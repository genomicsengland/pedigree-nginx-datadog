/*! pedigree-ui - v1.7.6 - 2019-07-06
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2019  Licensed AGPL-3.0 */

var CONSTANTS=CONSTANTS||{PEDIGREE_SERVICE_URL:"",PEDIGREE_TOOL_URL:"",LOOKUP_SERVICE_URL:""},$namespace=function(name,separator,container){var i,len,ns=name.split(separator||"."),o=container||window;for(i=0,len=ns.length;i<len;i++)o=o[ns[i]]=o[ns[i]]||{};return o},$type=function(oVar,oType){if(!oVar instanceof oType)throw new SyntaxError};if(!$)var $=function(sElementID){return document.getElementById(sElementID)};if(String.prototype.charCodeAt||(String.prototype.charCodeAt=function(idx){for(var c=this.charAt(idx),i=0;i<65536;i++){if(String.fromCharCode(i)==c)return i}return 0}),String.prototype.endsWith||(String.prototype.endsWith=function(test){return this.substr(this.length-test.length,test.length)==test}),!Exception){var Exception=function(sMsg,oException){this.cause=oException,this.errorMessage=sMsg};Exception.prototype=Error.prototype,Exception.prototype.getCause=function(){return this.cause},Exception.prototype.getMessage=function(){return this.message},Exception.prototype.getStackTrace=function(){if(this.callstack)return this.callstack;if(this.stack){for(var i=0,len=(lines=stack.split("\n")).length;i<len;i++)lines[i].match(/^\s*[A-Za-z0-9\=+\$]+\(/)&&this.callstack.push(lines[i]);return this.callstack.shift(),this.callstack}if(window.opera&&this.message){var lines;for(i=0,len=(lines=this.message.split("\n")).length;i<len;i++)if(lines[i].match(/^\s*[A-Za-z0-9\=+\$]+\(/)){var entry=lines[i];lines[i+1]&&(entry+=" at "+lines[i+1],i++),this.callstack.push(entry)}return this.callstack.shift(),this.callstack}for(var currentFunction=arguments.callee.caller;currentFunction;){var fn=currentFunction.toString(),fname=fn.substring(fn.indexOf("function")+8,fn.indexOf("("))||"anonymous";this.callstack.push(fname),currentFunction=currentFunction.caller}return this.callstack},Exception.prototype.printStackTrace=function(writer){var out=this.getMessage()+"|||"+this.getStackTrace().join("|||");if(this.cause&&this.cause.printStackTrace&&(out+="||||||Caused by "+this.cause.printStackTrace().replace("\n","|||")),!writer)return writer.replace("|||","\n");writer.value?writer.value=out.replace("|||","\n"):writer.writeln?writer.writeln(out.replace("|||","\n")):writer.innerHTML?writer.innerHTML=out.replace("|||","<br/>"):writer.textContent?writer.textContent=out.replace("|||","<br/>"):writer.append?writer.append(out.replace("|||","\n")):writer instanceof Function&&writer(out.replace("|||","\n"))}}if(!RuntimeException)var RuntimeException=Exception;if(!IllegalArgumentException)var IllegalArgumentException=Exception;if(!DateFormat){var DateFormat=function(sFmt){var fmt=sFmt,replaceChars={longMonths:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],longDays:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],d:function(date){return(date.getDate()<10?"0":"")+date.getDate()},D:function(date){return replaceChars.shortDays[date.getDay()]},j:function(date){return date.getDate()},l:function(date){return replaceChars.longDays[date.getDay()]},N:function(date){return date.getDay()+1},S:function(date){return date.getDate()%10==1&&11!=date.getDate()?"st":date.getDate()%10==2&&12!=date.getDate()?"nd":date.getDate()%10==3&&13!=date.getDate()?"rd":"th"},w:function(date){return date.getDay()},z:function(date){return"Not Yet Supported"},W:function(date){return"Not Yet Supported"},F:function(date){return replaceChars.longMonths[date.getMonth()]},m:function(date){return(date.getMonth()<9?"0":"")+(date.getMonth()+1)},M:function(date){return replaceChars.shortMonths[date.getMonth()]},n:function(date){return date.getMonth()+1},t:function(date){return"Not Yet Supported"},L:function(date){return date.getFullYear()%4==0&&date.getFullYear()%100!=0||date.getFullYear()%400==0?"1":"0"},o:function(date){return"Not Supported"},Y:function(date){return date.getFullYear()},y:function(date){return(""+date.getFullYear()).substr(2)},a:function(date){return date.getHours()<12?"am":"pm"},A:function(date){return date.getHours()<12?"AM":"PM"},B:function(date){return"Not Yet Supported"},g:function(date){return date.getHours()%12||12},G:function(date){return date.getHours()},h:function(date){return((date.getHours()%12||12)<10?"0":"")+(date.getHours()%12||12)},H:function(date){return(date.getHours()<10?"0":"")+date.getHours()},i:function(date){return(date.getMinutes()<10?"0":"")+date.getMinutes()},s:function(date){return(date.getSeconds()<10?"0":"")+date.getSeconds()},e:function(date){return"Not Yet Supported"},I:function(date){return"Not Supported"},O:function(date){return(-date.getTimezoneOffset()<0?"-":"+")+(Math.abs(date.getTimezoneOffset()/60)<10?"0":"")+Math.abs(date.getTimezoneOffset()/60)+"00"},P:function(date){return(-date.getTimezoneOffset()<0?"-":"+")+(Math.abs(date.getTimezoneOffset()/60)<10?"0":"")+Math.abs(date.getTimezoneOffset()/60)+":"+(Math.abs(date.getTimezoneOffset()%60)<10?"0":"")+Math.abs(date.getTimezoneOffset()%60)},T:function(date){var m=date.getMonth();date.setMonth(0);var result=date.toTimeString().replace(/^.+ \(?([^\)]+)\)?$/,"$1");return date.setMonth(m),result},Z:function(date){return 60*-date.getTimezoneOffset()},c:function(date){return date.format("Y-m-d")+"T"+date.format("H:i:sP")},r:function(date){return date.toString()},U:function(date){return date.getTime()/1e3}};return{format:function(oDate){for(var out="",i=0;i<fmt.length;i++){var c=fmt.charAt(i);replaceChars[c]?out+=replaceChars[c].call(oDate):out+=c}return out}}};DateFormat.getDateInstance=function(){return new DateFormat("M/d/y h:i a")}}$namespace("org.owasp.esapi"),org.owasp.esapi.ESAPI=function(oProperties){var _properties=oProperties;if(!_properties)throw new RuntimeException("Configuration Error - Unable to load $ESAPI_Properties Object");var _encoder=null,_validator=null,_logFactory=null,_resourceBundle=null,_httputilities=null;return{properties:_properties,encoder:function(){if(!_encoder){if(!_properties.encoder.Implementation)throw new RuntimeException("Configuration Error - $ESAPI.properties.encoder.Implementation object not found.");_encoder=new _properties.encoder.Implementation}return _encoder},logFactory:function(){if(!_logFactory){if(!_properties.logging.Implementation)throw new RuntimeException("Configuration Error - $ESAPI.properties.logging.Implementation object not found.");_logFactory=new _properties.logging.Implementation}return _logFactory},logger:function(sModuleName){return this.logFactory().getLogger(sModuleName)},locale:function(){return org.owasp.esapi.i18n.Locale.getLocale(_properties.localization.DefaultLocale)},resourceBundle:function(){if(!_resourceBundle){if(!_properties.localization.StandardResourceBundle)throw new RuntimeException("Configuration Error - $ESAPI.properties.localization.StandardResourceBundle not found.");_resourceBundle=new org.owasp.esapi.i18n.ObjectResourceBundle(_properties.localization.StandardResourceBundle)}return _resourceBundle},validator:function(){if(!_validator){if(!_properties.validation.Implementation)throw new RuntimeException("Configuration Error - $ESAPI.properties.validation.Implementation object not found.");_validator=new _properties.validation.Implementation}return _validator},httpUtilities:function(){return _httputilities||(_httputilities=new org.owasp.esapi.HTTPUtilities),_httputilities}}};var $ESAPI=null;with(org.owasp.esapi.ESAPI.initialize=function(){$ESAPI=new org.owasp.esapi.ESAPI(Base.esapi.properties)},$namespace("org.owasp.esapi"),org.owasp.esapi.Encoder=function(){},$namespace("org.owasp.esapi"),org.owasp.esapi.EncoderConstants={CHAR_LOWERS:["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],CHAR_UPPERS:["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],CHAR_DIGITS:["0","1","2","3","4","5","6","7","8","9"],CHAR_SPECIALS:["!","$","*","+","-",".","=","?","@","^","_","|","~"],CHAR_LETTERS:["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],CHAR_ALNUM:["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","0","1","2","3","4","5","6","7","8","9"]},$namespace("org.owasp.esapi"),org.owasp.esapi.EnterpriseSecurityException=function(sUserMessage,sLogMessage,oException){var _logMessage=sLogMessage,_super=new Exception(sUserMessage,oException);return{getMessage:_super.getMessage,getUserMessage:_super.getMessage,getLogMessage:function(){return _logMessage},getStackTrace:_super.getStackTrace,printStackTrace:_super.printStackTrace}},$namespace("org.owasp.esapi"),org.owasp.esapi.HTTPUtilities=function(){var log=$ESAPI.logger("HTTPUtilities"),resourceBundle=$ESAPI.resourceBundle(),EventType=org.owasp.esapi.Logger.EventType;return{addCookie:function(oCookie){if($type(oCookie,org.owasp.esapi.net.Cookie),"http:"!=window.top.location.protocol||"https:"!=window.top.location.protocol)throw new RuntimeException(resourceBundle.getString("HTTPUtilities.Cookie.Protocol",{protocol:window.top.location.protocol}));var name=oCookie.getName(),value=oCookie.getValue(),maxAge=oCookie.getMaxAge(),domain=oCookie.getDomain(),path=oCookie.getPath(),secure=oCookie.getSecure(),validationErrors=new org.owasp.esapi.ValidationErrorList;$ESAPI.validator().getValidInput("cookie name",name,"HttpCookieName",50,!1,validationErrors),$ESAPI.validator().getValidInput("cookie value",value,"HttpCookieValue",5e3,!1,validationErrors);if(0==validationErrors.size()){var header=name+"="+escape(value);header+=maxAge?";expires="+new Date((new Date).getTime()+1e3*maxAge).toGMTString():"",header+=path?";path="+path:"",header+=domain?";domain="+domain:"",header+=secure||$ESAPI.properties.httputilities.cookies.ForceSecure?";secure":"",document.cookie=header}else log.warning(EventType.SECURITY_FAILURE,resourceBundle.getString("HTTPUtilities.Cookie.UnsafeData",{name:name,value:value}))},getCookie:function(sName){for(var cookieJar=document.cookie.split("; "),i=0,len=cookieJar.length;i<len;i++){var cookie=cookieJar[i].split("=");if(cookie[0]==escape(sName))return new org.owasp.esapi.net.Cookie(sName,cookie[1]?unescape(cookie[1]):"")}return null},killAllCookies:function(){for(var cookieJar=document.cookie.split("; "),i=0,len=cookieJar.length;i<len;i++){var cookie=cookieJar[i].split("="),name=unescape(cookie[0]);if(!this.killCookie(name))throw new RuntimeException(resourceBundle.getString("HTTPUtilities.Cookie.CantKill",{name:name}))}},killCookie:function(sName){var c=this.getCookie(sName);if(c){if(c.setMaxAge(-10),this.addCookie(c),this.getCookie(sName))throw new RuntimeException(resourceBundle.getString("HTTPUtilities.Cookie.CantKill",{name:sName}));return!0}return!1},getRequestParameter:function(sName){var url=window.top.location.search.substring(1),pIndex=url.indexOf(sName);if(pIndex<0)return null;pIndex+=sName.length;var lastIndex=url.indexOf("&",pIndex);return lastIndex<0&&(lastIndex=url.length),unescape(url.substring(pIndex,lastIndex))}}},$namespace("org.owasp.esapi"),org.owasp.esapi.IntrusionException=function(sUserMessage,sLogMessage,oCause){var _super=new org.owasp.esapi.EnterpriseSecurityException(sUserMessage,sLogMessage,oCause);return{getMessage:_super.getMessage,getUserMessage:_super.getMessage,getLogMessage:_super.getLogMessage,getStackTrace:_super.getStackTrace,printStackTrace:_super.printStackTrace}},$namespace("org.owasp.esapi"),org.owasp.esapi.LogFactory=function(){return{getLogger:!1}},$namespace("org.owasp.esapi"),org.owasp.esapi.Logger=function(){return{setLevel:!1,fatal:!1,error:!1,isErrorEnabled:!1,warning:!1,isWarningEnabled:!1,info:!1,isInfoEnabled:!1,debug:!1,isDebugEnabled:!1,trace:!1,isTraceEnabled:!1}},org.owasp.esapi.Logger.EventType=function(sName,bNewSuccess){var type=sName,success=bNewSuccess;return{isSuccess:function(){return success},toString:function(){return type}}},org.owasp.esapi.Logger)EventType.SECURITY_SUCCESS=new EventType("SECURITY SUCCESS",!0),EventType.SECURITY_FAILURE=new EventType("SECURITY FAILURE",!1),EventType.EVENT_SUCCESS=new EventType("EVENT SUCCESS",!0),EventType.EVENT_FAILURE=new EventType("EVENT FAILURE",!1),OFF=Number.MAX_VALUE,FATAL=1e3,ERROR=800,WARNING=600,INFO=400,DEBUG=200,TRACE=100,ALL=Number.MIN_VALUE;$namespace("org.owasp.esapi"),org.owasp.esapi.PreparedString=function(sTemplate,oCodec,sParameterCharacter){var parts=[],parameters=[];return sParameterCharacter||(sParameterCharacter="?"),function(s){for(var idx=0,pcount=0,i=0;i<s.length;i++)s.charAt(i)==sParameterCharacter&&(pcount++,parts.push(s.substr(idx,i)),idx=i+1);parts.push(s.substr(idx)),parameters=new Array(pcount)}(sTemplate),{set:function(iIndex,sValue,codec){if(iIndex<1||iIndex>parameters.length)throw new IllegalArgumentException("Attempt to set parameter: "+iIndex+" on a PreparedString with only "+parameters.length+" placeholders");codec||(codec=oCodec),parameters[iIndex-1]=codec.encode([],sValue)},toString:function(){for(var ix=0;ix<parameters.length;ix++)if(null==parameters[ix])throw new RuntimeException("Attempt to render PreparedString without setting parameter "+(ix+1));for(var out="",i=0,p=0;p<parts.length;p++)out+=parts[p],i<parameters.length&&(out+=parameters[i++]);return out}}},$namespace("org.owasp.esapi"),org.owasp.esapi.ValidationErrorList=function(){var errorList=Array();return{addError:function(sContext,oValidationException){if(null==sContext)throw new RuntimeException("Context cannot be null: "+oValidationException.getLogMessage(),oValidationException);if(null==oValidationException)throw new RuntimeException("Context ("+sContext+") - Error cannot be null");if(errorList[sContext])throw new RuntimeException("Context ("+sContext+") already exists. must be unique.");errorList[sContext]=oValidationException},errors:function(){return errorList},isEmpty:function(){return 0==errorList.length},size:function(){return errorList.length}}},$namespace("org.owasp.esapi"),org.owasp.esapi.ValidationRule=function(){return{getValid:!1,setAllowNull:!1,getTypeName:!1,setTypeName:!1,setEncoder:!1,assertValid:!1,getSafe:!1,isValid:!1,whitelist:!1}},$namespace("org.owasp.esapi"),org.owasp.esapi.Validator=function(){return{addRule:!1,getRule:!1,getValidInput:!1,isValidDate:!1,getValidDate:!1,isValidSafeHTML:!1,getValidSafeHTML:!1,isValidCreditCard:!1,getValidCreditCard:!1,isValidFilename:!1,getValidFilename:!1,isValidNumber:!1,getValidNumber:!1,isValidPrintable:!1,getValidPrintable:!1}},$namespace("org.owasp.esapi.codecs.Base64"),org.owasp.esapi.codecs.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(sInput){if(!sInput)return null;for(var ch1,ch2,ch3,enc1,enc2,enc3,enc4,out="",i=0,input=org.owasp.esapi.codecs.UTF8.encode(sInput);i<input.length;)enc1=(ch1=input.charCodeAt(i++))>>2,enc2=(3&ch1)<<4|(ch2=input.charCodeAt(i++))>>4,enc3=(15&ch2)<<2|(ch3=input.charCodeAt(i++))>>6,enc4=63&ch3,isNaN(ch2)?enc3=enc4=64:isNaN(ch3)&&(enc4=64),out+=this._keyStr.charAt(enc1)+this._keyStr.charAt(enc2)+this._keyStr.charAt(enc3)+this._keyStr.charAt(enc4);return out},decode:function(sInput){if(!sInput)return null;for(var ch1,ch2,ch3,enc2,enc3,enc4,out="",i=0,input=sInput.replace(/[^A-Za-z0-9\+\/\=]/g,"");i<input.length;)ch1=this._keyStr.indexOf(input.charAt(i++))<<2|(enc2=this._keyStr.indexOf(input.charAt(i++)))>>4,ch2=(15&enc2)<<4|(enc3=this._keyStr.indexOf(input.charAt(i++)))>>2,ch3=(3&enc3)<<6|(enc4=this._keyStr.indexOf(input.charAt(i++))),out+=String.fromCharCode(ch1),64!=enc3&&(out+=String.fromCharCode(ch2)),64!=enc4&&(out+=String.fromCharCode(ch3));return out=org.owasp.esapi.codecs.UTF8.decode(out)}},$namespace("org.owasp.esapi.codecs"),org.owasp.esapi.codecs.CSSCodec=function(){var _super=new org.owasp.esapi.codecs.Codec;return{encode:_super.encode,decode:_super.decode,encodeCharacter:function(aImmune,c){if(-1<aImmune.indexOf(c))return c;var hex=org.owasp.esapi.codecs.Codec.getHexForNonAlphanumeric(c);return null==hex?c:"\\"+hex+" "},decodeCharacter:function(oPushbackString){oPushbackString.mark();var first=oPushbackString.next();if(null==first)return oPushbackString.reset(),null;if("\\"!=first)return oPushbackString.reset(),null;var second=oPushbackString.next();if(null==second)return oPushbackString.reset(),null;if(oPushbackString.isHexDigit(second)){for(var out=second,i=0;i<6;i++){var c=oPushbackString.next();if(null==c||32==c.charCodeAt(0))break;if(!oPushbackString.isHexDigit(c)){input.pushback(c);break}out+=c}try{var n=parseInt(out,16);return String.fromCharCode(n)}catch(e){return oPushbackString.reset(),null}}return second}}},$namespace("org.owasp.esapi.codecs"),org.owasp.esapi.codecs.Codec=function(){return{encode:function(aImmune,sInput){for(var out="",i=0;i<sInput.length;i++){var c=sInput.charAt(i);out+=this.encodeCharacter(aImmune,c)}return out},encodeCharacter:function(aImmune,c){return c},decode:function(sInput){for(var out="",pbs=new org.owasp.esapi.codecs.PushbackString(sInput);pbs.hasNext();){var c=this.decodeCharacter(pbs);out+=null!=c?c:pbs.next()}return out},decodeCharacter:function(oPushbackString){return oPushbackString.next()}}},org.owasp.esapi.codecs.Codec.getHexForNonAlphanumeric=function(c){return c.charCodeAt(0)<256?org.owasp.esapi.codecs.Codec.hex[c.charCodeAt(0)]:c.charCodeAt(0).toString(16)},org.owasp.esapi.codecs.Codec.hex=[];for(var c=0;c<255;c++)org.owasp.esapi.codecs.Codec.hex[c]=48<=c&&c<=57||65<=c&&c<=90||97<=c&&c<=122?null:c.toString(16);var entityToCharacterMap=[];entityToCharacterMap["&quot"]="34",entityToCharacterMap["&amp"]="38",entityToCharacterMap["&lt"]="60",entityToCharacterMap["&gt"]="62",entityToCharacterMap["&nbsp"]="160",entityToCharacterMap["&iexcl"]="161",entityToCharacterMap["&cent"]="162",entityToCharacterMap["&pound"]="163",entityToCharacterMap["&curren"]="164",entityToCharacterMap["&yen"]="165",entityToCharacterMap["&brvbar"]="166",entityToCharacterMap["&sect"]="167",entityToCharacterMap["&uml"]="168",entityToCharacterMap["&copy"]="169",entityToCharacterMap["&ordf"]="170",entityToCharacterMap["&laquo"]="171",entityToCharacterMap["&not"]="172",entityToCharacterMap["&shy"]="173",entityToCharacterMap["&reg"]="174",entityToCharacterMap["&macr"]="175",entityToCharacterMap["&deg"]="176",entityToCharacterMap["&plusmn"]="177",entityToCharacterMap["&sup2"]="178",entityToCharacterMap["&sup3"]="179",entityToCharacterMap["&acute"]="180",entityToCharacterMap["&micro"]="181",entityToCharacterMap["&para"]="182",entityToCharacterMap["&middot"]="183",entityToCharacterMap["&cedil"]="184",entityToCharacterMap["&sup1"]="185",entityToCharacterMap["&ordm"]="186",entityToCharacterMap["&raquo"]="187",entityToCharacterMap["&frac14"]="188",entityToCharacterMap["&frac12"]="189",entityToCharacterMap["&frac34"]="190",entityToCharacterMap["&iquest"]="191",entityToCharacterMap["&Agrave"]="192",entityToCharacterMap["&Aacute"]="193",entityToCharacterMap["&Acirc"]="194",entityToCharacterMap["&Atilde"]="195",entityToCharacterMap["&Auml"]="196",entityToCharacterMap["&Aring"]="197",entityToCharacterMap["&AElig"]="198",entityToCharacterMap["&Ccedil"]="199",entityToCharacterMap["&Egrave"]="200",entityToCharacterMap["&Eacute"]="201",entityToCharacterMap["&Ecirc"]="202",entityToCharacterMap["&Euml"]="203",entityToCharacterMap["&Igrave"]="204",entityToCharacterMap["&Iacute"]="205",entityToCharacterMap["&Icirc"]="206",entityToCharacterMap["&Iuml"]="207",entityToCharacterMap["&ETH"]="208",entityToCharacterMap["&Ntilde"]="209",entityToCharacterMap["&Ograve"]="210",entityToCharacterMap["&Oacute"]="211",entityToCharacterMap["&Ocirc"]="212",entityToCharacterMap["&Otilde"]="213",entityToCharacterMap["&Ouml"]="214",entityToCharacterMap["&times"]="215",entityToCharacterMap["&Oslash"]="216",entityToCharacterMap["&Ugrave"]="217",entityToCharacterMap["&Uacute"]="218",entityToCharacterMap["&Ucirc"]="219",entityToCharacterMap["&Uuml"]="220",entityToCharacterMap["&Yacute"]="221",entityToCharacterMap["&THORN"]="222",entityToCharacterMap["&szlig"]="223",entityToCharacterMap["&agrave"]="224",entityToCharacterMap["&aacute"]="225",entityToCharacterMap["&acirc"]="226",entityToCharacterMap["&atilde"]="227",entityToCharacterMap["&auml"]="228",entityToCharacterMap["&aring"]="229",entityToCharacterMap["&aelig"]="230",entityToCharacterMap["&ccedil"]="231",entityToCharacterMap["&egrave"]="232",entityToCharacterMap["&eacute"]="233",entityToCharacterMap["&ecirc"]="234",entityToCharacterMap["&euml"]="235",entityToCharacterMap["&igrave"]="236",entityToCharacterMap["&iacute"]="237",entityToCharacterMap["&icirc"]="238",entityToCharacterMap["&iuml"]="239",entityToCharacterMap["&eth"]="240",entityToCharacterMap["&ntilde"]="241",entityToCharacterMap["&ograve"]="242",entityToCharacterMap["&oacute"]="243",entityToCharacterMap["&ocirc"]="244",entityToCharacterMap["&otilde"]="245",entityToCharacterMap["&ouml"]="246",entityToCharacterMap["&divide"]="247",entityToCharacterMap["&oslash"]="248",entityToCharacterMap["&ugrave"]="249",entityToCharacterMap["&uacute"]="250",entityToCharacterMap["&ucirc"]="251",entityToCharacterMap["&uuml"]="252",entityToCharacterMap["&yacute"]="253",entityToCharacterMap["&thorn"]="254",entityToCharacterMap["&yuml"]="255",entityToCharacterMap["&OElig"]="338",entityToCharacterMap["&oelig"]="339",entityToCharacterMap["&Scaron"]="352",entityToCharacterMap["&scaron"]="353",entityToCharacterMap["&Yuml"]="376",entityToCharacterMap["&fnof"]="402",entityToCharacterMap["&circ"]="710",entityToCharacterMap["&tilde"]="732",entityToCharacterMap["&Alpha"]="913",entityToCharacterMap["&Beta"]="914",entityToCharacterMap["&Gamma"]="915",entityToCharacterMap["&Delta"]="916",entityToCharacterMap["&Epsilon"]="917",entityToCharacterMap["&Zeta"]="918",entityToCharacterMap["&Eta"]="919",entityToCharacterMap["&Theta"]="920",entityToCharacterMap["&Iota"]="921",entityToCharacterMap["&Kappa"]="922",entityToCharacterMap["&Lambda"]="923",entityToCharacterMap["&Mu"]="924",entityToCharacterMap["&Nu"]="925",entityToCharacterMap["&Xi"]="926",entityToCharacterMap["&Omicron"]="927",entityToCharacterMap["&Pi"]="928",entityToCharacterMap["&Rho"]="929",entityToCharacterMap["&Sigma"]="931",entityToCharacterMap["&Tau"]="932",entityToCharacterMap["&Upsilon"]="933",entityToCharacterMap["&Phi"]="934",entityToCharacterMap["&Chi"]="935",entityToCharacterMap["&Psi"]="936",entityToCharacterMap["&Omega"]="937",entityToCharacterMap["&alpha"]="945",entityToCharacterMap["&beta"]="946",entityToCharacterMap["&gamma"]="947",entityToCharacterMap["&delta"]="948",entityToCharacterMap["&epsilon"]="949",entityToCharacterMap["&zeta"]="950",entityToCharacterMap["&eta"]="951",entityToCharacterMap["&theta"]="952",entityToCharacterMap["&iota"]="953",entityToCharacterMap["&kappa"]="954",entityToCharacterMap["&lambda"]="955",entityToCharacterMap["&mu"]="956",entityToCharacterMap["&nu"]="957",entityToCharacterMap["&xi"]="958",entityToCharacterMap["&omicron"]="959",entityToCharacterMap["&pi"]="960",entityToCharacterMap["&rho"]="961",entityToCharacterMap["&sigmaf"]="962",entityToCharacterMap["&sigma"]="963",entityToCharacterMap["&tau"]="964",entityToCharacterMap["&upsilon"]="965",entityToCharacterMap["&phi"]="966",entityToCharacterMap["&chi"]="967",entityToCharacterMap["&psi"]="968",entityToCharacterMap["&omega"]="969",entityToCharacterMap["&thetasym"]="977",entityToCharacterMap["&upsih"]="978",entityToCharacterMap["&piv"]="982",entityToCharacterMap["&ensp"]="8194",entityToCharacterMap["&emsp"]="8195",entityToCharacterMap["&thinsp"]="8201",entityToCharacterMap["&zwnj"]="8204",entityToCharacterMap["&zwj"]="8205",entityToCharacterMap["&lrm"]="8206",entityToCharacterMap["&rlm"]="8207",entityToCharacterMap["&ndash"]="8211",entityToCharacterMap["&mdash"]="8212",entityToCharacterMap["&lsquo"]="8216",entityToCharacterMap["&rsquo"]="8217",entityToCharacterMap["&sbquo"]="8218",entityToCharacterMap["&ldquo"]="8220",entityToCharacterMap["&rdquo"]="8221",entityToCharacterMap["&bdquo"]="8222",entityToCharacterMap["&dagger"]="8224",entityToCharacterMap["&Dagger"]="8225",entityToCharacterMap["&bull"]="8226",entityToCharacterMap["&hellip"]="8230",entityToCharacterMap["&permil"]="8240",entityToCharacterMap["&prime"]="8242",entityToCharacterMap["&Prime"]="8243",entityToCharacterMap["&lsaquo"]="8249",entityToCharacterMap["&rsaquo"]="8250",entityToCharacterMap["&oline"]="8254",entityToCharacterMap["&frasl"]="8260",entityToCharacterMap["&euro"]="8364",entityToCharacterMap["&image"]="8365",entityToCharacterMap["&weierp"]="8472",entityToCharacterMap["&real"]="8476",entityToCharacterMap["&trade"]="8482",entityToCharacterMap["&alefsym"]="8501",entityToCharacterMap["&larr"]="8592",entityToCharacterMap["&uarr"]="8593",entityToCharacterMap["&rarr"]="8594",entityToCharacterMap["&darr"]="8595",entityToCharacterMap["&harr"]="8596",entityToCharacterMap["&crarr"]="8629",entityToCharacterMap["&lArr"]="8656",entityToCharacterMap["&uArr"]="8657",entityToCharacterMap["&rArr"]="8658",entityToCharacterMap["&dArr"]="8659",entityToCharacterMap["&hArr"]="8660",entityToCharacterMap["&forall"]="8704",entityToCharacterMap["&part"]="8706",entityToCharacterMap["&exist"]="8707",entityToCharacterMap["&empty"]="8709",entityToCharacterMap["&nabla"]="8711",entityToCharacterMap["&isin"]="8712",entityToCharacterMap["&notin"]="8713",entityToCharacterMap["&ni"]="8715",entityToCharacterMap["&prod"]="8719",entityToCharacterMap["&sum"]="8721",entityToCharacterMap["&minus"]="8722",entityToCharacterMap["&lowast"]="8727",entityToCharacterMap["&radic"]="8730",entityToCharacterMap["&prop"]="8733",entityToCharacterMap["&infin"]="8734",entityToCharacterMap["&ang"]="8736",entityToCharacterMap["&and"]="8743",entityToCharacterMap["&or"]="8744",entityToCharacterMap["&cap"]="8745",entityToCharacterMap["&cup"]="8746",entityToCharacterMap["&int"]="8747",entityToCharacterMap["&there4"]="8756",entityToCharacterMap["&sim"]="8764",entityToCharacterMap["&cong"]="8773",entityToCharacterMap["&asymp"]="8776",entityToCharacterMap["&ne"]="8800",entityToCharacterMap["&equiv"]="8801",entityToCharacterMap["&le"]="8804",entityToCharacterMap["&ge"]="8805",entityToCharacterMap["&sub"]="8834",entityToCharacterMap["&sup"]="8835",entityToCharacterMap["&nsub"]="8836",entityToCharacterMap["&sube"]="8838",entityToCharacterMap["&supe"]="8839",entityToCharacterMap["&oplus"]="8853",entityToCharacterMap["&otimes"]="8855",entityToCharacterMap["&perp"]="8869",entityToCharacterMap["&sdot"]="8901",entityToCharacterMap["&lceil"]="8968",entityToCharacterMap["&rceil"]="8969",entityToCharacterMap["&lfloor"]="8970",entityToCharacterMap["&rfloor"]="8971",entityToCharacterMap["&lang"]="9001",entityToCharacterMap["&rang"]="9002",entityToCharacterMap["&loz"]="9674",entityToCharacterMap["&spades"]="9824",entityToCharacterMap["&clubs"]="9827",entityToCharacterMap["&hearts"]="9829",entityToCharacterMap["&diams"]="9830";var characterToEntityMap=[];for(var entity in entityToCharacterMap)characterToEntityMap[entityToCharacterMap[entity]]=entity;$namespace("org.owasp.esapi.codecs"),org.owasp.esapi.codecs.HTMLEntityCodec=function(){var _super=new org.owasp.esapi.codecs.Codec,parseNumber=function(input){for(var out="";input.hasNext();){var c=input.peek();if(!c.match(/[0-9]/)){if(";"!=c)break;input.next();break}out+=c,input.next()}try{return parseInt(out)}catch(e){return null}},parseHex=function(input){for(var out="";input.hasNext();){var c=input.peek();if(!c.match(/[0-9A-Fa-f]/)){if(";"!=c)break;input.next();break}out+=c,input.next()}try{return parseInt(out,16)}catch(e){return null}};return{encode:_super.encode,decode:_super.decode,encodeCharacter:function(aImmune,c){if(-1<aImmune.indexOf(c))return c;var hex=org.owasp.esapi.codecs.Codec.getHexForNonAlphanumeric(c);if(null==hex)return c;var cc=c.charCodeAt(0);if(cc<=31&&"\t"!=c&&"\n"!=c&&"\r"!=c||127<=cc&&cc<=159||" "==c)return" ";var entityName=characterToEntityMap[cc];return null!=entityName?entityName+";":"&#x"+hex+";"},decodeCharacter:function(oPushbackString){var input=oPushbackString;input.mark();var first=input.next();if(null==first||"&"!=first)return input.reset(),null;var second=input.next();if(null==second)return input.reset(),null;if("#"==second){var c=function(input){var first=input.peek();return null==first?null:"x"==first||"X"==first?(input.next(),parseHex(input)):parseNumber(input)}(input);if(null!=c)return c}else if(second.match(/[A-Za-z]/)&&(input.pushback(second),null!=(c=function(input){for(var entity="";input.hasNext();){var c=input.peek();if(c.match(/[A-Za-z]/)){if(entity+=c,input.next(),entityToCharacterMap.containsKey("&"+entity)){input.peek(";")&&input.next();break}}else{if(";"!=c)break;input.next()}}return String.fromCharCode(entityToCharacterMap.getCaseInsensitive("&"+entity))}(input))))return c;return input.reset(),null}}},$namespace("org.owasp.esapi.codecs"),org.owasp.esapi.codecs.JavascriptCodec=function(){return{encode:function(aImmune,sInput){for(var out="",idx=0;idx<sInput.length;idx++){var ch=sInput.charAt(idx);if(-1<aImmune.indexOf(ch))out+=ch;else if(null==org.owasp.esapi.codecs.Codec.getHexForNonAlphanumeric(ch))out+=ch;else{var tmp=ch.charCodeAt(0).toString(16);if(ch.charCodeAt(0)<256){var pad="00".substr(tmp.length);out+="\\x"+pad+tmp.toUpperCase()}else out+="\\u"+(pad="0000".substr(tmp.length))+tmp.toUpperCase()}}return out},decode:(new org.owasp.esapi.codecs.Codec).decode,decodeCharacter:function(oPushbackString){oPushbackString.mark();var first=oPushbackString.next();if(null==first)return oPushbackString.reset(),null;if("\\"!=first)return oPushbackString.reset(),null;var second=oPushbackString.next();if(null==second)return oPushbackString.reset(),null;if("b"==second)return 8;if("t"==second)return 9;if("n"==second)return 10;if("v"==second)return 11;if("f"==second)return 12;if("r"==second)return 13;if('"'==second)return 34;if("'"==second)return 39;if("\\"==second)return 92;if("x"==second.toLowerCase()){out="";for(var i=0;i<2;i++){var c=oPushbackString.nextHex();if(null==c)return input.reset(),null;out+=c}try{return n=parseInt(out,16),String.fromCharCode(n)}catch(e){return oPushbackString.reset(),null}}else if("u"==second.toLowerCase()){for(out="",i=0;i<4;i++){if(null==(c=oPushbackString.nextHex()))return input.reset(),null;out+=c}try{var n=parseInt(out,16);return String.fromCharCode(n)}catch(e){return oPushbackString.reset(),null}}else if(oPushbackString.isOctalDigit(second)){var out=second,c2=oPushbackString.next();if(oPushbackString.isOctalDigit(c2)){out+=c2;var c3=oPushbackString.next();oPushbackString.isOctalDigit(c3)?out+=c3:oPushbackString.pushback(c3)}else oPushbackString.pushback(c2);try{return n=parseInt(out,8),String.fromCharCode(n)}catch(e){return oPushbackString.reset(),null}}return second}}},$namespace("org.owasp.esapi.codecs"),org.owasp.esapi.codecs.PercentCodec=function(){var _super=new org.owasp.esapi.codecs.Codec,UNENCODED_STR="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",getTwoUpperBytes=function(b){var out="";if(b<-128||127<b)throw new IllegalArgumentException("b is not a byte (was "+b+")");return(b&=255)<16&&(out+="0"),out+b.toString(16).toUpperCase()};return{encode:_super.encode,decode:_super.decode,encodeCharacter:function(aImmune,c){if(-1<UNENCODED_STR.indexOf(c))return c;for(var bytes=org.owasp.esapi.codecs.UTF8.encode(c),out="",b=0;b<bytes.length;b++)out+="%"+getTwoUpperBytes(bytes.charCodeAt(b));return out},decodeCharacter:function(oPushbackString){oPushbackString.mark();var first=oPushbackString.next();if(null==first||"%"!=first)return oPushbackString.reset(),null;for(var out="",i=0;i<2;i++){var c=oPushbackString.nextHex();null!=c&&(out+=c)}if(2==out.length)try{var n=parseInt(out,16);return String.fromCharCode(n)}catch(e){}return oPushbackString.reset(),null}}},$namespace("org.owasp.esapi.codecs"),org.owasp.esapi.codecs.PushbackString=function(sInput){var _input=sInput,_pushback="",_temp="",_index=0,_mark=0;return{pushback:function(c){_pushback=c},index:function(){return _index},hasNext:function(){return null!=_pushback||!(null==_input||0==_input.length||_index>=_input.length)},next:function(){if(null==_pushback)return null==_input||0==_input.length||_index>=_input.length?null:_input.charAt(_index++);var save=_pushback;return _pushback=null,save},nextHex:function(){var c=this.next();return this.isHexDigit(c)?c:null},nextOctal:function(){var c=this.next();return this.isOctalDigit(c)?c:null},isHexDigit:function(c){return null!=c&&("0"<=c&&c<="9"||"a"<=c&&c<="f"||"A"<=c&&c<="F")},isOctalDigit:function(c){return null!=c&&"0"<=c&&c<="7"},peek:function(c){return c?null!=_pushback&&_pushback==c||!(null==_input||0==_input.length||_index>=_input.length)&&_input.charAt(_index)==c:null!=_pushback?_pushback:null==_input||0==_input.length||_index>=_input.length?null:_input.charAt(_index)},mark:function(){_temp=_pushback,_mark=_index},reset:function(){_pushback=_temp,_index=_mark},remainder:function(){var out=_input.substr(_index);return null!=_pushback&&(out=_pushback+out),out}}},$namespace("org.owasp.esapi.codecs"),org.owasp.esapi.codecs.UTF8={encode:function(sInput){for(var input=sInput.replace(/\r\n/g,"\n"),utftext="",n=0;n<input.length;n++){var c=input.charCodeAt(n);c<128?utftext+=String.fromCharCode(c):(127<c&&c<2048?utftext+=String.fromCharCode(c>>6|192):(utftext+=String.fromCharCode(c>>12|224),utftext+=String.fromCharCode(c>>6&63|128)),utftext+=String.fromCharCode(63&c|128))}return utftext},decode:function(sInput){for(var out="",i=c=c1=c2=0;i<sInput.length;)(c=sInput.charCodeAt(i))<128?(out+=String.fromCharCode(c),i++):191<c&&c<224?(c2=sInput.charCodeAt(i+1),out+=String.fromCharCode((31&c)<<6|63&c2),i+=2):(c2=utftext.charCodeAt(i+1),c3=utftext.charCodeAt(i+2),string+=String.fromCharCode((15&c)<<12|(63&c2)<<6|63&c3),i+=3);return out}},$namespace("org.owasp.esapi.i18n"),org.owasp.esapi.i18n.ArrayResourceBundle=function(sName,oLocale,aMessages,oParent){with(org.owasp.esapi.i18n)var _super=new ResourceBundle(sName,oLocale,oParent);var messages=aMessages;return{getParent:_super.getParent,getLocale:_super.getLocale,getName:_super.getName,getString:_super.getString,getMessage:function(sKey){return messages[sKey]}}},$namespace("org.owasp.esapi.i18n"),org.owasp.esapi.i18n.Locale=function(sLanguage,sCountry,sVariant){var language=sLanguage,country=sCountry,variant=sVariant;return{getLanguage:function(){return language},getCountry:function(){return country},getVariant:function(){return variant},toString:function(){return language+(country?"-"+country+(variant?"-"+variant:""):"")}}},org.owasp.esapi.i18n.Locale.US=new org.owasp.esapi.i18n.Locale("en","US"),org.owasp.esapi.i18n.Locale.GB=new org.owasp.esapi.i18n.Locale("en","GB"),org.owasp.esapi.i18n.Locale.getLocale=function(sLocale){var l=sLocale.split("-");return new org.owasp.esapi.i18n.Locale(l[0],1<l.length?l[1]:"",2<l.length?l.length[2]:"")},org.owasp.esapi.i18n.Locale.getDefault=function(){var l=(navigator.language?navigator.language:navigator.userLanguage?navigator.userLanguage:"en-US").split("-");return new org.owasp.esapi.i18n.Locale(l[0],1<l.length?l[1]:"",2<l.length?l.length[2]:"")},$namespace("org.owasp.esapi.i18n"),org.owasp.esapi.i18n.ObjectResourceBundle=function(oResource,oParent){var _super=new org.owasp.esapi.i18n.ResourceBundle(oResource.name,org.owasp.esapi.i18n.Locale.getLocale(oResource.locale),oParent),messages=oResource.messages;return{getParent:_super.getParent,getLocale:_super.getLocale,getName:_super.getName,getString:_super.getString,getMessage:function(sKey){return messages[sKey]}}},$namespace("org.owasp.esapi.i18n"),org.owasp.esapi.i18n.ResourceBundle=function(sName,oLocale,oParentResourceBundle){var parent=oParentResourceBundle,locale=oLocale,name=sName;if(!name)throw new SyntaxError("Name required for implementations of org.owasp.esapi.i18n.ResourceBundle");if(!locale)throw new SyntaxError("Locale required for implementations of org.owasp.esapi.i18n.ResourceBundle");return{getParent:function(){return parent},getLocale:function(){return locale},getName:function(){return name},getMessage:function(sKey){return sKey},getString:function(sKey,oContextMap){if(arguments.length<1)throw new IllegalArgumentException("No key passed to getString");var msg=this.getMessage(sKey);if(!msg)return parent?parent.getString(sKey,oContextMap):sKey;if(!msg.match(/\{([A-Za-z]+)\}/)||!oContextMap)return msg;for(var out="",lastIndex=0;;){var nextVarIdx=msg.indexOf("{",lastIndex),endIndex=msg.indexOf("}",nextVarIdx);if(nextVarIdx<0){out+=msg.substr(lastIndex,msg.length-lastIndex);break}if(0<=nextVarIdx&&endIndex<-1)throw new SyntaxError("Invalid Message - Unclosed Context Reference: "+msg);out+=msg.substring(lastIndex,nextVarIdx);var contextKey=msg.substring(nextVarIdx+1,endIndex);oContextMap[contextKey]?out+=oContextMap[contextKey]:out+=msg.substring(nextVarIdx,endIndex+1),lastIndex=endIndex+1}return out}}},org.owasp.esapi.i18n.ResourceBundle.getResourceBundle=function(sResource,oLocale){var classname=sResource+"_"+oLocale.toString().replace("-","_");with(org.owasp.esapi.i18n)return ResourceBundle[classname]instanceof Object?ResourceBundle[classname]:new ResourceBundle[classname]},$namespace("org.owasp.esapi.net"),org.owasp.esapi.net.Cookie=function(sName,sValue){var name,value,comment,domain,maxAge,path,secure,version,_resourceBundle=$ESAPI.resourceBundle();if(function(sValue){for(var i=0,len=sValue.length;i<len;i++){var cc=sValue.charCodeAt(i),c=sValue.charAt(i);if(cc<32||127<=cc||-1!=",; ".indexOf(c))return!1}return!0}(sName)&&"comment"!=sName.toLowerCase()&&"discard"!=sName.toLowerCase()&&"domain"!=sName.toLowerCase()&&"expires"!=sName.toLowerCase()&&"max-age"!=sName.toLowerCase()&&"path"!=sName.toLowerCase()&&"secure"!=sName.toLowerCase()&&"version"!=sName.toLowerCase()&&"$"!=sName.charAt(0))return name=sName,value=sValue,{setComment:function(purpose){comment=purpose},getComment:function(){return comment},setDomain:function(sDomain){domain=sDomain.toLowerCase()},getDomain:function(){return domain},setMaxAge:function(nExpirey){maxAge=nExpirey},getMaxAge:function(){return maxAge},setPath:function(sPath){path=sPath},getPath:function(){return path},setSecure:function(bSecure){secure=bSecure},getSecure:function(){return secure},getName:function(){return name},setValue:function(sValue){value=sValue},getValue:function(){return value},setVersion:function(nVersion){if(nVersion<0||1<nVersion)throw new IllegalArgumentException(_resourceBundle.getString("Cookie.Version",{version:nVersion}));version=nVersion},getVersion:function(){return version}};var errMsg=_resourceBundle.getString("Cookie.Name",{name:sName});throw new IllegalArgumentException(errMsg)},$namespace("org.owasp.esapi.reference.encoding"),org.owasp.esapi.reference.encoding.DefaultEncoder=function(aCodecs){var _codecs=[],_htmlCodec=new org.owasp.esapi.codecs.HTMLEntityCodec,_javascriptCodec=new org.owasp.esapi.codecs.JavascriptCodec,_cssCodec=new org.owasp.esapi.codecs.CSSCodec,_percentCodec=new org.owasp.esapi.codecs.PercentCodec;aCodecs?_codecs=aCodecs:(_codecs.push(_htmlCodec),_codecs.push(_javascriptCodec),_codecs.push(_cssCodec),_codecs.push(_percentCodec));var IMMUNE_HTML=new Array(",",".","-","_"," "),IMMUNE_HTMLATTR=new Array(",",".","-","_"),IMMUNE_CSS=new Array,IMMUNE_JAVASCRIPT=new Array(",",".","_");return{cananicalize:function(sInput,bStrict){if(!sInput)return null;for(var working=sInput,codecFound=null,mixedCount=1,foundCount=0,clean=!1;!clean;)clean=!0,_codecs.each(function(codec){working!=(working=codec.decode(working))&&(null!=codecFound&&codecFound!=codec&&mixedCount++,codecFound=codec,clean&&foundCount++,clean=!1)});if(2<=foundCount&&1<mixedCount){if(bStrict)throw new org.owasp.esapi.IntrusionException("Input validation failure","Multiple ("+foundCount+"x) and mixed encoding ("+mixedCount+"x) detected in "+sInput)}else if(2<=foundCount){if(bStrict)throw new org.owasp.esapi.IntrusionException("Input validation failure","Multiple ("+foundCount+"x) encoding detected in "+sInput)}else if(1<mixedCount&&bStrict)throw new org.owasp.esapi.IntrusionException("Input validation failure","Mixed ("+mixedCount+"x) encoding detected in "+sInput);return working},normalize:function(sInput){return sInput.replace(/[^\x00-\x7F]/g,"")},encodeForHTML:function(sInput){return sInput?_htmlCodec.encode(IMMUNE_HTML,sInput):null},decodeForHTML:function(sInput){return sInput?_htmlCodec.decode(sInput):null},encodeForHTMLAttribute:function(sInput){return sInput?_htmlCodec.encode(IMMUNE_HTMLATTR,sInput):null},encodeForCSS:function(sInput){return sInput?_cssCodec.encode(IMMUNE_CSS,sInput):null},encodeForJavaScript:function(sInput){return sInput?_javascriptCodec.encode(IMMUNE_JAVASCRIPT,sInput):null},encodeForJavascript:this.encodeForJavaScript,encodeForURL:function(sInput){return sInput?escape(sInput):null},decodeFromURL:function(sInput){return sInput?unescape(sInput):null},encodeForBase64:function(sInput){return sInput?org.owasp.esapi.codecs.Base64.encode(sInput):null},decodeFromBase64:function(sInput){return sInput?org.owasp.esapi.codecs.Base64.decode(sInput):null}}},$namespace("org.owasp.esapi.reference.logging"),org.owasp.esapi.reference.logging.Log4JSLogFactory=function(){var loggersMap=Array(),Log4JSLogger=function(sModuleName){var jsLogger=null,moduleName=sModuleName||null,Level=Log4js.Level,logUrl=!1,logApplicationName=!1,encodingRequired=!1,encodingFunction=$ESAPI.encoder().encodeForHTML;jsLogger=Log4js.getLogger(moduleName);return{setLevel:function(nLevel){try{jsLogger.setLevel(function(nLevel){var Logger=org.owasp.esapi.Logger;switch(nLevel){case Logger.OFF:return Log4js.Level.OFF;case Logger.FATAL:return Log4js.Level.FATAL;case Logger.ERROR:return Log4js.Level.ERROR;case Logger.WARNING:return Log4js.Level.WARN;case Logger.INFO:return Log4js.Level.INFO;case Logger.DEBUG:return Log4js.Level.DEBUG;case Logger.TRACE:return Log4js.Level.TRACE;case Logger.ALL:return Log4js.Level.ALL}}(nLevel))}catch(e){this.error(org.owasp.esapi.Logger.SECURITY_FAILURE,"",e)}},trace:function(oEventType,sMessage,oException){this.log(Level.TRACE,oEventType,sMessage,oException)},debug:function(oEventType,sMessage,oException){this.log(Level.DEBUG,oEventType,sMessage,oException)},info:function(oEventType,sMessage,oException){this.log(Level.INFO,oEventType,sMessage,oException)},warning:function(oEventType,sMessage,oException){this.log(Level.WARN,oEventType,sMessage,oException)},error:function(oEventType,sMessage,oException){this.log(Level.ERROR,oEventType,sMessage,oException)},fatal:function(oEventType,sMessage,oException){this.log(Level.FATAL,oEventType,sMessage,oException)},log:function(oLevel,oEventType,sMessage,oException){switch(oLevel){case Level.TRACE:if(!jsLogger.isTraceEnabled())return;break;case Level.DEBUG:if(!jsLogger.isDebugEnabled())return;break;case Level.INFO:if(!jsLogger.isInfoEnabled())return;break;case Level.WARNING:if(!jsLogger.isWarnEnabled())return;break;case Level.ERROR:if(!jsLogger.isErrorEnabled())return;break;case Level.FATAL:if(!jsLogger.isFatalEnabled())return}sMessage||(sMessage="");var clean=(sMessage="["+oEventType.toString()+"] - "+sMessage).replace("\n","_").replace("\r","_");encodingRequired&&(clean=encodingFunction(clean))!=sMessage&&(clean+=" [Encoded]");var appInfo=(logUrl?window.location.href:"")+(logApplicationName?"/"+$ESAPI.properties.application.Name:"");jsLogger.log(oLevel,(""!=appInfo?"["+appInfo+"] ":"")+clean,oException)},addAppender:function(oAppender){jsLogger.addAppender(oAppender)},isLogUrl:function(){return logUrl},setLogUrl:function(b){logUrl=b},isLogApplicationName:function(){return logApplicationName},setLogApplicationName:function(b){logApplicationName=b},isEncodingRequired:function(){return encodingRequired},setEncodingRequired:function(b){encodingRequired=b},setEncodingFunction:function(f){encodingFunction=f},isDebugEnabled:function(){return jsLogger.isDebugEnabled()},isErrorEnabled:function(){return jsLogger.isErrorEnabled()},isFatalEnabled:function(){return jsLogger.isFatalEnabled()},isInfoEnabled:function(){return jsLogger.isInfoEnabled()},isTraceEnabled:function(){return jsLogger.isTraceEnabled()},isWarningEnabled:function(){return jsLogger.isWarnEnabled()}}};return{getLogger:function(moduleName){var key="string"==typeof moduleName?moduleName:moduleName.constructor.toString(),logger=loggersMap[key];if(!logger){logger=new Log4JSLogger(key);var logConfig=function(moduleName){var logConfig=$ESAPI.properties.logging;return logConfig[moduleName]&&(logConfig=logConfig[moduleName]),logConfig}(moduleName);logger.setLevel(logConfig.Level),logger.setLogUrl(logConfig.LogUrl),logger.setLogApplicationName(logConfig.LogApplicationName),logger.setEncodingRequired(logConfig.EncodingRequired),logConfig.EncodingFunction&&logger.setEncodingFunction(logConfig.EncodingFunction),logConfig.Appenders.each(function(e){logConfig.Layout&&e.setLayout(logConfig.Layout),logger.addAppender(e)}),loggersMap[key]=logger}return logger}}},$namespace("org.owasp.esapi.reference.validation"),org.owasp.esapi.reference.validation.BaseValidationRule=function(sTypeName,oEncoder,oLocale){var resourceBundle,log=$ESAPI.logger("Validation"),EventType=org.owasp.esapi.Logger.EventType,typename=sTypeName,encoder=oEncoder||$ESAPI.encoder(),allowNull=!1,ResourceBundle=org.owasp.esapi.i18n.ResourceBundle,locale=oLocale||$ESAPI.locale();return $ESAPI.properties.validation.ResourceBundle&&(resourceBundle=ResourceBundle.getResourceBundle($ESAPI.properties.validation.ResourceBundle,locale)),resourceBundle||(resourceBundle=$ESAPI.resourceBundle(),log.info(EventType.EVENT_FAILURE,"No Validation ResourceBundle - Defaulting to "+resourceBundle.getName()+"("+resourceBundle.getLocale().toString()+")")),log.info(EventType.EVENT_SUCCESS,"Validation Rule Initialized with ResourceBundle: "+resourceBundle.getName()),{setAllowNull:function(b){allowNull=b},isAllowNull:function(){return allowNull},getTypeName:function(){return typename},setTypeName:function(s){typename=s},setEncoder:function(oEncoder){encoder=oEncoder},getEncoder:function(){return encoder},assertValid:function(sContext,sInput){this.getValid(sContext,sInput)},getValid:function(sContext,sInput,oValidationErrorList){var valid=null;try{valid=this.getValidInput(sContext,sInput)}catch(oValidationException){return this.sanitize(sContext,sInput)}return valid},getValidInput:function(sContext,sInput){return sInput},getSafe:function(sContext,sInput){var valid=null;try{valid=this.getValidInput(sContext,sInput)}catch(oValidationException){return this.sanitize(sContext,sInput)}return valid},sanitize:function(sContext,sInput){return sInput},isValid:function(sContext,sInput){var valid=!1;try{this.getValidInput(sContext,sInput),valid=!0}catch(oValidationException){return!1}return valid},whitelist:function(sInput,aWhitelist){for(var stripped="",i=0;i<sInput.length;i++){var c=sInput.charAt(i);-1<aWhitelist.indexOf(c)&&(stripped+=c)}return stripped},getUserMessage:function(sContext,sDefault,oContextValues){return this.getMessage(sContext+".Usr",sDefault+".Usr",oContextValues)},getLogMessage:function(sContext,sDefault,oContextValues){return this.getMessage(sContext+".Log",sDefault+".Log",oContextValues)},getMessage:function(sContext,sDefault,oContextValues){return resourceBundle.getString(sContext,oContextValues)?resourceBundle.getString(sContext,oContextValues):resourceBundle.getString(sDefault,oContextValues)},validationException:function(sContext,sDefault,sValidation,oContextValues){throw new org.owasp.esapi.reference.validation.ValidationException(this.getUserMessage(sContext+"."+sValidation,sDefault+"."+sValidation,oContextValues),this.getLogMessage(sContext+"."+sValidation,sDefault+"."+sValidation,oContextValues),sContext)}}},$namespace("org.owasp.esapi.reference.validation"),org.owasp.esapi.reference.validation.CreditCardValidationRule=function(sTypeName,oEncoder,oLocale){var p,ccr,_super=new org.owasp.esapi.reference.validation.BaseValidationRule(sTypeName,oEncoder,oLocale),maxCardLength=19;ccRule=(p=new RegExp($ESAPI.properties.validation.CreditCard),(ccr=new org.owasp.esapi.reference.validation.StringValidationRule("ccrule",_super.getEncoder(),oLocale,p)).setMaxLength(maxCardLength),ccr.setAllowNull(!1),ccr);return{getMaxCardLength:function(){return maxCardLength},setMaxCardLength:function(n){maxCardLength=n},setAllowNull:_super.setAllowNull,isAllowNull:_super.isAllowNull,getTypeName:_super.getTypeName,setTypeName:_super.setTypeName,setEncoder:_super.setEncoder,getEncoder:_super.getEncoder,assertValid:_super.assertValid,getValid:_super.getValid,getValidInput:function(sContext,sInput){if(!sInput||""==sInput.trim()){if(this.isAllowNull())return null;_super.validationException(sContext,"CreditCard","Required",{context:sContext,input:sInput})}var canonical=(void 0).getValid(sContext,sInput);return function(ccNum){for(var c,digitsonly="",i=0;o<ccNum.length;i++)(c=ccNum.charAt(i)).match(/[0-9]/)&&(digitsonly+=c);for(var sum=0,digit=0,addend=0,timesTwo=!1,j=digitsonly.length-1;0<=j;j--)digit=parseInt(digitsonly.substring(j,i+1)),timesTwo?9<(addend=2*digit)&&(addend-=9):addend=digit,sum+=addend,timesTwo=!timesTwo;return sum%10==0}(canonical)||_super.validationException(sContext,"CreditCard","Invalid",{context:sContext,input:sInput}),canonical},getSafe:_super.getSafe,sanitize:function(sContext,sInput){return this.whitelist(sInput,org.owasp.esapi.EncoderConstants.CHAR_DIGITS)},isValid:_super.isValid,whitelist:_super.whitelist}},$namespace("org.owasp.esapi.reference.validation"),org.owasp.esapi.reference.validation.DateValidationRule=function(sTypeName,oEncoder,oLocale){var _super=new org.owasp.esapi.reference.validation.BaseValidationRule(sTypeName,oEncoder,oLocale),format=DateFormat.getDateInstance(),safelyParse=function(sContext,sInput){if(!sContext||""==sContext.trim()){if(_super.isAllowNull())return null;_super.validationException(sContext,"Date","Required",{context:sContext,input:sInput,format:format})}var canonical=_super.getEncoder().cananicalize(sInput);try{return format.parse(canonical)}catch(e){_super.validationException(sContext,"Date","Invalid",{context:sContext,input:sInput,format:format})}};return{setDateFormat:function(fmt){if(!fmt)throw new IllegalArgumentException("DateValidationRule.setDateFormat requires a non-null DateFormat");format=fmt},setAllowNull:_super.setAllowNull,isAllowNull:_super.isAllowNull,getTypeName:_super.getTypeName,setTypeName:_super.setTypeName,setEncoder:_super.setEncoder,getEncoder:_super.getEncoder,assertValid:_super.assertValid,getValid:_super.getValid,getValidInput:function(sContext,sInput){return safelyParse(sContext,sInput)},getSafe:_super.getSafe,sanitize:function(sContext,sInput){var date=new Date(0);try{date=safelyParse(sContext,sInput)}catch(e){}return date},isValid:_super.isValid,whitelist:_super.whitelist}},$namespace("org.owasp.esapi.reference.validation"),org.owasp.esapi.reference.validation.DefaultValidator=function(oEncoder,oLocale){var rules=Array(),encoder=oEncoder||$ESAPI.encoder(),locale=oLocale||org.owasp.esapi.i18n.Locale.getDefault(),p=org.owasp.esapi.reference.validation;return{addRule:function(oValidationRule){rules[oValidationRule.getName()]=oValidationRule},getRule:function(sName){return rules[sName]},isValidInput:function(sContext,sInput,sType,nMaxLength,bAllowNull){try{return this.getValidInput(sContext,sInput,sType,nMaxLength,bAllowNull),!0}catch(e){return!1}},getValidInput:function(sContext,sInput,sType,nMaxLength,bAllowNull,oValidationErrorList){var rvr=new org.owasp.esapi.reference.validation.StringValidationRule(sType,encoder,locale),p=new RegExp($ESAPI.properties.validation[sType]);if(!(p&&p instanceof RegExp))throw new IllegalArgumentException("Invalid Type: "+sType+" not found.");rvr.addWhitelistPattern(p),rvr.setMaxLength(nMaxLength),rvr.setAllowNull(bAllowNull);try{return rvr.getValid(sContext,sInput)}catch(e){throw e instanceof p.ValidationErrorList&&oValidationErrorList&&oValidationErrorList.addError(sContext,e),e}},isValidDate:function(sContext,sInput,oDateFormat,bAllowNull){try{return this.getValidDate(sContext,sInput,oDateFormat,bAllowNull),!0}catch(e){return!1}},getValidDate:function(sContext,sInput,oDateFormat,bAllowNull,oValidationErrorList){var dvr=new p.DateValidationRule(sContext,encoder,locale);dvr.setAllowNull(bAllowNull),dvr.setDateFormat(oDateFormat);try{return dvr.getValid(sContext,sInput)}catch(e){throw e instanceof p.ValidationErrorList&&oValidationErrorList&&oValidationErrorList.addError(sContext,e),e}},getValidCreditCard:function(sContext,sInput,bAllowNull,oValidationErrorList){var ccr=new p.CreditCardValidationRule(sContext,encoder,locale);ccr.setAllowNull(bAllowNull);try{return ccr.getValid(sContext,sInput)}catch(e){throw e instanceof p.ValidationErrorList&&oValidationErrorList&&oValidationErrorList.addError(sContext,e),e}},isValidCreditCard:function(sContext,sInput,bAllowNull){try{return this.getValidCreditCard(sContext,sInput,bAllowNull),!0}catch(e){return!1}},getValidNumber:function(sContext,sInput,bAllowNull,nMinValue,nMaxValue,oValidationErrorList){var nvr=new p.NumberValidationRule(sContext,encoder,locale,nMinValue,nMaxValue);nvr.setAllowNull(bAllowNull);try{return nvr.getValid(sContext,sInput)}catch(e){throw e instanceof p.ValidationErrorList&&oValidationErrorList&&oValidationErrorList.addError(sContext,e),e}},isValidNumber:function(sContext,sInput,bAllowNull,nMinValue,nMaxValue){try{return this.getValidNumber(sContext,sInput,bAllowNull,nMinValue,nMaxValue),!0}catch(e){return!1}},getValidInteger:function(sContext,sInput,bAllowNull,nMinValue,nMaxValue,oValidationErrorList){var nvr=new p.IntegerValidationRule(sContext,encoder,locale,nMinValue,nMaxValue);nvr.setAllowNull(bAllowNull);try{return nvr.getValid(sContext,sInput)}catch(e){throw e instanceof p.ValidationErrorList&&oValidationErrorList&&oValidationErrorList.addError(sContext,e),e}},isValidInteger:function(sContext,sInput,bAllowNull,nMinValue,nMaxValue){try{return this.getValidInteger(sContext,sInput,bAllowNull,nMinValue,nMaxValue),!0}catch(e){return!1}}}},$namespace("org.owasp.esapi.reference.validation"),org.owasp.esapi.reference.validation.IntegerValidationRule=function(sTypeName,oEncoder,oLocale,nMinValue,nMaxValue){var _super=new org.owasp.esapi.reference.validation.BaseValidationRule(sTypeName,oEncoder,oLocale),minValue=nMinValue||Number.MIN_VALUE,maxValue=nMaxValue||Number.MAX_VALUE;if(maxValue<=minValue)throw new IllegalArgumentException("minValue must be less than maxValue");var safelyParse=function(sContext,sInput){if(!sInput||""==sInput.trim()){if(_super.allowNull())return null;_super.validationException(sContext,"Integer","Required",{context:sContext,input:sInput,minValue:minValue,maxValue:maxValue})}var canonical=_super.getEncoder().cananicalize(sInput),n=parseInt(canonical);return"NaN"==n&&_super.validationException(sContext,"Integer","NaN",{context:sContext,input:sInput,minValue:minValue,maxValue:maxValue}),n<minValue&&_super.validationException(sContext,"Integer","MinValue",{context:sContext,input:sInput,minValue:minValue,maxValue:maxValue}),maxValue<n&&_super.validationException(sContext,"Integer","MaxValue",{context:sContext,input:sInput,minValue:minValue,maxValue:maxValue}),n};return{setMinValue:function(n){minValue=n},getMinValue:function(){return minValue},setMaxValue:function(n){maxValue=n},getMaxValue:function(){return maxValue},setAllowNull:_super.setAllowNull,isAllowNull:_super.isAllowNull,getTypeName:_super.getTypeName,setTypeName:_super.setTypeName,setEncoder:_super.setEncoder,getEncoder:_super.getEncoder,assertValid:_super.assertValid,getValid:_super.getValid,getValidInput:function(sContext,sInput){return safelyParse(sContext,sInput)},getSafe:_super.getSafe,sanitize:function(sContext,sInput){var n=0;try{n=safelyParse(sContext,sInput)}catch(e){}return n},isValid:_super.isValid,whitelist:_super.whitelist}},$namespace("org.owasp.esapi.reference.validation"),org.owasp.esapi.reference.validation.NumberValidationRule=function(sTypeName,oEncoder,oLocale,fMinValue,fMaxValue){var _super=new org.owasp.esapi.reference.validation.BaseValidationRule(sTypeName,oEncoder,oLocale),minValue=fMinValue||Number.MIN_VALUE,maxValue=fMaxValue||Number.MAX_VALUE;if(maxValue<=minValue)throw new IllegalArgumentException("MinValue must be less that MaxValue");var safelyParse=function(sContext,sInput){if(!sInput||""==sInput.trim()){if(_super.isAllowNull())return null;_super.validationException(sContext,"Number","Required",{context:sContext,input:sInput,minValue:minValue,maxValue:maxValue})}var canonical=_super.getEncoder().cananicalize(sInput),f=0;try{f=parseFloat(canonical)}catch(e){_super.validationException(sContext,"Number","Invalid",{context:sContext,input:sInput,minValue:minValue,maxValue:maxValue})}return"NaN"==f&&_super.validationException(sContext,"Number","NaN",{context:sContext,input:sInput,minValue:minValue,maxValue:maxValue}),f<minValue&&_super.validationException(sContext,"Number","MinValue",{context:sContext,input:sInput,minValue:minValue,maxValue:maxValue}),maxValue<f&&_super.validationException(sContext,"Number","MaxValue",{context:sContext,input:sInput,minValue:minValue,maxValue:maxValue}),f};return{setMinValue:function(n){minValue=n},getMinValue:function(){return minValue},setMaxValue:function(n){maxValue=n},getMaxValue:function(){return maxValue},setAllowNull:_super.setAllowNull,isAllowNull:_super.isAllowNull,getTypeName:_super.getTypeName,setTypeName:_super.setTypeName,setEncoder:_super.setEncoder,getEncoder:_super.getEncoder,assertValid:_super.assertValid,getValid:_super.getValid,getValidInput:function(sContext,sInput){return safelyParse(sContext,sInput)},getSafe:_super.getSafe,sanitize:function(sContext,sInput){var n=0;try{n=safelyParse(sContext,sInput)}catch(e){}return n},isValid:_super.isValid,whitelist:_super.whitelist}},$namespace("org.owasp.esapi.reference.validation"),org.owasp.esapi.reference.validation.StringValidationRule=function(sTypeName,oEncoder,oLocale,sWhiteListPattern){var _super=new org.owasp.esapi.reference.validation.BaseValidationRule(sTypeName,oEncoder,oLocale),whitelistPatterns=Array(),blacklistPatterns=Array(),minLength=0,maxLength=Number.MAX_VALUE,validateInputAndCanonical=!0;if(sWhiteListPattern)if(sWhiteListPattern instanceof String)whitelistPatterns.push(new RegExp(sWhiteListPattern));else{if(!(sWhiteListPattern instanceof RegExp))throw new IllegalArgumentException("sWhiteListPattern must be a string containing RegExp or a RegExp Object");whitelistPatterns.push(sWhiteListPattern)}var checkWhitelist=function(sContext,sInput,sOrig){whitelistPatterns.each(function(p){sInput.match(p)&&_super.validationException(sContext,"String","Whitelist",{context:sContext,input:sInput,orig:sOrig,pattern:p.toString(),minLength:minLength,maxLength:maxLength,validateInputAndCanonical:validateInputAndCanonical})})},checkBlacklist=function(sContext,sInput,sOrig){blacklistPatterns.each(function(p){sInput.match(p)&&_super.validationException(sContext,"String","Blacklist",{context:sContext,input:sInput,orig:sOrig,pattern:p.toString(),minLength:minLength,maxLength:maxLength,validateInputAndCanonical:validateInputAndCanonical})})},checkLength=function(sContext,sInput,sOrig){return sInput.length<minLength&&_super.validationException(sContext,"String","MinLength",{context:sContext,input:sInput,orig:sOrig,minLength:minLength,maxLength:maxLength,validateInputAndCanonical:validateInputAndCanonical}),sInput.length>maxLength&&_super.validationException(sContext,"String","MaxLength",{context:sContext,input:sInput,orig:sOrig,minLength:minLength,maxLength:maxLength,validateInputAndCanonical:validateInputAndCanonical}),sInput},checkEmpty=function(sContext,sInput,sOrig){if(!sInput||""==sInput.trim()){if(_super.isAllowNull())return null;_super.validationException(sContext,"String","Required",{context:sContext,input:sInput,orig:sOrig,minLength:minLength,maxLength:maxLength,validateInputAndCanonical:validateInputAndCanonical})}};return{addWhitelistPattern:function(p){if(p instanceof String)whitelistPatterns.push(new RegExp(p));else{if(!(p instanceof RegExp))throw new IllegalArgumentException("p must be a string containing RegExp or a RegExp Object");whitelistPatterns.push(p)}},addBlacklistPattern:function(p){if(p instanceof String)blacklistPatterns.push(new RegExp(p));else{if(!(p instanceof RegExp))throw new IllegalArgumentException("p must be a string containing RegExp or a RegExp Object");blacklistPatterns.push(p)}},setMinLength:function(n){minLength=n},getMinLength:function(){return minLength},setMaxLength:function(n){maxLength=n},getMaxLength:function(){return maxLength},setValidateInputAndCanonical:function(b){validateInputAndCanonical=b},isValidateInputAndCanonical:function(){return validateInputAndCanonical},setAllowNull:_super.setAllowNull,isAllowNull:_super.isAllowNull,getTypeName:_super.getTypeName,setTypeName:_super.setTypeName,setEncoder:_super.setEncoder,getEncoder:_super.getEncoder,assertValid:_super.assertValid,getValid:_super.getValid,getValidInput:function(sContext,sInput){var canonical;return null==checkEmpty(sContext,sInput)?null:(validateInputAndCanonical&&(checkLength(sContext,sInput),checkWhitelist(sContext,sInput),checkBlacklist(sContext,sInput)),canonical=this.getEncoder().cananicalize(sInput),null==checkEmpty(sContext,canonical,sInput)?null:(checkLength(sContext,canonical,sInput),checkWhitelist(sContext,canonical,sInput),checkBlacklist(sContext,canonical,sInput),canonical))},getSafe:_super.getSafe,sanitize:function(sContext,sInput){return this.whitelist(sInput,org.owasp.esapi.EncoderConstants.CHAR_ALNUM)},isValid:_super.isValid,whitelist:_super.whitelist}},$namespace("org.owasp.esapi.reference.validation"),org.owasp.esapi.reference.validation.ValidationException=function(sUserMessage,sLogMessage){var oException,sContext;arguments[2]&&arguments[2]instanceof Exception?(oException=arguments[2],arguments[3]&&arguments[3]instanceof String&&(sContext=arguments[3])):arguments[2]&&arguments[2]instanceof String&&(sContext=arguments[2]);var _super=new org.owasp.esapi.EnterpriseSecurityException(sUserMessage,sLogMessage,oException);return{setContext:function(s){sContext=s},getContext:function(){return sContext},getMessage:_super.getMessage,getUserMessage:_super.getMessage,getLogMessage:_super.getLogMessage,getStackTrace:_super.getStackTrace,printStackTrace:_super.printStackTrace}};var ESAPI_Standard_en_US={name:"ESAPI Standard Messages - US English",locale:"en-US",messages:{Test:"This is test #{testnumber}","CreditCard.Required.Usr":"{context}: Input credit card required","CreditCard.Required.Log":"Input credit card required: context={context}, input={input}","CreditCard.Invalid.Usr":"{context}: Invalid credit card input","CreditCard.Invalid.Log":"Invalid credit card input: context={context}, input={input}","Date.Required.Usr":"{context}: Input date required in {format} format","Date.Required.Log":"Date required: context={context}, input={input}, format={format}","Date.Invalid.Usr":"{context}: Invalid date, please use {format} format","Date.Invalid.Log":"Invalid date: context={context}, input={input}, format={format}","Integer.Required.Usr":"{context}: Input number required","Integer.Required.Log":"Input number required: context={context}, input={input}, minValue={minValue}, maxValue={maxValue}","Integer.NaN.Usr":"{context}: Invalid number","Integer.NaN.Log":"Invalid number: context={context}, input={input}, minValue={minValue}, maxValue={maxValue}","Integer.MinValue.Usr":"{context}: Invalid number - Must be greater than {minValue}","Integer.MinValue.Log":"Invalid number: context={context}, input={input}, minValue={minValue}, maxValue={maxValue}","Integer.MaxValue.Usr":"{context}: Invalid number - Must be less than {maxValue}","Integer.MaxValue.Log":"Invalid number: context={context}, input={input}, minValue={minValue}, maxValue={maxValue}","Number.Required.Usr":"{context}: Input number required","Number.Required.Log":"Input number required: context={context}, input={input}, minValue={minValue}, maxValue={maxValue}","Number.NaN.Usr":"{context}: Invalid number","Number.NaN.Log":"Invalid number: context={context}, input={input}, minValue={minValue}, maxValue={maxValue}","Number.MinValue.Usr":"{context}: Invalid number - Must be greater than {minValue}","Number.MinValue.Log":"Invalid number: context={context}, input={input}, minValue={minValue}, maxValue={maxValue}","Number.MaxValue.Usr":"{context}: Invalid number - Must be less than {maxValue}","Number.MaxValue.Log":"Invalid number: context={context}, input={input}, minValue={minValue}, maxValue={maxValue}","String.Required.Usr":"{context}: Input required","String.Required.Log":"Input required: context={context}, input={input}, original={orig}","String.Whitelist.Usr":"{context}: Invalid input - Conform to regex {pattern}","String.Whitelist.Log":"Invalid input - Whitelist validation failed: context={context}, input={input}, original={orig}, pattern={pattern}","String.Blacklist.Usr":"{context}: Invalid input - Dangerous input matching {pattern} detected","String.Blacklist.Log":"Invalid input - Blacklist validation failed: context={context}, input={input}, original={orig}, pattern={pattern}","String.MinLength.Usr":"{context}: Invalid input - Minimum length is {minLength}","String.MinLength.Log":"Invalid input - Too short: context={context}, input={input}, original={orig}, minLength={minLength}","String.MaxLength.Usr":"{context}: Invalid input - Maximum length is {maxLength}","String.MaxLength.Log":"Invalid input - Too long: context={context}, input={input}, original={orig}, maxLength={maxLength}","HTTPUtilities.Cookie.Protocol":"Cookies disallowed on non http[s] requests. Current protocol: {protocol}","HTTPUtilities.Cookie.UnsafeData":"Attempt to add unsafe data to cookie (skip mode) - Cookie: {name}={value}","HTTPUtilities.Cookie.CantKill":"Unable to kill cookie named {name}","Cookie.Name":'Cookie name "{name}" is a reserved token',"Cookie.Version":'Cookie version "{version}" is not a valid version. Version must be 0 or 1.'}},requirejs,require,define;$namespace("Base.esapi.properties"),Base.esapi.properties={application:{Name:"ESAPI4JS Base Application"},httputilities:{cookies:{ForceSecure:!0}},logging:{Implementation:org.owasp.esapi.reference.logging.Log4JSLogFactory,Level:org.owasp.esapi.Logger.OFF,Appenders:[],LogUrl:!1,LogApplicationName:!1,EncodingRequired:!0},encoder:{Implementation:org.owasp.esapi.reference.encoding.DefaultEncoder,AllowMultipleEncoding:!1},localization:{StandardResourceBundle:ESAPI_Standard_en_US,DefaultLocale:"en-US"},validation:{Implementation:org.owasp.esapi.reference.validation.DefaultValidator,AccountName:"^[a-zA-Z0-9]{3,20}$",SafeString:"[a-zA-Z0-9\\-_+]*",Email:"^[A-Za-z0-9._%-]+@[A-Za-z0-9.-]+\\.[a-zA-Z]{2,4}$",IPAddress:"^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$",URL:"^(ht|f)tp(s?)\\:\\/\\/[0-9a-zA-Z]([-.\\w]*[0-9a-zA-Z])*(:(0-9)*)*(\\/?)([a-zA-Z0-9\\-\\.\\?\\,\\:\\'\\/\\\\\\+=&amp;%\\$#_]*)?$",CreditCard:"^(\\d{4}[- ]?){3}\\d{4}$",SSN:"^(?!000)([0-6]\\d{2}|7([0-6]\\d|7[012]))([ -]?)(?!00)\\d\\d\\3(?!0000)\\d{4}$",HttpScheme:"^(http|https)$",HttpServerName:"^[a-zA-Z0-9_.\\-]*$",HttpParameterName:"^[a-zA-Z0-9_]{1,32}$",HttpParameterValue:"^[a-zA-Z0-9.\\-\\/+=_ ]*$",HttpCookieName:"^[a-zA-Z0-9\\-_]{1,32}$",HttpCookieValue:"^[a-zA-Z0-9\\-\\/+=_ ]*$"}},Base.esapi.properties.application.Name="Pedigree Editor Tool",org.owasp.esapi.ESAPI.initialize(),function(ba){function G(b){return"[object Function]"===K.call(b)}function H(b){return"[object Array]"===K.call(b)}function v(b,c){var d;if(b)for(d=0;d<b.length&&(!b[d]||!c(b[d],d,b));d+=1);}function T(b,c){var d;if(b)for(d=b.length-1;-1<d&&(!b[d]||!c(b[d],d,b));d-=1);}function t(b,c){return fa.call(b,c)}function m(b,c){return t(b,c)&&b[c]}function B(b,c){for(var d in b)if(t(b,d)&&c(b[d],d))break}function U(b,c,d,e){return c&&B(c,function(c,g){!d&&t(b,g)||(!e||"object"!=typeof c||!c||H(c)||G(c)||c instanceof RegExp?b[g]=c:(b[g]||(b[g]={}),U(b[g],c,d,e)))}),b}function u(b,c){return function(){return c.apply(b,arguments)}}function ca(b){throw b}function da(b){if(!b)return b;var c=ba;return v(b.split("."),function(b){c=c[b]}),c}function C(b,c,d,e){return(c=Error(c+"\nhttp://requirejs.org/docs/errors.html#"+b)).requireType=b,c.requireModules=e,d&&(c.originalError=d),c}function ga(b){function c(a,k,b){k=k&&k.split("/");var f,l,c,d,e,g,i,p,h=j.map,n=h&&h["*"];if(a){for(l=(a=a.split("/")).length-1,j.nodeIdCompat&&Q.test(a[l])&&(a[l]=a[l].replace(Q,"")),"."===a[0].charAt(0)&&k&&(a=(l=k.slice(0,k.length-1)).concat(a)),l=a,c=0;c<l.length;c++)"."===(d=l[c])?(l.splice(c,1),c-=1):".."===d&&0!==c&&(1!=c||".."!==l[2])&&".."!==l[c-1]&&0<c&&(l.splice(c-1,2),c-=2);a=a.join("/")}if(b&&h&&(k||n)){c=(l=a.split("/")).length;a:for(;0<c;c-=1){if(e=l.slice(0,c).join("/"),k)for(d=k.length;0<d;d-=1)if((b=m(h,k.slice(0,d).join("/")))&&(b=m(b,e))){f=b,g=c;break a}!i&&n&&m(n,e)&&(i=m(n,e),p=c)}!f&&i&&(f=i,g=p),f&&(l.splice(0,g,f),a=l.join("/"))}return(f=m(j.pkgs,a))?f:a}function d(a){z&&v(document.getElementsByTagName("script"),function(k){if(k.getAttribute("data-requiremodule")===a&&k.getAttribute("data-requirecontext")===i.contextName)return k.parentNode.removeChild(k),!0})}function e(a){var k=m(j.paths,a);if(k&&H(k)&&1<k.length)return k.shift(),i.require.undef(a),i.makeRequire(null,{skipMap:!0})([a]),!0}function n(a){var k,c=a?a.indexOf("!"):-1;return-1<c&&(k=a.substring(0,c),a=a.substring(c+1,a.length)),[k,a]}function p(a,k,b,f){var l,d,e=null,g=k?k.name:null,j=a,p=!0,h="";return a||(p=!1,a="_@r"+(K+=1)),e=(a=n(a))[0],a=a[1],e&&(e=c(e,g,f),d=m(r,e)),a&&(e?h=d&&d.normalize?d.normalize(a,function(a){return c(a,g,f)}):-1===a.indexOf("!")?c(a,g,f):a:(e=(a=n(h=c(a,g,f)))[0],h=a[1],b=!0,l=i.nameToUrl(h))),{prefix:e,name:h,parentMap:k,unnormalized:!!(b=!e||d||b?"":"_unnormalized"+(O+=1)),url:l,originalName:j,isDefine:p,id:(e?e+"!"+h:h)+b}}function s(a){var k=a.id,b=m(h,k);return b||(b=h[k]=new i.Module(a)),b}function q(a,k,b){var f=a.id,c=m(h,f);!t(r,f)||c&&!c.defineEmitComplete?(c=s(a)).error&&"error"===k?b(c.error):c.on(k,b):"defined"===k&&b(r[f])}function w(a,b){var c=a.requireModules,f=!1;b?b(a):(v(c,function(b){(b=m(h,b))&&(b.error=a,b.events.error&&(f=!0,b.emit("error",a)))}),f||g.onError(a))}function x(){R.length&&(ha.apply(A,[A.length,0].concat(R)),R=[])}function y(a){delete h[a],delete V[a]}function F(a,b,c){var f=a.map.id;a.error?a.emit("error",a.error):(b[f]=!0,v(a.depMaps,function(f,d){var e=f.id,g=m(h,e);g&&!a.depMatched[d]&&!c[e]&&(m(b,e)?(a.defineDep(d,r[e]),a.check()):F(g,b,c))}),c[f]=!0)}function D(){var a,b,c=(a=1e3*j.waitSeconds)&&i.startTime+a<(new Date).getTime(),f=[],l=[],g=!1,h=!0;if(!W){if(W=!0,B(V,function(a){var i=a.map,j=i.id;if(a.enabled&&(i.isDefine||l.push(a),!a.error))if(!a.inited&&c)e(j)?g=b=!0:(f.push(j),d(j));else if(!a.inited&&a.fetched&&i.isDefine&&(g=!0,!i.prefix))return h=!1}),c&&f.length)return(a=C("timeout","Load timeout for modules: "+f,null,f)).contextName=i.contextName,w(a);h&&v(l,function(a){F(a,{},{})}),c&&!b||!g||!z&&!ea||X||(X=setTimeout(function(){X=0,D()},50)),W=!1}}function E(a){t(r,a[0])||s(p(a[0],null,!0)).init(a[1],a[2])}function I(a){a=a.currentTarget||a.srcElement;var b=i.onScriptLoad;return a.detachEvent&&!Y?a.detachEvent("onreadystatechange",b):a.removeEventListener("load",b,!1),b=i.onScriptError,(!a.detachEvent||Y)&&a.removeEventListener("error",b,!1),{node:a,id:a&&a.getAttribute("data-requiremodule")}}function J(){var a;for(x();A.length;){if(null===(a=A.shift())[0])return w(C("mismatch","Mismatched anonymous define() module: "+a[a.length-1]));E(a)}}var W,Z,i,L,X,j={waitSeconds:7,baseUrl:"./",paths:{},bundles:{},pkgs:{},shim:{},config:{}},h={},V={},$={},A=[],r={},S={},aa={},K=1,O=1;return L={require:function(a){return a.require?a.require:a.require=i.makeRequire(a.map)},exports:function(a){if(a.usingExports=!0,a.map.isDefine)return a.exports?r[a.map.id]=a.exports:a.exports=r[a.map.id]={}},module:function(a){return a.module?a.module:a.module={id:a.map.id,uri:a.map.url,config:function(){return m(j.config,a.map.id)||{}},exports:a.exports||(a.exports={})}}},(Z=function(a){this.events=m($,a.id)||{},this.map=a,this.shim=m(j.shim,a.id),this.depExports=[],this.depMaps=[],this.depMatched=[],this.pluginMaps={},this.depCount=0}).prototype={init:function(a,b,c,f){f=f||{},this.inited||(this.factory=b,c?this.on("error",c):this.events.error&&(c=u(this,function(a){this.emit("error",a)})),this.depMaps=a&&a.slice(0),this.errback=c,this.inited=!0,this.ignore=f.ignore,f.enabled||this.enabled?this.enable():this.check())},defineDep:function(a,b){this.depMatched[a]||(this.depMatched[a]=!0,this.depCount-=1,this.depExports[a]=b)},fetch:function(){if(!this.fetched){this.fetched=!0,i.startTime=(new Date).getTime();var a=this.map;if(!this.shim)return a.prefix?this.callPlugin():this.load();i.makeRequire(this.map,{enableBuildCallback:!0})(this.shim.deps||[],u(this,function(){return a.prefix?this.callPlugin():this.load()}))}},load:function(){var a=this.map.url;S[a]||(S[a]=!0,i.load(this.map.id,a))},check:function(){if(this.enabled&&!this.enabling){var a,b,c=this.map.id;b=this.depExports;var f=this.exports,l=this.factory;if(this.inited){if(this.error)this.emit("error",this.error);else if(!this.defining){if(this.defining=!0,this.depCount<1&&!this.defined){if(G(l)){if(this.events.error&&this.map.isDefine||g.onError!==ca)try{f=i.execCb(c,l,b,f)}catch(d){a=d}else f=i.execCb(c,l,b,f);if(this.map.isDefine&&void 0===f&&((b=this.module)?f=b.exports:this.usingExports&&(f=this.exports)),a)return a.requireMap=this.map,a.requireModules=this.map.isDefine?[this.map.id]:null,a.requireType=this.map.isDefine?"define":"require",w(this.error=a)}else f=l;this.exports=f,this.map.isDefine&&!this.ignore&&(r[c]=f,g.onResourceLoad)&&g.onResourceLoad(i,this.map,this.depMaps),y(c),this.defined=!0}this.defining=!1,this.defined&&!this.defineEmitted&&(this.defineEmitted=!0,this.emit("defined",this.exports),this.defineEmitComplete=!0)}}else this.fetch()}},callPlugin:function(){var a=this.map,b=a.id,d=p(a.prefix);this.depMaps.push(d),q(d,"defined",u(this,function(f){var l,d;d=m(aa,this.map.id);var e=this.map.name,P=this.map.parentMap?this.map.parentMap.name:null,n=i.makeRequire(a.parentMap,{enableBuildCallback:!0});this.map.unnormalized?(f.normalize&&(e=f.normalize(e,function(a){return c(a,P,!0)})||""),q(f=p(a.prefix+"!"+e,this.map.parentMap),"defined",u(this,function(a){this.init([],function(){return a},null,{enabled:!0,ignore:!0})})),(d=m(h,f.id))&&(this.depMaps.push(f),this.events.error&&d.on("error",u(this,function(a){this.emit("error",a)})),d.enable())):d?(this.map.url=i.nameToUrl(d),this.load()):((l=u(this,function(a){this.init([],function(){return a},null,{enabled:!0})})).error=u(this,function(a){this.inited=!0,(this.error=a).requireModules=[b],B(h,function(a){0===a.map.id.indexOf(b+"_unnormalized")&&y(a.map.id)}),w(a)}),l.fromText=u(this,function(f,c){var d=a.name,e=p(d),P=M;c&&(f=c),P&&(M=!1),s(e),t(j.config,b)&&(j.config[d]=j.config[b]);try{g.exec(f)}catch(h){return w(C("fromtexteval","fromText eval for "+b+" failed: "+h,h,[b]))}P&&(M=!0),this.depMaps.push(e),i.completeLoad(d),n([d],l)}),f.load(a.name,n,l,j))})),i.enable(d,this),this.pluginMaps[d.id]=d},enable:function(){(V[this.map.id]=this).enabling=this.enabled=!0,v(this.depMaps,u(this,function(a,b){var c,f;if("string"==typeof a){if(a=p(a,this.map.isDefine?this.map:this.map.parentMap,!1,!this.skipMap),this.depMaps[b]=a,c=m(L,a.id))return void(this.depExports[b]=c(this));this.depCount+=1,q(a,"defined",u(this,function(a){this.defineDep(b,a),this.check()})),this.errback&&q(a,"error",u(this,this.errback))}c=a.id,f=h[c],!t(L,c)&&f&&!f.enabled&&i.enable(a,this)})),B(this.pluginMaps,u(this,function(a){var b=m(h,a.id);b&&!b.enabled&&i.enable(a,this)})),this.enabling=!1,this.check()},on:function(a,b){var c=this.events[a];c||(c=this.events[a]=[]),c.push(b)},emit:function(a,b){v(this.events[a],function(a){a(b)}),"error"===a&&delete this.events[a]}},(i={config:j,contextName:b,registry:h,defined:r,urlFetched:S,defQueue:A,Module:Z,makeModuleMap:p,nextTick:g.nextTick,onError:w,configure:function(a){a.baseUrl&&"/"!==a.baseUrl.charAt(a.baseUrl.length-1)&&(a.baseUrl+="/");var b=j.shim,c={paths:!0,bundles:!0,config:!0,map:!0};B(a,function(a,b){c[b]?(j[b]||(j[b]={}),U(j[b],a,!0,!0)):j[b]=a}),a.bundles&&B(a.bundles,function(a,b){v(a,function(a){a!==b&&(aa[a]=b)})}),a.shim&&(B(a.shim,function(a,c){H(a)&&(a={deps:a}),!a.exports&&!a.init||a.exportsFn||(a.exportsFn=i.makeShimExports(a)),b[c]=a}),j.shim=b),a.packages&&v(a.packages,function(a){var b;b=(a="string"==typeof a?{name:a}:a).name,a.location&&(j.paths[b]=a.location),j.pkgs[b]=a.name+"/"+(a.main||"main").replace(ia,"").replace(Q,"")}),B(h,function(a,b){!a.inited&&!a.map.unnormalized&&(a.map=p(b))}),(a.deps||a.callback)&&i.require(a.deps||[],a.callback)},makeShimExports:function(a){return function(){var b;return a.init&&(b=a.init.apply(ba,arguments)),b||a.exports&&da(a.exports)}},makeRequire:function(a,e){function j(c,d,m){var n,q;return e.enableBuildCallback&&d&&G(d)&&(d.__requireJsBuild=!0),"string"==typeof c?G(d)?w(C("requireargs","Invalid require call"),m):a&&t(L,c)?L[c](h[a.id]):g.get?g.get(i,c,a,j):(n=(n=p(c,a,!1,!0)).id,t(r,n)?r[n]:w(C("notloaded",'Module name "'+n+'" has not been loaded yet for context: '+b+(a?"":". Use require([])")))):(J(),i.nextTick(function(){J(),(q=s(p(null,a))).skipMap=e.skipMap,q.init(c,d,m,{enabled:!0}),D()}),j)}return e=e||{},U(j,{isBrowser:z,toUrl:function(b){var d,e=b.lastIndexOf("."),k=b.split("/")[0];return-1!==e&&("."!==k&&".."!==k||1<e)&&(d=b.substring(e,b.length),b=b.substring(0,e)),i.nameToUrl(c(b,a&&a.id,!0),d,!0)},defined:function(b){return t(r,p(b,a,!1,!0).id)},specified:function(b){return b=p(b,a,!1,!0).id,t(r,b)||t(h,b)}}),a||(j.undef=function(b){x();var c=p(b,a,!0),e=m(h,b);d(b),delete r[b],delete S[c.url],delete $[b],T(A,function(a,c){a[0]===b&&A.splice(c,1)}),e&&(e.events.defined&&($[b]=e.events),y(b))}),j},enable:function(a){m(h,a.id)&&s(a).enable()},completeLoad:function(a){var b,c,d=m(j.shim,a)||{},g=d.exports;for(x();A.length;){if(null===(c=A.shift())[0]){if(c[0]=a,b)break;b=!0}else c[0]===a&&(b=!0);E(c)}if(c=m(h,a),!b&&!t(r,a)&&c&&!c.inited){if(j.enforceDefine&&(!g||!da(g)))return e(a)?void 0:w(C("nodefine","No define call for "+a,null,[a]));E([a,d.deps||[],d.exportsFn])}D()},nameToUrl:function(a,b,c){var d,e,h;if((d=m(j.pkgs,a))&&(a=d),d=m(aa,a))return i.nameToUrl(d,b,c);if(g.jsExtRegExp.test(a))d=a+(b||"");else{for(d=j.paths,e=(a=a.split("/")).length;0<e;e-=1)if(h=m(d,h=a.slice(0,e).join("/"))){H(h)&&(h=h[0]),a.splice(0,e,h);break}d=a.join("/"),d=("/"===(d+=b||(/^data\:|\?/.test(d)||c?"":".js")).charAt(0)||d.match(/^[\w\+\.\-]+:/)?"":j.baseUrl)+d}return j.urlArgs?d+(-1===d.indexOf("?")?"?":"&")+j.urlArgs:d},load:function(a,b){g.load(i,a,b)},execCb:function(a,b,c,d){return b.apply(d,c)},onScriptLoad:function(a){("load"===a.type||ja.test((a.currentTarget||a.srcElement).readyState))&&(N=null,a=I(a),i.completeLoad(a.id))},onScriptError:function(a){var b=I(a);if(!e(b.id))return w(C("scripterror","Script error for: "+b.id,a,[b.id]))}}).require=i.makeRequire(),i}var g,x,y,D,I,E,N,J,s,O,ka=/(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/gm,la=/[^.]\s*require\s*\(\s*["']([^'"\s]+)["']\s*\)/g,Q=/\.js$/,ia=/^\.\//;x=Object.prototype;var K=x.toString,fa=x.hasOwnProperty,ha=Array.prototype.splice,z=!("undefined"==typeof window||"undefined"==typeof navigator||!window.document),ea=!z&&"undefined"!=typeof importScripts,ja=z&&"PLAYSTATION 3"===navigator.platform?/^complete$/:/^(complete|loaded)$/,Y="undefined"!=typeof opera&&"[object Opera]"===opera.toString(),F={},q={},R=[],M=!1;if(void 0===define){if(void 0!==requirejs){if(G(requirejs))return;q=requirejs,requirejs=void 0}void 0!==require&&!G(require)&&(q=require,require=void 0),g=requirejs=function(b,c,d,e){var n,p="_";return!H(b)&&"string"!=typeof b&&(n=b,H(c)?(b=c,c=d,d=e):b=[]),n&&n.context&&(p=n.context),(e=m(F,p))||(e=F[p]=g.s.newContext(p)),n&&e.configure(n),e.require(b,c,d)},g.config=function(b){return g(b)},g.nextTick="undefined"!=typeof setTimeout?function(b){setTimeout(b,4)}:function(b){b()},require||(require=g),g.version="2.1.15",g.jsExtRegExp=/^\/|:|\?|\.js$/,g.isBrowser=z,x=g.s={contexts:F,newContext:ga},g({}),v(["toUrl","undef","defined","specified"],function(b){g[b]=function(){var c=F._;return c.require[b].apply(c,arguments)}}),z&&(y=x.head=document.getElementsByTagName("head")[0],D=document.getElementsByTagName("base")[0])&&(y=x.head=D.parentNode),g.onError=ca,g.createNode=function(b){var c=b.xhtml?document.createElementNS("http://www.w3.org/1999/xhtml","html:script"):document.createElement("script");return c.type=b.scriptType||"text/javascript",c.charset="utf-8",c.async=!0,c},g.load=function(b,c,d){var e=b&&b.config||{};if(z)return(e=g.createNode(e,c,d)).setAttribute("data-requirecontext",b.contextName),e.setAttribute("data-requiremodule",c),!e.attachEvent||e.attachEvent.toString&&e.attachEvent.toString().indexOf("[native code")<0||Y?(e.addEventListener("load",b.onScriptLoad,!1),e.addEventListener("error",b.onScriptError,!1)):(M=!0,e.attachEvent("onreadystatechange",b.onScriptLoad)),e.src=d,J=e,D?y.insertBefore(e,D):y.appendChild(e),J=null,e;if(ea)try{importScripts(d),b.completeLoad(c)}catch(m){b.onError(C("importscripts","importScripts failed for "+c+" at "+d,m,[c]))}},z&&!q.skipDataMain&&T(document.getElementsByTagName("script"),function(b){if(y||(y=b.parentNode),I=b.getAttribute("data-main"))return s=I,q.baseUrl||(s=(E=s.split("/")).pop(),O=E.length?E.join("/")+"/":"./",q.baseUrl=O),s=s.replace(Q,""),g.jsExtRegExp.test(s)&&(s=I),q.deps=q.deps?q.deps.concat(s):[s],!0}),define=function(b,c,d){var e,g;"string"!=typeof b&&(d=c,c=b,b=null),H(c)||(d=c,c=null),!c&&G(d)&&(c=[],d.length&&(d.toString().replace(ka,"").replace(la,function(b,d){c.push(d)}),c=(1===d.length?["require"]:["require","exports","module"]).concat(c))),M&&((e=J)||(N&&"interactive"===N.readyState||T(document.getElementsByTagName("script"),function(b){if("interactive"===b.readyState)return N=b}),e=N),e&&(b||(b=e.getAttribute("data-requiremodule")),g=F[e.getAttribute("data-requirecontext")])),(g?g.defQueue:R).push([b,c,d])},define.amd={jQuery:!0},g.exec=function(b){return eval(b)},g(q)}}(this);var Utils={checkIfCssExist:function(csslink){var browserStyleSheets=document.styleSheets;if(!browserStyleSheets)return!1;for(var i=0,max=browserStyleSheets.length;i<max;i++)if(browserStyleSheets[i].href&&(browserStyleSheets[i].href.match(csslink)||browserStyleSheets[i].href==csslink))return!0;return!1},getOffsetFromParent:function(elName){var returnVal={x:0,y:0};try{var el=document.getElementById(elName);if(el){var rect=el.getBoundingClientRect();returnVal.x=rect&&rect.x||0,returnVal.y=rect&&rect.y||0}}catch(err){console.log(err)}return returnVal},getOffsetFromHost:function(){var pedigreeDivId=window.PedigreeEditorTool.divId;return Utils.getOffsetFromParent(pedigreeDivId)}};!function(){var embeddedAppConfigFunc=window.embeddedAppConfig,config={};window.PedigreeEditorTool=window.PedigreeEditorTool||{};var loadEnvironmentVariable=function(variableName){var value=config[variableName];if(!value)throw"The environment variable '"+variableName+"' is not defined or available. It must be defined for pedigree tool app to work.";return value};if(!embeddedAppConfigFunc||"function"!=typeof embeddedAppConfigFunc)throw"embeddedAppConfig is not defined. It must be defined at window level for pedigree tool app to work.";if(config=embeddedAppConfigFunc(),window.PedigreeEditorTool.divId=config.divId,console.log("Pedigree DivId="+window.PedigreeEditorTool.divId),window.PedigreeHostProvidesEnvVariable){var pedigreeToolUrl=loadEnvironmentVariable("pedigreeToolUrl"),pedigreeServiceUrl=loadEnvironmentVariable("pedigreeServiceUrl"),lookupServiceUrl=loadEnvironmentVariable("lookupServiceUrl");window.CONSTANTS=window.CONSTANTS||{PEDIGREE_SERVICE_URL:pedigreeServiceUrl,PEDIGREE_TOOL_URL:pedigreeToolUrl,LOOKUP_SERVICE_URL:lookupServiceUrl}}document.stopObserving&&document.stopObserving()}();var Prototype={Version:"1.7.1",Browser:function(){var b=navigator.userAgent,a="[object Opera]"==Object.prototype.toString.call(window.opera);return{IE:!!window.attachEvent&&!a,Opera:a,WebKit:-1<b.indexOf("AppleWebKit/"),Gecko:-1<b.indexOf("Gecko")&&-1===b.indexOf("KHTML"),MobileSafari:/Apple.*Mobile/.test(b)}}(),BrowserFeatures:{XPath:!!document.evaluate,SelectorsAPI:!!document.querySelector,ElementExtensions:function(){var a=window.Element||window.HTMLElement;return!(!a||!a.prototype)}(),SpecificElementExtensions:function(){if(void 0!==window.HTMLDivElement)return!0;var c=document.createElement("div"),b=document.createElement("form"),a=!1;return c.__proto__&&c.__proto__!==b.__proto__&&(a=!0),c=b=null,a}()},ScriptFragment:"<script[^>]*>([\\S\\s]*?)</script\\s*>",JSONFilter:/^\/\*-secure-([\s\S]*)\*\/\s*$/,emptyFunction:function(){},K:function(a){return a}};Prototype.Browser.MobileSafari&&(Prototype.BrowserFeatures.SpecificElementExtensions=!1);var Class=function(){var d=function(){for(var e in{toString:1})if("toString"===e)return!1;return!0}();function a(){}return{create:function(){var h=null,g=$A(arguments);function e(){this.initialize.apply(this,arguments)}Object.isFunction(g[0])&&(h=g.shift()),Object.extend(e,Class.Methods),e.superclass=h,e.subclasses=[],h&&(a.prototype=h.prototype,e.prototype=new a,h.subclasses.push(e));for(var f=0,j=g.length;f<j;f++)e.addMethods(g[f]);return e.prototype.initialize||(e.prototype.initialize=Prototype.emptyFunction),e.prototype.constructor=e},Methods:{addMethods:function(l){var g=this.superclass&&this.superclass.prototype,f=Object.keys(l);d&&(l.toString!=Object.prototype.toString&&f.push("toString"),l.valueOf!=Object.prototype.valueOf&&f.push("valueOf"));for(var e=0,h=f.length;e<h;e++){var k=f[e],j=l[k];if(g&&Object.isFunction(j)&&"$super"==j.argumentNames()[0]){var m=j;(j=function(i){return function(){return g[i].apply(this,arguments)}}(k).wrap(m)).valueOf=function(i){return function(){return i.valueOf.call(i)}}(m),j.toString=function(i){return function(){return i.toString.call(i)}}(m)}this.prototype[k]=j}return this}}}}();!function(){var y=Object.prototype.toString,k=Object.prototype.hasOwnProperty,z="Null",B="Undefined",K="Boolean",w="Number",v="String",I="Object",d="[object Boolean]",j="[object Number]",f="[object String]",b="[object Array]",e=window.JSON&&"function"==typeof JSON.stringify&&"0"===JSON.stringify(0)&&void 0===JSON.stringify(Prototype.K),q=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],a=function(){for(var L in{toString:1})if("toString"===L)return!1;return!0}();function D(M){switch(M){case null:return z;case void 0:return B}switch(typeof M){case"boolean":return K;case"number":return w;case"string":return v}return I}function h(L,N){for(var M in N)L[M]=N[M];return L}function u(L){return y.call(L)===b}function o(L){return void 0===L}"function"==typeof Array.isArray&&Array.isArray([])&&!Array.isArray({})&&(u=Array.isArray),h(Object,{extend:h,inspect:function(L){try{return o(L)?"undefined":null===L?"null":L.inspect?L.inspect():String(L)}catch(M){if(M instanceof RangeError)return"...";throw M}},toJSON:e?function(L){return JSON.stringify(L)}:function(L){return function m(U,R,S){var T=R[U];D(T)===I&&"function"==typeof T.toJSON&&(T=T.toJSON(U));var N=y.call(T);switch(N){case j:case d:case f:T=T.valueOf()}switch(T){case null:return"null";case!0:return"true";case!1:return"false"}var Q=typeof T;switch(Q){case"string":return T.inspect(!0);case"number":return isFinite(T)?String(T):"null";case"object":for(var M=0,L=S.length;M<L;M++)if(S[M]===T)throw new TypeError("Cyclic reference to '"+T+"' in object");S.push(T);var P=[];if(N===b){for(var M=0,L=T.length;M<L;M++){var O=m(M,T,S);P.push(void 0===O?"null":O)}P="["+P.join(",")+"]"}else{for(var V=Object.keys(T),M=0,L=V.length;M<L;M++){var U=V[M],O=m(U,T,S);void 0!==O&&P.push(U.inspect(!0)+":"+O)}P="{"+P.join(",")+"}"}return S.pop(),P}}("",{"":L},[])},toQueryString:function(L){return $H(L).toQueryString()},toHTML:function(L){return L&&L.toHTML?L.toHTML():String.interpret(L)},keys:Object.keys||function(L){if(D(L)!==I)throw new TypeError;var N=[];for(var O in L)k.call(L,O)&&N.push(O);if(a)for(var M=0;O=q[M];M++)k.call(L,O)&&N.push(O);return N},values:function(L){var M=[];for(var N in L)M.push(L[N]);return M},clone:function(L){return h({},L)},isElement:function(L){return!(!L||1!=L.nodeType)},isArray:u,isHash:function(L){return L instanceof Hash},isFunction:function(L){return"[object Function]"===y.call(L)},isString:function(L){return y.call(L)===f},isNumber:function(L){return y.call(L)===j},isDate:function(L){return"[object Date]"===y.call(L)},isUndefined:o})}(),Object.extend(Function.prototype,function(){var l=Array.prototype.slice;function d(p,m){for(var o=p.length,n=m.length;n--;)p[o+n]=m[n];return p}function j(n,m){return d(n=l.call(n,0),m)}var i={argumentNames:function(){var m=this.toString().match(/^[\s\(]*function[^(]*\(([^)]*)\)/)[1].replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g,"").replace(/\s+/g,"").split(",");return 1!=m.length||m[0]?m:[]},bindAsEventListener:function(o){var m=this,n=l.call(arguments,1);return function(q){var p=d([q||window.event],n);return m.apply(o,p)}},curry:function(){if(!arguments.length)return this;var m=this,n=l.call(arguments,0);return function(){var o=j(n,arguments);return m.apply(this,o)}},delay:function(o){var m=this,n=l.call(arguments,1);return o*=1e3,window.setTimeout(function(){return m.apply(m,n)},o)},defer:function(){var m=d([.01],arguments);return this.delay.apply(this,m)},wrap:function(n){var m=this;return function(){var o=d([m.bind(this)],arguments);return n.apply(this,o)}},methodize:function(){if(this._methodized)return this._methodized;var m=this;return this._methodized=function(){var n=d([this],arguments);return m.apply(null,n)}}};return Function.prototype.bind||(i.bind=function(o){if(arguments.length<2&&Object.isUndefined(o))return this;if(!Object.isFunction(this))throw new TypeError("The object is not callable.");var q=function(){},m=this,n=l.call(arguments,1),p=function(){var r=j(n,arguments),s=this instanceof p?this:o;return m.apply(s,r)};return q.prototype=this.prototype,p.prototype=new q,p}),i}()),function(c){c.toISOString||(c.toISOString=function(){return this.getUTCFullYear()+"-"+(this.getUTCMonth()+1).toPaddedString(2)+"-"+this.getUTCDate().toPaddedString(2)+"T"+this.getUTCHours().toPaddedString(2)+":"+this.getUTCMinutes().toPaddedString(2)+":"+this.getUTCSeconds().toPaddedString(2)+"Z"}),c.toJSON||(c.toJSON=function(){return this.toISOString()})}(Date.prototype),RegExp.prototype.match=RegExp.prototype.test,RegExp.escape=function(a){return String(a).replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")};var PeriodicalExecuter=Class.create({initialize:function(b,a){this.callback=b,this.frequency=a,this.currentlyExecuting=!1,this.registerCallback()},registerCallback:function(){this.timer=setInterval(this.onTimerEvent.bind(this),1e3*this.frequency)},execute:function(){this.callback(this)},stop:function(){this.timer&&(clearInterval(this.timer),this.timer=null)},onTimerEvent:function(){if(!this.currentlyExecuting)try{this.currentlyExecuting=!0,this.execute(),this.currentlyExecuting=!1}catch(a){throw this.currentlyExecuting=!1,a}}});Object.extend(String,{interpret:function(a){return null==a?"":String(a)},specialChar:{"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","\\":"\\\\"}}),Object.extend(String.prototype,function(){var NATIVE_JSON_PARSE_SUPPORT=window.JSON&&"function"==typeof JSON.parse&&JSON.parse('{"test": true}').test;function prepareReplacement(replacement){if(Object.isFunction(replacement))return replacement;var template=new Template(replacement);return function(match){return template.evaluate(match)}}function gsub(pattern,replacement){var match,result="",source=this;if(replacement=prepareReplacement(replacement),Object.isString(pattern)&&(pattern=RegExp.escape(pattern)),!pattern.length&&!pattern.source)return(replacement=replacement(""))+source.split("").join(replacement)+replacement;for(;0<source.length;)source=(match=source.match(pattern))?(result+=source.slice(0,match.index),result+=String.interpret(replacement(match)),source.slice(match.index+match[0].length)):(result+=source,"");return result}function sub(pattern,replacement,count){return replacement=prepareReplacement(replacement),count=Object.isUndefined(count)?1:count,this.gsub(pattern,function(match){return--count<0?match[0]:replacement(match)})}function scan(pattern,iterator){return this.gsub(pattern,iterator),String(this)}function truncate(length,truncation){return length=length||30,truncation=Object.isUndefined(truncation)?"...":truncation,this.length>length?this.slice(0,length-truncation.length)+truncation:String(this)}function strip(){return this.replace(/^\s+/,"").replace(/\s+$/,"")}function stripTags(){return this.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")}function stripScripts(){return this.replace(new RegExp(Prototype.ScriptFragment,"img"),"")}function extractScripts(){var matchAll=new RegExp(Prototype.ScriptFragment,"img"),matchOne=new RegExp(Prototype.ScriptFragment,"im");return(this.match(matchAll)||[]).map(function(scriptTag){return(scriptTag.match(matchOne)||["",""])[1]})}function evalScripts(){return this.extractScripts().map(function(script){return eval(script)})}function escapeHTML(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function unescapeHTML(){return this.stripTags().replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")}function toQueryParams(separator){var match=this.strip().match(/([^?#]*)(#.*)?$/);return match?match[1].split(separator||"&").inject({},function(hash,pair){if((pair=pair.split("="))[0]){var key=decodeURIComponent(pair.shift()),value=1<pair.length?pair.join("="):pair[0];null!=value&&(value=decodeURIComponent(value)),key in hash?(Object.isArray(hash[key])||(hash[key]=[hash[key]]),hash[key].push(value)):hash[key]=value}return hash}):{}}function toArray(){return this.split("")}function succ(){return this.slice(0,this.length-1)+String.fromCharCode(this.charCodeAt(this.length-1)+1)}function times(count){return count<1?"":new Array(count+1).join(this)}function camelize(){return this.replace(/-+(.)?/g,function(match,chr){return chr?chr.toUpperCase():""})}function capitalize(){return this.charAt(0).toUpperCase()+this.substring(1).toLowerCase()}function underscore(){return this.replace(/::/g,"/").replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").replace(/-/g,"_").toLowerCase()}function dasherize(){return this.replace(/_/g,"-")}function inspect(useDoubleQuotes){var escapedString=this.replace(/[\x00-\x1f\\]/g,function(character){return character in String.specialChar?String.specialChar[character]:"\\u00"+character.charCodeAt().toPaddedString(2,16)});return useDoubleQuotes?'"'+escapedString.replace(/"/g,'\\"')+'"':"'"+escapedString.replace(/'/g,"\\'")+"'"}function unfilterJSON(filter){return this.replace(filter||Prototype.JSONFilter,"$1")}function isJSON(){var str=this;return!str.blank()&&(str=(str=(str=str.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@")).replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]")).replace(/(?:^|:|,)(?:\s*\[)+/g,""),/^[\],:{}\s]*$/.test(str))}function evalJSON(sanitize){var json=this.unfilterJSON(),cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;cx.test(json)&&(json=json.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));try{if(!sanitize||json.isJSON())return eval("("+json+")")}catch(e){}throw new SyntaxError("Badly formed JSON string: "+this.inspect())}function parseJSON(){var json=this.unfilterJSON();return JSON.parse(json)}function include(pattern){return-1<this.indexOf(pattern)}function startsWith(pattern){return 0===this.lastIndexOf(pattern,0)}function endsWith(pattern){var d=this.length-pattern.length;return 0<=d&&this.indexOf(pattern,d)===d}function empty(){return""==this}function blank(){return/^\s*$/.test(this)}function interpolate(object,pattern){return new Template(this,pattern).evaluate(object)}return{gsub:gsub,sub:sub,scan:scan,truncate:truncate,strip:String.prototype.trim||strip,stripTags:stripTags,stripScripts:stripScripts,extractScripts:extractScripts,evalScripts:evalScripts,escapeHTML:escapeHTML,unescapeHTML:unescapeHTML,toQueryParams:toQueryParams,parseQuery:toQueryParams,toArray:toArray,succ:succ,times:times,camelize:camelize,capitalize:capitalize,underscore:underscore,dasherize:dasherize,inspect:inspect,unfilterJSON:unfilterJSON,isJSON:isJSON,evalJSON:NATIVE_JSON_PARSE_SUPPORT?parseJSON:evalJSON,include:include,startsWith:startsWith,endsWith:endsWith,empty:empty,blank:blank,interpolate:interpolate}}());var Template=Class.create({initialize:function(a,b){this.template=a.toString(),this.pattern=b||Template.Pattern},evaluate:function(a){return a&&Object.isFunction(a.toTemplateReplacements)&&(a=a.toTemplateReplacements()),this.template.gsub(this.pattern,function(d){if(null==a)return d[1]+"";var f=d[1]||"";if("\\"==f)return d[2];var b=a,g=d[3],e=/^([^.[]+|\[((?:.*?[^\\])?)\])(\.|\[|$)/;if(null==(d=e.exec(g)))return f;for(;null!=d;){if(null==(b=b[d[1].startsWith("[")?d[2].replace(/\\\\]/g,"]"):d[1]])||""==d[3])break;g=g.substring("["==d[3]?d[1].length:d[0].length),d=e.exec(g)}return f+String.interpret(b)})}});Template.Pattern=/(^|.|\r|\n)(#\{(.*?)\})/;var $break={},Enumerable=function(){function b(y,x){y=y||Prototype.K;var w=!0;return this.each(function(A,z){if(!(w=w&&!!y.call(x,A,z,this)))throw $break},this),w}function i(y,x){y=y||Prototype.K;var w=!1;return this.each(function(A,z){if(w=!!y.call(x,A,z,this))throw $break},this),w}function j(y,x){y=y||Prototype.K;var w=[];return this.each(function(A,z){w.push(y.call(x,A,z,this))},this),w}function t(y,x){var w;return this.each(function(A,z){if(y.call(x,A,z,this))throw w=A,$break},this),w}function h(y,x){var w=[];return this.each(function(A,z){y.call(x,A,z,this)&&w.push(A)},this),w}function a(w){if(Object.isFunction(this.indexOf)&&-1!=this.indexOf(w))return!0;var x=!1;return this.each(function(y){if(y==w)throw x=!0,$break}),x}function o(){return this.map()}return{each:function(x,w){try{this._each(x,w)}catch(y){if(y!=$break)throw y}return this},eachSlice:function(z,y,x){var w=-z,A=[],B=this.toArray();if(z<1)return B;for(;(w+=z)<B.length;)A.push(B.slice(w,w+z));return A.collect(y,x)},all:b,every:b,any:i,some:i,collect:j,map:j,detect:t,findAll:h,select:h,filter:h,grep:function(z,y,x){y=y||Prototype.K;var w=[];return Object.isString(z)&&(z=new RegExp(RegExp.escape(z))),this.each(function(B,A){z.match(B)&&w.push(y.call(x,B,A,this))},this),w},include:a,member:a,inGroupsOf:function(x,w){return w=Object.isUndefined(w)?null:w,this.eachSlice(x,function(y){for(;y.length<x;)y.push(w);return y})},inject:function(w,y,x){return this.each(function(A,z){w=y.call(x,w,A,z,this)},this),w},invoke:function(x){var w=$A(arguments).slice(1);return this.map(function(y){return y[x].apply(y,w)})},max:function(y,x){var w;return y=y||Prototype.K,this.each(function(A,z){A=y.call(x,A,z,this),(null==w||w<=A)&&(w=A)},this),w},min:function(y,x){var w;return y=y||Prototype.K,this.each(function(A,z){A=y.call(x,A,z,this),(null==w||A<w)&&(w=A)},this),w},partition:function(z,x){z=z||Prototype.K;var y=[],w=[];return this.each(function(B,A){(z.call(x,B,A,this)?y:w).push(B)},this),[y,w]},pluck:function(x){var w=[];return this.each(function(y){w.push(y[x])}),w},reject:function(y,x){var w=[];return this.each(function(A,z){y.call(x,A,z,this)||w.push(A)},this),w},sortBy:function(x,w){return this.map(function(z,y){return{value:z,criteria:x.call(w,z,y,this)}},this).sort(function(B,A){var z=B.criteria,y=A.criteria;return z<y?-1:y<z?1:0}).pluck("value")},toArray1:o,entries1:o,zip:function(){var x=Prototype.K,w=$A(arguments);Object.isFunction(w.last())&&(x=w.pop());var y=[this].concat(w).map($A);return this.map(function(A,z){return x(y.pluck(z))})},size:function(){return this.toArray().length},inspect:function(){return"#<Enumerable:"+this.toArray().inspect()+">"},find:t}}();function $A(c){if(!c)return[];if("toArray"in Object(c))return c.toArray();if("toArray1"in Object(c))return c.toArray1();for(var b=c.length||0,a=new Array(b);b--;)a[b]=c[b];return a}function $w(a){return Object.isString(a)&&(a=a.strip())?a.split(/\s+/):[]}function $H(a){return new Hash(a)}void 0===Array.from&&(Array.from=$A,console.error("Array.from changed")),function(){var x=Array.prototype,p=x.slice,r=x.forEach;function v(){return p.call(this,0)}function u(B){return function(){if(0===arguments.length)return B.call(this,Prototype.K);if(void 0!==arguments[0])return B.apply(this,arguments);var C=p.call(arguments,1);return C.unshift(Prototype.K),B.apply(this,C)}}function w(F){if(null==this)throw new TypeError;F=F||Prototype.K;for(var B=Object(this),E=[],D=arguments[1],H=0,C=0,G=B.length>>>0;C<G;C++)C in B&&(E[H]=F.call(D,B[C],C,B)),H++;return E.length=H,E}function h(F){if(null==this||!Object.isFunction(F))throw new TypeError;for(var H,B=Object(this),E=[],D=arguments[1],C=0,G=B.length>>>0;C<G;C++)C in B&&(H=B[C],F.call(D,H,C,B)&&E.push(H));return E}function i(E){if(null==this)throw new TypeError;E=E||Prototype.K;for(var D=arguments[1],B=Object(this),C=0,F=B.length>>>0;C<F;C++)if(C in B&&E.call(D,B[C],C,B))return!0;return!1}if(r||(r=function(D,C){for(var B=0,E=this.length>>>0;B<E;B++)B in this&&D.call(C,this[B],B,this)}),x.map&&(w=u(Array.prototype.map)),x.filter&&(h=Array.prototype.filter),x.some)var i=u(Array.prototype.some);function z(E){if(null==this)throw new TypeError;E=E||Prototype.K;for(var D=arguments[1],B=Object(this),C=0,F=B.length>>>0;C<F;C++)if(C in B&&!E.call(D,B[C],C,B))return!1;return!0}if(x.every)var z=u(Array.prototype.every);var t=x.reduce;function m(B,D){D=D||Prototype.K;var C=arguments[2];return t.call(this,D.bind(C),B)}if(!x.reduce)var m=Enumerable.inject;Object.extend(x,Enumerable),x._reverse||(x._reverse=x.reverse),Object.extend(x,{_each:r,map:w,collect:w,select:h,filter:h,findAll:h,some:i,any:i,every:z,all:z,inject:m,clear:function(){return this.length=0,this},first:function(){return this[0]},last:function(){return this[this.length-1]},compact:function(){return this.select(function(B){return null!=B})},flatten:function(){return this.inject([],function(C,B){return Object.isArray(B)?C.concat(B.flatten()):(C.push(B),C)})},without:function(){var B=p.call(arguments,0);return this.select(function(C){return!B.include(C)})},reverse:function(B){return(!1===B?this.toArray():this)._reverse()},uniq:function(B){return this.inject([],function(E,D,C){return 0!=C&&(B?E.last()==D:E.include(D))||E.push(D),E})},intersect:function(B){return this.uniq().findAll(function(C){return-1!==B.indexOf(C)})},clone:v,toArray:v,size:function(){return this.length},inspect:function(){return"["+this.map(Object.inspect).join(", ")+"]"}}),function(){return 1!==[].concat(arguments)[0][0]}(1,2)&&(x.concat=function(I){var J,G=[],H=p.call(arguments,0),C=0;H.unshift(this);for(var F=0,B=H.length;F<B;F++)if(J=H[F],!Object.isArray(J)||"callee"in J)G[C++]=J;else for(var E=0,D=J.length;E<D;E++)E in J&&(G[C]=J[E]),C++;return G.length=C,G}),x.indexOf||(x.indexOf=function(E,C){if(null==this)throw new TypeError;var F=Object(this),D=F.length>>>0;if(0===D)return-1;if(C=Number(C),isNaN(C)?C=0:0!==C&&isFinite(C)&&(C=(0<C?1:-1)*Math.floor(Math.abs(C))),D<C)return-1;for(var B=0<=C?C:Math.max(D-Math.abs(C),0);B<D;B++)if(B in F&&F[B]===E)return B;return-1}),x.lastIndexOf||(x.lastIndexOf=function(E,C){if(null==this)throw new TypeError;var F=Object(this),D=F.length>>>0;if(0===D)return-1;Object.isUndefined(C)?C=D:(C=Number(C),isNaN(C)?C=0:0!==C&&isFinite(C)&&(C=(0<C?1:-1)*Math.floor(Math.abs(C))));for(var B=0<=C?Math.min(C,D-1):D-Math.abs(C);0<=B;B--)if(B in F&&F[B]===E)return B;return-1})}();var Hash=Class.create(Enumerable,function(){function o(){return Object.clone(this._object)}function b(p,q){return Object.isUndefined(q)?p:(q=(q=String.interpret(q)).gsub(/(\r)?\n/,"\r\n"),p+"="+(q=(q=encodeURIComponent(q)).gsub(/%20/,"+")))}return{initialize:function(p){this._object=Object.isHash(p)?p.toObject():Object.clone(p)},_each:function(r,q){for(var p in this._object){var s=this._object[p],t=[p,s];t.key=p,t.value=s,r.call(q,t)}},set:function(p,q){return this._object[p]=q},get:function(p){if(this._object[p]!==Object.prototype[p])return this._object[p]},unset:function(p){var q=this._object[p];return delete this._object[p],q},toObject:o,toTemplateReplacements:o,keys:function(){return this.pluck("key")},values:function(){return this.pluck("value")},index:function(q){var p=this.detect(function(r){return r.value===q});return p&&p.key},merge:function(p){return this.clone().update(p)},update:function(p){return new Hash(p).inject(this,function(q,r){return q.set(r.key,r.value),q})},toQueryString:function(){return this.inject([],function(t,w){var s=encodeURIComponent(w.key),q=w.value;if(q&&"object"==typeof q){if(Object.isArray(q)){for(var u,v=[],r=0,p=q.length;r<p;r++)u=q[r],v.push(b(s,u));return t.concat(v)}}else t.push(b(s,q));return t}).join("&")},inspect:function(){return"#<Hash:{"+this.map(function(p){return p.map(Object.inspect).join(": ")}).join(", ")+"}>"},toJSON:o,clone:function(){return new Hash(this)}}}());function $R(c,a,b){return new ObjectRange(c,a,b)}Hash.from=$H,Object.extend(Number.prototype,{toColorPart:function(){return this.toPaddedString(2,16)},succ:function(){return this+1},times:function(j,i){return $R(0,this,!0).each(j,i),this},toPaddedString:function(k,j){var i=this.toString(j||10);return"0".times(k-i.length)+i},abs:function(){return Math.abs(this)},round:function(){return Math.round(this)},ceil:function(){return Math.ceil(this)},floor:function(){return Math.floor(this)}});var ObjectRange=Class.create(Enumerable,{initialize:function(f,d,e){this.start=f,this.end=d,this.exclusive=e},_each:function(e,d){for(var f=this.start;this.include(f);)e.call(d,f),f=f.succ()},include:function(d){return!(d<this.start)&&(this.exclusive?d<this.end:d<=this.end)}}),Abstract={},Try={these:function(){for(var c,b=0,d=arguments.length;b<d;b++){var a=arguments[b];try{c=a();break}catch(f){}}return c}},Ajax={getTransport:function(){return Try.these(function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")})||!1},activeRequestCount:0};Ajax.Responders={responders:[],_each:function(b,a){this.responders._each(b,a)},register:function(a){this.include(a)||this.responders.push(a)},unregister:function(a){this.responders=this.responders.without(a)},dispatch:function(d,b,c,a){this.each(function(f){if(Object.isFunction(f[d]))try{f[d].apply(f,[b,c,a])}catch(g){}})}},Object.extend(Ajax.Responders,Enumerable),Ajax.Responders.register({onCreate:function(){Ajax.activeRequestCount++},onComplete:function(){Ajax.activeRequestCount--}}),Ajax.Base=Class.create({initialize:function(a){this.options={method:"post",asynchronous:!0,contentType:"application/x-www-form-urlencoded",encoding:"UTF-8",parameters:"",evalJSON:!0,evalJS:!0},Object.extend(this.options,a||{}),this.options.method=this.options.method.toLowerCase(),Object.isHash(this.options.parameters)&&(this.options.parameters=this.options.parameters.toObject())}}),Ajax.Request=Class.create(Ajax.Base,{_complete:!1,initialize:function($super,b,a){$super(a),this.transport=Ajax.getTransport(),this.request(b)},request:function(b){"string"==typeof b?this.url=b:b&&"string"==typeof b.href?this.url=b.href:this.url=b+"",this.method=this.options.method;var d=Object.isString(this.options.parameters)?this.options.parameters:Object.toQueryString(this.options.parameters);["get","post"].include(this.method)||(d+=(d?"&":"")+"_method="+this.method,this.method="post"),d&&"get"===this.method&&(this.url+=(this.url.include("?")?"&":"?")+d),this.parameters=d.toQueryParams();try{var a=new Ajax.Response(this);this.options.onCreate&&this.options.onCreate(a),Ajax.Responders.dispatch("onCreate",this,a),this.transport.open(this.method.toUpperCase(),this.url,this.options.asynchronous),this.options.asynchronous&&this.respondToReadyState.bind(this).defer(1),this.transport.onreadystatechange=this.onStateChange.bind(this),this.setRequestHeaders(),this.body="post"==this.method?this.options.postBody||d:null,this.transport.send(this.body),!this.options.asynchronous&&this.transport.overrideMimeType&&this.onStateChange()}catch(c){this.dispatchException(c)}},onStateChange:function(){var a=this.transport.readyState;1<a&&(4!=a||!this._complete)&&this.respondToReadyState(this.transport.readyState)},setRequestHeaders:function(){var e={"X-Requested-With":"XMLHttpRequest","X-Prototype-Version":Prototype.Version,Accept:"text/javascript, text/html, application/xml, text/xml, */*","Access-Control-Allow-Origin":"*",Authorization:PedigreeEditorTool.accessToken};if("post"==this.method&&(e["Content-type"]=this.options.contentType+(this.options.encoding?"; charset="+this.options.encoding:""),this.transport.overrideMimeType&&(navigator.userAgent.match(/Gecko\/(\d{4})/)||[0,2005])[1]<2005&&(e.Connection="close")),"object"==typeof this.options.requestHeaders){var c=this.options.requestHeaders;if(Object.isFunction(c.push))for(var b=0,d=c.length;b<d;b+=2)e[c[b]]=c[b+1];else $H(c).each(function(f){e[f.key]=f.value})}for(var a in e)this.transport.setRequestHeader(a,e[a])},success:function(){var a=this.getStatus();return!a||200<=a&&a<300||304==a},getStatus:function(){try{return 1223===this.transport.status?204:this.transport.status||0}catch(a){return 0}},respondToReadyState:function(a){var c=Ajax.Request.Events[a],b=new Ajax.Response(this);if("Complete"==c){try{this._complete=!0,(this.options["on"+b.status]||this.options["on"+(this.success()?"Success":"Failure")]||Prototype.emptyFunction)(b,b.headerJSON)}catch(d){this.dispatchException(d)}var f=b.getHeader("Content-type");("force"==this.options.evalJS||this.options.evalJS&&this.isSameOrigin()&&f&&f.match(/^\s*(text|application)\/(x-)?(java|ecma)script(;.*)?\s*$/i))&&this.evalResponse()}try{(this.options["on"+c]||Prototype.emptyFunction)(b,b.headerJSON),Ajax.Responders.dispatch("on"+c,this,b,b.headerJSON)}catch(d){this.dispatchException(d)}"Complete"==c&&(this.transport.onreadystatechange=Prototype.emptyFunction)},isSameOrigin:function(){var a=this.url.match(/^\s*https?:\/\/[^\/]*/);return!a||a[0]=="#{protocol}//#{domain}#{port}".interpolate({protocol:location.protocol,domain:document.domain,port:location.port?":"+location.port:""})},getHeader:function(a){try{return this.transport.getResponseHeader(a)||null}catch(b){return null}},evalResponse:function(){try{return eval((this.transport.responseText||"").unfilterJSON())}catch(e){this.dispatchException(e)}},dispatchException:function(a){(this.options.onException||Prototype.emptyFunction)(this,a),Ajax.Responders.dispatch("onException",this,a)}}),Ajax.Request.Events=["Uninitialized","Loading","Loaded","Interactive","Complete"],Ajax.Response=Class.create({initialize:function(c){this.request=c;var d=this.transport=c.transport,a=this.readyState=d.readyState;if((2<a&&!Prototype.Browser.IE||4==a)&&(this.status=this.getStatus(),this.statusText=this.getStatusText(),this.responseText=String.interpret(d.responseText),this.headerJSON=this._getHeaderJSON()),4==a){var b=d.responseXML;this.responseXML=Object.isUndefined(b)?null:b,this.responseJSON=this._getResponseJSON()}},status:0,statusText:"",getStatus:Ajax.Request.prototype.getStatus,getStatusText:function(){try{return this.transport.statusText||""}catch(a){return""}},getHeader:Ajax.Request.prototype.getHeader,getAllHeaders:function(){try{return this.getAllResponseHeaders()}catch(a){return null}},getResponseHeader:function(a){return this.transport.getResponseHeader(a)},getAllResponseHeaders:function(){return this.transport.getAllResponseHeaders()},_getHeaderJSON:function(){var a=this.getHeader("X-JSON");if(!a)return null;try{a=decodeURIComponent(escape(a))}catch(b){}try{return a.evalJSON(this.request.options.sanitizeJSON||!this.request.isSameOrigin())}catch(b){this.request.dispatchException(b)}},_getResponseJSON:function(){var a=this.request.options;if(!a.evalJSON||"force"!=a.evalJSON&&!(this.getHeader("Content-type")||"").include("application/json")||this.responseText.blank())return null;try{return this.responseText.evalJSON(a.sanitizeJSON||!this.request.isSameOrigin())}catch(b){this.request.dispatchException(b)}}}),Ajax.Updater=Class.create(Ajax.Request,{initialize:function($super,a,c,b){this.container={success:a.success||a,failure:a.failure||(a.success?null:a)};var d=(b=Object.clone(b)).onComplete;b.onComplete=function(e,f){this.updateContent(e.responseText),Object.isFunction(d)&&d(e,f)}.bind(this),$super(c,b)},updateContent:function(d){var c=this.container[this.success()?"success":"failure"],a=this.options;if(a.evalScripts||(d=d.stripScripts()),c=$(c))if(a.insertion)if(Object.isString(a.insertion)){var b={};b[a.insertion]=d,c.insert(b)}else a.insertion(c,d);else c.update(d)}}),Ajax.PeriodicalUpdater=Class.create(Ajax.Base,{initialize:function($super,a,c,b){$super(b),this.onComplete=this.options.onComplete,this.frequency=this.options.frequency||2,this.decay=this.options.decay||1,this.updater={},this.container=a,this.url=c,this.start()},start:function(){this.options.onComplete=this.updateComplete.bind(this),this.onTimerEvent()},stop:function(){this.updater.options.onComplete=void 0,clearTimeout(this.timer),(this.onComplete||Prototype.emptyFunction).apply(this,arguments)},updateComplete:function(a){this.options.decay&&(this.decay=a.responseText==this.lastText?this.decay*this.options.decay:1,this.lastText=a.responseText),this.timer=this.onTimerEvent.bind(this).delay(this.decay*this.frequency)},onTimerEvent:function(){this.updater=new Ajax.Updater(this.container,this.url,this.options)}}),function(a6){var aC,aZ=Array.prototype.slice,at=document.createElement("div");function aX(bm){if(1<arguments.length){for(var F=0,bo=[],bn=arguments.length;F<bn;F++)bo.push(aX(arguments[F]));return bo}return Object.isString(bm)&&(bm=document.getElementById(bm)),aD.extend(bm)}a6.$=aX,a6.Node||(a6.Node={}),a6.Node.ELEMENT_NODE||Object.extend(a6.Node,{ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12});var p={};var c=function(){try{var i=document.createElement('<input name="x">');return"input"===i.tagName.toLowerCase()&&"x"===i.name}catch(F){return!1}}(),aG=a6.Element;function aD(F,i){if(i=i||{},F=F.toLowerCase(),c&&i.name)return F="<"+F+' name="'+i.name+'">',delete i.name,aD.writeAttribute(document.createElement(F),i);p[F]||(p[F]=aD.extend(document.createElement(F)));var bm=function(F,i){return"select"!==F&&!("type"in i)}(F,i)?p[F].cloneNode(!1):document.createElement(F);return aD.writeAttribute(bm,i)}a6.Element=aD,Object.extend(a6.Element,aG||{}),aG&&(a6.Element.prototype=aG.prototype),aD.Methods={ByTag:{},Simulated:{}};var a1={},E={id:"id",className:"class"};a1.inspect=function(F){var bm,bo,i="<"+(F=aX(F)).tagName.toLowerCase();for(var bn in E)bm=E[bn],(bo=(F[bn]||"").toString())&&(i+=" "+bm+"="+bo.inspect(!0));return i+">"},Object.extend(a1,{visible:function(i){return"none"!==aX(i).style.display},toggle:function(F,i){return F=aX(F),Object.isUndefined(i)&&(i=!aD.visible(F)),aD[i?"show":"hide"](F),F},hide:function(i){return(i=aX(i)).style.display="none",i},show:function(i){return(i=aX(i)).style.display="",i}});var i,F,aR=(i=document.createElement("select"),F=!0,i.innerHTML='<option value="test">test</option>',i.options&&i.options[0]&&(F="OPTION"!==i.options[0].nodeName.toUpperCase()),i=null,F),G=function(){try{var i=document.createElement("table");if(i&&i.tBodies){i.innerHTML="<tbody><tr><td>test</td></tr></tbody>";var bm=void 0===i.tBodies[0];return i=null,bm}}catch(F){return!0}}(),a0=function(){try{var i=document.createElement("div");i.innerHTML="<link />";var bm=0===i.childNodes.length;return i=null,bm}catch(F){return!0}}(),v=aR||G||a0,ao=function(){var i=document.createElement("script"),bm=!1;try{i.appendChild(document.createTextNode("")),bm=!i.firstChild||i.firstChild&&3!==i.firstChild.nodeType}catch(F){bm=!0}return i=null,bm}();function af(F,bm){if(F=aX(F),bm&&bm.toElement)bm=bm.toElement();else if(!Object.isElement(bm)){bm=Object.toHTML(bm);var i=F.ownerDocument.createRange();i.selectNode(F),bm.evalScripts.bind(bm).defer(),bm=i.createContextualFragment(bm.stripScripts())}return F.parentNode.replaceChild(bm,F),F}var aK,J={before:function(i,F){i.parentNode.insertBefore(F,i)},top:function(i,F){i.insertBefore(F,i.firstChild)},bottom:function(i,F){i.appendChild(F)},after:function(i,F){i.parentNode.insertBefore(F,i.nextSibling)},tags:{TABLE:["<table>","</table>",1],TBODY:["<table><tbody>","</tbody></table>",2],TR:["<table><tbody><tr>","</tr></tbody></table>",3],TD:["<table><tbody><tr><td>","</td></tr></tbody></table>",4],SELECT:["<select>","</select>",1]}},aH=J.tags;function bk(bo,bq,F){F=F.toLowerCase();var bs=J[F];if(bq&&bq.toElement&&(bq=bq.toElement()),Object.isElement(bq))return bs(bo,bq),bo;bq=Object.toHTML(bq);var br=r(("before"===F||"after"===F?bo.parentNode:bo).tagName.toUpperCase(),bq.stripScripts());"top"!==F&&"after"!==F||br.reverse();for(var bp,bm=0;bp=br[bm];bm++)bs(bo,bp);bq.evalScripts.bind(bq).defer()}function r(bp,bo,bq){var bn=J.tags[bp],bs=at,br=bs;bs.style.display="none",document.documentElement.appendChild(bs);var F=!!bn;if(!F&&bq&&(F=!0,bn=["","",0]),F){bs.innerHTML="&#160;"+bn[0]+bo+bn[1],bs.removeChild(bs.firstChild);for(var bm=bn[2];bm--;)bs=bs.firstChild}else bs.innerHTML=bo;return document.documentElement.removeChild(br),br.style.display="",$A(bs.childNodes)}function X(F){var i=K(F);i&&(aD.stopObserving(F),aW||(F._prototypeUID=aC),delete aD.Storage[i])}function ak(i,bm,bn){i=aX(i),bn=bn||-1;for(var F=[];(i=i[bm])&&(i.nodeType===Node.ELEMENT_NODE&&F.push(aD.extend(i)),F.length!==bn););return F}function bf(F){for(var i=[],bm=aX(F).firstChild;bm;)bm.nodeType===Node.ELEMENT_NODE&&i.push(aD.extend(bm)),bm=bm.nextSibling;return i}function n(i){return ak(i,"previousSibling")}function be(i){return ak(i,"nextSibling")}function aU(F,bm,bn,i){for(F=aX(F),bn=bn||0,i=i||0,Object.isNumber(bn)&&(i=bn,bn=null);F=F[bm];)if(1===F.nodeType&&(!bn||Prototype.Selector.match(F,bn))&&!(0<=--i))return aD.extend(F)}function a9(i){i=aX(i);var F=aZ.call(arguments,1).join(", ");return Prototype.Selector.select(F,i)}function B(F,i){for(F=aX(F),i=aX(i);F=F.parentNode;)if(F===i)return!0;return!1}Object.extend(aH,{THEAD:aH.TBODY,TFOOT:aH.TBODY,TH:aH.TD}),"outerHTML"in document.documentElement&&(af=function(bm,bp){if(bm=aX(bm),bp&&bp.toElement&&(bp=bp.toElement()),Object.isElement(bp))return bm.parentNode.replaceChild(bp,bm),bm;bp=Object.toHTML(bp);var bo=bm.parentNode,F=bo.tagName.toUpperCase();if(F in J.tags){var bn,bq=aD.next(bm),i=r(F,bp.stripScripts());bo.removeChild(bm),bn=bq?function(br){bo.insertBefore(br,bq)}:function(br){bo.appendChild(br)},i.each(bn)}else bm.outerHTML=bp.stripScripts();return bp.evalScripts.bind(bp).defer(),bm}),Object.extend(a1,{remove:function(i){return(i=aX(i)).parentNode.removeChild(i),i},update:function(bo,bq){for(var br=(bo=aX(bo)).getElementsByTagName("*"),bn=br.length;bn--;)X(br[bn]);if(bq&&bq.toElement&&(bq=bq.toElement()),Object.isElement(bq))return bo.update().insert(bq);bq=Object.toHTML(bq);var bm=bo.tagName.toUpperCase();if("SCRIPT"===bm&&ao)return bo.text=bq,bo;if(v)if(bm in J.tags){for(;bo.firstChild;)bo.removeChild(bo.firstChild);var F=r(bm,bq.stripScripts());for(bn=0;bp=F[bn];bn++)bo.appendChild(bp)}else if(a0&&Object.isString(bq)&&-1<bq.indexOf("<link")){for(;bo.firstChild;)bo.removeChild(bo.firstChild);var bp;for(F=r(bm,bq.stripScripts(),!0),bn=0;bp=F[bn];bn++)bo.appendChild(bp)}else bo.innerHTML=bq.stripScripts();else bo.innerHTML=bq.stripScripts();return bq.evalScripts.bind(bq).defer(),bo},replace:af,insert:function(F,bm){for(var i in F=aX(F),function(i){return!(Object.isUndefined(i)||null===i||!Object.isString(i)&&!Object.isNumber(i)&&!Object.isElement(i)&&!i.toElement&&!i.toHTML)}(bm)&&(bm={bottom:bm}),bm)bk(F,bm[i],i);return F},wrap:function(F,bm,i){return F=aX(F),Object.isElement(bm)?aX(bm).writeAttribute(i||{}):bm=Object.isString(bm)?new aD(bm,i):new aD("div",bm),F.parentNode&&F.parentNode.replaceChild(bm,F),bm.appendChild(F),bm},cleanWhitespace:function(F){for(var bm=(F=aX(F)).firstChild;bm;){var i=bm.nextSibling;bm.nodeType!==Node.TEXT_NODE||/\S/.test(bm.nodeValue)||F.removeChild(bm),bm=i}return F},empty:function(i){return aX(i).innerHTML.blank()},clone:function(bn,F){if(bn=aX(bn)){var bp=bn.cloneNode(F);if(!aW&&(bp._prototypeUID=aC,F))for(var bo=aD.select(bp,"*"),bm=bo.length;bm--;)bo[bm]._prototypeUID=aC;return aD.extend(bp)}},purge:function(bm){if(bm=aX(bm)){X(bm);for(var bn=bm.getElementsByTagName("*"),F=bn.length;F--;)X(bn[F]);return null}}}),aK=at.compareDocumentPosition?function(F,i){return F=aX(F),i=aX(i),8==(8&F.compareDocumentPosition(i))}:at.contains?function(F,i){return F=aX(F),(i=aX(i)).contains?i.contains(F)&&i!==F:B(F,i)}:B,Object.extend(a1,{recursivelyCollect:ak,ancestors:function(i){return ak(i,"parentNode")},descendants:function(i){return aD.select(i,"*")},firstDescendant:function(i){for(i=aX(i).firstChild;i&&i.nodeType!==Node.ELEMENT_NODE;)i=i.nextSibling;return aX(i)},immediateDescendants:bf,previousSiblings:n,nextSiblings:be,siblings:function(i){var bm=n(i=aX(i)),F=be(i);return bm.reverse().concat(F)},match:function(F,i){return F=aX(F),Object.isString(i)?Prototype.Selector.match(F,i):i.match(F)},up:function(F,bm,i){return F=aX(F),1===arguments.length?aX(F.parentNode):aU(F,"parentNode",bm,i)},down:function(F,bn,i){F=aX(F),bn=bn||0,i=i||0,Object.isNumber(bn)&&(i=bn,bn="*");var bm=Prototype.Selector.select(bn,F)[i];return aD.extend(bm)},previous:function(F,bm,i){return aU(F,"previousSibling",bm,i)},next:function(F,bm,i){return aU(F,"nextSibling",bm,i)},select:a9,adjacent:function(bn){bn=aX(bn);for(var bo,bp=aZ.call(arguments,1).join(", "),bq=aD.siblings(bn),bm=[],F=0;bo=bq[F];F++)Prototype.Selector.match(bo,bp)&&bm.push(bo);return bm},descendantOf:aK,getElementsBySelector:a9,childElements:bf});var R=1;function a7(F,i){return aX(F).getAttribute(i)}(function(){at.setAttribute("onclick",Prototype.emptyFunction);var F="function"==typeof at.getAttribute("onclick");return at.removeAttribute("onclick"),F})()?a7=function(F,i){F=aX(F);var bm=aE.read;return bm.values[i]?bm.values[i](F,i):(bm.names[i]&&(i=bm.names[i]),i.include(":")?F.attributes&&F.attributes[i]?F.attributes[i].value:null:F.getAttribute(i))}:Prototype.Browser.Opera&&(a7=function(F,i){return"title"===i?F.title:F.getAttribute(i)}),a6.Element.Methods.Simulated.hasAttribute=function(i,bm){bm=aE.has[bm]||bm;var F=aX(i).getAttributeNode(bm);return!(!F||!F.specified)};var T={};function e(F){if(T[F])return T[F];var i=new RegExp("(^|\\s+)"+F+"(\\s+|$)");return T[F]=i}function aj(i,F){if(i=aX(i)){var bm=i.className;return 0!==bm.length&&(bm===F||e(F).test(bm))}}var aE={},aN="className",ap="for";at.setAttribute(aN,"x"),"x"!==at.className&&(at.setAttribute("class","x"),"x"===at.className&&(aN="class"));var aI=document.createElement("label");function f(i,F){return i.getAttribute(F,2)}function bg(i,F){return aX(i).hasAttribute(F)?F:null}aI.setAttribute(ap,"x"),"x"!==aI.htmlFor&&(aI.setAttribute("htmlFor","x"),"x"===aI.htmlFor&&(ap="htmlFor")),aI=null,at.onclick=Prototype.emptyFunction;var au,N=at.getAttribute("onclick");-1<String(N).indexOf("{")?au=function(i,F){var bm=i.getAttribute(F);return bm?(bm=(bm=(bm=bm.toString()).split("{")[1]).split("}")[0]).strip():null}:""===N&&(au=function(i,F){var bm=i.getAttribute(F);return bm?bm.strip():null}),aE.read={names:{class:aN,className:aN,for:ap,htmlFor:ap},values:{style:function(i){return i.style.cssText.toLowerCase()},title:function(i){return i.title}}},aE.write={names:{className:"class",htmlFor:"for",cellpadding:"cellPadding",cellspacing:"cellSpacing"},values:{checked:function(i,F){i.checked=!!F},style:function(i,F){i.style.cssText=F||""}}},aE.has={names:{}},Object.extend(aE.write.names,aE.read.names);for(var ae,a4=$w("colSpan rowSpan vAlign dateTime accessKey tabIndex encType maxLength readOnly longDesc frameBorder"),ad=0;ae=a4[ad];ad++)aE.write.names[ae.toLowerCase()]=ae,aE.has.names[ae.toLowerCase()]=ae;function aM(F,bm){F=aX(F),bm=function(i){return"float"===i||"styleFloat"===i?"cssFloat":i.camelize()}(bm);var bn=F.style[bm];if(!bn||"auto"===bn){var i=document.defaultView.getComputedStyle(F,null);bn=i?i[bm]:null}return"opacity"===bm?bn?parseFloat(bn):1:"auto"===bn?null:bn}function ay(i){return(i||"").replace(/alpha\([^\)]*\)/gi,"")}Object.extend(aE.read.values,{href:f,src:f,type:function(i,F){return i.getAttribute(F)},action:function(i,bm){var F=i.getAttributeNode(bm);return F?F.value:""},disabled:bg,checked:bg,readonly:bg,multiple:bg,onload:au,onunload:au,onclick:au,ondblclick:au,onmousedown:au,onmouseup:au,onmouseover:au,onmousemove:au,onmouseout:au,onfocus:au,onblur:au,onkeypress:au,onkeydown:au,onkeyup:au,onsubmit:au,onreset:au,onselect:au,onchange:au}),Object.extend(a1,{identify:function(i){i=aX(i);var F=aD.readAttribute(i,"id");if(F)return F;for(;aX(F="anonymous_element_"+R++););return aD.writeAttribute(i,"id",F),F},readAttribute:a7,writeAttribute:function(bn,bm,bp){bn=aX(bn);var F={},bo=aE.write;for(var i in"object"==typeof bm?F=bm:F[bm]=!!Object.isUndefined(bp)||bp,F)bm=bo.names[i]||i,bp=F[i],bo.values[i]&&(bm=bo.values[i](bn,bp)),!1===bp||null===bp?bn.removeAttribute(bm):!0===bp?bn.setAttribute(bm,bm):bn.setAttribute(bm,bp);return bn},classNames:function(i){return new aD.ClassNames(i)},hasClassName:aj,addClassName:function(i,F){if(i=aX(i))return aj(i,F)||(i.className+=(i.className?" ":"")+F),i},removeClassName:function(i,F){if(i=aX(i))return i.className=i.className.replace(e(F)," ").strip(),i},toggleClassName:function(F,bm,i){if(F=aX(F))return Object.isUndefined(i)&&(i=!aj(F,bm)),(0,aD[i?"addClassName":"removeClassName"])(F,bm)}});var L=(at.style.cssText="opacity:.55",/^0.55/.test(at.style.opacity));function x(i,F){return 1==F||""===F?F="":F<1e-5&&(F=0),(i=aX(i)).style.opacity=F,i}function bb(i){return aD.getStyle(i,"opacity")}function bc(F){if(L)return bb(F);var bm=aD.getStyle(F,"filter");if(0===bm.length)return 1;var i=(bm||"").match(/alpha\(opacity=(.*)\)/);return i[1]?parseFloat(i[1])/100:1}Object.extend(a1,{setStyle:function(bm,bn){var bq=(bm=aX(bm)).style;if(Object.isString(bn)){if(bq.cssText+=";"+bn,bn.include("opacity")){var i=bn.match(/opacity:\s*(\d?\.?\d*)/)[1];aD.setOpacity(bm,i)}return bm}for(var bp in bn)if("opacity"===bp)aD.setOpacity(bm,bn[bp]);else{var bo=bn[bp];"float"!==bp&&"cssFloat"!==bp||(bp=Object.isUndefined(bq.styleFloat)?"cssFloat":"styleFloat"),bq[bp]=bo}return bm},getStyle:aM,setOpacity:x,getOpacity:bb}),"styleFloat"in at.style&&(a1.getStyle=function(i,F){i=aX(i),F=function(i){return"float"===i||"cssFloat"===i?"styleFloat":i.camelize()}(F);var bm=i.style[F];return!bm&&i.currentStyle&&(bm=i.currentStyle[F]),"opacity"!==F||L?"auto"===bm?"width"!==F&&"height"!==F||!aD.visible(i)?null:aD.measure(i,F)+"px":bm:bc(i)},a1.setOpacity=function(i,bn){if(L)return x(i,bn);i=function(i){return i.currentStyle&&i.currentStyle.hasLayout||(i.style.zoom=1),i}(aX(i));var bm=aD.getStyle(i,"filter"),F=i.style;return 1==bn||""===bn?(bm=ay(bm))?F.filter=bm:F.removeAttribute("filter"):(bn<1e-5&&(bn=0),F.filter=ay(bm)+"alpha(opacity="+100*bn+")"),i},a1.getOpacity=bc);function K(i){return i===window?0:(void 0===i._prototypeUID&&(i._prototypeUID=aD.Storage.UID++),i._prototypeUID)}a6.Element.Storage={UID:1};var aW="uniqueID"in at;function a(F){if(F=aX(F)){var i=K(F);return aD.Storage[i]||(aD.Storage[i]=$H()),aD.Storage[i]}}aW&&(K=function(i){return i===window?0:i==document?1:i.uniqueID}),Object.extend(a1,{getStorage:a,store:function(F,i,bm){if(F=aX(F)){var bn=a(F);return 2===arguments.length?bn.update(i):bn.set(i,bm),F}},retrieve:function(bm,F,i){if(bm=aX(bm)){var bo=a(bm),bn=bo.get(F);return Object.isUndefined(bn)&&(bo.set(F,i),bn=i),bn}}});var al={},aV=aD.Methods.ByTag,aA=Prototype.BrowserFeatures;!aA.ElementExtensions&&"__proto__"in at&&(a6.HTMLElement={},a6.HTMLElement.prototype=at.__proto__,aA.ElementExtensions=!0);var an=function(i){if(void 0===window.Element)return!1;var bm=window.Element.prototype;if(bm){var bo="_"+(Math.random()+"").slice(2),F=document.createElement(i),bn=(bm[bo]="x")!==F[bo];return delete bm[bo],F=null,bn}return!1}("object");function ai(F,i){for(var bn in i){var bm=i[bn];!Object.isFunction(bm)||bn in F||(F[bn]=bm.methodize())}}var bh={};function aw(F){return K(F)in bh}function ax(bm){if(!bm||aw(bm))return bm;if(bm.nodeType!==Node.ELEMENT_NODE||bm==window)return bm;var i=Object.clone(al),F=bm.tagName.toUpperCase();return aV[F]&&Object.extend(i,aV[F]),ai(bm,i),bh[K(bm)]=!0,bm}function Q(F,i){F=F.toUpperCase(),aV[F]||(aV[F]={}),Object.extend(aV[F],i)}function o(F,bm,i){for(var bo in Object.isUndefined(i)&&(i=!1),bm){var bn=bm[bo];Object.isFunction(bn)&&(i&&bo in F||(F[bo]=bn.methodize()))}}function ag(bn){var i,bm={OPTGROUP:"OptGroup",TEXTAREA:"TextArea",P:"Paragraph",FIELDSET:"FieldSet",UL:"UList",OL:"OList",DL:"DList",DIR:"Directory",H1:"Heading",H2:"Heading",H3:"Heading",H4:"Heading",H5:"Heading",H6:"Heading",Q:"Quote",INS:"Mod",DEL:"Mod",A:"Anchor",IMG:"Image",CAPTION:"TableCaption",COL:"TableCol",COLGROUP:"TableCol",THEAD:"TableSection",TFOOT:"TableSection",TBODY:"TableSection",TR:"TableRow",TH:"TableCell",TD:"TableCell",FRAMESET:"FrameSet",IFRAME:"IFrame"};if(bm[bn]&&(i="HTML"+bm[bn]+"Element"),window[i])return window[i];if(i="HTML"+bn+"Element",window[i])return window[i];if(i="HTML"+bn.capitalize()+"Element",window[i])return window[i];var F=document.createElement(bn),bo=F.__proto__||F.constructor.prototype;return F=null,bo}aA.SpecificElementExtensions&&(ax=an?function(F){if(!F||aw(F))return F;var i=F.tagName;return i&&/^(?:object|applet|embed)$/i.test(i)&&(ai(F,aD.Methods),ai(F,aD.Methods.Simulated),ai(F,aD.Methods.ByTag[i.toUpperCase()])),F}:Prototype.K),Object.extend(a6.Element,{extend:ax,addMethods:function(bo){if(0===arguments.length&&(Object.extend(Form,Form.Methods),Object.extend(Form.Element,Form.Element.Methods),Object.extend(aD.Methods.ByTag,{FORM:Object.clone(Form.Methods),INPUT:Object.clone(Form.Element.Methods),SELECT:Object.clone(Form.Element.Methods),TEXTAREA:Object.clone(Form.Element.Methods),BUTTON:Object.clone(Form.Element.Methods)})),2===arguments.length){var bq=bo;bo=arguments[1]}if(bq)if(Object.isArray(bq))for(var bp=0;bn=bq[bp];bp++)Q(bn,bo);else Q(bq,bo);else Object.extend(aD.Methods,bo||{});var bm=window.HTMLElement?HTMLElement.prototype:aD.prototype;if(aA.ElementExtensions&&(o(bm,aD.Methods),o(bm,aD.Methods.Simulated,!0)),aA.SpecificElementExtensions)for(var bn in aD.Methods.ByTag){var F=ag(bn);Object.isUndefined(F)||o(F.prototype,aV[bn])}Object.extend(aD,aD.Methods),Object.extend(aD,aD.Methods.Simulated),delete aD.ByTag,delete aD.Simulated,aD.extend.refresh(),p={}}}),ax===Prototype.K?a6.Element.extend.refresh=Prototype.emptyFunction:a6.Element.extend.refresh=function(){Prototype.BrowserFeatures.ElementExtensions||(Object.extend(al,aD.Methods),Object.extend(al,aD.Methods.Simulated),bh={})},aD.addMethods(a1)}(this),function(){function y(G,H){var I=(G=$(G)).style[H];if(!I||"auto"===I){var F=document.defaultView.getComputedStyle(G,null);I=F?F[H]:null}return"opacity"===H?I?parseFloat(I):1:"auto"===I?null:I}function r(H,G){return H.offsetWidth-(u(H,"borderLeftWidth",G)||0)-(u(H,"borderRightWidth",G)||0)-(u(H,"paddingLeft",G)||0)-(u(H,"paddingRight",G)||0)}function u(P,Q,G){var J=null;if(Object.isElement(P)&&(P=y(J=P,Q)),null===P||Object.isUndefined(P))return null;if(/^(?:-)?\d+(\.\d+)?(px)?$/i.test(P))return window.parseFloat(P);var K=P.include("%"),H=G===document.viewport;if(/\d/.test(P)&&J&&J.runtimeStyle&&(!K||!H)){var F=J.style.left,O=J.runtimeStyle.left;return J.runtimeStyle.left=J.currentStyle.left,J.style.left=P||0,P=J.style.pixelLeft,J.style.left=F,J.runtimeStyle.left=O,P}if(J&&K){G=G||J.parentNode;var I=function(G){var F=G.match(/^(\d+)%?$/i);return F?Number(F[1])/100:null}(P),L=null,N=Q.include("left")||Q.include("right")||Q.include("width"),M=Q.include("top")||Q.include("bottom")||Q.include("height");return G===document.viewport?N?L=document.viewport.getWidth():M&&(L=document.viewport.getHeight()):N?L=$(G).measure("width"):M&&(L=$(G).measure("height")),null===L?0:L*I}return 0}"currentStyle"in document.documentElement&&(y=function(F,G){var H=F.style[G];return!H&&F.currentStyle&&(H=F.currentStyle[G]),H});var g=Prototype.K;function p(F){if(h(F=$(F))||f(F)||o(F)||n(F))return $(document.body);if(!("inline"===Element.getStyle(F,"display"))&&F.offsetParent)return $(F.offsetParent);for(;(F=F.parentNode)&&F!==document.body;)if("static"!==Element.getStyle(F,"position"))return n(F)?$(document.body):$(F);return $(document.body)}function C(G){var F=0,H=0;if((G=$(G)).parentNode)for(;F+=G.offsetTop||0,H+=G.offsetLeft||0,G=G.offsetParent;);return new Element.Offset(H,F)}function w(G){var H=(G=$(G)).getLayout(),F=0,J=0;do{if(F+=G.offsetTop||0,J+=G.offsetLeft||0,G=G.offsetParent){if(o(G))break;if("static"!==Element.getStyle(G,"position"))break}}while(G);return J-=H.get("margin-top"),F-=H.get("margin-left"),new Element.Offset(J,F)}function o(F){return"BODY"===F.nodeName.toUpperCase()}function n(F){return"HTML"===F.nodeName.toUpperCase()}function h(F){return F.nodeType===Node.DOCUMENT_NODE}function f(F){return F!==document.body&&!Element.descendantOf(F,document.body)}"currentStyle"in document.documentElement&&(g=function(F){return F.currentStyle.hasLayout||(F.style.zoom=1),F}),Element.Layout=Class.create(Hash,{initialize:function($super,G,F){$super(),this.element=$(G),Element.Layout.PROPERTIES.each(function(H){this._set(H,null)},this),F&&(this._preComputing=!0,this._begin(),Element.Layout.PROPERTIES.each(this._compute,this),this._end(),this._preComputing=!1)},_set:function(G,F){return Hash.prototype.set.call(this,G,F)},set:function(G,F){throw"Properties of Element.Layout are read-only."},get:function($super,G){var F=$super(G);return null===F?this._compute(G):F},_begin:function(){if(!this._isPrepared()){var J=this.element;if(function(F){for(;F&&F.parentNode;){if("none"===F.getStyle("display"))return!1;F=$(F.parentNode)}return!0}(J))this._setPrepared(!0);else{var L={position:J.style.position||"",width:J.style.width||"",visibility:J.style.visibility||"",display:J.style.display||""};J.store("prototype_original_styles",L);var M=y(J,"position"),F=J.offsetWidth;0!==F&&null!==F||(J.style.display="block",F=J.offsetWidth);var G="fixed"===M?document.viewport:J.parentNode,N={visibility:"hidden",display:"block"};"fixed"!==M&&(N.position="absolute"),J.setStyle(N);var I,H=J.offsetWidth;if(F&&H===F)I=r(J,G);else if("absolute"===M||"fixed"===M)I=r(J,G);else{var O=J.parentNode;I=$(O).getLayout().get("width")-this.get("margin-left")-this.get("border-left")-this.get("padding-left")-this.get("padding-right")-this.get("border-right")-this.get("margin-right")}J.setStyle({width:I+"px"}),this._setPrepared(!0)}}},_end:function(){var G=this.element,F=G.retrieve("prototype_original_styles");G.store("prototype_original_styles",null),G.setStyle(F),this._setPrepared(!1)},_compute:function(G){var F=Element.Layout.COMPUTATIONS;if(!(G in F))throw"Property not found.";return this._set(G,F[G].call(this,this.element))},_isPrepared:function(){return this.element.retrieve("prototype_element_layout_prepared",!1)},_setPrepared:function(F){return this.element.store("prototype_element_layout_prepared",F)},toObject:function(){var F=$A(arguments),G=0===F.length?Element.Layout.PROPERTIES:F.join(" ").split(" "),H={};return G.each(function(I){if(Element.Layout.PROPERTIES.include(I)){var J=this.get(I);null!=J&&(H[I]=J)}},this),H},toHash:function(){var F=this.toObject.apply(this,arguments);return new Hash(F)},toCSS:function(){var F=$A(arguments),H=0===F.length?Element.Layout.PROPERTIES:F.join(" ").split(" "),G={};return H.each(function(I){if(Element.Layout.PROPERTIES.include(I)&&!Element.Layout.COMPOSITE_PROPERTIES.include(I)){var F,J=this.get(I);null!=J&&(G[(F=I,F.include("border")&&(F+="-width"),F.camelize())]=J+"px")}},this),G},inspect:function(){return"#<Element.Layout>"}}),Object.extend(Element.Layout,{PROPERTIES:$w("height width top left right bottom border-left border-right border-top border-bottom padding-left padding-right padding-top padding-bottom margin-top margin-bottom margin-left margin-right padding-box-width padding-box-height border-box-width border-box-height margin-box-width margin-box-height"),COMPOSITE_PROPERTIES:$w("padding-box-width padding-box-height margin-box-width margin-box-height border-box-width border-box-height"),COMPUTATIONS:{height:function(H){this._preComputing||this._begin();var F=this.get("border-box-height");if(F<=0)return this._preComputing||this._end(),0;var I=this.get("border-top"),G=this.get("border-bottom"),K=this.get("padding-top"),J=this.get("padding-bottom");return this._preComputing||this._end(),F-I-G-K-J},width:function(H){this._preComputing||this._begin();var G=this.get("border-box-width");if(G<=0)return this._preComputing||this._end(),0;var K=this.get("border-left"),F=this.get("border-right"),I=this.get("padding-left"),J=this.get("padding-right");return this._preComputing||this._end(),G-K-F-I-J},"padding-box-height":function(G){return this.get("height")+this.get("padding-top")+this.get("padding-bottom")},"padding-box-width":function(F){return this.get("width")+this.get("padding-left")+this.get("padding-right")},"border-box-height":function(G){this._preComputing||this._begin();var F=G.offsetHeight;return this._preComputing||this._end(),F},"border-box-width":function(F){this._preComputing||this._begin();var G=F.offsetWidth;return this._preComputing||this._end(),G},"margin-box-height":function(G){var F=this.get("border-box-height"),H=this.get("margin-top"),I=this.get("margin-bottom");return F<=0?0:F+H+I},"margin-box-width":function(H){var G=this.get("border-box-width"),I=this.get("margin-left"),F=this.get("margin-right");return G<=0?0:G+I+F},top:function(F){return F.positionedOffset().top},bottom:function(F){var I=F.positionedOffset();return F.getOffsetParent().measure("height")-this.get("border-box-height")-I.top},left:function(F){return F.positionedOffset().left},right:function(H){var J=H.positionedOffset();return H.getOffsetParent().measure("width")-this.get("border-box-width")-J.left},"padding-top":function(F){return u(F,"paddingTop")},"padding-bottom":function(F){return u(F,"paddingBottom")},"padding-left":function(F){return u(F,"paddingLeft")},"padding-right":function(F){return u(F,"paddingRight")},"border-top":function(F){return u(F,"borderTopWidth")},"border-bottom":function(F){return u(F,"borderBottomWidth")},"border-left":function(F){return u(F,"borderLeftWidth")},"border-right":function(F){return u(F,"borderRightWidth")},"margin-top":function(F){return u(F,"marginTop")},"margin-bottom":function(F){return u(F,"marginBottom")},"margin-left":function(F){return u(F,"marginLeft")},"margin-right":function(F){return u(F,"marginRight")}}}),"getBoundingClientRect"in document.documentElement&&Object.extend(Element.Layout.COMPUTATIONS,{right:function(G){var H=g(G.getOffsetParent()),I=G.getBoundingClientRect();return(H.getBoundingClientRect().right-I.right).round()},bottom:function(G){var H=g(G.getOffsetParent()),I=G.getBoundingClientRect();return(H.getBoundingClientRect().bottom-I.bottom).round()}}),Element.Offset=Class.create({initialize:function(G,F){this.left=G.round(),this.top=F.round(),this[0]=this.left,this[1]=this.top},relativeTo:function(F){return new Element.Offset(this.left-F.left,this.top-F.top)},inspect:function(){return"#<Element.Offset left: #{left} top: #{top}>".interpolate(this)},toString:function(){return"[#{left}, #{top}]".interpolate(this)},toArray:function(){return[this.left,this.top]}}),Prototype.Browser.IE?(p=p.wrap(function(H,G){if(h(G=$(G))||f(G)||o(G)||n(G))return $(document.body);var F=G.getStyle("position");if("static"!==F)return H(G);G.setStyle({position:"relative"});var I=H(G);return G.setStyle({position:F}),I}),w=w.wrap(function(I,G){if(!(G=$(G)).parentNode)return new Element.Offset(0,0);var F=G.getStyle("position");if("static"!==F)return I(G);var H=G.getOffsetParent();H&&"fixed"===H.getStyle("position")&&g(H),G.setStyle({position:"relative"});var J=I(G);return G.setStyle({position:F}),J})):Prototype.Browser.Webkit&&(C=function(G){G=$(G);var F=0,H=0;do{if(F+=G.offsetTop||0,H+=G.offsetLeft||0,G.offsetParent==document.body&&"absolute"==Element.getStyle(G,"position"))break;G=G.offsetParent}while(G);return new Element.Offset(H,F)}),Element.addMethods({getLayout:function(G,F){return new Element.Layout(G,F)},measure:function(F,G){return $(F).getLayout().get(G)},getWidth:function(F){return Element.getDimensions(F).width},getHeight:function(F){return Element.getDimensions(F).height},getDimensions:function(G){G=$(G);var K=Element.getStyle(G,"display");if(K&&"none"!==K)return{width:G.offsetWidth,height:G.offsetHeight};var H=G.style,F={visibility:H.visibility,position:H.position,display:H.display},J={visibility:"hidden",display:"block"};"fixed"!==F.position&&(J.position="absolute"),Element.setStyle(G,J);var I={width:G.offsetWidth,height:G.offsetHeight};return Element.setStyle(G,F),I},getOffsetParent:p,cumulativeOffset:C,positionedOffset:w,cumulativeScrollOffset:function(G){for(var F=0,H=0;F+=G.scrollTop||0,H+=G.scrollLeft||0,G=G.parentNode;);return new Element.Offset(H,F)},viewportOffset:function(J){var F=0,I=0,H=document.body,G=$(J);do{if(F+=G.offsetTop||0,I+=G.offsetLeft||0,G.offsetParent==H&&"absolute"==Element.getStyle(G,"position"))break}while(G=G.offsetParent);for(G=J;G!=H&&(F-=G.scrollTop||0,I-=G.scrollLeft||0),G=G.parentNode;);return new Element.Offset(I,F)},absolutize:function(F){if(F=$(F),"absolute"===Element.getStyle(F,"position"))return F;var J=p(F),I=F.viewportOffset(),G=J.viewportOffset(),K=I.relativeTo(G),H=F.getLayout();return F.store("prototype_absolutize_original_styles",{left:F.getStyle("left"),top:F.getStyle("top"),width:F.getStyle("width"),height:F.getStyle("height")}),F.setStyle({position:"absolute",top:K.top+"px",left:K.left+"px",width:H.get("width")+"px",height:H.get("height")+"px"}),F},relativize:function(G){if(G=$(G),"relative"===Element.getStyle(G,"position"))return G;var F=G.retrieve("prototype_absolutize_original_styles");return F&&G.setStyle(F),G},scrollTo:function(F){F=$(F);var G=Element.cumulativeOffset(F);return window.scrollTo(G.left,G.top),F},makePositioned:function(G){G=$(G);var F=Element.getStyle(G,"position"),H={};return"static"!==F&&F||(H.position="relative",Prototype.Browser.Opera&&(H.top=0,H.left=0),Element.setStyle(G,H),Element.store(G,"prototype_made_positioned",!0)),G},undoPositioned:function(F){F=$(F);var H=Element.getStorage(F);return H.get("prototype_made_positioned")&&(H.unset("prototype_made_positioned"),Element.setStyle(F,{position:"",top:"",bottom:"",left:"",right:""})),F},makeClipping:function(G){G=$(G);var I=Element.getStorage(G),F=I.get("prototype_made_clipping");if(Object.isUndefined(F)){var H=Element.getStyle(G,"overflow");I.set("prototype_made_clipping",H),"hidden"!==H&&(G.style.overflow="hidden")}return G},undoClipping:function(F){F=$(F);var H=Element.getStorage(F),G=H.get("prototype_made_clipping");return Object.isUndefined(G)||(H.unset("prototype_made_clipping"),F.style.overflow=G||""),F},clonePosition:function(G,K,F){F=Object.extend({setLeft:!0,setTop:!0,setWidth:!0,setHeight:!0,offsetTop:0,offsetLeft:0},F||{}),K=$(K),G=$(G);var L,M,J,I={};if((F.setLeft||F.setTop)&&(L=Element.viewportOffset(K),M=[0,0],"absolute"===Element.getStyle(G,"position"))){var H=Element.getOffsetParent(G);H!==document.body&&(M=Element.viewportOffset(H))}return(F.setWidth||F.setHeight)&&(J=Element.getLayout(K)),F.setLeft&&(I.left=L[0]-M[0]+F.offsetLeft+"px"),F.setTop&&(I.top=L[1]-M[1]+F.offsetTop+"px"),F.setWidth&&(I.width=J.get("border-box-width")+"px"),F.setHeight&&(I.height=J.get("border-box-height")+"px"),Element.setStyle(G,I)}}),"getBoundingClientRect"in document.documentElement&&Element.addMethods({viewportOffset:function(F){if(f(F=$(F)))return new Element.Offset(0,0);var G=F.getBoundingClientRect(),H=document.documentElement;return new Element.Offset(G.left-H.clientLeft,G.top-H.clientTop)}})}(),function(){var c=Prototype.Browser.Opera&&window.parseFloat(window.opera.version())<9.5,f=null;function b(){return f||(f=c?document.body:document.documentElement)}document.viewport={getDimensions:function(){return{width:this.getWidth(),height:this.getHeight()}},getWidth:function(){return b().clientWidth},getHeight:function(){return b().clientHeight},getScrollOffsets:function(){var h=window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft,i=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop;return new Element.Offset(h,i)}}}();var $$=function(){var a=$A(arguments).join(", ");return Prototype.Selector.select(a,document)};Prototype.Selector=function(){var b=Prototype.K;return{select:function(){throw new Error('Method "Prototype.Selector.select" must be defined.')},match:function(){throw new Error('Method "Prototype.Selector.match" must be defined.')},find:function(l,m,h){h=h||0;var j,g=Prototype.Selector.match,k=l.length,f=0;for(j=0;j<k;j++)if(g(l[j],m)&&h==f++)return Element.extend(l[j])},extendElements:Element.extend===b?b:function(h){for(var f=0,g=h.length;f<g;f++)Element.extend(h[f]);return h},extendElement:Element.extend}}(),function(){var l=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,m=0,p=Object.prototype.toString,g=!1,f=!0,n=/\\/g,t=/\W/;[0,0].sort(function(){return f=!1,0});var c=function(y,e,B,C){B=B||[];var E=e=e||document;if(1!==e.nodeType&&9!==e.nodeType)return[];if(!y||"string"!=typeof y)return B;var v,G,J,u,F,I,H,A,x=!0,w=c.isXML(e),z=[],D=y;do{if(l.exec(""),(v=l.exec(D))&&(D=v[3],z.push(v[1]),v[2])){u=v[3];break}}while(v);if(1<z.length&&h.exec(y))if(2===z.length&&i.relative[z[0]])G=q(z[0]+z[1],e);else for(G=i.relative[z[0]]?[e]:c(z.shift(),e);z.length;)y=z.shift(),i.relative[y]&&(y+=z.shift()),G=q(y,G);else if(!C&&1<z.length&&9===e.nodeType&&!w&&i.match.ID.test(z[0])&&!i.match.ID.test(z[z.length-1])&&(e=(F=c.find(z.shift(),e,w)).expr?c.filter(F.expr,F.set)[0]:F.set[0]),e)for(G=(F=C?{expr:z.pop(),set:j(C)}:c.find(z.pop(),1!==z.length||"~"!==z[0]&&"+"!==z[0]||!e.parentNode?e:e.parentNode,w)).expr?c.filter(F.expr,F.set):F.set,0<z.length?J=j(G):x=!1;z.length;)H=I=z.pop(),i.relative[I]?H=z.pop():I="",null==H&&(H=e),i.relative[I](J,H,w);else J=z=[];if(J||(J=G),J||c.error(I||y),"[object Array]"===p.call(J))if(x)if(e&&1===e.nodeType)for(A=0;null!=J[A];A++)J[A]&&(!0===J[A]||1===J[A].nodeType&&c.contains(e,J[A]))&&B.push(G[A]);else for(A=0;null!=J[A];A++)J[A]&&1===J[A].nodeType&&B.push(G[A]);else B.push.apply(B,J);else j(J,B);return u&&(c(u,E,B,C),c.uniqueSort(B)),B};c.uniqueSort=function(u){if(o&&(g=f,u.sort(o),g))for(var e=1;e<u.length;e++)u[e]===u[e-1]&&u.splice(e--,1);return u},c.matches=function(e,u){return c(e,null,null,u)},c.matchesSelector=function(e,u){return 0<c(u,null,null,[e]).length},c.find=function(A,e,B){var z;if(!A)return[];for(var w=0,v=i.order.length;w<v;w++){var x,y=i.order[w];if(x=i.leftMatch[y].exec(A)){var u=x[1];if(x.splice(1,1),"\\"!==u.substr(u.length-1)&&(x[1]=(x[1]||"").replace(n,""),null!=(z=i.find[y](x,e,B)))){A=A.replace(i.match[y],"");break}}}return z||(z=void 0!==e.getElementsByTagName?e.getElementsByTagName("*"):[]),{set:z,expr:A}},c.filter=function(E,D,H,x){for(var z,e,v=E,J=[],B=D,A=D&&D[0]&&c.isXML(D[0]);E&&D.length;){for(var C in i.filter)if(null!=(z=i.leftMatch[C].exec(E))&&z[2]){var I,G,u=i.filter[C],w=z[1];if(e=!1,z.splice(1,1),"\\"===w.substr(w.length-1))continue;if(B===J&&(J=[]),i.preFilter[C])if(z=i.preFilter[C](z,B,H,J,x,A)){if(!0===z)continue}else e=I=!0;if(z)for(var y=0;null!=(G=B[y]);y++)if(G){var F=x^!!(I=u(G,z,y,B));H&&null!=I?F?e=!0:B[y]=!1:F&&(J.push(G),e=!0)}if(void 0!==I){if(H||(B=J),E=E.replace(i.match[C],""),!e)return[];break}}if(E===v){if(null!=e)break;c.error(E)}v=E}return B},c.error=function(e){throw"Syntax error, unrecognized expression: "+e};var i=c.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF\-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF\-]|\\.)+)\s*(?:(\S?=)\s*(?:(['"])(.*?)\3|(#?(?:[\w\u00c0-\uFFFF\-]|\\.)*)|)|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*\-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\(\s*(even|odd|(?:[+\-]?\d+|(?:[+\-]?\d*)?n\s*(?:[+\-]\s*\d+)?))\s*\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^\-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF\-]|\\.)+)(?:\((['"]?)((?:\([^\)]+\)|[^\(\)]*)+)\2\))?/},leftMatch:{},attrMap:{class:"className",for:"htmlFor"},attrHandle:{href:function(e){return e.getAttribute("href")},type:function(e){return e.getAttribute("type")}},relative:{"+":function(z,u){var w="string"==typeof u,y=w&&!t.test(u),A=w&&!y;y&&(u=u.toLowerCase());for(var x,v=0,e=z.length;v<e;v++)if(x=z[v]){for(;(x=x.previousSibling)&&1!==x.nodeType;);z[v]=A||x&&x.nodeName.toLowerCase()===u?x||!1:x===u}A&&c.filter(u,z,!0)},">":function(z,u){var y,x="string"==typeof u,v=0,e=z.length;if(x&&!t.test(u)){for(u=u.toLowerCase();v<e;v++)if(y=z[v]){var w=y.parentNode;z[v]=w.nodeName.toLowerCase()===u&&w}}else{for(;v<e;v++)(y=z[v])&&(z[v]=x?y.parentNode:y.parentNode===u);x&&c.filter(u,z,!0)}},"":function(w,u,y){var x,v=m++,e=r;"string"!=typeof u||t.test(u)||(x=u=u.toLowerCase(),e=a),e("parentNode",u,v,w,x,y)},"~":function(w,u,y){var x,v=m++,e=r;"string"!=typeof u||t.test(u)||(x=u=u.toLowerCase(),e=a),e("previousSibling",u,v,w,x,y)}},find:{ID:function(u,v,w){if(void 0!==v.getElementById&&!w){var e=v.getElementById(u[1]);return e&&e.parentNode?[e]:[]}},NAME:function(v,y){if(void 0!==y.getElementsByName){for(var u=[],x=y.getElementsByName(v[1]),w=0,e=x.length;w<e;w++)x[w].getAttribute("name")===v[1]&&u.push(x[w]);return 0===u.length?null:u}},TAG:function(e,u){if(void 0!==u.getElementsByTagName)return u.getElementsByTagName(e[1])}},preFilter:{CLASS:function(w,u,v,e,z,A){if(w=" "+w[1].replace(n,"")+" ",A)return w;for(var y,x=0;null!=(y=u[x]);x++)y&&(z^(y.className&&0<=(" "+y.className+" ").replace(/[\t\n\r]/g," ").indexOf(w))?v||e.push(y):v&&(u[x]=!1));return!1},ID:function(e){return e[1].replace(n,"")},TAG:function(u,e){return u[1].replace(n,"").toLowerCase()},CHILD:function(e){if("nth"===e[1]){e[2]||c.error(e[0]),e[2]=e[2].replace(/^\+|\s*/g,"");var u=/(-?)(\d*)(?:n([+\-]?\d*))?/.exec(("even"===e[2]?"2n":"odd"===e[2]&&"2n+1")||!/\D/.test(e[2])&&"0n+"+e[2]||e[2]);e[2]=u[1]+(u[2]||1)-0,e[3]=u[3]-0}else e[2]&&c.error(e[0]);return e[0]=m++,e},ATTR:function(x,u,v,e,y,z){var w=x[1]=x[1].replace(n,"");return!z&&i.attrMap[w]&&(x[1]=i.attrMap[w]),x[4]=(x[4]||x[5]||"").replace(n,""),"~="===x[2]&&(x[4]=" "+x[4]+" "),x},PSEUDO:function(x,u,v,e,y){if("not"===x[1]){if(!(1<(l.exec(x[3])||"").length||/^\w/.test(x[3]))){var w=c.filter(x[3],u,v,!0^y);return v||e.push.apply(e,w),!1}x[3]=c(x[3],null,null,u)}else if(i.match.POS.test(x[0])||i.match.CHILD.test(x[0]))return!0;return x},POS:function(e){return e.unshift(!0),e}},filters:{enabled:function(e){return!1===e.disabled&&"hidden"!==e.type},disabled:function(e){return!0===e.disabled},checked:function(e){return!0===e.checked},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},parent:function(e){return!!e.firstChild},empty:function(e){return!e.firstChild},has:function(v,u,e){return!!c(e[3],v).length},header:function(e){return/h\d/i.test(e.nodeName)},text:function(v){var e=v.getAttribute("type"),u=v.type;return"input"===v.nodeName.toLowerCase()&&"text"===u&&(e===u||null===e)},radio:function(e){return"input"===e.nodeName.toLowerCase()&&"radio"===e.type},checkbox:function(e){return"input"===e.nodeName.toLowerCase()&&"checkbox"===e.type},file:function(e){return"input"===e.nodeName.toLowerCase()&&"file"===e.type},password:function(e){return"input"===e.nodeName.toLowerCase()&&"password"===e.type},submit:function(u){var e=u.nodeName.toLowerCase();return("input"===e||"button"===e)&&"submit"===u.type},image:function(e){return"input"===e.nodeName.toLowerCase()&&"image"===e.type},reset:function(u){var e=u.nodeName.toLowerCase();return("input"===e||"button"===e)&&"reset"===u.type},button:function(u){var e=u.nodeName.toLowerCase();return"input"===e&&"button"===u.type||"button"===e},input:function(e){return/input|select|textarea|button/i.test(e.nodeName)},focus:function(e){return e===e.ownerDocument.activeElement}},setFilters:{first:function(u,e){return 0===e},last:function(v,u,e,w){return u===w.length-1},even:function(u,e){return e%2==0},odd:function(u,e){return e%2==1},lt:function(v,u,e){return u<e[3]-0},gt:function(v,u,e){return u>e[3]-0},nth:function(v,u,e){return e[3]-0===u},eq:function(v,u,e){return e[3]-0===u}},filter:{PSEUDO:function(v,A,z,B){var e=A[1],u=i.filters[e];if(u)return u(v,z,A,B);if("contains"===e)return 0<=(v.textContent||v.innerText||c.getText([v])||"").indexOf(A[3]);if("not"===e){for(var w=A[3],y=0,x=w.length;y<x;y++)if(w[y]===v)return!1;return!0}c.error(e)},CHILD:function(e,w){var z=w[1],u=e;switch(z){case"only":case"first":for(;u=u.previousSibling;)if(1===u.nodeType)return!1;if("first"===z)return!0;u=e;case"last":for(;u=u.nextSibling;)if(1===u.nodeType)return!1;return!0;case"nth":var v=w[2],C=w[3];if(1===v&&0===C)return!0;var y=w[0],B=e.parentNode;if(B&&(B.sizcache!==y||!e.nodeIndex)){var x=0;for(u=B.firstChild;u;u=u.nextSibling)1===u.nodeType&&(u.nodeIndex=++x);B.sizcache=y}var A=e.nodeIndex-C;return 0===v?0===A:A%v==0&&0<=A/v}},ID:function(u,e){return 1===u.nodeType&&u.getAttribute("id")===e},TAG:function(u,e){return"*"===e&&1===u.nodeType||u.nodeName.toLowerCase()===e},CLASS:function(u,e){return-1<(" "+(u.className||u.getAttribute("class"))+" ").indexOf(e)},ATTR:function(y,w){var v=w[1],e=i.attrHandle[v]?i.attrHandle[v](y):null!=y[v]?y[v]:y.getAttribute(v),z=e+"",x=w[2],u=w[4];return null==e?"!="===x:"="===x?z===u:"*="===x?0<=z.indexOf(u):"~="===x?0<=(" "+z+" ").indexOf(u):u?"!="===x?z!==u:"^="===x?0===z.indexOf(u):"$="===x?z.substr(z.length-u.length)===u:"|="===x&&(z===u||z.substr(0,u.length+1)===u+"-"):z&&!1!==e},POS:function(x,u,v,y){var e=u[2],w=i.setFilters[e];if(w)return w(x,v,u,y)}}},h=i.match.POS,b=function(u,e){return"\\"+(e-0+1)};for(var d in i.match)i.match[d]=new RegExp(i.match[d].source+/(?![^\[]*\])(?![^\(]*\))/.source),i.leftMatch[d]=new RegExp(/(^(?:.|\r|\n)*?)/.source+i.match[d].source.replace(/\\(\d+)/g,b));var o,k,u,v,e,j=function(u,e){return u=Array.prototype.slice.call(u,0),e?(e.push.apply(e,u),e):u};try{Array.prototype.slice.call(document.documentElement.childNodes,0)[0].nodeType}catch(s){j=function(x,w){var v=0,u=w||[];if("[object Array]"===p.call(x))Array.prototype.push.apply(u,x);else if("number"==typeof x.length)for(var e=x.length;v<e;v++)u.push(x[v]);else for(;x[v];v++)u.push(x[v]);return u}}function a(u,z,y,C,A,B){for(var w=0,v=C.length;w<v;w++){var e=C[w];if(e){var x=!1;for(e=e[u];e;){if(e.sizcache===y){x=C[e.sizset];break}if(1!==e.nodeType||B||(e.sizcache=y,e.sizset=w),e.nodeName.toLowerCase()===z){x=e;break}e=e[u]}C[w]=x}}}function r(u,z,y,C,A,B){for(var w=0,v=C.length;w<v;w++){var e=C[w];if(e){var x=!1;for(e=e[u];e;){if(e.sizcache===y){x=C[e.sizset];break}if(1===e.nodeType)if(B||(e.sizcache=y,e.sizset=w),"string"!=typeof z){if(e===z){x=!0;break}}else if(0<c.filter(z,[e]).length){x=e;break}e=e[u]}C[w]=x}}}document.documentElement.compareDocumentPosition?o=function(u,e){return u===e?(g=!0,0):u.compareDocumentPosition&&e.compareDocumentPosition?4&u.compareDocumentPosition(e)?-1:1:u.compareDocumentPosition?-1:1}:(o=function(B,A){if(B===A)return g=!0,0;if(B.sourceIndex&&A.sourceIndex)return B.sourceIndex-A.sourceIndex;var y,u,v=[],e=[],x=B.parentNode,z=A.parentNode,C=x;if(x===z)return k(B,A);if(!x)return-1;if(!z)return 1;for(;C;)v.unshift(C),C=C.parentNode;for(C=z;C;)e.unshift(C),C=C.parentNode;y=v.length,u=e.length;for(var w=0;w<y&&w<u;w++)if(v[w]!==e[w])return k(v[w],e[w]);return w===y?k(B,e[w],-1):k(v[w],A,1)},k=function(u,e,v){if(u===e)return v;for(var w=u.nextSibling;w;){if(w===e)return-1;w=w.nextSibling}return 1}),c.getText=function(e){for(var w,u="",v=0;e[v];v++)3===(w=e[v]).nodeType||4===w.nodeType?u+=w.nodeValue:8!==w.nodeType&&(u+=c.getText(w.childNodes));return u},u=document.createElement("div"),v="script"+(new Date).getTime(),e=document.documentElement,u.innerHTML="<a name='"+v+"'/>",e.insertBefore(u,e.firstChild),document.getElementById(v)&&(i.find.ID=function(x,y,z){if(void 0!==y.getElementById&&!z){var w=y.getElementById(x[1]);return w?w.id===x[1]||void 0!==w.getAttributeNode&&w.getAttributeNode("id").nodeValue===x[1]?[w]:void 0:[]}},i.filter.ID=function(y,w){var x=void 0!==y.getAttributeNode&&y.getAttributeNode("id");return 1===y.nodeType&&x&&x.nodeValue===w}),e.removeChild(u),e=u=null,function(){var e=document.createElement("div");e.appendChild(document.createComment("")),0<e.getElementsByTagName("*").length&&(i.find.TAG=function(u,y){var x=y.getElementsByTagName(u[1]);if("*"===u[1]){for(var w=[],v=0;x[v];v++)1===x[v].nodeType&&w.push(x[v]);x=w}return x}),e.innerHTML="<a href='#'></a>",e.firstChild&&void 0!==e.firstChild.getAttribute&&"#"!==e.firstChild.getAttribute("href")&&(i.attrHandle.href=function(u){return u.getAttribute("href",2)}),e=null}(),document.querySelectorAll&&function(){var e=c,w=document.createElement("div");if(w.innerHTML="<p class='TEST'></p>",!w.querySelectorAll||0!==w.querySelectorAll(".TEST").length){for(var u in c=function(H,y,C,G){if(y=y||document,!G&&!c.isXML(y)){var F=/^(\w+$)|^\.([\w\-]+$)|^#([\w\-]+$)/.exec(H);if(F&&(1===y.nodeType||9===y.nodeType)){if(F[1])return j(y.getElementsByTagName(H),C);if(F[2]&&i.find.CLASS&&y.getElementsByClassName)return j(y.getElementsByClassName(F[2]),C)}if(9===y.nodeType){if("body"===H&&y.body)return j([y.body],C);if(F&&F[3]){var B=y.getElementById(F[3]);if(!B||!B.parentNode)return j([],C);if(B.id===F[3])return j([B],C)}try{return j(y.querySelectorAll(H),C)}catch(D){}}else if(1===y.nodeType&&"object"!==y.nodeName.toLowerCase()){var z=y,A=y.getAttribute("id"),x=A||"__sizzle__",J=y.parentNode,I=/^\s*[+~]/.test(H);A?x=x.replace(/'/g,"\\$&"):y.setAttribute("id",x),I&&J&&(y=y.parentNode);try{if(!I||J)return j(y.querySelectorAll("[id='"+x+"'] "+H),C)}catch(E){}finally{A||z.removeAttribute("id")}}}return e(H,y,C,G)},e)c[u]=e[u];w=null}}(),function(){var e=document.documentElement,v=e.matchesSelector||e.mozMatchesSelector||e.webkitMatchesSelector||e.msMatchesSelector;if(v){var x=!v.call(document.createElement("div"),"div"),u=!1;try{v.call(document.documentElement,"[test!='']:sizzle")}catch(w){u=!0}c.matchesSelector=function(z,B){if(B=B.replace(/\=\s*([^'"\]]*)\s*\]/g,"='$1']"),!c.isXML(z))try{if(u||!i.match.PSEUDO.test(B)&&!/!=/.test(B)){var y=v.call(z,B);if(y||!x||z.document&&11!==z.document.nodeType)return y}}catch(A){}return 0<c(B,null,null,[z]).length}}}(),function(){var e=document.createElement("div");e.innerHTML="<div class='test e'></div><div class='test'></div>",e.getElementsByClassName&&0!==e.getElementsByClassName("e").length&&(e.lastChild.className="e",1!==e.getElementsByClassName("e").length&&(i.order.splice(1,0,"CLASS"),i.find.CLASS=function(u,v,w){if(void 0!==v.getElementsByClassName&&!w)return v.getElementsByClassName(u[1])},e=null))}(),document.documentElement.contains?c.contains=function(u,e){return u!==e&&(!u.contains||u.contains(e))}:document.documentElement.compareDocumentPosition?c.contains=function(u,e){return!!(16&u.compareDocumentPosition(e))}:c.contains=function(){return!1},c.isXML=function(e){var u=(e?e.ownerDocument||e:0).documentElement;return!!u&&"HTML"!==u.nodeName};var q=function(e,A){for(var y,w=[],x="",v=A.nodeType?[A]:A;y=i.match.PSEUDO.exec(e);)x+=y[0],e=e.replace(i.match.PSEUDO,"");e=i.relative[e]?e+"*":e;for(var z=0,u=v.length;z<u;z++)c(e,v[z],w);return c.filter(x,w)};window.Sizzle=c}(),Prototype._original_property=window.Sizzle,function(c){var d=Prototype.Selector.extendElements;Prototype.Selector.engine=c,Prototype.Selector.select=function(e,f){return d(c(e,f||document))},Prototype.Selector.match=function(f,e){return 1==c.matches(e,[f]).length}}(window.Sizzle),window.Sizzle=Prototype._original_property,delete Prototype._original_property;var Form={reset:function(a){return(a=$(a)).reset(),a},serializeElements:function(h,d){"object"!=typeof d?d={hash:!!d}:Object.isUndefined(d.hash)&&(d.hash=!0);var e,g,b,c,a=!1,f=d.submit;return b=d.hash?(c={},function(i,j,k){return j in i?(Object.isArray(i[j])||(i[j]=[i[j]]),i[j].push(k)):i[j]=k,i}):(c="",function(i,j,k){return k=k.gsub(/(\r)?\n/,"\r\n"),k=(k=encodeURIComponent(k)).gsub(/%20/,"+"),i+(i?"&":"")+encodeURIComponent(j)+"="+k}),h.inject(c,function(i,j){return!j.disabled&&j.name&&(e=j.name,null==(g=$(j).getValue())||"file"==j.type||"submit"==j.type&&(a||!1===f||f&&e!=f||!(a=!0))||(i=b(i,e,g))),i})}};Form.Methods={serialize:function(b,a){return Form.serializeElements(Form.getElements(b),a)},getElements:function(e){for(var d,f=$(e).getElementsByTagName("*"),c=[],b=Form.Element.Serializers,a=0;d=f[a];a++)b[d.tagName.toLowerCase()]&&c.push(Element.extend(d));return c},getInputs:function(g,c,d){var a=(g=$(g)).getElementsByTagName("input");if(!c&&!d)return $A(a).map(Element.extend);for(var e=0,h=[],f=a.length;e<f;e++){var b=a[e];c&&b.type!=c||d&&b.name!=d||h.push(Element.extend(b))}return h},disable:function(a){return a=$(a),Form.getElements(a).invoke("disable"),a},enable:function(a){return a=$(a),Form.getElements(a).invoke("enable"),a},findFirstElement:function(b){var c=$(b).getElements().findAll(function(d){return"hidden"!=d.type&&!d.disabled}),a=c.findAll(function(d){return d.hasAttribute("tabIndex")&&0<=d.tabIndex}).sortBy(function(d){return d.tabIndex}).first();return a||c.find(function(d){return/^(?:input|select|textarea)$/i.test(d.tagName)})},focusFirstElement:function(b){var a=(b=$(b)).findFirstElement();return a&&a.activate(),b},request:function(b,a){b=$(b);var d=(a=Object.clone(a||{})).parameters,c=b.readAttribute("action")||"";return c.blank()&&(c=window.location.href),a.parameters=b.serialize(!0),d&&(Object.isString(d)&&(d=d.toQueryParams()),Object.extend(a.parameters,d)),b.hasAttribute("method")&&!a.method&&(a.method=b.method),new Ajax.Request(c,a)}},Form.Element={focus:function(a){return $(a).focus(),a},select:function(a){return $(a).select(),a}},Form.Element.Methods={serialize:function(a){if(!(a=$(a)).disabled&&a.name){var b=a.getValue();if(null!=b){var c={};return c[a.name]=b,Object.toQueryString(c)}}return""},getValue:function(a){var b=(a=$(a)).tagName.toLowerCase();return Form.Element.Serializers[b](a)},setValue:function(a,b){var c=(a=$(a)).tagName.toLowerCase();return Form.Element.Serializers[c](a,b),a},clear:function(a){return $(a).value="",a},present:function(a){return""!=$(a).value},activate:function(a){a=$(a);try{a.focus(),!a.select||"input"==a.tagName.toLowerCase()&&/^(?:button|reset|submit)$/i.test(a.type)||a.select()}catch(b){}return a},disable:function(a){return(a=$(a)).disabled=!0,a},enable:function(a){return(a=$(a)).disabled=!1,a}};var Field=Form.Element,$F=Form.Element.Methods.getValue;Form.Element.Serializers=function(){function f(h,i){if(Object.isUndefined(i))return h.checked?h.value:null;h.checked=!!i}function e(h,i){if(Object.isUndefined(i))return h.value;h.value=i}function c(i){var h=i.selectedIndex;return 0<=h?g(i.options[h]):null}function d(l){var m=l.length;if(!m)return null;for(var k=0,h=[];k<m;k++){var j=l.options[k];j.selected&&h.push(g(j))}return h}function g(h){return Element.hasAttribute(h,"value")?h.value:h.text}return{input:function(h,i){switch(h.type.toLowerCase()){case"checkbox":case"radio":return f(h,i);default:return e(h,i)}},inputSelector:f,textarea:e,select:function(k,n){if(Object.isUndefined(n))return("select-one"===k.type?c:d)(k);for(var j,l,o=!Object.isArray(n),h=0,m=k.length;h<m;h++)if(j=k.options[h],l=this.optionValue(j),o){if(l==n)return void(j.selected=!0)}else j.selected=n.include(l)},selectOne:c,selectMany:d,optionValue:g,button:e}}(),Abstract.TimedObserver=Class.create(PeriodicalExecuter,{initialize:function($super,a,b,c){$super(c,b),this.element=$(a),this.lastValue=this.getValue()},execute:function(){var a=this.getValue();(Object.isString(this.lastValue)&&Object.isString(a)?this.lastValue!=a:String(this.lastValue)!=String(a))&&(this.callback(this.element,a),this.lastValue=a)}}),Form.Element.Observer=Class.create(Abstract.TimedObserver,{getValue:function(){return Form.Element.getValue(this.element)}}),Form.Observer=Class.create(Abstract.TimedObserver,{getValue:function(){return Form.serialize(this.element)}}),Abstract.EventObserver=Class.create({initialize:function(a,b){this.element=$(a),this.callback=b,this.lastValue=this.getValue(),"form"==this.element.tagName.toLowerCase()?this.registerFormCallbacks():this.registerCallback(this.element)},onElementEvent:function(){var a=this.getValue();this.lastValue!=a&&(this.callback(this.element,a),this.lastValue=a)},registerFormCallbacks:function(){Form.getElements(this.element).each(this.registerCallback,this)},registerCallback:function(a){if(a.type)switch(a.type.toLowerCase()){case"checkbox":case"radio":Event.observe(a,"click",this.onElementEvent.bind(this));break;default:Event.observe(a,"change",this.onElementEvent.bind(this))}}}),Form.Element.EventObserver=Class.create(Abstract.EventObserver,{getValue:function(){return Form.Element.getValue(this.element)}}),Form.EventObserver=Class.create(Abstract.EventObserver,{getValue:function(){return Form.serialize(this.element)}}),function(D){var O,u=document.createElement("div"),d=document.documentElement,k="onmouseenter"in d&&"onmouseleave"in d,L={KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ESC:27,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_DELETE:46,KEY_HOME:36,KEY_END:35,KEY_PAGEUP:33,KEY_PAGEDOWN:34,KEY_INSERT:45},z=function(X){return!1};function M(Y,X){return Y.which?Y.which===X+1:Y.button===X}window.attachEvent&&(z=window.addEventListener?function(X){return!(X instanceof window.Event)}:function(X){return!0});var W={0:1,1:4,2:2};function S(Y,X){return Y.button===W[X]}function K(Z){var Y=(Z=L.extend(Z)).target,X=Z.type,aa=Z.currentTarget;return aa&&aa.tagName&&("load"===X||"error"===X||"click"===X&&"input"===aa.tagName.toLowerCase()&&"radio"===aa.type)&&(Y=aa),Y.nodeType==Node.TEXT_NODE&&(Y=Y.parentNode),Element.extend(Y)}function U(Z){var Y=document.documentElement,X=document.body||{scrollLeft:0};return Z.pageX||Z.clientX+(Y.scrollLeft||X.scrollLeft)-(Y.clientLeft||0)}function T(Z){var Y=document.documentElement,X=document.body||{scrollTop:0};return Z.pageY||Z.clientY+(Y.scrollTop||X.scrollTop)-(Y.clientTop||0)}O=window.attachEvent?window.addEventListener?function(Y,X){return z(Y)?S(Y,X):M(Y,X)}:S:Prototype.Browser.WebKit?function(Y,X){switch(X){case 0:return 1==Y.which&&!Y.metaKey;case 1:return 2==Y.which||1==Y.which&&Y.metaKey;case 2:return 3==Y.which;default:return!1}}:M,L.Methods={isLeftClick:function(X){return O(X,0)},isMiddleClick:function(X){return O(X,1)},isRightClick:function(X){return O(X,2)},element:function(X){return Element.extend(K(X))},findElement:function(Z,aa){var Y=K(Z),X=Prototype.Selector.match;if(!aa)return Element.extend(Y);for(;Y;){if(Object.isElement(Y)&&X(Y,aa))return Element.extend(Y);Y=Y.parentNode}},pointer:function(X){return{x:U(X),y:T(X)}},pointerX:U,pointerY:T,stop:function(X){L.extend(X),X.preventDefault(),X.stopPropagation(),X.stopped=!0}};var H=Object.keys(L.Methods).inject({},function(X,Y){return X[Y]=L.Methods[Y].methodize(),X});if(window.attachEvent){var Q={stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.returnValue=!1},inspect:function(){return"[object Event]"}};L.extend=function(Y,X){if(!Y)return!1;if(!z(Y))return Y;if(Y._extendedByPrototype)return Y;Y._extendedByPrototype=Prototype.emptyFunction;var Z=L.pointer(Y);return Object.extend(Y,{target:Y.srcElement||X,relatedTarget:function(Y){var X;switch(Y.type){case"mouseover":case"mouseenter":X=Y.fromElement;break;case"mouseout":case"mouseleave":X=Y.toElement;break;default:return null}return Element.extend(X)}(Y),pageX:Z.x,pageY:Z.y}),Object.extend(Y,H),Object.extend(Y,Q),Y}}else L.extend=Prototype.K;window.addEventListener&&(L.prototype=window.Event.prototype||document.createEvent("HTMLEvents").__proto__,Object.extend(L.prototype,H));var v={mouseenter:"mouseover",mouseleave:"mouseout"};function f(X){return v[X]||X}function R(X){return X===window?0:(void 0===X._prototypeUID&&(X._prototypeUID=Element.Storage.UID++),X._prototypeUID)}function x(X){return X.include(":")}function A(Z,Y){var X=D.Event.cache;return Object.isUndefined(Y)&&(Y=R(Z)),X[Y]||(X[Y]={element:Z}),X[Y]}function c(Z,Y,aa){var ab=function(Z,ac,af){var X=A(Z);X[ac]||(X[ac]=[]);for(var ab=X[ac],aa=ab.length;aa--;)if(ab[aa].handler===af)return null;var ad=R(Z),ae={responder:D.Event._createResponder(ad,ac,af),handler:af};return ab.push(ae),ae}(Z=$(Z),Y,aa);if(null===ab)return Z;var X=ab.responder;return x(Y)?function(Z,Y,X){Z.addEventListener?Z.addEventListener("dataavailable",X,!1):(Z.attachEvent("ondataavailable",X),Z.attachEvent("onlosecapture",X))}(Z,0,X):function(aa,Z,Y){var X=f(Z);aa.addEventListener?aa.addEventListener(X,Y,!1):aa.attachEvent("on"+X,Y)}(Z,Y,X),Z}function J(Y,X,Z){Y=$(Y);var ab=!Object.isUndefined(Z);if(!!Object.isUndefined(X)&&!ab)return function(ac){var X,aa,ab=R(ac),Z=A(ac,ab);for(var Y in function(Y,X){Object.isUndefined(X)&&(X=R(Y)),delete D.Event.cache[X]}(ac,ab),Z)if("element"!==Y)for(X=Z[Y],aa=X.length;aa--;)a(ac,Y,X[aa].responder)}(Y),Y;if(!ab)return function(ab,Z){var Y=A(ab),X=Y[Z];if(!X)return;delete Y[Z];var aa=X.length;for(;aa--;)a(ab,Z,X[aa].responder)}(Y,X),Y;var aa=function(ac,Z,ad){var X=A(ac)[Z];if(X){for(var ae,ab=X.length;ab--;)if(X[ab].handler===ad){ae=X[ab];break}if(ae){var aa=X.indexOf(ae);return X.splice(aa,1),ae}}}(Y,X,Z);return aa&&a(Y,X,aa.responder),Y}function a(Y,X,Z){x(X)?function(Z,Y,X){Z.removeEventListener?Z.removeEventListener("dataavailable",X,!1):(Z.detachEvent("ondataavailable",X),Z.detachEvent("onlosecapture",X))}(Y,0,Z):function(aa,Z,Y){var X=f(Z);aa.removeEventListener?aa.removeEventListener(X,Y,!1):aa.detachEvent("on"+X,Y)}(Y,X,Z)}function w(aa,Z,Y,X){aa=function(X){return X!==document?X:document.createEvent&&!X.dispatchEvent?document.documentElement:X}($(aa)),Object.isUndefined(X)&&(X=!0);var ab=N(aa,Z,Y=Y||{},X);return L.extend(ab)}k&&(f=Prototype.K),"uniqueID"in u&&(R=function(X){return X===window?0:X==document?1:X.uniqueID}),L._isCustomEvent=x;var N=document.createEvent?function(aa,Z,Y,X){var ab=document.createEvent("HTMLEvents");return ab.initEvent("dataavailable",X,!0),ab.eventName=Z,ab.memo=Y,aa.dispatchEvent(ab),ab}:function(aa,Z,Y,X){var ab=document.createEventObject();return ab.eventType=X?"ondataavailable":"onlosecapture",ab.eventName=Z,ab.memo=Y,aa.fireEvent(ab.eventType,ab),ab};function F(Z,Y,X,aa){return Z=$(Z),Object.isFunction(X)&&Object.isUndefined(aa)&&(aa=X,X=null),new L.Handler(Z,Y,X,aa).start()}L.Handler=Class.create({initialize:function(Z,Y,X,aa){this.element=$(Z),this.eventName=Y,this.selector=X,this.callback=aa,this.handler=this.handleEvent.bind(this)},start:function(){return L.observe(this.element,this.eventName,this.handler),this},stop:function(){return L.stopObserving(this.element,this.eventName,this.handler),this},handleEvent:function(Y){var X=L.findElement(Y,this.selector);X&&this.callback.call(this.element,Y,X)}}),Object.extend(L,L.Methods),Object.extend(L,{fire:w,observe:c,stopObserving:J,on:F}),Element.addMethods({fire:w,observe:c,stopObserving:J,on:F}),Object.extend(document,{fire:w.methodize(),observe:c.methodize(),stopObserving:J.methodize(),on:F.methodize(),loaded:!1}),D.Event?Object.extend(window.Event,L):D.Event=L,D.Event.cache={},window.attachEvent&&window.attachEvent("onunload",function(){D.Event.cache=null}),d=u=null}(this),function(c){var g=document.documentElement,b="onmouseenter"in g&&"onmouseleave"in g;c.Event._createResponder=function(i,h,j){return Event._isCustomEvent(h)?function(i,h,j){return function(l){var m=Event.cache[i],k=m.element;return!Object.isUndefined(l.eventName)&&l.eventName===h&&(Event.extend(l,k),void j.call(k,l))}}(i,h,j):function(h){return!b&&("mouseenter"===h||"mouseleave"===h)}(h)?function(i,h,j){return function(m){var o=Event.cache[i],k=o.element;Event.extend(m,k);for(var l=m.relatedTarget;l&&l!==k;)try{l=l.parentNode}catch(n){l=k}l!==k&&j.call(k,m)}}(i,0,j):function(l){var k=Event.cache[i].element;Event.extend(l,k),j.call(k,l)}},g=null}(this),function(a){var e;function b(){document.loaded||(e&&window.clearTimeout(e),document.loaded=!0,document.fire("dom:loaded"))}document.addEventListener?document.addEventListener("DOMContentLoaded",b,!1):(document.attachEvent("onreadystatechange",function d(){"complete"===document.readyState&&(document.detachEvent("onreadystatechange",d),b())}),window==top&&(e=function c(){try{document.documentElement.doScroll("left")}catch(f){return void(e=c.defer())}b()}.defer())),Event.observe(window,"load",b)}(),Element.addMethods(),Hash.toQueryString=Object.toQueryString;var Toggle={display:Element.toggle};Element.Methods.childOf=Element.Methods.descendantOf;var Insertion={Before:function(a,b){return Element.insert(a,{before:b})},Top:function(a,b){return Element.insert(a,{top:b})},Bottom:function(a,b){return Element.insert(a,{bottom:b})},After:function(a,b){return Element.insert(a,{after:b})}},$continue=new Error('"throw $continue" is deprecated, use "return" instead'),Position={includeScrollOffsets:!1,prepare:function(){this.deltaX=window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft||0,this.deltaY=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0},within:function(b,a,c){return this.includeScrollOffsets?this.withinIncludingScrolloffsets(b,a,c):(this.xcomp=a,this.ycomp=c,this.offset=Element.cumulativeOffset(b),c>=this.offset[1]&&c<this.offset[1]+b.offsetHeight&&a>=this.offset[0]&&a<this.offset[0]+b.offsetWidth)},withinIncludingScrolloffsets:function(b,a,d){var c=Element.cumulativeScrollOffset(b);return this.xcomp=a+c[0]-this.deltaX,this.ycomp=d+c[1]-this.deltaY,this.offset=Element.cumulativeOffset(b),this.ycomp>=this.offset[1]&&this.ycomp<this.offset[1]+b.offsetHeight&&this.xcomp>=this.offset[0]&&this.xcomp<this.offset[0]+b.offsetWidth},overlap:function(b,a){return b?"vertical"==b?(this.offset[1]+a.offsetHeight-this.ycomp)/a.offsetHeight:"horizontal"==b?(this.offset[0]+a.offsetWidth-this.xcomp)/a.offsetWidth:void 0:0},cumulativeOffset:Element.Methods.cumulativeOffset,positionedOffset:Element.Methods.positionedOffset,absolutize:function(a){return Position.prepare(),Element.absolutize(a)},relativize:function(a){return Position.prepare(),Element.relativize(a)},realOffset:Element.Methods.cumulativeScrollOffset,offsetParent:Element.Methods.getOffsetParent,page:Element.Methods.viewportOffset,clone:function(b,c,a){return a=a||{},Element.clonePosition(c,b,a)}};document.getElementsByClassName||(document.getElementsByClassName=function(b){function a(c){return c.blank()?null:"[contains(concat(' ', @class, ' '), ' "+c+" ')]"}return Element.Methods.getElementsByClassName=Prototype.BrowserFeatures.XPath?function(c,e){e=e.toString().strip();var d=/\s/.test(e)?$w(e).map(a).join(""):a(e);return d?document._getElementsByXPath(".//*"+d,c):[]}:function(e,f){f=f.toString().strip();var g=[],h=/\s/.test(f)?$w(f):null;if(!h&&!f)return g;var c=$(e).getElementsByTagName("*");f=" "+f+" ";for(var k,j,d=0;k=c[d];d++)k.className&&(j=" "+k.className+" ")&&(j.include(f)||h&&h.all(function(i){return!i.toString().blank()&&j.include(" "+i+" ")}))&&g.push(Element.extend(k));return g},function(d,c){return $(c||document.body).getElementsByClassName(d)}}()),Element.ClassNames=Class.create(),Element.ClassNames.prototype={initialize:function(a){this.element=$(a)},_each:function(b,a){this.element.className.split(/\s+/).select(function(c){return 0<c.length})._each(b,a)},set:function(a){this.element.className=a},add:function(a){this.include(a)||this.set($A(this).concat(a).join(" "))},remove:function(a){this.include(a)&&this.set($A(this).without(a).join(" "))},toString:function(){return $A(this).join(" ")}},Object.extend(Element.ClassNames.prototype,Enumerable);var Selector=function(){var a=Class.create({initialize:function(b){this.expression=b.strip()},findElements:function(b){return Prototype.Selector.select(this.expression,b)},match:function(b){return Prototype.Selector.match(b,this.expression)},toString:function(){return this.expression},inspect:function(){return"#<Selector: "+this.expression+">"}});return Object.extend(a,{matchElements:function(g,h){for(var b=Prototype.Selector.match,e=[],d=0,f=g.length;d<f;d++){var c=g[d];b(c,h)&&e.push(Element.extend(c))}return e},findElement:function(g,h,c){c=c||0;for(var e,b=0,d=0,f=g.length;d<f;d++)if(e=g[d],Prototype.Selector.match(e,h)&&c===b++)return Element.extend(e)},findChildElements:function(c,d){var b=d.toArray().join(", ");return Prototype.Selector.select(b,c||document)}}),a}();$services={localization:{messages:{"phenotips.imageDisplayer.delete":"Delete","phenotips.imageDisplayer.openImage":"Open {0}","phenotips.imageDisplayer.acceptedFormats":"Accepted file formats:","phenotips.imageDisplayer.uploadAndSelect":"Upload and select","phenotips.imageDisplayer.uploadAndManage":"Upload and manage","phenotips.imageDisplayer.AJAXnotSuportedMessage":"This feature works better in more advanced browsers (Mozilla Firefox 4.0+, Google Chrome). Please consider upgrading.","phenotips.imageDisplayer.noneAvailable":"None available","phenotips.imageDisplayer.error.invalidFile":"The selected file has an unsupported format.","phenotips.imageDisplayer.error.general":"An error occurred while uploading the file.","phenotips.imageDisplayer.error.abort":"The upload has been canceled by the user or the browser dropped the connection","phenotips.imageDisplayer.error.size":"The selected file is too large. Please choose files under __maxSize__","phenotips.imageDisplayer.done":"Done","phenotips.imageDisplayer.noFiles":"No files available","phenotips.tableMacros.delete":"Delete","phenotips.tableMacros.newEntry":"New entry","phenotips.tableMacros.newVariantEntry":"Add variant","phenotips.tableMacros.noObjects":"None specified","phenotips.tableMacros.rowDeleteConfirmation":"Are you sure you want to delete this row?","phenotips.tableMacros.listNotFound":"Cannot find the list to update","phenotips.tableMacros.typeNotFound":"Unable to add data of that type","phenotips.tableMacros.variantAlreadyExist":"This variant has already been entered","phenotips.widgets.helpButtons.xHelpButton.hint":"How to enter this information","phenotips.widgets.helpButtons.phenotype.hint":"About this phenotype","phenotips.widgets.helpButtons.phenotype.synonym":"Also known as","phenotips.widgets.helpButtons.phenotype.typeOf":"Is a type of","phenotips.widgets.helpButtons.phenotype.browseRelated":"Browse related terms...","phenotips.widgets.helpButtons.phenotypeQualifier.hint":"About this phenotype qualifier","phenotips.widgets.helpButtons.omimDisease.hint":"About this disease","phenotips.widgets.helpButtons.omimDisease.symptoms":"This disorder is typically characterized by","phenotips.widgets.helpButtons.omimDisease.notSymptoms":"This disorder does not typically cause","phenotips.widgets.helpButtons.omimDisease.linkToOmim":"Read about it on OMIM.org...","phenotips.widgets.helpButtons.gene.hint":"About this gene","phenotips.widgets.helpButtons.gene.alias":"Aliases","phenotips.widgets.helpButtons.gene.previousSymbols":"Previous symbols","phenotips.widgets.helpButtons.gene.family":"Gene family","phenotips.widgets.helpButtons.loading":"Loading...","phenotips.widgets.helpButtons.failedToLoad":"Failed to retrieve information about __subject__","phenotips.widgets.multiSuggest.clear.title":"Clear the list of selected suggestions","phenotips.widgets.multiSuggest.clear":"Delete all","phenotips.widgets.suggest.hideSuggestions":"hide suggestions","phenotips.widgets.workgroupPicker.noResults":"Group not found","phenotips.yesNoNAPicker.NA.title":"NA (irrelevant or unknown)","phenotips.yesNoNAPicker.NA.unselectedTitle":"Unselect","phenotips.yesNoNAPicker.yes.title":"YES (investigated and observed)","phenotips.yesNoNAPicker.yes.unselectedTitle":"Select as present","phenotips.yesNoNAPicker.yes.selectedTitle":"Unselect as present","phenotips.yesNoNAPicker.no.title":"NO (investigated and NOT observed)","phenotips.yesNoNAPicker.no.unselectedTitle":"Select as absent","phenotips.yesNoNAPicker.no.selectedTitle":"Unselect as absent"},render:function(name){var messgaeContent=this.messages[name];if(null==messgaeContent||null==messgaeContent)return"";for(var arguments=arguments,i=1;i<arguments.length;i++){var indexPointer="{"+(i-1).toString()+"}";messgaeContent.indexOf(indexPointer)&&(messgaeContent=messgaeContent.replace(indexPointer,arguments[i]))}return messgaeContent}}},WebService=Class.create({initialize:function(){this._settings=new Settings,this._baseURL=this._settings.getSetting("codingDefinitionServiceEndpoint"),this.baseURL=CONSTANTS.LOOKUP_SERVICE_URL},getOmimLookupPath:function(){return this._baseURL+"/codes-search/omim?"},getOrphanetLookupPath:function(){return this._baseURL+"/codes-search/orphanet?"},getEthnicityLookupPath:function(){return this._baseURL+"/codes-search/clinical_ethnicity?limit=50"},getHPOLookupPath:function(){return this._baseURL+"/codes-search/hpo?"},getHPOModifierLookupPath:function(){return this._baseURL+"/codes-search/hpo_modifier?"},getDiagramEndpointPath:function(){var config=this._settings.getSetting("diagramEndpoint");switch(config.service){case"mercury":var returnUrl=this.getUrlParameter("returnUrl",!0),participantId=this.getUrlParameter("participantId",!0),labkeyToken=this.getUrlParameter("labkeyToken",!0),labkeyEmail=this.getUrlParameter("labkeyEmail",!0);return config.mercuryPedigreeServiceEndpoint+"/"+participantId+"?accessPath="+returnUrl+"&labkeyToken="+labkeyToken+"&labkeyEmail="+labkeyEmail;case"openclinica":return"/openclinica/pedigree/get?eventCRFId="+this.getUrlParameter("eventCRFId",!0)+"&status="+this.getUrlParameter("status",!0)+"&participantId="+(participantId=this.getUrlParameter("participantId",!0));case"local":return null}},saveDiagramEndpointPath:function(){var config=this._settings.getSetting("diagramEndpoint");switch(config.service){case"mercury":var returnUrl=(_this=this).getUrlParameter("returnUrl",!0),participantId=this.getUrlParameter("participantId",!0),labkeyToken=this.getUrlParameter("labkeyToken",!0),labkeyEmail=this.getUrlParameter("labkeyEmail",!0);return config.mercuryPedigreeServiceEndpoint+"/"+participantId+"?accessPath="+returnUrl+"&labkeyToken="+labkeyToken+"&labkeyEmail="+labkeyEmail;case"openclinica":var _this;return"/openclinica/pedigree/update?eventCRFId="+(_this=this).getUrlParameter("eventCRFId",!0)+"&status="+_this.getUrlParameter("status",!0)+"&participantId="+(participantId=_this.getUrlParameter("participantId",!0));case"local":return null}},getPathToEditorFiles:function(){var config=this._settings.getSetting("diagramEndpoint");switch(config.service){case"mercury":case"openclinica":return Helpers.getSiteURL()+"/"+config.pathToEditorJSFiles;case"local":return Helpers.getSiteURL()+"/"}},getUrlParameter:function(sParam,doNotDecode){var sPageURL=decodeURIComponent(window.location.search.substring(1));doNotDecode&&1==doNotDecode&&(sPageURL=window.location.search.substring(1));var sParameterName,i,sURLVariables=sPageURL.split("&");for(i=0;i<sURLVariables.length;i++)if((sParameterName=sURLVariables[i].split("="))[0].toLowerCase()===sParam.toLowerCase())return void 0===sParameterName[1]||sParameterName[1]},getParticipantId:function(){switch(this._settings.getSetting("diagramEndpoint").service){case"mercury":case"openclinica":return this.getUrlParameter("participantId",!0);case"local":return null}}});var XWiki=function(a){return a.widgets=a.widgets||{},Object.extend(a,{constants:{anchorSeparator:"#",docextraCommentsAnchor:"Comments",docextraAttachmentsAnchor:"Attachments",docextraHistoryAnchor:"History",docextraInformationAnchor:"Information"},resource:{get:function(e,h){for(var b,d="",j=["Attachments"],g=[a.EntityType.DOCUMENT],f=0;f<j.length;f++)if(e.endsWith(a.constants.anchorSeparator+j[f])){d=j[f],e=e.substr(0,e.length-(d.length+1)),h=h||g[f];break}if(h)b=a.Model.resolve(e,h);else if(!(b=a.Model.resolve(e,a.EntityType.ATTACHMENT)).parent&&!(b=a.Model.resolve(e,a.EntityType.DOCUMENT)).parent){var c=a.Model.resolve(e,a.EntityType.SPACE);c.parent&&(b=c)}return this.fromEntityReference(b,d)},fromEntityReference:function(e,g){var l=e.extractReference(a.EntityType.WIKI);l=l&&l.name||a.currentWiki;var c=e.extractReference(a.EntityType.SPACE);c=c&&c.name||a.currentSpace;var j=e.extractReference(a.EntityType.DOCUMENT);j=j&&j.name||a.currentPage;var h=e.extractReference(a.EntityType.ATTACHMENT);h=h&&h.name||"";var f=new a.DocumentReference(l,c,j),d=a.Model.serialize(f.relativeTo(new a.WikiReference(l)));return{wiki:l,space:c,prefixedSpace:a.Model.serialize(f.parent),fullName:d,prefixedFullName:a.Model.serialize(f),name:j,attachment:h,anchor:g}},asEntityReference:function(e){for(var b,d=[e.wiki,e.space,e.name,e.attachment],c=0;c<d.length;c++)d[c]&&(b=new a.EntityReference(d[c],c,b));return b},serialize:function(c){var b=a.Model.serialize(this.asEntityReference(c));return c.anchor&&(0<b.length&&(b+=a.constants.anchorSeparator),b+=c.anchor),b}},getResource:function(b){return this.resource.get(b)},displayDocExtra:function(b,c,e){var d=function(f){var g=document.getElementById(f+"tab"),h=document.getElementById(f+"pane");null!=window.activeDocExtraTab&&(window.activeDocExtraTab.className="",window.activeDocExtraPane.className="hidden"),window.activeDocExtraTab=g,window.activeDocExtraPane=h,window.activeDocExtraTab.className="active",window.activeDocExtraPane.className="",g.blur(),document.fire("xwiki:docextra:activated",{id:f})};-1!=$(b+"pane").className.indexOf("empty")?(null!=window.activeDocExtraPane&&(window.activeDocExtraPane.className="invisible"),$("docextrapanes").className="loading",new Ajax.Updater(b+"pane",window.docgeturl+"?xpage=xpart&vm="+c,{method:"post",evalScripts:!0,onComplete:function(f){$("docextrapanes").className="",document.fire("xwiki:docextra:loaded",{id:b,element:$(b+"pane")}),d(b),e&&($(b+"anchor").id=b,location.href="#"+b,$(b).id=b+"anchor")}})):(d(b),e&&($(b+"anchor").id=b,location.href="#"+b,$(b).id=b+"anchor"))},makeRenderingErrorsExpandable:function(b){$(b||document.getElementById(PedigreeEditorTool.divId)).select(".xwikirenderingerror").each(function(c){""!==c.next().innerHTML&&c.next().hasClassName("xwikirenderingerrordescription")&&(c.style.cursor="pointer",c.title="Read technical information related to this error",Event.observe(c,"click",function(d){d.element().next().toggleClassName("hidden")}))})},fixLinksTargetAttribute:function(g){for(var f=$(g||document.getElementById(PedigreeEditorTool.divId)).select("a[rel]"),e=0;e<f.length;e++){var d=f[e];if(!d.up(".xRichTextEditor")&&(d.getAttribute("href")&&d.getAttribute("rel")))for(var b=d.getAttribute("rel").split(" "),c=0;c<b.length;c++){if("_"==b[c].charAt(0)){d.target=b[c].substring(1);break}if("external"==b[c]){d.target="_blank";break}}}},insertSectionEditLinks:function(b){},insertCreatePageFromTemplateModalBoxes:function(b){if("xwiki/1.0"!=a.docsyntax&&"view"==a.contextaction&&a.hasEdit&&a.widgets.ModalPopup){a.widgets.CreatePagePopup=Class.create(a.widgets.ModalPopup,{initialize:function($super,f){var e=new Element("div",{class:"modal-popup"});e.insert(f.content),$super(e,{show:{method:this.showDialog,keys:[]},close:{method:this.closeDialog,keys:["Esc"]}},{displayCloseButton:!0,verticalPosition:"center",backgroundColor:"#FFF"}),this.showDialog(),this.setClass("createpage-modal-popup")}});for(var d=$(b||document.getElementById(PedigreeEditorTool.divId)).select("span.wikicreatelink"),c=0;c<d.length;c++)d[c].down("a").observe("click",function(e){new Ajax.Request(e.findElement("a").href.replace(/#.*$/,""),{method:"get",parameters:{xpage:"createinline",ajax:1},onSuccess:function(g){var f=g.getHeader("redirect");f?window.location=f:new a.widgets.CreatePagePopup({content:g.responseText})},onFailure:function(){new a.widgets.Notification("An error occurred, please refresh the page and try again","error",{inactive:!0}).show()}}),e.stop()})}},watchlist:{actionsMap:{tmWatchDocument:"adddocument",tmUnwatchDocument:"removedocument",tmWatchSpace:"addspace",tmUnwatchSpace:"removespace",tmWatchWiki:"addwiki",tmUnwatchWiki:"removewiki"},flowMap:{tmWatchDocument:"tmUnwatchDocument",tmUnwatchDocument:"tmWatchDocument",tmWatchSpace:"tmUnwatchSpace",tmUnwatchSpace:"tmWatchSpace",tmWatchWiki:"tmUnwatchWiki",tmUnwatchWiki:"tmWatchWiki"},executeAction:function(b){var d=window.docgeturl+"?xpage=watch&do="+this.actionsMap[b.id];new Ajax.Request(d,{method:"get",onComplete:function(){"A"==b.nodeName?(b.up().toggleClassName("hidden"),$(a.watchlist.flowMap[b.id]).up().toggleClassName("hidden")):(b.toggleClassName("hidden"),$(a.watchlist.flowMap[b.id]).toggleClassName("hidden"))}})},initialize:function(b){for(button in b=$(b||document.getElementById(PedigreeEditorTool.divId)),a.watchlist.actionsMap){var d=b.down("#"+button);if(d){"A"!=d.nodeName&&(d=$(button).down("A")),d.stopObserving("click"),d.observe("click",function(f){Event.stop(f);for(var e=f.element();""==e.id;)e=e.up();a.watchlist.executeAction(e)})}}}},cookies:{create:function(d,e,f){if(f){var c=new Date;c.setTime(c.getTime()+24*f*60*60*1e3);var b="; expires="+c.toGMTString()}else b="";document.cookie=d+"="+e+b+"; path=/"},read:function(d){for(var f=d+"=",b=document.cookie.split(";"),e=0;e<b.length;e++){for(var g=b[e];" "==g.charAt(0);)g=g.substring(1,g.length);if(0==g.indexOf(f))return g.substring(f.length,g.length)}return null},erase:function(b){a.cookies.create(b,"",-1)}},togglePanelVisibility:function(b){(b=$(b)).toggleClassName("collapsed")},registerPanelToggle:function(b){$(b||document.getElementById(PedigreeEditorTool.divId)).select(".panel .xwikipaneltitle").each(function(c){c.observe("click",this.togglePanelVisibility.bind(this,c.up(".panel")))}.bind(this))},extractFileName:function(c){if((c=$(c)).files&&0<c.files.length)return c.files[0].name;if("C:\\fakepath\\"==c.value.substr(0,12))return c.value.substr(12);var b=c.value.lastIndexOf("/");return 0<=b?c.value.substr(b+1):0<=(b=c.value.lastIndexOf("\\"))?c.value.substr(b+1):c.value},initialize:function(){if(void 0===this.isInitialized||0==this.isInitialized){if(void 0===a.lastScriptLoaded)return void(a.failedInit=!0);this.isInitialized=!0,document.fire("xwiki:dom:loading"),document.observe("xwiki:dom:updated",function(b){b.memo.elements.each(this._addBehaviour.bind(this))}.bindAsEventListener(this)),this._addBehaviour(),this.domIsLoaded=!0,document.fire("xwiki:dom:loaded")}},_addBehaviour:function(b){b=b||$(document.getElementById(PedigreeEditorTool.divId)),this.makeRenderingErrorsExpandable(b),this.fixLinksTargetAttribute(b),this.insertSectionEditLinks(b),this.insertCreatePageFromTemplateModalBoxes(b),this.watchlist.initialize(b),this.registerPanelToggle(b)}}),a}(XWiki||{});function showsubmenu(a){if("span"==a.lastChild.tagName.toLowerCase()){window.hidetimer&&(window.hideelement==a.lastChild?(clearTimeout(window.hidetimer),window.hidetimer=null,window.hideelement=null):doHide());var b=Element.positionedOffset(a);a.lastChild.style.left=b[0]-10+"px",a.lastChild.style.top=b[1]+a.offsetHeight+"px",a.lastChild.className=a.lastChild.className.replace("hidden","visible")}}function hidesubmenu(a){"span"==a.lastChild.tagName.toLowerCase()&&(window.hideelement=a.lastChild,window.hidetimer=setTimeout(doHide,100))}function doHide(){window.hideelement.className=window.hideelement.className.replace("visible","hidden"),clearTimeout(window.hidetimer),window.hidetimer=null,window.hideelement=null}function toggleClass(b,a){eltHasClass(b,a)?rmClass(b,a):b.className+=" "+a}function addClass(b,a){eltHasClass(b,a)||(b.className+=" "+a)}function eltHasClass(b,a){return!!b.className&&new RegExp("\\b"+a+"\\b").test(b.className)}function rmClass(b,a){b.className=b.className.replace(new RegExp("\\s*\\b"+a+"\\b"),"")}function openURL(a){win=open(a,"win","titlebar=0,width=990,height=500,resizable,scrollbars"),win&&win.focus()}function openHelp(){win=open("http://platform.xwiki.org/xwiki/bin/view/Main/XWikiSyntax?xpage=print","XWikiSyntax","titlebar=0,width=750,height=480,resizable,scrollbars"),win&&win.focus()}function updateName(a,d,c){var b=a.value;return b=noaccent(b),0!=c&&(b=b.replace(/class$/gi,"")),null==d?a.value=b:d.value=b,""!=b}function noaccent(a){return temp=a.replace(/[\u00c0\u00c1\u00c2\u00c3\u00c4\u00c5\u0100\u0102\u0104\u01cd\u01de\u01e0\u01fa\u0200\u0202\u0226]/g,"A"),temp=temp.replace(/[\u00e0\u00e1\u00e2\u00e3\u00e4\u00e5\u0101\u0103\u0105\u01ce\u01df\u01e1\u01fb\u0201\u0203\u0227]/g,"a"),temp=temp.replace(/[\u00c6\u01e2\u01fc]/g,"AE"),temp=temp.replace(/[\u00e6\u01e3\u01fd]/g,"ae"),temp=temp.replace(/[\u008c\u0152]/g,"OE"),temp=temp.replace(/[\u009c\u0153]/g,"oe"),temp=temp.replace(/[\u00c7\u0106\u0108\u010a\u010c]/g,"C"),temp=temp.replace(/[\u00e7\u0107\u0109\u010b\u010d]/g,"c"),temp=temp.replace(/[\u00d0\u010e\u0110]/g,"D"),temp=temp.replace(/[\u00f0\u010f\u0111]/g,"d"),temp=temp.replace(/[\u00c8\u00c9\u00ca\u00cb\u0112\u0114\u0116\u0118\u011a\u0204\u0206\u0228]/g,"E"),temp=temp.replace(/[\u00e8\u00e9\u00ea\u00eb\u0113\u0115\u0117\u0119\u011b\u01dd\u0205\u0207\u0229]/g,"e"),temp=temp.replace(/[\u011c\u011e\u0120\u0122\u01e4\u01e6\u01f4]/g,"G"),temp=temp.replace(/[\u011d\u011f\u0121\u0123\u01e5\u01e7\u01f5]/g,"g"),temp=temp.replace(/[\u0124\u0126\u021e]/g,"H"),temp=temp.replace(/[\u0125\u0127\u021f]/g,"h"),temp=temp.replace(/[\u00cc\u00cd\u00ce\u00cf\u0128\u012a\u012c\u012e\u0130\u01cf\u0208\u020a]/g,"I"),temp=temp.replace(/[\u00ec\u00ed\u00ee\u00ef\u0129\u012b\u012d\u012f\u0131\u01d0\u0209\u020b]/g,"i"),temp=temp.replace(/[\u0132]/g,"IJ"),temp=temp.replace(/[\u0133]/g,"ij"),temp=temp.replace(/[\u0134]/g,"J"),temp=temp.replace(/[\u0135]/g,"j"),temp=temp.replace(/[\u0136\u01e8]/g,"K"),temp=temp.replace(/[\u0137\u0138\u01e9]/g,"k"),temp=temp.replace(/[\u0139\u013b\u013d\u013f\u0141]/g,"L"),temp=temp.replace(/[\u013a\u013c\u013e\u0140\u0142\u0234]/g,"l"),temp=temp.replace(/[\u00d1\u0143\u0145\u0147\u014a\u01f8]/g,"N"),temp=temp.replace(/[\u00f1\u0144\u0146\u0148\u0149\u014b\u01f9\u0235]/g,"n"),temp=temp.replace(/[\u00d2\u00d3\u00d4\u00d5\u00d6\u00d8\u014c\u014e\u0150\u01d1\u01ea\u01ec\u01fe\u020c\u020e\u022a\u022c\u022e\u0230]/g,"O"),temp=temp.replace(/[\u00f2\u00f3\u00f4\u00f5\u00f6\u00f8\u014d\u014f\u0151\u01d2\u01eb\u01ed\u01ff\u020d\u020f\u022b\u022d\u022f\u0231]/g,"o"),temp=temp.replace(/[\u0156\u0158\u0210\u0212]/g,"R"),temp=temp.replace(/[\u0157\u0159\u0211\u0213]/g,"r"),temp=temp.replace(/[\u015a\u015c\u015e\u0160\u0218]/g,"S"),temp=temp.replace(/[\u015b\u015d\u015f\u0161\u0219]/g,"s"),temp=temp.replace(/[\u00de\u0162\u0164\u0166\u021a]/g,"T"),temp=temp.replace(/[\u00fe\u0163\u0165\u0167\u021b\u0236]/g,"t"),temp=temp.replace(/[\u00d9\u00da\u00db\u00dc\u0168\u016a\u016c\u016e\u0170\u0172\u01d3\u01d5\u01d7\u01d9\u01db\u0214\u0216]/g,"U"),temp=temp.replace(/[\u00f9\u00fa\u00fb\u00fc\u0169\u016b\u016d\u016f\u0171\u0173\u01d4\u01d6\u01d8\u01da\u01dc\u0215\u0217]/g,"u"),temp=temp.replace(/[\u0174]/g,"W"),temp=temp.replace(/[\u0175]/g,"w"),temp=temp.replace(/[\u00dd\u0176\u0178\u0232]/g,"Y"),temp=temp.replace(/[\u00fd\u00ff\u0177\u0233]/g,"y"),temp=temp.replace(/[\u0179\u017b\u017d]/g,"Z"),temp=temp.replace(/[\u017a\u017c\u017e]/g,"z"),temp=temp.replace(/[\u00df]/g,"SS"),temp=temp.replace(/[^a-zA-Z0-9_]/g,""),temp}function prepareName(b){var d=b.register_first_name.value,a=b.register_last_name.value,c=b.xwikiname;""!=d&&(d=d.substring(0,1).toUpperCase()+d.substring(1)).replace(/ /g,""),""!=a&&(a=a.substring(0,1).toUpperCase()+a.substring(1)).replace(/ /g,""),""==c.value&&(c.value=noaccent(d+a))}function checkAdvancedContent(a){return result=!1,!document.forms.edit||(data=document.forms.edit.content.value,myRE=new RegExp("</?(html|body|img|a|i|b|embed|script|form|input|textarea|object|font|li|ul|ol|table|center|hr|br|p) ?([^>]*)>","ig"),results=data.match(myRE),results&&0<results.length&&(result=!0),myRE2=new RegExp("(#(set|include|if|end|for)|#(#) Advanced content|public class|/* Advanced content */)","ig"),results=data.match(myRE2),results&&0<results.length&&(result=!0),1!=result||confirm(a))}function BrowserDetect(){var b=navigator.userAgent.toLowerCase();this.isGecko=-1!=b.indexOf("gecko")&&-1==b.indexOf("safari"),this.isAppleWebKit=-1!=b.indexOf("applewebkit"),this.isKonqueror=-1!=b.indexOf("konqueror"),this.isSafari=-1!=b.indexOf("safari"),this.isOmniweb=-1!=b.indexOf("omniweb"),this.isOpera=-1!=b.indexOf("opera"),this.isIcab=-1!=b.indexOf("icab"),this.isAol=-1!=b.indexOf("aol"),this.isIE=-1!=b.indexOf("msie")&&!this.isOpera&&-1==b.indexOf("webtv"),this.isMozilla=this.isGecko&&b.indexOf("gecko/")+14==b.length,this.isFirefox=-1!=b.indexOf("firefox/")||-1!=b.indexOf("firebird/"),this.isNS=this.isGecko?-1!=b.indexOf("netscape"):-1!=b.indexOf("mozilla")&&!this.isOpera&&!this.isSafari&&-1==b.indexOf("spoofer")&&-1==b.indexOf("compatible")&&-1==b.indexOf("webtv")&&-1==b.indexOf("hotjava"),this.isIECompatible=-1!=b.indexOf("msie")&&!this.isIE,this.isNSCompatible=-1!=b.indexOf("mozilla")&&!this.isNS&&!this.isMozilla,this.geckoVersion=this.isGecko?b.substring(b.lastIndexOf("gecko/")+6,b.lastIndexOf("gecko/")+14):-1,this.equivalentMozilla=this.isGecko?parseFloat(b.substring(b.indexOf("rv:")+3)):-1,this.appleWebKitVersion=this.isAppleWebKit?parseFloat(b.substring(b.indexOf("applewebkit/")+12)):-1,this.versionMinor=parseFloat(navigator.appVersion),this.isGecko&&!this.isMozilla?this.versionMinor=parseFloat(b.substring(b.indexOf("/",b.indexOf("gecko/")+6)+1)):this.isMozilla?this.versionMinor=parseFloat(b.substring(b.indexOf("rv:")+3)):this.isIE&&4<=this.versionMinor?this.versionMinor=parseFloat(b.substring(b.indexOf("msie ")+5)):this.isKonqueror?this.versionMinor=parseFloat(b.substring(b.indexOf("konqueror/")+10)):this.isSafari?this.versionMinor=parseFloat(b.substring(b.lastIndexOf("safari/")+7)):this.isOmniweb?this.versionMinor=parseFloat(b.substring(b.lastIndexOf("omniweb/")+8)):this.isOpera?this.versionMinor=parseFloat(b.substring(b.indexOf("opera")+6)):this.isIcab&&(this.versionMinor=parseFloat(b.substring(b.indexOf("icab")+5))),this.versionMajor=parseInt(this.versionMinor),this.isDOM1=document.getElementById,this.isDOM2Event=document.addEventListener&&document.removeEventListener,this.mode=document.compatMode?document.compatMode:"BackCompat",this.isWin=-1!=b.indexOf("win"),this.isWin32=this.isWin&&(-1!=b.indexOf("95")||-1!=b.indexOf("98")||-1!=b.indexOf("nt")||-1!=b.indexOf("win32")||-1!=b.indexOf("32bit")||-1!=b.indexOf("xp")),this.isMac=-1!=b.indexOf("mac"),this.isUnix=-1!=b.indexOf("unix")||-1!=b.indexOf("sunos")||-1!=b.indexOf("bsd")||-1!=b.indexOf("x11"),this.isLinux=-1!=b.indexOf("linux"),this.isNS4x=this.isNS&&4==this.versionMajor,this.isNS40x=this.isNS4x&&this.versionMinor<4.5,this.isNS47x=this.isNS4x&&4.7<=this.versionMinor,this.isNS4up=this.isNS&&4<=this.versionMinor,this.isNS6x=this.isNS&&6==this.versionMajor,this.isNS6up=this.isNS&&6<=this.versionMajor,this.isNS7x=this.isNS&&7==this.versionMajor,this.isNS7up=this.isNS&&7<=this.versionMajor,this.isIE4x=this.isIE&&4==this.versionMajor,this.isIE4up=this.isIE&&4<=this.versionMajor,this.isIE5x=this.isIE&&5==this.versionMajor,this.isIE55=this.isIE&&5.5==this.versionMinor,this.isIE5up=this.isIE&&5<=this.versionMajor,this.isIE6x=this.isIE&&6==this.versionMajor,this.isIE6up=this.isIE&&6<=this.versionMajor,this.isIE4xMac=this.isIE4x&&this.isMac;var a=/trident\/(\d+)/.exec(b);this.isIE11up=a&&7<=parseInt(a[1])}document.observe("dom:loaded",XWiki.initialize.bind(XWiki)),shortcut={all_shortcuts:{},add:function(b,h,d){var g={type:"keydown",propagate:!1,disable_in_input:!1,target:document,keycode:!1};if(d)for(var a in g)void 0===d[a]&&(d[a]=g[a]);else d=g;var f=d.target;"string"==typeof d.target&&(f=document.getElementById(d.target));b=b.toLowerCase();var e=function(p){var m;if((p=p||window.event,d.disable_in_input)&&(p.target?m=p.target:p.srcElement&&(m=p.srcElement),3==m.nodeType&&(m=m.parentNode),"INPUT"==m.tagName||"TEXTAREA"==m.tagName||"SELECT"==m.tagName))return;var j=0;p.keyCode?j=p.keyCode:p.which&&(j=p.which);var o=String.fromCharCode(j).toLowerCase();188==j&&(o=","),190==j&&(o=".");var t=b.split("+"),s=0,q={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|"},n={esc:27,escape:27,tab:9,space:32,return:13,enter:13,backspace:8,scrolllock:145,scroll_lock:145,scroll:145,capslock:20,caps_lock:20,caps:20,numlock:144,num_lock:144,num:144,pause:19,break:19,insert:45,home:36,delete:46,end:35,pageup:33,page_up:33,pu:33,pagedown:34,page_down:34,pd:34,left:37,up:38,right:39,down:40,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123},r={shift:{wanted:!1,pressed:!1},ctrl:{wanted:!1,pressed:!1},alt:{wanted:!1,pressed:!1},meta:{wanted:!1,pressed:!1}};p.ctrlKey&&(r.ctrl.pressed=!0),p.shiftKey&&(r.shift.pressed=!0),p.altKey&&(r.alt.pressed=!0),p.metaKey&&(r.meta.pressed=!0);for(var l=0;k=t[l],l<t.length;l++)"ctrl"==k||"control"==k?(s++,r.ctrl.wanted=!0):"shift"==k?(s++,r.shift.wanted=!0):"alt"==k?(s++,r.alt.wanted=!0):"meta"==k?(s++,r.meta.wanted=!0):1<k.length?n[k]==j&&s++:d.keycode?d.keycode==j&&s++:o==k?s++:q[o]&&p.shiftKey&&(o=q[o])==k&&s++;if(s==t.length&&r.ctrl.pressed==r.ctrl.wanted&&r.shift.pressed==r.shift.wanted&&r.alt.pressed==r.alt.wanted&&r.meta.pressed==r.meta.wanted&&(h(p),!d.propagate))return p.cancelBubble=!0,p.returnValue=!1,document.all&&!window.opera&&window.XMLHttpRequest&&(p.keyCode=0),p.stopPropagation&&(p.stopPropagation(),p.preventDefault()),!1};this.all_shortcuts[b]={callback:e,target:f,event:d.type},f.addEventListener?f.addEventListener(d.type,e,!1):f.attachEvent?f.attachEvent("on"+d.type,e):f["on"+d.type]=e},remove:function(a){a=a.toLowerCase();var d=this.all_shortcuts[a];if(delete this.all_shortcuts[a],d){var b=d.event,c=d.target,e=d.callback;c.detachEvent?c.detachEvent("on"+b,e):c.removeEventListener?c.removeEventListener(b,e,!1):c["on"+b]=!1}}};var browser=new BrowserDetect;XWiki.Document=Class.create({initialize:function(c,b,a){this.page=c||XWiki.Document.currentPage,this.space=b||XWiki.Document.currentSpace,this.wiki=a||XWiki.Document.currentWiki},getURL:function(c,d,b){c=c||"view";var a=XWiki.Document.URLTemplate;return a=(a=(a=a.replace("__space__",encodeURIComponent(this.space))).replace("__page__","WebHome"==this.page?"":encodeURIComponent(this.page))).replace("__action__/","view"==c?"":encodeURIComponent(c)+"/"),d&&(a+="?"+d),b&&(a+="#"+b),a},getRestURL:function(a,c){a=a||"";var b=XWiki.Document.RestURLTemplate;return b=(b=(b=b.replace("__wiki__",this.wiki)).replace("__space__",this.space)).replace("__page__",this.page),a&&(b+="/"+a),c&&(b+="?"+c),b}});var htmlElement=$(document.documentElement);XWiki.Document.currentWiki=XWiki.currentWiki||"xwiki",htmlElement.readAttribute("data-xwiki-wiki")?XWiki.Document.currentWiki=htmlElement.readAttribute("data-xwiki-wiki"):0<$$("meta[name=wiki]").length&&(XWiki.Document.currentWiki=$$("meta[name=wiki]")[0].content),XWiki.Document.currentSpace=XWiki.currentSpace||"Main",htmlElement.readAttribute("data-xwiki-space")?XWiki.Document.currentSpace=htmlElement.readAttribute("data-xwiki-space"):0<$$("meta[name=space]").length&&(XWiki.Document.currentSpace=$$("meta[name=space]")[0].content),XWiki.Document.currentPage=XWiki.currentPage||"WebHome",htmlElement.readAttribute("data-xwiki-page")?XWiki.Document.currentPage=htmlElement.readAttribute("data-xwiki-page"):0<$$("meta[name=page]").length&&(XWiki.Document.currentPage=$$("meta[name=page]")[0].content),XWiki.Document.URLTemplate="/__action__/__space__/__page__",XWiki.Document.RestURLTemplate="/rest/wikis/__wiki__/spaces/__space__/pages/__page__",XWiki.Document.WikiSearchURLStub="/rest/wikis/__wiki__/search",XWiki.Document.SpaceSearchURLStub="/rest/wikis/__wiki__/spaces/__space__/search",XWiki.Document.getRestSearchURL=function(d,c,a){var b;return a=a||XWiki.Document.currentWiki,b=c?XWiki.Document.SpaceSearchURLStub.replace("__wiki__",a).replace("__space__",c):XWiki.Document.WikiSearchURLStub.replace("__wiki__",a),d&&(b+="?"+d),b},XWiki.currentDocument=new XWiki.Document,function(){var b;if("placeholder"in document.createElement("input"))b=function(e){var d=e.memo.element;""===d.placeholder&&(d.hasClassName("useTitleAsTip")?d.placeholder=d.title:(d.placeholder=d.defaultValue,d.value=""))};else{b=function(f){var e=f.memo.element,d=e.value;e.readAttribute("placeholder")?e.defaultValue=e.readAttribute("placeholder"):e.hasClassName("useTitleAsTip")&&(e.defaultValue=e.title),e.value=d,e.value==e.defaultValue&&e.addClassName("empty"),e.observe("focus",function(){var d=this.hasClassName("empty");this.removeClassName("empty"),d?this.value="":this.select()}.bindAsEventListener(e)),e.observe("blur",function(){""==this.value&&(this.value=this.defaultValue,this.addClassName("empty"))}.bindAsEventListener(e))}}document.observe("xwiki:addBehavior:withTip",b),document.observe("xwiki:dom:loaded",function(){$$("input.withTip","textarea.withTip","[placeholder]").each(function(d){document.fire("xwiki:addBehavior:withTip",{element:d})})}),document.observe("xwiki:dom:updated",function(d){d.memo.elements.each(function(e){e.select("input.withTip","textarea.withTip","[placeholder]").each(function(f){document.fire("xwiki:addBehavior:withTip",{element:f})})})})}(),document.observe("xwiki:dom:loaded",function(){var b={documents:{script:XWiki.Document.getRestSearchURL("scope=name&number=10&"),varname:"q",icon:"resources/icons/silk/page_white_text.png",noresults:"Document not found",json:!0,resultsParameter:"searchResults",resultId:"id",resultValue:"pageFullName",resultInfo:"pageFullName"},spaces:{script:XWiki.Document.getRestSearchURL("scope=spaces&number=10&"),varname:"q",icon:"resources/icons/silk/folder.png",noresults:"Space not found",json:!0,resultsParameter:"searchResults",resultId:"id",resultValue:"space",resultInfo:"space"}},a=function(f){if(void 0!==XWiki.widgets.Suggest)for(var e=Object.keys(b),d=0;d<e.length;d++){var c="input.suggest"+e[d].capitalize();f.each(function(g){$(g).select(c).each(function(i){if(!i.hasClassName("initialized")){var h={timeout:3e4};Object.extend(h,b[e[d]]);new XWiki.widgets.Suggest(i,h);i.addClassName("initialized")}})})}};a([$(document.documentElement)]),document.observe("xwiki:dom:updated",function(c){a(c.memo.elements)})}),["xwiki:dom:loaded","xwiki:dom:updated"].each(function(a){document.observe(a,function(b){void 0!==XWiki.widgets.Suggest&&(b.memo&&b.memo.elements||[document.documentElement]).each(function(d){d.select(".suggested").each(function(e){e.setAttribute("autocomplete","off"),"function"==typeof e.onfocus&&(e.onfocus(),e.removeAttribute("onfocus"))})})})}),document.observe("xwiki:dom:loaded",function(){var h=$("hierarchy"),d=$("breadcrumbs"),f=$("editParentTrigger"),b=$("parentinput"),a=$("xwikidocparentinput"),g=$("xwikidoctitleinput");function e(j){j&&j.stop(),b.removeClassName("active"),f.addClassName("edit-parent"),f.removeClassName("hide-edit-parent")}$("hideEditParentTrigger")&&($("hideEditParentTrigger").style.display="none"),f&&f.observe("click",function(j){j.stop(),j.element().blur(),f.hasClassName("edit-parent")?function(j){j&&j.stop(),b.addClassName("active"),a.focus(),f.removeClassName("edit-parent"),f.addClassName("hide-edit-parent")}():e()}),a&&((h||d)&&["blur","change","xwiki:suggest:selected"].each(function(j){a.observe(j,function(){var l={xpage:"xpart",vm:h?"hierarchy.vm":"space.vm",parent:a.value};g&&(l.title=g.value),new Ajax.Request(XWiki.currentDocument.getURL("edit"),{parameters:l,onSuccess:function(m){if(h)h.replace(m.responseText),h=$("hierarchy");else{var n=new Element("div");n.update(m.responseText),d.replace(n.down("[id=breadcrumbs]")),d=$("breadcrumbs")}}})})}),$(document.getElementById(PedigreeEditorTool.divId)).observe("click",function(j){j.element().descendantOf&&!j.element().descendantOf(b)&&j.element()!=b&&j.element()!=f&&e()}))}),document.observe("xwiki:dom:loaded",function(){if($(document.getElementById(PedigreeEditorTool.divId)).hasClassName("skin-colibri")){var f=$("contentmenu")||$("editmenu"),d=$("mainContentArea")||$("mainEditArea");f&&d&&(e(f),Event.observe(window,"resize",function(){if("fixed"==f.style.position&&(f.style.width=d.getWidth()+"px",void 0!==f.__fm_extra)){if("px"==f.__fm_extra.getStyle("padding-left").replace(/[^a-z]/g,"")){var g=f.__fm_extra.getStyle("border-left-width").replace(/[^0-9.]/g,"")-0;g+=f.__fm_extra.getStyle("padding-left").replace(/[^0-9.]/g,"")-0,g+=f.__fm_extra.getStyle("padding-right").replace(/[^0-9.]/g,"")-0,g+=f.__fm_extra.getStyle("border-right-width").replace(/[^0-9.]/g,"")-0}else g=50;f.__fm_extra.style.width=d.getWidth()-g+"px"}}),browser.isIE6x||(Event.observe(window,"scroll",b),document.observe("xwiki:annotations:settings:loaded",b)))}function b(){var h=$$(".annotationsettings"),g=0;h&&0<h.size()&&(f.__fm_extra=h[0],e(f.__fm_extra),g=f.__fm_extra.getHeight());var m=f.getHeight(),l=d.cumulativeOffset().top-g;if(document.viewport.getScrollOffsets().top>=l){var j=d.getWidth(),i=d.cumulativeOffset().left;c(f,0,i,j),f.__fm_extra&&c(f.__fm_extra,m,i,j-f.__fm_extra.getStyle("border-left-width").replace(/[^0-9]/g,"")-f.__fm_extra.getStyle("border-right-width").replace(/[^0-9]/g,"")-f.__fm_extra.getStyle("padding-right").replace(/[^0-9]/g,"")-f.__fm_extra.getStyle("padding-left").replace(/[^0-9]/g,""))}else a(f),a(f.__fm_extra)}function e(g){void 0===g.__fm_ghost&&(g.__fm_ghost=new Element("div"),g.__fm_ghost.hide(),g.insert({after:g.__fm_ghost})),g.__fm_ghost.clonePosition(g,{setWidth:!1})}function c(g,j,i,h){g&&(g.addClassName("floating-menu"),g.style.position="fixed",g.style.top=j+"px",g.style.left=i+"px",g.style.width=h+"px",g.__fm_ghost.show())}function a(g){g&&(g.removeClassName("floating-menu"),g.style.position="",g.style.top="",g.style.left="",g.style.width="",g.__fm_ghost.hide())}});var XWiki=function(l){var s=0;l.EntityType={WIKI:s++,SPACE:s++,DOCUMENT:s++,ATTACHMENT:s++,OBJECT:s++,OBJECT_PROPERTY:s++,CLASS_PROPERTY:s++};var d=[];for(var q in l.EntityType)if(l.EntityType.hasOwnProperty(q)){for(var f=l.EntityType[q],p=q.toLowerCase().split("_"),u=1;u<p.length;u++)p[u]=p[u].substr(0,1).toUpperCase()+p[u].substr(1);d[f]=p.join("")}l.EntityType.getName=function(i){return d[i]},l.EntityType.byName=function(A){for(var i=0;i<d.length;i++)if(d[i]===A)return i;return-1},l.EntityReference=Class.create({initialize:function(i,B,A){this.name=i,this.type=B,this.parent=A},extractReference:function(A){for(var i=this;i&&i.type!=A;)i=i.parent;return i},extractReferenceValue:function(A){var i=this.extractReference(A);return i?i.name:null},relativeTo:function(C){for(var B=this._extractComponents().reverse(),D=C?C._extractComponents().reverse():[];0<B.length&&0<D.length&&B[0].type!=D[0].type;)B[0].type>D[0].type?D.shift():B.shift();for(;0<B.length&&0<D.length&&B[0].type==D[0].type&&B[0].name==D[0].name;)B.shift(),D.shift();if(0==B.length)return new l.EntityReference("",this.type);B=B.reverse();for(var A=0;A<B.length;A++)B[A]=new l.EntityReference(B[A].name,B[A].type),0<A&&(B[A-1].parent=B[A]);return B[0]},_extractComponents:function(){for(var A=[],i=this;i;)A.push(i),i=i.parent;return A}}),l.WikiReference=Class.create(l.EntityReference,{initialize:function($super,i){$super(i,l.EntityType.WIKI)}}),l.SpaceReference=Class.create(l.EntityReference,{initialize:function($super,A,i){$super(i,l.EntityType.SPACE,new l.WikiReference(A))}}),l.DocumentReference=Class.create(l.EntityReference,{initialize:function($super,B,A,i){$super(i,l.EntityType.DOCUMENT,new l.SpaceReference(B,A))}}),l.AttachmentReference=Class.create(l.EntityReference,{initialize:function($super,A,i){$super(A,l.EntityType.ATTACHMENT,i)}});var r="\\",k=r+r,m=":",x=".",b="^",n=[[],[x,m,r],[x,r],["@",r],[b,r],[".",r],["^",x,r]],t=[[],[r+x,r+m,k],[r+x,k],["\\@",k],[r+b,k],["\\.",k],["\\^",r+x,k]],v=[[],[m],[x,m],["@",x,m],[b,x,m],[".",b,x,m],["^",x,m]],c=[[l.EntityType.WIKI],[l.EntityType.SPACE,l.EntityType.WIKI],[l.EntityType.DOCUMENT,l.EntityType.SPACE,l.EntityType.WIKI],[l.EntityType.ATTACHMENT,l.EntityType.DOCUMENT,l.EntityType.SPACE,l.EntityType.WIKI],[l.EntityType.OBJECT,l.EntityType.DOCUMENT,l.EntityType.SPACE,l.EntityType.WIKI],[l.EntityType.OBJECT_PROPERTY,l.EntityType.OBJECT,l.EntityType.DOCUMENT,l.EntityType.SPACE,l.EntityType.WIKI],[l.EntityType.CLASS_PROPERTY,l.EntityType.DOCUMENT,l.EntityType.SPACE,l.EntityType.WIKI]],z=[k,r],e=[r,""];function j(E,A,B){for(var D=0;D<B.length;D++){var C=A+D;if(C>=E.length||E.charAt(C)!=B.charAt(D))return!1}return!0}function a(F,E,D){for(var C=-1;++C<F.length;)for(var B=0;B<E.length;B++)if(j(F,C,E[B])){F=F.substr(0,C)+D[B]+F.substr(C+E[B].length),C+=D[B].length-1;break}return F}l.EntityReferenceResolver=Class.create({resolve:function(C,F){if(C=C||"",F=parseInt(F),isNaN(F)||F<0||v.length<=F)throw"No parsing definition found for Entity Type ["+F+"]";for(var D,B=v[F],H=c[F],G=0;G<B.length&&null!=C;G++){var E=this._splitAndUnescape(C,B[G]);C=E[0];var I=new l.EntityReference(E[1],H[G]);D=this._appendParent(D,I)}if(null!=C){var A=a(C,z,e);I=new l.EntityReference(A,H[B.length]);D=this._appendParent(D,I)}return D},_appendParent:function(i,B){if(i){for(var A=i;A.parent;)A=A.parent;return A.parent=B,i}return B},_splitAndUnescape:function(D,G){for(var C=[],E=D.length;0<=--E;){var B=D.charAt(E),A=E-1,H=0;if(0<=A&&(H=D.charAt(A)),B==G){if(this._getNumberOfCharsBefore(r,D,A)%2==0)break;--E}else H==r&&--E;C.push(B)}return[E<0?null:D.substring(0,E),C.reverse().join("")]},_getNumberOfCharsBefore:function(C,A,B){for(var i=B;0<=i&&A.charAt(i)==C;)--i;return B-i}}),l.EntityReferenceSerializer=Class.create({serialize:function(i){return i?this.serialize(i.parent)+this._serializeComponent(i):""},_serializeComponent:function(B){var i="",A=n[B.type];return B.parent&&(i+=B.parent.type==l.EntityType.WIKI?m:A[0]),0<A.length?i+=a(B.name,A,t[B.type]):i+=B.name.replace(r,k),i}});var g=new l.EntityReferenceResolver,w=new l.EntityReferenceSerializer;return l.Model={serialize:function(i){return w.serialize(i)},resolve:function(i,A){return g.resolve(i,A)}},l}(XWiki||{}),XWiki=function(b){var a=b.widgets=b.widgets||{};return a.ModalPopup=Class.create({options:{globalDialog:!0,title:"",displayCloseButton:!0,extraClassName:!1,screenColor:"",borderColor:"",titleColor:"",backgroundColor:"",screenOpacity:"0.5",verticalPosition:"center",horizontalPosition:"center",removeOnClose:!1,onClose:Prototype.emptyFunction},initialize:function(e,c,d){this.shortcuts={show:{method:this.showDialog,keys:["Ctrl+G","Meta+G"]},close:{method:this.closeDialog,keys:["Esc"]}},this.content=e||"Hello world!",this.shortcuts=Object.extend(Object.clone(this.shortcuts),c||{}),this.options=Object.extend(Object.clone(this.options),d||{}),this.registerShortcuts("show")},createDialog:function(e){this.dialog=new Element("div",{class:"xdialog-modal-container"});var d=new Element("div",{class:"xdialog-screen"}).setStyle({opacity:this.options.screenOpacity,backgroundColor:this.options.screenColor});if(this.dialog.update(d),this.dialogBox=new Element("div",{class:"xdialog-box"}),this.options.extraClassName&&this.dialogBox.addClassName(this.options.extraClassName),this.dialogBox._x_contentPlug=new Element("div",{class:"xdialog-content"}),this.dialogBox.update(this.dialogBox._x_contentPlug),this.dialogBox._x_contentPlug.update(this.content),this.options.title){var f=new Element("div",{class:"xdialog-title"}).update(this.options.title);f.setStyle({color:this.options.titleColor}),this.dialogBox.insertBefore(f,this.dialogBox.firstChild)}if(this.options.displayCloseButton){var c=new Element("div",{class:"xdialog-close",title:"Close"}).update("&#215;");c.observe("click",this.closeDialog.bindAsEventListener(this)),this.options.title?(f.insert({bottom:c}),this.options.titleColor&&c.setStyle({color:this.options.titleColor})):this.dialogBox.insertBefore(c,this.dialogBox.firstChild)}switch(this.dialog.appendChild(this.dialogBox),this.dialogBox.setStyle({textAlign:"left",borderColor:this.options.borderColor,backgroundColor:this.options.backgroundColor}),this.options.verticalPosition){case"top":this.dialogBox.setStyle({top:"0"});break;case"bottom":this.dialogBox.setStyle({bottom:"0"});break;default:this.dialogBox.setStyle({top:"20%"})}switch(this.options.horizontalPosition){case"left":this.dialog.setStyle({textAlign:"left"});break;case"right":this.dialog.setStyle({textAlign:"right"});break;default:this.dialog.setStyle({textAlign:"center"}),this.dialogBox.setStyle({margin:"auto"})}$(document.getElementById(PedigreeEditorTool.divId)).appendChild(this.dialog),this.dialog.hide()},setClass:function(c){this.dialogBox.addClassName("xdialog-box-"+c)},removeClass:function(c){this.dialogBox.removeClassName("xdialog-box-"+c)},setContent:function(c){this.content=c,this.dialogBox._x_contentPlug.update(this.content)},showDialog:function(c){if(c&&Event.stop(c),this.options.globalDialog){if(a.ModalPopup.active)return;a.ModalPopup.active=!0}else{if(this.active)return;this.active=!0}this.dialog||this.createDialog(),this.attachKeyListeners(),this.dialog.show()},closeDialog:function(c){c&&Event.stop(c),this.options.onClose.call(this),this.dialog.hide(),this.options.removeOnClose&&this.dialog.remove(),this.detachKeyListeners(),this.options.globalDialog?a.ModalPopup.active=!1:this.active=!1},attachKeyListeners:function(){for(var c in this.shortcuts)"show"!=c&&this.registerShortcuts(c)},detachKeyListeners:function(){for(var c in this.shortcuts)"show"!=c&&this.unregisterShortcuts(c)},registerShortcuts:function(f){for(var c=this.shortcuts[f].keys,g=this.shortcuts[f].method.bindAsEventListener(this,f),d=this.shortcuts[f].options,e=0;e<c.size();++e)shortcut.add(c[e],g,d)},unregisterShortcuts:function(d){for(var c=0;c<this.shortcuts[d].keys.size();++c)shortcut.remove(this.shortcuts[d].keys[c])},createButton:function(d,f,e,i,h){var g=new Element("span",{class:"buttonwrapper"}),c=new Element("input",{type:d,class:"button",value:f,title:e,id:i});return h&&c.addClassName(h),g.update(c),g}}),a.ModalPopup.active=!1,b}(XWiki||{}),XWiki=function(c){var a=c.widgets=c.widgets||{};if(c.widgets.ModalPopup){function b(){return new a.JumpToPage}a.JumpToPage=Class.create(a.ModalPopup,{urlTemplate:"/__action__/__space__/__document__",initialize:function($super){var e=new Element("div");this.input=new Element("input",{type:"text",id:"jmp_target",title:"Space.Document"}),e.appendChild(this.input),this.viewButton=this.createButton("button","View","View document (Enter, Meta+V)","jmp_view"),this.editButton=this.createButton("button","Edit","Edit document in the default editor (Meta+E)","jmp_edit");var d=new Element("div",{class:"buttons"});d.appendChild(this.viewButton),d.appendChild(this.editButton),e.appendChild(d),$super(e,{show:{method:this.showDialog,keys:["Meta+G","Ctrl+G","Ctrl+/","Meta+/"]},view:{method:this.openDocument,keys:["Enter","Meta+V"],options:{propagate:!0}},edit:{method:this.openDocument,keys:["Meta+E"]}},{title:"Go to:",extraClassName:"jump-dialog",verticalPosition:"top"}),this.shortcuts.close.options={propagate:!0},this.addQuickLinksEntry()},createDialog:function($super,d){Event.observe(this.viewButton,"click",this.openDocument.bindAsEventListener(this,"view")),Event.observe(this.editButton,"click",this.openDocument.bindAsEventListener(this,"edit")),$super(d),void 0!==c.widgets.Suggest&&new c.widgets.Suggest(this.input,{script:"/rest/wikis/xwiki/search?scope=name&number=10&",varname:"q",noresults:"No documents found",icon:"resources/icons/silk/page_white_text.png",json:!0,resultsParameter:"searchResults",resultId:"id",resultValue:"pageFullName",resultInfo:"pageFullName",timeout:3e4,parentContainer:this.dialogBox,propagateEventKeyCodes:[Event.KEY_RETURN]})},showDialog:function($super){$super(),this.input.value="",this.input.focus()},closeDialog:function($super,d){d.type.startsWith("key")&&this.dialogBox.down(".ajaxsuggest")||($super(),this.input.__x_suggest.clearSuggestions())},openDocument:function(e,f){var g=this.dialogBox.down(".ajaxsuggest .xhighlight");if((!g||g.hasClassName("noSuggestion"))&&""!=this.input.value){Event.stop(e);var d=c.Model.resolve(this.input.value,c.EntityType.DOCUMENT);d.parent?window.self.location=this.urlTemplate.replace("__space__",d.parent.name).replace("__document__",d.name).replace("__action__",f):void 0!==c.widgets.Suggest&&new c.widgets.Notification("Invalid page name. Valid names have the following format: Space.Page","error")}},addQuickLinksEntry:function(){$$(".panel.QuickLinks .xwikipanelcontents").each(function(e){var d=new Element("span",{class:"jmp-activator"});d.update("Jump to any page in the wiki (Meta+G)"),Event.observe(d,"click",function(f){this.showDialog(f)}.bindAsEventListener(this)),e.appendChild(d)}.bind(this))}}),c.domIsLoaded&&b()||document.observe("xwiki:dom:loaded",b)}else console&&console.warn&&console.warn("[JumpToPage widget] Required class missing: XWiki.widgets.ModalPopup");return c}(XWiki||{});void 0===XWiki||void 0===XWiki.widgets||void 0===XWiki.widgets.ModalPopup?"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn("[ConfirmationBox widget] Required class missing: XWiki.widgets.ModalPopup"):XWiki.widgets.ConfirmationBox=Class.create(XWiki.widgets.ModalPopup,{defaultInteractionParameters:{confirmationText:"Are you sure?",yesButtonText:"Yes",noButtonText:"No",cancelButtonText:"Cancel",showCancelButton:!1},initialize:function($super,b,c){this.interactionParameters=Object.extend(Object.clone(this.defaultInteractionParameters),c||{});var a={show:{method:this.showDialog,keys:[]},yes:{method:this.onYes,keys:["Enter","Space","y"]},no:{method:this.onNo,keys:["n"]},close:{method:this.closeDialog,keys:["c"]}};this.interactionParameters.showCancelButton?a.close.keys.push("Esc"):a.no.keys.push("Esc"),$super(this.createContent(this.interactionParameters),a,{displayCloseButton:!1,removeOnClose:!0}),this.showDialog(),this.setClass("confirmation"),this.behavior=b||{}},createContent:function(e){var b=new Element("div",{class:"question"}).update(e.confirmationText),d=new Element("div",{class:"buttons"}),f=this.createButton("button",e.yesButtonText,"(Enter)","");Event.observe(f,"click",this.onYes.bindAsEventListener(this)),d.insert(f);var a=this.createButton("button",e.noButtonText,e.showCancelButton?"(n)":"(Esc)","","secondary");if(Event.observe(a,"click",this.onNo.bindAsEventListener(this)),d.insert(a),e.showCancelButton){var g=this.createButton("button",e.cancelButtonText,"(Esc)","","cancel secondary");Event.observe(g,"click",this.onCancel.bindAsEventListener(this)),d.insert(g)}var c=new Element("div");return c.insert(b).insert(d),c},onYes:function(){this.closeDialog(),"function"==typeof this.behavior.onYes&&this.behavior.onYes()},onNo:function(){this.closeDialog(),"function"==typeof this.behavior.onNo&&this.behavior.onNo()},onCancel:function(){this.closeDialog(),"function"==typeof this.behavior.onCancel&&this.behavior.onCancel()}}),void 0===XWiki||void 0===XWiki.widgets||void 0===XWiki.widgets.ConfirmationBox?"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn("[MessageBox widget] Required class missing: XWiki.widgets.ModalPopup"):XWiki.widgets.ConfirmedAjaxRequest=Class.create(XWiki.widgets.ConfirmationBox,{defaultAjaxRequestParameters:{on1223:function(a){a.request.options.onSuccess(a)},on0:function(a){a.request.options.onFailure(a)}},initialize:function($super,b,a,c){this.interactionParameters=Object.extend({displayProgressMessage:!0,progressMessageText:"Sending request...",displaySuccessMessage:!0,successMessageText:"Done!",displayFailureMessage:!0,failureMessageText:"Failed: "},c||{}),this.requestUrl=b,this.ajaxRequestParameters=Object.extend(Object.clone(this.defaultAjaxRequestParameters),a||{}),Object.extend(this.ajaxRequestParameters,{onSuccess:function(){this.interactionParameters.displaySuccessMessage?this.progressNotification?this.progressNotification.replace(new XWiki.widgets.Notification(this.interactionParameters.successMessageText,"done")):new XWiki.widgets.Notification(this.interactionParameters.successMessageText,"done"):this.progressNotification&&this.progressNotification.hide(),a.onSuccess&&a.onSuccess.apply(this,arguments)}.bind(this),onFailure:function(d){if(this.interactionParameters.displayFailureMessage){var e=d.statusText;""!=d.statusText&&12031!=d.status||(e="Server not responding"),this.progressNotification?this.progressNotification.replace(new XWiki.widgets.Notification(this.interactionParameters.failureMessageText+e,"error")):new XWiki.widgets.Notification(this.interactionParameters.failureMessageText+e,"error")}else this.progressNotification&&this.progressNotification.hide();a.onFailure&&a.onFailure.apply(this,arguments)}.bind(this)}),$super({onYes:function(){this.interactionParameters.displayProgressMessage&&(this.progressNotification=new XWiki.widgets.Notification(this.interactionParameters.progressMessageText,"inprogress")),new Ajax.Request(this.requestUrl,this.ajaxRequestParameters)}.bind(this)},this.interactionParameters)}});var XWiki=function(b){var a=b.widgets=b.widgets||{};return a.Notification=Class.create({text:"Hello world!",defaultOptions:{plain:{timeout:5},info:{timeout:5},warning:{timeout:5},error:{timeout:10},inprogress:{timeout:!1},done:{timeout:2}},initialize:function(e,d,c){this.text=e||this.text,this.type=void 0!==this.defaultOptions[d]?d:"plain",this.options=Object.extend(Object.clone(this.defaultOptions[this.type]),c||{}),this.createElement(),this.options.inactive||this.show()},createElement:function(){this.element||(this.element=new Element("div",{class:"xnotification xnotification-"+this.type}).update(this.text),this.options.icon&&this.element.setStyle({backgroundImage:this.options.icon,paddingLeft:"22px"}),this.options.backgroundColor&&this.element.setStyle({backgroundColor:this.options.backgroundColor}),this.options.color&&this.element.setStyle({color:this.options.color}),this.element=this.element.wrap(new Element("div",{class:"xnotification-wrapper"})),Event.observe(this.element,"click",this.hide.bindAsEventListener(this)))},show:function(){this.element.descendantOf(a.Notification.getContainer())||a.Notification.getContainer().insert({top:this.element}),this.element.show(),this.options.timeout&&(this.timer=window.setTimeout(this.hide.bind(this),1e3*this.options.timeout))},hide:function(){this.element.hide(),this.element.parentNode&&this.element.remove(),this.timer&&(window.clearTimeout(this.timer),this.timer=null),"function"==typeof this.options.onHide&&this.options.onHide()},replace:function(c){this.element.parentNode&&this.element.replace(c.element),this.timer&&(window.clearTimeout(this.timer),this.timer=null),c.show()}}),a.Notification.container=null,a.Notification.getContainer=function(){return a.Notification.container||(a.Notification.container=new Element("div",{class:"xnotification-container"}),$(document.getElementById(PedigreeEditorTool.divId)).insert(a.Notification.container)),a.Notification.container},b}(XWiki||{}),XWiki=function(b){var a=b.widgets=b.widgets||{};return a.XList=Class.create({initialize:function(c,d){if(this.items=c||[],this.options=d||{},this.listElement=new Element(this.options.ordered?"ol":"ul",{class:"xlist"+(this.options.classes?" "+this.options.classes:"")}),this.items&&0<this.items.length)for(var e=0;e<this.items.length;e++)this.addItem(this.items[e])},addItem:function(c){c&&c instanceof b.widgets.XListItem||(c=new b.widgets.XListItem(c));var d=c.getElement();this.options.itemClasses&&!this.options.itemClasses.blank()&&d.addClassName(this.options.itemClasses),this.listElement.insert(d),"object"==typeof this.options.eventListeners&&c.bindEventListeners(this.options.eventListeners),this.options.icon&&!this.options.icon.blank()&&c.setIcon(this.options.icon,this.options.overrideItemIcon),c.list=this},getElement:function(){return this.listElement}}),a.XListItem=Class.create({initialize:function(e,c){this.options=c||{};var d="xitem "+(this.options.noHighlight?"":"xhighlight ");d+=this.options.classes?this.options.classes:"",this.containerElement=new Element("div",{class:"xitemcontainer"}).insert(e||""),this.containerElement.addClassName(this.options.containerClasses||""),this.containerElement.setStyle({textIndent:"0px"}),this.options.value&&this.containerElement.insert(new Element("div",{class:"hidden value"}).insert(this.options.value)),this.listItemElement=new Element("li",{class:d}).update(this.containerElement),this.options.icon&&!this.options.icon.blank()&&(this.setIcon(this.options.icon),this.hasIcon=!0),"object"==typeof this.options.eventListeners&&this.bindEventListeners(this.options.eventListeners)},getElement:function(){return this.listItemElement},setIcon:function(d,c){this.hasIcon&&!c||(this.iconImage=new Image,this.iconImage.onload=function(){this.listItemElement.setStyle({backgroundImage:"url("+this.iconImage.src+")",backgroundRepeat:"no-repeat",backgroundPosition:"3px 3px"}),this.listItemElement.down(".xitemcontainer").setStyle({textIndent:this.iconImage.width+6+"px"})}.bind(this),this.iconImage.src=d)},bindEventListeners:function(e){for(var d=Object.keys(e),c=0;c<d.length;c++)this.listItemElement.observe(d[c],e[d[c]].bindAsEventListener(this.options.eventCallbackScope?this.options.eventCallbackScope:this))}}),b}(XWiki||{}),XWiki=function(b){var a=b.widgets=b.widgets||{};return void 0===a.XList?"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn("[Suggest widget] Required class missing: XWiki.widgets.XList"):a.Suggest=Class.create({options:{minchars:1,method:"get",varname:"input",className:"ajaxsuggest",timeout:2500,delay:500,offsety:0,shownoresults:!0,noresults:"No results!",maxheight:250,cache:!1,seps:"",icon:null,resultsParameter:"results",resultId:"id",resultValue:"value",resultInfo:"info",resultIcon:"icon",resultHint:"hint",resultType:"type",parentContainer:"pedigree-tool",highlight:!0,fadeOnClear:!0,hideButton:{positions:["top"],text:"hide suggestions"},insertBeforeSuggestions:null,displayValue:!1,displayValueText:"Value: ",align:"left",unifiedLoader:!1,loaderNode:null,propagateEventKeyCodes:[]},sInput:"",nInputChars:0,aSuggestions:{},iHighlighted:null,isActive:!1,initialize:function(c,d){if(!c)return!1;this.setInputField(c),this.options=Object.extend(Object.clone(this.options),d||{}),"object"==typeof this.options.sources?(this.isInMultiSourceMode=!0,this.sources=this.options.sources):this.sources=this.options,this.sources=[this.sources].flatten().compact(),0==this.sources.length&&this.sources.push({script:function(e,f){f([])}}),$(this.options.parentContainer)||(this.options.parentContainer=$(document.getElementById(PedigreeEditorTool.divId))),this.options.seps?this.seps=this.options.seps:this.seps="",this.latestRequest=0},setInputField:function(c){this.detach(),this.fld=$(c),this.fld.__x_suggest&&this.fld.__x_suggest.detach(),(this.fld.__x_suggest=this).onKeyUp=this.onKeyUp.bindAsEventListener(this),this.fld.observe("keyup",this.onKeyUp),this.onKeyPress=this.onKeyPress.bindAsEventListener(this),Prototype.Browser.IE||Prototype.Browser.WebKit||browser.isIE11up?this.fld.observe("keydown",this.onKeyPress):this.fld.observe("keypress",this.onKeyPress),this.fld.setAttribute("autocomplete","off"),this.fld.observe("blur",function(d){this.latestRequest++}.bind(this))},onKeyUp:function(f){switch(f.keyCode){case Event.KEY_RETURN:case Event.KEY_ESC:case Event.KEY_UP:case Event.KEY_DOWN:break;default:if(this.seps){for(var e=-1,c=0;c<this.seps.length;c++)this.fld.value.lastIndexOf(this.seps.charAt(c))>e&&(e=this.fld.value.lastIndexOf(this.seps.charAt(c)));-1==e?this.getSuggestions(this.fld.value):this.getSuggestions(this.fld.value.substring(e+1))}else this.getSuggestions(this.fld.value)}},onKeyPress:function(d){if($(this.isActive)){var c=d.keyCode,e=!0;switch(c){case Event.KEY_RETURN:this.iHighlighted||1!=Object.keys(this.aSuggestions).length||1!=this.aSuggestions[Object.keys(this.aSuggestions)[0]].length||this.highlightFirst(),this.setHighlightedValue(d);break;case Event.KEY_ESC:this.clearSuggestions();break;case Event.KEY_UP:case Event.KEY_DOWN:this.changeHighlight(c);break;default:e=!1}e&&this.options.propagateEventKeyCodes&&-1==this.options.propagateEventKeyCodes.indexOf(c)&&Event.stop(d)}},getSuggestions:function(g){if((g=g.strip().toLowerCase())==this.sInput)return!1;if(g.length<this.options.minchars)return this.sInput="",this.clearSuggestions(),!1;if(g.length>this.nInputChars&&Object.keys(this.aSuggestions).length&&this.options.cache){for(var m={},l=0;l<Object.keys(this.aSuggestions).length;l++){for(var o=Object.keys(this.aSuggestions)[l],h=[],k=0;k<this.aSuggestions[o].length;k++){var e=this.aSuggestions[o][k];e.value.substr(0,g.length).toLowerCase()==g&&h.push(e)}h.length&&(m[o]=n)}this.sInput=g,this.nInputChars=g.length,this.aSuggestions=m;for(l=0;l<sources.length;l++){var d=sources[l],n=this.aSuggestions[d.id];n&&this.createList(n,d)}return!1}this.sInput=g,this.nInputChars=g.length,this.prepareContainer(),this.latestRequest++;var c=this,f=this.latestRequest;return clearTimeout(this.ajID),this.container.select(".hide-button-wrapper").invoke("hide"),this.ajID=setTimeout(function(){c.doAjaxRequests(f)},this.options.delay),!1},doAjaxRequests:function(f,d){if(!(this.fld.value.length<this.options.minchars))for(var c=0;c<this.sources.length;c++){var e=this.sources[c];"function"==typeof e.script?(this.fld.addClassName("loading"),e.script(this.fld.value.strip(),function(g){f==this.latestRequest&&(this.aSuggestions[e.id]=g||[],g&&this.createList(this.aSuggestions[e.id],e),this.fld.removeClassName("loading"))}.bind(this))):this.doAjaxRequest(e,f,d)}},doAjaxRequest:function(f,g,e){var d=f.script+(f.script.indexOf("?")<0?"?":"&")+f.varname+"="+encodeURIComponent(this.fld.value.strip()),i=f.method||"get",h={};f.json?h.Accept="application/json":h.Accept="application/xml";var c={method:i,requestHeaders:h,onCreate:this.fld.addClassName.bind(this.fld,"loading"),onSuccess:this.setSuggestions.bindAsEventListener(this,f,g),onFailure:function(j){new b.widgets.Notification("Failed to retrieve suggestions: "+j.statusText,"error",{timeout:5})},onComplete:this.fld.removeClassName.bind(this.fld,"loading")};c.defaultValues=Object.clone(c),new Ajax.Request(d,Object.extend(c,e||{}))},setSuggestions:function(d,e,f){if(!(f<this.latestRequest)){var c=this.parseResponse(d,e);this.aSuggestions[e.id]=c||[],c&&this.createList(this.aSuggestions[e.id],e)}},_getNestedProperty:function(e,d){for(var c=d.split(".");c.length&&(e=e[c.shift()]););return 0<c.length?null:e},parseResponse:function(h,j){var d=[];if(j.json){var k=h.responseJSON;if(!k)return null;if(Object.isArray(k))var g=k;else g=this._getNestedProperty(k,j.resultsParameter||this.options.resultsParameter);for(var f=0;f<g.length;f++){var c=g[f];d.push({id:this._getNestedProperty(c,j.resultId||this.options.resultId),value:this._getNestedProperty(c,j.resultValue||this.options.resultValue),info:this._getNestedProperty(c,j.resultInfo||this.options.resultInfo),icon:this._getNestedProperty(c,j.resultIcon||this.options.resultIcon),hint:this._getNestedProperty(c,j.resultHint||this.options.resultHint),type:this._getNestedProperty(c,j.resultType||this.options.resultType)})}}else for(g=h.responseXML.getElementsByTagName(j.resultsParameter||this.options.resultsParameter)[0].childNodes,f=0;f<g.length;f++)g[f].hasChildNodes()&&d.push({id:g[f].getAttribute("id"),value:g[f].childNodes[0].nodeValue,info:g[f].getAttribute("info"),icon:g[f].getAttribute("icon"),hint:g[f].getAttribute("hint"),type:g[f].getAttribute("type")});return d},prepareContainer:function(){if(!$(this.options.parentContainer).down(".suggestItems")){var m=new Element("div",{class:"suggestItems "+this.options.className}),g=$(this.options.parentContainer).id.toLowerCase()==PedigreeEditorTool.divId.toLowerCase()?this.fld.cumulativeOffset():this.fld.positionedOffset(),j=this.fld.offsetWidth-2,l=this.options.width||j,c=this.fld.viewportOffset().left,e=$(document.getElementById(PedigreeEditorTool.divId)).getWidth();"left"==this.options.align||"auto"==this.options.align&&c+this.options.width<e?m.style.left=g.left+"px":"center"==this.options.align?m.style.left=g.left+(j-l)/2+"px":m.style.left=g.left+j-l+"px",m.style.top=g.top+this.fld.offsetHeight+this.options.offsety+"px",m.style[this.options.width?"width":"minWidth"]=l+"px";var p=this;m.onmouseover=function(){p.killTimeout()},m.onmouseout=function(){p.resetTimeout()},this.resultContainer=new Element("div",{class:"resultContainer"}),m.appendChild(this.resultContainer),$(this.options.parentContainer).insert(m),this.container=m,this.options.insertBeforeSuggestions&&this.resultContainer.insert(this.options.insertBeforeSuggestions),document.fire("xwiki:suggest:containerCreated",{container:this.container,suggest:this})}if(this.isInMultiSourceMode)for(var r=0;r<this.sources.length;r++){var o=this.sources[r];if(o.id=o.id||r,this.resultContainer.down(".results"+o.id))this.resultContainer.down(".results"+o.id).down("ul")&&this.resultContainer.down(".results"+o.id).down("ul").remove(),this.options.unifiedLoader?((this.options.loaderNode||this.fld).addClassName("loading"),this.resultContainer.down(".results"+o.id).addClassName("hidden").addClassName("loading")):this.resultContainer.down(".results"+o.id).down(".sourceContent").addClassName("loading");else{var f=new Element("div",{class:"results results"+o.id}),h=new Element("div",{class:"sourceName"});if(this.options.unifiedLoader&&f.addClassName("hidden").addClassName("loading"),void 0!==o.icon){var d=new Image;d.onload=function(){this.sourceHeader.setStyle({backgroundImage:"url("+this.iconImage.src+")"}),this.sourceHeader.setStyle({textIndent:this.iconImage.width+6+"px"})}.bind({sourceHeader:h,iconImage:d}),d.src=o.icon}h.insert(o.name),f.insert(h);var t="sourceContent "+(this.options.unifiedLoader?"":"loading");f.insert(new Element("div",{class:t})),void 0!==o.before&&this.resultContainer.insert(o.before),this.resultContainer.insert(f),void 0!==o.after&&this.resultContainer.insert(o.after)}}else this.resultContainer.down("ul")&&this.resultContainer.down("ul").remove();if(void 0!==this.options.hideButton&&"object"==typeof this.options.hideButton.positions&&0<this.options.hideButton.positions.length&&!this.container.down(".hide-button")){var k=this.options.hideButton.positions;for(r=0;r<k.length;r++){var u=new Element("span",{class:"hide-button"}).update(this.options.hideButton.text),q={};q[k[r]]=new Element("div",{class:"hide-button-wrapper"}).update(u),u.observe("click",this.clearSuggestions.bindAsEventListener(this)),this.container.insert(q)}}this.container.fire("xwiki:suggest:containerPrepared",{container:this.container,suggest:this});return this.container},createList:function(c,d){this._createList(c,d),this.isInMultiSourceMode&&this.resultContainer.down(".results.loading")||document.fire("xwiki:suggest:updated",{container:this.container,suggest:this})},_createList:function(f,d){this.isActive=!0;var c=this;if(this.killTimeout(),this.isInMultiSourceMode)(j=this.resultContainer.down(".results"+d.id)).removeClassName("loading"),j.down(".sourceContent").removeClassName("loading"),(0<f.length||this.options.shownoresults)&&j.removeClassName("hidden"),this.options.unifiedLoader&&!this.resultContainer.down(".results.loading")&&(this.options.loaderNode||this.fld).removeClassName("loading");else var j=this.resultContainer;if(0==f.length&&!this.options.shownoresults)return!1;j.down("ul")&&j.down("ul").remove(),this.container.select(".hide-button-wrapper").invoke("show");for(var h=new b.widgets.XList([],{icon:this.options.icon,classes:"suggestList",eventListeners:{click:function(i){return c.setHighlightedValue(i),!1},mouseover:function(){c.setHighlight(this.getElement())}}}),e=0,g=f.length;e<g;e++){var m=function(i){return((i||"")+"").escapeHTML()},k=new Element("div").insert(new Element("span",{class:"suggestId"}).update(m(f[e].id))).insert(new Element("span",{class:"suggestValue"}).update(m(f[e].value))).insert(new Element("span",{class:"suggestInfo"}).update(m(f[e].info))),l=new b.widgets.XListItem(this.createItemDisplay(f[e],d),{containerClasses:"suggestItem "+(f[e].type||""),value:k,noHighlight:!0});h.addItem(l)}0==f.length&&h.addItem(new b.widgets.XListItem(this.options.noresults,{classes:"noSuggestion",noHighlight:!0})),j.appendChild(h.getElement()),this.suggest=j;c=this;0<this.options.timeout&&(this.toID=setTimeout(function(){c.clearSuggestions()},this.options.timeout))},createItemDisplay:function(g,c){var h=this.sInput?this.sInput.escapeHTML():this.sInput,k=((g.value||"")+"").escapeHTML(),e=c.highlight?this.emphasizeMatches(h,k):k;g.hint&&(e+="<span class='hint'>"+(g.hint+"").escapeHTML()+"</span>");if(this.options.displayValue){var i=((g.info||"")+"").escapeHTML();j=new Element("div").insert(new Element("div",{class:"value"}).update(e)).insert(new Element("div",{class:"info"}).update("<span class='legend'>"+this.options.displayValueText+"</span>"+i))}else var j=new Element("span",{class:"info"}).update(e);if(g.icon){if(0<=g.icon.indexOf(".")||0<=g.icon.indexOf("/"))var f=new Element("img",{src:g.icon,class:"icon"});else f=new Element("i",{class:"icon "+g.icon});j.insert({top:f})}return j},emphasizeMatches:function(k,m){if(!k)return m;for(var c=m,i=k.split(" ").uniq().compact(),d=0,g={},e=0,n=i.length;e<n;e++)for(var h=c.toLowerCase().indexOf(i[e].toLowerCase());0<=h;){var f=c.substring(h,h+i[e].length),l="";i[e].length.times(function(){l+=" "}),g[h]=f,h=(c=c.substring(0,h)+l+c.substring(h+i[e].length)).toLowerCase().indexOf(i[e].toLowerCase())}return Object.keys(g).sortBy(function(j){return parseInt(j)}).each(function(j){var o=c.substring(0,parseInt(j)+d),p=c.substring(parseInt(j)+g[j].length+d);c=o+"<em>"+g[j]+"</em>"+p,d+=9}),c},changeHighlight:function(c){var d,f=this.resultContainer;if(!f)return!1;if(this.iHighlighted){if(c==Event.KEY_DOWN){if(!(d=this.iHighlighted.next())&&this.iHighlighted.up("div.results"))for(var e=this.iHighlighted.up("div.results").next();e&&!d;)d=e.down("li"),e=e.next();d||(d=f.down("li"))}else if(c==Event.KEY_UP){if(!(d=this.iHighlighted.previous())&&this.iHighlighted.up("div.results"))for(e=this.iHighlighted.up("div.results").previous();e&&!d;)d=e.down("li:last-child"),e=e.previous();d||(d=f.select("ul")[f.select("ul").length-1].down("li:last-child"))}}else c==Event.KEY_DOWN?d=f.down("div.results")?f.down("div.results").down("li"):f.down("li"):c==Event.KEY_UP&&0<f.select("li")&&(d=f.select("li")[f.select("li").length-1]);d&&this.setHighlight(d)},setHighlight:function(c){this.iHighlighted&&this.clearHighlight(),c.addClassName("xhighlight"),this.iHighlighted=c,this.killTimeout()},clearHighlight:function(){this.iHighlighted&&(this.iHighlighted.removeClassName("xhighlight"),delete this.iHighlighted)},highlightFirst:function(){if(this.suggest&&this.suggest.down("ul")){var c=this.suggest.down("ul").down("li");c&&this.setHighlight(c)}},hasActiveSelection:function(){return this.iHighlighted},setHighlightedValue:function(c){if(this.iHighlighted&&!this.iHighlighted.hasClassName("noSuggestion")){var k,l,m=function(i){return i.textContent||i.innerText},j=this.iHighlighted.down("img.icon"),f={suggest:this,id:m(this.iHighlighted.down(".suggestId")),value:m(this.iHighlighted.down(".suggestValue")),info:m(this.iHighlighted.down(".suggestInfo")),icon:j?j.src:"",originalEvent:c};if(""==this.sInput&&""==this.fld.value)k=l=f.value;else if(this.seps){for(var d=-1,g=0;g<this.seps.length;g++)this.fld.value.lastIndexOf(this.seps.charAt(g))>d&&(d=this.fld.value.lastIndexOf(this.seps.charAt(g)));k=-1==d?l=f.value:(l=this.fld.value.substring(0,d+1)+f.value).substring(d+1)}else k=l=f.value;if(!(c=Event.fire(this.fld,"xwiki:suggest:selected",Object.clone(f))).stopped&&(this.sInput=k,this.fld.value=l,this.fld.focus(),this.clearSuggestions(),"function"==typeof this.options.callback&&this.options.callback(Object.clone(f)),0<this.fld.id.indexOf("_suggest"))){var e=this.fld.id.substring(0,this.fld.id.indexOf("_suggest")),h=$(e);h&&(h.value=f.info)}}},killTimeout:function(){clearTimeout(this.toID)},resetTimeout:function(){clearTimeout(this.toID);var c=this;this.toID=setTimeout(function(){c.clearSuggestions()},1e3)},clearSuggestions:function(){this.clearHighlight(),this.killTimeout(),this.isActive=!1;var c=$(this.container),e=this;if(c&&c.parentNode){if(this.options.fadeOnClear)new Effect.Fade(c,{duration:"0.25",afterFinish:function(){$(e.container)&&$(e.container).remove()}});else $(this.container).remove();document.fire("xwiki:suggest:clearSuggestions",{suggest:this})}},detach:function(){this.fld&&(Event.stopObserving(this.fld,"keyup",this.onKeyUp),Prototype.Browser.IE||Prototype.Browser.WebKit?Event.stopObserving(this.fld,"keydown",this.onKeyPress):Event.stopObserving(this.fld,"keypress",this.onKeyPress),this.clearSuggestions(),this.fld.__x_suggest=null,this.fld.setAttribute("autocomplete","on"))}}),b}(XWiki||{}),config={codingDefinitionServiceEndpoint:CONSTANTS.LOOKUP_SERVICE_URL+"",diagramEndpoint:{service:"local",pathToEditorJSFiles:"/"},saveAndExit:!0},version="v1.7.6";String.prototype.parseColor=function(){var a="#";if("rgb("==this.slice(0,4))for(var c=this.slice(4,this.length-1).split(","),b=0;a+=parseInt(c[b]).toColorPart(),++b<3;);else if("#"==this.slice(0,1)){if(4==this.length)for(b=1;b<4;b++)a+=(this.charAt(b)+this.charAt(b)).toLowerCase();7==this.length&&(a=this.toLowerCase())}return 7==a.length?a:arguments[0]||this},Element.collectTextNodes=function(a){return $A($(a).childNodes).collect(function(b){return 3==b.nodeType?b.nodeValue:b.hasChildNodes()?Element.collectTextNodes(b):""}).flatten().join("")},Element.collectTextNodesIgnoreClass=function(a,b){return $A($(a).childNodes).collect(function(c){return 3==c.nodeType?c.nodeValue:c.hasChildNodes()&&!Element.hasClassName(c,b)?Element.collectTextNodesIgnoreClass(c,b):""}).flatten().join("")},Element.setContentZoom=function(a,b){return(a=$(a)).setStyle({fontSize:b/100+"em"}),Prototype.Browser.WebKit&&window.scrollBy(0,0),a},Element.getInlineOpacity=function(a){return $(a).style.opacity||""},Element.forceRerendering=function(a){try{a=$(a);var c=document.createTextNode(" ");a.appendChild(c),a.removeChild(c)}catch(b){}};var Effect={_elementDoesNotExistError:{name:"ElementDoesNotExistError",message:"The specified DOM element does not exist, but is required for this effect to operate"},Transitions:{linear:Prototype.K,sinoidal:function(a){return-Math.cos(a*Math.PI)/2+.5},reverse:function(a){return 1-a},flicker:function(a){return 1<(a=-Math.cos(a*Math.PI)/4+.75+Math.random()/4)?1:a},wobble:function(a){return-Math.cos(a*Math.PI*(9*a))/2+.5},pulse:function(b,a){return-Math.cos(b*((a||5)-.5)*2*Math.PI)/2+.5},spring:function(a){return 1-Math.cos(4.5*a*Math.PI)*Math.exp(6*-a)},none:function(a){return 0},full:function(a){return 1}},DefaultOptions:{duration:1,fps:100,sync:!1,from:0,to:1,delay:0,queue:"parallel"},tagifyText:function(a){var b="position:relative";Prototype.Browser.IE&&(b+=";zoom:1"),$A((a=$(a)).childNodes).each(function(c){3==c.nodeType&&(c.nodeValue.toArray().each(function(d){a.insertBefore(new Element("span",{style:b}).update(" "==d?String.fromCharCode(160):d),c)}),Element.remove(c))})},multiple:function(b,c){var e;e=("object"==typeof b||Object.isFunction(b))&&b.length?b:$(b).childNodes;var a=Object.extend({speed:.1,delay:0},arguments[2]||{}),d=a.delay;$A(e).each(function(g,f){new c(g,Object.extend(a,{delay:f*a.speed+d}))})},PAIRS:{slide:["SlideDown","SlideUp"],blind:["BlindDown","BlindUp"],appear:["Appear","Fade"]},toggle:function(b,c,a){return b=$(b),c=(c||"appear").toLowerCase(),Effect[Effect.PAIRS[c][b.visible()?1:0]](b,Object.extend({queue:{position:"end",scope:b.id||"global",limit:1}},a||{}))}};Effect.DefaultOptions.transition=Effect.Transitions.sinoidal,Effect.ScopedQueue=Class.create(Enumerable,{initialize:function(){this.effects=[],this.interval=null},_each:function(a){this.effects._each(a)},add:function(b){var c=(new Date).getTime();switch(Object.isString(b.options.queue)?b.options.queue:b.options.queue.position){case"front":this.effects.findAll(function(d){return"idle"==d.state}).each(function(d){d.startOn+=b.finishOn,d.finishOn+=b.finishOn});break;case"with-last":c=this.effects.pluck("startOn").max()||c;break;case"end":c=this.effects.pluck("finishOn").max()||c}b.startOn+=c,b.finishOn+=c,(!b.options.queue.limit||this.effects.length<b.options.queue.limit)&&this.effects.push(b),this.interval||(this.interval=setInterval(this.loop.bind(this),15))},remove:function(a){this.effects=this.effects.reject(function(b){return b==a}),0==this.effects.length&&(clearInterval(this.interval),this.interval=null)},loop:function(){for(var c=(new Date).getTime(),b=0,a=this.effects.length;b<a;b++)this.effects[b]&&this.effects[b].loop(c)}}),Effect.Queues={instances:$H(),get:function(a){return Object.isString(a)?this.instances.get(a)||this.instances.set(a,new Effect.ScopedQueue):a}},Effect.Queue=Effect.Queues.get("global"),Effect.Base=Class.create({position:null,start:function(a){a&&!1===a.transition&&(a.transition=Effect.Transitions.linear),this.options=Object.extend(Object.extend({},Effect.DefaultOptions),a||{}),this.currentFrame=0,this.state="idle",this.startOn=1e3*this.options.delay,this.finishOn=this.startOn+1e3*this.options.duration,this.fromToDelta=this.options.to-this.options.from,this.totalTime=this.finishOn-this.startOn,this.totalFrames=this.options.fps*this.options.duration,this.render=function(){function b(d,c){d.options[c+"Internal"]&&d.options[c+"Internal"](d),d.options[c]&&d.options[c](d)}return function(c){"idle"===this.state&&(this.state="running",b(this,"beforeSetup"),this.setup&&this.setup(),b(this,"afterSetup")),"running"===this.state&&(c=this.options.transition(c)*this.fromToDelta+this.options.from,this.position=c,b(this,"beforeUpdate"),this.update&&this.update(c),b(this,"afterUpdate"))}}(),this.event("beforeStart"),this.options.sync||Effect.Queues.get(Object.isString(this.options.queue)?"global":this.options.queue.scope).add(this)},loop:function(c){if(c>=this.startOn){if(c>=this.finishOn)return this.render(1),this.cancel(),this.event("beforeFinish"),this.finish&&this.finish(),void this.event("afterFinish");var b=(c-this.startOn)/this.totalTime,a=(b*this.totalFrames).round();a>this.currentFrame&&(this.render(b),this.currentFrame=a)}},cancel:function(){this.options.sync||Effect.Queues.get(Object.isString(this.options.queue)?"global":this.options.queue.scope).remove(this),this.state="finished"},event:function(a){this.options[a+"Internal"]&&this.options[a+"Internal"](this),this.options[a]&&this.options[a](this)},inspect:function(){var a=$H();for(property in this)Object.isFunction(this[property])||a.set(property,this[property]);return"#<Effect:"+a.inspect()+",options:"+$H(this.options).inspect()+">"}}),Effect.Parallel=Class.create(Effect.Base,{initialize:function(a){this.effects=a||[],this.start(arguments[1])},update:function(a){this.effects.invoke("render",a)},finish:function(a){this.effects.each(function(b){b.render(1),b.cancel(),b.event("beforeFinish"),b.finish&&b.finish(a),b.event("afterFinish")})}}),Effect.Tween=Class.create(Effect.Base,{initialize:function(c,f,e){c=Object.isString(c)?$(c):c;var b=$A(arguments),d=b.last(),a=5==b.length?b[3]:null;this.method=Object.isFunction(d)?d.bind(c):Object.isFunction(c[d])?c[d].bind(c):function(g){c[d]=g},this.start(Object.extend({from:f,to:e},a||{}))},update:function(a){this.method(a)}}),Effect.Event=Class.create(Effect.Base,{initialize:function(){this.start(Object.extend({duration:0},arguments[0]||{}))},update:Prototype.emptyFunction}),Effect.Opacity=Class.create(Effect.Base,{initialize:function(b){if(this.element=$(b),!this.element)throw Effect._elementDoesNotExistError;Prototype.Browser.IE&&!this.element.currentStyle.hasLayout&&this.element.setStyle({zoom:1});var a=Object.extend({from:this.element.getOpacity()||0,to:1},arguments[1]||{});a.from=parseFloat(a.from),a.to=parseFloat(a.to),this.start(a)},update:function(a){this.element.setOpacity(a)}}),Effect.Move=Class.create(Effect.Base,{initialize:function(b){if(this.element=$(b),!this.element)throw Effect._elementDoesNotExistError;var a=Object.extend({x:0,y:0,mode:"relative"},arguments[1]||{});this.start(a)},setup:function(){this.element.makePositioned(),this.originalLeft=parseFloat(this.element.getStyle("left")||"0"),this.originalTop=parseFloat(this.element.getStyle("top")||"0"),"absolute"==this.options.mode&&(this.options.x=this.options.x-this.originalLeft,this.options.y=this.options.y-this.originalTop)},update:function(a){this.element.setStyle({left:(this.options.x*a+this.originalLeft).round()+"px",top:(this.options.y*a+this.originalTop).round()+"px"})}}),Effect.MoveBy=function(b,a,c){return new Effect.Move(b,Object.extend({x:c,y:a},arguments[3]||{}))},Effect.Scale=Class.create(Effect.Base,{initialize:function(b,c){if(this.element=$(b),!this.element)throw Effect._elementDoesNotExistError;var a=Object.extend({scaleX:!0,scaleY:!0,scaleContent:!0,scaleFromCenter:!1,scaleMode:"box",scaleFrom:100,scaleTo:c},arguments[2]||{});this.start(a)},setup:function(){this.restoreAfterFinish=this.options.restoreAfterFinish||!1,this.elementPositioning=this.element.getStyle("position"),this.originalStyle={},["top","left","width","height","fontSize"].each(function(b){this.originalStyle[b]=this.element.style[b]}.bind(this)),this.originalTop=this.element.offsetTop,this.originalLeft=this.element.offsetLeft;var a=this.element.getStyle("font-size")||"100%";["em","px","%","pt"].each(function(b){0<a.indexOf(b)&&(this.fontSize=parseFloat(a),this.fontSizeType=b)}.bind(this)),this.factor=(this.options.scaleTo-this.options.scaleFrom)/100,this.dims=null,"box"==this.options.scaleMode&&(this.dims=[this.element.offsetHeight,this.element.offsetWidth]),/^content/.test(this.options.scaleMode)&&(this.dims=[this.element.scrollHeight,this.element.scrollWidth]),this.dims||(this.dims=[this.options.scaleMode.originalHeight,this.options.scaleMode.originalWidth])},update:function(a){var b=this.options.scaleFrom/100+this.factor*a;this.options.scaleContent&&this.fontSize&&this.element.setStyle({fontSize:this.fontSize*b+this.fontSizeType}),this.setDimensions(this.dims[0]*b,this.dims[1]*b)},finish:function(a){this.restoreAfterFinish&&this.element.setStyle(this.originalStyle)},setDimensions:function(a,e){var f={};if(this.options.scaleX&&(f.width=e.round()+"px"),this.options.scaleY&&(f.height=a.round()+"px"),this.options.scaleFromCenter){var c=(a-this.dims[0])/2,b=(e-this.dims[1])/2;"absolute"==this.elementPositioning?(this.options.scaleY&&(f.top=this.originalTop-c+"px"),this.options.scaleX&&(f.left=this.originalLeft-b+"px")):(this.options.scaleY&&(f.top=-c+"px"),this.options.scaleX&&(f.left=-b+"px"))}this.element.setStyle(f)}}),Effect.Highlight=Class.create(Effect.Base,{initialize:function(b){if(this.element=$(b),!this.element)throw Effect._elementDoesNotExistError;var a=Object.extend({startcolor:"#ffff99"},arguments[1]||{});this.start(a)},setup:function(){"none"!=this.element.getStyle("display")?(this.oldStyle={},this.options.keepBackgroundImage||(this.oldStyle.backgroundImage=this.element.getStyle("background-image"),this.element.setStyle({backgroundImage:"none"})),this.options.endcolor||(this.options.endcolor=this.element.getStyle("background-color").parseColor("#ffffff")),this.options.restorecolor||(this.options.restorecolor=this.element.getStyle("background-color")),this._base=$R(0,2).map(function(a){return parseInt(this.options.startcolor.slice(2*a+1,2*a+3),16)}.bind(this)),this._delta=$R(0,2).map(function(a){return parseInt(this.options.endcolor.slice(2*a+1,2*a+3),16)-this._base[a]}.bind(this))):this.cancel()},update:function(a){this.element.setStyle({backgroundColor:$R(0,2).inject("#",function(b,c,d){return b+(this._base[d]+this._delta[d]*a).round().toColorPart()}.bind(this))})},finish:function(){this.element.setStyle(Object.extend(this.oldStyle,{backgroundColor:this.options.restorecolor}))}}),Effect.ScrollTo=function(c){var b=arguments[1]||{},a=document.viewport.getScrollOffsets(),d=$(c).cumulativeOffset();return b.offset&&(d[1]+=b.offset),new Effect.Tween(null,a.top,d[1],b,function(e){scrollTo(a.left,e.round())})},Effect.Fade=function(c){var a=(c=$(c)).getInlineOpacity(),b=Object.extend({from:c.getOpacity()||1,to:0,afterFinishInternal:function(d){0==d.options.to&&d.element.hide().setStyle({opacity:a})}},arguments[1]||{});return new Effect.Opacity(c,b)},Effect.Appear=function(b){b=$(b);var a=Object.extend({from:"none"==b.getStyle("display")?0:b.getOpacity()||0,to:1,afterFinishInternal:function(c){c.element.forceRerendering()},beforeSetup:function(c){c.element.setOpacity(c.options.from).show()}},arguments[1]||{});return new Effect.Opacity(b,a)},Effect.Puff=function(b){var a={opacity:(b=$(b)).getInlineOpacity(),position:b.getStyle("position"),top:b.style.top,left:b.style.left,width:b.style.width,height:b.style.height};return new Effect.Parallel([new Effect.Scale(b,200,{sync:!0,scaleFromCenter:!0,scaleContent:!0,restoreAfterFinish:!0}),new Effect.Opacity(b,{sync:!0,to:0})],Object.extend({duration:1,beforeSetupInternal:function(c){Position.absolutize(c.effects[0].element)},afterFinishInternal:function(c){c.effects[0].element.hide().setStyle(a)}},arguments[1]||{}))},Effect.BlindUp=function(a){return(a=$(a)).makeClipping(),new Effect.Scale(a,0,Object.extend({scaleContent:!1,scaleX:!1,restoreAfterFinish:!0,afterFinishInternal:function(b){b.element.hide().undoClipping()}},arguments[1]||{}))},Effect.BlindDown=function(b){var a=(b=$(b)).getDimensions();return new Effect.Scale(b,100,Object.extend({scaleContent:!1,scaleX:!1,scaleFrom:0,scaleMode:{originalHeight:a.height,originalWidth:a.width},restoreAfterFinish:!0,afterSetup:function(c){c.element.makeClipping().setStyle({height:"0px"}).show()},afterFinishInternal:function(c){c.element.undoClipping()}},arguments[1]||{}))},Effect.SwitchOff=function(b){var a=(b=$(b)).getInlineOpacity();return new Effect.Appear(b,Object.extend({duration:.4,from:0,transition:Effect.Transitions.flicker,afterFinishInternal:function(c){new Effect.Scale(c.element,1,{duration:.3,scaleFromCenter:!0,scaleX:!1,scaleContent:!1,restoreAfterFinish:!0,beforeSetup:function(d){d.element.makePositioned().makeClipping()},afterFinishInternal:function(d){d.element.hide().undoClipping().undoPositioned().setStyle({opacity:a})}})}},arguments[1]||{}))},Effect.DropOut=function(b){var a={top:(b=$(b)).getStyle("top"),left:b.getStyle("left"),opacity:b.getInlineOpacity()};return new Effect.Parallel([new Effect.Move(b,{x:0,y:100,sync:!0}),new Effect.Opacity(b,{sync:!0,to:0})],Object.extend({duration:.5,beforeSetup:function(c){c.effects[0].element.makePositioned()},afterFinishInternal:function(c){c.effects[0].element.hide().undoPositioned().setStyle(a)}},arguments[1]||{}))},Effect.Shake=function(d){d=$(d);var b=Object.extend({distance:20,duration:.5},arguments[1]||{}),e=parseFloat(b.distance),c=parseFloat(b.duration)/10,a={top:d.getStyle("top"),left:d.getStyle("left")};return new Effect.Move(d,{x:e,y:0,duration:c,afterFinishInternal:function(f){new Effect.Move(f.element,{x:2*-e,y:0,duration:2*c,afterFinishInternal:function(g){new Effect.Move(g.element,{x:2*e,y:0,duration:2*c,afterFinishInternal:function(h){new Effect.Move(h.element,{x:2*-e,y:0,duration:2*c,afterFinishInternal:function(i){new Effect.Move(i.element,{x:2*e,y:0,duration:2*c,afterFinishInternal:function(j){new Effect.Move(j.element,{x:-e,y:0,duration:c,afterFinishInternal:function(k){k.element.undoPositioned().setStyle(a)}})}})}})}})}})}})},Effect.SlideDown=function(c){var a=(c=$(c).cleanWhitespace()).down().getStyle("bottom"),b=c.getDimensions();return new Effect.Scale(c,100,Object.extend({scaleContent:!1,scaleX:!1,scaleFrom:window.opera?0:1,scaleMode:{originalHeight:b.height,originalWidth:b.width},restoreAfterFinish:!0,afterSetup:function(d){d.element.makePositioned(),d.element.down().makePositioned(),window.opera&&d.element.setStyle({top:""}),d.element.makeClipping().setStyle({height:"0px"}).show()},afterUpdateInternal:function(d){d.element.down().setStyle({bottom:d.dims[0]-d.element.clientHeight+"px"})},afterFinishInternal:function(d){d.element.undoClipping().undoPositioned(),d.element.down().undoPositioned().setStyle({bottom:a})}},arguments[1]||{}))},Effect.SlideUp=function(c){var a=(c=$(c).cleanWhitespace()).down().getStyle("bottom"),b=c.getDimensions();return new Effect.Scale(c,window.opera?0:1,Object.extend({scaleContent:!1,scaleX:!1,scaleMode:"box",scaleFrom:100,scaleMode:{originalHeight:b.height,originalWidth:b.width},restoreAfterFinish:!0,afterSetup:function(d){d.element.makePositioned(),d.element.down().makePositioned(),window.opera&&d.element.setStyle({top:""}),d.element.makeClipping().show()},afterUpdateInternal:function(d){d.element.down().setStyle({bottom:d.dims[0]-d.element.clientHeight+"px"})},afterFinishInternal:function(d){d.element.hide().undoClipping().undoPositioned(),d.element.down().undoPositioned().setStyle({bottom:a})}},arguments[1]||{}))},Effect.Squish=function(a){return new Effect.Scale(a,window.opera?1:0,{restoreAfterFinish:!0,beforeSetup:function(b){b.element.makeClipping()},afterFinishInternal:function(b){b.element.hide().undoClipping()}})},Effect.Grow=function(c){c=$(c);var h,f,e,d,b=Object.extend({direction:"center",moveTransition:Effect.Transitions.sinoidal,scaleTransition:Effect.Transitions.sinoidal,opacityTransition:Effect.Transitions.full},arguments[1]||{}),a={top:c.style.top,left:c.style.left,height:c.style.height,width:c.style.width,opacity:c.getInlineOpacity()},g=c.getDimensions();switch(b.direction){case"top-left":h=f=e=d=0;break;case"top-right":h=g.width,f=d=0,e=-g.width;break;case"bottom-left":h=e=0,f=g.height,d=-g.height;break;case"bottom-right":h=g.width,f=g.height,e=-g.width,d=-g.height;break;case"center":h=g.width/2,f=g.height/2,e=-g.width/2,d=-g.height/2}return new Effect.Move(c,{x:h,y:f,duration:.01,beforeSetup:function(i){i.element.hide().makeClipping().makePositioned()},afterFinishInternal:function(i){new Effect.Parallel([new Effect.Opacity(i.element,{sync:!0,to:1,from:0,transition:b.opacityTransition}),new Effect.Move(i.element,{x:e,y:d,sync:!0,transition:b.moveTransition}),new Effect.Scale(i.element,100,{scaleMode:{originalHeight:g.height,originalWidth:g.width},sync:!0,scaleFrom:window.opera?1:0,transition:b.scaleTransition,restoreAfterFinish:!0})],Object.extend({beforeSetup:function(j){j.effects[0].element.setStyle({height:"0px"}).show()},afterFinishInternal:function(j){j.effects[0].element.undoClipping().undoPositioned().setStyle(a)}},b))}})},Effect.Shrink=function(c){c=$(c);var e,d,b=Object.extend({direction:"center",moveTransition:Effect.Transitions.sinoidal,scaleTransition:Effect.Transitions.sinoidal,opacityTransition:Effect.Transitions.none},arguments[1]||{}),a={top:c.style.top,left:c.style.left,height:c.style.height,width:c.style.width,opacity:c.getInlineOpacity()},f=c.getDimensions();switch(b.direction){case"top-left":e=d=0;break;case"top-right":e=f.width,d=0;break;case"bottom-left":e=0,d=f.height;break;case"bottom-right":e=f.width,d=f.height;break;case"center":e=f.width/2,d=f.height/2}return new Effect.Parallel([new Effect.Opacity(c,{sync:!0,to:0,from:1,transition:b.opacityTransition}),new Effect.Scale(c,window.opera?1:0,{sync:!0,transition:b.scaleTransition,restoreAfterFinish:!0}),new Effect.Move(c,{x:e,y:d,sync:!0,transition:b.moveTransition})],Object.extend({beforeStartInternal:function(g){g.effects[0].element.makePositioned().makeClipping()},afterFinishInternal:function(g){g.effects[0].element.hide().undoClipping().undoPositioned().setStyle(a)}},b))},Effect.Pulsate=function(c){c=$(c);var b=arguments[1]||{},a=c.getInlineOpacity(),e=b.transition||Effect.Transitions.linear;return new Effect.Opacity(c,Object.extend(Object.extend({duration:2,from:0,afterFinishInternal:function(f){f.element.setStyle({opacity:a})}},b),{transition:function(f){return 1-e(-Math.cos(f*(b.pulses||5)*2*Math.PI)/2+.5)}}))},Effect.Fold=function(b){var a={top:(b=$(b)).style.top,left:b.style.left,width:b.style.width,height:b.style.height};return b.makeClipping(),new Effect.Scale(b,5,Object.extend({scaleContent:!1,scaleX:!1,afterFinishInternal:function(c){new Effect.Scale(b,1,{scaleContent:!1,scaleY:!1,afterFinishInternal:function(d){d.element.hide().undoClipping().setStyle(a)}})}},arguments[1]||{}))},Effect.Morph=Class.create(Effect.Base,{initialize:function(c){if(this.element=$(c),!this.element)throw Effect._elementDoesNotExistError;var a=Object.extend({style:{}},arguments[1]||{});if(Object.isString(a.style))if(a.style.include(":"))this.style=a.style.parseStyle();else{this.element.addClassName(a.style),this.style=$H(this.element.getStyles()),this.element.removeClassName(a.style);var b=this.element.getStyles();this.style=this.style.reject(function(d){return d.value==b[d.key]}),a.afterFinishInternal=function(d){d.element.addClassName(d.options.style),d.transforms.each(function(e){d.element.style[e.style]=""})}}else this.style=$H(a.style);this.start(a)},setup:function(){function a(b){return b&&!["rgba(0, 0, 0, 0)","transparent"].include(b)||(b="#ffffff"),b=b.parseColor(),$R(0,2).map(function(c){return parseInt(b.slice(2*c+1,2*c+3),16)})}this.transforms=this.style.map(function(g){var f=g[0],e=g[1],d=null;if("#zzzzzz"!=e.parseColor("#zzzzzz"))e=e.parseColor(),d="color";else if("opacity"==f)e=parseFloat(e),Prototype.Browser.IE&&!this.element.currentStyle.hasLayout&&this.element.setStyle({zoom:1});else if(Element.CSS_LENGTH.test(e)){var c=e.match(/^([\+\-]?[0-9\.]+)(.*)$/);e=parseFloat(c[1]),d=3==c.length?c[2]:null}var b=this.element.getStyle(f);return{style:f.camelize(),originalValue:"color"==d?a(b):parseFloat(b||0),targetValue:"color"==d?a(e):e,unit:d}}.bind(this)).reject(function(b){return b.originalValue==b.targetValue||"color"!=b.unit&&(isNaN(b.originalValue)||isNaN(b.targetValue))})},update:function(a){for(var b,d={},c=this.transforms.length;c--;)d[(b=this.transforms[c]).style]="color"==b.unit?"#"+Math.round(b.originalValue[0]+(b.targetValue[0]-b.originalValue[0])*a).toColorPart()+Math.round(b.originalValue[1]+(b.targetValue[1]-b.originalValue[1])*a).toColorPart()+Math.round(b.originalValue[2]+(b.targetValue[2]-b.originalValue[2])*a).toColorPart():(b.originalValue+(b.targetValue-b.originalValue)*a).toFixed(3)+(null===b.unit?"":b.unit);this.element.setStyle(d,!0)}}),Effect.Transform=Class.create({initialize:function(a){this.tracks=[],this.options=arguments[1]||{},this.addTracks(a)},addTracks:function(a){return a.each(function(b){var c=(b=$H(b)).values().first();this.tracks.push($H({ids:b.keys().first(),effect:Effect.Morph,options:{style:c}}))}.bind(this)),this},play:function(){return new Effect.Parallel(this.tracks.map(function(a){var d=a.get("ids"),c=a.get("effect"),b=a.get("options");return[$(d)||$$(d)].flatten().map(function(f){return new c(f,Object.extend({sync:!0},b))})}).flatten(),this.options)}}),Element.CSS_PROPERTIES=$w("backgroundColor backgroundPosition borderBottomColor borderBottomStyle borderBottomWidth borderLeftColor borderLeftStyle borderLeftWidth borderRightColor borderRightStyle borderRightWidth borderSpacing borderTopColor borderTopStyle borderTopWidth bottom clip color fontSize fontWeight height left letterSpacing lineHeight marginBottom marginLeft marginRight marginTop markerOffset maxHeight maxWidth minHeight minWidth opacity outlineColor outlineOffset outlineWidth paddingBottom paddingLeft paddingRight paddingTop right textIndent top width wordSpacing zIndex"),Element.CSS_LENGTH=/^(([\+\-]?[0-9\.]+)(em|ex|px|in|cm|mm|pt|pc|\%))|0$/,String.__parseStyleElement=document.createElement("div"),String.prototype.parseStyle=function(){var b,a=$H();return b=Prototype.Browser.WebKit?new Element("div",{style:this}).style:(String.__parseStyleElement.innerHTML='<div style="'+this+'"></div>',String.__parseStyleElement.childNodes[0].style),Element.CSS_PROPERTIES.each(function(c){b[c]&&a.set(c,b[c])}),Prototype.Browser.IE&&this.include("opacity")&&a.set("opacity",this.match(/opacity:\s*((?:0|1)?(?:\.\d*)?)/)[1]),a},document.defaultView&&document.defaultView.getComputedStyle?Element.getStyles=function(b){var a=document.defaultView.getComputedStyle($(b),null);return Element.CSS_PROPERTIES.inject({},function(c,d){return c[d]=a[d],c})}:Element.getStyles=function(b){var c,a=(b=$(b)).currentStyle;return(c=Element.CSS_PROPERTIES.inject({},function(d,e){return d[e]=a[e],d})).opacity||(c.opacity=b.getOpacity()),c},Effect.Methods={morph:function(a,b){return a=$(a),new Effect.Morph(a,Object.extend({style:b},arguments[2]||{})),a},visualEffect:function(c,e,b){c=$(c);var d=e.dasherize().camelize(),a=d.charAt(0).toUpperCase()+d.substring(1);return new Effect[a](c,b),c},highlight:function(b,a){return b=$(b),new Effect.Highlight(b,a),b}},$w("fade appear grow shrink fold blindUp blindDown slideUp slideDown pulsate shake puff squish switchOff dropOut").each(function(a){Effect.Methods[a]=function(c,b){return c=$(c),Effect[a.charAt(0).toUpperCase()+a.substring(1)](c,b),c}}),$w("getInlineOpacity forceRerendering setContentZoom collectTextNodes collectTextNodesIgnoreClass getStyles").each(function(a){Effect.Methods[a]=Element[a]}),Element.addMethods(Effect.Methods),Date.CultureInfo={name:"en-US",englishName:"English (United States)",nativeName:"English (United States)",dayNames:["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],abbreviatedDayNames:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],shortestDayNames:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],firstLetterDayNames:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],abbreviatedMonthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],amDesignator:"AM",pmDesignator:"PM",firstDayOfWeek:0,dateElementOrder:"mdy",formatPatterns:{shortDate:"M/d/yyyy",longDate:"dddd, MMMM dd, yyyy",shortTime:"h:mm tt",longTime:"h:mm:ss tt",fullDateTime:"dddd, MMMM dd, yyyy h:mm:ss tt",sortableDateTime:"yyyy-MM-ddTHH:mm:ss",universalSortableDateTime:"yyyy-MM-dd HH:mm:ssZ",rfc1123:"ddd, dd MMM yyyy HH:mm:ss GMT",monthDay:"MMMM dd",yearMonth:"MMMM, yyyy"},regexPatterns:{jan:/^(January)|(Jan)/i,feb:/^(February)|(Feb)/i,mar:/^(March)|(Mar)/i,apr:/^(April)|(Apr)/i,may:/^(May)|(May)/i,jun:/^(June)|(Jun)/i,jul:/^(July)|(Jul)/i,aug:/^(August)|(Aug)/i,sep:/^(September)|(Sep)/i,oct:/^(October)|(Oct)/i,nov:/^(November)|(Nov)/i,dec:/^(December)|(Dec)/i,sun:/^(Monday)|(Mon)|(Mon)|(Mon)/i,mon:/^(Tuesday)|(Tue)|(Tue)|(Tue)/i,tue:/^(Wednesday)|(Wed)|(Wed)|(Wed)/i,wed:/^(Thursday)|(Thu)|(Thu)|(Thu)/i,thu:/^(Friday)|(Fri)|(Fri)|(Fri)/i,fri:/^(Saturday)|(Sat)|(Sat)|(Sat)/i,sat:/^(Sunday)|(Sun)|(Sun)|(Sun)/i,future:/^next/i,past:/^last|past|prev(ious)?/i,add:/^(\+|aft(er)?|from|hence)/i,subtract:/^(\-|bef(ore)?|ago)/i,yesterday:/^yes(terday)?/i,today:/^t(od(ay)?)?/i,tomorrow:/^tom(orrow)?/i,now:/^n(ow)?/i,millisecond:/^ms|milli(second)?s?/i,second:/^sec(ond)?s?/i,minute:/^mn|min(ute)?s?/i,hour:/^h(our)?s?/i,week:/^w(eek)?s?/i,month:/^m(onth)?s?/i,day:/^d(ay)?s?/i,year:/^y(ear)?s?/i,shortMeridian:/^(a|p)/i,longMeridian:/^(a\.?m?\.?|p\.?m?\.?)/i,timezone:/^((e(s|d)t|c(s|d)t|m(s|d)t|p(s|d)t)|((gmt)?\s*(\+|\-)\s*\d\d\d\d?)|gmt|utc)/i,ordinalSuffix:/^\s*(st|nd|rd|th)/i,timeContext:/^\s*(\:|a(?!u|p)|p)/i},timezones:[{name:"UTC",offset:"-000"},{name:"GMT",offset:"-000"},{name:"EST",offset:"-0500"},{name:"EDT",offset:"-0400"},{name:"CST",offset:"-0600"},{name:"CDT",offset:"-0500"},{name:"MST",offset:"-0700"},{name:"MDT",offset:"-0600"},{name:"PST",offset:"-0800"},{name:"PDT",offset:"-0700"}]},_translations={OK:"OK",Now:"Now",Today:"Today",Clear:"Clear"},Date.getMonthNumberFromName=function(b){for(var e=Date.CultureInfo.monthNames,a=Date.CultureInfo.abbreviatedMonthNames,d=b.toLowerCase(),c=0;c<e.length;c++)if(e[c].toLowerCase()==d||a[c].toLowerCase()==d)return c;return-1},Date.getDayNumberFromName=function(b){for(var f=Date.CultureInfo.dayNames,a=Date.CultureInfo.abbreviatedDayNames,d=(Date.CultureInfo.shortestDayNames,b.toLowerCase()),c=0;c<f.length;c++)if(f[c].toLowerCase()==d||a[c].toLowerCase()==d)return c;return-1},Date.isLeapYear=function(a){return a%4==0&&a%100!=0||a%400==0},Date.getDaysInMonth=function(a,b){return[31,Date.isLeapYear(a)?29:28,31,30,31,30,31,31,30,31,30,31][b]},Date.getTimezoneOffset=function(a,b){return b?Date.CultureInfo.abbreviatedTimeZoneDST[a.toUpperCase()]:Date.CultureInfo.abbreviatedTimeZoneStandard[a.toUpperCase()]},Date.getTimezoneAbbreviation=function(b,d){var a,c=d?Date.CultureInfo.abbreviatedTimeZoneDST:Date.CultureInfo.abbreviatedTimeZoneStandard;for(a in c)if(c[a]===b)return a;return null},Date.prototype.clone=function(){return new Date(this.getTime())},Date.prototype.compareTo=function(a){if(isNaN(this))throw new Error(this);if(a instanceof Date&&!isNaN(a))return a<this?1:this<a?-1:0;throw new TypeError(a)},Date.prototype.equals=function(a){return 0===this.compareTo(a)},Date.prototype.between=function(c,a){var b=this.getTime();return b>=c.getTime()&&b<=a.getTime()},Date.prototype.addMilliseconds=function(a){return this.setMilliseconds(this.getMilliseconds()+a),this},Date.prototype.addSeconds=function(a){return this.addMilliseconds(1e3*a)},Date.prototype.addMinutes=function(a){return this.addMilliseconds(6e4*a)},Date.prototype.addHours=function(a){return this.addMilliseconds(36e5*a)},Date.prototype.addDays=function(a){return this.addMilliseconds(864e5*a)},Date.prototype.addWeeks=function(a){return this.addMilliseconds(6048e5*a)},Date.prototype.addMonths=function(a){var b=this.getDate();return this.setDate(1),this.setMonth(this.getMonth()+a),this.setDate(Math.min(b,this.getDaysInMonth())),this},Date.prototype.addYears=function(a){return this.addMonths(12*a)},Date.prototype.add=function(b){if("number"==typeof b)return this._orient=b,this;var a=b;return(a.millisecond||a.milliseconds)&&this.addMilliseconds(a.millisecond||a.milliseconds),(a.second||a.seconds)&&this.addSeconds(a.second||a.seconds),(a.minute||a.minutes)&&this.addMinutes(a.minute||a.minutes),(a.hour||a.hours)&&this.addHours(a.hour||a.hours),(a.month||a.months)&&this.addMonths(a.month||a.months),(a.year||a.years)&&this.addYears(a.year||a.years),(a.day||a.days)&&this.addDays(a.day||a.days),this},Date._validate=function(d,c,a,b){if("number"!=typeof d)throw new TypeError(d+" is not a Number.");if(d<c||a<d)throw new RangeError(d+" is not a valid value for "+b+".");return!0},Date.validateMillisecond=function(a){return Date._validate(a,0,999,"milliseconds")},Date.validateSecond=function(a){return Date._validate(a,0,59,"seconds")},Date.validateMinute=function(a){return Date._validate(a,0,59,"minutes")},Date.validateHour=function(a){return Date._validate(a,0,23,"hours")},Date.validateDay=function(c,a,b){return Date._validate(c,1,Date.getDaysInMonth(a,b),"days")},Date.validateMonth=function(a){return Date._validate(a,0,11,"months")},Date.validateYear=function(a){return Date._validate(a,1,9999,"seconds")},Date.prototype.set=function(b){var a=b;return a.millisecond||0===a.millisecond||(a.millisecond=-1),a.second||0===a.second||(a.second=-1),a.minute||0===a.minute||(a.minute=-1),a.hour||0===a.hour||(a.hour=-1),a.day||0===a.day||(a.day=-1),a.month||0===a.month||(a.month=-1),a.year||0===a.year||(a.year=-1),-1!=a.millisecond&&Date.validateMillisecond(a.millisecond)&&this.addMilliseconds(a.millisecond-this.getMilliseconds()),-1!=a.second&&Date.validateSecond(a.second)&&this.addSeconds(a.second-this.getSeconds()),-1!=a.minute&&Date.validateMinute(a.minute)&&this.addMinutes(a.minute-this.getMinutes()),-1!=a.hour&&Date.validateHour(a.hour)&&this.addHours(a.hour-this.getHours()),-1!==a.month&&Date.validateMonth(a.month)&&this.addMonths(a.month-this.getMonth()),-1!=a.year&&Date.validateYear(a.year)&&this.addYears(a.year-this.getFullYear()),-1!=a.day&&Date.validateDay(a.day,this.getFullYear(),this.getMonth())&&this.addDays(a.day-this.getDate()),a.timezone&&this.setTimezone(a.timezone),a.timezoneOffset&&this.setTimezoneOffset(a.timezoneOffset),this},Date.prototype.clearTime=function(){return this.setHours(0),this.setMinutes(0),this.setSeconds(0),this.setMilliseconds(0),this},Date.prototype.isLeapYear=function(){var a=this.getFullYear();return a%4==0&&a%100!=0||a%400==0},Date.prototype.isWeekday=function(){return!(this.is().sat()||this.is().sun())},Date.prototype.getDaysInMonth=function(){return Date.getDaysInMonth(this.getFullYear(),this.getMonth())},Date.prototype.moveToFirstDayOfMonth=function(){return this.set({day:1})},Date.prototype.moveToLastDayOfMonth=function(){return this.set({day:this.getDaysInMonth()})},Date.prototype.moveToDayOfWeek=function(a,b){var c=(a-this.getDay()+7*(b||1))%7;return this.addDays(0===c?c+=7*(b||1):c)},Date.prototype.moveToMonth=function(c,a){var b=(c-this.getMonth()+12*(a||1))%12;return this.addMonths(0===b?b+=12*(a||1):b)},Date.prototype.getDayOfYear=function(){return Math.floor((this-new Date(this.getFullYear(),0,1))/864e5)},Date.prototype.getWeekOfYear=function(a){var i=this.getFullYear(),c=this.getMonth(),f=this.getDate(),k=a||Date.CultureInfo.firstDayOfWeek,e=8-new Date(i,0,1).getDay();8==e&&(e=1);var b=(Date.UTC(i,c,f,0,0,0)-Date.UTC(i,0,1,0,0,0))/864e5+1,j=Math.floor((b-e+7)/7);if(j===k){i--;var g=8-new Date(i,0,1).getDay();j=2==g||8==g?53:52}return j},Date.prototype.isDST=function(){return console.log("isDST"),"D"==this.toString().match(/(E|C|M|P)(S|D)T/)[2]},Date.prototype.getTimezone=function(){return Date.getTimezoneAbbreviation(this.getUTCOffset,this.isDST())},Date.prototype.setTimezoneOffset=function(b){var a=this.getTimezoneOffset(),c=-6*Number(b)/10;return this.addMinutes(c-a),this},Date.prototype.setTimezone=function(a){return this.setTimezoneOffset(Date.getTimezoneOffset(a))},Date.prototype.getUTCOffset=function(){var a,b=-10*this.getTimezoneOffset()/6;return b<0?(a=(b-1e4).toString())[0]+a.substr(2):"+"+(a=(b+1e4).toString()).substr(1)},Date.prototype.getDayName=function(a){return a?Date.CultureInfo.abbreviatedDayNames[this.getDay()]:Date.CultureInfo.dayNames[this.getDay()]},Date.prototype.getMonthName=function(a){return a?Date.CultureInfo.abbreviatedMonthNames[this.getMonth()]:Date.CultureInfo.monthNames[this.getMonth()]},null==Date.prototype._toString&&(Date.prototype._toString=Date.prototype.toString),Date.prototype.toString=function(c){var a=this.toUTC(),b=function(d){return 1==d.toString().length?"0"+d:d};return c?c.replace(/dd?d?d?|MM?M?M?|yy?y?y?|hh?|HH?|mm?|ss?|tt?|zz?z?/g,function(d){switch(d){case"hh":return b(a.getHours()<13?a.getHours():a.getHours()-12);case"h":return a.getHours()<13?a.getHours():a.getHours()-12;case"HH":return b(a.getHours());case"H":return a.getHours();case"mm":return b(a.getMinutes());case"m":return a.getMinutes();case"ss":return b(a.getSeconds());case"s":return a.getSeconds();case"yyyy":return a.getFullYear();case"yy":return a.getFullYear().toString().substring(2,4);case"dddd":return a.getDayName();case"ddd":return a.getDayName(!0);case"dd":return b(a.getDate());case"d":return a.getDate().toString();case"MMMM":return a.getMonthName();case"MMM":return a.getMonthName(!0);case"MM":return b(a.getMonth()+1);case"M":return a.getMonth()+1;case"t":return a.getHours()<12?Date.CultureInfo.amDesignator.substring(0,1):Date.CultureInfo.pmDesignator.substring(0,1);case"tt":return a.getHours()<12?Date.CultureInfo.amDesignator:Date.CultureInfo.pmDesignator;case"zzz":case"zz":case"z":return"Z"}}):this._toString()},TimeSpan=function(f,a,d,e,c){if(this.days=0,this.hours=0,this.minutes=0,this.seconds=0,this.milliseconds=0,5!=arguments.length){if(1!=arguments.length||"number"!=typeof f)return null;var b=f<0?-1:1;return this.milliseconds=Math.abs(f),this.days=Math.floor(this.milliseconds/864e5)*b,this.milliseconds=this.milliseconds%864e5,this.hours=Math.floor(this.milliseconds/36e5)*b,this.milliseconds=this.milliseconds%36e5,this.minutes=Math.floor(this.milliseconds/6e4)*b,this.milliseconds=this.milliseconds%6e4,this.seconds=Math.floor(this.milliseconds/1e3)*b,this.milliseconds=this.milliseconds%1e3,this.milliseconds=this.milliseconds*b,this}this.days=f,this.hours=a,this.minutes=d,this.seconds=e,this.milliseconds=c},TimeSpan.prototype.compare=function(c){var a,b=new Date(1970,1,1,this.hours(),this.minutes(),this.seconds());return(a=null===c?new Date(1970,1,1,0,0,0):new Date(1970,1,1,c.hours(),c.minutes(),c.seconds()))<b?1:b<a?-1:0},TimeSpan.prototype.add=function(a){return null===a?this:this.addSeconds(a.getTotalMilliseconds()/1e3)},TimeSpan.prototype.subtract=function(a){return null===a?this:this.addSeconds(-a.getTotalMilliseconds()/1e3)},TimeSpan.prototype.addDays=function(a){return new TimeSpan(this.getTotalMilliseconds()+24*a*60*60*1e3)},TimeSpan.prototype.addHours=function(a){return new TimeSpan(this.getTotalMilliseconds()+60*a*60*1e3)},TimeSpan.prototype.addMinutes=function(a){return new TimeSpan(this.getTotalMilliseconds()+60*a*1e3)},TimeSpan.prototype.addSeconds=function(a){return new TimeSpan(this.getTotalMilliseconds()+1e3*a)},TimeSpan.prototype.addMilliseconds=function(a){return new TimeSpan(this.getTotalMilliseconds()+a)},TimeSpan.prototype.getTotalMilliseconds=function(){return 864e5*this.days()+36e5*this.hours()+6e4*this.minutes()+1e3*this.seconds()},TimeSpan.prototype.get12HourHour=function(){return(h=this.hours()%12)?h:12},TimeSpan.prototype.getDesignator=function(){return this.hours()<12?Date.CultureInfo.amDesignator:Date.CultureInfo.pmDesignator},TimeSpan.prototype.toString=function(c){function b(e){return e.toString().length<2?"0"+e:e}var a=this;return c?c.replace(/d|dd|HH|H|hh|h|mm|m|ss|s|tt|t/g,function(e){switch(e){case"d":return a.days();case"dd":return b(a.days());case"H":return a.hours();case"HH":return b(a.hours());case"h":return a.get12HourHour();case"hh":return b(a.get12HourHour());case"m":return a.minutes();case"mm":return b(a.minutes());case"s":return a.seconds();case"ss":return b(a.seconds());case"t":return(this.hours()<12?Date.CultureInfo.amDesignator:Date.CultureInfo.pmDesignator).substring(0,1);case"tt":return this.hours()<12?Date.CultureInfo.amDesignator:Date.CultureInfo.pmDesignator}}):this._toString()};var TimePeriod=function(e,a,m,g,c,j,b){if(this.years=0,this.months=0,this.days=0,this.hours=0,this.minutes=0,this.seconds=0,this.milliseconds=0,2==arguments.length&&e instanceof Date&&a instanceof Date){var n=e.clone(),l=a.clone(),k=n.clone(),d=l<n?-1:1;if(this.years=l.getFullYear()-n.getFullYear(),k.addYears(this.years),1==d?l<k&&0!==this.years&&this.years--:k<l&&0!==this.years&&this.years++,n.addYears(this.years),1==d)for(;n<l&&n.clone().addDays(n.getDaysInMonth())<l;)n.addMonths(1),this.months++;else for(;l<n&&n.clone().addDays(-n.getDaysInMonth())>l;)n.addMonths(-1),this.months--;var i=l-n;if(0!==i){var f=new TimeSpan(i);this.days=f.days,this.hours=f.hours,this.minutes=f.minutes,this.seconds=f.seconds,this.milliseconds=f.milliseconds}return this}};Date.now=function(){return new Date},Date.today=function(){return Date.now().clearTime()},Date.prototype._orient=1,Date.prototype.next=function(){return this._orient=1,this},Date.prototype.last=Date.prototype.prev=Date.prototype.previous=function(){return this._orient=-1,this},Date.prototype._is=!1,Date.prototype.is=function(){return this._is=!0,this},Number.prototype._dateElement="day",Number.prototype.fromNow=function(){var a={};return a[this._dateElement]=this,Date.now().add(a)},Number.prototype.ago=function(){var a={};return a[this._dateElement]=-1*this,Date.now().add(a)},function(){for(var n,g=Date.prototype,a=Number.prototype,q="sunday monday tuesday wednesday thursday friday saturday".split(/\s/),p="january february march april may june july august september october november december".split(/\s/),o="Millisecond Second Minute Hour Day Week Month Year".split(/\s/),m=function(i){return function(){return this._is?(this._is=!1,this.getDay()==i):this.moveToDayOfWeek(i,this._orient)}},f=0;f<q.length;f++)g[q[f]]=g[q[f].substring(0,3)]=m(f);for(var l=function(i){return function(){return this._is?(this._is=!1,this.getMonth()===i):this.moveToMonth(i,this._orient)}},d=0;d<p.length;d++)g[p[d]]=g[p[d].substring(0,3)]=l(d);for(var e=function(i){return function(){return"s"!=i.substring(i.length-1)&&(i+="s"),this["add"+i](this._orient)}},b=function(i){return function(){return this._dateElement=i,this}},c=0;c<o.length;c++)g[n=o[c].toLowerCase()]=g[n+"s"]=e(o[c]),a[n]=a[n+"s"]=b(n)}(),Date.prototype.toJSONString=function(){return this.toString("yyyy-MM-ddThh:mm:ssZ")},Date.prototype.toShortDateString=function(){return this.toString(Date.CultureInfo.formatPatterns.shortDatePattern)},Date.prototype.toLongDateString=function(){return this.toString(Date.CultureInfo.formatPatterns.longDatePattern)},Date.prototype.toShortTimeString=function(){return this.toString(Date.CultureInfo.formatPatterns.shortTimePattern)},Date.prototype.toLongTimeString=function(){return this.toString(Date.CultureInfo.formatPatterns.longTimePattern)},Date.prototype.getOrdinal=function(){switch(this.getDate()){case 1:case 21:case 31:return"st";case 2:case 22:return"nd";case 3:case 23:return"rd";default:return"th"}},Date.ISO8601Format="yyyy-MM-ddTHH:mm:ssZ",Date.prototype.toISO8601=function(){var a=this.toString(Date.ISO8601Format);return-1<a.indexOf("NaN")&&(a=""),a},Date.prototype.toUTC=function(){return new Date(this.getUTCFullYear(),this.getUTCMonth(),this.getUTCDate(),this.getUTCHours(),this.getUTCMinutes(),0,0)},Date.prototype.setAsUTC=function(){var b=this.getDate(),e=this.getMonth(),d=this.getFullYear(),a=this.getHours(),c=this.getMinutes();this.setUTCDate(b),this.setUTCMonth(e),this.setUTCFullYear(d),this.setUTCHours(a),this.setUTCMinutes(c)},Date.prototype.toFormattedString=function(e){var b=e.format_mask,d=e.convert_to_UTC?this.toUTC():this;return new SimpleDateFormat(b).format(d)},Date.parseISO_8601=function(a){var b=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(\.\d+)?(([+-](\d{2})([:]?(\d{2}))?)|Z)$/.exec(a);if(b)return"Z"==b[8]?new Date(Date.UTC(parseInt(b[1],10),parseInt(b[2],10)-1,parseInt(b[3],10),parseInt(b[4],10),parseInt(b[5],10),parseInt(b[6],10))):new Date(parseInt(b[1],10),parseInt(b[2],10)-1,parseInt(b[3],10),parseInt(b[4],10),parseInt(b[5],10),parseInt(b[6],10))},void 0===Prototype&&alert("CalendarDateSelect Error: Prototype could not be found. Please make sure that your application's layout includes prototype.js *before* it includes calendar_date_select.js"),Prototype.Version<"1.6"&&alert("Prototype > 1.6.0 is required."),DateUtils=Class.create({weekdays:[],months:$A(Date.CultureInfo.monthNames),firstDayOfWeek:Date.CultureInfo.firstDayOfWeek,msecondsInOneDay:864e5,initialize:function(){var c=$A(Date.CultureInfo.firstLetterDayNames);this.weekdays=[];for(var b=(this.firstDayOfWeek+6)%7,a=b;0<=a&&a<c.length;++a)this.weekdays.push(c[a]);for(a=0;a<c.length&&a<b;++a)this.weekdays.push(c[a])},daysDistance:function(b,a){return Math.round((a-b)/this.msecondsInOneDay)},getAMPMHour:function(b){var a=b.getHours();return 0==a?12:12<a?a-12:a},getAMPM:function(){return this.getHours()<12?"AM":"PM"}}),SelectBox=Class.create({initialize:function(d,c,b,a){this.element=new Element("select",{class:b||""}),this.populate(c),Element.insert(d,this.element),this.element.observe("change",a)},populate:function(b){var a=this.element;a.update(""),$A(b).each(function(c){"object"!=typeof c&&(c=[c,c]),a.insert(new Element("option",{value:c[1]}).update(c[0]))})},setValue:function(b){var c=this.element,a=!1;return $R(0,c.options.length-1).each(function(d){c.options[d].value==b.toString()&&(c.selectedIndex=d,a=!0)}),a},getValue:function(){return $F(this.element)}}),CalendarDateSelect=Class.create({options:{hour_format_12:!1,default_format_mask:"dd/MM/yyyy",format_mask:null,convert_to_UTC:!1,embedded:!1,popup:null,time:!1,buttons:!0,clear_button:!0,year_range:10,close_on_click:null,minute_interval:5,month_year:"dropdowns",valid_date_check:null},initialize:function(c,b){if(this.target_element=$(c),!this.target_element)return alert("Target element "+c+" not found!"),!1;"INPUT"!=this.target_element.tagName&&(this.target_element=this.target_element.down("INPUT")),(this.target_element.calendar_date_select=this).last_click_at=0,this.options=Object.extend(Object.clone(this.options),b||{}),this.options.popup_by=this.target_element,this.options.onchange=this.options.onchange||this.target_element.onchange;var a=this.target_element.title||this.options.format_mask||this.options.default_format_mask;!this.options.time||a.toLowerCase().include("h")||a.include("m")||a.include("a")?this.options.format_mask=a:this.options.hour_format_12?this.options.format_mask=a+" hh:mm tt":this.options.format_mask=a+" HH:mm",this.dateUtils=new DateUtils,this.use_time=this.options.time,this.parseDate(),this.callback("before_show"),this.initCalendarDiv(),this.options.embedded||(this.positionCalendarDiv(),Event.observe(document,"mousedown",this.closeIfClickedOut_handler=this.closeIfClickedOut.bindAsEventListener(this)),Event.observe(document,"keypress",this.keyPress_handler=this.keyPress.bindAsEventListener(this))),this.callback("after_show")},newElement:function(d,b){b=b||{};var c=new Element(d,b.attrs||{}).update(b.content||"");if(b.style&&c.setStyle(b.style),b.parent&&Element.insert(b.parent,c),b.events)for(var a in b.events)Event.observe(c,a,b.events[a]);if(b.customData)for(var e in b.customData)c[e]=b.customData[e];return c},positionCalendarDiv:function(){var n=!1,j=this.calendar_div.cumulativeOffset(),c=(j[0],j[1],this.calendar_div.getDimensions()),o=c.height,b=c.width,m=document.viewport.getScrollOffsets().top,d=document.viewport.getHeight(),p=$(this.options.popup_by).cumulativeOffset(),f=p[1],q=p[0],g=$(this.options.popup_by).getDimensions().height,k=f+g;m+d<k+o&&m<k-o&&(n=!0);var a=q.toString()+"px",e=(n?f-o:f+g).toString()+"px";this.calendar_div.style.left=a,this.calendar_div.style.top=e,this.calendar_div.setStyle({visibility:""}),"Microsoft Internet Explorer"==navigator.appName&&(this.iframe=this.newElement("iframe",{parent:$(document.body),attrs:{src:"javascript:false",class:"ie6_blocker"},style:{left:a,top:e,height:o.toString()+"px",width:b.toString()+"px",border:"0px"}}))},initCalendarDiv:function(){if(this.options.embedded)var parent=this.target_element.parentNode,style={};else var parent=document.body,style={position:"absolute",visibility:"hidden",left:0,top:0};this.calendar_div=this.newElement("div",{parent:$(parent),attrs:{class:"calendar_date_select"},style:style});var context=this;$w("top header body buttons footer bottom").each(function(name){eval("context."+name+"_div = context.newElement('div', {parent : context.calendar_div, attrs : { 'class': 'cds_part cds_"+name+"' } }); ")}),this.initHeaderDiv(),this.initButtonsDiv(),this.initCalendarGrid(),this.updateFooter("&#160;"),this.refresh(),this.setUseTime(this.use_time)},initHeaderDiv:function(){this.close_button=this.newElement("a",{attrs:{href:"#",class:"close"},content:"x",parent:this.header_div,events:{click:function(b){b.stop(),this.close()}.bindAsEventListener(this)}}),this.next_month_button=this.newElement("a",{attrs:{href:"#",class:"next"},content:"&raquo;",parent:this.header_div,events:{click:function(b){b.stop(),this.navMonth(b,this.date.getMonth()+1)}.bindAsEventListener(this)}}),this.prev_month_button=this.newElement("a",{attrs:{href:"#",class:"prev"},content:"&laquo;",parent:this.header_div,events:{click:function(b){b.stop(),this.navMonth(b,this.date.getMonth()-1)}.bindAsEventListener(this)}});var a=this.dateUtils;"dropdowns"==this.options.month_year?(this.month_select=new SelectBox(this.header_div,$R(0,11).map(function(b){return[a.months[b],b]}),"month",this.navMonth.bindAsEventListener(this)),this.year_select=new SelectBox(this.header_div,[],"year",this.navYear.bindAsEventListener(this)),this.populateYearRange()):this.month_year_label=this.newElement("span",{parent:this.header_div})},initCalendarGrid:function(){var a=this.body_div;this.calendar_day_grid=[];var i=this.newElement("table",{parent:a}),b=this.newElement("tr",{parent:this.newElement("thead",{parent:i})});this.dateUtils.weekdays.each(function(j){Element.insert(b,new Element("th").update(function(k){var j=k.charCodeAt(0);return 64<=j&&j<=7929}(j)?j.substring(0,2):j))});for(var e,f=this.newElement("tbody",{parent:i}),c=0,g=0;g<42;g++)(e=g%7)==0&&(days_row=this.newElement("tr",{parent:f,attrs:{class:"row_"+c++}})),this.calendar_day_grid[g]=this.newElement("td",{content:new Element("div"),parent:days_row,attrs:{class:e==(7-this.dateUtils.firstDayOfWeek)%7||e==(13-this.dateUtils.firstDayOfWeek)%7?"weekend":""},events:{mouseover:function(){this.calendar_date_select.dayHover(this)},mouseout:function(){this.calendar_date_select.dayHoverOut(this)},click:function(){this.calendar_date_select.updateSelectedDate(this,!0)}},customData:{calendar_date_select:this}})},initButtonsDiv:function(){var i=function(k){var j=parseInt(k,10);return k<10&&(j="0"+j),j},g=this.buttons_div,e=this.newElement("div",{parent:g,attrs:{class:"timediv"}});if(this.options.time){var d=$A("mixed"==this.options.time?[[" - ",""]]:[]);if(e.update(new Element("span",{class:"at_sign"}).update("@")),this.options.hour_format_12){var c=new Date;d=d.concat($R(0,23).map(function(j){return c.setHours(j),$A([this.dateUtils.getAMPMHour(c)+" "+this.dateUtils.getAMPM(c),j])}))}else d=d.concat($R(0,23).map(function(j){return $A([i(j),j])}));this.hour_select=new SelectBox(e,d,"hour",this.calendar_date_select.updateSelectedDate.bind(this,{hour:this.value})),this.hour_select.calendar_date_select=this,e.insert(new Element("span",{class:"separator"}).update(":"));var b=this;d=$A([]),this.minute_select=new SelectBox(e,d.concat($R(0,59).select(function(j){return j%b.options.minute_interval==0}).map(function(j){return $A([i(j),j])})),"minute",this.calendar_date_select.updateSelectedDate.bind(this,{minute:this.value})),this.minute_select.calendar_date_select=this}else this.options.buttons||g.remove();if(this.options.buttons){var a=function(k,l,j){this.newElement("a",{parent:k,content:_translations[l],attrs:{href:"#"},events:{click:j}})}.bind(this),f=function(j){this.newElement("span",{parent:j,content:"&#160;|&#160;",attrs:{class:"button_separator"}})}.bind(this);this.newElement("span",{parent:g,content:"&#160;"}),"mixed"!=this.options.time&&this.options.time||a(g,"Today",function(j){return this.today(!1),j.stop(),!1}.bindAsEventListener(this)),"mixed"==this.options.time&&f(g),this.options.time&&a(g,"Now",function(j){return this.today(!0),j.stop(),!1}.bindAsEventListener(this)),this.options.embedded||this.closeOnClick()||(f(g),a(g,"OK",function(j){return this.close(),j.stop(),!1}.bindAsEventListener(this))),this.options.clear_button&&(f(g),a(g,"Clear",function(j){return this.clearDate(),this.options.embedded||this.close(),j.stop(),!1}.bindAsEventListener(this)))}},refresh:function(){this.refreshMonthYear(),this.refreshCalendarGrid(),this.setSelectedClass(),this.updateFooter()},refreshCalendarGrid:function(){this.beginning_date=new Date(this.date).clearTime(),this.beginning_date.setDate(1),this.beginning_date.setHours(12);var b=this.beginning_date.getDay();b<3&&(b+=7),this.beginning_date.setDate(1-b+this.dateUtils.firstDayOfWeek);var d=new Date(this.beginning_date),a=(new Date).clearTime(),c=this.date.getMonth();vdc=this.options.valid_date_check;for(var e=0;e<42;e++)day=d.getDate(),month=d.getMonth(),cell=this.calendar_day_grid[e],cell.update(new Element("div",{class:month!=c?"other":""}).update(day)),cell.day=day,cell.month=month,cell.year=d.getFullYear(),vdc&&(vdc(d.clearTime())?cell.removeClassName("disabled"):cell.addClassName("disabled")),d.setDate(day+1);this.today_cell&&this.today_cell.removeClassName("today"),$R(0,41).include(days_until=this.dateUtils.daysDistance(this.beginning_date.clearTime(),a))&&(this.today_cell=this.calendar_day_grid[days_until],this.today_cell.addClassName("today"))},refreshMonthYear:function(){var a=this.date.getMonth(),c=this.date.getFullYear();if("dropdowns"==this.options.month_year){this.month_select.setValue(a,!1);var b=this.year_select.element;this.flexibleYearRange()&&(!this.year_select.setValue(c,!1)||b.selectedIndex<=1||b.selectedIndex>=b.options.length-2)&&this.populateYearRange(),this.year_select.setValue(c)}else this.month_year_label.update(this.dateUtils.months[a]+" "+c.toString())},populateYearRange:function(){this.year_select.populate(this.yearRange().toArray())},yearRange:function(){if(!this.flexibleYearRange())return $R(this.options.year_range[0],this.options.year_range[1]);var a=this.date.getFullYear();return $R(a-this.options.year_range,a+this.options.year_range)},flexibleYearRange:function(){return"number"==typeof this.options.year_range},validYear:function(a){return!!this.flexibleYearRange()||this.yearRange().include(a)},dayHover:function(a){var b=new Date(this.selected_date);b.setFullYear(a.year,a.month,a.day),this.updateFooter(b.toFormattedString(this.options))},dayHoverOut:function(a){this.updateFooter()},clearSelectedClass:function(){this.selected_cell&&this.selected_cell.removeClassName("selected")},setSelectedClass:function(){this.selection_made&&(this.clearSelectedClass(),$R(0,42).include(days_until=this.dateUtils.daysDistance(this.beginning_date.clearTime(),this.selected_date.clearTime()))&&(this.selected_cell=this.calendar_day_grid[days_until],this.selected_cell.addClassName("selected")))},reparse:function(){this.parseDate(),this.refresh()},dateString:function(){return this.selection_made?this.selected_date.toFormattedString(this.options):"&#160;"},parseDate:function(){var b=this.target_element.readAttribute("alt").strip(),a=this.options.default_time;this.selection_made=""!=b||a,this.date=""==b?NaN:Date.parseISO_8601(b),isNaN(this.date)&&!a?this.date=new Date:isNaN(this.date)&&a&&(this.date="[object Function]"===Object.prototype.toString.apply(a)?a():a),this.validYear(this.date.getFullYear())||this.date.setYear(this.date.getFullYear()<this.yearRange().start?this.yearRange().start:this.yearRange().end),this.selected_date=new Date(this.date),this.use_time=!!/[0-9]:[0-9]{2}/.exec(b),this.date.setDate(1)},updateFooter:function(a){this.footer_div.update(new Element("span").update(a||this.dateString()))},clearDate:function(){if((this.target_element.disabled||this.target_element.readOnly)&&"force"!=this.options.popup)return!1;var a=this.target_element.value;this.target_element.value="",this.target_element.writeAttribute("alt",""),this.clearSelectedClass(),this.updateFooter("&#160;"),a!=this.target_element.value&&this.callback("onchange")},updateSelectedDate:function(b,a){var e=$H(b);if((this.target_element.disabled||this.target_element.readOnly)&&"force"!=this.options.popup)return!1;if(e.get("day")){var d=this.selected_date,c=this.options.valid_date_check;if(d.setFullYear(e.get("year"),e.get("month"),e.get("day")),c&&!c(d.clearTime()))return!1;this.selected_date=d,this.selection_made=!0}isNaN(e.get("hour"))||this.selected_date.setHours(e.get("hour")),isNaN(e.get("minute"))||this.selected_date.setMinutes(this.alignMinutesToInterval(e.get("minute"))),""===e.get("hour")||""===e.get("minute")?this.setUseTime(!1):isNaN(e.get("hour"))&&isNaN(e.get("minute"))||this.setUseTime(!0),this.updateFooter(),this.setSelectedClass(),this.selection_made&&this.updateValue(),a&&this.closeOnClick()&&this.close(),a&&!this.options.embedded&&(new Date-this.last_click_at<333&&this.close(),this.last_click_at=new Date)},closeOnClick:function(){return!this.options.embedded&&(null===this.options.close_on_click?!this.options.time:this.options.close_on_click)},navMonth:function(a,b){return(target_date=new Date(this.date)).setMonth("number"==typeof b?b:this.month_select.getValue()),this.navTo(target_date)},navYear:function(b,a){return(target_date=new Date(this.date)).setYear("number"==typeof a?a:this.year_select.getValue()),this.navTo(target_date)},navTo:function(a){return!!this.validYear(a.getFullYear())&&(this.date=a,this.date.setDate(1),this.refresh(),this.callback("after_navigate",this.date),!0)},alignMinutesToInterval:function(b){var a=this.options.minute_interval;return Math.floor(b/a)*a},setUseTime:function(b){if(this.use_time=this.options.time&&("mixed"!=this.options.time||b),this.use_time&&this.selected_date){var c=this.alignMinutesToInterval(this.selected_date.getMinutes()),a=this.selected_date.getHours();this.hour_select.setValue(a),this.minute_select.setValue(c)}else"mixed"==this.options.time&&(this.hour_select.setValue(""),this.minute_select.setValue(""))},updateValue:function(){var a=this.target_element.value;this.target_element.value=this.dateString(),this.target_element.writeAttribute("alt",this.selected_date.toISO8601()),a!=this.target_element.value&&this.callback("onchange")},today:function(a){var c=new Date;this.date=new Date;var b=$H({day:c.getDate(),month:c.getMonth(),year:c.getFullYear(),hour:c.getHours(),minute:c.getMinutes()});a||(b=b.merge({hour:"",minute:""})),this.updateSelectedDate(b,!0),this.refresh()},close:function(){if(this.closed)return!1;this.callback("before_close"),this.target_element.calendar_date_select=null,Event.stopObserving(document,"mousedown",this.closeIfClickedOut_handler),Event.stopObserving(document,"keypress",this.keyPress_handler),this.calendar_div.remove(),this.closed=!0,this.iframe&&this.iframe.remove(),"hidden"==this.target_element.type||this.target_element.disabled||this.target_element.focus(),this.callback("after_close")},closeIfClickedOut:function(a){$(Event.element(a)).descendantOf&&$(Event.element(a)).descendantOf(this.calendar_div)||this.close()},keyPress:function(a){a.keyCode==Event.KEY_ESC&&this.close()},callback:function(a,b){this.options[a]&&this.options[a].bind(this.target_element)(b)}});var XWiki=function(b){return(b.widgets=b.widgets||{}).DateTimePicker=Class.create({selector:"input.xwiki-date:not(.initialized)",options:{year_range:10,time:!1,convert_to_UTC:!1,hour_format_12:!1,minute_interval:1,popup:"force"},initialize:function(c){this.options=Object.extend(Object.clone(this.options),c||{}),this.attachPickers(),document.observe("xwiki:dom:updated",function(d){this.attachPickers(d.memo.elements&&d.memo.elements[0])}.bindAsEventListener(this))},attachPickers:function(c){var d=c&&c.select(this.selector)||$$(this.selector);d.invoke("observe","click",this.onClick.bindAsEventListener(this)),d.each(function(e){e.readOnly=!0,e.addClassName("initialized")})},onClick:function(c){this.showCalendar(c.element())},showCalendar:function(d){var c=Object.clone(this.options);c.time=c.time||d.hasClassName("withTime"),c.convert_to_UTC=c.convert_to_UTC||d.hasClassName("withUTC"),c.onchange=function(){Event.fire(d,"xwiki:date:changed"),Event.fire(d,"xwiki:form:field-value-changed")},d._selector=new CalendarDateSelect(d,c)}}),b}(XWiki||{}),SimpleDateFormat;document.observe("xwiki:dom:loaded",function(){var a=(new Date).getFullYear();window.dateTimePicker=new XWiki.widgets.DateTimePicker({year_range:[a-99,a+1]})}),function(){function g(q){return void 0===q}var p=/('[^']*')|(G+|y+|M+|w+|W+|D+|d+|F+|E+|a+|H+|k+|K+|h+|m+|s+|S+|Z+)|([a-zA-Z]+)|([^a-zA-Z']+)/,k=Date.CultureInfo.monthNames,c=Date.CultureInfo.dayNames,l={G:0,y:3,M:4,w:2,W:2,D:2,d:2,F:2,E:1,a:0,H:2,k:2,K:2,h:2,m:2,s:2,S:2,Z:5},d=864e5,a=7*d,o=function(r,s,q){var t=new Date(r,s,q,0,0,0);return t.setMilliseconds(0),t};Date.prototype.getDifference=function(q){return this.getTime()-q.getTime()},Date.prototype.isBefore=function(q){return this.getTime()<q.getTime()},Date.prototype.getUTCTime=function(){return Date.UTC(this.getFullYear(),this.getMonth(),this.getDate(),this.getHours(),this.getMinutes(),this.getSeconds(),this.getMilliseconds())},Date.prototype.getTimeSince=function(q){return this.getUTCTime()-q.getUTCTime()},Date.prototype.getPreviousSunday=function(){var r=new Date(this.getFullYear(),this.getMonth(),this.getDate(),12,0,0),q=new Date(r.getTime()-this.getDay()*d);return o(q.getFullYear(),q.getMonth(),q.getDate())},Date.prototype.getWeekInYear=function(v){g(this.minimalDaysInFirstWeek)&&(v=1);var t=this.getPreviousSunday(),r=o(this.getFullYear(),0,1),s=t.isBefore(r)?0:1+Math.floor(t.getTimeSince(r)/a);return 7-r.getDay()<v&&s--,s},Date.prototype.getWeekInMonth=function(v){g(this.minimalDaysInFirstWeek)&&(v=1);var r=this.getPreviousSunday(),u=o(this.getFullYear(),this.getMonth(),1),s=r.isBefore(u)?0:1+Math.floor(r.getTimeSince(u)/a);return v<=7-u.getDay()&&s++,s},Date.prototype.getDayInYear=function(){var q=o(this.getFullYear(),0,1);return 1+Math.floor(this.getTimeSince(q)/d)},(SimpleDateFormat=function(q){this.formatString=q}).prototype.setMinimalDaysInFirstWeek=function(q){this.minimalDaysInFirstWeek=q},SimpleDateFormat.prototype.getMinimalDaysInFirstWeek=function(q){return g(this.minimalDaysInFirstWeek)?1:this.minimalDaysInFirstWeek},SimpleDateFormat.prototype.format=function(J){if("Invalid Date"==J)return"";for(var A,q="",u=function(M,L){for(;M.length<L;)M="0"+M;return M},s=function(N,M,L){return 4<=M?N:N.substr(0,Math.max(L,M))},y=function(N,M){return u(""+N,M)},x=this.formatString;A=p.exec(x);){A[0];var z=A[1],B=A[2],w=A[3],v=A[4];if(z)q+="''"==z?"'":z.substring(1,z.length-1);else if(w);else if(v)q+=v;else if(B){var r=B.charAt(0),K=B.length,C="";switch(r){case"G":C="AD";break;case"y":C=J.getFullYear();break;case"M":C=J.getMonth();break;case"w":C=J.getWeekInYear(this.getMinimalDaysInFirstWeek());break;case"W":C=J.getWeekInMonth(this.getMinimalDaysInFirstWeek());break;case"D":C=J.getDayInYear();break;case"d":C=J.getDate();break;case"F":C=1+Math.floor((J.getDate()-1)/7);break;case"E":C=c[J.getDay()];break;case"a":C=12<=J.getHours()?"PM":"AM";break;case"H":C=J.getHours();break;case"k":C=J.getHours()||24;break;case"K":C=J.getHours()%12;break;case"h":C=J.getHours()%12||12;break;case"m":C=J.getMinutes();break;case"s":C=J.getSeconds();break;case"S":C=J.getMilliseconds();break;case"Z":C=J.getTimezoneOffset()}switch(l[r]){case 0:q+=s(C,K,2);break;case 1:q+=s(C,K,3);break;case 2:q+=y(C,K);break;case 3:if(K<=3)q+=(""+C).substr(2,2);else q+=y(C,K);break;case 4:q+=3<=K?s(k[C],K,K):y(C+1,K);break;case 5:var F=0<C?"-":"+",H=Math.abs(C),G=""+Math.floor(H/60),D=""+H%60;q+=F+(G=u(G,2))+(D=u(D,2))}}x=x.substr(A.index+A[0].length)}return q}}();var PedigreeFuzzyDatePickerDropdown=Class.create({initialize:function(options){this.span=new Element("span"),this.options=options,this.callback=null},populate:function(values){var selectedIndex=this.dropdown?this.dropdown.selectedIndex||this._tmpSelectedIndex:0,optionsHTML='<select name="'+this.options.name+'" class="'+(this.options.cssClass||this.options.name||"")+'" placeholder="'+(this.options.hint||this.options.name||"")+'" title="'+(this.options.hint||this.options.name||"")+'">';optionsHTML+='<option value="" class="empty"></option>';values.each(function(item){optionsHTML+='<option value="'+item.value+'"',item.cssClass&&(optionsHTML+=' class="'+item.cssClass+'"'),optionsHTML+=">"+(item.text||item.value||"")+"</option>"}),optionsHTML+="</select>",this.span.innerHTML=optionsHTML,this.dropdown=this.span.firstChild,this.callback&&this.onSelect(this.callback),this.dropdown.selectedIndex<=0&&0<=selectedIndex&&selectedIndex<this.dropdown.options.length&&(this.dropdown.selectedIndex=selectedIndex)},enable:function(){return!this.options.alwaysEnabled&&(this.dropdown.enable(),this.dropdown.selectedIndex<=0&&this._tmpSelectedIndex<this.dropdown.options.length)&&(this.dropdown.selectedIndex=this._tmpSelectedIndex,0<this._tmpSelectedIndex)},disable:function(){this.options.alwaysEnabled||(this.dropdown.disable(),this._tmpSelectedIndex=this.dropdown.selectedIndex,this.dropdown.selectedIndex=0)},getElement:function(){return this.span},onSelect:function(callback){var _this=this;this.callback=callback;var events=["change"];browser.isGecko&&events.push("keyup"),events.each(function(eventName){_this.dropdown.observe(eventName,function(){callback(),"YMD"==this.inputFormat&&(_this._tmpSelectedIndex=_this.dropdown.selectedIndex)})})},onFocus:function(callback){var _this=this;this.dropdown.observe("focus",function(){callback(),-1==_this.dropdown.selectedIndex&&_this._tmpSelectedIndex<_this.dropdown.options.size()&&(_this.dropdown.selectedIndex=_this._tmpSelectedIndex)})},onBlur:function(callback){this.dropdown.observe("blur",callback)},getSelectedValue:function(){return 0<=this.dropdown.selectedIndex?this.dropdown.options[this.dropdown.selectedIndex].value:""},getSelectedOption:function(){return 0<=this.dropdown.selectedIndex?this.dropdown.options[this.dropdown.selectedIndex].innerHTML:""}}),PedigreeFuzzyDatePicker=Class.create({initialize:function(input,inputFormat){if(this.inputFormat=inputFormat||"YMD",input){if(this.__input=input,this.__input.hide(),this.__name=input.name,this.container=new Element("div",{class:"fuzzy-date-picker"}),this.__input.insert({after:this.container}),"DMY"==this.inputFormat||"MY"==this.inputFormat){var hideDay="MY"==this.inputFormat;this.container.insert(this.createDayDropdown(hideDay)),this.container.insert(this.createMonthDropdown()),this.container.insert(this.createYearDropdown())}else this.container.insert(this.createYearDropdown()),this.container.insert(this.createMonthDropdown()),this.container.insert(this.createDayDropdown());this.container.observe("datepicker:date:changed",this.onProgrammaticUpdate.bind(this))}},onProgrammaticUpdate:function(){this.yearSelected(!0),this.monthSelected(!0),this.updateDate(!0)},createYearDropdown:function(){this.yearSelector=new PedigreeFuzzyDatePickerDropdown({name:"year",alwaysEnabled:"YMD"!=this.inputFormat});var crtYear=(new Date).getYear()+1900,values=[];"estimatedDateOfDelivery"==this.__input.name&&values.push({value:crtYear+1});for(var y=crtYear;1850<=y;--y)values.push({value:y}),y%10==0&&values.push({value:y+"s",cssClass:"decade",text:y+"s"});return values.push({value:"1800s",cssClass:"decade"}),values.push({value:"1700s",cssClass:"decade"}),values.push({value:"1600s",cssClass:"decade"}),this.yearSelector.populate(values),this.yearSelector.onSelect(this.yearSelected.bind(this)),this.yearSelector.getElement()},yearSelected:function(doNotNotifyOnChange){0<this.yearSelector.getSelectedValue()?("date_of_birth"!=this.__name&&"date_of_death"!=this.__name?this.monthSelector.enable():console.log("HEY WHAT"),this.monthSelected(doNotNotifyOnChange)):(this.monthSelector.disable(),this.daySelector.disable()),this.updateDate(doNotNotifyOnChange)},createMonthDropdown:function(){return this.monthSelector=new PedigreeFuzzyDatePickerDropdown({name:"month",alwaysEnabled:"YMD"!=this.inputFormat}),this.monthSelector.populate(this.getZeroPaddedValueRange(1,12)),this.monthSelector.disable(),this.monthSelector.onSelect(this.monthSelected.bind(this)),this.monthSelector.getElement()},monthSelected:function(doNotNotifyOnChange){0<this.monthSelector.getSelectedValue()?(this.daySelector.populate(this.getAvailableDays()),"date_of_birth"==this.__name&&"date_of_death"==this.__name||this.daySelector.enable()):"DMY"==this.inputFormat?this.daySelector.populate(this.getZeroPaddedValueRange(1,31)):this.daySelector.disable(),this.updateDate(doNotNotifyOnChange)},createDayDropdown:function(hide){return this.daySelector=new PedigreeFuzzyDatePickerDropdown({name:"day",alwaysEnabled:"YMD"!=this.inputFormat}),this.daySelector.populate(this.getZeroPaddedValueRange(1,31)),this.daySelector.disable(),this.daySelector.onSelect(this.updateDate.bind(this)),hide&&this.daySelector.getElement().hide(),this.daySelector.getElement()},getAvailableDays:function(){var year=1*this.yearSelector.getSelectedValue(),month=1*this.monthSelector.getSelectedValue(),lastDayOfMonth=0;return 0<=[1,3,5,7,8,10,12].indexOf(month)?lastDayOfMonth=31:0<=[4,6,9,11].indexOf(month)?lastDayOfMonth=30:2==month&&(lastDayOfMonth=year%4!=0||year%100==0&&year%400!=0?28:29),this.getZeroPaddedValueRange(1,lastDayOfMonth)},getZeroPaddedValueRange:function(start,end){var values=[];if(start<=end)for(var v=start;v<=end;++v)values.push({value:v,text:("0"+v).slice(-2)});else for(v=end;v<=start;--v)values.push({value:v,text:("0"+v).slice(-2)});return values},updateDate:function(doNotFireEventOnChange){var dateObject={},y=this.yearSelector.getSelectedValue();if(y.match(/\d\d\d\ds$/)?dateObject.decade=y:""!=y&&(dateObject.year=y),0<y||"DMY"==this.inputFormat){var m=this.monthSelector.getSelectedValue();if(0<m&&(dateObject.month=this.monthSelector.getSelectedOption()),0<m||"DMY"==this.inputFormat)0<this.daySelector.getSelectedValue()&&(dateObject.day=this.daySelector.getSelectedOption())}JSON.stringify(dateObject)!=this.__input.value&&(this.__input.value=JSON.stringify(dateObject),doNotFireEventOnChange||this.__input.fire("xwiki:date:changed"))}}),XWiki=function(XWiki){XWiki.SearchSuggest=Class.create({initialize:function(searchInput,sources){this.sources=sources,this.searchInput=$(searchInput),this.searchInput&&(document.observe("xwiki:suggest:clearSuggestions",this.onClearSuggestions.bindAsEventListener(this)),document.observe("xwiki:suggest:containerCreated",this.onSuggestContainerCreated.bindAsEventListener(this)),document.observe("xwiki:suggest:containerPrepared",this.onSuggestContainerPrepared.bindAsEventListener(this)),document.observe("xwiki:suggest:updated",this.onSuggestUpdated.bindAsEventListener(this)),document.observe("xwiki:suggest:selected",this.onSuggestionSelected.bindAsEventListener(this)),this.createSuggest())},onClearSuggestions:function(event){event.memo.suggest==this.suggest&&this.searchInput.setStyle({borderBottomStyle:this.searchInputBorderBottomSavedStyle})},onSuggestContainerCreated:function(event){event.memo.suggest==this.suggest&&(this.searchInputBorderBottomSavedStyle=this.searchInput.getStyle("borderBottomStyle"),this.searchInput.setStyle({borderBottomStyle:"none"}))},onSuggestContainerPrepared:function(event){this.noResultsMessage.addClassName("hidden")},onSuggestUpdated:function(event){1==event.memo.container.select(".suggestItem").length&&this.noResultsMessage.removeClassName("hidden").setStyle({float:"left"})},onSuggestionSelected:function(event){event.memo.suggest==this.suggest&&(event.stop(),event.memo.originalEvent&&Event.stop(event.memo.originalEvent),event.memo.id?window.location=event.memo.id:this.searchInput.up("form").submit())},createSuggest:function(){var valueNode=new Element("div").insert(new Element("span",{class:"suggestId"})).insert(new Element("span",{class:"suggestValue"})).insert(new Element("span",{class:"suggestInfo"}));this.noResultsMessage=new Element("div",{class:"hidden"}).update("No results!".escapeHTML());var gotoSearchPageMessage=new Element("div").update("Go to search page".escapeHTML()),content=new Element("div").insert(this.noResultsMessage).insert(gotoSearchPageMessage).insert(new Element("div",{class:"clearfloats"})),allResults=new XWiki.widgets.XList([new XWiki.widgets.XListItem(content,{containerClasses:"suggestItem",classes:"showAllResults",eventCallbackScope:this,noHighlight:!0,value:valueNode})],{classes:"suggestList",eventListeners:{click:function(event){this.searchInput.up("form").submit()},mouseover:function(event){this.suggest.clearHighlight(),this.suggest.iHighlighted=event.element(),event.element().addClassName("xhighlight")}}}).getElement();this.suggest=new XWiki.widgets.Suggest(this.searchInput,{parentContainer:$("searchSuggest"),className:"searchSuggest horizontalLayout",fadeOnClear:!1,align:"auto",minchars:1,sources:this.sources,insertBeforeSuggestions:new Element("div",{class:"results"}).update(allResults),displayValue:!0,displayValueText:"in ",timeout:0,width:500,unifiedLoader:!0,loaderNode:allResults.down("li"),shownoresults:!1,propagateEventKeyCodes:[Event.KEY_RETURN]})}});var init=function(){return new XWiki.SearchSuggest($("headerglobalsearchinput"),[{name:"Matching patients",varname:"input",script:"/get/PhenoTips/SuggestPatientsService?outputSyntax=plain&permission=view&query=__INPUT__&nb=5",icon:"resources/icons/silk/user.png",highlight:!1}]),!0};return XWiki.isInitialized&&init()||document.observe("xwiki:dom:loading",init),XWiki}(XWiki),XWiki=function(c){var a=function(f){if(!f)return c.currentDocument;if("string"!=typeof f)return f;var e=c.Model.resolve(f,c.EntityType.DOCUMENT),d=e.name,g=e.extractReferenceValue(c.EntityType.SPACE),h=e.extractReferenceValue(c.EntityType.WIKI);return new c.Document(d,g,h)};c.DocumentLock=Class.create({initialize:function(e){this._document=a(e);var g=this.unlock.bind(this);Event.observe(window,"unload",g),Event.observe(window,"pagehide",g),$("tmLogout")&&$("tmLogout").down("a")&&$("tmLogout").down("a").observe("click",g);var f=this.setLocked.bind(this,!1);$$("form.withLock").each(function(h){h.observe("submit",f)});var d=new c.DocumentReference(this._document.wiki,this._document.space,this._document.page);c.DocumentLock._instances[c.Model.serialize(d)]=this},lock:function(){this._locked||(this._locked=!0)},unlock:function(){this._locked&&(this._locked=!1)},setLocked:function(d){this._locked=!!d},isLocked:function(){return this._locked},_getURL:function(d){return this._document.getURL(d,"ajax=1&action="+c.contextaction+"&"+(c.docvariant||""))}}),c.DocumentLock._instances={},c.DocumentLock.get=function(e){e=a(e);var d=new c.DocumentReference(e.wiki,e.space,e.page);return c.DocumentLock._instances[c.Model.serialize(d)]};var b=function(){return c.EditLock=new c.DocumentLock,c.EditLock.lock(),!0};return c.domIsLoaded&&b()||document.observe("xwiki:dom:loaded",b),c}(XWiki||{}),LiveValidation=Class.create();Object.extend(LiveValidation,{VERSION:"1.3 prototype",TEXTAREA:1,TEXT:2,PASSWORD:3,CHECKBOX:4,SELECT:5,FILE:6,massValidate:function(c){for(var d=!0,b=0,a=c.length;b<a;++b){var e=c[b].validate();d&&(d=e)}return d}}),LiveValidation.prototype={validClass:"LV_valid",invalidClass:"LV_invalid",messageClass:"LV_validation_message",validFieldClass:"LV_valid_field",invalidFieldClass:"LV_invalid_field",initialize:function(b,a){if(!b)throw new Error("LiveValidation::initialize - No element reference or element id has been provided!");if(this.element=$(b),!this.element)throw new Error("LiveValidation::initialize - No element with reference or id of '"+b+"' exists!");this.elementType=this.getElementType(),this.validations=[],this.form=this.element.form,this.options=Object.extend({validMessage:"Thankyou!",onValid:function(){this.insertMessage(this.createMessageSpan()),this.addFieldClass()},onInvalid:function(){this.insertMessage(this.createMessageSpan()),this.addFieldClass()},insertAfterWhatNode:this.element,onlyOnBlur:!1,wait:0,onlyOnSubmit:!1},a||{});var c=this.options.insertAfterWhatNode||this.element;if(this.options.insertAfterWhatNode=$(c),Object.extend(this,this.options),this.form&&(this.formObj=LiveValidationForm.getInstance(this.form),this.formObj.addField(this)),this.boundFocus=this.doOnFocus.bindAsEventListener(this),Event.observe(this.element,"focus",this.boundFocus),!this.onlyOnSubmit)switch(this.elementType){case LiveValidation.CHECKBOX:this.boundClick=this.validate.bindAsEventListener(this),Event.observe(this.element,"click",this.boundClick);case LiveValidation.SELECT:case LiveValidation.FILE:this.boundChange=this.validate.bindAsEventListener(this),Event.observe(this.element,"change",this.boundChange);break;default:this.onlyOnBlur||(this.boundKeyup=this.deferValidation.bindAsEventListener(this),Event.observe(this.element,"keyup",this.boundKeyup)),this.boundBlur=this.validate.bindAsEventListener(this),Event.observe(this.element,"blur",this.boundBlur)}},destroy:function(){if(this.formObj&&(this.formObj.removeField(this),this.formObj.destroy()),Event.stopObserving(this.element,"focus",this.boundFocus),!this.onlyOnSubmit)switch(this.elementType){case LiveValidation.CHECKBOX:Event.stopObserving(this.element,"click",this.boundClick);case LiveValidation.SELECT:case LiveValidation.FILE:Event.stopObserving(this.element,"change",this.boundChange);break;default:this.onlyOnBlur||Event.stopObserving(this.element,"keyup",this.boundKeyup),Event.stopObserving(this.element,"blur",this.boundBlur)}this.validations=[],this.removeMessageAndFieldClass()},add:function(a,b){return this.validations.push({type:a,params:b||{}}),this},remove:function(a,b){return this.validations=this.validations.reject(function(c){return c.type==a&&c.params==b}),this},deferValidation:function(a){300<=this.wait&&this.removeMessageAndFieldClass(),this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(this.validate.bind(this),this.wait)},doOnBlur:function(){this.focused=!1,this.validate()},doOnFocus:function(){this.focused=!0,this.removeMessageAndFieldClass()},getElementType:function(){switch(!0){case"TEXTAREA"==this.element.nodeName.toUpperCase():return LiveValidation.TEXTAREA;case"INPUT"==this.element.nodeName.toUpperCase()&&"TEXT"==this.element.type.toUpperCase():return LiveValidation.TEXT;case"INPUT"==this.element.nodeName.toUpperCase()&&"PASSWORD"==this.element.type.toUpperCase():return LiveValidation.PASSWORD;case"INPUT"==this.element.nodeName.toUpperCase()&&"CHECKBOX"==this.element.type.toUpperCase():return LiveValidation.CHECKBOX;case"INPUT"==this.element.nodeName.toUpperCase()&&"FILE"==this.element.type.toUpperCase():return LiveValidation.FILE;case"SELECT"==this.element.nodeName.toUpperCase():return LiveValidation.SELECT;case"INPUT"==this.element.nodeName.toUpperCase():throw new Error("LiveValidation::getElementType - Cannot use LiveValidation on an "+this.element.type+" input!");default:throw new Error("LiveValidation::getElementType - Element must be an input, select, or textarea!")}},doValidations:function(){this.validationFailed=!1;for(var c=0,a=this.validations.length;c<a;++c){var b=this.validations[c];switch(b.type){case Validate.Presence:case Validate.Confirmation:case Validate.Acceptance:this.displayMessageWhenEmpty=!0,this.validationFailed=!this.validateElement(b.type,b.params);break;default:this.validationFailed=!this.validateElement(b.type,b.params)}if(this.validationFailed)return!1}return this.message=this.validMessage,!0},validateElement:function(a,c){var d=this.elementType==LiveValidation.SELECT?this.element.options[this.element.selectedIndex].value:this.element.value;if(a==Validate.Acceptance){if(this.elementType!=LiveValidation.CHECKBOX)throw new Error("LiveValidation::validateElement - Element to validate acceptance must be a checkbox!");d=this.element.checked}var e=!0;try{a(d,c)}catch(b){if(!(b instanceof Validate.Error))throw b;(""!==d||""===d&&this.displayMessageWhenEmpty)&&(this.validationFailed=!0,this.message=b.message,e=!1)}finally{return e}},validate:function(){return!!this.element.disabled||(this.doValidations()?(this.onValid(),!0):(this.onInvalid(),!1))},enable:function(){return this.element.disabled=!1,this},disable:function(){return this.element.disabled=!0,this.removeMessageAndFieldClass(),this},createMessageSpan:function(){var a=document.createElement("span"),b=document.createTextNode(this.message);return a.appendChild(b),a},insertMessage:function(b){this.removeMessage();var a=this.validationFailed?this.invalidClass:this.validClass;(this.displayMessageWhenEmpty&&(this.elementType==LiveValidation.CHECKBOX||""==this.element.value)||""!=this.element.value)&&($(b).addClassName(this.messageClass+" "+a),(nxtSibling=this.insertAfterWhatNode.nextSibling)?this.insertAfterWhatNode.parentNode.insertBefore(b,nxtSibling):this.insertAfterWhatNode.parentNode.appendChild(b))},addFieldClass:function(){this.removeFieldClass(),this.validationFailed?this.element.hasClassName(this.invalidFieldClass)||this.element.addClassName(this.invalidFieldClass):(this.displayMessageWhenEmpty||""!=this.element.value)&&(this.element.hasClassName(this.validFieldClass)||this.element.addClassName(this.validFieldClass))},removeMessage:function(){(nxtEl=this.insertAfterWhatNode.next("."+this.messageClass))&&nxtEl.remove()},removeFieldClass:function(){this.element.removeClassName(this.invalidFieldClass),this.element.removeClassName(this.validFieldClass)},removeMessageAndFieldClass:function(){this.removeMessage(),this.removeFieldClass()}};var LiveValidationForm=Class.create();Object.extend(LiveValidationForm,{instances:{},getInstance:function(a){var b=Math.random()*Math.random();return a.id||(a.id="formId_"+b.toString().replace(/\./,"")+(new Date).valueOf()),LiveValidationForm.instances[a.id]||(LiveValidationForm.instances[a.id]=new LiveValidationForm(a)),LiveValidationForm.instances[a.id]}}),LiveValidationForm.prototype={initialize:function(a){this.element=$(a),this.fields=[],this.oldOnSubmit=this.element.onsubmit||function(){},this.element.onsubmit=function(c){!!LiveValidation.massValidate(this.fields)&&!1!==this.oldOnSubmit.call(this.element,c)||Event.stop(c)}.bindAsEventListener(this)},addField:function(a){this.fields.push(a)},removeField:function(a){this.fields=this.fields.without(a)},destroy:function(a){return!(0!=this.fields.length&&!a)&&(this.element.onsubmit=this.oldOnSubmit,!(LiveValidationForm.instances[this.element.id]=null))}};var Validate={Presence:function(a,b){var c=Object.extend({failureMessage:"Can't be empty!"},b||{});return""!==a&&null!=a||Validate.fail(c.failureMessage),!0},Numericality:function(b,c){var a=b,d=(b=Number(b),{notANumberMessage:(c=c||{}).notANumberMessage||"Must be a number!",notAnIntegerMessage:c.notAnIntegerMessage||"Must be an integer!",wrongNumberMessage:c.wrongNumberMessage||"Must be "+c.is+"!",tooLowMessage:c.tooLowMessage||"Must not be less than "+c.minimum+"!",tooHighMessage:c.tooHighMessage||"Must not be more than "+c.maximum+"!",is:c.is||0==c.is?c.is:null,minimum:c.minimum||0==c.minimum?c.minimum:null,maximum:c.maximum||0==c.maximum?c.maximum:null,onlyInteger:c.onlyInteger||!1});switch(isFinite(b)||Validate.fail(d.notANumberMessage),d.onlyInteger&&(/\.0+$|\.$/.test(String(a))||b!=parseInt(b))&&Validate.fail(d.notAnIntegerMessage),!0){case null!==d.is:b!=Number(d.is)&&Validate.fail(d.wrongNumberMessage);break;case null!==d.minimum&&null!==d.maximum:Validate.Numericality(b,{tooLowMessage:d.tooLowMessage,minimum:d.minimum}),Validate.Numericality(b,{tooHighMessage:d.tooHighMessage,maximum:d.maximum});break;case null!==d.minimum:b<Number(d.minimum)&&Validate.fail(d.tooLowMessage);break;case null!==d.maximum:b>Number(d.maximum)&&Validate.fail(d.tooHighMessage)}return!0},Format:function(a,b){a=String(a);var c=Object.extend({failureMessage:"Not valid!",pattern:/./,negate:!1},b||{});return c.negate||c.pattern.test(a)||Validate.fail(c.failureMessage),c.negate&&c.pattern.test(a)&&Validate.fail(c.failureMessage),!0},Email:function(a,b){var c=Object.extend({failureMessage:"Must be a valid email address!"},b||{});return Validate.Format(a,{failureMessage:c.failureMessage,pattern:/^([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})$/i}),!0},Length:function(a,b){a=String(a);var c={wrongLengthMessage:(b=b||{}).wrongLengthMessage||"Must be "+b.is+" characters long!",tooShortMessage:b.tooShortMessage||"Must not be less than "+b.minimum+" characters long!",tooLongMessage:b.tooLongMessage||"Must not be more than "+b.maximum+" characters long!",is:b.is||0==b.is?b.is:null,minimum:b.minimum||0==b.minimum?b.minimum:null,maximum:b.maximum||0==b.maximum?b.maximum:null};switch(!0){case null!==c.is:a.length!=Number(c.is)&&Validate.fail(c.wrongLengthMessage);break;case null!==c.minimum&&null!==c.maximum:Validate.Length(a,{tooShortMessage:c.tooShortMessage,minimum:c.minimum}),Validate.Length(a,{tooLongMessage:c.tooLongMessage,maximum:c.maximum});break;case null!==c.minimum:a.length<Number(c.minimum)&&Validate.fail(c.tooShortMessage);break;case null!==c.maximum:a.length>Number(c.maximum)&&Validate.fail(c.tooLongMessage);break;default:throw new Error("Validate::Length - Length(s) to validate against must be provided!")}return!0},Inclusion:function(c,d){var e=Object.extend({failureMessage:"Must be included in the list!",within:[],allowNull:!1,partialMatch:!1,caseSensitive:!0,negate:!1},d||{});if(e.allowNull&&null==c)return!0;if(e.allowNull||null!=c||Validate.fail(e.failureMessage),!e.caseSensitive){var a=[];e.within.each(function(f){"string"==typeof f&&(f=f.toLowerCase()),a.push(f)}),e.within=a,"string"==typeof c&&(c=c.toLowerCase())}var b=-1!=e.within.indexOf(c);return e.partialMatch&&(b=!1,e.within.each(function(f){-1!=c.indexOf(f)&&(b=!0)})),(!e.negate&&!b||e.negate&&b)&&Validate.fail(e.failureMessage),!0},Exclusion:function(a,b){var c=Object.extend({failureMessage:"Must not be included in the list!",within:[],allowNull:!1,partialMatch:!1,caseSensitive:!0},b||{});return c.negate=!0,Validate.Inclusion(a,c),!0},Confirmation:function(a,b){if(!b.match)throw new Error("Validate::Confirmation - Error validating confirmation: Id of element to match must be provided!");var c=Object.extend({failureMessage:"Does not match!",match:null},b||{});if(c.match=$(b.match),!c.match)throw new Error("Validate::Confirmation - There is no reference with name of, or element with id of '"+c.match+"'!");return a!=c.match.value&&Validate.fail(c.failureMessage),!0},Acceptance:function(a,b){var c=Object.extend({failureMessage:"Must be accepted!"},b||{});return a||Validate.fail(c.failureMessage),!0},Custom:function(a,b){var c=Object.extend({against:function(){return!0},args:{},failureMessage:"Not valid!"},b||{});return c.against(a,c.args)||Validate.fail(c.failureMessage),!0},now:function(a,d,c){if(!a)throw new Error("Validate::now - Validation function must be provided!");var e=!0;try{a(d,c||{})}catch(b){if(!(b instanceof Validate.Error))throw b;e=!1}finally{return e}},Error:function(a){this.message=a,this.name="ValidationError"},fail:function(a){throw new Validate.Error(a)}},XWiki=function(XWiki){var widgets=XWiki.widgets=XWiki.widgets||{};function init(){return new widgets.FullScreen}return widgets.FullScreen=Class.create({margin:0,buttonSize:16,editFullScreenLabel:"GEL_$jsontool.serialize($services.localization.render('core.editors.fullscreen.editFullScreen'))_GEL",exitFullScreenLabel:"GEL_$jsontool.serialize($services.localization.render('core.editors.fullscreen.exitFullScreen'))_GEL",initialize:function(){if(this.buttons=$(document.body).down(".bottombuttons"),this.buttons||(this.buttons=new Element("div",{class:"bottombuttons"}).update(new Element("div",{class:"buttons"})),this.buttons._x_isCustom=!0,document.body.appendChild(this.buttons.hide())),this.buttonsPlaceholder=new Element("span"),this.toolbarPlaceholder=new Element("span"),this.createCloseButtons(),$$("textarea",".maximizable").each(function(element){this.addBehavior(element)}.bind(this)),document.observe("xwiki:dom:updated",function(event){event.memo.elements.each(function(element){element.select("textarea",".maximizable").each(function(element){this.addBehavior(element)}.bind(this))}.bind(this))}.bind(this)),$$(".xRichTextEditor").each(function(item){this.addBehavior(item)}.bind(this)),this.addWysiwygListeners(),this.maximizedReference=$(document.body).down("input[name='x-maximized']"),this.maximizedReference&&""!=this.maximizedReference.value){var matches=$$(this.maximizedReference.value);matches&&0<matches.length&&this.makeFullScreen(matches[0])}this.unloadHandler=this.cleanup.bind(this),Event.observe(window,"unload",this.unloadHandler)},addBehavior:function(item){this.isWysiwyg20Content(item)?this.addWysiwyg20ContentButton(item):this.isWysiwyg10Content(item)?this.addWysiwyg10ContentButton(item):this.isWikiContent(item)?this.addWikiContentButton(item):this.isWysiwyg20Field(item)?this.addWysiwyg20FieldButton(item):this.isWikiField(item)?this.addWikiFieldButton(item):this.isWysiwyg10Field(item)?this.addWysiwyg10FieldButton(item):this.addElementButton(item)},addWysiwygListeners:function(){document.observe("xwiki:wysiwyg:created",this.wysiwyg20Created.bindAsEventListener(this)),document.observe("xwiki:tinymce:created",this.wysiwyg10Created.bindAsEventListener(this))},wysiwyg10Created:function(event){var item=$(event.memo.instance);this.removeTextareaLink(item),this.addBehavior(item)},wysiwyg20Created:function(event){var item=$(event.memo.instance.getRichTextArea()).up(".xRichTextEditor");this.removeTextareaLink(item),this.addBehavior(item)},removeTextareaLink:function(item){for(;;){if(!item)return;if(item.previous(".fullScreenEditLinkContainer"))return void item.previous(".fullScreenEditLinkContainer").remove();item=item.up()}},isWikiContent:function(textarea){return"content"==textarea.name&&textarea.visible()},isWysiwyg10Content:function(textarea){return"content"==textarea.name&&(Prototype.Browser.IE?textarea.previous(".mceEditorContainer"):textarea.next(".mceEditorContainer"))},isWysiwyg20Content:function(item){return item.hasClassName("xRichTextEditor")&&item.up("div[id^=content_container]")},isWikiField:function(textarea){return textarea.visible()},isWysiwyg10Field:function(textarea){return!textarea.visible()&&"content"!=textarea.name&&(Prototype.Browser.IE?textarea.previous(".mceEditorContainer"):textarea.next(".mceEditorContainer"))},isWysiwyg20Field:function(item){return item.hasClassName("xRichTextEditor")&&!item.up("div[id^=content_container]")},addWikiContentButton:function(textarea){textarea._toolbar=$(document.body).down(".leftmenu2"),textarea._toolbar?textarea._toolbar.insert({top:this.createOpenButton(textarea)}):this.addWikiFieldButton(textarea)},addWysiwyg10ContentButton:function(item){var container=Prototype.Browser.IE?item.previous(".mceEditorContainer"):item.next(".mceEditorContainer");if(!container)return!1;var toolbar=container.down(".mceToolbar");if(!toolbar)return!1;var newToolbar=new Element("span",{class:"mce_editor_fullscreentoolbar"}),link=new Element("a",{class:"mceButtonNormal"});return newToolbar.insert(new Element("img",{class:"mceSeparatorLine",height:15,width:1,src:toolbar.down("img.mceSeparatorLine").src})),newToolbar.insert(link.insert(this.createOpenButton(container))),toolbar.insert(newToolbar),container._toolbar=toolbar,!0},addWysiwyg20ContentButton:function(item){var toolbar=item.down(".gwt-MenuBar");return toolbar?(toolbar.insert({top:this.createOpenButton(item)}),item._toolbar=toolbar,item._x_fullScreenLoader&&(item._x_fullScreenLoader.stop(),item._x_fullScreenLoader=!1),!0):(item._x_fullScreenLoader||(item._x_fullScreenLoader_iterations=0,item._x_fullScreenLoader=new PeriodicalExecuter(function(item){if(100<item._x_fullScreenLoader_iteration)return item._x_fullScreenLoader.stop(),void(item._x_fullScreenLoader=!1);item._x_fullScreenLoader_iteration++,this.addWysiwyg20ContentButton(item)}.bind(this,item),.2)),!1)},addElementButton:function(element){Element.insert(element,{before:this.createOpenLink(element)})},addWikiFieldButton:function(textarea){Element.insert(textarea,{before:this.createOpenLink(textarea)})},addWysiwyg10FieldButton:function(textarea){this.addWysiwyg10ContentButton(textarea)},addWysiwyg20FieldButton:function(textarea){this.addWysiwyg20ContentButton(textarea)},createOpenButton:function(targetElement){var fullScreenActivator=new Element("img",{class:"fullScreenEditButton",title:this.editFullScreenLabel,alt:this.editFullScreenLabel,src:"resources/icons/silk/arrow_out.png"});return fullScreenActivator.observe("click",this.makeFullScreen.bind(this,targetElement)),fullScreenActivator.observe("mousedown",this.preventDrag.bindAsEventListener(this)),(targetElement._x_fullScreenActivator=fullScreenActivator)._x_maximizedElement=targetElement,fullScreenActivator},createOpenLink:function(targetElement){var fullScreenActivatorContainer=new Element("div",{class:"fullScreenEditLinkContainer"}),fullScreenActivator=new Element("a",{class:"fullScreenEditLink",title:this.editFullScreenLabel}).update(this.editFullScreenLabel+" &raquo;");return fullScreenActivator.observe("click",this.makeFullScreen.bind(this,targetElement)),fullScreenActivatorContainer.update(fullScreenActivator),(targetElement._x_fullScreenActivator=fullScreenActivator)._x_maximizedElement=targetElement,fullScreenActivatorContainer},createCloseButtons:function(){this.closeButton=new Element("img",{class:"fullScreenCloseButton",title:this.exitFullScreenLabel,alt:this.exitFullScreenLabel,src:"resources/icons/silk/arrow_in.png"}),this.closeButton.observe("click",this.closeFullScreen.bind(this)),this.closeButton.observe("mousedown",this.preventDrag.bindAsEventListener(this)),this.closeButton.hide(),this.actionCloseButton=new Element("input",{type:"button",class:"button",value:this.exitFullScreenLabel}),this.actionCloseButtonWrapper=new Element("span",{class:"buttonwrapper"}),this.actionCloseButtonWrapper.update(this.actionCloseButton),this.actionCloseButton.observe("click",this.closeFullScreen.bind(this)),this.actionCloseButtonWrapper.hide(),this.buttons.down(".buttons").insert({top:this.actionCloseButtonWrapper})},makeFullScreen:function(targetElement){if(document.fire("xwiki:fullscreen:enter",{target:targetElement}),this.maximizedReference&&(targetElement.id?this.maximizedReference.value=targetElement.tagName+"[id='"+targetElement.id+"']":targetElement.name?this.maximizedReference.value=targetElement.tagName+"[name='"+targetElement.name+"']":targetElement.className&&(this.maximizedReference.value=targetElement.tagName+"."+targetElement.className)),"function"==typeof(this.maximized=targetElement).setSelectionRange)var selectionStart=targetElement.selectionStart,selectionEnd=targetElement.selectionEnd,scrollTop=targetElement.scrollTop;if(targetElement._originalStyle={width:targetElement.style.width,height:targetElement.style.height},targetElement.hasClassName("xRichTextEditor")){var iframe=targetElement.down(".gwt-RichTextArea");targetElement._richTextAreaOriginalStyle={width:iframe.style.width,height:iframe.style.height}}else if(targetElement.hasClassName("mceEditorContainer")){(iframe=targetElement.down(".mceEditorIframe"))._originalStyle={width:iframe.style.width,height:iframe.style.height};var tframe=targetElement.down(".mceEditorSource");tframe._originalStyle={width:tframe.style.width,height:tframe.style.height}}var wrapper=targetElement.up();wrapper.addClassName("fullScreenWrapper"),targetElement._toolbar&&(targetElement._toolbar.hasClassName("leftmenu2")&&wrapper.insert({top:targetElement._toolbar.replace(this.toolbarPlaceholder)}),targetElement._x_fullScreenActivator.replace(this.closeButton)),wrapper.insert(this.buttons.replace(this.buttonsPlaceholder).show());var parent=targetElement.up();for(targetElement._x_fullScreenActivator.hide();parent!=document.body;)parent._originalStyle={overflow:parent.style.overflow,position:parent.style.position,width:parent.style.width,height:parent.style.height,left:parent.style.left,right:parent.style.right,top:parent.style.top,bottom:parent.style.bottom,padding:parent.style.padding,margin:parent.style.margin},parent.setStyle({overflow:"visible",position:"absolute",width:"100%",height:"100%",left:0,top:0,right:0,bottom:0,padding:0,margin:0}),parent.siblings().each(function(item){item._originalDisplay=item.style.display,item.setStyle({display:"none"}),item._fullscreenHidden=!0}),parent=parent.up();document.body._originalStyle={overflow:parent.style.overflow,width:parent.style.width,height:parent.style.height};var root=$(document.body).up();root._originalStyle={overflow:root.style.overflow,width:root.style.width,height:root.style.height},$(document.body).setStyle({overflow:"hidden",width:"100%",height:"100%"}),root.setStyle({overflow:"hidden",width:"100%",height:"100%"}),this.resizeListener=this.resizeTextArea.bind(this,targetElement),Event.observe(window,"resize",this.resizeListener),this.closeButton.show(),this.actionCloseButtonWrapper.show(),this.resizeTextArea(targetElement),targetElement._toolbar&&targetElement._toolbar.viewportOffset(),"function"==typeof targetElement.setSelectionRange&&(targetElement.scrollTop=scrollTop,targetElement.selectionStart=selectionStart,targetElement.selectionEnd=selectionEnd),document.fire("xwiki:fullscreen:entered",{target:targetElement})},closeFullScreen:function(){var targetElement=this.maximized;if(document.fire("xwiki:fullscreen:exit",{target:targetElement}),"function"==typeof targetElement.setSelectionRange)var selectionStart=targetElement.selectionStart,selectionEnd=targetElement.selectionEnd,scrollTop=targetElement.scrollTop;if(this.closeButton.hide(),this.actionCloseButtonWrapper.hide(),Event.stopObserving(window,"resize",this.resizeListener),targetElement.up().removeClassName("fullScreenWrapper"),targetElement.hasClassName("xRichTextEditor"))(iframe=targetElement.down(".gwt-RichTextArea")).setStyle(targetElement._richTextAreaOriginalStyle);else if(targetElement.hasClassName("mceEditorContainer")){var iframe;(iframe=targetElement.down(".mceEditorIframe")).setStyle(iframe._originalStyle);var tframe=targetElement.down(".mceEditorSource");tframe.setStyle(tframe._originalStyle)}for(var parent=targetElement.up(),parents=[];parent!=document.body;)parents.push(parent),parent=parent.up();for(var i=parents.length;i--;)(parent=parents[i]).setStyle(parent._originalStyle),parent.siblings().each(function(item){item._fullscreenHidden&&(item.style.display=item._originalDisplay||"")});document.body.setStyle(document.body._originalStyle),$(document.body).up().setStyle($(document.body).up()._originalStyle),this.buttonsPlaceholder.replace(this.buttons),this.buttons._x_isCustom&&this.buttons.hide(),targetElement._toolbar&&(targetElement._toolbar.hasClassName("leftmenu2")&&this.toolbarPlaceholder.replace(targetElement._toolbar),this.closeButton.replace(targetElement._x_fullScreenActivator)),Prototype.Browser.IE?setTimeout(function(){targetElement._x_fullScreenActivator.show(),this.setStyle(this._originalStyle)}.bind(targetElement),500):(targetElement._x_fullScreenActivator.show(),targetElement.setStyle(targetElement._originalStyle)),delete this.maximized,this.maximizedReference&&(this.maximizedReference.value=""),"function"==typeof targetElement.setSelectionRange&&(targetElement.scrollTop=scrollTop,targetElement.selectionStart=selectionStart,targetElement.selectionEnd=selectionEnd),document.fire("xwiki:fullscreen:exited",{target:targetElement})},resizeTextArea:function(targetElement){if(this.maximized){var newHeight=document.viewport.getHeight(),newWidth=document.viewport.getWidth();newWidth<=0&&(newWidth=document.body.clientWidth,newHeight=document.body.clientHeight),newWidth-=this.margin,newHeight=newHeight-targetElement.positionedOffset().top-this.margin-this.buttons.getHeight(),targetElement.setStyle({width:newWidth+"px",height:newHeight+"px"}),targetElement.hasClassName("xRichTextEditor")?targetElement.down(".gwt-RichTextArea").setStyle({width:newWidth+"px",height:newHeight-targetElement.down(".xToolbar").getHeight()-targetElement.down(".gwt-MenuBar").getHeight()+"px"}):targetElement.hasClassName("mceEditorContainer")&&(targetElement.down(".mceEditorIframe").setStyle({width:newWidth+"px",height:newHeight-targetElement._toolbar.getHeight()+"px"}),targetElement.down(".mceEditorSource").setStyle({width:newWidth+"px",height:newHeight-targetElement._toolbar.getHeight()+"px"})),document.fire("xwiki:fullscreen:resized",{target:targetElement})}},preventDrag:function(event){event.stop()},cleanup:function(){Event.stopObserving(window,"unload",this.unloadHandler);try{this.actionCloseButtonWrapper.remove()}catch(ex){}}}),XWiki.domIsLoaded&&init()||document.observe("xwiki:dom:loaded",init),XWiki}(XWiki||{});if(!Control)var Control={};if(Control.Slider=Class.create({initialize:function(d,a,b){var c=this;Object.isArray(d)?this.handles=d.collect(function(f){return $(f)}):this.handles=[$(d)],this.track=$(a),this.options=b||{},this.axis=this.options.axis||"horizontal",this.increment=this.options.increment||1,this.step=parseInt(this.options.step||"1"),this.range=this.options.range||$R(0,1),this.value=0,this.values=this.handles.map(function(){return 0}),this.spans=!!this.options.spans&&this.options.spans.map(function(e){return $(e)}),this.options.startSpan=$(this.options.startSpan||null),this.options.endSpan=$(this.options.endSpan||null),this.restricted=this.options.restricted||!1,this.maximum=this.options.maximum||this.range.end,this.minimum=this.options.minimum||this.range.start,this.alignX=parseInt(this.options.alignX||"0"),this.alignY=parseInt(this.options.alignY||"0"),this.trackLength=this.maximumOffset()-this.minimumOffset(),this.handleLength=this.isVertical()?0!=this.handles[0].offsetHeight?this.handles[0].offsetHeight:this.handles[0].style.height.replace(/px$/,""):0!=this.handles[0].offsetWidth?this.handles[0].offsetWidth:this.handles[0].style.width.replace(/px$/,""),this.active=!1,this.dragging=!1,this.disabled=!1,this.options.disabled&&this.setDisabled(),this.allowedValues=!!this.options.values&&this.options.values.sortBy(Prototype.K),this.allowedValues&&(this.minimum=this.allowedValues.min(),this.maximum=this.allowedValues.max()),this.eventMouseDown=this.startDrag.bindAsEventListener(this),this.eventMouseUp=this.endDrag.bindAsEventListener(this),this.eventMouseMove=this.update.bindAsEventListener(this),this.handles.each(function(f,e){e=c.handles.length-1-e,c.setValue(parseFloat((Object.isArray(c.options.sliderValue)?c.options.sliderValue[e]:c.options.sliderValue)||c.range.start),e),f.makePositioned().observe("mousedown",c.eventMouseDown)}),this.track.observe("mousedown",this.eventMouseDown),document.observe("mouseup",this.eventMouseUp),document.observe("mousemove",this.eventMouseMove),this.initialized=!0},dispose:function(){var a=this;Event.stopObserving(this.track,"mousedown",this.eventMouseDown),Event.stopObserving(document,"mouseup",this.eventMouseUp),Event.stopObserving(document,"mousemove",this.eventMouseMove),this.handles.each(function(b){Event.stopObserving(b,"mousedown",a.eventMouseDown)})},setDisabled:function(){this.disabled=!0},setEnabled:function(){this.disabled=!1},getNearestValue:function(a){if(this.allowedValues){if(a>=this.allowedValues.max())return this.allowedValues.max();if(a<=this.allowedValues.min())return this.allowedValues.min();var c=Math.abs(this.allowedValues[0]-a),b=this.allowedValues[0];return this.allowedValues.each(function(d){var e=Math.abs(d-a);e<=c&&(b=d,c=e)}),b}return a>this.range.end?this.range.end:a<this.range.start?this.range.start:a},setValue:function(b,a){this.active||(this.activeHandleIdx=a||0,this.activeHandle=this.handles[this.activeHandleIdx],this.updateStyles()),a=a||this.activeHandleIdx||0,this.initialized&&this.restricted&&(0<a&&b<this.values[a-1]&&(b=this.values[a-1]),a<this.handles.length-1&&b>this.values[a+1]&&(b=this.values[a+1])),b=this.getNearestValue(b),this.values[a]=b,this.value=this.values[0],this.handles[a].style[this.isVertical()?"top":"left"]=this.translateToPx(b),this.drawSpans(),this.dragging&&this.event||this.updateFinished()},setValueBy:function(b,a){this.setValue(this.values[a||this.activeHandleIdx||0]+b,a||this.activeHandleIdx||0)},translateToPx:function(a){return Math.round((this.trackLength-this.handleLength)/(this.range.end-this.range.start)*(a-this.range.start))+"px"},translateToValue:function(a){return a/(this.trackLength-this.handleLength)*(this.range.end-this.range.start)+this.range.start},getRange:function(b){var a=this.values.sortBy(Prototype.K);return $R(a[b=b||0],a[b+1])},minimumOffset:function(){return this.isVertical()?this.alignY:this.alignX},maximumOffset:function(){return this.isVertical()?(0!=this.track.offsetHeight?this.track.offsetHeight:this.track.style.height.replace(/px$/,""))-this.alignY:(0!=this.track.offsetWidth?this.track.offsetWidth:this.track.style.width.replace(/px$/,""))-this.alignX},isVertical:function(){return"vertical"==this.axis},drawSpans:function(){var a=this;this.spans&&$R(0,this.spans.length-1).each(function(b){a.setSpan(a.spans[b],a.getRange(b))}),this.options.startSpan&&this.setSpan(this.options.startSpan,$R(0,1<this.values.length?this.getRange(0).min():this.value)),this.options.endSpan&&this.setSpan(this.options.endSpan,$R(1<this.values.length?this.getRange(this.spans.length-1).max():this.value,this.maximum))},setSpan:function(b,a){this.isVertical()?(b.style.top=this.translateToPx(a.start),b.style.height=this.translateToPx(a.end-a.start+this.range.start)):(b.style.left=this.translateToPx(a.start),b.style.width=this.translateToPx(a.end-a.start+this.range.start))},updateStyles:function(){this.handles.each(function(a){Element.removeClassName(a,"selected")}),Element.addClassName(this.activeHandle,"selected")},startDrag:function(c){if(Event.isLeftClick(c)){if(!this.disabled){this.active=!0;var d=Event.element(c),e=[Event.pointerX(c),Event.pointerY(c)];if(d==this.track){var b=this.track.cumulativeOffset();this.event=c,this.setValue(this.translateToValue((this.isVertical()?e[1]-b[1]:e[0]-b[0])-this.handleLength/2));b=this.activeHandle.cumulativeOffset();this.offsetX=e[0]-b[0],this.offsetY=e[1]-b[1]}else{for(;-1==this.handles.indexOf(d)&&d.parentNode;)d=d.parentNode;if(-1!=this.handles.indexOf(d)){this.activeHandle=d,this.activeHandleIdx=this.handles.indexOf(this.activeHandle),this.updateStyles();b=this.activeHandle.cumulativeOffset();this.offsetX=e[0]-b[0],this.offsetY=e[1]-b[1]}}}Event.stop(c)}},update:function(a){this.active&&(this.dragging||(this.dragging=!0),this.draw(a),Prototype.Browser.WebKit&&window.scrollBy(0,0),Event.stop(a))},draw:function(b){var c=[Event.pointerX(b),Event.pointerY(b)],a=this.track.cumulativeOffset();c[0]-=this.offsetX+a[0],c[1]-=this.offsetY+a[1],this.event=b,this.setValue(this.translateToValue(this.isVertical()?c[1]:c[0])),this.initialized&&this.options.onSlide&&this.options.onSlide(1<this.values.length?this.values:this.value,this)},endDrag:function(a){this.active&&this.dragging&&(this.finishDrag(a,!0),Event.stop(a)),this.active=!1,this.dragging=!1},finishDrag:function(a,b){this.active=!1,this.dragging=!1,this.updateFinished()},updateFinished:function(){this.initialized&&this.options.onChange&&this.options.onChange(1<this.values.length?this.values:this.value,this),this.event=null}}),Object.isUndefined(Effect))throw"dragdrop.js requires including script.aculo.us' effects.js library";var Droppables={drops:[],remove:function(element){this.drops=this.drops.reject(function(d){return d.element==$(element)})},add:function(element){element=$(element);var options=Object.extend({greedy:!0,hoverclass:null,tree:!1},arguments[1]||{});if(options.containment){options._containers=[];var containment=options.containment;Object.isArray(containment)?containment.each(function(c){options._containers.push($(c))}):options._containers.push($(containment))}options.accept&&(options.accept=[options.accept].flatten()),Element.makePositioned(element),options.element=element,this.drops.push(options)},findDeepestChild:function(drops){for(deepest=drops[0],i=1;i<drops.length;++i)Element.isParent(drops[i].element,deepest.element)&&(deepest=drops[i]);return deepest},isContained:function(element,drop){var containmentNode;return containmentNode=drop.tree?element.treeNode:element.parentNode,drop._containers.detect(function(c){return containmentNode==c})},isAffected:function(point,element,drop){return drop.element!=element&&(!drop._containers||this.isContained(element,drop))&&(!drop.accept||Element.classNames(element).detect(function(v){return drop.accept.include(v)}))&&Position.within(drop.element,point[0],point[1])},deactivate:function(drop){drop.hoverclass&&Element.removeClassName(drop.element,drop.hoverclass),this.last_active=null},activate:function(drop){drop.hoverclass&&Element.addClassName(drop.element,drop.hoverclass),this.last_active=drop},show:function(point,element,event){if(this.drops.length){var drop,affected=[];this.drops.each(function(drop){Droppables.isAffected(point,element,drop)&&affected.push(drop)}),0<affected.length&&(drop=Droppables.findDeepestChild(affected)),this.last_active&&this.last_active!=drop&&this.deactivate(this.last_active),drop&&(Position.within(drop.element,point[0],point[1]),drop.onHover&&drop.onHover(element,drop.element,Position.overlap(drop.overlap,drop.element),event),drop!=this.last_active&&Droppables.activate(drop))}},fire:function(event,element){if(this.last_active)return Position.prepare(),this.isAffected([Event.pointerX(event),Event.pointerY(event)],element,this.last_active)&&this.last_active.onDrop?(this.last_active.onDrop(element,this.last_active.element,event),!0):void 0},reset:function(){this.last_active&&this.deactivate(this.last_active)}},Draggables={drags:[],observers:[],register:function(draggable){0==this.drags.length&&(this.eventMouseUp=this.endDrag.bindAsEventListener(this),this.eventMouseMove=this.updateDrag.bindAsEventListener(this),this.eventKeypress=this.keyPress.bindAsEventListener(this),Event.observe(document,"mouseup",this.eventMouseUp),Event.observe(document,"mousemove",this.eventMouseMove),Event.observe(document,"keypress",this.eventKeypress)),this.drags.push(draggable)},unregister:function(draggable){this.drags=this.drags.reject(function(d){return d==draggable}),0==this.drags.length&&(Event.stopObserving(document,"mouseup",this.eventMouseUp),Event.stopObserving(document,"mousemove",this.eventMouseMove),Event.stopObserving(document,"keypress",this.eventKeypress))},activate:function(draggable){draggable.options.delay?this._timeout=setTimeout(function(){Draggables._timeout=null,window.focus(),Draggables.activeDraggable=draggable}.bind(this),draggable.options.delay):(window.focus(),this.activeDraggable=draggable)},deactivate:function(){this.activeDraggable=null},updateDrag:function(event){if(this.activeDraggable){var pointer=[Event.pointerX(event),Event.pointerY(event)];this._lastPointer&&this._lastPointer.inspect()==pointer.inspect()||(this._lastPointer=pointer,this.activeDraggable.updateDrag(event,pointer))}},endDrag:function(event){this._timeout&&(clearTimeout(this._timeout),this._timeout=null),this.activeDraggable&&(this._lastPointer=null,this.activeDraggable.endDrag(event),this.activeDraggable=null)},keyPress:function(event){this.activeDraggable&&this.activeDraggable.keyPress(event)},addObserver:function(observer){this.observers.push(observer),this._cacheObserverCallbacks()},removeObserver:function(element){this.observers=this.observers.reject(function(o){return o.element==element}),this._cacheObserverCallbacks()},notify:function(eventName,draggable,event){0<this[eventName+"Count"]&&this.observers.each(function(o){o[eventName]&&o[eventName](eventName,draggable,event)}),draggable.options[eventName]&&draggable.options[eventName](draggable,event)},_cacheObserverCallbacks:function(){["onStart","onEnd","onDrag"].each(function(eventName){Draggables[eventName+"Count"]=Draggables.observers.select(function(o){return o[eventName]}).length})}},Draggable=Class.create({initialize:function(element){var defaults={handle:!1,reverteffect:function(element,top_offset,left_offset){var dur=.02*Math.sqrt(Math.abs(2^top_offset)+Math.abs(2^left_offset));new Effect.Move(element,{x:-left_offset,y:-top_offset,duration:dur,queue:{scope:"_draggable",position:"end"}})},endeffect:function(element){var toOpacity=Object.isNumber(element._opacity)?element._opacity:1;new Effect.Opacity(element,{duration:.2,from:.7,to:toOpacity,queue:{scope:"_draggable",position:"end"},afterFinish:function(){Draggable._dragging[element]=!1}})},zindex:1e3,revert:!1,quiet:!1,scroll:!1,scrollSensitivity:20,scrollSpeed:15,snap:!1,delay:0};arguments[1]&&!Object.isUndefined(arguments[1].endeffect)||Object.extend(defaults,{starteffect:function(element){element._opacity=Element.getOpacity(element),Draggable._dragging[element]=!0,new Effect.Opacity(element,{duration:.2,from:element._opacity,to:.7})}});var options=Object.extend(defaults,arguments[1]||{});this.element=$(element),options.handle&&Object.isString(options.handle)&&(this.handle=this.element.down("."+options.handle,0)),this.handle||(this.handle=$(options.handle)),this.handle||(this.handle=this.element),!options.scroll||options.scroll.scrollTo||options.scroll.outerHTML||(options.scroll=$(options.scroll),this._isScrollChild=Element.childOf(this.element,options.scroll)),Element.makePositioned(this.element),this.options=options,this.dragging=!1,this.eventMouseDown=this.initDrag.bindAsEventListener(this),Event.observe(this.handle,"mousedown",this.eventMouseDown),Draggables.register(this)},destroy:function(){Event.stopObserving(this.handle,"mousedown",this.eventMouseDown),Draggables.unregister(this)},currentDelta:function(){return[parseInt(Element.getStyle(this.element,"left")||"0"),parseInt(Element.getStyle(this.element,"top")||"0")]},initDrag:function(event){if((Object.isUndefined(Draggable._dragging[this.element])||!Draggable._dragging[this.element])&&Event.isLeftClick(event)){var src=Event.element(event);if((tag_name=src.tagName.toUpperCase())&&("INPUT"==tag_name||"SELECT"==tag_name||"OPTION"==tag_name||"BUTTON"==tag_name||"TEXTAREA"==tag_name))return;var pointer=[Event.pointerX(event),Event.pointerY(event)],pos=this.element.cumulativeOffset();this.offset=[0,1].map(function(i){return pointer[i]-pos[i]}),Draggables.activate(this),Event.stop(event)}},startDrag:function(event){if(this.dragging=!0,this.delta||(this.delta=this.currentDelta()),this.options.zindex&&(this.originalZ=parseInt(Element.getStyle(this.element,"z-index")||0),this.element.style.zIndex=this.options.zindex),this.options.ghosting&&(this._clone=this.element.cloneNode(!0),this._originallyAbsolute="absolute"==this.element.getStyle("position"),this._originallyAbsolute||Position.absolutize(this.element),this.element.parentNode.insertBefore(this._clone,this.element)),this.options.scroll)if(this.options.scroll==window){var where=this._getWindowScroll(this.options.scroll);this.originalScrollLeft=where.left,this.originalScrollTop=where.top}else this.originalScrollLeft=this.options.scroll.scrollLeft,this.originalScrollTop=this.options.scroll.scrollTop;Draggables.notify("onStart",this,event),this.options.starteffect&&this.options.starteffect(this.element)},updateDrag:function(event,pointer){if(this.dragging||this.startDrag(event),this.options.quiet||(Position.prepare(),Droppables.show(pointer,this.element,event)),Draggables.notify("onDrag",this,event),this.draw(pointer),this.options.change&&this.options.change(this),this.options.scroll){var p;if(this.stopScrolling(),this.options.scroll==window)with(this._getWindowScroll(this.options.scroll))p=[left,top,left+width,top+height];else p=Position.page(this.options.scroll).toArray(),p[0]+=this.options.scroll.scrollLeft+Position.deltaX,p[1]+=this.options.scroll.scrollTop+Position.deltaY,p.push(p[0]+this.options.scroll.offsetWidth),p.push(p[1]+this.options.scroll.offsetHeight);var speed=[0,0];pointer[0]<p[0]+this.options.scrollSensitivity&&(speed[0]=pointer[0]-(p[0]+this.options.scrollSensitivity)),pointer[1]<p[1]+this.options.scrollSensitivity&&(speed[1]=pointer[1]-(p[1]+this.options.scrollSensitivity)),pointer[0]>p[2]-this.options.scrollSensitivity&&(speed[0]=pointer[0]-(p[2]-this.options.scrollSensitivity)),pointer[1]>p[3]-this.options.scrollSensitivity&&(speed[1]=pointer[1]-(p[3]-this.options.scrollSensitivity)),this.startScrolling(speed)}Prototype.Browser.WebKit&&window.scrollBy(0,0),Event.stop(event)},finishDrag:function(event,success){if(this.dragging=!1,this.options.quiet){Position.prepare();var pointer=[Event.pointerX(event),Event.pointerY(event)];Droppables.show(pointer,this.element,event)}this.options.ghosting&&(this._originallyAbsolute||Position.relativize(this.element),delete this._originallyAbsolute,Element.remove(this._clone),this._clone=null);var dropped=!1;success&&((dropped=Droppables.fire(event,this.element))||(dropped=!1)),dropped&&this.options.onDropped&&this.options.onDropped(this.element),Draggables.notify("onEnd",this,event);var revert=this.options.revert;revert&&Object.isFunction(revert)&&(revert=revert(this.element));var d=this.currentDelta();revert&&this.options.reverteffect?0!=dropped&&"failure"==revert||this.options.reverteffect(this.element,d[1]-this.delta[1],d[0]-this.delta[0]):this.delta=d,this.options.zindex&&(this.element.style.zIndex=this.originalZ),this.options.endeffect&&this.options.endeffect(this.element),Draggables.deactivate(this),Droppables.reset()},keyPress:function(event){event.keyCode==Event.KEY_ESC&&(this.finishDrag(event,!1),Event.stop(event))},endDrag:function(event){this.dragging&&(this.stopScrolling(),this.finishDrag(event,!0),Event.stop(event))},draw:function(point){var pos=this.element.cumulativeOffset();if(this.options.ghosting){var r=Position.realOffset(this.element);pos[0]+=r[0]-Position.deltaX,pos[1]+=r[1]-Position.deltaY}var d=this.currentDelta();pos[0]-=d[0],pos[1]-=d[1],this.options.scroll&&this.options.scroll!=window&&this._isScrollChild&&(pos[0]-=this.options.scroll.scrollLeft-this.originalScrollLeft,pos[1]-=this.options.scroll.scrollTop-this.originalScrollTop);var p=[0,1].map(function(i){return point[i]-pos[i]-this.offset[i]}.bind(this));this.options.snap&&(p=Object.isFunction(this.options.snap)?this.options.snap(p[0],p[1],this):Object.isArray(this.options.snap)?p.map(function(v,i){return(v/this.options.snap[i]).round()*this.options.snap[i]}.bind(this)):p.map(function(v){return(v/this.options.snap).round()*this.options.snap}.bind(this)));var style=this.element.style;this.options.constraint&&"horizontal"!=this.options.constraint||(style.left=p[0]+"px"),this.options.constraint&&"vertical"!=this.options.constraint||(style.top=p[1]+"px"),"hidden"==style.visibility&&(style.visibility="")},stopScrolling:function(){this.scrollInterval&&(clearInterval(this.scrollInterval),this.scrollInterval=null,Draggables._lastScrollPointer=null)},startScrolling:function(speed){(speed[0]||speed[1])&&(this.scrollSpeed=[speed[0]*this.options.scrollSpeed,speed[1]*this.options.scrollSpeed],this.lastScrolled=new Date,this.scrollInterval=setInterval(this.scroll.bind(this),10))},scroll:function(){var current=new Date,delta=current-this.lastScrolled;if(this.lastScrolled=current,this.options.scroll==window){with(this._getWindowScroll(this.options.scroll))if(this.scrollSpeed[0]||this.scrollSpeed[1]){var d=delta/1e3;this.options.scroll.scrollTo(left+d*this.scrollSpeed[0],top+d*this.scrollSpeed[1])}}else this.options.scroll.scrollLeft+=this.scrollSpeed[0]*delta/1e3,this.options.scroll.scrollTop+=this.scrollSpeed[1]*delta/1e3;Position.prepare(),Droppables.show(Draggables._lastPointer,this.element,null),Draggables.notify("onDrag",this),this._isScrollChild&&(Draggables._lastScrollPointer=Draggables._lastScrollPointer||$A(Draggables._lastPointer),Draggables._lastScrollPointer[0]+=this.scrollSpeed[0]*delta/1e3,Draggables._lastScrollPointer[1]+=this.scrollSpeed[1]*delta/1e3,Draggables._lastScrollPointer[0]<0&&(Draggables._lastScrollPointer[0]=0),Draggables._lastScrollPointer[1]<0&&(Draggables._lastScrollPointer[1]=0),this.draw(Draggables._lastScrollPointer)),this.options.change&&this.options.change(this)},_getWindowScroll:function(w){var T,L,W,H;with(w.document)w.document.documentElement&&documentElement.scrollTop?(T=documentElement.scrollTop,L=documentElement.scrollLeft):w.document.body&&(T=body.scrollTop,L=body.scrollLeft),H=w.innerWidth?(W=w.innerWidth,w.innerHeight):w.document.documentElement&&documentElement.clientWidth?(W=documentElement.clientWidth,documentElement.clientHeight):(W=body.offsetWidth,body.offsetHeight);return{top:T,left:L,width:W,height:H}}});Draggable._dragging={};var SortableObserver=Class.create({initialize:function(element,observer){this.element=$(element),this.observer=observer,this.lastValue=Sortable.serialize(this.element)},onStart:function(){this.lastValue=Sortable.serialize(this.element)},onEnd:function(){Sortable.unmark(),this.lastValue!=Sortable.serialize(this.element)&&this.observer(this.element)}}),Sortable={SERIALIZE_RULE:/^[^_\-](?:[A-Za-z0-9\-\_]*)[_](.*)$/,sortables:{},_findRootElement:function(element){for(;"BODY"!=element.tagName.toUpperCase();){if(element.id&&Sortable.sortables[element.id])return element;element=element.parentNode}},options:function(element){if(element=Sortable._findRootElement($(element)))return Sortable.sortables[element.id]},destroy:function(element){element=$(element);var s=Sortable.sortables[element.id];s&&(Draggables.removeObserver(s.element),s.droppables.each(function(d){Droppables.remove(d)}),s.draggables.invoke("destroy"),delete Sortable.sortables[s.element.id])},create:function(element){element=$(element);var options=Object.extend({element:element,tag:"li",dropOnEmpty:!1,tree:!1,treeTag:"ul",overlap:"vertical",constraint:"vertical",containment:element,handle:!1,only:!1,delay:0,hoverclass:null,ghosting:!1,quiet:!1,scroll:!1,scrollSensitivity:20,scrollSpeed:15,format:this.SERIALIZE_RULE,elements:!1,handles:!1,onChange:Prototype.emptyFunction,onUpdate:Prototype.emptyFunction},arguments[1]||{});this.destroy(element);var options_for_draggable={revert:!0,quiet:options.quiet,scroll:options.scroll,scrollSpeed:options.scrollSpeed,scrollSensitivity:options.scrollSensitivity,delay:options.delay,ghosting:options.ghosting,constraint:options.constraint,handle:options.handle};options.starteffect&&(options_for_draggable.starteffect=options.starteffect),options.reverteffect?options_for_draggable.reverteffect=options.reverteffect:options.ghosting&&(options_for_draggable.reverteffect=function(element){element.style.top=0,element.style.left=0}),options.endeffect&&(options_for_draggable.endeffect=options.endeffect),options.zindex&&(options_for_draggable.zindex=options.zindex);var options_for_droppable={overlap:options.overlap,containment:options.containment,tree:options.tree,hoverclass:options.hoverclass,onHover:Sortable.onHover},options_for_tree={onHover:Sortable.onEmptyHover,overlap:options.overlap,containment:options.containment,hoverclass:options.hoverclass};Element.cleanWhitespace(element),options.draggables=[],options.droppables=[],(options.dropOnEmpty||options.tree)&&(Droppables.add(element,options_for_tree),options.droppables.push(element)),(options.elements||this.findElements(element,options)||[]).each(function(e,i){var handle=options.handles?$(options.handles[i]):options.handle?$(e).select("."+options.handle)[0]:e;options.draggables.push(new Draggable(e,Object.extend(options_for_draggable,{handle:handle}))),Droppables.add(e,options_for_droppable),options.tree&&(e.treeNode=element),options.droppables.push(e)}),options.tree&&(Sortable.findTreeElements(element,options)||[]).each(function(e){Droppables.add(e,options_for_tree),e.treeNode=element,options.droppables.push(e)}),this.sortables[element.identify()]=options,Draggables.addObserver(new SortableObserver(element,options.onUpdate))},findElements:function(element,options){return Element.findChildren(element,options.only,!!options.tree,options.tag)},findTreeElements:function(element,options){return Element.findChildren(element,options.only,!!options.tree,options.treeTag)},onHover:function(element,dropon,overlap,event){if(!(Element.isParent(dropon,element)||.33<overlap&&overlap<.66&&Sortable.options(dropon).tree))if(.5<overlap){if(Sortable.mark(dropon,"before"),dropon.previousSibling!=element){var oldParentNode=element.parentNode;element.style.visibility="hidden",dropon.parentNode.insertBefore(element,dropon),dropon.parentNode!=oldParentNode&&Sortable.options(oldParentNode).onChange(element),Sortable.options(dropon.parentNode).onChange(element)}}else{Sortable.mark(dropon,"after");var nextElement=dropon.nextSibling||null;if(nextElement!=element){oldParentNode=element.parentNode;element.style.visibility="hidden",dropon.parentNode.insertBefore(element,nextElement),dropon.parentNode!=oldParentNode&&Sortable.options(oldParentNode).onChange(element),Sortable.options(dropon.parentNode).onChange(element)}}},onEmptyHover:function(element,dropon,overlap){var oldParentNode=element.parentNode,droponOptions=Sortable.options(dropon);if(!Element.isParent(dropon,element)){var index,children=Sortable.findElements(dropon,{tag:droponOptions.tag,only:droponOptions.only}),child=null;if(children){var offset=Element.offsetSize(dropon,droponOptions.overlap)*(1-overlap);for(index=0;index<children.length;index+=1){if(!(0<=offset-Element.offsetSize(children[index],droponOptions.overlap))){if(0<=offset-Element.offsetSize(children[index],droponOptions.overlap)/2){child=index+1<children.length?children[index+1]:null;break}child=children[index];break}offset-=Element.offsetSize(children[index],droponOptions.overlap)}}dropon.insertBefore(element,child),Sortable.options(oldParentNode).onChange(element),droponOptions.onChange(element)}},unmark:function(){Sortable._marker&&Sortable._marker.hide()},mark:function(dropon,position){var sortable=Sortable.options(dropon.parentNode);if(!sortable||sortable.ghosting){Sortable._marker||(Sortable._marker=($("dropmarker")||Element.extend(document.createElement("DIV"))).hide().addClassName("dropmarker").setStyle({position:"absolute"}),document.getElementById(PedigreeEditorTool.divId).item(0).appendChild(Sortable._marker));var offsets=dropon.cumulativeOffset();Sortable._marker.setStyle({left:offsets[0]+"px",top:offsets[1]+"px"}),"after"==position&&("horizontal"==sortable.overlap?Sortable._marker.setStyle({left:offsets[0]+dropon.clientWidth+"px"}):Sortable._marker.setStyle({top:offsets[1]+dropon.clientHeight+"px"})),Sortable._marker.show()}},_tree:function(element,options,parent){for(var children=Sortable.findElements(element,options)||[],i=0;i<children.length;++i){var match=children[i].id.match(options.format);if(match){var child={id:encodeURIComponent(match?match[1]:null),element:element,parent:parent,children:[],position:parent.children.length,container:$(children[i]).down(options.treeTag)};child.container&&this._tree(child.container,options,child),parent.children.push(child)}}return parent},tree:function(element){element=$(element);var sortableOptions=this.options(element),options=Object.extend({tag:sortableOptions.tag,treeTag:sortableOptions.treeTag,only:sortableOptions.only,name:element.id,format:sortableOptions.format},arguments[1]||{}),root={id:null,parent:null,children:[],container:element,position:0};return Sortable._tree(element,options,root)},_constructIndex:function(node){for(var index="";node.id&&(index="["+node.position+"]"+index),null!=(node=node.parent););return index},sequence:function(element){element=$(element);var options=Object.extend(this.options(element),arguments[1]||{});return $(this.findElements(element,options)||[]).map(function(item){return item.id.match(options.format)?item.id.match(options.format)[1]:""})},setSequence:function(element,new_sequence){element=$(element);var options=Object.extend(this.options(element),arguments[2]||{}),nodeMap={};this.findElements(element,options).each(function(n){n.id.match(options.format)&&(nodeMap[n.id.match(options.format)[1]]=[n,n.parentNode]),n.parentNode.removeChild(n)}),new_sequence.each(function(ident){var n=nodeMap[ident];n&&(n[1].appendChild(n[0]),delete nodeMap[ident])})},serialize:function(element){element=$(element);var options=Object.extend(Sortable.options(element),arguments[1]||{}),name=encodeURIComponent(arguments[1]&&arguments[1].name?arguments[1].name:element.id);return options.tree?Sortable.tree(element,arguments[1]).children.map(function(item){return[name+Sortable._constructIndex(item)+"[id]="+encodeURIComponent(item.id)].concat(item.children.map(arguments.callee))}).flatten().join("&"):Sortable.sequence(element,arguments[1]).map(function(item){return name+"[]="+encodeURIComponent(item)}).join("&")}};Element.isParent=function(child,element){return!(!child.parentNode||child==element)&&(child.parentNode==element||Element.isParent(child.parentNode,element))},Element.findChildren=function(element,only,recursive,tagName){if(!element.hasChildNodes())return null;tagName=tagName.toUpperCase(),only&&(only=[only].flatten());var elements=[];return $A(element.childNodes).each(function(e){if(!e.tagName||e.tagName.toUpperCase()!=tagName||only&&!Element.classNames(e).detect(function(v){return only.include(v)})||elements.push(e),recursive){var grandchildren=Element.findChildren(e,only,recursive,tagName);grandchildren&&elements.push(grandchildren)}}),0<elements.length?elements.flatten():[]},Element.offsetSize=function(element,type){return element["offset"+("vertical"==type||"height"==type?"Height":"Width")]},function(glob){var current_event,stop,has="hasOwnProperty",separator=/[\.\/]/,fun=function(){},numsort=function(a,b){return a-b},events={n:{}},eve=function(name,scope){var l,oldstop=stop,args=Array.prototype.slice.call(arguments,2),listeners=eve.listeners(name),z=0,indexed=[],queue={},out=[],ce=current_event;current_event=name;for(var i=stop=0,ii=listeners.length;i<ii;i++)"zIndex"in listeners[i]&&(indexed.push(listeners[i].zIndex),listeners[i].zIndex<0&&(queue[listeners[i].zIndex]=listeners[i]));for(indexed.sort(numsort);indexed[z]<0;)if(l=queue[indexed[z++]],out.push(l.apply(scope,args)),stop)return stop=oldstop,out;for(i=0;i<ii;i++)if("zIndex"in(l=listeners[i]))if(l.zIndex==indexed[z]){if(out.push(l.apply(scope,args)),stop)break;do{if((l=queue[indexed[++z]])&&out.push(l.apply(scope,args)),stop)break}while(l)}else queue[l.zIndex]=l;else if(out.push(l.apply(scope,args)),stop)break;return stop=oldstop,current_event=ce,out.length?out:null};eve.listeners=function(name){var item,items,k,i,ii,j,jj,nes,names=name.split(separator),e=events,es=[e],out=[];for(i=0,ii=names.length;i<ii;i++){for(nes=[],j=0,jj=es.length;j<jj;j++)for(items=[(e=es[j].n)[names[i]],e["*"]],k=2;k--;)(item=items[k])&&(nes.push(item),out=out.concat(item.f||[]));es=nes}return out},eve.on=function(name,f){for(var names=name.split(separator),e=events,i=0,ii=names.length;i<ii;i++)!(e=e.n)[names[i]]&&(e[names[i]]={n:{}}),e=e[names[i]];for(e.f=e.f||[],i=0,ii=e.f.length;i<ii;i++)if(e.f[i]==f)return fun;return e.f.push(f),function(zIndex){+zIndex==+zIndex&&(f.zIndex=+zIndex)}},eve.stop=function(){stop=1},eve.nt=function(subname){return subname?new RegExp("(?:\\.|\\/|^)"+subname+"(?:\\.|\\/|$)").test(current_event):current_event},eve.off=eve.unbind=function(name,f){var e,key,splice,i,ii,j,jj,names=name.split(separator),cur=[events];for(i=0,ii=names.length;i<ii;i++)for(j=0;j<cur.length;j+=splice.length-2){if(splice=[j,1],e=cur[j].n,"*"!=names[i])e[names[i]]&&splice.push(e[names[i]]);else for(key in e)e[has](key)&&splice.push(e[key]);cur.splice.apply(cur,splice)}for(i=0,ii=cur.length;i<ii;i++)for(e=cur[i];e.n;){if(f){if(e.f){for(j=0,jj=e.f.length;j<jj;j++)if(e.f[j]==f){e.f.splice(j,1);break}!e.f.length&&delete e.f}for(key in e.n)if(e.n[has](key)&&e.n[key].f){var funcs=e.n[key].f;for(j=0,jj=funcs.length;j<jj;j++)if(funcs[j]==f){funcs.splice(j,1);break}!funcs.length&&delete e.n[key].f}}else for(key in delete e.f,e.n)e.n[has](key)&&e.n[key].f&&delete e.n[key].f;e=e.n}},eve.once=function(name,f){var f2=function(){var res=f.apply(this,arguments);return eve.unbind(name,f2),res};return eve.on(name,f2)},eve.version="0.3.4",eve.toString=function(){return"You are running Eve 0.3.4"},"undefined"!=typeof module&&module.exports?module.exports=eve:void 0!==define?define("eve",[],function(){return eve}):glob.eve=eve,glob.eve=eve}(this),function(){function R(first){if(R.is(first,"function"))return loaded?first():eve.on("raphael.DOMload",first);if(R.is(first,array))return R._engine.create[apply](R,first.splice(0,3+R.is(first[0],nu))).add(first);var args=Array.prototype.slice.call(arguments,0);if(R.is(args[args.length-1],"function")){var f=args.pop();return loaded?f.call(R._engine.create[apply](R,args)):eve.on("raphael.DOMload",function(){f.call(R._engine.create[apply](R,args))})}return R._engine.create[apply](R,arguments)}R.version="2.1.0",R.eve=eve;var loaded,paperproto,separator=/[, ]+/,elements={circle:1,rect:1,path:1,ellipse:1,text:1,image:1},formatrg=/\{(\d+)\}/g,has="hasOwnProperty",g={doc:document,win:window},oldRaphael={was:Object.prototype[has].call(g.win,"Raphael"),is:g.win.Raphael},Paper=function(){this.ca=this.customAttributes={}},apply="apply",concat="concat",E="",S=" ",Str=String,split="split",events="click dblclick mousedown mousemove mouseout mouseover mouseup touchstart touchmove touchend touchcancel"[split](S),lowerCase=Str.prototype.toLowerCase,math=Math,mmax=math.max,mmin=math.min,abs=math.abs,pow=math.pow,PI=math.PI,nu="number",array="array",objectToString=Object.prototype.toString,colourRegExp=(R._ISURL=/^url\(['"]?([^\)]+?)['"]?\)$/i,/^\s*((#[a-f\d]{6})|(#[a-f\d]{3})|rgba?\(\s*([\d\.]+%?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+%?(?:\s*,\s*[\d\.]+%?)?)\s*\)|hsba?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\)|hsla?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\))\s*$/i),isnan={NaN:1,Infinity:1,"-Infinity":1},bezierrg=/^(?:cubic-)?bezier\(([^,]+),([^,]+),([^,]+),([^\)]+)\)/,round=math.round,toFloat=parseFloat,toInt=parseInt,upperCase=Str.prototype.toUpperCase,availableAttrs=R._availableAttrs={"arrow-end":"none","arrow-start":"none",blur:0,"clip-rect":"0 0 1e9 1e9",cursor:"default",cx:0,cy:0,fill:"#fff","fill-opacity":1,"font-family":'"Arial"',"font-size":"10","font-style":"normal","font-weight":400,gradient:0,height:0,href:"http://raphaeljs.com/","letter-spacing":0,opacity:1,path:"M0,0",r:0,rx:0,ry:0,src:"",stroke:"#000","stroke-dasharray":"","stroke-linecap":"butt","stroke-linejoin":"butt","stroke-miterlimit":0,"stroke-opacity":1,"stroke-width":1,target:"_blank","text-anchor":"middle",title:"Raphael",transform:"",width:0,x:0,y:0},availableAnimAttrs=R._availableAnimAttrs={blur:nu,"clip-rect":"csv",cx:nu,cy:nu,fill:"colour","fill-opacity":nu,"font-size":nu,height:nu,opacity:nu,path:"path",r:nu,rx:nu,ry:nu,stroke:"colour","stroke-opacity":nu,"stroke-width":nu,transform:"transform",width:nu,x:nu,y:nu},commaSpaces=/[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/,hsrg={hs:1,rg:1},p2s=/,?([achlmqrstvxz]),?/gi,pathCommand=/([achlmrqstvz])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/gi,tCommand=/([rstm])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/gi,pathValues=/(-?\d*\.?\d*(?:e[\-+]?\d+)?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/gi,eldata=(R._radial_gradient=/^r(?:\(([^,]+?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*([^\)]+?)\))?/,{}),sortByNumber=function(a,b){return toFloat(a)-toFloat(b)},pipe=function(x){return x},rectPath=R._rectPath=function(x,y,w,h,r){return r?[["M",x+r,y],["l",w-2*r,0],["a",r,r,0,0,1,r,r],["l",0,h-2*r],["a",r,r,0,0,1,-r,r],["l",2*r-w,0],["a",r,r,0,0,1,-r,-r],["l",0,2*r-h],["a",r,r,0,0,1,r,-r],["z"]]:[["M",x,y],["l",w,0],["l",0,h],["l",-w,0],["z"]]},ellipsePath=function(x,y,rx,ry){return null==ry&&(ry=rx),[["M",x,y],["m",0,-ry],["a",rx,ry,0,1,1,0,2*ry],["a",rx,ry,0,1,1,0,-2*ry],["z"]]},getPath=R._getPath={path:function(el){return el.attr("path")},circle:function(el){var a=el.attrs;return ellipsePath(a.cx,a.cy,a.r)},ellipse:function(el){var a=el.attrs;return ellipsePath(a.cx,a.cy,a.rx,a.ry)},rect:function(el){var a=el.attrs;return rectPath(a.x,a.y,a.width,a.height,a.r)},image:function(el){var a=el.attrs;return rectPath(a.x,a.y,a.width,a.height)},text:function(el){var bbox=el._getBBox();return rectPath(bbox.x,bbox.y,bbox.width,bbox.height)}},mapPath=R.mapPath=function(path,matrix){if(!matrix)return path;var x,y,i,j,ii,jj,pathi;for(i=0,ii=(path=path2curve(path)).length;i<ii;i++)for(j=1,jj=(pathi=path[i]).length;j<jj;j+=2)x=matrix.x(pathi[j],pathi[j+1]),y=matrix.y(pathi[j],pathi[j+1]),pathi[j]=x,pathi[j+1]=y;return path};if(R._g=g,"VML"==(R.type=g.win.SVGAngle||g.doc.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")?"SVG":"VML")){var b,d=g.doc.createElement("div");if(d.innerHTML='<v:shape adj="1"/>',(b=d.firstChild).style.behavior="url(#default#VML)",!b||"object"!=typeof b.adj)return R.type=E;d=null}function clone(obj){if(Object(obj)!==obj||"function"==typeof obj)return obj;var res=new obj.constructor;for(var key in obj)obj[has](key)&&("object"==typeof obj[key]?res[key]=clone(obj[key]):res[key]=obj[key]);return res}R.svg=!(R.vml="VML"==R.type),R._Paper=Paper,R.fn=paperproto=Paper.prototype=R.prototype,R._id=0,R._oid=0,R.is=function(o,type){return"finite"==(type=lowerCase.call(type))?!isnan[has](+o):"array"==type?o instanceof Array:"null"==type&&null===o||type==typeof o&&null!==o||"object"==type&&o===Object(o)||"array"==type&&Array.isArray&&Array.isArray(o)||objectToString.call(o).slice(8,-1).toLowerCase()==type},R.angle=function(x1,y1,x2,y2,x3,y3){if(null!=x3)return R.angle(x1,y1,x3,y3)-R.angle(x2,y2,x3,y3);var x=x1-x2,y=y1-y2;return x||y?(180+180*math.atan2(-y,-x)/PI+360)%360:0},R.rad=function(deg){return deg%360*PI/180},R.deg=function(rad){return 180*rad/PI%360},R.snapTo=function(values,value,tolerance){if(tolerance=R.is(tolerance,"finite")?tolerance:10,R.is(values,array)){for(var i=values.length;i--;)if(abs(values[i]-value)<=tolerance)return values[i]}else{var rem=value%(values=+values);if(rem<tolerance)return value-rem;if(values-tolerance<rem)return value-rem+values}return value};var uuidRegEx,uuidReplacer;R.createUUID=(uuidRegEx=/[xy]/g,uuidReplacer=function(c){var r=16*math.random()|0;return("x"==c?r:3&r|8).toString(16)},function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(uuidRegEx,uuidReplacer).toUpperCase()});R.setWindow=function(newwin){eve("raphael.setWindow",R,g.win,newwin),g.win=newwin,g.doc=g.win.document,R._engine.initWin&&R._engine.initWin(g.win)};var toHex=function(color){if(R.vml){var bod,trim=/^\s+|\s+$/g;try{var docum=new ActiveXObject("htmlfile");docum.write("<body>"),docum.close(),bod=docum.body}catch(e){bod=createPopup().document.body}var range=bod.createTextRange();toHex=cacher(function(color){try{bod.style.color=Str(color).replace(trim,E);var value=range.queryCommandValue("ForeColor");return"#"+("000000"+(value=(255&value)<<16|65280&value|(16711680&value)>>>16).toString(16)).slice(-6)}catch(e){return"none"}})}else{var i=g.doc.createElement("i");i.title="Raphal Colour Picker",i.style.display="none",g.doc.body.appendChild(i),toHex=cacher(function(color){return i.style.color=color,g.doc.defaultView.getComputedStyle(i,E).getPropertyValue("color")})}return toHex(color)},hsbtoString=function(){return"hsb("+[this.h,this.s,this.b]+")"},hsltoString=function(){return"hsl("+[this.h,this.s,this.l]+")"},rgbtoString=function(){return this.hex},prepareRGB=function(r,g,b){if(null==g&&R.is(r,"object")&&"r"in r&&"g"in r&&"b"in r&&(b=r.b,g=r.g,r=r.r),null==g&&R.is(r,"string")){var clr=R.getRGB(r);r=clr.r,g=clr.g,b=clr.b}return(1<r||1<g||1<b)&&(r/=255,g/=255,b/=255),[r,g,b]},packageRGB=function(r,g,b,o){var rgb={r:r*=255,g:g*=255,b:b*=255,hex:R.rgb(r,g,b),toString:rgbtoString};return R.is(o,"finite")&&(rgb.opacity=o),rgb};function cacher(f,scope,postprocessor){return function newf(){var arg=Array.prototype.slice.call(arguments,0),args=arg.join(""),cache=newf.cache=newf.cache||{},count=newf.count=newf.count||[];return cache[has](args)?function(array,item){for(var i=0,ii=array.length;i<ii;i++)if(array[i]===item)return array.push(array.splice(i,1)[0])}(count,args):(1e3<=count.length&&delete cache[count.shift()],count.push(args),cache[args]=f[apply](scope,arg)),postprocessor?postprocessor(cache[args]):cache[args]}}R.color=function(clr){var rgb;return R.is(clr,"object")&&"h"in clr&&"s"in clr&&"b"in clr?(rgb=R.hsb2rgb(clr),clr.r=rgb.r,clr.g=rgb.g,clr.b=rgb.b,clr.hex=rgb.hex):R.is(clr,"object")&&"h"in clr&&"s"in clr&&"l"in clr?(rgb=R.hsl2rgb(clr),clr.r=rgb.r,clr.g=rgb.g,clr.b=rgb.b,clr.hex=rgb.hex):(R.is(clr,"string")&&(clr=R.getRGB(clr)),R.is(clr,"object")&&"r"in clr&&"g"in clr&&"b"in clr?(rgb=R.rgb2hsl(clr),clr.h=rgb.h,clr.s=rgb.s,clr.l=rgb.l,rgb=R.rgb2hsb(clr),clr.v=rgb.b):(clr={hex:"none"}).r=clr.g=clr.b=clr.h=clr.s=clr.v=clr.l=-1),clr.toString=rgbtoString,clr},R.hsb2rgb=function(h,s,v,o){var R,G,B,X,C;return this.is(h,"object")&&"h"in h&&"s"in h&&"b"in h&&(v=h.b,s=h.s,o=(h=h.h).o),X=(C=v*s)*(1-abs((h=(h*=360)%360/60)%2-1)),R=G=B=v-C,packageRGB(R+=[C,X,0,0,X,C][h=~~h],G+=[X,C,C,X,0,0][h],B+=[0,0,X,C,C,X][h],o)},R.hsl2rgb=function(h,s,l,o){var R,G,B,X,C;return this.is(h,"object")&&"h"in h&&"s"in h&&"l"in h&&(l=h.l,s=h.s,h=h.h),(1<h||1<s||1<l)&&(h/=360,s/=100,l/=100),X=(C=2*s*(l<.5?l:1-l))*(1-abs((h=(h*=360)%360/60)%2-1)),R=G=B=l-C/2,packageRGB(R+=[C,X,0,0,X,C][h=~~h],G+=[X,C,C,X,0,0][h],B+=[0,0,X,C,C,X][h],o)},R.rgb2hsb=function(r,g,b){var V,C;return r=(b=prepareRGB(r,g,b))[0],g=b[1],b=b[2],{h:((0==(C=(V=mmax(r,g,b))-mmin(r,g,b))?null:V==r?(g-b)/C:V==g?(b-r)/C+2:(r-g)/C+4)+360)%6*60/360,s:0==C?0:C/V,b:V,toString:hsbtoString}},R.rgb2hsl=function(r,g,b){var L,M,m,C;return r=(b=prepareRGB(r,g,b))[0],g=b[1],b=b[2],L=((M=mmax(r,g,b))+(m=mmin(r,g,b)))/2,{h:((0==(C=M-m)?null:M==r?(g-b)/C:M==g?(b-r)/C+2:(r-g)/C+4)+360)%6*60/360,s:0==C?0:L<.5?C/(2*L):C/(2-2*L),l:L,toString:hsltoString}},R._path2string=function(){return this.join(",").replace(p2s,"$1")};R._preload=function(src,f){var img=g.doc.createElement("img");img.style.cssText="position:absolute;left:-9999em;top:-9999em",img.onload=function(){f.call(this),this.onload=null,g.doc.body.removeChild(this)},img.onerror=function(){g.doc.body.removeChild(this)},g.doc.body.appendChild(img),img.src=src};function clrToString(){return this.hex}function catmullRom2bezier(crp,z){for(var d=[],i=0,iLen=crp.length;i<iLen-2*!z;i+=2){var p=[{x:+crp[i-2],y:+crp[i-1]},{x:+crp[i],y:+crp[i+1]},{x:+crp[i+2],y:+crp[i+3]},{x:+crp[i+4],y:+crp[i+5]}];z?i?iLen-4==i?p[3]={x:+crp[0],y:+crp[1]}:iLen-2==i&&(p[2]={x:+crp[0],y:+crp[1]},p[3]={x:+crp[2],y:+crp[3]}):p[0]={x:+crp[iLen-2],y:+crp[iLen-1]}:iLen-4==i?p[3]=p[2]:i||(p[0]={x:+crp[i],y:+crp[i+1]}),d.push(["C",(-p[0].x+6*p[1].x+p[2].x)/6,(-p[0].y+6*p[1].y+p[2].y)/6,(p[1].x+6*p[2].x-p[3].x)/6,(p[1].y+6*p[2].y-p[3].y)/6,p[2].x,p[2].y])}return d}R.getRGB=cacher(function(colour){if(!colour||(colour=Str(colour)).indexOf("-")+1)return{r:-1,g:-1,b:-1,hex:"none",error:1,toString:clrToString};if("none"==colour)return{r:-1,g:-1,b:-1,hex:"none",toString:clrToString};!hsrg[has](colour.toLowerCase().substring(0,2))&&"#"!=colour.charAt()&&(colour=toHex(colour));var red,green,blue,opacity,t,values,rgb=colour.match(colourRegExp);return rgb?(rgb[2]&&(blue=toInt(rgb[2].substring(5),16),green=toInt(rgb[2].substring(3,5),16),red=toInt(rgb[2].substring(1,3),16)),rgb[3]&&(blue=toInt((t=rgb[3].charAt(3))+t,16),green=toInt((t=rgb[3].charAt(2))+t,16),red=toInt((t=rgb[3].charAt(1))+t,16)),rgb[4]&&(values=rgb[4][split](commaSpaces),red=toFloat(values[0]),"%"==values[0].slice(-1)&&(red*=2.55),green=toFloat(values[1]),"%"==values[1].slice(-1)&&(green*=2.55),blue=toFloat(values[2]),"%"==values[2].slice(-1)&&(blue*=2.55),"rgba"==rgb[1].toLowerCase().slice(0,4)&&(opacity=toFloat(values[3])),values[3]&&"%"==values[3].slice(-1)&&(opacity/=100)),rgb[5]?(values=rgb[5][split](commaSpaces),red=toFloat(values[0]),"%"==values[0].slice(-1)&&(red*=2.55),green=toFloat(values[1]),"%"==values[1].slice(-1)&&(green*=2.55),blue=toFloat(values[2]),"%"==values[2].slice(-1)&&(blue*=2.55),("deg"==values[0].slice(-3)||""==values[0].slice(-1))&&(red/=360),"hsba"==rgb[1].toLowerCase().slice(0,4)&&(opacity=toFloat(values[3])),values[3]&&"%"==values[3].slice(-1)&&(opacity/=100),R.hsb2rgb(red,green,blue,opacity)):rgb[6]?(values=rgb[6][split](commaSpaces),red=toFloat(values[0]),"%"==values[0].slice(-1)&&(red*=2.55),green=toFloat(values[1]),"%"==values[1].slice(-1)&&(green*=2.55),blue=toFloat(values[2]),"%"==values[2].slice(-1)&&(blue*=2.55),("deg"==values[0].slice(-3)||""==values[0].slice(-1))&&(red/=360),"hsla"==rgb[1].toLowerCase().slice(0,4)&&(opacity=toFloat(values[3])),values[3]&&"%"==values[3].slice(-1)&&(opacity/=100),R.hsl2rgb(red,green,blue,opacity)):((rgb={r:red,g:green,b:blue,toString:clrToString}).hex="#"+(16777216|blue|green<<8|red<<16).toString(16).slice(1),R.is(opacity,"finite")&&(rgb.opacity=opacity),rgb)):{r:-1,g:-1,b:-1,hex:"none",error:1,toString:clrToString}},R),R.hsb=cacher(function(h,s,b){return R.hsb2rgb(h,s,b).hex}),R.hsl=cacher(function(h,s,l){return R.hsl2rgb(h,s,l).hex}),R.rgb=cacher(function(r,g,b){return"#"+(16777216|b|g<<8|r<<16).toString(16).slice(1)}),(R.getColor=function(value){var start=this.getColor.start=this.getColor.start||{h:0,s:1,b:value||.75},rgb=this.hsb2rgb(start.h,start.s,start.b);return start.h+=.075,1<start.h&&(start.h=0,start.s-=.2,start.s<=0&&(this.getColor.start={h:0,s:1,b:start.b})),rgb.hex}).reset=function(){delete this.start},R.parsePathString=function(pathString){if(!pathString)return null;var pth=paths(pathString);if(pth.arr)return pathClone(pth.arr);var paramCounts={a:7,c:6,h:1,l:2,m:2,r:4,q:4,s:4,t:2,v:1,z:0},data=[];return R.is(pathString,array)&&R.is(pathString[0],array)&&(data=pathClone(pathString)),data.length||Str(pathString).replace(pathCommand,function(a,b,c){var params=[],name=b.toLowerCase();if(c.replace(pathValues,function(a,b){b&&params.push(+b)}),"m"==name&&2<params.length&&(data.push([b][concat](params.splice(0,2))),name="l",b="m"==b?"l":"L"),"r"==name)data.push([b][concat](params));else for(;params.length>=paramCounts[name]&&(data.push([b][concat](params.splice(0,paramCounts[name]))),paramCounts[name]););}),data.toString=R._path2string,pth.arr=pathClone(data),data},R.parseTransformString=cacher(function(TString){if(!TString)return null;var data=[];return R.is(TString,array)&&R.is(TString[0],array)&&(data=pathClone(TString)),data.length||Str(TString).replace(tCommand,function(a,b,c){var params=[];lowerCase.call(b);c.replace(pathValues,function(a,b){b&&params.push(+b)}),data.push([b][concat](params))}),data.toString=R._path2string,data});var paths=function(ps){var p=paths.ps=paths.ps||{};return p[ps]?p[ps].sleep=100:p[ps]={sleep:100},setTimeout(function(){for(var key in p)p[has](key)&&key!=ps&&(p[key].sleep--,!p[key].sleep&&delete p[key])}),p[ps]};function base3(t,p1,p2,p3,p4){return t*(t*(-3*p1+9*p2-9*p3+3*p4)+6*p1-12*p2+6*p3)-3*p1+3*p2}function bezlen(x1,y1,x2,y2,x3,y3,x4,y4,z){null==z&&(z=1);for(var z2=(z=1<z?1:z<0?0:z)/2,Tvalues=[-.1252,.1252,-.3678,.3678,-.5873,.5873,-.7699,.7699,-.9041,.9041,-.9816,.9816],Cvalues=[.2491,.2491,.2335,.2335,.2032,.2032,.1601,.1601,.1069,.1069,.0472,.0472],sum=0,i=0;i<12;i++){var ct=z2*Tvalues[i]+z2,xbase=base3(ct,x1,x2,x3,x4),ybase=base3(ct,y1,y2,y3,y4),comb=xbase*xbase+ybase*ybase;sum+=Cvalues[i]*math.sqrt(comb)}return z2*sum}function intersect(x1,y1,x2,y2,x3,y3,x4,y4){if(!(mmax(x1,x2)<mmin(x3,x4)||mmin(x1,x2)>mmax(x3,x4)||mmax(y1,y2)<mmin(y3,y4)||mmin(y1,y2)>mmax(y3,y4))){var denominator=(x1-x2)*(y3-y4)-(y1-y2)*(x3-x4);if(denominator){var px=((x1*y2-y1*x2)*(x3-x4)-(x1-x2)*(x3*y4-y3*x4))/denominator,py=((x1*y2-y1*x2)*(y3-y4)-(y1-y2)*(x3*y4-y3*x4))/denominator,px2=+px.toFixed(2),py2=+py.toFixed(2);if(!(px2<+mmin(x1,x2).toFixed(2)||px2>+mmax(x1,x2).toFixed(2)||px2<+mmin(x3,x4).toFixed(2)||px2>+mmax(x3,x4).toFixed(2)||py2<+mmin(y1,y2).toFixed(2)||py2>+mmax(y1,y2).toFixed(2)||py2<+mmin(y3,y4).toFixed(2)||py2>+mmax(y3,y4).toFixed(2)))return{x:px,y:py}}}}function interHelper(bez1,bez2,justCount){var bbox1=R.bezierBBox(bez1),bbox2=R.bezierBBox(bez2);if(!R.isBBoxIntersect(bbox1,bbox2))return justCount?0:[];for(var n1=~~(bezlen.apply(0,bez1)/5),n2=~~(bezlen.apply(0,bez2)/5),dots1=[],dots2=[],xy={},res=justCount?0:[],i=0;i<n1+1;i++){var p=R.findDotsAtSegment.apply(R,bez1.concat(i/n1));dots1.push({x:p.x,y:p.y,t:i/n1})}for(i=0;i<n2+1;i++)p=R.findDotsAtSegment.apply(R,bez2.concat(i/n2)),dots2.push({x:p.x,y:p.y,t:i/n2});for(i=0;i<n1;i++)for(var j=0;j<n2;j++){var di=dots1[i],di1=dots1[i+1],dj=dots2[j],dj1=dots2[j+1],ci=abs(di1.x-di.x)<.001?"y":"x",cj=abs(dj1.x-dj.x)<.001?"y":"x",is=intersect(di.x,di.y,di1.x,di1.y,dj.x,dj.y,dj1.x,dj1.y);if(is){if(xy[is.x.toFixed(4)]==is.y.toFixed(4))continue;xy[is.x.toFixed(4)]=is.y.toFixed(4);var t1=di.t+abs((is[ci]-di[ci])/(di1[ci]-di[ci]))*(di1.t-di.t),t2=dj.t+abs((is[cj]-dj[cj])/(dj1[cj]-dj[cj]))*(dj1.t-dj.t);0<=t1&&t1<=1&&0<=t2&&t2<=1&&(justCount?res++:res.push({x:is.x,y:is.y,t1:t1,t2:t2}))}}return res}function interPathHelper(path1,path2,justCount){path1=R._path2curve(path1),path2=R._path2curve(path2);for(var x1,y1,x2,y2,x1m,y1m,x2m,y2m,bez1,bez2,res=justCount?0:[],i=0,ii=path1.length;i<ii;i++){var pi=path1[i];if("M"==pi[0])x1=x1m=pi[1],y1=y1m=pi[2];else{y1="C"==pi[0]?(x1=(bez1=[x1,y1].concat(pi.slice(1)))[6],bez1[7]):(bez1=[x1,y1,x1,y1,x1m,y1m,x1m,y1m],x1=x1m,y1m);for(var j=0,jj=path2.length;j<jj;j++){var pj=path2[j];if("M"==pj[0])x2=x2m=pj[1],y2=y2m=pj[2];else{y2="C"==pj[0]?(x2=(bez2=[x2,y2].concat(pj.slice(1)))[6],bez2[7]):(bez2=[x2,y2,x2,y2,x2m,y2m,x2m,y2m],x2=x2m,y2m);var intr=interHelper(bez1,bez2,justCount);if(justCount)res+=intr;else{for(var k=0,kk=intr.length;k<kk;k++)intr[k].segment1=i,intr[k].segment2=j,intr[k].bez1=bez1,intr[k].bez2=bez2;res=res.concat(intr)}}}}}return res}R.findDotsAtSegment=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t){var t1=1-t,t13=pow(t1,3),t12=pow(t1,2),t2=t*t,t3=t2*t,x=t13*p1x+3*t12*t*c1x+3*t1*t*t*c2x+t3*p2x,y=t13*p1y+3*t12*t*c1y+3*t1*t*t*c2y+t3*p2y,mx=p1x+2*t*(c1x-p1x)+t2*(c2x-2*c1x+p1x),my=p1y+2*t*(c1y-p1y)+t2*(c2y-2*c1y+p1y),nx=c1x+2*t*(c2x-c1x)+t2*(p2x-2*c2x+c1x),ny=c1y+2*t*(c2y-c1y)+t2*(p2y-2*c2y+c1y),ax=t1*p1x+t*c1x,ay=t1*p1y+t*c1y,cx=t1*c2x+t*p2x,cy=t1*c2y+t*p2y,alpha=90-180*math.atan2(mx-nx,my-ny)/PI;return(nx<mx||my<ny)&&(alpha+=180),{x:x,y:y,m:{x:mx,y:my},n:{x:nx,y:ny},start:{x:ax,y:ay},end:{x:cx,y:cy},alpha:alpha}},R.bezierBBox=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y){R.is(p1x,"array")||(p1x=[p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y]);var bbox=curveDim.apply(null,p1x);return{x:bbox.min.x,y:bbox.min.y,x2:bbox.max.x,y2:bbox.max.y,width:bbox.max.x-bbox.min.x,height:bbox.max.y-bbox.min.y}},R.isPointInsideBBox=function(bbox,x,y){return x>=bbox.x&&x<=bbox.x2&&y>=bbox.y&&y<=bbox.y2},R.isBBoxIntersect=function(bbox1,bbox2){var i=R.isPointInsideBBox;return i(bbox2,bbox1.x,bbox1.y)||i(bbox2,bbox1.x2,bbox1.y)||i(bbox2,bbox1.x,bbox1.y2)||i(bbox2,bbox1.x2,bbox1.y2)||i(bbox1,bbox2.x,bbox2.y)||i(bbox1,bbox2.x2,bbox2.y)||i(bbox1,bbox2.x,bbox2.y2)||i(bbox1,bbox2.x2,bbox2.y2)||(bbox1.x<bbox2.x2&&bbox1.x>bbox2.x||bbox2.x<bbox1.x2&&bbox2.x>bbox1.x)&&(bbox1.y<bbox2.y2&&bbox1.y>bbox2.y||bbox2.y<bbox1.y2&&bbox2.y>bbox1.y)},R.pathIntersection=function(path1,path2){return interPathHelper(path1,path2)},R.pathIntersectionNumber=function(path1,path2){return interPathHelper(path1,path2,1)},R.isPointInsidePath=function(path,x,y){var bbox=R.pathBBox(path);return R.isPointInsideBBox(bbox,x,y)&&interPathHelper(path,[["M",x,y],["H",bbox.x2+10]],1)%2==1},R._removedFactory=function(methodname){return function(){eve("raphael.log",null,"Raphal: you are calling to method "+methodname+" of removed object",methodname)}};var pathDimensions=R.pathBBox=function(path){var pth=paths(path);if(pth.bbox)return pth.bbox;if(!path)return{x:0,y:0,width:0,height:0,x2:0,y2:0};for(var p,x=0,y=0,X=[],Y=[],i=0,ii=(path=path2curve(path)).length;i<ii;i++)if("M"==(p=path[i])[0])x=p[1],y=p[2],X.push(x),Y.push(y);else{var dim=curveDim(x,y,p[1],p[2],p[3],p[4],p[5],p[6]);X=X[concat](dim.min.x,dim.max.x),Y=Y[concat](dim.min.y,dim.max.y),x=p[5],y=p[6]}var xmin=mmin[apply](0,X),ymin=mmin[apply](0,Y),xmax=mmax[apply](0,X),ymax=mmax[apply](0,Y),bb={x:xmin,y:ymin,x2:xmax,y2:ymax,width:xmax-xmin,height:ymax-ymin};return pth.bbox=clone(bb),bb},pathClone=function(pathArray){var res=clone(pathArray);return res.toString=R._path2string,res},pathToRelative=R._pathToRelative=function(pathArray){var pth=paths(pathArray);if(pth.rel)return pathClone(pth.rel);R.is(pathArray,array)&&R.is(pathArray&&pathArray[0],array)||(pathArray=R.parsePathString(pathArray));var res=[],x=0,y=0,mx=0,my=0,start=0;"M"==pathArray[0][0]&&(mx=x=pathArray[0][1],my=y=pathArray[0][2],start++,res.push(["M",x,y]));for(var i=start,ii=pathArray.length;i<ii;i++){var r=res[i]=[],pa=pathArray[i];if(pa[0]!=lowerCase.call(pa[0]))switch(r[0]=lowerCase.call(pa[0]),r[0]){case"a":r[1]=pa[1],r[2]=pa[2],r[3]=pa[3],r[4]=pa[4],r[5]=pa[5],r[6]=+(pa[6]-x).toFixed(3),r[7]=+(pa[7]-y).toFixed(3);break;case"v":r[1]=+(pa[1]-y).toFixed(3);break;case"m":mx=pa[1],my=pa[2];default:for(var j=1,jj=pa.length;j<jj;j++)r[j]=+(pa[j]-(j%2?x:y)).toFixed(3)}else{r=res[i]=[],"m"==pa[0]&&(mx=pa[1]+x,my=pa[2]+y);for(var k=0,kk=pa.length;k<kk;k++)res[i][k]=pa[k]}var len=res[i].length;switch(res[i][0]){case"z":x=mx,y=my;break;case"h":x+=+res[i][len-1];break;case"v":y+=+res[i][len-1];break;default:x+=+res[i][len-2],y+=+res[i][len-1]}}return res.toString=R._path2string,pth.rel=pathClone(res),res},pathToAbsolute=R._pathToAbsolute=function(pathArray){var pth=paths(pathArray);if(pth.abs)return pathClone(pth.abs);if(R.is(pathArray,array)&&R.is(pathArray&&pathArray[0],array)||(pathArray=R.parsePathString(pathArray)),!pathArray||!pathArray.length)return[["M",0,0]];var res=[],x=0,y=0,mx=0,my=0,start=0;"M"==pathArray[0][0]&&(mx=x=+pathArray[0][1],my=y=+pathArray[0][2],start++,res[0]=["M",x,y]);for(var r,pa,crz=3==pathArray.length&&"M"==pathArray[0][0]&&"R"==pathArray[1][0].toUpperCase()&&"Z"==pathArray[2][0].toUpperCase(),i=start,ii=pathArray.length;i<ii;i++){if(res.push(r=[]),(pa=pathArray[i])[0]!=upperCase.call(pa[0]))switch(r[0]=upperCase.call(pa[0]),r[0]){case"A":r[1]=pa[1],r[2]=pa[2],r[3]=pa[3],r[4]=pa[4],r[5]=pa[5],r[6]=+(pa[6]+x),r[7]=+(pa[7]+y);break;case"V":r[1]=+pa[1]+y;break;case"H":r[1]=+pa[1]+x;break;case"R":for(var dots=[x,y][concat](pa.slice(1)),j=2,jj=dots.length;j<jj;j++)dots[j]=+dots[j]+x,dots[++j]=+dots[j]+y;res.pop(),res=res[concat](catmullRom2bezier(dots,crz));break;case"M":mx=+pa[1]+x,my=+pa[2]+y;default:for(j=1,jj=pa.length;j<jj;j++)r[j]=+pa[j]+(j%2?x:y)}else if("R"==pa[0])dots=[x,y][concat](pa.slice(1)),res.pop(),res=res[concat](catmullRom2bezier(dots,crz)),r=["R"][concat](pa.slice(-2));else for(var k=0,kk=pa.length;k<kk;k++)r[k]=pa[k];switch(r[0]){case"Z":x=mx,y=my;break;case"H":x=r[1];break;case"V":y=r[1];break;case"M":mx=r[r.length-2],my=r[r.length-1];default:x=r[r.length-2],y=r[r.length-1]}}return res.toString=R._path2string,pth.abs=pathClone(res),res},l2c=function(x1,y1,x2,y2){return[x1,y1,x2,y2,x2,y2]},q2c=function(x1,y1,ax,ay,x2,y2){return[1/3*x1+2/3*ax,1/3*y1+2/3*ay,1/3*x2+2/3*ax,1/3*y2+2/3*ay,x2,y2]},a2c=function(x1,y1,rx,ry,angle,large_arc_flag,sweep_flag,x2,y2,recursive){var xy,_120=120*PI/180,rad=PI/180*(+angle||0),res=[],rotate=cacher(function(x,y,rad){return{x:x*math.cos(rad)-y*math.sin(rad),y:x*math.sin(rad)+y*math.cos(rad)}});if(recursive)f1=recursive[0],f2=recursive[1],cx=recursive[2],cy=recursive[3];else{x1=(xy=rotate(x1,y1,-rad)).x,y1=xy.y,x2=(xy=rotate(x2,y2,-rad)).x,y2=xy.y;math.cos(PI/180*angle),math.sin(PI/180*angle);var x=(x1-x2)/2,y=(y1-y2)/2,h=x*x/(rx*rx)+y*y/(ry*ry);1<h&&(rx*=h=math.sqrt(h),ry*=h);var rx2=rx*rx,ry2=ry*ry,k=(large_arc_flag==sweep_flag?-1:1)*math.sqrt(abs((rx2*ry2-rx2*y*y-ry2*x*x)/(rx2*y*y+ry2*x*x))),cx=k*rx*y/ry+(x1+x2)/2,cy=k*-ry*x/rx+(y1+y2)/2,f1=math.asin(((y1-cy)/ry).toFixed(9)),f2=math.asin(((y2-cy)/ry).toFixed(9));(f1=x1<cx?PI-f1:f1)<0&&(f1=2*PI+f1),(f2=x2<cx?PI-f2:f2)<0&&(f2=2*PI+f2),sweep_flag&&f2<f1&&(f1-=2*PI),!sweep_flag&&f1<f2&&(f2-=2*PI)}var df=f2-f1;if(abs(df)>_120){var f2old=f2,x2old=x2,y2old=y2;f2=f1+_120*(sweep_flag&&f1<f2?1:-1),x2=cx+rx*math.cos(f2),y2=cy+ry*math.sin(f2),res=a2c(x2,y2,rx,ry,angle,0,sweep_flag,x2old,y2old,[f2,f2old,cx,cy])}df=f2-f1;var c1=math.cos(f1),s1=math.sin(f1),c2=math.cos(f2),s2=math.sin(f2),t=math.tan(df/4),hx=4/3*rx*t,hy=4/3*ry*t,m1=[x1,y1],m2=[x1+hx*s1,y1-hy*c1],m3=[x2+hx*s2,y2-hy*c2],m4=[x2,y2];if(m2[0]=2*m1[0]-m2[0],m2[1]=2*m1[1]-m2[1],recursive)return[m2,m3,m4][concat](res);for(var newres=[],i=0,ii=(res=[m2,m3,m4][concat](res).join()[split](",")).length;i<ii;i++)newres[i]=i%2?rotate(res[i-1],res[i],rad).y:rotate(res[i],res[i+1],rad).x;return newres},findDotAtSegment=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t){var t1=1-t;return{x:pow(t1,3)*p1x+3*pow(t1,2)*t*c1x+3*t1*t*t*c2x+pow(t,3)*p2x,y:pow(t1,3)*p1y+3*pow(t1,2)*t*c1y+3*t1*t*t*c2y+pow(t,3)*p2y}},curveDim=cacher(function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y){var dot,a=c2x-2*c1x+p1x-(p2x-2*c2x+c1x),b=2*(c1x-p1x)-2*(c2x-c1x),c=p1x-c1x,t1=(-b+math.sqrt(b*b-4*a*c))/2/a,t2=(-b-math.sqrt(b*b-4*a*c))/2/a,y=[p1y,p2y],x=[p1x,p2x];return"1e12"<abs(t1)&&(t1=.5),"1e12"<abs(t2)&&(t2=.5),0<t1&&t1<1&&(dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t1),x.push(dot.x),y.push(dot.y)),0<t2&&t2<1&&(dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t2),x.push(dot.x),y.push(dot.y)),a=c2y-2*c1y+p1y-(p2y-2*c2y+c1y),c=p1y-c1y,t1=(-(b=2*(c1y-p1y)-2*(c2y-c1y))+math.sqrt(b*b-4*a*c))/2/a,t2=(-b-math.sqrt(b*b-4*a*c))/2/a,"1e12"<abs(t1)&&(t1=.5),"1e12"<abs(t2)&&(t2=.5),0<t1&&t1<1&&(dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t1),x.push(dot.x),y.push(dot.y)),0<t2&&t2<1&&(dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t2),x.push(dot.x),y.push(dot.y)),{min:{x:mmin[apply](0,x),y:mmin[apply](0,y)},max:{x:mmax[apply](0,x),y:mmax[apply](0,y)}}}),path2curve=R._path2curve=cacher(function(path,path2){var pth=!path2&&paths(path);if(!path2&&pth.curve)return pathClone(pth.curve);for(var p=pathToAbsolute(path),p2=path2&&pathToAbsolute(path2),attrs={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},attrs2={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},processPath=function(path,d){if(!path)return["C",d.x,d.y,d.x,d.y,d.x,d.y];switch(!(path[0]in{T:1,Q:1})&&(d.qx=d.qy=null),path[0]){case"M":d.X=path[1],d.Y=path[2];break;case"A":path=["C"][concat](a2c[apply](0,[d.x,d.y][concat](path.slice(1))));break;case"S":path=["C",d.x+(d.x-(d.bx||d.x)),d.y+(d.y-(d.by||d.y))][concat](path.slice(1));break;case"T":d.qx=d.x+(d.x-(d.qx||d.x)),d.qy=d.y+(d.y-(d.qy||d.y)),path=["C"][concat](q2c(d.x,d.y,d.qx,d.qy,path[1],path[2]));break;case"Q":d.qx=path[1],d.qy=path[2],path=["C"][concat](q2c(d.x,d.y,path[1],path[2],path[3],path[4]));break;case"L":path=["C"][concat](l2c(d.x,d.y,path[1],path[2]));break;case"H":path=["C"][concat](l2c(d.x,d.y,path[1],d.y));break;case"V":path=["C"][concat](l2c(d.x,d.y,d.x,path[1]));break;case"Z":path=["C"][concat](l2c(d.x,d.y,d.X,d.Y))}return path},fixArc=function(pp,i){if(7<pp[i].length){pp[i].shift();for(var pi=pp[i];pi.length;)pp.splice(i++,0,["C"][concat](pi.splice(0,6)));pp.splice(i,1),ii=mmax(p.length,p2&&p2.length||0)}},fixM=function(path1,path2,a1,a2,i){path1&&path2&&"M"==path1[i][0]&&"M"!=path2[i][0]&&(path2.splice(i,0,["M",a2.x,a2.y]),a1.bx=0,a1.by=0,a1.x=path1[i][1],a1.y=path1[i][2],ii=mmax(p.length,p2&&p2.length||0))},i=0,ii=mmax(p.length,p2&&p2.length||0);i<ii;i++){p[i]=processPath(p[i],attrs),fixArc(p,i),p2&&(p2[i]=processPath(p2[i],attrs2)),p2&&fixArc(p2,i),fixM(p,p2,attrs,attrs2,i),fixM(p2,p,attrs2,attrs,i);var seg=p[i],seg2=p2&&p2[i],seglen=seg.length,seg2len=p2&&seg2.length;attrs.x=seg[seglen-2],attrs.y=seg[seglen-1],attrs.bx=toFloat(seg[seglen-4])||attrs.x,attrs.by=toFloat(seg[seglen-3])||attrs.y,attrs2.bx=p2&&(toFloat(seg2[seg2len-4])||attrs2.x),attrs2.by=p2&&(toFloat(seg2[seg2len-3])||attrs2.y),attrs2.x=p2&&seg2[seg2len-2],attrs2.y=p2&&seg2[seg2len-1]}return p2||(pth.curve=pathClone(p)),p2?[p,p2]:p},null,pathClone),tear=(R._parseDots=cacher(function(gradient){for(var dots=[],i=0,ii=gradient.length;i<ii;i++){var dot={},par=gradient[i].match(/^([^:]*):?([\d\.]*)/);if(dot.color=R.getRGB(par[1]),dot.color.error)return null;dot.color=dot.color.hex,par[2]&&(dot.offset=par[2]+"%"),dots.push(dot)}for(i=1,ii=dots.length-1;i<ii;i++)if(!dots[i].offset){for(var start=toFloat(dots[i-1].offset||0),end=0,j=i+1;j<ii;j++)if(dots[j].offset){end=dots[j].offset;break}end||(end=100,j=ii);for(var d=((end=toFloat(end))-start)/(j-i+1);i<j;i++)start+=d,dots[i].offset=start+"%"}return dots}),R._tear=function(el,paper){el==paper.top&&(paper.top=el.prev),el==paper.bottom&&(paper.bottom=el.next),el.next&&(el.next.prev=el.prev),el.prev&&(el.prev.next=el.next)}),toMatrix=(R._tofront=function(el,paper){paper.top!==el&&(tear(el,paper),el.next=null,el.prev=paper.top,paper.top.next=el,paper.top=el)},R._toback=function(el,paper){paper.bottom!==el&&(tear(el,paper),el.next=paper.bottom,el.prev=null,paper.bottom.prev=el,paper.bottom=el)},R._insertafter=function(el,el2,paper){tear(el,paper),el2==paper.top&&(paper.top=el),el2.next&&(el2.next.prev=el),el.next=el2.next,(el.prev=el2).next=el},R._insertbefore=function(el,el2,paper){tear(el,paper),el2==paper.bottom&&(paper.bottom=el),el2.prev&&(el2.prev.next=el),el.prev=el2.prev,(el2.prev=el).next=el2},R.toMatrix=function(path,transform){var bb=pathDimensions(path),el={_:{transform:E},getBBox:function(){return bb}};return extractTransform(el,transform),el.matrix}),extractTransform=(R.transformPath=function(path,transform){return mapPath(path,toMatrix(path,transform))},R._extractTransform=function(el,tstr){if(null==tstr)return el._.transform;tstr=Str(tstr).replace(/\.{3}|\u2026/g,el._.transform||E);var dx,dy,tdata=R.parseTransformString(tstr),deg=0,sx=1,sy=1,_=el._,m=new Matrix;if(_.transform=tdata||[],tdata)for(var i=0,ii=tdata.length;i<ii;i++){var x1,y1,x2,y2,bb,t=tdata[i],tlen=t.length,command=Str(t[0]).toLowerCase(),absolute=t[0]!=command,inver=absolute?m.invert():0;"t"==command&&3==tlen?absolute?(x1=inver.x(0,0),y1=inver.y(0,0),x2=inver.x(t[1],t[2]),y2=inver.y(t[1],t[2]),m.translate(x2-x1,y2-y1)):m.translate(t[1],t[2]):"r"==command?2==tlen?(bb=bb||el.getBBox(1),m.rotate(t[1],bb.x+bb.width/2,bb.y+bb.height/2),deg+=t[1]):4==tlen&&(absolute?(x2=inver.x(t[2],t[3]),y2=inver.y(t[2],t[3]),m.rotate(t[1],x2,y2)):m.rotate(t[1],t[2],t[3]),deg+=t[1]):"s"==command?2==tlen||3==tlen?(bb=bb||el.getBBox(1),m.scale(t[1],t[tlen-1],bb.x+bb.width/2,bb.y+bb.height/2),sx*=t[1],sy*=t[tlen-1]):5==tlen&&(absolute?(x2=inver.x(t[3],t[4]),y2=inver.y(t[3],t[4]),m.scale(t[1],t[2],x2,y2)):m.scale(t[1],t[2],t[3],t[4]),sx*=t[1],sy*=t[2]):"m"==command&&7==tlen&&m.add(t[1],t[2],t[3],t[4],t[5],t[6]),_.dirtyT=1,el.matrix=m}el.matrix=m,_.sx=sx,_.sy=sy,_.deg=deg,_.dx=dx=m.e,_.dy=dy=m.f,1==sx&&1==sy&&!deg&&_.bbox?(_.bbox.x+=+dx,_.bbox.y+=+dy):_.dirtyT=1}),getEmpty=function(item){var l=item[0];switch(l.toLowerCase()){case"t":return[l,0,0];case"m":return[l,1,0,0,1,0,0];case"r":return 4==item.length?[l,0,item[2],item[3]]:[l,0];case"s":return 5==item.length?[l,1,1,item[3],item[4]]:3==item.length?[l,1,1]:[l,1]}},equaliseTransform=R._equaliseTransform=function(t1,t2){t2=Str(t2).replace(/\.{3}|\u2026/g,t1),t1=R.parseTransformString(t1)||[],t2=R.parseTransformString(t2)||[];for(var j,jj,tt1,tt2,maxlength=mmax(t1.length,t2.length),from=[],to=[],i=0;i<maxlength;i++){if(tt1=t1[i]||getEmpty(t2[i]),tt2=t2[i]||getEmpty(tt1),tt1[0]!=tt2[0]||"r"==tt1[0].toLowerCase()&&(tt1[2]!=tt2[2]||tt1[3]!=tt2[3])||"s"==tt1[0].toLowerCase()&&(tt1[3]!=tt2[3]||tt1[4]!=tt2[4]))return;for(from[i]=[],to[i]=[],j=0,jj=mmax(tt1.length,tt2.length);j<jj;j++)j in tt1&&(from[i][j]=tt1[j]),j in tt2&&(to[i][j]=tt2[j])}return{from:from,to:to}};function Matrix(a,b,c,d,e,f){null!=a?(this.a=+a,this.b=+b,this.c=+c,this.d=+d,this.e=+e,this.f=+f):(this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0)}R._getContainer=function(x,y,w,h){var container;if(null!=(container=null!=h||R.is(x,"object")?x:g.doc.getElementById(x)))return container.tagName?null==y?{container:container,width:container.style.pixelWidth||container.offsetWidth,height:container.style.pixelHeight||container.offsetHeight}:{container:container,width:y,height:w}:{container:1,x:x,y:y,width:w,height:h}},R.pathToRelative=pathToRelative,R._engine={},R.path2curve=path2curve,R.matrix=function(a,b,c,d,e,f){return new Matrix(a,b,c,d,e,f)},function(matrixproto){function norm(a){return a[0]*a[0]+a[1]*a[1]}function normalize(a){var mag=math.sqrt(norm(a));a[0]&&(a[0]/=mag),a[1]&&(a[1]/=mag)}matrixproto.add=function(a,b,c,d,e,f){var x,y,z,res,out=[[],[],[]],m=[[this.a,this.c,this.e],[this.b,this.d,this.f],[0,0,1]],matrix=[[a,c,e],[b,d,f],[0,0,1]];for(a&&a instanceof Matrix&&(matrix=[[a.a,a.c,a.e],[a.b,a.d,a.f],[0,0,1]]),x=0;x<3;x++)for(y=0;y<3;y++){for(z=res=0;z<3;z++)res+=m[x][z]*matrix[z][y];out[x][y]=res}this.a=out[0][0],this.b=out[1][0],this.c=out[0][1],this.d=out[1][1],this.e=out[0][2],this.f=out[1][2]},matrixproto.invert=function(){var me=this,x=me.a*me.d-me.b*me.c;return new Matrix(me.d/x,-me.b/x,-me.c/x,me.a/x,(me.c*me.f-me.d*me.e)/x,(me.b*me.e-me.a*me.f)/x)},matrixproto.clone=function(){return new Matrix(this.a,this.b,this.c,this.d,this.e,this.f)},matrixproto.translate=function(x,y){this.add(1,0,0,1,x,y)},matrixproto.scale=function(x,y,cx,cy){null==y&&(y=x),(cx||cy)&&this.add(1,0,0,1,cx,cy),this.add(x,0,0,y,0,0),(cx||cy)&&this.add(1,0,0,1,-cx,-cy)},matrixproto.rotate=function(a,x,y){a=R.rad(a),x=x||0,y=y||0;var cos=+math.cos(a).toFixed(9),sin=+math.sin(a).toFixed(9);this.add(cos,sin,-sin,cos,x,y),this.add(1,0,0,1,-x,-y)},matrixproto.x=function(x,y){return x*this.a+y*this.c+this.e},matrixproto.y=function(x,y){return x*this.b+y*this.d+this.f},matrixproto.get=function(i){return+this[Str.fromCharCode(97+i)].toFixed(4)},matrixproto.toString=function(){return R.svg?"matrix("+[this.get(0),this.get(1),this.get(2),this.get(3),this.get(4),this.get(5)].join()+")":[this.get(0),this.get(2),this.get(1),this.get(3),0,0].join()},matrixproto.toFilter=function(){return"progid:DXImageTransform.Microsoft.Matrix(M11="+this.get(0)+", M12="+this.get(2)+", M21="+this.get(1)+", M22="+this.get(3)+", Dx="+this.get(4)+", Dy="+this.get(5)+", sizingmethod='auto expand')"},matrixproto.offset=function(){return[this.e.toFixed(4),this.f.toFixed(4)]},matrixproto.split=function(){var out={};out.dx=this.e,out.dy=this.f;var row=[[this.a,this.c],[this.b,this.d]];out.scalex=math.sqrt(norm(row[0])),normalize(row[0]),out.shear=row[0][0]*row[1][0]+row[0][1]*row[1][1],row[1]=[row[1][0]-row[0][0]*out.shear,row[1][1]-row[0][1]*out.shear],out.scaley=math.sqrt(norm(row[1])),normalize(row[1]),out.shear/=out.scaley;var sin=-row[0][1],cos=row[1][1];return cos<0?(out.rotate=R.deg(math.acos(cos)),sin<0&&(out.rotate=360-out.rotate)):out.rotate=R.deg(math.asin(sin)),out.isSimple=!(+out.shear.toFixed(9)||out.scalex.toFixed(9)!=out.scaley.toFixed(9)&&out.rotate),out.isSuperSimple=!+out.shear.toFixed(9)&&out.scalex.toFixed(9)==out.scaley.toFixed(9)&&!out.rotate,out.noRotation=!+out.shear.toFixed(9)&&!out.rotate,out},matrixproto.toTransformString=function(shorter){var s=shorter||this[split]();return s.isSimple?(s.scalex=+s.scalex.toFixed(4),s.scaley=+s.scaley.toFixed(4),s.rotate=+s.rotate.toFixed(4),(s.dx||s.dy?"t"+[s.dx,s.dy]:E)+(1!=s.scalex||1!=s.scaley?"s"+[s.scalex,s.scaley,0,0]:E)+(s.rotate?"r"+[s.rotate,0,0]:E)):"m"+[this.get(0),this.get(1),this.get(2),this.get(3),this.get(4),this.get(5)]}}(Matrix.prototype);var version=navigator.userAgent.match(/Version\/(.*?)\s/)||navigator.userAgent.match(/Chrome\/(\d+)/);"Apple Computer, Inc."==navigator.vendor&&(version&&version[1]<4||"iP"==navigator.platform.slice(0,2))||"Google Inc."==navigator.vendor&&version&&version[1]<8?paperproto.safari=function(){var rect=this.rect(-99,-99,this.width+99,this.height+99).attr({stroke:"none"});setTimeout(function(){rect.remove()})}:paperproto.safari=function(){};for(var preventDefault=function(){this.returnValue=!1},stopPropagation=function(){this.cancelBubble=!0},addEvent=g.doc.addEventListener?function(obj,type,fn,element){var realName=type,f=function(e){var scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft,x=e.clientX+scrollX,y=e.clientY+scrollY;return fn.call(element,e,x,y)};return obj.addEventListener(realName,f,!1),function(){return obj.removeEventListener(realName,f,!1),!0}}:g.doc.attachEvent?function(obj,type,fn,element){var f=function(e){e=e||g.win.event;var scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft,x=e.clientX+scrollX,y=e.clientY+scrollY;return e.preventDefault=e.preventDefault||preventDefault,e.stopPropagation=e.stopPropagation||stopPropagation,fn.call(element,e,x,y)};return obj.attachEvent("on"+type,f),function(){return obj.detachEvent("on"+type,f),!0}}:void 0,drag=[],dragMove=function(e){for(var dragi,x=e.clientX,y=e.clientY,scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft,j=drag.length;j--;){dragi=drag[j],e.preventDefault();var o,node=dragi.el.node,next=node.nextSibling,parent=node.parentNode,display=node.style.display;g.win.opera&&parent.removeChild(node),node.style.display="none",o=dragi.el.paper.getElementByPoint(x,y),node.style.display=display,g.win.opera&&(next?parent.insertBefore(node,next):parent.appendChild(node)),o&&eve("raphael.drag.over."+dragi.el.id,dragi.el,o),x+=scrollX,y+=scrollY,eve("raphael.drag.move."+dragi.el.id,dragi.move_scope||dragi.el,x-dragi.el._drag.x,y-dragi.el._drag.y,x,y,e)}},dragUp=function(e){R.unmousemove(dragMove).unmouseup(dragUp);for(var dragi,i=drag.length;i--;)(dragi=drag[i]).el._drag={},eve("raphael.drag.end."+dragi.el.id,dragi.end_scope||dragi.start_scope||dragi.move_scope||dragi.el,e);drag=[]},elproto=R.el={},i=events.length;i--;)!function(eventName){R[eventName]=elproto[eventName]=function(fn,scope){return R.is(fn,"function")&&(this.events=this.events||[],this.events.push({name:eventName,f:fn,unbind:addEvent(this.shape||this.node||g.doc,eventName,fn,scope||this)})),this},R["un"+eventName]=elproto["un"+eventName]=function(fn){for(var events=this.events||[],l=events.length;l--;)if(events[l].name==eventName&&events[l].f==fn)return events[l].unbind(),events.splice(l,1),!events.length&&delete this.events,this;return this}}(events[i]);elproto.data=function(key,value){var data=eldata[this.id]=eldata[this.id]||{};if(1!=arguments.length)return data[key]=value,eve("raphael.data.set."+this.id,this,value,key),this;if(R.is(key,"object")){for(var i in key)key[has](i)&&this.data(i,key[i]);return this}return eve("raphael.data.get."+this.id,this,data[key],key),data[key]},elproto.removeData=function(key){return null==key?eldata[this.id]={}:eldata[this.id]&&delete eldata[this.id][key],this},elproto.hover=function(f_in,f_out,scope_in,scope_out){return this.mouseover(f_in,scope_in).mouseout(f_out,scope_out||scope_in)},elproto.unhover=function(f_in,f_out){return this.unmouseover(f_in).unmouseout(f_out)};var draggable=[];elproto.drag=function(onmove,onstart,onend,move_scope,start_scope,end_scope){function start(e){(e.originalEvent||e).preventDefault();var scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft;this._drag.x=e.clientX+scrollX,this._drag.y=e.clientY+scrollY,this._drag.id=e.identifier,!drag.length&&R.mousemove(dragMove).mouseup(dragUp),drag.push({el:this,move_scope:move_scope,start_scope:start_scope,end_scope:end_scope}),onstart&&eve.on("raphael.drag.start."+this.id,onstart),onmove&&eve.on("raphael.drag.move."+this.id,onmove),onend&&eve.on("raphael.drag.end."+this.id,onend),eve("raphael.drag.start."+this.id,start_scope||move_scope||this,e.clientX+scrollX,e.clientY+scrollY,e)}return this._drag={},draggable.push({el:this,start:start}),this.mousedown(start),this},elproto.onDragOver=function(f){f?eve.on("raphael.drag.over."+this.id,f):eve.unbind("raphael.drag.over."+this.id)},elproto.undrag=function(){for(var i=draggable.length;i--;)draggable[i].el==this&&(this.unmousedown(draggable[i].start),draggable.splice(i,1),eve.unbind("raphael.drag.*."+this.id));!draggable.length&&R.unmousemove(dragMove).unmouseup(dragUp)},paperproto.circle=function(x,y,r){var out=R._engine.circle(this,x||0,y||0,r||0);return this.__set__&&this.__set__.push(out),out},paperproto.rect=function(x,y,w,h,r){var out=R._engine.rect(this,x||0,y||0,w||0,h||0,r||0);return this.__set__&&this.__set__.push(out),out},paperproto.ellipse=function(x,y,rx,ry){var out=R._engine.ellipse(this,x||0,y||0,rx||0,ry||0);return this.__set__&&this.__set__.push(out),out},paperproto.path=function(pathString){pathString&&!R.is(pathString,"string")&&!R.is(pathString[0],array)&&(pathString+=E);var out=R._engine.path(R.format[apply](R,arguments),this);return this.__set__&&this.__set__.push(out),out},paperproto.image=function(src,x,y,w,h){var out=R._engine.image(this,src||"about:blank",x||0,y||0,w||0,h||0);return this.__set__&&this.__set__.push(out),out},paperproto.text=function(x,y,text){var out=R._engine.text(this,x||0,y||0,Str(text));return this.__set__&&this.__set__.push(out),out},paperproto.set=function(itemsArray){!R.is(itemsArray,"array")&&(itemsArray=Array.prototype.splice.call(arguments,0,arguments.length));var out=new Set(itemsArray);return this.__set__&&this.__set__.push(out),out},paperproto.setStart=function(set){this.__set__=set||this.set()},paperproto.setFinish=function(set){var out=this.__set__;return delete this.__set__,out},paperproto.setSize=function(width,height){return R._engine.setSize.call(this,width,height)},paperproto.setViewBox=function(x,y,w,h,fit){return R._engine.setViewBox.call(this,x,y,w,h,fit)},paperproto.top=paperproto.bottom=null,paperproto.raphael=R;function x_y_w_h(){return this.x+S+this.y+S+this.width+"  "+this.height}paperproto.getElementByPoint=function(x,y){var elem,box,doc,body,docElem,clientTop,clientLeft,svg=this.canvas,target=g.doc.elementFromPoint(x,y);if(g.win.opera&&"svg"==target.tagName){var so=(box=(elem=svg).getBoundingClientRect(),doc=elem.ownerDocument,body=doc.body,docElem=doc.documentElement,clientTop=docElem.clientTop||body.clientTop||0,clientLeft=docElem.clientLeft||body.clientLeft||0,{y:box.top+(g.win.pageYOffset||docElem.scrollTop||body.scrollTop)-clientTop,x:box.left+(g.win.pageXOffset||docElem.scrollLeft||body.scrollLeft)-clientLeft}),sr=svg.createSVGRect();sr.x=x-so.x,sr.y=y-so.y,sr.width=sr.height=1;var hits=svg.getIntersectionList(sr,null);hits.length&&(target=hits[hits.length-1])}if(!target)return null;for(;target.parentNode&&target!=svg.parentNode&&!target.raphael;)target=target.parentNode;return target==this.canvas.parentNode&&(target=svg),target=target&&target.raphael?this.getById(target.raphaelid):null},paperproto.getById=function(id){for(var bot=this.bottom;bot;){if(bot.id==id)return bot;bot=bot.next}return null},paperproto.forEach=function(callback,thisArg){for(var bot=this.bottom;bot;){if(!1===callback.call(thisArg,bot))return this;bot=bot.next}return this},paperproto.getElementsByPoint=function(x,y){var set=this.set();return this.forEach(function(el){el.isPointInside(x,y)&&set.push(el)}),set},elproto.isPointInside=function(x,y){var rp=this.realPath=this.realPath||getPath[this.type](this);return R.isPointInsidePath(rp,x,y)},elproto.getBBox=function(isWithoutTransform){if(this.removed)return{};var _=this._;return isWithoutTransform?(!_.dirty&&_.bboxwt||(this.realPath=getPath[this.type](this),_.bboxwt=pathDimensions(this.realPath),_.bboxwt.toString=x_y_w_h,_.dirty=0),_.bboxwt):((_.dirty||_.dirtyT||!_.bbox)&&(!_.dirty&&this.realPath||(_.bboxwt=0,this.realPath=getPath[this.type](this)),_.bbox=pathDimensions(mapPath(this.realPath,this.matrix)),_.bbox.toString=x_y_w_h,_.dirty=_.dirtyT=0),_.bbox)},elproto.clone=function(){if(this.removed)return null;var out=this.paper[this.type]().attr(this.attr());return this.__set__&&this.__set__.push(out),out},elproto.glow=function(glow){if("text"==this.type)return null;var s={width:((glow=glow||{}).width||10)+(+this.attr("stroke-width")||1),fill:glow.fill||!1,opacity:glow.opacity||.5,offsetx:glow.offsetx||0,offsety:glow.offsety||0,color:glow.color||"#000"},c=s.width/2,r=this.paper,out=r.set(),path=this.realPath||getPath[this.type](this);path=this.matrix?mapPath(path,this.matrix):path;for(var i=1;i<c+1;i++)out.push(r.path(path).attr({stroke:s.color,fill:s.fill?s.color:"none","stroke-linejoin":"round","stroke-linecap":"round","stroke-width":+(s.width/c*i).toFixed(3),opacity:+(s.opacity/c).toFixed(3)}));return out.insertBefore(this).translate(s.offsetx,s.offsety)};var getPointAtSegmentLength=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,length){return null==length?bezlen(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y):R.findDotsAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,function(x1,y1,x2,y2,x3,y3,x4,y4,ll){if(!(ll<0||bezlen(x1,y1,x2,y2,x3,y3,x4,y4)<ll)){var l,step=.5,t2=1-step;for(l=bezlen(x1,y1,x2,y2,x3,y3,x4,y4,t2);.01<abs(l-ll);)l=bezlen(x1,y1,x2,y2,x3,y3,x4,y4,t2+=(l<ll?1:-1)*(step/=2));return t2}}(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,length))},getLengthFactory=function(istotal,subpath){return function(path,length,onlystart){for(var x,y,p,l,point,sp="",subpaths={},len=0,i=0,ii=(path=path2curve(path)).length;i<ii;i++){if("M"==(p=path[i])[0])x=+p[1],y=+p[2];else{if(length<len+(l=getPointAtSegmentLength(x,y,p[1],p[2],p[3],p[4],p[5],p[6]))){if(subpath&&!subpaths.start){if(sp+=["C"+(point=getPointAtSegmentLength(x,y,p[1],p[2],p[3],p[4],p[5],p[6],length-len)).start.x,point.start.y,point.m.x,point.m.y,point.x,point.y],onlystart)return sp;subpaths.start=sp,sp=["M"+point.x,point.y+"C"+point.n.x,point.n.y,point.end.x,point.end.y,p[5],p[6]].join(),len+=l,x=+p[5],y=+p[6];continue}if(!istotal&&!subpath)return{x:(point=getPointAtSegmentLength(x,y,p[1],p[2],p[3],p[4],p[5],p[6],length-len)).x,y:point.y,alpha:point.alpha}}len+=l,x=+p[5],y=+p[6]}sp+=p.shift()+p}return subpaths.end=sp,(point=istotal?len:subpath?subpaths:R.findDotsAtSegment(x,y,p[0],p[1],p[2],p[3],p[4],p[5],1)).alpha&&(point={x:point.x,y:point.y,alpha:point.alpha}),point}},getTotalLength=getLengthFactory(1),getPointAtLength=getLengthFactory(),getSubpathsAtLength=getLengthFactory(0,1);R.getTotalLength=getTotalLength,R.getPointAtLength=getPointAtLength,R.getSubpath=function(path,from,to){if(this.getTotalLength(path)-to<1e-6)return getSubpathsAtLength(path,from).end;var a=getSubpathsAtLength(path,to,1);return from?getSubpathsAtLength(a,from).end:a},elproto.getTotalLength=function(){if("path"==this.type)return this.node.getTotalLength?this.node.getTotalLength():getTotalLength(this.attrs.path)},elproto.getPointAtLength=function(length){if("path"==this.type)return getPointAtLength(this.attrs.path,length)},elproto.getSubpath=function(from,to){if("path"==this.type)return R.getSubpath(this.attrs.path,from,to)};var ef=R.easing_formulas={linear:function(n){return n},"<":function(n){return pow(n,1.7)},">":function(n){return pow(n,.48)},"<>":function(n){var q=.48-n/1.04,Q=math.sqrt(.1734+q*q),x=Q-q,y=-Q-q,t=pow(abs(x),1/3)*(x<0?-1:1)+pow(abs(y),1/3)*(y<0?-1:1)+.5;return 3*(1-t)*t*t+t*t*t},backIn:function(n){var s=1.70158;return n*n*((s+1)*n-s)},backOut:function(n){var s=1.70158;return(n-=1)*n*((s+1)*n+s)+1},elastic:function(n){return n==!!n?n:pow(2,-10*n)*math.sin(2*PI*(n-.075)/.3)+1},bounce:function(n){var s=7.5625,p=2.75;return n<1/p?s*n*n:n<2/p?s*(n-=1.5/p)*n+.75:n<2.5/p?s*(n-=2.25/p)*n+.9375:s*(n-=2.625/p)*n+.984375}};ef.easeIn=ef["ease-in"]=ef["<"],ef.easeOut=ef["ease-out"]=ef[">"],ef.easeInOut=ef["ease-in-out"]=ef["<>"],ef["back-in"]=ef.backIn,ef["back-out"]=ef.backOut;var animationElements=[],requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){setTimeout(callback,16)},animation=function(){for(var Now=+new Date,l=0;l<animationElements.length;l++){var e=animationElements[l];if(!e.el.removed&&!e.paused){var now,key,time=Now-e.start,ms=e.ms,easing=e.easing,from=e.from,diff=e.diff,to=e.to,that=(e.t,e.el),set={},init={};if(e.initstatus?(time=(e.initstatus*e.anim.top-e.prev)/(e.percent-e.prev)*ms,e.status=e.initstatus,delete e.initstatus,e.stop&&animationElements.splice(l--,1)):e.status=(e.prev+(e.percent-e.prev)*(time/ms))/e.anim.top,!(time<0))if(time<ms){var pos=easing(time/ms);for(var attr in from)if(from[has](attr)){switch(availableAnimAttrs[attr]){case nu:now=+from[attr]+pos*ms*diff[attr];break;case"colour":now="rgb("+[upto255(round(from[attr].r+pos*ms*diff[attr].r)),upto255(round(from[attr].g+pos*ms*diff[attr].g)),upto255(round(from[attr].b+pos*ms*diff[attr].b))].join(",")+")";break;case"path":now=[];for(var i=0,ii=from[attr].length;i<ii;i++){now[i]=[from[attr][i][0]];for(var j=1,jj=from[attr][i].length;j<jj;j++)now[i][j]=+from[attr][i][j]+pos*ms*diff[attr][i][j];now[i]=now[i].join(S)}now=now.join(S);break;case"transform":if(diff[attr].real)for(now=[],i=0,ii=from[attr].length;i<ii;i++)for(now[i]=[from[attr][i][0]],j=1,jj=from[attr][i].length;j<jj;j++)now[i][j]=from[attr][i][j]+pos*ms*diff[attr][i][j];else{var get=function(i){return+from[attr][i]+pos*ms*diff[attr][i]};now=[["m",get(0),get(1),get(2),get(3),get(4),get(5)]]}break;case"csv":if("clip-rect"==attr)for(now=[],i=4;i--;)now[i]=+from[attr][i]+pos*ms*diff[attr][i];break;default:var from2=[][concat](from[attr]);for(now=[],i=that.paper.customAttributes[attr].length;i--;)now[i]=+from2[i]+pos*ms*diff[attr][i]}set[attr]=now}that.attr(set),function(id,that,anim){setTimeout(function(){eve("raphael.anim.frame."+id,that,anim)})}(that.id,that,e.anim)}else{if(function(f,el,a){setTimeout(function(){eve("raphael.anim.frame."+el.id,el,a),eve("raphael.anim.finish."+el.id,el,a),R.is(f,"function")&&f.call(el)})}(e.callback,that,e.anim),that.attr(to),animationElements.splice(l--,1),1<e.repeat&&!e.next){for(key in to)to[has](key)&&(init[key]=e.totalOrigin[key]);e.el.attr(init),runAnimation(e.anim,e.el,e.anim.percents[0],null,e.totalOrigin,e.repeat-1)}e.next&&!e.stop&&runAnimation(e.anim,e.el,e.next,null,e.totalOrigin,e.repeat)}}}R.svg&&that&&that.paper&&that.paper.safari(),animationElements.length&&requestAnimFrame(animation)},upto255=function(color){return 255<color?255:color<0?0:color};function CubicBezierAtTime(t,p1x,p1y,p2x,p2y,duration){var cx=3*p1x,bx=3*(p2x-p1x)-cx,ax=1-cx-bx,cy=3*p1y,by=3*(p2y-p1y)-cy,ay=1-cy-by;function sampleCurveX(t){return((ax*t+bx)*t+cx)*t}return function(x,epsilon){var t=function(x,epsilon){var t0,t1,t2,x2,d2,i;for(t2=x,i=0;i<8;i++){if(x2=sampleCurveX(t2)-x,abs(x2)<epsilon)return t2;if(abs(d2=(3*ax*t2+2*bx)*t2+cx)<1e-6)break;t2-=x2/d2}if(t1=1,(t2=x)<(t0=0))return t0;if(t1<t2)return t1;for(;t0<t1;){if(x2=sampleCurveX(t2),abs(x2-x)<epsilon)return t2;x2<x?t0=t2:t1=t2,t2=(t1-t0)/2+t0}return t2}(x,epsilon);return((ay*t+by)*t+cy)*t}(t,1/(200*duration))}function Animation(anim,ms){var percents=[],newAnim={};if(this.ms=ms,this.times=1,anim){for(var attr in anim)anim[has](attr)&&(newAnim[toFloat(attr)]=anim[attr],percents.push(toFloat(attr)));percents.sort(sortByNumber)}this.anim=newAnim,this.top=percents[percents.length-1],this.percents=percents}function runAnimation(anim,element,percent,status,totalOrigin,times){percent=toFloat(percent);var params,isInAnim,isInAnimSet,next,prev,timestamp,ms=anim.ms,from={},to={},diff={};if(status)for(i=0,ii=animationElements.length;i<ii;i++){var e=animationElements[i];if(e.el.id==element.id&&e.anim==anim){e.percent!=percent?(animationElements.splice(i,1),isInAnimSet=1):isInAnim=e,element.attr(e.totalOrigin);break}}else status=+to;for(var i=0,ii=anim.percents.length;i<ii;i++){if(anim.percents[i]==percent||anim.percents[i]>status*anim.top){percent=anim.percents[i],prev=anim.percents[i-1]||0,ms=ms/anim.top*(percent-prev),next=anim.percents[i+1],params=anim.anim[percent];break}status&&element.attr(anim.anim[anim.percents[i]])}if(params){if(isInAnim)isInAnim.initstatus=status,isInAnim.start=new Date-isInAnim.ms*status;else{for(var attr in params)if(params[has](attr)&&(availableAnimAttrs[has](attr)||element.paper.customAttributes[has](attr)))switch(from[attr]=element.attr(attr),null==from[attr]&&(from[attr]=availableAttrs[attr]),to[attr]=params[attr],availableAnimAttrs[attr]){case nu:diff[attr]=(to[attr]-from[attr])/ms;break;case"colour":from[attr]=R.getRGB(from[attr]);var toColour=R.getRGB(to[attr]);diff[attr]={r:(toColour.r-from[attr].r)/ms,g:(toColour.g-from[attr].g)/ms,b:(toColour.b-from[attr].b)/ms};break;case"path":var pathes=path2curve(from[attr],to[attr]),toPath=pathes[1];for(from[attr]=pathes[0],diff[attr]=[],i=0,ii=from[attr].length;i<ii;i++){diff[attr][i]=[0];for(var j=1,jj=from[attr][i].length;j<jj;j++)diff[attr][i][j]=(toPath[i][j]-from[attr][i][j])/ms}break;case"transform":var _=element._,eq=equaliseTransform(_[attr],to[attr]);if(eq)for(from[attr]=eq.from,to[attr]=eq.to,diff[attr]=[],diff[attr].real=!0,i=0,ii=from[attr].length;i<ii;i++)for(diff[attr][i]=[from[attr][i][0]],j=1,jj=from[attr][i].length;j<jj;j++)diff[attr][i][j]=(to[attr][i][j]-from[attr][i][j])/ms;else{var m=element.matrix||new Matrix,to2={_:{transform:_.transform},getBBox:function(){return element.getBBox(1)}};from[attr]=[m.a,m.b,m.c,m.d,m.e,m.f],extractTransform(to2,to[attr]),to[attr]=to2._.transform,diff[attr]=[(to2.matrix.a-m.a)/ms,(to2.matrix.b-m.b)/ms,(to2.matrix.c-m.c)/ms,(to2.matrix.d-m.d)/ms,(to2.matrix.e-m.e)/ms,(to2.matrix.f-m.f)/ms]}break;case"csv":var values=Str(params[attr])[split](separator),from2=Str(from[attr])[split](separator);if("clip-rect"==attr)for(from[attr]=from2,diff[attr]=[],i=from2.length;i--;)diff[attr][i]=(values[i]-from[attr][i])/ms;to[attr]=values;break;default:for(values=[][concat](params[attr]),from2=[][concat](from[attr]),diff[attr]=[],i=element.paper.customAttributes[attr].length;i--;)diff[attr][i]=((values[i]||0)-(from2[i]||0))/ms}var easing=params.easing,easyeasy=R.easing_formulas[easing];if(!easyeasy)if((easyeasy=Str(easing).match(bezierrg))&&5==easyeasy.length){var curve=easyeasy;easyeasy=function(t){return CubicBezierAtTime(t,+curve[1],+curve[2],+curve[3],+curve[4],ms)}}else easyeasy=pipe;if(e={anim:anim,percent:percent,timestamp:timestamp=params.start||anim.start||+new Date,start:timestamp+(anim.del||0),status:0,initstatus:status||0,stop:!1,ms:ms,easing:easyeasy,from:from,diff:diff,to:to,el:element,callback:params.callback,prev:prev,next:next,repeat:times||anim.times,origin:element.attr(),totalOrigin:totalOrigin},animationElements.push(e),status&&!isInAnim&&!isInAnimSet&&(e.stop=!0,e.start=new Date-ms*status,1==animationElements.length))return animation();isInAnimSet&&(e.start=new Date-e.ms*status),1==animationElements.length&&requestAnimFrame(animation)}eve("raphael.anim.start."+element.id,element,anim)}}function stopAnimation(paper){for(var i=0;i<animationElements.length;i++)animationElements[i].el.paper==paper&&animationElements.splice(i--,1)}elproto.animateWith=function(el,anim,params,ms,easing,callback){if(this.removed)return callback&&callback.call(this),this;var a=params instanceof Animation?params:R.animation(params,ms,easing,callback);runAnimation(a,this,a.percents[0],null,this.attr());for(var i=0,ii=animationElements.length;i<ii;i++)if(animationElements[i].anim==anim&&animationElements[i].el==el){animationElements[ii-1].start=animationElements[i].start;break}return this},elproto.onAnimation=function(f){return f?eve.on("raphael.anim.frame."+this.id,f):eve.unbind("raphael.anim.frame."+this.id),this},Animation.prototype.delay=function(delay){var a=new Animation(this.anim,this.ms);return a.times=this.times,a.del=+delay||0,a},Animation.prototype.repeat=function(times){var a=new Animation(this.anim,this.ms);return a.del=this.del,a.times=math.floor(mmax(times,0))||1,a},R.animation=function(params,ms,easing,callback){if(params instanceof Animation)return params;!R.is(easing,"function")&&easing||(callback=callback||easing||null,easing=null),params=Object(params),ms=+ms||0;var json,attr,p={};for(attr in params)params[has](attr)&&toFloat(attr)!=attr&&toFloat(attr)+"%"!=attr&&(json=!0,p[attr]=params[attr]);return json?(easing&&(p.easing=easing),callback&&(p.callback=callback),new Animation({100:p},ms)):new Animation(params,ms)},elproto.animate=function(params,ms,easing,callback){if(this.removed)return callback&&callback.call(this),this;var anim=params instanceof Animation?params:R.animation(params,ms,easing,callback);return runAnimation(anim,this,anim.percents[0],null,this.attr()),this},elproto.setTime=function(anim,value){return anim&&null!=value&&this.status(anim,mmin(value,anim.ms)/anim.ms),this},elproto.status=function(anim,value){var len,e,out=[],i=0;if(null!=value)return runAnimation(anim,this,-1,mmin(value,1)),this;for(len=animationElements.length;i<len;i++)if((e=animationElements[i]).el.id==this.id&&(!anim||e.anim==anim)){if(anim)return e.status;out.push({anim:e.anim,status:e.status})}return anim?0:out},elproto.pause=function(anim){for(var i=0;i<animationElements.length;i++)animationElements[i].el.id!=this.id||anim&&animationElements[i].anim!=anim||!1!==eve("raphael.anim.pause."+this.id,this,animationElements[i].anim)&&(animationElements[i].paused=!0);return this},elproto.resume=function(anim){for(var i=0;i<animationElements.length;i++)if(animationElements[i].el.id==this.id&&(!anim||animationElements[i].anim==anim)){var e=animationElements[i];!1!==eve("raphael.anim.resume."+this.id,this,e.anim)&&(delete e.paused,this.status(e.anim,e.status))}return this},elproto.stop=function(anim){for(var i=0;i<animationElements.length;i++)animationElements[i].el.id!=this.id||anim&&animationElements[i].anim!=anim||!1!==eve("raphael.anim.stop."+this.id,this,animationElements[i].anim)&&animationElements.splice(i--,1);return this},eve.on("raphael.remove",stopAnimation),eve.on("raphael.clear",stopAnimation),elproto.toString=function(){return"Raphals object"};var tokenRegex,objNotationRegex,doc,f,Set=function(items){if(this.items=[],this.length=0,this.type="set",items)for(var i=0,ii=items.length;i<ii;i++)!items[i]||items[i].constructor!=elproto.constructor&&items[i].constructor!=Set||(this[this.items.length]=this.items[this.items.length]=items[i],this.length++)},setproto=Set.prototype;for(var method in setproto.push=function(){for(var item,len,i=0,ii=arguments.length;i<ii;i++)!(item=arguments[i])||item.constructor!=elproto.constructor&&item.constructor!=Set||(this[len=this.items.length]=this.items[len]=item,this.length++);return this},setproto.pop=function(){return this.length&&delete this[this.length--],this.items.pop()},setproto.forEach=function(callback,thisArg){for(var i=0,ii=this.items.length;i<ii;i++)if(!1===callback.call(thisArg,this.items[i],i))return this;return this},elproto)elproto[has](method)&&(setproto[method]=function(methodname){return function(){var arg=arguments;return this.forEach(function(el){el[methodname][apply](el,arg)})}}(method));setproto.attr=function(name,value){if(name&&R.is(name,array)&&R.is(name[0],"object"))for(var j=0,jj=name.length;j<jj;j++)this.items[j].attr(name[j]);else for(var i=0,ii=this.items.length;i<ii;i++)this.items[i].attr(name,value);return this},setproto.clear=function(){for(;this.length;)this.pop()},setproto.splice=function(index,count,insertion){index=index<0?mmax(this.length+index,0):index,count=mmax(0,mmin(this.length-index,count));var i,tail=[],todel=[],args=[];for(i=2;i<arguments.length;i++)args.push(arguments[i]);for(i=0;i<count;i++)todel.push(this[index+i]);for(;i<this.length-index;i++)tail.push(this[index+i]);var arglen=args.length;for(i=0;i<arglen+tail.length;i++)this.items[index+i]=this[index+i]=i<arglen?args[i]:tail[i-arglen];for(i=this.items.length=this.length-=count-arglen;this[i];)delete this[i++];return new Set(todel)},setproto.exclude=function(el){for(var i=0,ii=this.length;i<ii;i++)if(this[i]==el)return this.splice(i,1),!0},setproto.animate=function(params,ms,easing,callback){(R.is(easing,"function")||!easing)&&(callback=easing||null);var item,collector,len=this.items.length,i=len,set=this;if(!len)return this;callback&&(collector=function(){!--len&&callback.call(set)}),easing=R.is(easing,"string")?easing:collector;var anim=R.animation(params,ms,easing,collector);for(item=this.items[--i].animate(anim);i--;)this.items[i]&&!this.items[i].removed&&this.items[i].animateWith(item,anim,anim);return this},setproto.insertAfter=function(el){for(var i=this.items.length;i--;)this.items[i].insertAfter(el);return this},setproto.getBBox=function(){for(var x=[],y=[],x2=[],y2=[],i=this.items.length;i--;)if(!this.items[i].removed){var box=this.items[i].getBBox();x.push(box.x),y.push(box.y),x2.push(box.x+box.width),y2.push(box.y+box.height)}return{x:x=mmin[apply](0,x),y:y=mmin[apply](0,y),x2:x2=mmax[apply](0,x2),y2:y2=mmax[apply](0,y2),width:x2-x,height:y2-y}},setproto.clone=function(s){s=new Set;for(var i=0,ii=this.items.length;i<ii;i++)s.push(this.items[i].clone());return s},setproto.toString=function(){return"Raphals set"},R.registerFont=function(font){if(!font.face)return font;this.fonts=this.fonts||{};var fontcopy={w:font.w,face:{},glyphs:{}},family=font.face["font-family"];for(var prop in font.face)font.face[has](prop)&&(fontcopy.face[prop]=font.face[prop]);if(this.fonts[family]?this.fonts[family].push(fontcopy):this.fonts[family]=[fontcopy],!font.svg)for(var glyph in fontcopy.face["units-per-em"]=toInt(font.face["units-per-em"],10),font.glyphs)if(font.glyphs[has](glyph)){var path=font.glyphs[glyph];if(fontcopy.glyphs[glyph]={w:path.w,k:{},d:path.d&&"M"+path.d.replace(/[mlcxtrv]/g,function(command){return{l:"L",c:"C",x:"z",t:"m",r:"l",v:"c"}[command]||"M"})+"z"},path.k)for(var k in path.k)path[has](k)&&(fontcopy.glyphs[glyph].k[k]=path.k[k])}return font},paperproto.getFont=function(family,weight,style,stretch){if(stretch=stretch||"normal",style=style||"normal",weight=+weight||{normal:400,bold:700,lighter:300,bolder:800}[weight]||400,R.fonts){var thefont,font=R.fonts[family];if(!font){var name=new RegExp("(^|\\s)"+family.replace(/[^\w\d\s+!~.:_-]/g,E)+"(\\s|$)","i");for(var fontName in R.fonts)if(R.fonts[has](fontName)&&name.test(fontName)){font=R.fonts[fontName];break}}if(font)for(var i=0,ii=font.length;i<ii&&((thefont=font[i]).face["font-weight"]!=weight||thefont.face["font-style"]!=style&&thefont.face["font-style"]||thefont.face["font-stretch"]!=stretch);i++);return thefont}},paperproto.print=function(x,y,string,font,size,origin,letter_spacing){origin=origin||"middle",letter_spacing=mmax(mmin(letter_spacing||0,1),-1);var scale,letters=Str(string)[split](E),shift=0,notfirst=0,path=E;if(R.is(font,string)&&(font=this.getFont(font)),font){scale=(size||16)/font.face["units-per-em"];for(var bb=font.face.bbox[split](separator),top=+bb[0],lineHeight=bb[3]-bb[1],shifty=0,height=+bb[1]+("baseline"==origin?lineHeight+ +font.face.descent:lineHeight/2),i=0,ii=letters.length;i<ii;i++){if("\n"==letters[i])notfirst=curr=shift=0,shifty+=lineHeight;else{var prev=notfirst&&font.glyphs[letters[i-1]]||{},curr=font.glyphs[letters[i]];shift+=notfirst?(prev.w||font.w)+(prev.k&&prev.k[letters[i]]||0)+font.w*letter_spacing:0,notfirst=1}curr&&curr.d&&(path+=R.transformPath(curr.d,["t",shift*scale,shifty*scale,"s",scale,scale,top,height,"t",(x-top)/scale,(y-height)/scale]))}}return this.path(path).attr({fill:"#000",stroke:"none"})},paperproto.add=function(json){if(R.is(json,"array"))for(var j,res=this.set(),i=0,ii=json.length;i<ii;i++)j=json[i]||{},elements[has](j.type)&&res.push(this[j.type]().attr(j));return res},R.format=function(token,params){var args=R.is(params,array)?[0][concat](params):arguments;return token&&R.is(token,"string")&&args.length-1&&(token=token.replace(formatrg,function(str,i){return null==args[++i]?E:args[i]})),token||E},R.fullfill=(tokenRegex=/\{([^\}]+)\}/g,objNotationRegex=/(?:(?:^|\.)(.+?)(?=\[|\.|$|\()|\[('|")(.+?)\2\])(\(\))?/g,function(str,obj){return String(str).replace(tokenRegex,function(all,key){return function(all,key,obj){var res=obj;return key.replace(objNotationRegex,function(all,name,quote,quotedName,isFunc){name=name||quotedName,res&&(name in res&&(res=res[name]),"function"==typeof res&&isFunc&&(res=res()))}),res=(null==res||res==obj?all:res)+""}(all,key,obj)})}),R.ninja=function(){return oldRaphael.was?g.win.Raphael=oldRaphael.is:delete Raphael,R},R.st=setproto,null==(doc=document).readyState&&doc.addEventListener&&(doc.addEventListener("DOMContentLoaded",f=function(){doc.removeEventListener("DOMContentLoaded",f,!1),doc.readyState="complete"},!1),doc.readyState="loading"),function isLoaded(){/in/.test(doc.readyState)?setTimeout(isLoaded,9):R.eve("raphael.DOMload")}(),oldRaphael.was?g.win.Raphael=R:Raphael=R,eve.on("raphael.DOMload",function(){loaded=!0})}(),window.Raphael.svg&&function(R){var has="hasOwnProperty",Str=String,toFloat=parseFloat,toInt=parseInt,math=Math,mmax=math.max,abs=math.abs,pow=math.pow,separator=/[, ]+/,eve=R.eve,E="",S=" ",xlink="http://www.w3.org/1999/xlink",markers={block:"M5,0 0,2.5 5,5z",classic:"M5,0 0,2.5 5,5 3.5,3 3.5,2z",diamond:"M2.5,0 5,2.5 2.5,5 0,2.5z",open:"M6,1 1,3.5 6,6",oval:"M2.5,0A2.5,2.5,0,0,1,2.5,5 2.5,2.5,0,0,1,2.5,0z"},markerCounter={};R.toString=function(){return"Your browser supports SVG.\nYou are running Raphal "+this.version};var $=function(el,attr){if(attr)for(var key in"string"==typeof el&&(el=$(el)),attr)attr[has](key)&&("xlink:"==key.substring(0,6)?el.setAttributeNS(xlink,key.substring(6),Str(attr[key])):el.setAttribute(key,Str(attr[key])));else(el=R._g.doc.createElementNS("http://www.w3.org/2000/svg",el)).style&&(el.style.webkitTapHighlightColor="rgba(0,0,0,0)");return el},addGradientFill=function(element,gradient){var type="linear",id="grad:"+element.id+gradient,fx=.5,fy=.5,o=element.node,SVG=element.paper,s=o.style,el=R._g.doc.getElementById(id);if(!el){if(gradient=(gradient=Str(gradient).replace(R._radial_gradient,function(all,_fx,_fy){if(type="radial",_fx&&_fy){fx=toFloat(_fx);var dir=2*(.5<(fy=toFloat(_fy)))-1;.25<pow(fx-.5,2)+pow(fy-.5,2)&&(fy=math.sqrt(.25-pow(fx-.5,2))*dir+.5)&&.5!=fy&&(fy=fy.toFixed(5)-1e-5*dir)}return E})).split(/\s*\-\s*/),"linear"==type){var angle=gradient.shift();if(angle=-toFloat(angle),isNaN(angle))return null;var vector=[0,0,math.cos(R.rad(angle)),math.sin(R.rad(angle))],max=1/(mmax(abs(vector[2]),abs(vector[3]))||1);vector[2]*=max,vector[3]*=max,vector[2]<0&&(vector[0]=-vector[2],vector[2]=0),vector[3]<0&&(vector[1]=-vector[3],vector[3]=0)}var dots=R._parseDots(gradient);if(!dots)return null;if(id=id.replace(/[\(\)\s,\xb0#]/g,"_"),element.gradient&&id!=element.gradient.id&&(SVG.defs.removeChild(element.gradient),delete element.gradient),!element.gradient){el=$(type+"Gradient",{id:id}),element.gradient=el,$(el,"radial"==type?{fx:fx,fy:fy}:{x1:vector[0],y1:vector[1],x2:vector[2],y2:vector[3]}),SVG.defs.appendChild(el);for(var i=0,ii=dots.length;i<ii;i++)el.appendChild($("stop",{offset:dots[i].offset?dots[i].offset:i?"100%":"0%","stop-color":dots[i].color||"#fff"}))}}return $(o,{fill:"url(#"+id+")",opacity:1,"fill-opacity":1}),s.fill=E,s.opacity=1,s.fillOpacity=1},updatePosition=function(o){var bbox=o.getBBox(1);$(o.pattern,{patternTransform:o.matrix.invert()+" translate("+bbox.x+","+bbox.y+")"})},addArrow=function(o,value,isEnd){if("path"==o.type){for(var from,to,dx,refX,attr,values=Str(value).toLowerCase().split("-"),p=o.paper,se=isEnd?"end":"start",node=o.node,attrs=o.attrs,stroke=attrs["stroke-width"],i=values.length,type="classic",w=3,h=3,t=5;i--;)switch(values[i]){case"block":case"classic":case"oval":case"diamond":case"open":case"none":type=values[i];break;case"wide":h=5;break;case"narrow":h=2;break;case"long":w=5;break;case"short":w=2}if(attr="open"==type?(w+=2,h+=2,t+=2,dx=1,refX=isEnd?4:1,{fill:"none",stroke:attrs.stroke}):(refX=dx=w/2,{fill:attrs.stroke,stroke:"none"}),o._.arrows?isEnd?(o._.arrows.endPath&&markerCounter[o._.arrows.endPath]--,o._.arrows.endMarker&&markerCounter[o._.arrows.endMarker]--):(o._.arrows.startPath&&markerCounter[o._.arrows.startPath]--,o._.arrows.startMarker&&markerCounter[o._.arrows.startMarker]--):o._.arrows={},"none"!=type){var pathId="raphael-marker-"+type,markerId="raphael-marker-"+se+type+w+h;R._g.doc.getElementById(pathId)?markerCounter[pathId]++:(p.defs.appendChild($($("path"),{"stroke-linecap":"round",d:markers[type],id:pathId})),markerCounter[pathId]=1);var use,marker=R._g.doc.getElementById(markerId);marker?(markerCounter[markerId]++,use=marker.getElementsByTagName("use")[0]):(marker=$($("marker"),{id:markerId,markerHeight:h,markerWidth:w,orient:"auto",refX:refX,refY:h/2}),use=$($("use"),{"xlink:href":"#"+pathId,transform:(isEnd?"rotate(180 "+w/2+" "+h/2+") ":E)+"scale("+w/t+","+h/t+")","stroke-width":(1/((w/t+h/t)/2)).toFixed(4)}),marker.appendChild(use),p.defs.appendChild(marker),markerCounter[markerId]=1),$(use,attr);var delta=dx*("diamond"!=type&&"oval"!=type);to=isEnd?(from=o._.arrows.startdx*stroke||0,R.getTotalLength(attrs.path)-delta*stroke):(from=delta*stroke,R.getTotalLength(attrs.path)-(o._.arrows.enddx*stroke||0)),(attr={})["marker-"+se]="url(#"+markerId+")",(to||from)&&(attr.d=Raphael.getSubpath(attrs.path,from,to)),$(node,attr),o._.arrows[se+"Path"]=pathId,o._.arrows[se+"Marker"]=markerId,o._.arrows[se+"dx"]=delta,o._.arrows[se+"Type"]=type,o._.arrows[se+"String"]=value}else to=isEnd?(from=o._.arrows.startdx*stroke||0,R.getTotalLength(attrs.path)-from):(from=0,R.getTotalLength(attrs.path)-(o._.arrows.enddx*stroke||0)),o._.arrows[se+"Path"]&&$(node,{d:Raphael.getSubpath(attrs.path,from,to)}),delete o._.arrows[se+"Path"],delete o._.arrows[se+"Marker"],delete o._.arrows[se+"dx"],delete o._.arrows[se+"Type"],delete o._.arrows[se+"String"];for(attr in markerCounter)if(markerCounter[has](attr)&&!markerCounter[attr]){var item=R._g.doc.getElementById(attr);item&&item.parentNode.removeChild(item)}}},dasharray={"":[0],none:[0],"-":[3,1],".":[1,1],"-.":[3,1,1,1],"-..":[3,1,1,1,1,1],". ":[1,3],"- ":[4,3],"--":[8,3],"- .":[4,3,1,3],"--.":[8,3,1,3],"--..":[8,3,1,3,1,3]},addDashes=function(o,value,params){if(value=dasharray[Str(value).toLowerCase()]){for(var width=o.attrs["stroke-width"]||"1",butt={round:width,square:width,butt:0}[o.attrs["stroke-linecap"]||params["stroke-linecap"]]||0,dashes=[],i=value.length;i--;)dashes[i]=value[i]*width+(i%2?1:-1)*butt;$(o.node,{"stroke-dasharray":dashes.join(",")})}},setFillAndStroke=function(o,params){var node=o.node,attrs=o.attrs,vis=node.style.visibility;for(var att in node.style.visibility="hidden",params)if(params[has](att)){if(!R._availableAttrs[has](att))continue;var value=params[att];switch(attrs[att]=value,att){case"blur":o.blur(value);break;case"href":case"title":case"target":var pn=node.parentNode;if("a"!=pn.tagName.toLowerCase()){var hl=$("a");pn.insertBefore(hl,node),hl.appendChild(node),pn=hl}"target"==att?pn.setAttributeNS(xlink,"show","blank"==value?"new":value):pn.setAttributeNS(xlink,att,value);break;case"cursor":node.style.cursor=value;break;case"transform":o.transform(value);break;case"arrow-start":addArrow(o,value);break;case"arrow-end":addArrow(o,value,1);break;case"clip-rect":var rect=Str(value).split(separator);if(4==rect.length){o.clip&&o.clip.parentNode.parentNode.removeChild(o.clip.parentNode);var el=$("clipPath"),rc=$("rect");el.id=R.createUUID(),$(rc,{x:rect[0],y:rect[1],width:rect[2],height:rect[3]}),el.appendChild(rc),o.paper.defs.appendChild(el),$(node,{"clip-path":"url(#"+el.id+")"}),o.clip=rc}if(!value){var path=node.getAttribute("clip-path");if(path){var clip=R._g.doc.getElementById(path.replace(/(^url\(#|\)$)/g,E));clip&&clip.parentNode.removeChild(clip),$(node,{"clip-path":E}),delete o.clip}}break;case"path":"path"==o.type&&($(node,{d:value?attrs.path=R._pathToAbsolute(value):"M0,0"}),o._.dirty=1,o._.arrows&&("startString"in o._.arrows&&addArrow(o,o._.arrows.startString),"endString"in o._.arrows&&addArrow(o,o._.arrows.endString,1)));break;case"width":if(node.setAttribute(att,value),o._.dirty=1,!attrs.fx)break;att="x",value=attrs.x;case"x":attrs.fx&&(value=-attrs.x-(attrs.width||0));case"rx":if("rx"==att&&"rect"==o.type)break;case"cx":node.setAttribute(att,value),o.pattern&&updatePosition(o),o._.dirty=1;break;case"height":if(node.setAttribute(att,value),o._.dirty=1,!attrs.fy)break;att="y",value=attrs.y;case"y":attrs.fy&&(value=-attrs.y-(attrs.height||0));case"ry":if("ry"==att&&"rect"==o.type)break;case"cy":node.setAttribute(att,value),o.pattern&&updatePosition(o),o._.dirty=1;break;case"r":"rect"==o.type?$(node,{rx:value,ry:value}):node.setAttribute(att,value),o._.dirty=1;break;case"src":"image"==o.type&&node.setAttributeNS(xlink,"href",value);break;case"stroke-width":1==o._.sx&&1==o._.sy||(value/=mmax(abs(o._.sx),abs(o._.sy))||1),node.setAttribute(att,value),attrs["stroke-dasharray"]&&addDashes(o,attrs["stroke-dasharray"],params),o._.arrows&&("startString"in o._.arrows&&addArrow(o,o._.arrows.startString),"endString"in o._.arrows&&addArrow(o,o._.arrows.endString,1));break;case"stroke-dasharray":addDashes(o,value,params);break;case"fill":var isURL=Str(value).match(R._ISURL);if(isURL){el=$("pattern");var ig=$("image");el.id=R.createUUID(),$(el,{x:0,y:0,patternUnits:"userSpaceOnUse",height:1,width:1}),$(ig,{x:0,y:0,"xlink:href":isURL[1]}),el.appendChild(ig),function(el){R._preload(isURL[1],function(){var w=this.offsetWidth,h=this.offsetHeight;$(el,{width:w,height:h}),$(ig,{width:w,height:h}),o.paper.safari()})}(el),o.paper.defs.appendChild(el),$(node,{fill:"url(#"+el.id+")"}),o.pattern=el,o.pattern&&updatePosition(o);break}var clr=R.getRGB(value);if(clr.error){if(("circle"==o.type||"ellipse"==o.type||"r"!=Str(value).charAt())&&addGradientFill(o,value)){if("opacity"in attrs||"fill-opacity"in attrs){var gradient=R._g.doc.getElementById(node.getAttribute("fill").replace(/^url\(#|\)$/g,E));if(gradient){var stops=gradient.getElementsByTagName("stop");$(stops[stops.length-1],{"stop-opacity":("opacity"in attrs?attrs.opacity:1)*("fill-opacity"in attrs?attrs["fill-opacity"]:1)})}}attrs.gradient=value,attrs.fill="none";break}}else delete params.gradient,delete attrs.gradient,!R.is(attrs.opacity,"undefined")&&R.is(params.opacity,"undefined")&&$(node,{opacity:attrs.opacity}),!R.is(attrs["fill-opacity"],"undefined")&&R.is(params["fill-opacity"],"undefined")&&$(node,{"fill-opacity":attrs["fill-opacity"]});clr[has]("opacity")&&$(node,{"fill-opacity":1<clr.opacity?clr.opacity/100:clr.opacity});case"stroke":clr=R.getRGB(value),node.setAttribute(att,clr.hex),"stroke"==att&&clr[has]("opacity")&&$(node,{"stroke-opacity":1<clr.opacity?clr.opacity/100:clr.opacity}),"stroke"==att&&o._.arrows&&("startString"in o._.arrows&&addArrow(o,o._.arrows.startString),"endString"in o._.arrows&&addArrow(o,o._.arrows.endString,1));break;case"gradient":("circle"==o.type||"ellipse"==o.type||"r"!=Str(value).charAt())&&addGradientFill(o,value);break;case"opacity":attrs.gradient&&!attrs[has]("stroke-opacity")&&$(node,{"stroke-opacity":1<value?value/100:value});case"fill-opacity":if(attrs.gradient){(gradient=R._g.doc.getElementById(node.getAttribute("fill").replace(/^url\(#|\)$/g,E)))&&(stops=gradient.getElementsByTagName("stop"),$(stops[stops.length-1],{"stop-opacity":value}));break}default:"font-size"==att&&(value=toInt(value,10)+"px");var cssrule=att.replace(/(\-.)/g,function(w){return w.substring(1).toUpperCase()});node.style[cssrule]=value,o._.dirty=1,node.setAttribute(att,value)}}tuneText(o,params),node.style.visibility=vis},tuneText=function(el,params){if("text"==el.type&&(params[has]("text")||params[has]("font")||params[has]("font-size")||params[has]("x")||params[has]("y"))){var a=el.attrs,node=el.node,fontSize=node.firstChild?toInt(R._g.doc.defaultView.getComputedStyle(node.firstChild,E).getPropertyValue("font-size"),10):10;if(params[has]("text")){for(a.text=params.text;node.firstChild;)node.removeChild(node.firstChild);for(var tspan,texts=Str(params.text).split("\n"),tspans=[],i=0,ii=texts.length;i<ii;i++)tspan=$("tspan"),i&&$(tspan,{dy:1.2*fontSize,x:a.x}),tspan.appendChild(R._g.doc.createTextNode(texts[i])),node.appendChild(tspan),tspans[i]=tspan}else for(i=0,ii=(tspans=node.getElementsByTagName("tspan")).length;i<ii;i++)i?$(tspans[i],{dy:1.2*fontSize,x:a.x}):$(tspans[0],{dy:0});$(node,{x:a.x,y:a.y}),el._.dirty=1;var bb=el._getBBox(),dif=a.y-(bb.y+bb.height/2);dif&&R.is(dif,"finite")&&$(tspans[0],{dy:dif})}},Element=function(node,svg){this[0]=this.node=node,node.raphael=!0,this.id=R._oid++,node.raphaelid=this.id,this.matrix=R.matrix(),this.realPath=null,this.paper=svg,this.attrs=this.attrs||{},this._={transform:[],sx:1,sy:1,deg:0,dx:0,dy:0,dirty:1},!svg.bottom&&(svg.bottom=this),this.prev=svg.top,svg.top&&(svg.top.next=this),(svg.top=this).next=null},elproto=R.el;(Element.prototype=elproto).constructor=Element,R._engine.path=function(pathString,SVG){var el=$("path");SVG.canvas&&SVG.canvas.appendChild(el);var p=new Element(el,SVG);return p.type="path",setFillAndStroke(p,{fill:"none",stroke:"#000",path:pathString}),p},elproto.rotate=function(deg,cx,cy){if(this.removed)return this;if((deg=Str(deg).split(separator)).length-1&&(cx=toFloat(deg[1]),cy=toFloat(deg[2])),deg=toFloat(deg[0]),null==cy&&(cx=cy),null==cx||null==cy){var bbox=this.getBBox(1);cx=bbox.x+bbox.width/2,cy=bbox.y+bbox.height/2}return this.transform(this._.transform.concat([["r",deg,cx,cy]])),this},elproto.scale=function(sx,sy,cx,cy){if(this.removed)return this;if((sx=Str(sx).split(separator)).length-1&&(sy=toFloat(sx[1]),cx=toFloat(sx[2]),cy=toFloat(sx[3])),sx=toFloat(sx[0]),null==sy&&(sy=sx),null==cy&&(cx=cy),null==cx||null==cy)var bbox=this.getBBox(1);return cx=null==cx?bbox.x+bbox.width/2:cx,cy=null==cy?bbox.y+bbox.height/2:cy,this.transform(this._.transform.concat([["s",sx,sy,cx,cy]])),this},elproto.translate=function(dx,dy){return this.removed||((dx=Str(dx).split(separator)).length-1&&(dy=toFloat(dx[1])),dx=toFloat(dx[0])||0,dy=+dy||0,this.transform(this._.transform.concat([["t",dx,dy]]))),this},elproto.transform=function(tstr){var _=this._;if(null==tstr)return _.transform;if(R._extractTransform(this,tstr),this.clip&&$(this.clip,{transform:this.matrix.invert()}),this.pattern&&updatePosition(this),this.node&&$(this.node,{transform:this.matrix}),1!=_.sx||1!=_.sy){var sw=this.attrs[has]("stroke-width")?this.attrs["stroke-width"]:1;this.attr({"stroke-width":sw})}return this},elproto.hide=function(){return!this.removed&&this.paper.safari(this.node.style.display="none"),this},elproto.show=function(){return!this.removed&&this.paper.safari(this.node.style.display=""),this},elproto.remove=function(){if(!this.removed&&this.node.parentNode){var paper=this.paper;for(var i in paper.__set__&&paper.__set__.exclude(this),eve.unbind("raphael.*.*."+this.id),this.gradient&&paper.defs.removeChild(this.gradient),R._tear(this,paper),"a"==this.node.parentNode.tagName.toLowerCase()?this.node.parentNode.parentNode.removeChild(this.node.parentNode):this.node.parentNode.removeChild(this.node),this)this[i]="function"==typeof this[i]?R._removedFactory(i):null;this.removed=!0}},elproto._getBBox=function(){if("none"==this.node.style.display){this.show();var hide=!0}var bbox={};try{bbox=this.node.getBBox()}catch(e){}finally{bbox=bbox||{}}return hide&&this.hide(),bbox},elproto.attr=function(name,value){if(this.removed)return this;if(null==name){var res={};for(var a in this.attrs)this.attrs[has](a)&&(res[a]=this.attrs[a]);return res.gradient&&"none"==res.fill&&(res.fill=res.gradient)&&delete res.gradient,res.transform=this._.transform,res}if(null==value&&R.is(name,"string")){if("fill"==name&&"none"==this.attrs.fill&&this.attrs.gradient)return this.attrs.gradient;if("transform"==name)return this._.transform;for(var names=name.split(separator),out={},i=0,ii=names.length;i<ii;i++)(name=names[i])in this.attrs?out[name]=this.attrs[name]:R.is(this.paper.customAttributes[name],"function")?out[name]=this.paper.customAttributes[name].def:out[name]=R._availableAttrs[name];return ii-1?out:out[names[0]]}if(null==value&&R.is(name,"array")){for(out={},i=0,ii=name.length;i<ii;i++)out[name[i]]=this.attr(name[i]);return out}if(null!=value){var params={};params[name]=value}else null!=name&&R.is(name,"object")&&(params=name);for(var key in params)eve("raphael.attr."+key+"."+this.id,this,params[key]);for(key in this.paper.customAttributes)if(this.paper.customAttributes[has](key)&&params[has](key)&&R.is(this.paper.customAttributes[key],"function")){var par=this.paper.customAttributes[key].apply(this,[].concat(params[key]));for(var subkey in this.attrs[key]=params[key],par)par[has](subkey)&&(params[subkey]=par[subkey])}return setFillAndStroke(this,params),this},elproto.toFront=function(){if(this.removed)return this;"a"==this.node.parentNode.tagName.toLowerCase()?this.node.parentNode.parentNode.appendChild(this.node.parentNode):this.node.parentNode.appendChild(this.node);var svg=this.paper;return svg.top!=this&&R._tofront(this,svg),this},elproto.toBack=function(){if(this.removed)return this;var parent=this.node.parentNode;"a"==parent.tagName.toLowerCase()?parent.parentNode.insertBefore(this.node.parentNode,this.node.parentNode.parentNode.firstChild):parent.firstChild!=this.node&&parent.insertBefore(this.node,this.node.parentNode.firstChild),R._toback(this,this.paper);this.paper;return this},elproto.insertAfter=function(element){if(this.removed)return this;var node=element.node||element[element.length-1].node;return node.nextSibling?node.parentNode.insertBefore(this.node,node.nextSibling):node.parentNode.appendChild(this.node),R._insertafter(this,element,this.paper),this},elproto.insertBefore=function(element){if(this.removed)return this;try{var node=element.node||element[0].node;node.parentNode.insertBefore(this.node,node),R._insertbefore(this,element,this.paper)}catch(exp){console.log(exp)}return this},elproto.blur=function(size){var t=this;if(0!=+size){var fltr=$("filter"),blur=$("feGaussianBlur");t.attrs.blur=size,fltr.id=R.createUUID(),$(blur,{stdDeviation:+size||1.5}),fltr.appendChild(blur),t.paper.defs.appendChild(fltr),t._blur=fltr,$(t.node,{filter:"url(#"+fltr.id+")"})}else t._blur&&(t._blur.parentNode.removeChild(t._blur),delete t._blur,delete t.attrs.blur),t.node.removeAttribute("filter")},R._engine.circle=function(svg,x,y,r){var el=$("circle");svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);return res.attrs={cx:x,cy:y,r:r,fill:"none",stroke:"#000"},res.type="circle",$(el,res.attrs),res},R._engine.rect=function(svg,x,y,w,h,r){var el=$("rect");svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);return res.attrs={x:x,y:y,width:w,height:h,rx:r||0,ry:r||0,fill:"none",stroke:"#000"},res.type="rect",$(el,res.attrs),res},R._engine.ellipse=function(svg,x,y,rx,ry){var el=$("ellipse");svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);return res.attrs={cx:x,cy:y,rx:rx,ry:ry,fill:"none",stroke:"#000"},res.type="ellipse",$(el,res.attrs),res},R._engine.image=function(svg,src,x,y,w,h){var el=$("image");$(el,{x:x,y:y,width:w,height:h,preserveAspectRatio:"none"}),el.setAttributeNS(xlink,"href",src),svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);return res.attrs={x:x,y:y,width:w,height:h,src:src},res.type="image",res},R._engine.text=function(svg,x,y,text){var el=$("text");svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);return res.attrs={x:x,y:y,"text-anchor":"middle",text:text,"font-family":R._availableAttrs["font-family"],"font-size":R._availableAttrs["font-size"],stroke:"none",fill:"#000"},res.type="text",setFillAndStroke(res,res.attrs),res},R._engine.setSize=function(width,height){return this.width=width||this.width,this.height=height||this.height,this.canvas.setAttribute("width",this.width),this.canvas.setAttribute("height",this.height),this._viewBox&&this.setViewBox.apply(this,this._viewBox),this},R._engine.create=function(){var con=R._getContainer.apply(0,arguments),container=con&&con.container,x=con.x,y=con.y,width=con.width,height=con.height;if(!container)throw new Error("SVG container not found.");var isFloating,cnvs=$("svg"),css="overflow:hidden;";return x=x||0,y=y||0,$(cnvs,{height:height=height||342,version:1.1,width:width=width||512,xmlns:"http://www.w3.org/2000/svg"}),1==container?(cnvs.style.cssText=css+"position:absolute;left:"+x+"px;top:"+y+"px",R._g.doc.body.appendChild(cnvs),isFloating=1):(cnvs.style.cssText=css+"position:relative",container.firstChild?container.insertBefore(cnvs,container.firstChild):container.appendChild(cnvs)),(container=new R._Paper).width=width,container.height=height,container.canvas=cnvs,container.clear(),container._left=container._top=0,isFloating&&(container.renderfix=function(){}),container.renderfix(),container},R._engine.setViewBox=function(x,y,w,h,fit){eve("raphael.setViewBox",this,this._viewBox,[x,y,w,h,fit]);var vb,sw,size=mmax(w/this.width,h/this.height),top=this.top,aspectRatio=fit?"meet":"xMinYMin";for(vb=null==x?(this._vbSize&&(size=1),delete this._vbSize,"0 0 "+this.width+S+this.height):(this._vbSize=size,x+S+y+S+w+S+h),$(this.canvas,{viewBox:vb,preserveAspectRatio:aspectRatio});size&&top;)sw="stroke-width"in top.attrs?top.attrs["stroke-width"]:1,top.attr({"stroke-width":sw}),top._.dirty=1,top._.dirtyT=1,top=top.prev;return this._viewBox=[x,y,w,h,!!fit],this},R.prototype.renderfix=function(){var pos,cnvs=this.canvas,s=cnvs.style;try{pos=cnvs.getScreenCTM()||cnvs.createSVGMatrix()}catch(e){pos=cnvs.createSVGMatrix()}var left=-pos.e%1,top=-pos.f%1;(left||top)&&(left&&(this._left=(this._left+left)%1,s.left=this._left+"px"),top&&(this._top=(this._top+top)%1,s.top=this._top+"px"))},R.prototype.clear=function(){R.eve("raphael.clear",this);for(var c=this.canvas;c.firstChild;)c.removeChild(c.firstChild);this.bottom=this.top=null,(this.desc=$("desc")).appendChild(R._g.doc.createTextNode("Created with Raphal "+R.version)),c.appendChild(this.desc),c.appendChild(this.defs=$("defs"))},R.prototype.remove=function(){for(var i in eve("raphael.remove",this),this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this)this[i]="function"==typeof this[i]?R._removedFactory(i):null};var setproto=R.st;for(var method in elproto)elproto[has](method)&&!setproto[has](method)&&(setproto[method]=function(methodname){return function(){var arg=arguments;return this.forEach(function(el){el[methodname].apply(el,arg)})}}(method))}(window.Raphael),window.Raphael.vml&&function(R){var has="hasOwnProperty",Str=String,toFloat=parseFloat,math=Math,round=math.round,mmax=math.max,mmin=math.min,abs=math.abs,separator=/[, ]+/,eve=R.eve,S=" ",E="",map={M:"m",L:"l",C:"c",Z:"x",m:"t",l:"r",c:"v",z:"x"},bites=/([clmz]),?([^clmz]*)/gi,blurregexp=/ progid:\S+Blur\([^\)]+\)/g,val=/-?[^,\s-]+/g,cssDot="position:absolute;left:0;top:0;width:1px;height:1px",zoom=21600,pathTypes={path:1,rect:1,image:1},ovalTypes={circle:1,ellipse:1},compensation=function(deg,dx,dy){var m=R.matrix();return m.rotate(-deg,.5,.5),{dx:m.x(dx,dy),dy:m.y(dx,dy)}},setCoords=function(p,sx,sy,dx,dy,deg){var _=p._,m=p.matrix,fillpos=_.fillpos,o=p.node,s=o.style,y=1,flip="",kx=zoom/sx,ky=zoom/sy;if(s.visibility="hidden",sx&&sy){if(o.coordsize=abs(kx)+S+abs(ky),s.rotation=deg*(sx*sy<0?-1:1),deg){var c=compensation(deg,dx,dy);dx=c.dx,dy=c.dy}if(sx<0&&(flip+="x"),sy<0&&(flip+=" y")&&(y=-1),s.flip=flip,o.coordorigin=dx*-kx+S+dy*-ky,fillpos||_.fillsize){var fill=o.getElementsByTagName("fill");fill=fill&&fill[0],o.removeChild(fill),fillpos&&(c=compensation(deg,m.x(fillpos[0],fillpos[1]),m.y(fillpos[0],fillpos[1])),fill.position=c.dx*y+S+c.dy*y),_.fillsize&&(fill.size=_.fillsize[0]*abs(sx)+S+_.fillsize[1]*abs(sy)),o.appendChild(fill)}s.visibility="visible"}};R.toString=function(){return"Your browser doesnt support SVG. Falling down to VML.\nYou are running Raphal "+this.version};var createNode,addArrow=function(o,value,isEnd){for(var values=Str(value).toLowerCase().split("-"),se=isEnd?"end":"start",i=values.length,type="classic",w="medium",h="medium";i--;)switch(values[i]){case"block":case"classic":case"oval":case"diamond":case"open":case"none":type=values[i];break;case"wide":case"narrow":h=values[i];break;case"long":case"short":w=values[i]}var stroke=o.node.getElementsByTagName("stroke")[0];stroke[se+"arrow"]=type,stroke[se+"arrowlength"]=w,stroke[se+"arrowwidth"]=h},setFillAndStroke=function(o,params){o.attrs=o.attrs||{};var node=o.node,a=o.attrs,s=node.style,newpath=pathTypes[o.type]&&(params.x!=a.x||params.y!=a.y||params.width!=a.width||params.height!=a.height||params.cx!=a.cx||params.cy!=a.cy||params.rx!=a.rx||params.ry!=a.ry||params.r!=a.r),isOval=ovalTypes[o.type]&&(a.cx!=params.cx||a.cy!=params.cy||a.r!=params.r||a.rx!=params.rx||a.ry!=params.ry),res=o;for(var par in params)params[has](par)&&(a[par]=params[par]);if(newpath&&(a.path=R._getPath[o.type](o),o._.dirty=1),params.href&&(node.href=params.href),params.title&&(node.title=params.title),params.target&&(node.target=params.target),params.cursor&&(s.cursor=params.cursor),"blur"in params&&o.blur(params.blur),(params.path&&"path"==o.type||newpath)&&(node.path=function(path){var total=/[ahqstv]/gi,command=R._pathToAbsolute;if(Str(path).match(total)&&(command=R._path2curve),total=/[clmz]/g,command==R._pathToAbsolute&&!Str(path).match(total)){var res=Str(path).replace(bites,function(all,command,args){var vals=[],isMove="m"==command.toLowerCase(),res=map[command];return args.replace(val,function(value){isMove&&2==vals.length&&(res+=vals+map["m"==command?"l":"L"],vals=[]),vals.push(round(value*zoom))}),res+vals});return res}var p,r,pa=command(path);res=[];for(var i=0,ii=pa.length;i<ii;i++){p=pa[i],"z"==(r=pa[i][0].toLowerCase())&&(r="x");for(var j=1,jj=p.length;j<jj;j++)r+=round(p[j]*zoom)+(j!=jj-1?",":E);res.push(r)}return res.join(S)}(~Str(a.path).toLowerCase().indexOf("r")?R._pathToAbsolute(a.path):a.path),"image"==o.type&&(o._.fillpos=[a.x,a.y],o._.fillsize=[a.width,a.height],setCoords(o,1,1,0,0,0))),"transform"in params&&o.transform(params.transform),isOval){var cx=+a.cx,cy=+a.cy,rx=+a.rx||+a.r||0,ry=+a.ry||+a.r||0;node.path=R.format("ar{0},{1},{2},{3},{4},{1},{4},{1}x",round((cx-rx)*zoom),round((cy-ry)*zoom),round((cx+rx)*zoom),round((cy+ry)*zoom),round(cx*zoom))}if("clip-rect"in params){var rect=Str(params["clip-rect"]).split(separator);if(4==rect.length){rect[2]=+rect[2]+ +rect[0],rect[3]=+rect[3]+ +rect[1];var div=node.clipRect||R._g.doc.createElement("div"),dstyle=div.style;dstyle.clip=R.format("rect({1}px {2}px {3}px {0}px)",rect),node.clipRect||(dstyle.position="absolute",dstyle.top=0,dstyle.left=0,dstyle.width=o.paper.width+"px",dstyle.height=o.paper.height+"px",node.parentNode.insertBefore(div,node),div.appendChild(node),node.clipRect=div)}params["clip-rect"]||node.clipRect&&(node.clipRect.style.clip="auto")}if(o.textpath){var textpathStyle=o.textpath.style;params.font&&(textpathStyle.font=params.font),params["font-family"]&&(textpathStyle.fontFamily='"'+params["font-family"].split(",")[0].replace(/^['"]+|['"]+$/g,E)+'"'),params["font-size"]&&(textpathStyle.fontSize=params["font-size"]),params["font-weight"]&&(textpathStyle.fontWeight=params["font-weight"]),params["font-style"]&&(textpathStyle.fontStyle=params["font-style"])}if("arrow-start"in params&&addArrow(res,params["arrow-start"]),"arrow-end"in params&&addArrow(res,params["arrow-end"],1),null!=params.opacity||null!=params["stroke-width"]||null!=params.fill||null!=params.src||null!=params.stroke||null!=params["stroke-width"]||null!=params["stroke-opacity"]||null!=params["fill-opacity"]||null!=params["stroke-dasharray"]||null!=params["stroke-miterlimit"]||null!=params["stroke-linejoin"]||null!=params["stroke-linecap"]){var fill=node.getElementsByTagName("fill");if(!(fill=fill&&fill[0])&&(fill=createNode("fill")),"image"==o.type&&params.src&&(fill.src=params.src),params.fill&&(fill.on=!0),null!=fill.on&&"none"!=params.fill&&null!==params.fill||(fill.on=!1),fill.on&&params.fill){var isURL=Str(params.fill).match(R._ISURL);if(isURL){fill.parentNode==node&&node.removeChild(fill),fill.rotate=!0,fill.src=isURL[1],fill.type="tile";var bbox=o.getBBox(1);fill.position=bbox.x+S+bbox.y,o._.fillpos=[bbox.x,bbox.y],R._preload(isURL[1],function(){o._.fillsize=[this.offsetWidth,this.offsetHeight]})}else fill.color=R.getRGB(params.fill).hex,fill.src=E,fill.type="solid",R.getRGB(params.fill).error&&(res.type in{circle:1,ellipse:1}||"r"!=Str(params.fill).charAt())&&addGradientFill(res,params.fill,fill)&&(a.fill="none",a.gradient=params.fill,fill.rotate=!1)}if("fill-opacity"in params||"opacity"in params){var opacity=((+a["fill-opacity"]+1||2)-1)*((+a.opacity+1||2)-1)*((+R.getRGB(params.fill).o+1||2)-1);opacity=mmin(mmax(opacity,0),1),fill.opacity=opacity,fill.src&&(fill.color="none")}node.appendChild(fill);var stroke=node.getElementsByTagName("stroke")&&node.getElementsByTagName("stroke")[0],newstroke=!1;!stroke&&(newstroke=stroke=createNode("stroke")),(params.stroke&&"none"!=params.stroke||params["stroke-width"]||null!=params["stroke-opacity"]||params["stroke-dasharray"]||params["stroke-miterlimit"]||params["stroke-linejoin"]||params["stroke-linecap"])&&(stroke.on=!0),("none"==params.stroke||null===params.stroke||null==stroke.on||0==params.stroke||0==params["stroke-width"])&&(stroke.on=!1);var strokeColor=R.getRGB(params.stroke);stroke.on&&params.stroke&&(stroke.color=strokeColor.hex),opacity=((+a["stroke-opacity"]+1||2)-1)*((+a.opacity+1||2)-1)*((+strokeColor.o+1||2)-1);var width=.75*(toFloat(params["stroke-width"])||1);if(opacity=mmin(mmax(opacity,0),1),null==params["stroke-width"]&&(width=a["stroke-width"]),params["stroke-width"]&&(stroke.weight=width),width&&width<1&&(opacity*=width)&&(stroke.weight=1),stroke.opacity=opacity,params["stroke-linejoin"]&&(stroke.joinstyle=params["stroke-linejoin"]||"miter"),stroke.miterlimit=params["stroke-miterlimit"]||8,params["stroke-linecap"]&&(stroke.endcap="butt"==params["stroke-linecap"]?"flat":"square"==params["stroke-linecap"]?"square":"round"),params["stroke-dasharray"]){var dasharray={"-":"shortdash",".":"shortdot","-.":"shortdashdot","-..":"shortdashdotdot",". ":"dot","- ":"dash","--":"longdash","- .":"dashdot","--.":"longdashdot","--..":"longdashdotdot"};stroke.dashstyle=dasharray[has](params["stroke-dasharray"])?dasharray[params["stroke-dasharray"]]:E}newstroke&&node.appendChild(stroke)}if("text"==res.type){res.paper.canvas.style.display=E;var span=res.paper.span,fontSize=a.font&&a.font.match(/\d+(?:\.\d*)?(?=px)/);s=span.style,a.font&&(s.font=a.font),a["font-family"]&&(s.fontFamily=a["font-family"]),a["font-weight"]&&(s.fontWeight=a["font-weight"]),a["font-style"]&&(s.fontStyle=a["font-style"]),fontSize=toFloat(a["font-size"]||fontSize&&fontSize[0])||10,s.fontSize=100*fontSize+"px",res.textpath.string&&(span.innerHTML=Str(res.textpath.string).replace(/</g,"&#60;").replace(/&/g,"&#38;").replace(/\n/g,"<br>"));var brect=span.getBoundingClientRect();res.W=a.w=(brect.right-brect.left)/100,res.H=a.h=(brect.bottom-brect.top)/100,res.X=a.x,res.Y=a.y+res.H/2,("x"in params||"y"in params)&&(res.path.v=R.format("m{0},{1}l{2},{1}",round(a.x*zoom),round(a.y*zoom),round(a.x*zoom)+1));for(var dirtyattrs=["x","y","text","font","font-family","font-weight","font-style","font-size"],d=0,dd=dirtyattrs.length;d<dd;d++)if(dirtyattrs[d]in params){res._.dirty=1;break}switch(a["text-anchor"]){case"start":res.textpath.style["v-text-align"]="left",res.bbx=res.W/2;break;case"end":res.textpath.style["v-text-align"]="right",res.bbx=-res.W/2;break;default:res.textpath.style["v-text-align"]="center",res.bbx=0}res.textpath.style["v-text-kern"]=!0}},addGradientFill=function(o,gradient,fill){o.attrs=o.attrs||{};o.attrs;var pow=Math.pow,type="linear",fxfy=".5 .5";if(o.attrs.gradient=gradient,gradient=(gradient=Str(gradient).replace(R._radial_gradient,function(all,fx,fy){return type="radial",fx&&fy&&(fx=toFloat(fx),fy=toFloat(fy),.25<pow(fx-.5,2)+pow(fy-.5,2)&&(fy=math.sqrt(.25-pow(fx-.5,2))*(2*(.5<fy)-1)+.5),fxfy=fx+S+fy),E})).split(/\s*\-\s*/),"linear"==type){var angle=gradient.shift();if(angle=-toFloat(angle),isNaN(angle))return null}var dots=R._parseDots(gradient);if(!dots)return null;if(o=o.shape||o.node,dots.length){o.removeChild(fill),fill.on=!0,fill.method="none",fill.color=dots[0].color,fill.color2=dots[dots.length-1].color;for(var clrs=[],i=0,ii=dots.length;i<ii;i++)dots[i].offset&&clrs.push(dots[i].offset+S+dots[i].color);fill.colors=clrs.length?clrs.join():"0% "+fill.color,"radial"==type?(fill.type="gradientTitle",fill.focus="100%",fill.focussize="0 0",fill.focusposition=fxfy,fill.angle=0):(fill.type="gradient",fill.angle=(270-angle)%360),o.appendChild(fill)}return 1},Element=function(node,vml){this[0]=this.node=node,node.raphael=!0,this.id=R._oid++,node.raphaelid=this.id,this.X=0,this.Y=0,this.attrs={},this.paper=vml,this.matrix=R.matrix(),this._={transform:[],sx:1,sy:1,dx:0,dy:0,deg:0,dirty:1,dirtyT:1},!vml.bottom&&(vml.bottom=this),this.prev=vml.top,vml.top&&(vml.top.next=this),(vml.top=this).next=null},elproto=R.el;(Element.prototype=elproto).constructor=Element,elproto.transform=function(tstr){if(null==tstr)return this._.transform;var oldt,vbs=this.paper._viewBoxShift,vbt=vbs?"s"+[vbs.scale,vbs.scale]+"-1-1t"+[vbs.dx,vbs.dy]:E;vbs&&(oldt=tstr=Str(tstr).replace(/\.{3}|\u2026/g,this._.transform||E)),R._extractTransform(this,vbt+tstr);var split,matrix=this.matrix.clone(),skew=this.skew,o=this.node,isGrad=~Str(this.attrs.fill).indexOf("-"),isPatt=!Str(this.attrs.fill).indexOf("url(");if(matrix.translate(-.5,-.5),isPatt||isGrad||"image"==this.type)if(skew.matrix="1 0 0 1",skew.offset="0 0",split=matrix.split(),isGrad&&split.noRotation||!split.isSimple){o.style.filter=matrix.toFilter();var bb=this.getBBox(),bbt=this.getBBox(1),dx=bb.x-bbt.x,dy=bb.y-bbt.y;o.coordorigin=dx*-zoom+S+dy*-zoom,setCoords(this,1,1,dx,dy,0)}else o.style.filter=E,setCoords(this,split.scalex,split.scaley,split.dx,split.dy,split.rotate);else o.style.filter=E,skew.matrix=Str(matrix),skew.offset=matrix.offset();return oldt&&(this._.transform=oldt),this},elproto.rotate=function(deg,cx,cy){if(this.removed)return this;if(null!=deg){if((deg=Str(deg).split(separator)).length-1&&(cx=toFloat(deg[1]),cy=toFloat(deg[2])),deg=toFloat(deg[0]),null==cy&&(cx=cy),null==cx||null==cy){var bbox=this.getBBox(1);cx=bbox.x+bbox.width/2,cy=bbox.y+bbox.height/2}return this._.dirtyT=1,this.transform(this._.transform.concat([["r",deg,cx,cy]])),this}},elproto.translate=function(dx,dy){return this.removed||((dx=Str(dx).split(separator)).length-1&&(dy=toFloat(dx[1])),dx=toFloat(dx[0])||0,dy=+dy||0,this._.bbox&&(this._.bbox.x+=dx,this._.bbox.y+=dy),this.transform(this._.transform.concat([["t",dx,dy]]))),this},elproto.scale=function(sx,sy,cx,cy){if(this.removed)return this;if((sx=Str(sx).split(separator)).length-1&&(sy=toFloat(sx[1]),cx=toFloat(sx[2]),cy=toFloat(sx[3]),isNaN(cx)&&(cx=null),isNaN(cy)&&(cy=null)),sx=toFloat(sx[0]),null==sy&&(sy=sx),null==cy&&(cx=cy),null==cx||null==cy)var bbox=this.getBBox(1);return cx=null==cx?bbox.x+bbox.width/2:cx,cy=null==cy?bbox.y+bbox.height/2:cy,this.transform(this._.transform.concat([["s",sx,sy,cx,cy]])),this._.dirtyT=1,this},elproto.hide=function(){return!this.removed&&(this.node.style.display="none"),this},elproto.show=function(){return!this.removed&&(this.node.style.display=E),this},elproto._getBBox=function(){return this.removed?{}:{x:this.X+(this.bbx||0)-this.W/2,y:this.Y-this.H,width:this.W,height:this.H}},elproto.remove=function(){if(!this.removed&&this.node.parentNode){for(var i in this.paper.__set__&&this.paper.__set__.exclude(this),R.eve.unbind("raphael.*.*."+this.id),R._tear(this,this.paper),this.node.parentNode.removeChild(this.node),this.shape&&this.shape.parentNode.removeChild(this.shape),this)this[i]="function"==typeof this[i]?R._removedFactory(i):null;this.removed=!0}},elproto.attr=function(name,value){if(this.removed)return this;if(null==name){var res={};for(var a in this.attrs)this.attrs[has](a)&&(res[a]=this.attrs[a]);return res.gradient&&"none"==res.fill&&(res.fill=res.gradient)&&delete res.gradient,res.transform=this._.transform,res}if(null==value&&R.is(name,"string")){if("fill"==name&&"none"==this.attrs.fill&&this.attrs.gradient)return this.attrs.gradient;for(var names=name.split(separator),out={},i=0,ii=names.length;i<ii;i++)(name=names[i])in this.attrs?out[name]=this.attrs[name]:R.is(this.paper.customAttributes[name],"function")?out[name]=this.paper.customAttributes[name].def:out[name]=R._availableAttrs[name];return ii-1?out:out[names[0]]}if(this.attrs&&null==value&&R.is(name,"array")){for(out={},i=0,ii=name.length;i<ii;i++)out[name[i]]=this.attr(name[i]);return out}var params;for(var key in null!=value&&((params={})[name]=value),null==value&&R.is(name,"object")&&(params=name),params)eve("raphael.attr."+key+"."+this.id,this,params[key]);if(params){for(key in this.paper.customAttributes)if(this.paper.customAttributes[has](key)&&params[has](key)&&R.is(this.paper.customAttributes[key],"function")){var par=this.paper.customAttributes[key].apply(this,[].concat(params[key]));for(var subkey in this.attrs[key]=params[key],par)par[has](subkey)&&(params[subkey]=par[subkey])}params.text&&"text"==this.type&&(this.textpath.string=params.text),setFillAndStroke(this,params)}return this},elproto.toFront=function(){return!this.removed&&this.node.parentNode.appendChild(this.node),this.paper&&this.paper.top!=this&&R._tofront(this,this.paper),this},elproto.toBack=function(){return this.removed||this.node.parentNode.firstChild!=this.node&&(this.node.parentNode.insertBefore(this.node,this.node.parentNode.firstChild),R._toback(this,this.paper)),this},elproto.insertAfter=function(element){return this.removed||(element.constructor==R.st.constructor&&(element=element[element.length-1]),element.node.nextSibling?element.node.parentNode.insertBefore(this.node,element.node.nextSibling):element.node.parentNode.appendChild(this.node),R._insertafter(this,element,this.paper)),this},elproto.insertBefore=function(element){return this.removed||(element.constructor==R.st.constructor&&(element=element[0]),element.node.parentNode.insertBefore(this.node,element.node),R._insertbefore(this,element,this.paper)),this},elproto.blur=function(size){var s=this.node.runtimeStyle,f=s.filter;f=f.replace(blurregexp,E),0!=+size?(this.attrs.blur=size,s.filter=f+S+" progid:DXImageTransform.Microsoft.Blur(pixelradius="+(+size||1.5)+")",s.margin=R.format("-{0}px 0 0 -{0}px",round(+size||1.5))):(s.filter=f,s.margin=0,delete this.attrs.blur)},R._engine.path=function(pathString,vml){var el=createNode("shape");el.style.cssText=cssDot,el.coordsize=zoom+S+zoom,el.coordorigin=vml.coordorigin;var p=new Element(el,vml),attr={fill:"none",stroke:"#000"};pathString&&(attr.path=pathString),p.type="path",p.path=[],p.Path=E,setFillAndStroke(p,attr),vml.canvas.appendChild(el);var skew=createNode("skew");return skew.on=!0,el.appendChild(skew),p.skew=skew,p.transform(E),p},R._engine.rect=function(vml,x,y,w,h,r){var path=R._rectPath(x,y,w,h,r),res=vml.path(path),a=res.attrs;return res.X=a.x=x,res.Y=a.y=y,res.W=a.width=w,res.H=a.height=h,a.r=r,a.path=path,res.type="rect",res},R._engine.ellipse=function(vml,x,y,rx,ry){var res=vml.path();res.attrs;return res.X=x-rx,res.Y=y-ry,res.W=2*rx,res.H=2*ry,res.type="ellipse",setFillAndStroke(res,{cx:x,cy:y,rx:rx,ry:ry}),res},R._engine.circle=function(vml,x,y,r){var res=vml.path();res.attrs;return res.X=x-r,res.Y=y-r,res.W=res.H=2*r,res.type="circle",setFillAndStroke(res,{cx:x,cy:y,r:r}),res},R._engine.image=function(vml,src,x,y,w,h){var path=R._rectPath(x,y,w,h),res=vml.path(path).attr({stroke:"none"}),a=res.attrs,node=res.node,fill=node.getElementsByTagName("fill")[0];return a.src=src,res.X=a.x=x,res.Y=a.y=y,res.W=a.width=w,res.H=a.height=h,a.path=path,res.type="image",fill.parentNode==node&&node.removeChild(fill),fill.rotate=!0,fill.src=src,fill.type="tile",res._.fillpos=[x,y],res._.fillsize=[w,h],node.appendChild(fill),setCoords(res,1,1,0,0,0),res},R._engine.text=function(vml,x,y,text){var el=createNode("shape"),path=createNode("path"),o=createNode("textpath");x=x||0,y=y||0,text=text||"",path.v=R.format("m{0},{1}l{2},{1}",round(x*zoom),round(y*zoom),round(x*zoom)+1),path.textpathok=!0,o.string=Str(text),o.on=!0,el.style.cssText=cssDot,el.coordsize=zoom+S+zoom,el.coordorigin="0 0";var p=new Element(el,vml),attr={fill:"#000",stroke:"none","font-family":R._availableAttrs["font-family"],"font-size":R._availableAttrs["font-size"],text:text};p.shape=el,p.path=path,p.textpath=o,p.type="text",p.attrs.text=Str(text),p.attrs.x=x,p.attrs.y=y,p.attrs.w=1,p.attrs.h=1,setFillAndStroke(p,attr),el.appendChild(o),el.appendChild(path),vml.canvas.appendChild(el);var skew=createNode("skew");return skew.on=!0,el.appendChild(skew),p.skew=skew,p.transform(E),p},R._engine.setSize=function(width,height){var cs=this.canvas.style;return(this.width=width)==+width&&(width+="px"),(this.height=height)==+height&&(height+="px"),cs.width=width,cs.height=height,cs.clip="rect(0 "+width+" "+height+" 0)",this._viewBox&&R._engine.setViewBox.apply(this,this._viewBox),this},R._engine.setViewBox=function(x,y,w,h,fit){R.eve("raphael.setViewBox",this,this._viewBox,[x,y,w,h,fit]);var H,W,width=this.width,height=this.height,size=1/mmax(w/width,h/height);return fit&&(w*(H=height/h)<width&&(x-=(width-w*H)/2/H),h*(W=width/w)<height&&(y-=(height-h*W)/2/W)),this._viewBox=[x,y,w,h,!!fit],this._viewBoxShift={dx:-x,dy:-y,scale:size},this.forEach(function(el){el.transform("...")}),this},R._engine.initWin=function(win){var doc=win.document;doc.createStyleSheet().addRule(".rvml","behavior:url(#default#VML)");try{!doc.namespaces.rvml&&doc.namespaces.add("rvml","urn:schemas-microsoft-com:vml"),createNode=function(tagName){return doc.createElement("<rvml:"+tagName+' class="rvml">')}}catch(e){createNode=function(tagName){return doc.createElement("<"+tagName+' xmlns="urn:schemas-microsoft.com:vml" class="rvml">')}}},R._engine.initWin(R._g.win),R._engine.create=function(){var con=R._getContainer.apply(0,arguments),container=con.container,height=con.height,width=con.width,x=con.x,y=con.y;if(!container)throw new Error("VML container not found.");var res=new R._Paper,c=res.canvas=R._g.doc.createElement("div"),cs=c.style;return x=x||0,y=y||0,width=width||512,height=height||342,(res.width=width)==+width&&(width+="px"),(res.height=height)==+height&&(height+="px"),res.coordsize=216e5+S+216e5,res.coordorigin="0 0",res.span=R._g.doc.createElement("span"),res.span.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;",c.appendChild(res.span),cs.cssText=R.format("top:0;left:0;width:{0};height:{1};display:inline-block;position:relative;clip:rect(0 {0} {1} 0);overflow:hidden",width,height),1==container?(R._g.doc.body.appendChild(c),cs.left=x+"px",cs.top=y+"px",cs.position="absolute"):container.firstChild?container.insertBefore(c,container.firstChild):container.appendChild(c),res.renderfix=function(){},res},R.prototype.clear=function(){R.eve("raphael.clear",this),this.canvas.innerHTML=E,this.span=R._g.doc.createElement("span"),this.span.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;display:inline;",this.canvas.appendChild(this.span),this.bottom=this.top=null},R.prototype.remove=function(){for(var i in R.eve("raphael.remove",this),this.canvas.parentNode.removeChild(this.canvas),this)this[i]="function"==typeof this[i]?R._removedFactory(i):null;return!0};var setproto=R.st;for(var method in elproto)elproto[has](method)&&!setproto[has](method)&&(setproto[method]=function(methodname){return function(){var arg=arguments;return this.forEach(function(el){el[methodname].apply(el,arg)})}}(method))}(window.Raphael);var Helpers={};function getAge(birthDate,deathDate,onlyYears){if(birthDate.onlyDecadeAvailable()||deathDate&&deathDate.onlyDecadeAvailable()){if(onlyYears){var lastYearAlive=(new Date).getFullYear();null!=deathDate&&(lastYearAlive=deathDate.getYear(!0),deathDate.onlyDecadeAvailable()&&(lastYearAlive+=10));var age=lastYearAlive-(birthDate.onlyDecadeAvailable()?parseInt(birthDate.getDecade()):birthDate.getYear());return"before_"+10*Math.ceil(age/10)}return""}var now;now=null==deathDate?new Date:deathDate.toJSDate(),birthDate=birthDate.toJSDate();if((age=now.getTime()-birthDate.getTime())<=0){if(null!=deathDate)return"";if(age<0)return"not born yet"}var years=now.getFullYear()-birthDate.getFullYear()-(now.getDayOfYear()<birthDate.getDayOfYear()?1:0);if(onlyYears)return years;var agestr="",months=Math.floor(age/26352e5);if(months<12){var days=Math.floor(age/864e5);if(days<21)agestr=1==days?days+" day":days+" days";else if(days<60){agestr=Math.floor(age/6048e5)+" wk"}else agestr=months+" mo"}else agestr=years+" y";return agestr}window.console||(window.console={log:function(){}}),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),Array.prototype.forEach||(Array.prototype.forEach=function(fun){var t=Object(this),len=t.length>>>0;if("function"!=typeof fun)throw new TypeError;for(var thisArg=2<=arguments.length?arguments[1]:void 0,i=0;i<len;i++)i in t&&fun.call(thisArg,t[i],i,t)}),"undefined"!=typeof HTMLElement&&!HTMLElement.prototype.click&&document.createEvent&&(HTMLElement.prototype.click=function(){var eventObj=document.createEvent("MouseEvents");eventObj.initEvent("click",!0,!0),this.dispatchEvent(eventObj)}),Helpers.clone2DArray=function(arr2D){for(var new2D=[],i=0;i<arr2D.length;++i)new2D.push(arr2D[i].slice());return new2D},Helpers.cloneObject=function(obj){var target={};for(var i in obj)obj.hasOwnProperty(i)&&(target[i]=obj[i]);return target},Helpers.setByTemplate=function(template,data){if("object"==typeof template&&"object"==typeof data)for(var key in template)data.hasOwnProperty(key)&&template.hasOwnProperty(key)&&("object"==typeof template[key]?"[object Array]"===Object.prototype.toString.call(template[key])?template[key]=data[key].slice():Helpers.setByTemplate(template[key],data[key]):template[key]=data[key])},Helpers.copyProperties=function(objectSource,objectTarget){for(var p in objectSource)objectSource.hasOwnProperty(p)&&(objectTarget[p]=objectSource[p])},Helpers.arrayContains=function(array,item){if(Array.prototype.indexOf)return!(array.indexOf(item)<0);for(var i=0,len=array.length;i<len;++i)if(array[i]===item)return!0;return!1},Helpers.arrayIndexOf=function(array,item){if(Array.prototype.indexOf)return array.indexOf(item);for(var i=0,len=array.length;i<len;++i)if(array[i]===item)return i;return-1},Helpers.indexOfLastMinElementInArray=function(array){for(var min=array[0],minIndex=0,i=1,len=array.length;i<len;++i)array[i]<=min&&(min=array[minIndex=i]);return minIndex},Helpers.filterUnique=function(array){for(var hash={},result=[],i=array.length;i--;)hash[array[i]]||(hash[array[i]]=!0,result.push(array[i]));return result},Helpers.replaceInArray=function(array,value,newValue){for(var i=0,len=array.length;i<len;++i)if(array[i]===value){array[i]=newValue;break}},Helpers.removeFirstOccurrenceByValue=function(array,item){for(var i=0,len=array.length;i<len;++i)if(array[i]==item){array.splice(i,1);break}},Helpers.isObjectEmpty=function(map){for(var key in map)if(map.hasOwnProperty(key))return!1;return!0},Helpers.numTextLines=function(text){return null===text||""==text||0===Object.keys(text).length&&text.constructor===Object?0:(text.replace(/^\s+|\s+$/g,"").match(/\n/g)||[]).length+1},Helpers.isInt=function(n){return!isNaN(n)&&parseInt(n)==parseFloat(n)},Helpers.toObjectWithTrue=function(array){for(var obj={},i=0;i<array.length;++i)void 0!==array[i]&&(obj[array[i]]=!0);return obj},Helpers.romanize=function(num){if(!+num)return!1;for(var digits=String(+num).split(""),key=["","C","CC","CCC","CD","D","DC","DCC","DCCC","CM","","X","XX","XXX","XL","L","LX","LXX","LXXX","XC","","I","II","III","IV","V","VI","VII","VIII","IX"],roman="",i=3;i--;)roman=(key[+digits.pop()+10*i]||"")+roman;return Array(+digits.join("")+1).join("M")+roman},Helpers.stopEventPropagation=function(event){event.preventDefault(),event.stopPropagation(),event.stopImmediatePropagation()},Helpers.disableMouseclicks=function(element){element.__oldMouseDown=element.onmousedown,element.onmousedown=Helpers.stopEventPropagation,element.__oldClick=element.onclick,element.onclick=Helpers.stopEventPropagation},Helpers.enableMouseclicks=function(element){element.hasOwnProperty("__oldMouseDown")?(element.onmousedown=element.__oldMouseDown,delete element.__oldMouseDown):element.onmousedown=null,element.hasOwnProperty("__oldClick")?(element.onclick=element.__oldClick,delete element.__oldClick):element.onclick=null},Helpers.makeFlattened2DArrayCopy=function(array){return[].concat.apply([],array)},Helpers.swap=function(array,i,j){var b=array[j];array[j]=array[i],array[i]=b},Helpers.permute2DArrayInFirstDimension=function(permutations,array,from){var len=array.length;if(from!=len-1)for(var j=from;j<len;j++)Helpers.swap(array,from,j),Helpers.permute2DArrayInFirstDimension(permutations,array,from+1),Helpers.swap(array,from,j);else permutations.push(Helpers.makeFlattened2DArrayCopy(array))},Helpers.Timer=function(){this.startTime=void 0,this.lastCheck=void 0,this.start()},Helpers.Timer.prototype={start:function(){this.startTime=(new Date).getTime(),this.lastCheck=this.startTime},restart:function(){this.start()},report:function(){return(new Date).getTime()-this.lastCheck},printSinceLast:function(msg){var current=(new Date).getTime(),elapsed=current-this.lastCheck;this.lastCheck=current,console.log(msg+elapsed+"ms")}},Helpers.stringifyObject=function(obj){return _printObjectInternal(obj,1)},Helpers.printObject=function(obj){console.log(_printObjectInternal(obj,0))},_printObjectInternal=function(o,level){if(10<level)return"...[too deep, possibly a recursive object]...";var output="";if("object"==typeof o)if("[object Array]"===Object.prototype.toString.call(o)){output="[";for(var i=0;i<o.length;i++)0<i&&(output+=", "),output+=_printObjectInternal(o[i],level+1);output+="]"}else{output="{";var idx=0;for(var property in 0==level&&(output+="\n"),o)o.hasOwnProperty(property)&&(0!=level&&0!=idx&&(output+=", "),output+=property+": "+_printObjectInternal(o[property],level+1),0==level&&(output+="\n"),idx++);output+="}"}else output="string"==typeof o?"'"+o+"'":""+o;return output},Helpers.padString=function(string,width,padding,onLeft){return width<=string.length?string:Helpers.padString(onLeft?padding+string:string+padding,width,padding,onLeft)},Helpers.createRandomID=function(){for(var text="",possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;i<5;i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text},Helpers.getSiteURL=function(){return window.location.origin+window.location.pathname.substr(0,window.location.pathname.lastIndexOf("/"))},Helpers.getGenderDisplayText=function(genderString){var gender="Unknown";return genderString&&("female"==(genderString=genderString.toLowerCase())||"f"==genderString||"2"==genderString?gender="Female":"male"==genderString||"m"==genderString||"1"==genderString?gender="Male":"other"!=genderString&&"o"!=genderString&&"9"!=genderString||(gender="Other")),gender},Helpers.wrapStringNonBreak=function(stringToWrap,maxWidth){try{if(null==stringToWrap)return stringToWrap;for(var splits=stringToWrap.split("\n"),arr=[],returnVal="",regex=new RegExp(".{1,"+maxWidth+"}","g"),j=0;j<splits.length;j++)if(splits[j].length>maxWidth){var words=splits[j].match(regex);arr=arr.concat(words)}else arr.push(splits[j]);for(var i=0;i<arr.length;i++)returnVal=""===returnVal?arr[0]:returnVal+"\n"+arr[i];return returnVal}catch(err){return console.warn(err),stringToWrap}},Helpers.wrapString=function(stringToWrap,maxWidth){try{var regStr="(?![^\\n]{1,maxWidth}$)([^\\n]{1,maxWidth})\\s".replace(/maxWidth/g,maxWidth);return stringToWrap.replace(new RegExp(regStr,"g"),"$1\n")}catch(err){console.error("Error wrapping string = "+stringToWrap+" err="+err)}},Helpers.toTitleCase=function(str){var original=str;if(null==str||" "===str)return str;try{str=str.toLowerCase().split(" ");for(var i=0;i<str.length;i++)str[i]=str[i].charAt(0).toUpperCase()+str[i].slice(1);return str.join(" ")}catch(err){return console.log("Error converting to title case : "+str),original}},Array.prototype.remove=function(){for(var what,ax,a=arguments,L=a.length;L&&this.length;)for(what=a[--L];-1!==(ax=this.indexOf(what));)this.splice(ax,1);return this},window.URLSearchParams||(console.warn("Polyfilling URLSearchParams. Not supported in browser"),window.URLSearchParams=window.URLSearchParams||function(searchString){var self=this;self.searchString=searchString,self.get=function(name){var results=new RegExp("[?&]"+name+"=([^&#]*)").exec(self.searchString);return null==results?null:decodeURI(results[1])||0}}),String.prototype.includes||(String.prototype.includes=function(search,start){return"number"!=typeof start&&(start=0),!(start+search.length>this.length)&&-1!==this.indexOf(search,start)}),Queue=function(){this.data=[]},Queue.prototype={setTo:function(list){this.data=list.slice()},push:function(v){this.data.push(v)},pop:function(v){return this.data.shift()},size:function(){return this.data.length},clear:function(){this.data=[]}},Stack=function(){this.data=[]},Stack.prototype={setTo:function(list){this.data=list.slice()},push:function(v){this.data.push(v)},pop:function(v){return this.data.pop()},size:function(){return this.data.length}},BaseGraph=function(defaultPersonNodeWidth,defaultNonPersonNodeWidth){this.v=[],this.inedges=[],this.maxRealVertexId=-1,this.weights=[],this.type=[],this.properties=[],this.vWidth=[],this.defaultPersonNodeWidth=defaultPersonNodeWidth||10,this.defaultNonPersonNodeWidth=defaultNonPersonNodeWidth||2},BaseGraph.TYPE={RELATIONSHIP:1,CHILDHUB:2,PERSON:3,VIRTUALEDGE:4},BaseGraph.prototype={serialize:function(saveWidth){for(var output=[],v=0;v<this.v.length;v++){var data={};data.id=v,saveWidth&&(data.width=this.vWidth[v]),this.type[v]==BaseGraph.TYPE.PERSON||(this.type[v]==BaseGraph.TYPE.RELATIONSHIP?(data.rel=!0,data.hub=!0):this.type[v]==BaseGraph.TYPE.CHILDHUB?data.chhub=!0:data.virt=!0),data.prop=this.properties[v],out=[];for(var outEdges=this.getOutEdges(v),i=0;i<outEdges.length;i++){var to=outEdges[i],weight=this.getEdgeWeight(v,to);1==weight?out.push({to:outEdges[i]}):out.push({to:outEdges[i],weight:weight})}0<out.length&&(data.outedges=out),output.push(data)}return output},makeGWithSplitMultiRankEdges:function(ranks){for(var newG=new BaseGraph(this.defaultPersonNodeWidth,this.defaultNonPersonNodeWidth),i=0;i<this.v.length;i++)newG._addVertex(i,this.type[i],this.properties[i],this.vWidth[i]);for(var sourceV=0;sourceV<this.v.length;sourceV++){var sourceRank=ranks[sourceV];for(i=0;i<this.v[sourceV].length;i++){var targetV=this.v[sourceV][i],weight=this.getEdgeWeight(sourceV,targetV),targetRank=ranks[targetV];if(targetRank<sourceRank)throw"Assertion failed: only forward edges";if(targetRank==sourceRank+1||targetRank==sourceRank)newG.addEdge(sourceV,targetV,weight);else{for(var prevV=sourceV,midRank=sourceRank+1;midRank<=targetRank-1;midRank++){var nextV=newG._addVertex(null,BaseGraph.TYPE.VIRTUALEDGE,{fName:"_"+sourceV+"->"+targetV+"_"+(midRank-sourceRank-1)},this.defaultNonPersonNodeWidth);ranks[nextV]=midRank,newG.addEdge(prevV,nextV,weight),prevV=nextV}newG.addEdge(prevV,targetV,weight)}}}return newG.validate(),newG},makeGWithCollapsedMultiRankEdges:function(){for(var newG=new BaseGraph(this.defaultPersonNodeWidth,this.defaultNonPersonNodeWidth),i=0;i<=this.maxRealVertexId;i++)newG._addVertex(i,this.type[i],this.properties[i],this.vWidth[i]);for(var sourceV=0;sourceV<=this.maxRealVertexId;sourceV++)for(i=0;i<this.v[sourceV].length;i++){for(var targetV=this.v[sourceV][i],weight=this.getEdgeWeight(sourceV,targetV);targetV>this.maxRealVertexId;)targetV=this.getOutEdges(targetV)[0];newG.addEdge(sourceV,targetV,weight)}return newG.validate(),newG},getLeafAndParentlessNodes:function(){for(var result={parentlessNodes:[],leafNodes:[]},vid=0;vid<=this.maxRealVertexId;vid++)0==this.getInEdges(vid).length?result.parentlessNodes.push(vid):0==this.getOutEdges(vid).length&&result.leafNodes.push(vid);return result},_addVertex:function(id,type,properties,width){if(id&&this.v[id])throw"addVertex: vertex with id="+id+" is already in G";var nextId=null==id?this.v.length:id;return this.v[nextId]=[],this.inedges[nextId]=[],this.weights[nextId]={},this.vWidth[nextId]=width,this.type[nextId]=type,this.properties[nextId]=properties,type!=BaseGraph.TYPE.VIRTUALEDGE&&nextId>this.maxRealVertexId&&(this.maxRealVertexId=nextId),nextId},addEdge:function(fromV,toV,weight){if(this.v.length<Math.max(fromV,toV))throw"addEdge: vertex ID="+Math.max(fromV,toV)+"] is not in G";if(this.hasEdge(fromV,toV))throw"addEdge: edge from ID="+fromV+" to ID="+toV+" already exists";this.v[fromV].push(toV),this.inedges[toV].push(fromV),this.weights[fromV][toV]=weight},removeEdge:function(fromV,toV){if(!this.hasEdge(fromV,toV))throw"removeEdge: edge does not exist";Helpers.removeFirstOccurrenceByValue(this.v[fromV],toV),Helpers.removeFirstOccurrenceByValue(this.inedges[toV],fromV);var weight=this.weights[fromV][toV];return delete this.weights[fromV][toV],weight},insertVertex:function(type,properties,edgeWeights,inedges,outedges,width){width=width||(type==BaseGraph.TYPE.PERSON?this.defaultPersonNodeWidth:this.defaultNonPersonNodeWidth);type!=BaseGraph.TYPE.PERSON||properties.hasOwnProperty("gender")||(properties.gender="U");var newNodeId=type==BaseGraph.TYPE.VIRTUALEDGE?this.v.length:this.maxRealVertexId+1;if(this.v.length>=newNodeId){this._updateAllReferencesToNewIDs(function(u){return newNodeId<=u},function(u){return u+1})}this.v.splice(newNodeId,0,[]),this.inedges.splice(newNodeId,0,[]),this.weights.splice(newNodeId,0,{}),this.vWidth.splice(newNodeId,0,width),this.type.splice(newNodeId,0,type),this.properties.splice(newNodeId,0,properties),type!=BaseGraph.TYPE.VIRTUALEDGE&&this.maxRealVertexId++;for(var i=0;i<inedges.length;i++)this.addEdge(inedges[i],newNodeId,edgeWeights);for(i=0;i<outedges.length;i++)this.addEdge(newNodeId,outedges[i],edgeWeights);return newNodeId},unplugVirtualVertex:function(v){if(v<=this.getMaxRealVertexId())throw"Attempting to unplug a non-virtual vertex";var parent=this.inedges[v][0],child=this.v[v][0];Helpers.replaceInArray(this.v[parent],v,child),this.weights[parent][child]=this.weights[parent][v],delete this.weights[parent][v],Helpers.replaceInArray(this.inedges[child],v,parent),this.v[v]=[],this.inedges[v]=[],this.weights[v]={}},remove:function(v){for(var i=0;i<this.v[v].length;i++){var target=this.v[v][i];Helpers.removeFirstOccurrenceByValue(this.inedges[target],v)}for(i=0;i<this.inedges[v].length;i++){var incoming=this.inedges[v][i];Helpers.removeFirstOccurrenceByValue(this.v[incoming],v),delete this.weights[incoming][v]}this.v.splice(v,1),this.inedges.splice(v,1),this.weights.splice(v,1),this.vWidth.splice(v,1),this.type.splice(v,1),this.properties.splice(v,1),v<=this.maxRealVertexId&&this.maxRealVertexId--;this._updateAllReferencesToNewIDs(function(u){return v<u},function(u){return u-1})},_updateAllReferencesToNewIDs:function(test,modification){for(var i=0;i<this.v.length;i++){for(var j=0;j<this.v[i].length;j++)test(this.v[i][j])&&(this.v[i][j]=modification(this.v[i][j]));for(j=0;j<this.inedges[i].length;j++)test(this.inedges[i][j])&&(this.inedges[i][j]=modification(this.inedges[i][j]));var newWeights={},weights=this.weights[i];for(var u in weights)weights.hasOwnProperty(u)&&(u=parseInt(u)),test(u)?newWeights[modification(u)]=weights[u]:newWeights[u]=weights[u];this.weights[i]=newWeights}},validate:function(){if(0!=this.v.length){for(var v=0;v<this.v.length;v++){var outEdges=this.getOutEdges(v),inEdges=this.getInEdges(v);if(this.isPerson(v)){if(1<inEdges.length)throw"Assertion failed: person nodes can't have two in-edges as people are produced by a single pregnancy (failed for "+this.getVertexDescription(v)+")";for(var i=0;i<outEdges.length;i++)if(!this.isRelationship(outEdges[i])&&!this.isVirtual(outEdges[i]))throw"Assertion failed: person nodes have only out edges to relationships (failed for "+this.getVertexDescription(v)+")"}else if(this.isRelationship(v)){if(0==outEdges.length)throw"Assertion failed: all relationships should have a childhub associated with them (failed for "+this.getVertexDescription(v)+")";if(1<outEdges.length)throw"Assertion failed: all relationships should have only one outedge (to a childhub) (failed for "+this.getVertexDescription(v)+")";if(!this.isChildhub(outEdges[0]))throw"Assertion failed: relationships should only have out edges to childhubs (failed for "+this.getVertexDescription(v)+")";if(2!=inEdges.length)throw"Assertion failed: relationships should always have exactly two associated persons (failed for "+this.getVertexDescription(v)+")"}else if(this.isVirtual(v)){if(1!=outEdges.length)throw"Assertion failed: all virtual nodes have exactly one out edge (to a virtual node or a relationship)";if(1!=inEdges.length)throw"Assertion failed: all virtual nodes have exactly one in edge (from a person or a virtual node)";if(!this.isRelationship(outEdges[0])&&!this.isVirtual(outEdges[0]))throw"Assertion failed: all virtual nodes may only have an outedge to a virtual node or a relationship"}else if(this.isChildhub(v)){if(outEdges.length<1)throw"Assertion failed: all childhubs should have at least one child associated with them";for(i=0;i<outEdges.length;i++)if(!this.isPerson(outEdges[i]))throw"Assertion failed: childhubs are only connected to people (failed for "+this.getVertexDescription(v)+")"}}var leafAndRootlessInfo=this.getLeafAndParentlessNodes();if(0==leafAndRootlessInfo.parentlessNodes.length)throw"Assertion failed: pedigrees should have no cycles (no parentless nodes found)";for(var j=0;j<leafAndRootlessInfo.parentlessNodes.length;j++)if(this._DFSFindCycles(leafAndRootlessInfo.parentlessNodes[j],{}))throw"Assertion failed: pedigrees should have no cycles";var reachable={};this._markAllReachableComponents(leafAndRootlessInfo.parentlessNodes[0],reachable);for(v=0;v<this.v.length;v++)if(!reachable.hasOwnProperty(v))throw"Assertion failed: disconnected component detected ("+this.getVertexDescription(v)+")"}},_DFSFindCycles:function(vertex,visited){visited[vertex]=!0;for(var outEdges=this.getOutEdges(vertex),i=0;i<outEdges.length;i++){var v=outEdges[i];if(visited.hasOwnProperty(v))return!0;if(this._DFSFindCycles(v,visited))return!0}return delete visited[vertex],!1},_markAllReachableComponents:function(vertex,reachable){reachable[vertex]=!0;for(var outEdges=this.getOutEdges(vertex),i=0;i<outEdges.length;i++){var v=outEdges[i];reachable.hasOwnProperty(v)||this._markAllReachableComponents(v,reachable)}for(var inEdges=this.getInEdges(vertex),j=0;j<inEdges.length;j++){v=inEdges[j];reachable.hasOwnProperty(v)||this._markAllReachableComponents(v,reachable)}},getVertexNameById:function(v){var firstname=this.properties[v].hasOwnProperty("fName")?this.properties[v].fName:"",lastname=this.properties[v].hasOwnProperty("lName")?this.properties[v].lName:"";return""!=firstname&&""!=lastname&&(firstname+=" "),firstname+lastname},getVertexDescription:function(v){var desc="id: "+v+", name: <"+this.getVertexNameById(v)+">, type: ";switch(this.type[v]){case BaseGraph.TYPE.PERSON:desc+="PERSON";break;case BaseGraph.TYPE.RELATIONSHIP:desc+="RELATION";break;case BaseGraph.TYPE.CHILDHUB:desc+="CHILDHUB";break;case BaseGraph.TYPE.VIRTUALEDGE:desc+="VIRTUAL";break;default:desc+="ERROR"}return"["+desc+"]"},getVertexWidth:function(v){return this.vWidth[v]},getVertexHalfWidth:function(v){return Math.floor(this.vWidth[v]/2)},getEdgeWeight:function(fromV,toV){return this.weights[fromV][toV]},hasEdge:function(fromV,toV){return this.weights[fromV].hasOwnProperty(toV)},isValidId:function(v){return 0<=v&&v<this.v.length},getNumVertices:function(){return this.v.length},getMaxRealVertexId:function(){return this.maxRealVertexId},getOutEdges:function(v){return this.v[v]},getInEdges:function(v){return this.inedges[v]},getAllEdgesWithWeights:function(v){for(var edgeToWeight={},outEdges=this.getOutEdges(v),i=0;i<outEdges.length;i++){edgeToWeight[u=outEdges[i]]={weight:this.weights[v][u],out:!0}}var inEdges=this.getInEdges(v);for(i=0;i<inEdges.length;i++){var u;edgeToWeight[u=inEdges[i]]={weight:this.weights[u][v],out:!1}}return edgeToWeight},getAllEdges:function(v){return this.getOutEdges(v).concat(this.getInEdges(v))},isRelationship:function(v){return this.type[v]==BaseGraph.TYPE.RELATIONSHIP},isChildhub:function(v){return this.type[v]==BaseGraph.TYPE.CHILDHUB},isPerson:function(v){return this.type[v]==BaseGraph.TYPE.PERSON},isPlaceholder:function(v){return!(!this.isPerson(v)||!this.properties[v].hasOwnProperty("placeholder"))&&!!this.properties[v].placeholder},isVirtual:function(v){return this.type[v]==BaseGraph.TYPE.VIRTUALEDGE},isAdoptedIn:function(v){return!!this.properties[v].hasOwnProperty("adoptedStatus")&&"adoptedIn"==this.properties[v].adoptedStatus},isAdoptedOut:function(v){return!!this.properties[v].hasOwnProperty("adoptedStatus")&&"adoptedOut"==this.properties[v].adoptedStatus},getGender:function(v){if(!this.isPerson(v))throw"Assertion failed: attempting to get gender of a non-person";return this.properties[v].gender},getLastName:function(v){if(!this.isPerson(v))throw"Assertion failed: attempting to get last name of a non-person";return this.properties[v].hasOwnProperty("lName")?this.properties[v].lName:this.properties[v].hasOwnProperty("lNameAtB")?this.properties[v].lNameAtB:""},getLastNameAtBirth:function(v){if(!this.isPerson(v))throw"Assertion failed: attempting to get last name at birth of a non-person";return this.properties[v].hasOwnProperty("lNameAtB")?this.properties[v].lNameAtB:""},getOppositeGender:function(v){if(!this.isPerson(v))throw"Assertion failed: attempting to get gender of a non-person";return"U"==this.getGender(v)?"U":"O"==this.getGender(v)?"U":"M"==this.getGender(v)?"F":"M"},getRelationshipChildhub:function(v){if(!this.isRelationship(v))throw"Assertion failed: applying getRelationshipChildhub() to a non-relationship node";return this.v[v][0]},getAllRelationships:function(v){if(!this.isPerson(v))throw"Assertion failed: attempting to get relationships of a non-person";for(var relationships=this.v[v],result=[],r=0;r<relationships.length;++r){var edgeTo=relationships[r],relationship=this.downTheChainUntilNonVirtual(edgeTo);result.push(relationship)}return result},getAllPartners:function(v){if(!this.isPerson(v))throw"Assertion failed: attempting to get partners of a non-person";for(var relationships=this.getAllRelationships(v),result=[],r=0;r<relationships.length;++r){var partners=this.getParents(relationships[r]);partners[0]!=v?result.push(partners[0]):result.push(partners[1])}return result},getParents:function(v){if(!this.isPerson(v)&&!this.isRelationship(v))throw"Assertion failed: attempting to get parents of a non-person and non-relationship";var parentRelationship=this.isPerson(v)?this.getProducingRelationship(v):v;if(null==parentRelationship)return[];var inEdges=this.getInEdges(parentRelationship);if(2!=inEdges.length)throw"Assertion failed: exactly two parents";return[this.upTheChainUntilNonVirtual(inEdges[0]),this.upTheChainUntilNonVirtual(inEdges[1])]},getPathToParents:function(v){var result=[];if(!this.isRelationship(v))throw"Assertion failed: incorrect v in getPathToParents()";var inEdges=this.getInEdges(v);return result.push(this.getUpPathEndingInNonVirtual(inEdges[0])),result.push(this.getUpPathEndingInNonVirtual(inEdges[1])),result},getProducingRelationship:function(v){if(!this.isPerson(v))throw"Assertion failed: attempting to get producing relationship of a non-person";if(0==this.inedges[v].length)return null;var chHub=this.inedges[v][0];return 0==this.inedges[chHub].length?null:this.inedges[chHub][0]},upTheChainUntilNonVirtual:function(v){return this.isVirtual(v)?this.upTheChainUntilNonVirtual(this.inedges[v][0]):v},downTheChainUntilNonVirtual:function(v){return this.isVirtual(v)?this.downTheChainUntilNonVirtual(this.v[v][0]):v},getUpPathEndingInNonVirtual:function(v){for(var path=[v];this.isVirtual(v);)v=this.inedges[v][0],path.push(v);return path},getUnusedTwinGroupId:function(v){if(!this.isRelationship(v))throw"Assertion failed: incorrect v in getNumTwinGroups()";for(var childhubId=this.v[v][0],children=this.v[childhubId],twinGroupExists=[],c=0;c<children.length;c++){var child=children[c];this.properties[child].hasOwnProperty("twinGroup")&&(twinGroupExists[this.properties[child].twinGroup]=!0)}for(var firstFreeTwinGroupId=0,i=0;i<twinGroupExists.length&&void 0!==twinGroupExists[i];i++)firstFreeTwinGroupId=i+1;return firstFreeTwinGroupId},getTwinGroupId:function(v){return this.properties[v].hasOwnProperty("twinGroup")?this.properties[v].twinGroup:null},getAllSiblingsOf:function(v){if(!this.isPerson(v))throw"Assertion failed: incorrect v in getAllSiblingsOf()";if(0==this.inedges[v].length)return[v];var childhubId=this.inedges[v][0];return this.v[childhubId].slice(0)},getAllTwinsOf:function(v){if(!this.isPerson(v))throw"Assertion failed: incorrect v in getAllTwinsOf()";if(!this.properties[v].hasOwnProperty("twinGroup")||0==this.inedges[v].length)return[v];for(var twinGroupId=this.properties[v].twinGroup,childhubId=this.inedges[v][0],children=this.v[childhubId],twins=[],c=0;c<children.length;c++){var child=children[c];this.properties[child].hasOwnProperty("twinGroup")&&this.properties[child].twinGroup==twinGroupId&&twins.push(child)}return twins},isParentToTwinEdge:function(fromV,toV){return!(!this.isPerson(toV)||!this.isChildhub(fromV)||null==this.getTwinGroupId(toV))},getAllAncestors:function(v){var ancestors={};ancestors[v]=!0;var q=new Queue;for(q.push(v);0<q.size();)for(var nextV=q.pop(),inEdges=this.getInEdges(nextV),j=0;j<inEdges.length;j++){v=inEdges[j];ancestors.hasOwnProperty(v)||(q.push(v),ancestors[v]=!0)}return ancestors}},XCoord=function(xinit,graph){this.halfWidth=[];for(var i=0;i<graph.GG.vWidth.length;i++)this.halfWidth[i]=Math.floor(graph.GG.vWidth[i]/2);this.graph=graph,this.xcoord=xinit||this.init_xcoord()},XCoord.prototype={relationshipOrChhub:function(v){return this.graph.GG.type[v]==BaseGraph.TYPE.RELATIONSHIP||this.graph.GG.type[v]==BaseGraph.TYPE.CHILDHUB},getSeparation:function(v1,v2){return this.relationshipOrChhub(v1)&&this.relationshipOrChhub(v2)?this.graph.horizontalTwinSeparationDist:this.relationshipOrChhub(v1)||this.relationshipOrChhub(v2)?this.graph.horizontalRelSeparationDist:this.graph.GG.type[v1]==BaseGraph.TYPE.VIRTUALEDGE||this.graph.GG.type[v2]==BaseGraph.TYPE.VIRTUALEDGE?this.graph.GG.hasEdge(v1,v2)||this.graph.GG.hasEdge(v2,v1)?this.graph.horizontalRelSeparationDist:this.graph.horizontalTwinSeparationDist:this.graph.GG.type[v1]!=BaseGraph.TYPE.PERSON&&this.graph.GG.type[v2]!=BaseGraph.TYPE.PERSON||this.graph.GG.getTwinGroupId(v1)!=this.graph.GG.getTwinGroupId(v2)||null==this.graph.GG.getTwinGroupId(v1)?this.graph.horizontalPersonSeparationDist:this.graph.horizontalTwinSeparationDist},init_xcoord:function(){for(var xinit=[],r=0;r<this.graph.order.order.length;r++){xinit[this.graph.order.order[r][0]]=this.halfWidth[this.graph.order.order[r][0]];for(var i=1;i<this.graph.order.order[r].length;i++){var vPrev=this.graph.order.order[r][i-1],v=this.graph.order.order[r][i],separation=this.getSeparation(vPrev,v);xinit[v]=xinit[vPrev]+this.halfWidth[vPrev]+separation+this.halfWidth[v]}}return xinit},getLeftMostNoDisturbPosition:function(v){var leftNeighbour=this.graph.order.getLeftNeighbour(v,this.graph.ranks[v]);return null===leftNeighbour?-1/0:this.getRightEdge(leftNeighbour)+this.getSeparation(v,leftNeighbour)+this.halfWidth[v]},getSlackOnTheLeft:function(v){return this.xcoord[v]-this.getLeftMostNoDisturbPosition(v)},getRightMostNoDisturbPosition:function(v,alsoMoveRelationship){var rightNeighbour=this.graph.order.getRightNeighbour(v,this.graph.ranks[v]);if(null===rightNeighbour)return 1/0;var rightBoundary=this.getLeftEdge(rightNeighbour)-this.getSeparation(v,rightNeighbour)-this.halfWidth[v];alsoMoveRelationship&&this.graph.GG.type[rightNeighbour]==BaseGraph.TYPE.RELATIONSHIP&&(rightBoundary+=this.getRightMostNoDisturbPosition(rightNeighbour)-this.xcoord[rightNeighbour]);return rightBoundary},getSlackOnTheRight:function(v){return this.getRightMostNoDisturbPosition(v,!1)-this.xcoord[v]},getLeftEdge:function(v){return this.xcoord[v]-this.halfWidth[v]},getRightEdge:function(v){return this.xcoord[v]+this.halfWidth[v]},shiftLeftOneVertex:function(v,amount){var leftBoundary=this.getLeftMostNoDisturbPosition(v),actualShift=Math.min(amount,this.xcoord[v]-leftBoundary);return this.xcoord[v]-=actualShift,actualShift},shiftRightOneVertex:function(v,amount){var rightBoundary=this.getRightMostNoDisturbPosition(v),actualShift=Math.min(amount,rightBoundary-this.xcoord[v]);return this.xcoord[v]+=actualShift,actualShift},shiftRightAndShiftOtherIfNecessary:function(v,amount){this.xcoord[v]+=amount;for(var rightEdge=this.getRightEdge(v),rank=this.graph.ranks[v],i=this.graph.order.vOrder[v]+1;i<this.graph.order.order[rank].length;i++){var rightNeighbour=this.graph.order.order[rank][i];if(this.getLeftEdge(rightNeighbour)>=rightEdge+this.getSeparation(v,rightNeighbour))break;this.xcoord[rightNeighbour]=rightEdge+this.getSeparation(v,rightNeighbour)+this.halfWidth[rightNeighbour],rightEdge=this.getRightEdge(rightNeighbour),v=rightNeighbour}return amount},moveNodeAsCloseToXAsPossible:function(v,targetX){var x=this.xcoord[v];if(targetX<x){var leftMostOK=this.getLeftMostNoDisturbPosition(v);this.xcoord[v]=leftMostOK<=targetX?targetX:leftMostOK}else{var rightMostOK=this.getRightMostNoDisturbPosition(v);this.xcoord[v]=targetX<=rightMostOK?targetX:rightMostOK}return this.xcoord[v]!=x},normalize:function(){for(var leftMostElement=Helpers.indexOfLastMinElementInArray(this.xcoord),moveAmount=this.xcoord[leftMostElement]-this.halfWidth[leftMostElement],i=0;i<this.xcoord.length;i++)this.xcoord[i]-=moveAmount},copy:function(){return new XCoord(this.xcoord.slice(0),this.graph,this.halfWidth)},findVertexSetSlacks:function(set){var leftSlack=1/0,rightSlack=1/0;for(var v in set)if(set.hasOwnProperty(v)){var leftNeighbour=this.graph.order.getLeftNeighbour(v,this.graph.ranks[v]);set.hasOwnProperty(leftNeighbour)||(leftSlack=Math.min(leftSlack,this.getSlackOnTheLeft(v)));var rightNeighbour=this.graph.order.getRightNeighbour(v,this.graph.ranks[v]);set.hasOwnProperty(rightNeighbour)||(rightSlack=Math.min(rightSlack,this.getSlackOnTheRight(v)))}return{rightSlack:rightSlack,leftSlack:leftSlack}}},XCoordScore=function(maxRealVertexId){this.score=0,this.inEdgeMaxLen=[],this.maxRealVertexId=maxRealVertexId,this.numStraightLong=0},XCoordScore.prototype={add:function(amount){this.score+=amount},addEdge:function(v,u,length){u>this.maxRealVertexId&&(0==length&&v>this.maxRealVertexId&&this.numStraightLong++,length/=2),(!this.inEdgeMaxLen[u]||length>this.inEdgeMaxLen[u])&&(this.inEdgeMaxLen[u]=length);for(var i=0;i<u;i++)void 0===this.inEdgeMaxLen[i]&&(this.inEdgeMaxLen[i]=0)},isBettertThan:function(otherScore){if(this.score!=otherScore.score)return this.score<otherScore.score;if(this.numStraightLong!=otherScore.numStraightLong)return this.numStraightLong>otherScore.numStraightLong;var score1=0==this.inEdgeMaxLen.length?0:this.inEdgeMaxLen.reduce(function(a,b){return a+b}),score2=0==otherScore.inEdgeMaxLen.length?0:otherScore.inEdgeMaxLen.reduce(function(a,b){return a+b});return score1==score2?Math.max.apply(null,this.inEdgeMaxLen)<Math.max.apply(null,otherScore.inEdgeMaxLen):score1<score2}},VerticalLevels=function(){this.rankVerticalLevels=[],this.childEdgeLevel=[],this.outEdgeVerticalLevel=[]},VerticalLevels.prototype={copy:function(){var result=new VerticalLevels;return result.rankVerticalLevels=this.rankVerticalLevels.slice(0),result.childEdgeLevel=this.childEdgeLevel.slice(0),result.outEdgeVerticalLevel=this.outEdgeVerticalLevel.slice(0),result}},Ordering=function(order,vOrder){this.order=order,this.vOrder=vOrder},Ordering.prototype={serialize:function(){return this.order},deserialize:function(data){this.order=data,this.vOrder=[];for(var r=0;r<this.order.length;r++)for(var ordersAtRank=this.order[r],i=0;i<ordersAtRank.length;i++)this.vOrder[ordersAtRank[i]]=i},insert:function(rank,insertOrder,vertex){this.order[rank].splice(insertOrder,0,vertex);for(var next=(this.vOrder[vertex]=insertOrder)+1;next<this.order[rank].length;++next)this.vOrder[this.order[rank][next]]++},exchange:function(rank,index1,index2){var v1=this.order[rank][index1],v2=this.order[rank][index2];this.order[rank][index2]=v1,this.order[rank][index1]=v2,this.vOrder[v1]=index2,this.vOrder[v2]=index1},canMove:function(rank,index,amount){var newIndex=index+amount;return!(newIndex<0)&&!(newIndex>this.order[rank].length-1)},move:function(rank,index,amount){if(0==amount)return!0;var newIndex=index+amount;if(newIndex<0)return!1;var ord=this.order[rank];if(newIndex>ord.length-1)return!1;var v=ord[index];if(index<newIndex)for(var i=index;i<newIndex;++i){var vv=ord[i+1];ord[i]=vv,this.vOrder[vv]=i}else for(i=index;newIndex<i;--i){vv=ord[i-1];ord[i]=vv,this.vOrder[vv]=i}return ord[newIndex]=v,this.vOrder[v]=newIndex,!0},copy:function(){return new Ordering(Helpers.clone2DArray(this.order),this.vOrder.slice())},moveVertexToRankAndOrder:function(oldRank,oldOrder,newRank,newOrder){var v=this.order[oldRank][oldOrder];this.order[oldRank].splice(oldOrder,1),this.order[newRank].splice(newOrder,0,v);for(var i=(this.vOrder[v]=newOrder)+1;i<this.order[newRank].length;++i){var nextV=this.order[newRank][i];this.vOrder[nextV]++}for(i=oldOrder;i<this.order[oldRank].length;++i){nextV=this.order[oldRank][i];this.vOrder[nextV]--}},moveVertexToOrder:function(rank,oldOrder,newOrder){var shiftAmount=newOrder<=oldOrder?newOrder-oldOrder:newOrder-oldOrder-1;this.move(rank,oldOrder,shiftAmount)},removeUnplugged:function(){for(var result=this.order[0].slice(0),u=0;u<this.order[0].length;++u){for(var unplugged=this.order[0][u],i=0;i<this.order.length;++i)for(var j=0;j<this.order[i].length;++j)this.order[i][j]>unplugged&&this.order[i][j]--;this.vOrder.splice(unplugged,1)}return this.order[0]=[],result},remove:function(v,rank){var order=this.vOrder[v];this.moveVertexToRankAndOrder(rank,order,0,0),this.removeUnplugged()},insertAndShiftAllIdsAboveVByOne:function(v,rank,newOrder){for(var i=this.vOrder.length;v<i;--i)this.vOrder[i]=this.vOrder[i-1];for(i=0;i<this.order.length;++i)for(var j=0;j<this.order[i].length;++j)this.order[i][j]>=v&&this.order[i][j]++;this.insert(rank,newOrder,v)},insertRank:function(insertBeforeRank){this.order.splice(insertBeforeRank,0,[])},getRightNeighbour:function(v,rank){var order=this.vOrder[v];return order<this.order[rank].length-1?this.order[rank][order+1]:null},getLeftNeighbour:function(v,rank){var order=this.vOrder[v];return 0<order?this.order[rank][order-1]:null},sortByOrder:function(v_list){var vorders=this.vOrder,result=v_list.slice(0);return result.sort(function(x,y){return vorders[x]-vorders[y]}),result},getLeftToRightTopToBottomOrdering:function(onlyType,GG){for(var result=[],i=1;i<this.order.length;++i)for(var j=0;j<this.order[i].length;++j){var v=this.order[i][j];onlyType&&GG.type[v]!=onlyType||result.push(this.order[i][j])}return result}},PedigreeImport=function(){},PedigreeImport.prototype={},PedigreeImport.initFromPhenotipsInternal=function(inputG){for(var newG=new BaseGraph,nameToId={},relationshipHasExplicitChHub={},v=0;v<inputG.length;v++){if(!inputG[v].hasOwnProperty("name")&&!inputG[v].hasOwnProperty("id"))throw"Invalid input: a node without id and without name";var type=BaseGraph.TYPE.PERSON;inputG[v].hasOwnProperty("relationship")||inputG[v].hasOwnProperty("rel")?(type=BaseGraph.TYPE.RELATIONSHIP,(inputG[v].hasOwnProperty("hub")||inputG[v].hasOwnProperty("haschhub"))&&(relationshipHasExplicitChHub[v]=!0)):inputG[v].hasOwnProperty("chhub")?type=BaseGraph.TYPE.CHILDHUB:(inputG[v].hasOwnProperty("virtual")||inputG[v].hasOwnProperty("virt"))&&(type=BaseGraph.TYPE.VIRTUALEDGE);var properties={};if((inputG[v].hasOwnProperty("properties")||inputG[v].hasOwnProperty("prop"))&&(properties=inputG[v].hasOwnProperty("properties")?inputG[v].properties:inputG[v].prop),type==BaseGraph.TYPE.PERSON&&(properties.hasOwnProperty("sex")&&!properties.hasOwnProperty("gender")&&(properties.gender=properties.sex),properties.hasOwnProperty("gender")||(properties.gender="U"),inputG[v].hasOwnProperty("gender"))){var genderString=inputG[v].gender.toLowerCase();"female"!=genderString&&"f"!=genderString&&"2"!=genderString||(properties.gender="F"),"other"==genderString||"o"==genderString||"9"==genderString?properties.gender="O":"male"!=genderString&&"m"!=genderString&&"1"!=genderString||(properties.gender="M")}var width=inputG[v].hasOwnProperty("width")?inputG[v].width:type==BaseGraph.TYPE.PERSON?newG.defaultPersonNodeWidth:newG.defaultNonPersonNodeWidth,newID=newG._addVertex(null,type,properties,width);if(inputG[v].hasOwnProperty("name")){if(nameToId[inputG[v].name])throw"Invalid user input: multiple nodes with the same name";type==BaseGraph.TYPE.PERSON&&(newG.properties[newID].fName=inputG[v].name),nameToId[inputG[v].name]=newID}if(type==BaseGraph.TYPE.RELATIONSHIP&&!relationshipHasExplicitChHub.hasOwnProperty(v)){var chHubId=newG._addVertex(null,BaseGraph.TYPE.CHILDHUB,null,width);nameToId["_chhub_"+newID]=chHubId}}for(v=0;v<inputG.length;v++){var nextV=inputG[v],vID=nextV.hasOwnProperty("id")?nextV.id:nameToId[nextV.name],origID=vID,substitutedID=!1;if(newG.type[vID]==BaseGraph.TYPE.RELATIONSHIP&&!relationshipHasExplicitChHub.hasOwnProperty(vID))vID=nameToId["_chhub_"+vID],substitutedID=!0;var maxChildEdgeWeight=0;if(nextV.outedges)for(var outE=0;outE<nextV.outedges.length;outE++){var target=nextV.outedges[outE].to,targetID=nameToId[target]?nameToId[target]:target;if(!newG.isValidId(targetID))throw"Invalid input: invalid edge target ("+target+")";var weight=1;nextV.outedges[outE].hasOwnProperty("weight")&&(weight=nextV.outedges[outE].weight),maxChildEdgeWeight<weight&&(maxChildEdgeWeight=weight),newG.addEdge(vID,targetID,weight)}substitutedID&&newG.addEdge(origID,vID,maxChildEdgeWeight)}return newG.validate(),newG},PedigreeImport.initFromPED=function(inputText,acceptOtherPhenotypes,markEvaluated,saveIDAsExternalID,affectedCodeOne,disorderNames){var inputLines=inputText.match(/[^\r\n]+/g);if(0==inputLines.length)throw"Unable to import: no data";var postMakeped=!1;0<inputLines[0].indexOf("Ped:")&&0<inputLines[0].indexOf("Per:")&&(postMakeped=!0);for(var familyPrefix="",newG=new BaseGraph,nameToId={},phenotypeValues={},extendedPhenotypesFound=!1,nextID=postMakeped?1:0,i=0;i<inputLines.length;i++)if("#"!=inputLines[i].charAt(0)){if(inputLines[i]=inputLines[i].replace(/[^a-zA-Z0-9_.\-\s*]/g," "),inputLines[i]=inputLines[i].replace(/^\s+|\s+$/g,""),(parts=inputLines[i].split(/\s+/)).length<6||postMakeped&&parts.length<10)throw"Input line has not enough columns: ["+inputLines[i]+"]";if(""==familyPrefix)familyPrefix=parts[0];else if(parts[0]!=familyPrefix)throw"Unsupported feature: multiple families detected within the same pedigree";var pedID=parts[1];if(nameToId.hasOwnProperty(pedID))throw"Multiple persons with the same ID ["+pedID+"]";var genderValue=postMakeped?parts[7]:parts[4],gender="U";1==genderValue?gender="M":2==genderValue&&(gender="F");var properties={gender:gender};saveIDAsExternalID&&(properties.externalID=pedID);var useID=postMakeped&&1==parts[8]?0:nextID++;i==inputLines.length-1&&void 0===newG.v[0]&&(useID=0);var pedigreeID=newG._addVertex(useID,BaseGraph.TYPE.PERSON,properties,newG.defaultPersonNodeWidth);nameToId[pedID]=pedigreeID,phenotypeValues[phenotype=postMakeped?parts[9]:parts[5]]=!0,acceptOtherPhenotypes&&"-9"!=phenotype&&"0"!=phenotype&&"1"!=phenotype&&"2"!=phenotype&&(extendedPhenotypesFound=!0)}if(affectedCodeOne){if(extendedPhenotypesFound||phenotypeValues.hasOwnProperty("2"))throw"Phenotypes with codes other than 0 or 1 were found";var affectedValues={1:!0},missingValues={"-9":!0},unaffectedValues={0:!0}}else affectedValues={2:!0},missingValues={0:!0,"-9":!0},unaffectedValues={1:!0};if(!disorderNames&&(disorderNames={},extendedPhenotypesFound))for(var phenotype in phenotypeValues)phenotypeValues.hasOwnProperty(phenotype)&&"-9"!=phenotype&&"0"!=phenotype&&"1"!=phenotype&&(disorderNames[phenotype]="affected (phenotype "+phenotype+")",affectedValues[phenotype]=!0);var relationshipTracker=new RelationshipTracker(newG,1);for(i=0;i<inputLines.length;i++)if("#"!=inputLines[i].charAt(0)){var parts,thisPersonName=(parts=inputLines[i].split(/\s+/))[1],id=nameToId[thisPersonName];phenotype=postMakeped?parts[9]:parts[5];if(affectedValues.hasOwnProperty(phenotype)){var disorder=disorderNames.hasOwnProperty(phenotype)?disorderNames[phenotype]:"Affected";newG.properties[id].carrierStatus="Affected",newG.properties[id].disorders=[disorder],markEvaluated&&(newG.properties[id].evaluated=!0)}else unaffectedValues.hasOwnProperty(phenotype)?(newG.properties[id].carrierStatus="",markEvaluated&&(newG.properties[id].evaluated=!0)):missingValues.hasOwnProperty(phenotype);var fatherID=parts[2],motherID=parts[3];if(0!=fatherID||0!=motherID){if(0==fatherID)fatherID=newG._addVertex(null,BaseGraph.TYPE.PERSON,{gender:"M",comments:"unknown"},newG.defaultPersonNodeWidth);else{if(void 0===(fatherID=nameToId[fatherID]))throw"Unable to import pedigree: incorrect father link on line "+(i+1)+"; Maybe import data is not in PED format?";"F"==newG.properties[fatherID].gender&&console.warn("A person declared as female [id: "+fatherID+"] is also declared as being a father for [id: "+thisPersonName+"]")}if(0==motherID)motherID=newG._addVertex(null,BaseGraph.TYPE.PERSON,{gender:"F",comments:"unknown"},newG.defaultPersonNodeWidth);else{if(void 0===(motherID=nameToId[motherID]))throw"Unable to import pedigree: incorrect mother link on line "+(i+1)+"; Maybe import data is not in PED format?";"M"==newG.properties[motherID].gender&&console.warn("A person declared as male [id: "+motherID+"] is also declared as being a mother for [id: "+thisPersonName+"]")}var chhubID=relationshipTracker.createOrGetChildhub(motherID,fatherID);newG.addEdge(chhubID,id,1)}}return PedigreeImport.validateBaseGraph(newG),newG},PedigreeImport.initFromBOADICEA=function(inputText,saveIDAsExternalID){var inputLines=inputText.match(/[^\r\n]+/g);if(inputLines.length<=2)throw"Unable to import: no data";if(null===inputLines[0].match(/^BOADICEA import pedigree file format 2/i))throw"Unable to import: unsupported version of the BOADICEA format";inputLines.splice(0,2);for(var familyPrefix="",newG=new BaseGraph,nameToId={},nextID=1,i=0;i<inputLines.length;i++){if(inputLines[i]=inputLines[i].replace(/[^a-zA-Z0-9_.\-\s*]/g," "),inputLines[i]=inputLines[i].replace(/^\s+|\s+$/g,""),(parts=inputLines[i].split(/\s+/)).length<24)throw"Input line has not enough columns: ["+inputLines[i]+"]";if(""==familyPrefix)familyPrefix=parts[0];else if(parts[0]!=familyPrefix)throw"Unsupported feature: multiple families detected within the same pedigree";var extID=parts[3];if(nameToId.hasOwnProperty(extID))throw"Multiple persons with the same ID ["+extID+"]";var gender="M";"F"==parts[6]&&(gender="F");var properties={gender:gender,fName:parts[1]};saveIDAsExternalID&&(properties.externalID=extID),"1"==parts[8]&&(properties.lifeStatus="Deceased");var yob=parts[10];"0"!=yob&&Helpers.isInt(yob)&&(properties.dob={decade:yob+"s",year:parseInt(yob)});for(var addCommentToProperties=function(properties,line){line&&""!=line&&(properties.hasOwnProperty("comments")?properties.comments+="\n"+line:properties.comments=line)},cancers=[{column:11,label:"Breast",comment:""},{column:12,label:"Breast",comment:"Contralateral breast cancer",onlySetComment:!0},{column:13,label:"Ovarian",comment:""},{column:14,label:"Prostate",comment:""},{column:15,label:"Pancreatic",comment:""}],c=0;c<cancers.length;c++){var cancer=cancers[c];properties.hasOwnProperty("cancers")||(properties.cancers={});var cancerData={};if("0"==parts[cancer.column])cancer.hasOwnProperty("onlySetComment")&&cancer.onlySetComment||(cancerData.affected=!1);else{cancerData.affected=!0;var age=parts[cancer.column];if(Helpers.isInt(age)){var numericAge=parseInt(age);100<(cancerData.numericAgeAtDiagnosis=numericAge)&&(age="after_100"),cancerData.ageAtDiagnosis=age}addCommentToProperties(properties,cancer.comment)}cancer.onlySetComment||(properties.cancers[cancer.label]=cancerData)}var mutations=parts[17];"1"==mutations||"2"==mutations||"3"==mutations?(properties.candidateGenes=[],1!=mutations&&3!=mutations||properties.candidateGenes.push("BRCA1"),2!=mutations&&3!=mutations||properties.candidateGenes.push("BRCA2")):"N"==mutations&&addCommentToProperties(properties,"BRCA tested: no mutations"),"0"!=parts[18]&&(properties.ethnicities=["Ashkenazi Jews"]);var useID=1==parts[2]?0:nextID++;i==inputLines.length-1&&void 0===newG.v[0]&&(useID=0);var pedigreeID=newG._addVertex(useID,BaseGraph.TYPE.PERSON,properties,newG.defaultPersonNodeWidth);nameToId[extID]=pedigreeID}var relationshipTracker=new RelationshipTracker(newG,1);for(i=0;i<inputLines.length;i++){var parts,id=nameToId[extID=(parts=inputLines[i].split(/\s+/))[3]],fatherID=parts[4],motherID=parts[5];if(0!=fatherID||0!=motherID){0==fatherID?fatherID=newG._addVertex(null,BaseGraph.TYPE.PERSON,{gender:"M",comments:"unknown"},newG.defaultPersonNodeWidth):(fatherID=nameToId[fatherID],"F"==newG.properties[fatherID].gender&&console.warn("Unable to import pedigree: a person declared as female [id: "+fatherID+"] is also declared as being a father for [id: "+extID+"]")),0==motherID?motherID=newG._addVertex(null,BaseGraph.TYPE.PERSON,{gender:"F",comments:"unknown"},newG.defaultPersonNodeWidth):(motherID=nameToId[motherID],"M"==newG.properties[motherID].gender&&console.warn("Unable to import pedigree: a person declared as male [id: "+motherID+"] is also declared as being a mother for [id: "+extID+"]"));var chhubID=relationshipTracker.createOrGetChildhub(motherID,fatherID);newG.addEdge(chhubID,id,1)}}return PedigreeImport.validateBaseGraph(newG),newG},PedigreeImport.validateBaseGraph=function(newG){try{newG.validate()}catch(err){throw err.indexOf("disconnected component")?"Unsupported pedigree: some components of the imported pedigree are disconnected from each other":"Unable to import pedigree"}},PedigreeImport.initFromSimpleJSON=function(inputText){try{var inputArray=JSON.parse(inputText)}catch(err){throw"Unable to import pedigree: input is not a valid JSON string "+err}if("object"!=typeof inputArray||"[object Array]"!==Object.prototype.toString.call(inputArray))throw"Unable to import pedigree: JSON does not represent an array of objects";if(0==inputArray.length)throw"Unable to import pedigree: input is empty";for(var newG=new BaseGraph,nameToID={},externalIDToID={},ambiguousReferences={},hasID={},unRenderedNodes=void 0,i=0;i<inputArray.length;i++)if(!inputArray[i].hasOwnProperty("relationshipId"))if(!inputArray[i].hasOwnProperty("unrendered")&&!inputArray[i].hasOwnProperty("unRendered")||1!=inputArray[i].unRendered){if("object"!=typeof(nextPerson=inputArray[i]))throw"Unable to import pedigree: JSON does not represent an array of objects";if(!(nextPerson.hasOwnProperty("id")||nextPerson.hasOwnProperty("name")||nextPerson.hasOwnProperty("firstName")||nextPerson.hasOwnProperty("externalId")))throw"Unable to import pedigree: a node with no ID or name is found";var pedigreeID=newG._addVertex(null,BaseGraph.TYPE.PERSON,{},newG.defaultPersonNodeWidth),properties={gender:"U"};for(var property in nextPerson)if(nextPerson.hasOwnProperty(property)){if("otherIdentifier"==property||"otherIdentifierType"==property||"estimatedDateOfDelivery"==property||"participatingInTest"==property||"clinicalIndicationName"==property||"tumour"==property||"numberOfColorectalPolypsAdenomas"==property||"numberOfColorectalPolypsTotal"==property||"clinicalIndicationName"==property||"lastMenstralPeriod"==property||"nonNgisPatientStableUid"==property||"ngisRegisteredPatientSimpleId"==property||"ngisRegisteredPatientUid"==property||"clinicalIndicationAgeOfOnset"==property||"carrierStatus"==property||"gestationAgeDays"==property||"gestationAgeWeeks"==property||"chiNumber"==property||"organDonorId"==property||"localIdentifier"==property||"clinicalIndicationAgeOfOnsetMonths"==property||"clinicalIndicationAgeOfOnsetYears"==property)console.log("Adding Custom Property",property,value),null!==(processed=PedigreeImport.convertProperty(property,nextPerson[property]))&&(properties[processed.propertyName]=processed.value);var value=nextPerson[property];if("mother"==(property=property.toLowerCase())||"father"==property)continue;if("sex"==property&&null!=value){var genderString=value.toLowerCase();"female"==genderString||"f"==genderString||"2"==genderString?properties.gender="F":"male"==genderString||"m"==genderString||"1"==genderString?properties.gender="M":"indeterminate"!=genderString&&"o"!=genderString&&"9"!=genderString||(properties.gender="O")}else if("id"==property){if(externalIDToID.hasOwnProperty(value))throw"Unable to import pedigree: multiple persons with the same ID ["+value+"]";nameToID.hasOwnProperty(value)&&nameToID[value]!=pedigreeID?(delete nameToID[value],ambiguousReferences[value]=!0):hasID[externalIDToID[value]=pedigreeID]=!0}else if("name"==property||"firstname"==property)properties.fName=value,nameToID.hasOwnProperty(value)&&nameToID[value]!=pedigreeID?(delete nameToID[value],ambiguousReferences[value]=!0):externalIDToID.hasOwnProperty(value)&&externalIDToID[value]!=pedigreeID?(delete externalIDToID[value],ambiguousReferences[value]=!0):nameToID[value]=pedigreeID;else{null!==(processed=PedigreeImport.convertProperty(property,value))&&(properties[processed.propertyName]=processed.value)}}nextPerson.hasOwnProperty("externalId")&&!hasID.hasOwnProperty(pedigreeID)&&(hasID[externalIDToID[nextPerson.externalId]=pedigreeID]=!0),newG.properties[pedigreeID]=properties}else unRenderedNodes||(unRenderedNodes=[]),unRenderedNodes.push(inputArray[i]);var person,findReferencedPerson=function(reference,refType){if(ambiguousReferences.hasOwnProperty(reference))throw"Unable to import pedigree: ambiguous reference to ["+reference+"]";if(externalIDToID.hasOwnProperty(reference))return externalIDToID[reference];if(nameToID.hasOwnProperty(reference))return nameToID[reference];throw"Unable to import pedigree: ["+reference+"] is not a valid "+refType+" reference (does not correspond to a name or an ID of another person)"},relationshipTracker=new RelationshipTracker(newG,1);for(i=0;i<inputArray.length;i++)if(!inputArray[i].hasOwnProperty("relationshipId")){var nextPerson=inputArray[i],personID=(person=nextPerson).hasOwnProperty("id")?externalIDToID[person.id]:person.hasOwnProperty("firstName")?nameToID[person.firstName]:person.hasOwnProperty("name")?nameToID[person.name]:void 0,motherLink=nextPerson.hasOwnProperty("mother")?nextPerson.mother:null,fatherLink=nextPerson.hasOwnProperty("father")?nextPerson.father:null;if(null!=motherLink||null!=fatherLink){if(null==fatherLink)var fatherID=newG._addVertex(null,BaseGraph.TYPE.PERSON,{gender:"M",comments:"unknown"},newG.defaultPersonNodeWidth);else{fatherID=findReferencedPerson(fatherLink,"father");"F"==newG.properties[fatherID].gender&&console.warn("Unable to import pedigree: a person declared as female is also declared as being a father ("+fatherLink+")")}if(null==motherLink)var motherID=newG._addVertex(null,BaseGraph.TYPE.PERSON,{gender:"F",comments:"unknown"},newG.defaultPersonNodeWidth);else{motherID=findReferencedPerson(motherLink,"mother");"M"==newG.properties[motherID].gender&&console.warn("Unable to import pedigree: a person declared as male is also declared as being a mother ("+motherLink+")")}if(fatherID==personID||motherID==personID)throw"Unable to import pedigree: a person is declared to be his or hew own parent";var chhubID=relationshipTracker.createOrGetChildhub(motherID,fatherID);newG.addEdge(chhubID,personID,1)}}for(i=0;i<inputArray.length;i++)if(inputArray[i].hasOwnProperty("relationshipId")){var nextRelationship=inputArray[i],partnerLink1=nextRelationship.hasOwnProperty("partner1")?nextRelationship.partner1:null,partnerLink2=nextRelationship.hasOwnProperty("partner2")?nextRelationship.partner2:null;if(null==partnerLink1||null==partnerLink2)throw"Unable to import pedigree: a relationship has only one partner specified";var partnerID1=findReferencedPerson(partnerLink1),partnerID2=findReferencedPerson(partnerLink2);chhubID=relationshipTracker.createOrGetChildhub(partnerID1,partnerID2);if(0==newG.getOutEdges(chhubID).length){var placeholderID=newG._addVertex(null,BaseGraph.TYPE.PERSON,{gender:"U",placeholder:!0},newG.defaultPersonNodeWidth);newG.addEdge(chhubID,placeholderID,1)}var relationshipID=relationshipTracker.getRelationshipIDForChildHub(chhubID);for(var property in nextRelationship)if(nextRelationship.hasOwnProperty(property)){var processed;value=nextRelationship[property];if("partner1"==(property=property.toLowerCase())||"partner2"==property)continue;null!==(processed=PedigreeImport.convertRelationshipProperty(property,value))&&(newG.properties[relationshipID][processed.propertyName]=processed.value)}}return PedigreeImport.validateBaseGraph(newG),newG.unRenderedNodes=unRenderedNodes,newG},PedigreeImport.initFromGEDCOM=function(inputText,markEvaluated,saveIDAsExternalID){var inputLines=inputText.match(/[^\r\n]+/g);if(0==inputLines.length)throw"Unable to import: no data";var gedcom=function(inputLines){for(var obj={header:{},individuals:[],families:[]},currentObject=[],i=0;i<inputLines.length;i++){inputLines[i].replace(/[^a-zA-Z0-9.\@\/\-\s*]/g," ").replace(/^\s+|\s+$/g,"");var words=inputLines[i].split(/\s+/),parts=words.splice(0,2);parts.push(words.join(" "));var level=parseInt(parts[0]);if(currentObject.splice(level),0==level)"HEAD"==parts[1]?currentObject[0]=obj.header:"@"==parts[1][0]&&"INDI"==parts[2]?(obj.individuals.push({}),currentObject[0]=obj.individuals[obj.individuals.length-1],currentObject[0].id=parts[1]):"@"==parts[1][0]&&"FAM"==parts[2]?(obj.families.push({}),currentObject[0]=obj.families[obj.families.length-1],currentObject[0].id=parts[1]):currentObject[0]={};else{if(currentObject.length<level-1)throw"Unable to import GEDCOM: a multi-level jump detected in line: ["+inputLines[i]+"]";currentObject[level-1].hasOwnProperty(parts[1])||(currentObject[level-1][parts[1]]=[]),currentObject.length<level+1&&(currentObject[level]={},currentObject[level-1][parts[1]].push(currentObject[level])),""!=parts[2]&&(currentObject[level].value=parts[2])}currentLevel=parts[0]}return obj}(inputLines);if(console.log("GEDCOM object: "+Helpers.stringifyObject(gedcom)),gedcom.header.hasOwnProperty("GEDC")&&gedcom.header.GEDC.hasOwnProperty("VERS")&&"5.5"!=gedcom.header.GEDC.VERS&&"5.5.1"!=gedcom.header.GEDC.VERS&&alert("Unsupported GEDCOM version detected: ["+gedcom.header.GEDC.VERS+"]. Import will continue but the correctness is not guaranteed. Supportede versions are 5.5 and 5.5.1"),0==gedcom.individuals.length)throw"Unable to create a pedigree from GEDCOM: no individuals are defined in the import data";for(var newG=new BaseGraph,externalIDToID={},i=0;i<gedcom.individuals.length;i++){var nextPerson=gedcom.individuals[i],pedigreeID=newG._addVertex(null,BaseGraph.TYPE.PERSON,{},newG.defaultPersonNodeWidth);externalIDToID[nextPerson.id]=pedigreeID;var cleanedID=nextPerson.id.replace(/@/g,""),properties=saveIDAsExternalID?{externalID:cleanedID}:{};properties.gender="U";var getFirstValue=function(obj){return obj[0].value},parseDate=function(gedcomDate){gedcomDate=(gedcomDate=(gedcomDate=(gedcomDate=(gedcomDate=gedcomDate[0].value).replace(/^(\s*)ABT(\s*)/,"")).replace(/^(\s*)EST(\s*)/,"")).replace(/^(\s*)BEF(\s*)/,"")).replace(/^(\s*)AFT(\s*)/,"");var match=/^\s*BET\s+(.+)\s+AND.*/.exec(gedcomDate);if(null!=match&&(gedcomDate=match[1]),"?"==gedcomDate)return null;var timestamp=Date.parse(gedcomDate);return 0==isNaN(timestamp)?new PedigreeDate(new Date(timestamp)):null};for(var property in nextPerson)if(nextPerson.hasOwnProperty(property))if("SEX"==property){var genderString=getFirstValue(nextPerson[property])[0].toLowerCase();"female"==genderString||"f"==genderString?properties.gender="F":"male"!=genderString&&"m"!=genderString||(properties.gender="M")}else if("BIRT"==property){if(nextPerson[property][0].hasOwnProperty("DATE"))null!==(date=parseDate(nextPerson[property][0].DATE))&&(properties.dob=new PedigreeDate(date).getSimpleObject())}else if("DEAT"==property){if(properties.hasOwnProperty("lifeStatus")&&"Stillborn"==properties.lifeStatus)continue;var date;if(properties.lifeStatus="Deceased",nextPerson[property][0].hasOwnProperty("DATE"))null!==(date=parseDate(nextPerson[property][0].DATE))&&(properties.dod=new PedigreeDate(date).getSimpleObject())}else if("ADOP"==property)properties.adoptedStatus="adoptedIn";else if("_INFO"==property)properties.hasOwnProperty("comments")||(properties.comments=""),properties.comments+="(Info: "+getFirstValue(nextPerson[property])+")\n";else if("NOTE"==property||"_COMMENT"==property){if(properties.hasOwnProperty("comments")||(properties.comments=""),properties.comments+=getFirstValue(nextPerson[property])+"\n",nextPerson[property][0].hasOwnProperty("CONT"))for(var more=nextPerson[property][0].CONT,cc=0;cc<more.length;cc++)properties.comments+=more[cc].value+"\n"}else if("NAME"==property){var firstName=(nameParts=getFirstValue(nextPerson[property]).split("/"))[0].replace(/^\s+|\s+$/g,""),lastName=1<nameParts.length?nameParts[1].replace(/^\s+|\s+$/g,""):"";properties.fName=firstName,""!=lastName&&(properties.lName=lastName)}else if("_MAIDEN"==property){var nameParts;firstName=(nameParts=getFirstValue(nextPerson[property]).split("/"))[0].replace(/^\s+|\s+$/g,""),lastName=1<nameParts.length?nameParts[1].replace(/^\s+|\s+$/g,""):"";properties.lNameAtB=firstName,""!=lastName&&(properties.lNameAtB+=" "+lastName)}else if("_GENSTAT"==property)for(var props=getFirstValue(nextPerson[property]).split(""),p=0;p<props.length;p++){var value=props[p];switch(65533!=value.charCodeAt(0)&&172!=value.charCodeAt(0)||(value="HEARSAY"),value){case"O":properties.carrierStatus="Affected",properties.disorders=["Affected"],markEvaluated&&(properties.evaluated=!0);break;case"HEARSAY":properties.carrierStatus="Presymptomatic",markEvaluated&&(properties.evaluated=!0);break;case"K":properties.lifeStatus="Stillborn";break;case"M":properties.childlessStatus="Infertile";break;case"E":properties.hasOwnProperty("comments")?properties.comments="(untested)\n"+properties.comments:properties.comments="(untested)"}}properties.hasOwnProperty("comments")&&(properties.comments=properties.comments.replace(/^\s+|\s+$/g,""),""==properties.comments&&delete properties.comments),newG.properties[pedigreeID]=properties}var relationshipTracker=new RelationshipTracker(newG,1);for(i=0;i<gedcom.families.length;i++){var nextFamily=gedcom.families[i],motherLink=nextFamily.hasOwnProperty("WIFE")?getFirstValue(nextFamily.WIFE):null,fatherLink=nextFamily.hasOwnProperty("HUSB")?getFirstValue(nextFamily.HUSB):null;if(null==fatherLink)var fatherID=newG._addVertex(null,BaseGraph.TYPE.PERSON,{gender:"M",comments:"unknown"},newG.defaultPersonNodeWidth);else{fatherID=externalIDToID[fatherLink];if("F"==newG.properties[fatherID].gender)throw"Unable to import pedigree: a person declared as female is also declared as being a father ("+fatherLink+")"}if(null==motherLink)var motherID=newG._addVertex(null,BaseGraph.TYPE.PERSON,{gender:"F",comments:"unknown"},newG.defaultPersonNodeWidth);else{motherID=externalIDToID[motherLink];if("M"==newG.properties[motherID].gender)throw"Unable to import pedigree: a person declared as male is also declared as being a mother ("+motherLink+")"}var chhubID=relationshipTracker.createOrGetChildhub(motherID,fatherID),children=nextFamily.hasOwnProperty("CHIL")?nextFamily.CHIL:null;if(null==children)children=[{value:externalIDToID[childID=newG._addVertex(null,BaseGraph.TYPE.PERSON,{gender:"U",placeholder:!0},newG.defaultPersonNodeWidth)]=childID}];for(var j=0;j<children.length;j++){var childID,externalID=children[j].value;if(null==(childID=externalIDToID.hasOwnProperty(externalID)?externalIDToID[externalID]:null))throw"Unable to import pedigree: child link does not point to an existing individual: ["+externalID+"]";newG.addEdge(chhubID,childID,1)}}return PedigreeImport.validateBaseGraph(newG),newG},PedigreeImport.JSONToInternalPropertyMapping={proband:"proband",lastname:"lName",participatingInTest:"participatingInTest",otherIdentifier:"otherIdentifier",otherIdentifierType:"otherIdentifierType",gestationAgeWeeks:"gestationAgeWeeks",gestationAgeDays:"gestationAgeDays",estimatedDateOfDelivery:"estimatedDateOfDelivery",comments:"comments",nhsnumber:"NHSNumber",chiNumber:"chiNumber",localIdentifier:"localIdentifier",organDonorId:"organDonorId",familyid:"familyId",gelsuperfamilyid:"gelSuperFamilyId",consanguineouspopulation:"consanguineousPopulation",karyotypicsex:"karyotypicSex",ancestries:"ancestries",participantid:"participantId",registered:"registered",lastnameatbirth:"lNameAtB",comments:"comments",twingroup:"twinGroup",monozygotic:"monozygotic",adoptedstatus:"adoptedStatus",evaluated:"evaluated",birthdate:"dob",deathdate:"dod",ageatdeath:"ageOfDeath",ageatdeathformat:"ageOfDeathFormat",lifestatus:"lifeStatus",disorders:"disorders",disordersfulldetails:"disordersFullDetails",hpoterms:"hpoTerms",hpotermsfulldetails:"hpoTermsFullDetails",candidategenes:"candidateGenes",ethnicities:"ethnicities",carrierStatus:"carrierStatus",externalid:"externalID",clinicalIndicationAgeOfOnsetMonths:"clinicalIndicationAgeOfOnsetMonths",clinicalIndicationAgeOfOnsetYears:"clinicalIndicationAgeOfOnsetYears",numpersons:"numPersons",lostcontact:"lostContact",nodenumber:"nodeNumber",cancers:"cancers",childlessstatus:"childlessStatus",childlessreason:"childlessReason",clinicalIndicationName:"clinicalIndicationName",tumour:"cancers",numberOfColorectalPolypsAdenomas:"numberOfColorectalPolypsAdenomas",numberOfColorectalPolypsTotal:"numberOfColorectalPolypsTotal",nonNgisPatientStableUid:"nonNgisPatientStableUid",ngisRegisteredPatientSimpleId:"ngisRegisteredPatientUid",ngisRegisteredPatientUid:"ngisRegisteredPatientSimpleId",lastMenstralPeriod:"lastMenstralPeriod"},PedigreeImport.convertProperty=function(externalPropertyName,value){return PedigreeImport.JSONToInternalPropertyMapping.hasOwnProperty(externalPropertyName)?{propertyName:PedigreeImport.JSONToInternalPropertyMapping[externalPropertyName],value:value}:null},PedigreeImport.JSONToInternalRelationshipPropertyMapping={childlessstatus:"childlessStatus",childlessreason:"childlessReason",consanguinity:"consangr",separated:"broken"},PedigreeImport.convertRelationshipProperty=function(externalPropertyName,value){if(!PedigreeImport.JSONToInternalRelationshipPropertyMapping.hasOwnProperty(externalPropertyName))return null;var internalPropertyName=PedigreeImport.JSONToInternalRelationshipPropertyMapping[externalPropertyName];return"consanguinity"==externalPropertyName&&-1==["Y","N","P","U"].indexOf(value)?null:{propertyName:internalPropertyName,value:value}},RelationshipTracker=function(newG,defaultEdgeWeight){this.newG=newG,this.defaultEdgeWeight=defaultEdgeWeight,this.relationships={},this.relChildHubs={},this.chhubRels={}},RelationshipTracker.prototype={createOrGetChildhub:function(partnerID1,partnerID2){if(this.relationships.hasOwnProperty(partnerID1)&&this.relationships[partnerID1].hasOwnProperty(partnerID2))var relID=this.relationships[partnerID1][partnerID2],chhubID=this.relChildHubs[relID];else{void 0===this.relationships[partnerID1]&&(this.relationships[partnerID1]={}),void 0===this.relationships[partnerID2]&&(this.relationships[partnerID2]={});relID=this.newG._addVertex(null,BaseGraph.TYPE.RELATIONSHIP,{},this.newG.defaultNonPersonNodeWidth),chhubID=this.newG._addVertex(null,BaseGraph.TYPE.CHILDHUB,{},this.newG.defaultNonPersonNodeWidth);this.newG.addEdge(relID,chhubID,this.defaultEdgeWeight),this.newG.addEdge(partnerID1,relID,this.defaultEdgeWeight),this.newG.addEdge(partnerID2,relID,this.defaultEdgeWeight),this.relationships[partnerID1][partnerID2]=relID,this.relationships[partnerID2][partnerID1]=relID,this.relChildHubs[relID]=chhubID,this.chhubRels[chhubID]=relID}return chhubID},getRelationshipIDForChildHub:function(chhubID){return this.chhubRels[chhubID]}},PedigreeExport=function(){},PedigreeExport.prototype={},PedigreeExport.exportAsSimpleJSON=function(pedigree,privacySetting){for(var exportObj=[],getMotherFather=function(nodeID){var parents=pedigree.GG.getParents(nodeID);if(0<parents.length){var father=parents[0],mother=parents[1];"F"!=pedigree.GG.properties[parents[0]].gender&&"M"!=pedigree.GG.properties[parents[1]].gender||(father=parents[1],mother=parents[0])}return{mother:mother,father:father}},idToJSONId=PedigreeExport.createNewIDs(pedigree),i=0;i<=pedigree.GG.getMaxRealVertexId();i++)if(pedigree.GG.isPerson(i)&&!pedigree.GG.isPlaceholder(i)){var person={id:idToJSONId[i]},parents=getMotherFather(i);person.father=idToJSONId[parents.father],person.mother=idToJSONId[parents.mother];var properties=pedigree.GG.properties[i];for(var property in properties)if(properties.hasOwnProperty(property)){if("all"!=privacySetting){if("lName"==property||"fName"==property||"lNameAtB"==property||"dob"==property||"bob"==property)continue;if("minimal"==privacySetting&&"comments"==property)continue}null!==(converted=PedigreeExport.convertProperty(property,properties[property]))&&(person[converted.propertyName]=converted.value),converted&&"ageOfDeathFormat"==converted.propertyName&&(!person.ageOfDeath||person.ageOfDeath&&""==person.ageOfDeath)&&delete person.ageOfDeathFormat}exportObj.push(person)}var nextRelId=1;for(i=0;i<=pedigree.GG.getMaxRealVertexId();i++)if(pedigree.GG.isRelationship(i)){var relationship={relationshipId:nextRelId++},hasProperties=(properties=pedigree.GG.properties[i],!1);for(var property in properties){var converted;if(properties.hasOwnProperty(property))hasProperties=!0,null!==(converted=PedigreeExport.convertRelationshipProperty(property,properties[property]))&&(relationship[converted.propertyName]=converted.value)}if(hasProperties){parents=getMotherFather(i);relationship.partner1=idToJSONId[parents.father],relationship.partner2=idToJSONId[parents.mother],exportObj.push(relationship)}}return JSON.stringify(exportObj)},PedigreeExport.exportAsPED=function(pedigree,idGenerationPreference){for(var output="",familyID=XWiki.currentDocument.page,idToPedId=PedigreeExport.createNewIDs(pedigree,idGenerationPreference),i=0;i<=pedigree.GG.getMaxRealVertexId();i++)if(pedigree.GG.isPerson(i)&&!pedigree.GG.isPlaceholder(i)){output+=familyID+" "+idToPedId[i]+" ";var parents=pedigree.GG.getParents(i);if(0<parents.length){var father=parents[0],mother=parents[1];"F"!=pedigree.GG.properties[parents[0]].gender&&"M"!=pedigree.GG.properties[parents[1]].gender||(father=parents[1],mother=parents[0]),output+=idToPedId[father]+" "+idToPedId[mother]+" "}else output+="0 0 ";var sex=3;"M"==pedigree.GG.properties[i].gender?sex=1:"F"==pedigree.GG.properties[i].gender&&(sex=2),output+=sex+" ";var status=-9;pedigree.GG.properties[i].hasOwnProperty("carrierStatus")&&(status="Affected"==pedigree.GG.properties[i].carrierStatus||"Carrier"==pedigree.GG.properties[i].carrierStatus||"Presymptomatic"==pedigree.GG.properties[i].carrierStatus?2:1),output+=status+"\n"}return output},PedigreeExport.exportAsBOADICEA=function(dynamicPedigree,idGenerationPreference){var pedigree=dynamicPedigree.DG,output="BOADICEA import pedigree file format 2.0\n";output+="FamID\t\tName\tTarget\tIndivID\tFathID\tMothID\tSex\tTwin\tDead\tAge\tYob\t1BrCa\t2BrCa\tOvCa\tProCa\tPanCa\tGtest\tMutn\tAshkn\tNot_implemented_yet\n";for(var familyID=XWiki.currentDocument.page,idToBoadId=PedigreeExport.createNewIDs(pedigree,idGenerationPreference,7,!0),alertUnknownGenderFound=!1,warnAboutMissingDOB=!1,i=0;i<=pedigree.GG.getMaxRealVertexId();i++)if(pedigree.GG.isPerson(i)&&!pedigree.GG.isPlaceholder(i)){var id=idToBoadId[i];output+=familyID+"\t"+(pedigree.GG.properties[i].hasOwnProperty("fName")?pedigree.GG.properties[i].fName.substring(0,8).replace(/[^A-Za-z0-9]/g,""):id)+"\t"+(0==i?"1":"0")+"\t"+id+"\t";var parents=pedigree.GG.getParents(i);if(0<parents.length){if("U"==pedigree.GG.properties[parents[0]].gender&&"U"==pedigree.GG.properties[parents[1]].gender)return editor.getOkCancelDialogue().showCustomized("Unable to export in BOADICEA format when both parents of any node are of unknown gender","Can't export: missing gender data","OK",null),"";var father=parents[0],mother=parents[1];"F"!=pedigree.GG.properties[parents[0]].gender&&"M"!=pedigree.GG.properties[parents[1]].gender||(father=parents[1],mother=parents[0]),output+=idToBoadId[father]+"\t"+idToBoadId[mother]+"\t"}else output+="0\t0\t";var sex="M",gender=pedigree.GG.properties[i].gender;if("F"==gender)sex="F";else if("U"==gender||"O"==gender){var possibleGenders=dynamicPedigree.getPossibleGenders(i);if(!possibleGenders.F&&!possibleGenders.M)return editor.getOkCancelDialogue().showCustomized("Unable to export in BOADICEA format since gender assignment in pedigree is inconsistent","Can't export: gender inconsistency in pedigree","OK",null),"";sex=possibleGenders.F&&!possibleGenders.M?"F":(possibleGenders.M&&possibleGenders.F,"M"),alertUnknownGenderFound=!0}output+=sex+"\t",null!==pedigree.GG.getTwinGroupId(i)&&pedigree.GG.properties[i].hasOwnProperty("monozygotic")&&pedigree.GG.properties[i].monozygotic?output+="1\t":output+="0\t";var dead="0";if(pedigree.GG.properties[i].hasOwnProperty("lifeStatus")&&"Alive"!=pedigree.GG.properties[i].lifeStatus)dead="1";output+=dead+"\t";var age="0",yob="0";if(pedigree.GG.properties[i].hasOwnProperty("dob")){var birthDate=new PedigreeDate(pedigree.GG.properties[i].dob);if(yob=parseInt(birthDate.getAverageYearEstimate()),pedigree.GG.properties[i].hasOwnProperty("dod")){var deathDate=new PedigreeDate(pedigree.GG.properties[i].dod),lastYearAlive=parseInt(deathDate.getAverageYearEstimate());deathDate.toJSDate().getDayOfYear()<birthDate.toJSDate().getDayOfYear()&&lastYearAlive--}else lastYearAlive=(new Date).getFullYear();(age=lastYearAlive-yob)<0&&(age="0")}output+=age+"\t"+yob+"\t";for(var cancerSequence=["Breast","","Ovarian","Prostate","Pancreatic"],c=0;c<cancerSequence.length;c++)if(cancer=cancerSequence[c],""!=cancer&&pedigree.GG.properties[i].hasOwnProperty("cancers"))if(pedigree.GG.properties[i].cancers.hasOwnProperty(cancer)){var cancerData=pedigree.GG.properties[i].cancers[cancer];if(cancerData.affected)output+=(cancerData.hasOwnProperty("numericAgeAtDiagnosis")&&0<cancerData.numericAgeAtDiagnosis?cancerData.numericAgeAtDiagnosis:"AU").toString()+"\t","0"==yob&&(warnAboutMissingDOB=!0);else output+="0\t"}else output+="0\t";else output+="0\t";if(output+="0\t",pedigree.GG.properties[i].hasOwnProperty("candidateGenes")){var genes=pedigree.GG.properties[i].candidateGenes,status="0";0<=Helpers.arrayIndexOf(genes,"BRCA1")&&(status="1"),0<=Helpers.arrayIndexOf(genes,"BRCA2")&&(status="1"==status?"3":"2"),output+=status+"\t"}else output+="0\t";var ashkenazi="0";if(pedigree.GG.properties[i].hasOwnProperty("ethnicities"))for(var ethnicities=pedigree.GG.properties[i].ethnicities,k=0;k<ethnicities.length;k++)if(null!==ethnicities[k].match(/ashkenaz/i)){ashkenazi="1";break}output+=ashkenazi+"\t",output+="0\t0\t0\t0\t0",output+="\n"}if(alertUnknownGenderFound||warnAboutMissingDOB){var warningText="Pedigree can be exported, but there are warnings:\n\n\n",numberWarnings=!1;alertUnknownGenderFound&&warnAboutMissingDOB&&(numberWarnings=!0),alertUnknownGenderFound&&(warningText+=(numberWarnings?"1) ":"")+"BOADICEA format does not support unknown or other genders.\n\nAll persons of unknown or other gender were either assigned a gender opposite to their partner's gender or saved as male in the export file"),warnAboutMissingDOB&&(warningText+=(numberWarnings?"\n\n\n2) ":"")+"BOADICEA requires that all individuals with cancer have their age specified or estimated.\n\nA person with cancer is missing age data, data will be exported but may not be accepted by BOADICEA"),alert(warningText)}return output},PedigreeExport.internalToJSONPropertyMapping={proband:"proband",otherIdentifier:"otherIdentifier",otherIdentifierType:"otherIdentifierType",participatingInTest:"participatingInTest",gestationAgeWeeks:"gestationAgeWeeks",gestationAgeDays:"gestationAgeDays",estimatedDateOfDelivery:"estimatedDateOfDelivery",comments:"comments",fName:"firstName",lName:"lastName",NHSNumber:"NHSNumber",chiNumber:"chiNumber",localIdentifier:"localIdentifier",organDonorId:"organDonorId",gelSuperFamilyId:"gelSuperFamilyId",karyotypicSex:"karyotypicSex",consanguineousPopulation:"consanguineousPopulation",ancestries:"ancestries",participantId:"participantId",registered:"registered",lNameAtB:"lastNameAtBirth",twinGroup:"twinGroup",monozygotic:"monozygotic",adoptedStatus:"adoptedStatus",evaluated:"evaluated",dob:"birthDate",dod:"deathDate",ageOfDeath:"ageAtDeath",ageOfDeathFormat:"ageAtDeathFormat",lifeStatus:"lifeStatus",disorders:"disorders",disordersFullDetails:"disordersFullDetails",ethnicities:"ethnicities",carrierStatus:"carrierStatus",externalID:"externalId",gender:"sex",numPersons:"numPersons",hpoTerms:"hpoTerms",hpoTermsFullDetails:"hpoTermsFullDetails",candidateGenes:"candidateGenes",lostContact:"lostContact",nodeNumber:"nodeNumber",cancers:"cancers",childlessStatus:"childlessStatus",childlessReason:"childlessReason",clinicalIndicationName:"clinicalIndicationName",numberOfColorectalPolypsAdenomas:"numberOfColorectalPolypsAdenomas",numberOfColorectalPolypsTotal:"numberOfColorectalPolypsTotal",nonNgisPatientStableUid:"nonNgisPatientStableUid",ngisRegisteredPatientUid:"ngisRegisteredPatientSimpleId",ngisRegisteredPatientSimpleId:"ngisRegisteredPatientUid",clinicalIndicationAgeOfOnset:"clinicalIndicationAgeOfOnset",clinicalIndicationAgeOfOnsetYears:"clinicalIndicationAgeOfOnsetYears",clinicalIndicationAgeOfOnsetMonths:"clinicalIndicationAgeOfOnsetMonths"},PedigreeExport.internalToJSONRelationshipPropertyMapping={childlessStatus:"childlessStatus",childlessReason:"childlessReason",consangr:"consanguinity",broken:"separated"},PedigreeExport.convertProperty=function(internalPropertyName,value){if(!PedigreeExport.internalToJSONPropertyMapping.hasOwnProperty(internalPropertyName))return null;var externalPropertyName=PedigreeExport.internalToJSONPropertyMapping[internalPropertyName];return"sex"==externalPropertyName&&(value="M"==value||"m"==value||"1"==value?"Male":"F"==value||"f"==value||"2"==value?"Female":"O"==value||"9"==value?"Indeterminate":"Unknown"),{propertyName:externalPropertyName,value:value}},PedigreeExport.convertRelationshipProperty=function(internalPropertyName,value){if(!PedigreeExport.internalToJSONRelationshipPropertyMapping.hasOwnProperty(internalPropertyName))return null;var externalPropertyName=PedigreeExport.internalToJSONRelationshipPropertyMapping[internalPropertyName];return"consanguinity"==externalPropertyName&&"Y"!=value&&"N"!=value&&"P"!=value&&"U"!=value?null:{propertyName:externalPropertyName,value:value}},PedigreeExport.createNewIDs=function(pedigree,idGenerationPreference,maxLength,forbidNonAlphaNum){idGenerationPreference||(idGenerationPreference="newid");for(var idToNewId={},usedIDs={},nextUnusedID=1,i=0;i<=pedigree.GG.getMaxRealVertexId();i++)if(pedigree.GG.isPerson(i)&&!pedigree.GG.isPlaceholder(i)){var id=nextUnusedID++;"external"==idGenerationPreference&&pedigree.GG.properties[i].hasOwnProperty("externalID")?(nextUnusedID--,id=pedigree.GG.properties[i].externalID.replace(/\s/g,"_")):"name"==idGenerationPreference&&pedigree.GG.properties[i].hasOwnProperty("fName")&&(nextUnusedID--,id=pedigree.GG.properties[i].fName.replace(/\s/g,"_")),id=String(id),forbidNonAlphaNum&&(id=id.replace(/[^A-Za-z0-9]/g,"")),maxLength&&id.length>maxLength&&(id=id.substring(0,maxLength));for(var baseID=id,numSimilar=2;usedIDs.hasOwnProperty(id);){if(maxLength){var cutSize=baseID.length+String(numSimilar).length-maxLength;id=baseID.substring(0,id.length-cutSize)}else id=baseID;id+=String(numSimilar),numSimilar++}usedIDs[idToNewId[i]=id]=!0}return idToNewId},VerticalPosIntOptimizer=function(pairScoreFunc,initLevels,minLevels){this.pairScoreFunc=pairScoreFunc,this.initLevels=initLevels,this.maxOfMinlevels=1,minLevels&&(this.maxOfMinlevels=Math.max.apply(null,minLevels),1<this.maxOfMinlevels&&(this.minLevels=minLevels));var precompute=this.computeComponents();this.components=precompute.components,this.crosses=precompute.crosses},VerticalPosIntOptimizer.prototype={numberOfLevelsPenalty:function(maxLevelUsed,minRequired,numEdges){return(maxLevelUsed-minRequired)/(numEdges+1)},componentScoreFunc:function(levels,componentID){for(var penalty=0,maxLevelUsed=0,minRequired=1,component=this.components.getComponentEdges(componentID),i=0;i<component.length;i++){var edge=component[i];levels[edge]>maxLevelUsed&&(maxLevelUsed=levels[edge]),this.minLevels&&this.minLevels[edge]>minRequired&&(minRequired=this.minLevels[edge]);for(var crosses=this.crosses[edge],j=0;j<crosses.length;j++){var intersects=crosses[j];if(edge<intersects&&(penalty+=this.pairScoreFunc(edge,intersects,levels[edge],levels[intersects],levels),!isFinite(penalty)))return penalty}}return penalty+=this.numberOfLevelsPenalty(maxLevelUsed,minRequired,component.length)},computeComponents:function(){for(var components=new Complonents,crosses=[],hasToBeAboveForPerfectScore=[],numEdges=this.initLevels.length,i=0;i<numEdges;i++)crosses[i]=[],hasToBeAboveForPerfectScore[i]=[];for(i=0;i<numEdges-1;i++)for(var j=i+1;j<numEdges;j++)if(this.pairScoreFunc(i,j,1,1)==1/0){crosses[i].push(j),crosses[j].push(i);var componentI=components.getEdgeComponent(i),componentJ=components.getEdgeComponent(j);void 0===componentI&&void 0===componentJ?(components.addToNewComponent(i),components.addToExistingComponent(j,components.getEdgeComponent(i))):void 0!==componentI?void 0!==componentJ?componentI!=componentJ&&components.mergeComponents(componentI,componentJ):components.addToExistingComponent(j,componentI):components.addToExistingComponent(i,componentJ);var scoreAbove=this.pairScoreFunc(i,j,1,2),scoreBelow=this.pairScoreFunc(i,j,2,1),compID=components.getEdgeComponent(i);components.addRequiredPenaltyToComponent(compID,Math.min(scoreAbove,scoreBelow)),scoreAbove<scoreBelow&&hasToBeAboveForPerfectScore[i].push(j),scoreBelow<scoreAbove&&hasToBeAboveForPerfectScore[j].push(i)}for(compID=0;compID<components.getNumComponents();compID++){var minNumLevels=1,minRequired=1,minMinLevel=1/0,component=components.getComponentEdges(compID);for(i=0;i<component.length;i++){var edge=component[i];this.minLevels&&(this.minLevels[edge]>minRequired&&(minRequired=this.minLevels[edge]),this.minLevels[edge]<minMinLevel&&(minMinLevel=this.minLevels[edge]));var minForThisEdge=this.minLevels?this.minLevels[edge]:1;for(j=0;j<hasToBeAboveForPerfectScore[edge].length;j++){var needToBeAboveEdge=hasToBeAboveForPerfectScore[edge][j],minForOtherEdge=this.minLevels?this.minLevels[edge]:1;0<hasToBeAboveForPerfectScore[needToBeAboveEdge].length&&1==minForOtherEdge&&minForOtherEdge++,minForThisEdge=Math.max(minForThisEdge,minForOtherEdge+1)}minNumLevels=Math.max(minNumLevels,minForThisEdge)}var needExtraLevelsAboveMin=0==components.getMinPossiblePenalty(compID)?0:1;isFinite(minMinLevel)||(minMinLevel=1),minNumLevels=Math.max(minNumLevels,minMinLevel+needExtraLevelsAboveMin);var penaltyForNumLevelsUsed=this.numberOfLevelsPenalty(minNumLevels,minRequired,component.length);components.addRequiredPenaltyToComponent(compID,penaltyForNumLevelsUsed)}return{crosses:crosses,components:components}},computeVerticalPositions:function(maxFullSearchSize,maxSteps,seed){this.seed=seed||1;for(var bestSoFar=this.initLevels,compID=0;compID<this.components.getNumComponents();compID++)bestSoFar=this.components.getComponentEdges(compID).length<=maxFullSearchSize?this.exhaustiveSearch(compID,bestSoFar):this.simulatedAnnellingOptimizer(compID,bestSoFar,maxSteps);return bestSoFar},exhaustiveSearch:function(componentID,bestSoFar){var initScore=this.componentScoreFunc(bestSoFar,componentID);return this.recursiveExhaustiveSearch(componentID,bestSoFar.slice(0),0,{values:bestSoFar,score:initScore}).values},recursiveExhaustiveSearch:function(componentID,valuesSoFar,level,bestSoFar){var component=this.components.getComponentEdges(componentID);if(level==component.length){var score=this.componentScoreFunc(valuesSoFar,componentID);return score<bestSoFar.score&&(bestSoFar.values=valuesSoFar.slice(0),bestSoFar.score=score),bestSoFar}var edge=component[level],minValue=1,maxValue=component.length;this.minLevels&&(maxValue+=(minValue=this.minLevels[edge])-1);for(var i=minValue;i<=maxValue&&(valuesSoFar[edge]=i,(bestSoFar=this.recursiveExhaustiveSearch(componentID,valuesSoFar,level+1,bestSoFar)).score!=this.components.getMinPossiblePenalty(componentID));i++);return bestSoFar},makeBasicValidAssignment:function(initLevels,componentID){for(var component=this.components.getComponentEdges(componentID),value=1,newAssignemnt=initLevels.slice(0),i=0;i<component.length;i++){var edge=component[i];this.minLevels&&value<this.minLevels[edge]&&(value=this.minLevels[edge]),newAssignemnt[edge]=value,value++}return newAssignemnt},computeNeighbour:function(currentState,componentID,step){var newLevel,component=this.components.getComponentEdges(componentID),newState=currentState.slice(0);do{for(var edge=component[Math.floor(this.random()*component.length)],oldLevel=newState[edge],maxUsedLevel=oldLevel,isBelowAll=!0,isAboveAll=!0,forbidden={},i=0;i<this.crosses[edge].length;i++){var crossLevel=newState[this.crosses[edge][i]];maxUsedLevel<crossLevel&&(maxUsedLevel=crossLevel),forbidden[crossLevel]=!0,oldLevel<=crossLevel&&(isAboveAll=!1),crossLevel<=oldLevel&&(isBelowAll=!1)}this.minLevels&&oldLevel==this.minLevels[edge]&&(isBelowAll=!0)}while(isAboveAll&&isBelowAll);for(;(newLevel=Math.floor(this.random()*(maxUsedLevel+2)))==oldLevel||isBelowAll&&newLevel<oldLevel||isAboveAll&&oldLevel<newLevel;);if(forbidden.hasOwnProperty(newLevel))for(i=0;i<component.length;i++){var e=component[i];newState[e]<=newLevel&&newState[e]++}return newState[edge]=newLevel,this.normalize(newState,component),newState},normalize:function(levels,component){for(var usedLevels=Helpers.filterUnique(levels).sort(),i=usedLevels.length-1;0<i;i--)if(usedLevels[i]!=usedLevels[i-1]+1){for(var j=0;j<component.length;j++){var e=component[j];levels[e]>=usedLevels[i]&&levels[e]--}break}for(i=0;i<component.length;i++){if((curLevel=levels[edge=component[i]])<(minLevel=this.minLevels?this.minLevels[edge]:1)){var adjust=minLevel-curLevel;for(j=0;j<component.length;j++)levels[component[j]]+=adjust}}for(i=0;i<component.length;i++){var edge,minLevel,curLevel=levels[edge=component[i]];if((minLevel=this.minLevels?this.minLevels[edge]:1)<curLevel){var highestBelow=0;for(j=0;j<this.crosses[edge].length;j++){var level=levels[this.crosses[edge][j]];level<curLevel&&highestBelow<level&&(highestBelow=levels[this.crosses[edge][j]])}highestBelow<curLevel-1&&(levels[edge]=highestBelow+1)}}},localOptimization:function(levels,currentScore,componentID,untilFirstImprovement){return currentScore},random:function(){var x=16*Math.sin(this.seed++);return x-Math.floor(x)},doSwitchDuringAnneling:function(oldScore,newScore,stepsSinceReset){return newScore<=oldScore||Math.exp(-(newScore-oldScore)*Math.log(5*(stepsSinceReset+1)))>this.random()},simulatedAnnellingOptimizer:function(componentID,bestSoFar,maxSteps){for(var bestScore=this.componentScoreFunc(bestSoFar,componentID),bestState=isFinite(bestScore)?bestSoFar:this.makeBasicValidAssignment(bestSoFar,componentID),bestStep=maxSteps,currentState=bestState,currentScore=bestScore=isFinite(bestScore)?bestScore:this.componentScoreFunc(bestState,componentID),maxWrongDirection=maxSteps/6,step=maxSteps;bestScore>this.components.getMinPossiblePenalty(componentID)&&0<=step;){step<bestStep-maxWrongDirection&&(currentState=bestState.slice(0),currentScore=this.localOptimization(currentState,bestScore,componentID,!0),bestStep=step,console.log("[asearch] reset to: "+Helpers.stringifyObject(currentState)+", score: "+currentScore+" (@ step = "+(maxSteps-step+1)+")"));var neighbourState=this.computeNeighbour(currentState,componentID,step),neighbourScore=this.componentScoreFunc(neighbourState,componentID);this.doSwitchDuringAnneling(currentScore,neighbourScore,bestStep-step)&&(currentState=neighbourState,currentScore=neighbourScore),currentScore<bestScore&&(console.log("[asearch] New best: "+Helpers.stringifyObject(currentState)+", score: "+currentScore+" (@ step = "+(maxSteps-step+1)+")"),bestState=currentState.slice(0),bestScore=currentScore,bestStep=step),step--}return bestScore=this.localOptimization(bestState,bestScore,componentID),console.log("[asearch] Final optimized best: "+Helpers.stringifyObject(bestState)+", score: "+bestScore),bestState}},Complonents=function(){this.components=[],this.minPossiblePenalty=[],this.edgeComponents=[]},Complonents.prototype={getNumComponents:function(){return this.components.length},getComponentEdges:function(componentID){return this.components[componentID]},getEdgeComponent:function(edge){return this.edgeComponents[edge]},addToNewComponent:function(edge){this.edgeComponents[edge]=this.components.length,this.components.push([edge]),this.minPossiblePenalty.push(0)},addToExistingComponent:function(edge,componentID){this.components[componentID].push(edge),this.edgeComponents[edge]=componentID},mergeComponents:function(component1,component2){if(component1!=component2){for(var minID=Math.min(component1,component2),maxID=Math.max(component1,component2),i=0;i<this.components[maxID].length;i++){var edge=this.components[maxID][i];this.addToExistingComponent(edge,minID)}this.minPossiblePenalty[minID]+=this.minPossiblePenalty[maxID],this.components.splice(maxID,1),this.minPossiblePenalty.splice(maxID,1)}},addRequiredPenaltyToComponent:function(componentID,penalty){this.minPossiblePenalty[componentID]+=penalty},getMinPossiblePenalty:function(componentID){return this.minPossiblePenalty[componentID]}};var AgeCalc={};AgeCalc.getAge=getAge,PositionedGraph=function(baseG,horizontalPersonSeparationDist,horizontalRelSeparationDist,maxInitOrderingBuckets,maxOrderingIterations,maxXcoordIterations,performVerticalPositioning,suggestedRanks){this.GG=void 0,this.ranks=void 0,this.maxRank=void 0,this.order=void 0,this.positions=void 0,this.vertLevel=void 0,this.rankY=void 0,this.ancestors=void 0,this.consangr=void 0,this.initialize(baseG,horizontalPersonSeparationDist,horizontalRelSeparationDist,maxInitOrderingBuckets,maxOrderingIterations,maxXcoordIterations,performVerticalPositioning,suggestedRanks)},PositionedGraph.prototype={maxInitOrderingBuckets:5,maxOrderingIterations:24,maxXcoordIterations:4,xCoordEdgeWeightValue:!0,horizontalPersonSeparationDist:10,horizontalTwinSeparationDist:8,horizontalRelSeparationDist:6,yDistanceNodeToChildhub:20,yDistanceChildhubToNode:14,yExtraPerHorizontalLine:4,yAttachPortHeight:1.5,yCommentLineHeight:2.9,initialize:function(baseG,horizontalPersonSeparationDist,horizontalRelSeparationDist,maxInitOrderingBuckets,maxOrderingIterations,maxXcoordIterations,performVerticalPositioning,suggestedRanks){if(horizontalPersonSeparationDist&&(this.horizontalPersonSeparationDist=horizontalPersonSeparationDist),horizontalRelSeparationDist&&(this.horizontalRelSeparationDist=horizontalRelSeparationDist),maxInitOrderingBuckets&&(this.maxInitOrderingBuckets=maxInitOrderingBuckets),maxOrderingIterations&&(this.maxOrderingIterations=maxOrderingIterations),maxXcoordIterations&&(this.maxXcoordIterations=maxXcoordIterations),8<this.maxInitOrderingBuckets)throw"Too many ordering buckets: number of permutations ("+this.maxInitOrderingBuckets.toString()+"!) is too big";var timer=new Helpers.Timer;this.ranks=this.rank(baseG,suggestedRanks),this.maxRank=Math.max.apply(null,this.ranks),timer.printSinceLast("=== Ranking runtime: "),this.GG=baseG.makeGWithSplitMultiRankEdges(this.ranks);var disconnectedTwins=this.disconnectTwins();timer.restart(),this.order=this.ordering(this.maxInitOrderingBuckets,this.maxOrderingIterations,disconnectedTwins),timer.printSinceLast("=== Ordering runtime: "),this.reRankRelationships(),this.reconnectTwins(disconnectedTwins);var ancestors=this.findAllAncestors();this.ancestors=ancestors.ancestors,this.consangr=ancestors.consangr,timer.printSinceLast("=== Ancestors + re-ranking runtime: "),this.positions=this.position(),timer.printSinceLast("=== Positioning runtime: "),performVerticalPositioning&&(this.vertLevel=this.positionVertically(),this.rankY=this.computeRankY(),timer.printSinceLast("=== Vertical spacing runtime: "))},rank:function(baseG,suggestedRanks){if(suggestedRanks&&(ranks=this.init_rank(baseG,suggestedRanks)))return ranks;var ranks=this.init_rank(baseG);return this.lower_ranks(baseG,ranks),ranks},init_rank:function(baseG,suggestedRanks){if(0==baseG.v.length)return[];for(var ranks=[],numRankedParents=[],i=0;i<baseG.getNumVertices();i++)ranks.push(-1),numRankedParents.push(0);var queue=new Queue;if(suggestedRanks){for(i=0;i<suggestedRanks.length;i++)for(var nodesAtRank=suggestedRanks[i],j=0;j<nodesAtRank.length;j++)ranks[nodesAtRank[j]]=3*i+1;for(var v=0;v<baseG.getNumVertices();v++){if(baseG.isPerson(v)&&-1==ranks[v])return null;baseG.isRelationship(v)&&queue.push(v)}}else{var parentlessNodes=baseG.getLeafAndParentlessNodes().parentlessNodes;queue.setTo(parentlessNodes)}for(;0<queue.size();){var nextNode=queue.pop(),inEdges=baseG.getInEdges(nextNode),useRank=1;for(i=0;i<inEdges.length;i++){ranks[v=inEdges[i]]>=useRank&&(useRank=ranks[v]+1)}ranks[nextNode]=useRank;for(var outEdges=baseG.getOutEdges(nextNode),u=0;u<outEdges.length;u++){var vertex=outEdges[u];if(suggestedRanks&&-1!=ranks[vertex]&&ranks[vertex]<=ranks[nextNode])return null;numRankedParents[vertex]++;var numVertexInEdges=baseG.getInEdges(vertex).length;numRankedParents[vertex]==numVertexInEdges&&queue.push(vertex)}}return ranks},lower_ranks:function(baseG,ranks){if(!(ranks.length<=1)){for(console.log("Re-ranking ranks before: "+Helpers.stringifyObject(ranks));;){for(var nodeColor=[],component=[],minOutEdgeInfo=[],v=0;v<baseG.getNumVertices();v++)nodeColor.push(null);var currentComponentColor=0;for(v=0;v<baseG.getNumVertices();v++)if(null==nodeColor[v]){var thisComponent=[],potentialLongEdges={},queue=new Queue;for(queue.push(v);0<queue.size();){var nextV=queue.pop();if(null==nodeColor[nextV]){nodeColor[nextV]=currentComponentColor,thisComponent.push(nextV);var rankV=ranks[nextV],allEdges=baseG.getAllEdgesWithWeights(nextV);for(var vv in allEdges)if(allEdges.hasOwnProperty(vv)&&nodeColor[vv]!=currentComponentColor){var edgeLength=Math.abs(rankV-ranks[vv]);1==edgeLength?null==nodeColor[vv]&&queue.push(vv):allEdges[vv].out&&(potentialLongEdges[vv]={length:edgeLength,weight:allEdges[vv].weight})}}}for(var vv in component[currentComponentColor]=thisComponent,minOutEdgeInfo[currentComponentColor]={length:1/0,weight:0},potentialLongEdges)if(potentialLongEdges.hasOwnProperty(vv)){if(nodeColor[vv]==currentComponentColor)continue;var nextEdge=potentialLongEdges[vv];(nextEdge.length<minOutEdgeInfo[currentComponentColor].length||nextEdge.length==minOutEdgeInfo[currentComponentColor].length&&nextEdge.weight>minOutEdgeInfo[currentComponentColor].weight)&&(minOutEdgeInfo[currentComponentColor]=nextEdge)}currentComponentColor++}if(1==currentComponentColor)return;for(var minComponent=0,i=1;i<component.length;i++)(minOutEdgeInfo[i].weight>minOutEdgeInfo[minComponent].weight||minOutEdgeInfo[i].weight==minOutEdgeInfo[minComponent].weight&&minOutEdgeInfo[i].length<minOutEdgeInfo[minComponent].length)&&(minComponent=i);for(v=0;v<component[minComponent].length;v++)ranks[component[minComponent][v]]+=minOutEdgeInfo[minComponent].length-1}console.log("Ranks after re-ranking: "+Helpers.stringifyObject(ranks))}},ordering:function(maxInitOrderingBuckets,maxOrderingIterations,disconnectedTwins){if(0==this.GG.v.length)return new Ordering([],[]);var best=void 0,bestCrossings=1/0,leafAndRootlessInfo=this.GG.getLeafAndParentlessNodes(),rootlessPartners=this.findAllRootlessPartners(leafAndRootlessInfo);this.disconnectRootlessPartners(rootlessPartners);var leafSiblings=this.findLeafSiblings(leafAndRootlessInfo);this.disconnectLeafSiblings(leafSiblings);for(var permutationsRoots=this.computePossibleParentlessNodePermutations(maxInitOrderingBuckets,leafAndRootlessInfo,rootlessPartners),permutationsLeafs=this.computePossibleLeafNodePermutations(maxInitOrderingBuckets,leafAndRootlessInfo,leafSiblings,disconnectedTwins),initOrderIterTotal=0,useStack=!1,timer=new Helpers.Timer;;){for(var initOrderIter=0;initOrderIter<permutationsRoots.length;initOrderIter++){if(initOrderIterTotal++,order=this.init_order_top_to_bottom(permutationsRoots[initOrderIter],useStack),this.transpose(order,!1,4*bestCrossings+5),(numCrossings=this.edge_crossing(order))<bestCrossings&&(best=order.copy(),0==(bestCrossings=numCrossings)))break}if(0==bestCrossings)break;for(var initOrderIter2=0;initOrderIter2<permutationsLeafs.length;initOrderIter2++){if(initOrderIterTotal++,order=this.init_order_bottom_to_top(permutationsLeafs[initOrderIter2],useStack),this.transpose(order,!1,4*bestCrossings+5),(numCrossings=this.edge_crossing(order))<bestCrossings&&(best=order.copy(),0==(bestCrossings=numCrossings)))break}if(0==bestCrossings)break;if(useStack)break;useStack=!0}timer.printSinceLast("Initial ordering: ");var bestEdgeLengthScore=this.edge_length_score(best);console.log("Initial ordering: "+Helpers.stringifyObject(best.order)),console.log("Initial ordering:  numCrossings= "+bestCrossings+",  edhgeLengthScore= "+bestEdgeLengthScore);for(var noChangeIterations=0,order=best.copy(),i=0;i<maxOrderingIterations;i++){var changed=this.wmedian(order,i);this.transpose(order,!0);var numCrossings=this.edge_crossing(order),edgeLengthScore=this.edge_length_score(order);if(numCrossings<bestCrossings||numCrossings==bestCrossings&&edgeLengthScore<bestEdgeLengthScore)console.log("ordering: new better one selected ("+numCrossings+" crossings, "+edgeLengthScore+" edgeLengthScore)"),best=order.copy(),bestCrossings=numCrossings,bestEdgeLengthScore=edgeLengthScore,noChangeIterations=0;else if(changed||noChangeIterations++,6==noChangeIterations)break}this.transpose(best,!0),this.reconnectRootlessPartners(best,rootlessPartners),this.transpose(best,!0),this.reconnectLeafSiblings(best,leafSiblings),timer.restart();var newBestCrossings=this.transposeLongEdges(best,bestCrossings);return timer.printSinceLast("Ordering long edges: "),console.log("Ordering stats:  initOrderIter= "+initOrderIterTotal+",  reOrderingIter= "+i+",  noChangeIterations= "+noChangeIterations),console.log("Final ordering: "+Helpers.stringifyObject(best.order)),console.log("Final ordering:  numCrossings= "+newBestCrossings),best},findAllRootlessPartners:function(leafAndRootlessInfo){for(var rootlessPartners={},i=0;i<leafAndRootlessInfo.parentlessNodes.length;i++){var v=leafAndRootlessInfo.parentlessNodes[i];if(1==this.GG.getOutEdges(v).length){var relationShipNode=this.GG.downTheChainUntilNonVirtual(this.GG.getOutEdges(v)[0]),parents=this.GG.getParents(relationShipNode),otherParent=parents[0]==v?parents[1]:parents[0];if(this.ranks[v]!=this.ranks[otherParent])continue;0<this.GG.getInEdges(otherParent).length&&(rootlessPartners[otherParent]?rootlessPartners[otherParent].push(v):rootlessPartners[otherParent]=[v])}}return rootlessPartners},disconnectRootlessPartners:function(rootlessPartners){for(var p in rootlessPartners)if(rootlessPartners.hasOwnProperty(p))for(var rootless=rootlessPartners[p],i=0;i<rootless.length;i++){var v=rootless[i],relNode=this.GG.getOutEdges(v)[0];Helpers.removeFirstOccurrenceByValue(this.GG.inedges[relNode],v)}},reconnectRootlessPartners:function(order,rootlessPartners){for(var p in rootlessPartners)if(rootlessPartners.hasOwnProperty(p)){for(var partnersToTheLeft=0,partnersToTheRight=0,pOrder=order.vOrder[p],rank=this.ranks[p],pRelationships=this.GG.getOutEdges(p),j=0;j<pRelationships.length;j++)if(this.GG.isRelationship(pRelationships[j])){var parents=this.GG.getInEdges(pRelationships[j]);if(2==parents.length){var partner=parents[0]==p?parents[1]:parents[0];order.vOrder[partner]>pOrder?partnersToTheRight++:partnersToTheLeft++}}for(var rootless=rootlessPartners[p],i=0;i<rootless.length;i++){var v=rootless[i],relNode=this.GG.getOutEdges(v)[0];this.GG.inedges[relNode].push(v),partnersToTheRight<=partnersToTheLeft?(partnersToTheRight++,order.insert(rank,pOrder+1,v)):(partnersToTheLeft++,order.insert(rank,pOrder,v))}}},findLeafSiblings:function(leafAndRootlessInfo){for(var leafSiblings={},i=0;i<leafAndRootlessInfo.leafNodes.length;i++){var v=leafAndRootlessInfo.leafNodes[i],childHubNode=this.GG.getInEdges(v)[0];if(!leafSiblings.hasOwnProperty(childHubNode)){var children=this.GG.getOutEdges(childHubNode);if(1<children.length){leafSiblings[childHubNode]=[];for(var keepChild=v,j=0;j<children.length;j++){var child=children[j],outNum=this.GG.getOutEdges(child).length;child!=keepChild&&0==outNum&&leafSiblings[childHubNode].push(child)}}}}return leafSiblings},disconnectLeafSiblings:function(leafSiblings){for(var p in leafSiblings)if(leafSiblings.hasOwnProperty(p))for(var leaves=leafSiblings[p],i=0;i<leaves.length;i++){var l=leaves[i];Helpers.removeFirstOccurrenceByValue(this.GG.v[p],l)}},reconnectLeafSiblings:function(order,leafSiblings){for(var p in leafSiblings)if(leafSiblings.hasOwnProperty(p))for(var leaves=leafSiblings[p],i=0;i<leaves.length;i++){var l=leaves[i];this.GG.v[p].push(l);var rank=this.ranks[l];order.insert(rank,0,l);for(var bestO=0,bestCross=this.edge_crossing(order,rank),bestScore=this.edge_length_score(order,rank),o=0;o<order.order[rank].length-1;o++){order.exchange(rank,o,o+1);var newEdgeCrossings=this.edge_crossing(order,rank),newLengthScore=this.edge_length_score(order,rank);(newEdgeCrossings<bestCross||newEdgeCrossings==bestCross&&newLengthScore<bestScore)&&(bestO=o+1,bestCross=newEdgeCrossings,bestScore=newLengthScore)}order.moveVertexToOrder(rank,order.vOrder[l],bestO)}},disconnectTwins:function(){for(var disconnectedTwins={},handled={},v=0;v<=this.GG.getMaxRealVertexId();v++){if(!handled[v])if(this.GG.isPerson(v))if(null!=this.GG.getTwinGroupId(v)){disconnectedTwins[v]=[];for(var childhub=this.GG.getInEdges(v)[0],allTwins=this.GG.getAllTwinsOf(v),i=0;i<allTwins.length;i++){var twin=allTwins[i];if(twin!=v){Helpers.removeFirstOccurrenceByValue(this.GG.v[childhub],twin);for(var outEdges=this.GG.getOutEdges(twin),j=0;j<outEdges.length;j++){var rel=outEdges[j];Helpers.replaceInArray(this.GG.inedges[rel],twin,v),this.GG.v[v].push(rel),this.GG.weights[v].hasOwnProperty(rel)?this.GG.weights[v][rel]+=this.GG.weights[twin][rel]:this.GG.weights[v][rel]=this.GG.weights[twin][rel]}disconnectedTwins[v].push(twin),handled[twin]=!0}}}}return disconnectedTwins},reconnectTwins:function(disconnectedTwins){for(var v in disconnectedTwins)if(disconnectedTwins.hasOwnProperty(v)){var rank=this.ranks[v],childhub=this.GG.getInEdges(v)[0],allDisconnectedTwins=disconnectedTwins[v],GG=this.GG;allDisconnectedTwins.sort(function(a,b){var an=GG.getOutEdges(a).length;return GG.getOutEdges(b).length-an});for(var i=0;i<allDisconnectedTwins.length;i++){for(var twin=allDisconnectedTwins[i],outEdges=this.GG.getOutEdges(twin),j=0;j<outEdges.length;j++){var rel=outEdges[j];Helpers.removeFirstOccurrenceByValue(this.GG.inedges[rel],v),Helpers.removeFirstOccurrenceByValue(this.GG.v[v],rel),this.GG.weights[v][rel]==this.GG.weights[twin][rel]?delete this.GG.weights[v][rel]:this.GG.weights[v][rel]-=this.GG.weights[twin][rel],this.GG.inedges[rel].push(twin)}var insertOrder=this.findBestTwinInsertPosition(twin,this.GG.getOutEdges(twin),this.order);this.order.insert(rank,insertOrder,twin),this.GG.v[childhub].push(twin);var groupID=this.GG.getTwinGroupId(twin);for(outEdges=this.GG.getOutEdges(twin),j=0;j<outEdges.length;j++){rel=outEdges[j];if(!this.GG.isVirtual(rel)){var parents=this.GG.getInEdges(rel),otherParent=parents[0]==twin?parents[1]:parents[0];if(this.GG.getTwinGroupId(otherParent)==groupID&&this.GG.hasEdge(childhub,otherParent)){var orderRel=this.order.vOrder[rel],orderTwin1=this.order.vOrder[twin],orderTwin2=this.order.vOrder[otherParent];if(1!=Math.abs(orderTwin1-orderTwin2)){if(1==this.GG.getOutEdges(twin).length)orderTwin1<orderTwin2?this.order.moveVertexToOrder(rank,orderTwin1,orderTwin2):this.order.moveVertexToOrder(rank,orderTwin1,orderTwin2+1);else{if(1!=this.GG.getOutEdges(otherParent).length)continue;orderTwin2<orderTwin1?this.order.moveVertexToOrder(rank,orderTwin2,orderTwin1):this.order.moveVertexToOrder(rank,orderTwin2,orderTwin1+1)}orderRel=this.order.vOrder[rel],orderTwin1=this.order.vOrder[twin],orderTwin2=this.order.vOrder[otherParent]}orderTwin1<orderTwin2?this.order.moveVertexToOrder(rank,orderRel,orderTwin2):this.order.moveVertexToOrder(rank,orderRel,orderTwin1)}}}}}},computePossibleParentlessNodePermutations:function(maxInitOrderingBuckets,leafAndRootlessInfo,rootlessPartners){var buckets=[];console.log("maxInitOrderingBuckets: "+maxInitOrderingBuckets);var handled={};for(var p in rootlessPartners)if(rootlessPartners.hasOwnProperty(p))for(var rootless=rootlessPartners[p],i=0;i<rootless.length;i++)handled[rootless[i]]=!0;for(i=0;i<leafAndRootlessInfo.parentlessNodes.length;i++){var v=leafAndRootlessInfo.parentlessNodes[i];if(!handled.hasOwnProperty(v)){var nextBucket=[];if(nextBucket.push(v),handled[v]=!0,1==this.GG.getOutEdges(v).length){var rel=this.GG.downTheChainUntilNonVirtual(this.GG.getOutEdges(v)[0]),parents=this.GG.getParents(rel),otherPartner=parents[0]==v?parents[1]:parents[0];handled.hasOwnProperty(otherPartner)||0!=this.GG.getInEdges(otherPartner).length||1!=this.GG.getOutEdges(otherPartner).length||(nextBucket.push(otherPartner),handled[otherPartner]=!0)}buckets.push(nextBucket)}}buckets.length>maxInitOrderingBuckets&&this.mergeBucketsUntilNoMoreThanGivenLeft(buckets,maxInitOrderingBuckets);var permutations=[];return Helpers.permute2DArrayInFirstDimension(permutations,buckets,0),Helpers.printObject(buckets),console.log("Found "+permutations.length+" permutations of parentless nodes"),permutations},computePossibleLeafNodePermutations:function(maxInitOrderingBuckets,leafAndRootlessInfo,leafSiblings,disconnectedTwins){var buckets=[],handled={};for(var p in leafSiblings)if(leafSiblings.hasOwnProperty(p))for(var leaves=leafSiblings[p],i=0;i<leaves.length;i++)handled[leaves[i]]=!0;for(var p in disconnectedTwins)if(disconnectedTwins.hasOwnProperty(p)){var twins=disconnectedTwins[p];for(i=0;i<twins.length;i++)handled[twins[i]]=!0}var nextBucket=0;for(i=0;i<leafAndRootlessInfo.leafNodes.length;i++){var v=leafAndRootlessInfo.leafNodes[i];if(!handled.hasOwnProperty(v)){if((nextBucket=[]).push(v),handled[v]=!0,1!=this.GG.getInEdges(v).length)throw"Assertion failed: only one in edge into a leaf node";for(var childhubNode=this.GG.getInEdges(v)[0],j=i+1;j<leafAndRootlessInfo.leafNodes.length;j++){var u=leafAndRootlessInfo.leafNodes[j];if(!handled.hasOwnProperty(u))childhubNode==this.GG.getInEdges(u)[0]&&(nextBucket.push(u),handled[u]=!0)}buckets.push(nextBucket)}}buckets.length>maxInitOrderingBuckets&&this.mergeBucketsUntilNoMoreThanGivenLeft(buckets,maxInitOrderingBuckets,!0);var permutations=[];return Helpers.permute2DArrayInFirstDimension(permutations,buckets,0),Helpers.printObject(buckets),console.log("Found "+permutations.length+" permutations of leaf nodes"),permutations},mergeBucketsUntilNoMoreThanGivenLeft:function(buckets,maxInitOrderingBuckets,useInEdges){for(console.log("original buckets: "+Helpers.stringifyObject(buckets));buckets.length>maxInitOrderingBuckets&&this.mergeMostRelatedBuckets(buckets,useInEdges););console.log("merged buckets: "+Helpers.stringifyObject(buckets))},mergeMostRelatedBuckets:function(buckets,useInEdges){for(var minDistance=1/0,bucket1=0,bucket2=1,i=0;i<buckets.length-1;i++)for(var j=i+1;j<buckets.length;j++){var dist=this.findDistanceBetweenBuckets(buckets[i],buckets[j],useInEdges);(dist<minDistance||dist==minDistance&&buckets[i].length+buckets[j].length<buckets[bucket1].length+buckets[bucket2].length)&&(minDistance=dist,bucket1=i,bucket2=j)}if(minDistance==1/0)throw"Assumption failed: unrelated buckets";for(i=0;i<buckets[bucket2].length;i++)buckets[bucket1].push(buckets[bucket2][i]);return buckets.splice(bucket2,1),!0},findDistanceBetweenBuckets:function(bucket1nodes,bucket2nodes,useInEdges){for(var distance=[],i=0;i<bucket1nodes.length;i++)distance[bucket1nodes[i]]=1;for(i=0;i<bucket2nodes.length;i++)distance[bucket2nodes[i]]=-1;var queue1=new Queue;queue1.setTo(bucket1nodes);var queue2=new Queue;queue2.setTo(bucket2nodes);for(var iter=0;iter<100;){if(iter++,0==queue1.size()&&0==queue2.size())return 1/0;for(var nextQueue1=new Queue;0<queue1.size();)for(var dist=distance[nextNode=queue1.pop()],edges=useInEdges?this.GG.getInEdges(nextNode):this.GG.getOutEdges(nextNode),j=0;j<edges.length;j++){if(distance[nextV=edges[j]]<0)return-distance[nextV]+dist;distance[nextV]=dist+1,nextQueue1.push(nextV)}queue1=nextQueue1;for(var nextQueue2=new Queue;0<queue2.size();){var nextNode;for(dist=distance[nextNode=queue2.pop()],edges=useInEdges?this.GG.getInEdges(nextNode):this.GG.getOutEdges(nextNode),j=0;j<edges.length;j++){var nextV;if(0<distance[nextV=edges[j]])return distance[nextV]-dist;distance[nextV]=dist-1,nextQueue2.push(nextV)}}queue2=nextQueue2}throw"Assertion failed: possible loop detected"},init_order_top_to_bottom:function(parentlessNodes,useStack){for(var order=[],vOrder=[],r=0;r<=this.maxRank;r++)order[r]=[];for(var i=0;i<this.GG.getNumVertices();i++)vOrder[i]=void 0;var queue=useStack?new Stack:new Queue;for(queue.setTo(parentlessNodes);0<queue.size();){var next=queue.pop();if(null==vOrder[next]){var rank=this.ranks[next],nextOrder=order[rank].length;vOrder[next]=nextOrder,order[rank].push(next);for(var outEdges=this.GG.getOutEdges(next),u=0;u<outEdges.length;u++)queue.push(outEdges[u])}}return new Ordering(order,vOrder)},init_order_bottom_to_top:function(leafNodes,useStack){for(var order=[],vOrder=[],r=0;r<=this.maxRank;r++)order[r]=[];for(var i=0;i<this.GG.getNumVertices();i++)vOrder[i]=void 0;var queue=useStack?new Stack:new Queue;for(queue.setTo(leafNodes);0<queue.size();){var next=queue.pop();if(null==vOrder[next]){var rank=this.ranks[next],nextOrder=order[rank].length;vOrder[next]=nextOrder,order[rank].push(next);for(var inEdges=this.GG.getInEdges(next),u=0;u<inEdges.length;u++)queue.push(inEdges[u])}}return new Ordering(order,vOrder)},edge_length_score:function(order,onlyRank){for(var totalEdgeLengthInPositions=0,totalEdgeLengthInChildren=0,totalPenaltyForFatherOnRight=0,totalPenaltyForChildAgeOrder=0,i=0;i<this.GG.getNumVertices();i++){if(onlyRank){var rank=this.ranks[i];if(rank<onlyRank-1||onlyRank+1<rank)continue}if(this.GG.isRelationship(i)){var parents=this.GG.getInEdges(i);if(2==parents.length){if(this.ranks[parents[0]]!=this.ranks[parents[1]])continue;var order1=order.vOrder[parents[0]],order2=order.vOrder[parents[1]];totalEdgeLengthInPositions+=Math.abs(order1-order2);var leftParent=order1<order2?parents[0]:parents[1];"F"==this.GG.properties[leftParent].gender&&totalPenaltyForFatherOnRight++}}if(this.GG.isChildhub(i)){var children=this.GG.getOutEdges(i);if(1<children.length){var orderedChildren=order.sortByOrder(children),minOrder=order.vOrder[orderedChildren[0]];totalEdgeLengthInChildren+=order.vOrder[orderedChildren[orderedChildren.length-1]]-minOrder;for(var leftChildDOB=this.GG.properties[orderedChildren[0]].hasOwnProperty("dob")?new PedigreeDate(this.GG.properties[orderedChildren[0]].dob):null,j=1;j<orderedChildren.length;j++){var thisChildDOB=this.GG.properties[orderedChildren[j]].hasOwnProperty("dob")?new PedigreeDate(this.GG.properties[orderedChildren[j]].dob):null;null!=thisChildDOB&&(null==leftChildDOB?totalPenaltyForChildAgeOrder++:leftChildDOB.getTime()>thisChildDOB.getTime()&&totalPenaltyForChildAgeOrder++),leftChildDOB=thisChildDOB}}}}return 1e5*totalEdgeLengthInPositions+1e3*totalEdgeLengthInChildren+5*totalPenaltyForFatherOnRight+totalPenaltyForChildAgeOrder},edge_crossing:function(order,onlyRank,dontUseApproximationForRelationshipEdges){for(var numCrossings=0,rankFrom=onlyRank?Math.max(1,onlyRank-1):1,rankTo=onlyRank||this.maxRank,r=rankFrom;r<=rankTo;++r)for(var numVert=order.order[r].length,i=0;i<numVert-1;++i)for(var v=order.order[r][i],isChhub=this.GG.isChildhub(v),outEdges=this.GG.getOutEdges(v),len=outEdges.length,j=0;j<len;++j){var targetV=outEdges[j];if(!dontUseApproximationForRelationshipEdges&&this.GG.isRelationship(targetV)){var parents=this.GG.getInEdges(targetV);if(2==parents.length){var order1=order.vOrder[parents[0]],order2=order.vOrder[parents[1]];numCrossings+=this.numNodesWithParentsInBetween(order,r,order1,order2)/2}}numCrossings+=this._edge_crossing_crossingsByOneEdge(order,v,targetV)*(isChhub&&null!=this.GG.getTwinGroupId(targetV)?2:1)}return numCrossings},_edge_crossing_crossingsByOneEdge:function(order,v,targetV){var rankV=this.ranks[v],rankT=this.ranks[targetV],orderV=order.vOrder[v],orderT=order.vOrder[targetV];if(rankV==rankT)return this.numNodesWithParentsInBetween(order,rankV,orderV,orderT);for(var crossings=0,verticesAtRankV=order.order[rankV],ord=orderV+1;ord<verticesAtRankV.length;++ord)for(var vertex=verticesAtRankV[ord],isChhub=this.GG.isChildhub(vertex),outEdges=this.GG.getOutEdges(vertex),len=outEdges.length,j=0;j<len;++j){var target=outEdges[j];order.vOrder[target]<orderT&&(crossings++,isChhub&&null!=this.GG.getTwinGroupId(target)&&crossings++)}return 0<crossings&&this.GG.isPerson(v)&&this.GG.isVirtual(targetV)&&(crossings-=.1),crossings},numNodesWithParentsInBetween:function(order,rank,order1,order2){for(var numNodes=0,fromBetween=Math.min(order1,order2)+1,toBetween=Math.max(order1,order2)-1,o=fromBetween;o<=toBetween;o++){var b=order.order[rank][o];if(0<this.GG.getInEdges(b).length)for(var i=0;i<this.GG.getInEdges(b).length;i++){var u=this.GG.getInEdges(b)[i];if(this.ranks[u]!=rank)numNodes++;else{var orderOther=order.vOrder[u];(orderOther<fromBetween-1||toBetween+1<orderOther)&&numNodes++}}if(this.GG.isPerson(b))null!=this.GG.getTwinGroupId(b)&&numNodes++}return numNodes},wmedian:function(order,iter){if(iter%2==0){for(var r=2;r<=this.maxRank;r++)if(!(order.order[r].length<=1||order.order[r-1].length<=1)){for(var median=[],len=order.order[r].length,i=0;i<len;i++){median[v=order.order[r][i]]=this.median_value(order,v,r-1)}this.sort_orders(order,r,median)}}else for(r=this.maxRank-1;1<=r;r--)if(!(order.order[r].length<=1||order.order[r+1].length<=1)){for(median=[],len=order.order[r].length,i=0;i<len;i++){var v;median[v=order.order[r][i]]=this.median_value(order,v,r+1)}this.sort_orders(order,r,median)}return!1},median_value:function(order,v,adj_rank){var P=this.adj_position(order,v,adj_rank);if(0==P.length)return-1;var m=Math.floor(P.length/2);if(P.length%2==1)return P[m];if(2==P.length)return(P[0]+P[1])/2;var left=P[m-1]-P[0],right=P[P.length-1]-P[m];return(P[m-1]*right+P[m]*left)/(left+right)},adj_position:function(order,v,adj_rank){for(var result=[],verticesAtRankAdj=order.order[adj_rank],len=verticesAtRankAdj.length,j=0;j<len;j++){var adjV=verticesAtRankAdj[j];(this.GG.hasEdge(adjV,v)||this.GG.hasEdge(v,adjV))&&result.push(j)}return result},sort_orders:function(order,rank,weightToUseForThisRank){order.order[rank].sort(function(a,b){return weightToUseForThisRank[a]-weightToUseForThisRank[b]});for(var changed=!1,i=0;i<order.order[rank].length;i++){var v=order.order[rank][i];order.vOrder[v]!=i&&(order.vOrder[v]=i,changed=!0)}return changed},isChhubsOrderOK:function(rank,order){for(var i=0;i<order.order[rank].length-1;i++){var v=order.order[rank][i];if(this.GG.isChildhub(v)){for(var next=i+1;next<order.order[rank].length&&!this.GG.isChildhub(order.order[rank][next]);next++);var u=order.order[rank][next];if(this.GG.isChildhub(u)){var aboveV=this.GG.getInEdges(v)[0],aboveU=this.GG.getInEdges(u)[0];if(order.vOrder[aboveV]>order.vOrder[aboveU])return!1}}}return!0},placeChhubsInCorrectOrder:function(rank,order){var GG=this.GG;order.order[rank].sort(function(a,b){var above1=GG.getInEdges(a)[0],above2=GG.getInEdges(b)[0];return above1==above2?order.vOrder[a]-order.vOrder[b]:order.vOrder[above1]-order.vOrder[above2]});for(var i=0;i<order.order[rank].length;i++)order.vOrder[order.order[rank][i]]=i},transpose:function(order,doMinorImprovements,stopIfMoreThanCrossings){var improved=!0,totalEdgeCrossings=this.edge_crossing(order);if(!(stopIfMoreThanCrossings&&stopIfMoreThanCrossings<totalEdgeCrossings))for(var iter=0;improved&&(iter++,doMinorImprovements||!(4<iter));){if(100<iter){console.log("Assertion failed: too many iterations in transpose(), NumIter == "+iter);break}improved=!1;for(var r=1;r<=this.maxRank;r++)if(r%3!=0){var numEdgeCrossings=this.edge_crossing(order,r);if(doMinorImprovements||0!=numEdgeCrossings){for(var edgeLengthScore=doMinorImprovements?this.edge_length_score(order,r):0,rankImproved=!1,maxIndex=order.order[r].length-1,i=0;i<maxIndex;++i){order.exchange(r,i,i+1);var newEdgeCrossings=this.edge_crossing(order,r),newLengthScore=doMinorImprovements?this.edge_length_score(order,r):0;if(newEdgeCrossings<numEdgeCrossings||newEdgeCrossings==numEdgeCrossings&&newLengthScore<edgeLengthScore){if(rankImproved=improved=!0,totalEdgeCrossings-=numEdgeCrossings-newEdgeCrossings,numEdgeCrossings=newEdgeCrossings,edgeLengthScore=newLengthScore,!doMinorImprovements){if(0==totalEdgeCrossings)return;if(0==numEdgeCrossings)break}}else order.exchange(r,i,i+1)}rankImproved&&r--}}else this.placeChhubsInCorrectOrder(r,order)}},transposeLongEdges:function(order,numCrossings,postReRanking){if(0==numCrossings)return numCrossings;for(var maxRealId=this.GG.getMaxRealVertexId(),numVert=this.GG.getNumVertices(),checked=[],v=maxRealId+1;v<numVert;v++)checked[v]=!1;for(v=maxRealId+1;v<numVert;v++)if(!checked[v]&&0!=this.ranks[v]){for(var head=v;this.GG.isVirtual(this.GG.getInEdges(head)[0]);)head=this.GG.getInEdges(head)[0];for(var chain=[],next=head;checked[next]=!0,chain.push(next),next=this.GG.getOutEdges(next)[0],this.GG.isVirtual(next););chain.push(next);var bestScore=numCrossings,bestOrder=void 0;if(console.log("Optimizing long edge placement: chain "+Helpers.stringifyObject(chain)),chain.length<=10){var beforeChainEnd=2;postReRanking&&(beforeChainEnd=4);for(var i=0;i<chain.length-beforeChainEnd;i++)for(var piece1=chain[i],piece2=chain[i+1],piece3=chain[i+2],rank1=this.ranks[piece1],rank2=this.ranks[piece2],rank3=this.ranks[piece3],ord1=order.vOrder[piece1],ord2=order.vOrder[piece2],ord3=order.vOrder[piece3],move1=-4;move1<=4;move1++)if(order.canMove(rank1,ord1,move1))for(var move2=-4;move2<=4;move2++)if(order.canMove(rank2,ord2,move2))for(var move3=-4;move3<=4;move3++)if((0!=move1||0!=move2||0!=move3)&&order.canMove(rank3,ord3,move3)){var newOrder=order.copy();newOrder.move(rank1,ord1,move1),newOrder.move(rank2,ord2,move2),newOrder.move(rank3,ord3,move3);var newCross=this.edge_crossing(newOrder,!1,postReRanking);newCross<bestScore&&(bestScore=newCross,bestOrder=[rank1,ord1,move1,rank2,ord2,move2,rank3,ord3,move3])}}if(bestScore<numCrossings&&(order.move(bestOrder[0],bestOrder[1],bestOrder[2]),order.move(bestOrder[3],bestOrder[4],bestOrder[5]),order.move(bestOrder[6],bestOrder[7],bestOrder[8]),numCrossings=bestScore),0==numCrossings)break}return numCrossings},reRankRelationships:function(){if(void 0!==this.maxRank&&0!=this.GG.v.length){for(var handled={},initialOrdering=this.order.copy(),r=2;r<=this.maxRank;r+=3){for(var oo=0;oo<initialOrdering.order[r].length;oo++){var i=initialOrdering.order[r][oo];if(!this.GG.isVirtual(i)){if(!this.GG.isRelationship(i))throw"[1] Unexpected node "+i+" at rank "+r;var parents=this.GG.getInEdges(i);if(this.ranks[parent[0]]!=this.ranks[parent[1]])throw"Assertion failed: edges betwen neighbouring ranks only";var order1=this.order.vOrder[parents[0]],order2=this.order.vOrder[parents[1]],minOrder=Math.min(order1,order2),maxOrder=Math.max(order1,order2);maxOrder==minOrder+1&&(this.moveVertexToRankAndOrder(i,this.ranks[parents[0]],maxOrder),handled[i]=!0)}}for(oo=0;oo<initialOrdering.order[r].length;oo++){i=initialOrdering.order[r][oo];if(!this.GG.isVirtual(i)){if(!this.GG.isRelationship(i))throw"[2] Unexpected node "+i+" at rank "+r;if(!handled.hasOwnProperty(i)){parents=this.GG.getInEdges(i);this.order.vOrder[parents[0]]>this.order.vOrder[parents[1]]&&parents.reverse();var rank=this.ranks[parents[0]];order1=this.order.vOrder[parents[0]];if((order2=this.order.vOrder[parents[1]])==order1+1)throw"Assertion failed: all relationship with parents next to each other are already handled (for parents: "+Helpers.stringifyObject(parents)+")";var insertOrder=order1+1,rightOfParent0=this.order.order[rank][order1+1],leftOfParent1=this.order.order[rank][order2-1],p0busy=!1,p1busy=!1;if(this.GG.hasEdge(parents[0],rightOfParent0)&&(p0busy=!0),this.GG.hasEdge(parents[1],leftOfParent1)&&(p1busy=!0),p1busy&&p0busy){for(var o=order1+2;o<=order2-1;o++){var next=this.order.order[rank][o];if(!this.GG.hasEdge(parents[0],next)){insertOrder=o;break}}if(null==insertOrder){var parentsOfLeft=this.GG.getInEdges(leftOfParent1),otherP1=parentsOfLeft[0]!=parents[1]?parentsOfLeft[0]:parentsOfLeft[1];insertOrder=this.order.vOrder[otherP1]<order1?order2:order1+1}}else insertOrder=p1busy?order1+1:order2;this.moveVertexToRankAndOrder(i,rank,insertOrder);var oldOrder=initialOrdering.vOrder[i];if(0<oldOrder){var oldNeighbourLeft=initialOrdering.order[r][oldOrder-1];if(this.GG.isRelationship(oldNeighbourLeft)&&this.order.vOrder[oldNeighbourLeft]>this.order.vOrder[i]&&this.ranks[oldNeighbourLeft]==this.ranks[i]){this.swapChildrenIfAllAToTheLeftOfB(oldNeighbourLeft,i);var chHubL=this.GG.getOutEdges(oldNeighbourLeft)[0],chHubR=this.GG.getOutEdges(i)[0];this.order.vOrder[chHubL]<this.order.vOrder[chHubR]&&this.order.exchange(this.ranks[chHubL],this.order.vOrder[chHubL],this.order.vOrder[chHubR])}}if(oldOrder<initialOrdering.order[rank+1].length-1){var oldNeighbourRight=initialOrdering.order[r][oldOrder+1];if(this.GG.isRelationship(oldNeighbourRight)&&this.order.vOrder[oldNeighbourRight]<this.order.vOrder[i]&&this.ranks[oldNeighbourRight]==this.ranks[i]){this.swapChildrenIfAllAToTheLeftOfB(i,oldNeighbourRight);chHubL=this.GG.getOutEdges(i)[0],chHubR=this.GG.getOutEdges(oldNeighbourRight)[0];this.order.vOrder[chHubL]<this.order.vOrder[chHubR]&&this.order.exchange(this.ranks[chHubL],this.order.vOrder[chHubL],this.order.vOrder[chHubR])}}}}}}this.removeRelationshipRanks(),this.improveOrdering();var edgeCrossings=this.edge_crossing(this.order,!1,!0);this.transposeLongEdges(this.order,edgeCrossings,!0),console.log("Final re-ordering: "+Helpers.stringifyObject(this.order.order)),console.log("Final ranks: "+Helpers.stringifyObject(this.ranks))}},moveVertexToRankAndOrder:function(v,newRank,newOrder){var oldRank=this.ranks[v],oldOrder=this.order.vOrder[v];this.order.moveVertexToRankAndOrder(oldRank,oldOrder,newRank,newOrder),this.ranks[v]=newRank},swapChildrenIfAllAToTheLeftOfB:function(leftRel,rightRel){console.log("Attempting to swap children of "+leftRel+" and "+rightRel+" (due to change of order during re-ranking)");var chHubL=this.GG.getOutEdges(leftRel)[0],chHubR=this.GG.getOutEdges(rightRel)[0],childrenL=this.GG.getOutEdges(chHubL),childrenR=this.GG.getOutEdges(chHubR),allChildren=childrenL.concat(childrenR),order=this.order;allChildren.sort(function(a,b){return order.vOrder[a]-order.vOrder[b]});var childRank=this.ranks[allChildren[0]],leftMostOrder=order.vOrder[allChildren[0]],rightMostOrder=order.vOrder[allChildren[allChildren.length-1]];if(rightMostOrder-leftMostOrder+1==childrenL.length+childrenR.length){for(var i=0;i<allChildren.length;i++){var nextInOrder=allChildren[i],shouldBeLeftRelChild=i<childrenL.length;if(shouldBeLeftRelChild&&this.GG.getInEdges(nextInOrder)[0]!=chHubL)return;var outEdges=this.GG.getOutEdges(nextInOrder);if(0<outEdges.length)for(var j=0;j<outEdges.length;j++){var rel=outEdges[j];if(this.GG.isVirtual(rel))return;for(var parents=this.GG.getParents(rel),k=0;k<parents.length;k++){if(this.ranks[parents[k]]!=childRank)return;if(shouldBeLeftRelChild&&order.vOrder[parents[k]]<leftMostOrder)return;if(!shouldBeLeftRelChild&&order.vOrder[parents[k]]>rightMostOrder)return}}}var middle=Math.floor((leftMostOrder+rightMostOrder)/2);for(i=leftMostOrder;i<=middle;i++){var tmp=this.order.order[childRank][i];this.order.order[childRank][i]=this.order.order[childRank][leftMostOrder+rightMostOrder-i],this.order.order[childRank][leftMostOrder+rightMostOrder-i]=tmp,this.order.vOrder[this.order.order[childRank][i]]=i,this.order.vOrder[this.order.order[childRank][leftMostOrder+rightMostOrder-i]]=leftMostOrder+rightMostOrder-i}}},removeRelationshipRanks:function(){for(var r=2;r<=this.maxRank;r+=2){if(0<this.order.order[r].length)for(var i=0;i<this.order.order[r].length;i++){var v=this.order.order[r][i];this.GG.unplugVirtualVertex(v),this.ranks[v]=0,this.order.vOrder[v]=this.order.order[0].length,this.order.order[0].push(v)}this.order.order.splice(r,1);for(v=0;v<this.ranks.length;v++)this.ranks[v]>r&&this.ranks[v]--;this.maxRank--}var unplugged=this.order.removeUnplugged().sort(function(a,b){return a-b});console.log("Removing unnecessary long edge pieces: "+Helpers.stringifyObject(unplugged));for(i=0;i<unplugged.length;i++){var removedID=unplugged[i]-i;this.ranks.splice(removedID,1),this.GG.remove(removedID)}},improveOrdering:function(){for(var r=1;r<=this.maxRank;r+=1)for(var oo=0;oo<this.order.order[r].length;oo++){var v=this.order.order[r][oo];if(this.GG.isPerson(v)&&0==this.GG.getInEdges(v).length){var relationships=this.GG.getOutEdges(v);if(1==relationships.length){var rel=relationships[0];if(this.ranks[rel]==r){var orderV=this.order.vOrder[v],orderRel=this.order.vOrder[rel];1!=Math.abs(orderRel-orderV)&&(orderV<orderRel?this.order.move(r,orderV,orderRel-orderV-1):this.order.move(r,orderV,orderRel-orderV+1))}}}}for(r=2;r<=this.maxRank;r+=2)this.isChhubsOrderOK(r,this.order)||this.placeChhubsInCorrectOrder(r,this.order)},findConnectedComponent:function(v,edgeIncludedFunc,stopSet,maxSize){var component={},size=0,stopFound=!1;"[object Array]"!==Object.prototype.toString.call(v)&&(v=[v]);for(var q=new Queue,i=0;i<v.length;i++)q.push(v[i]),component[v[i]]=!0;for(;0<q.size();){var nextV=q.pop(),allConnected=this.GG.getAllEdgesWithWeights(nextV);for(var u in allConnected)if(allConnected.hasOwnProperty(u)){if(edgeIncludedFunc(allConnected[u].out?nextV:u,allConnected[u].out?u:nextV)&&!component.hasOwnProperty(u)&&(component[u]=!0,q.push(u),size++,stopSet.hasOwnProperty(u))){stopFound=!0;break}if(maxSize<size){q.clear();break}}}return{component:component,size:size,stopSetReached:stopFound}},findAllAncestors:function(){for(var ancestors={},consangr={},r=1;r<=this.maxRank;r++)for(var nextRank=this.order.order[r],i=0;i<nextRank.length;i++){var v=this.order.order[r][i];if(this.GG.isPerson(v)&&(ancestors[v]={},ancestors[v][v]=0,!this.GG.isAdoptedIn(v)))for(var parents=this.GG.getParents(v),j=0;j<parents.length;j++){var familyBranch=ancestors[parents[j]];for(var u in familyBranch)familyBranch.hasOwnProperty(u)&&(ancestors[v].hasOwnProperty(u)?ancestors[v][u]=Math.min(familyBranch[u]+1,ancestors[v][u]):ancestors[v][u]=familyBranch[u]+1)}}for(r=1;r<=this.maxRank;r++)for(nextRank=this.order.order[r],i=0;i<nextRank.length;i++){v=this.order.order[r][i];if(this.GG.isRelationship(v)){ancestors[v]={},ancestors[v][v]=0;for(parents=this.GG.getParents(v),j=0;j<parents.length;j++){familyBranch=ancestors[parents[j]];for(var u in familyBranch)familyBranch.hasOwnProperty(u)&&(ancestors[v].hasOwnProperty(u)?(consangr[v]=!0,ancestors[v][u]=Math.min(familyBranch[u]+1,ancestors[v][u])):ancestors[v][u]=familyBranch[u]+1)}}}return{ancestors:ancestors,consangr:consangr}},positionVertically:function(){for(var verticalLevels=new VerticalLevels,r=1;r<=this.maxRank;r+=1)verticalLevels.rankVerticalLevels[r]=1;if(this.GG.v.length<=1)return verticalLevels;for(r=2;r<=this.maxRank;r+=2){for(var initLevels=[],edgeInfo=[],len=this.order.order[r].length,i=0;i<len;i++){var v=this.order.order[r][i];if(!this.GG.isVirtual(v)){if(!this.GG.isChildhub(v))throw"Assertion failed: childhub nodes at every other rank ("+v+")";for(var realationship=this.GG.getInEdges(v)[0],top_x=this.positions[realationship],left_x=top_x,right_x=top_x,childCoords=[],outEdges=this.GG.getOutEdges(v),j=0;j<outEdges.length;j++){var child_x=this.positions[outEdges[j]];childCoords.push(child_x),left_x=Math.min(left_x,child_x),right_x=Math.max(right_x,child_x)}if(left_x==right_x)verticalLevels.childEdgeLevel[v]=0;else{var needTopmost=1==outEdges.length&&(0==this.order.vOrder[outEdges[0]]&&top_x>this.positions[outEdges[0]]||this.order.vOrder[outEdges[0]]==this.order.vOrder.length-1&&top_x<this.positions[outEdges[0]]);edgeInfo.push({childhub:v,top_x:top_x,left_x:left_x,right_x:right_x,childCoords:childCoords,needTopmost:needTopmost}),initLevels.push(1)}}}var pairScoreFunc=function(edge1,edge2,edge1level,edge2level){if(edgeInfo[edge1].right_x<edgeInfo[edge2].left_x||edgeInfo[edge1].left_x>edgeInfo[edge2].right_x)return 0;if(edge1level==edge2level)return 1/0;if(edge2level<edge1level){var tmpEdge=edge1,tmpLevel=edge1level;edge1=edge2,edge1level=edge2level,edge2=tmpEdge,edge2level=tmpLevel}var intersections=0;edgeInfo[edge2].top_x>=edgeInfo[edge1].left_x&&edgeInfo[edge2].top_x<=edgeInfo[edge1].right_x&&intersections++;for(var j=0;j<edgeInfo[edge1].childCoords.length;j++){var childX=edgeInfo[edge1].childCoords[j];childX>=edgeInfo[edge2].left_x&&childX<=edgeInfo[edge2].right_x&&intersections++}return edgeInfo[edge2].needTopmost?intersections+.1:intersections},edgeLevels=new VerticalPosIntOptimizer(pairScoreFunc,initLevels).computeVerticalPositions(5,600);for(v=0;v<edgeInfo.length;v++)verticalLevels.childEdgeLevel[edgeInfo[v].childhub]=edgeLevels[v],edgeLevels[v]>verticalLevels.rankVerticalLevels[r]&&(verticalLevels.rankVerticalLevels[r]=edgeLevels[v])}for(r=1;r<=this.maxRank;r++){var numLevels=1,relEdges=(initLevels=[],edgeInfo=[],{});for(len=this.order.order[r].length,i=0;i<len;i++){v=this.order.order[r][i];if(this.GG.isPerson(v)){if((outEdges=this.GG.getOutEdges(v)).length<=0)continue;var v_x=this.positions[v];verticalLevels.outEdgeVerticalLevel[v]={};var vOrder=this.order.vOrder,positionEdgesOnOneSide=function(edges){for(var nextAttachPort=0,nextVerticalLevel=0,k=0;k<edges.length;k++){for(var u=this.GG.downTheChainUntilNonVirtual(edges[k]),dest=edges[k],minOrder=Math.min(vOrder[dest],vOrder[v])+1,maxOrder=Math.max(vOrder[dest],vOrder[v]),minLevel=minOrder==maxOrder?0:1,otherVirtualEdge=!1,goesOver=[],o=minOrder;o<maxOrder;o++){var w=this.order.order[r][o];this.GG.isPlaceholder(w)||(this.GG.isRelationship(w)&&(minLevel=Math.max(minLevel,2)),this.GG.isPerson(w)&&(minLevel=Math.max(minLevel,3)),this.GG.isVirtual(w)&&this.GG.getInEdges(w)[0]!=v&&(otherVirtualEdge=!0),goesOver.push(w))}if(nextVerticalLevel=Math.max(nextVerticalLevel,minLevel),verticalLevels.outEdgeVerticalLevel[v][u]={attachlevel:nextAttachPort,verticalLevel:nextVerticalLevel,numAttachLevels:edges.length},2<=minLevel||1==minLevel&&otherVirtualEdge){var left_x=Math.min(v_x,this.positions[dest]),right_x=Math.max(v_x,this.positions[dest]),down_x=this.positions[dest],top_x=1/0;if(dest==u){var parents=this.GG.getInEdges(u),otherParent=parents[0]==v?parents[1]:parents[0];this.GG.isVirtual(otherParent)&&(right_x<(top_x=this.positions[otherParent])&&(right_x=top_x),top_x<left_x&&(left_x=top_x))}edgeInfo.push({v:v,u:u,v_x:v_x,left_x:left_x,right_x:right_x,down_x:down_x,top_x:top_x,over:goesOver}),initLevels.push(nextVerticalLevel),relEdges.hasOwnProperty(u)||(relEdges[u]=[]),relEdges[u].push(edgeInfo.length-1)}nextAttachPort++,nextVerticalLevel++}return nextVerticalLevel-1}.bind(this),partnerInfo=this._findLeftAndRightPartners(v),maxLeftLevel=positionEdgesOnOneSide(partnerInfo.leftPartners),maxRightLevel=positionEdgesOnOneSide(partnerInfo.rightPartners);numLevels=Math.max(numLevels,Math.max(maxLeftLevel,maxRightLevel))}}if(1<edgeInfo.length){for(var e=0;e<edgeInfo.length;e++)if(!edgeInfo[e].hasOwnProperty("edgeComplement")){var nextRel=edgeInfo[e].u,nextEdges=relEdges[nextRel];if(1<nextEdges.length){var otherEdge=nextEdges[0]==e?nextEdges[1]:nextEdges[0];edgeInfo[e].edgeComplement=otherEdge,edgeInfo[otherEdge].edgeComplement=e}}pairScoreFunc=function(edge1,edge2,edge1level,edge2level,levels){if(edgeInfo[edge1].right_x<=edgeInfo[edge2].left_x||edgeInfo[edge1].left_x>=edgeInfo[edge2].right_x)return 0;if(edge1level==edge2level)return 1/0;if(edge1level<edge2level){var tmpEdge=edge1,tmpLevel=edge1level;edge1=edge2,edge1level=edge2level,edge2=tmpEdge,edge2level=tmpLevel}if(edgeInfo[edge1].v==edgeInfo[edge2].v&&edgeInfo[edge1].direction==edgeInfo[edge2].direction&&edgeInfo[edge1].attachLevel<edgeInfo[edge2].attachLevel)return 1/0;if(edgeInfo[edge1].left_x<=edgeInfo[edge2].left_x&&edgeInfo[edge1].right_x>=edgeInfo[edge2].right_x)return 0;if(edgeInfo[edge1].left_x>=edgeInfo[edge2].left_x&&edgeInfo[edge1].right_x<=edgeInfo[edge2].right_x)return 2;var extraIntersections=1;return edgeInfo[edge2].top_x>=edgeInfo[edge1].left_x&&edgeInfo[edge2].top_x<=edgeInfo[edge1].right_x&&extraIntersections++,edgeInfo[edge1].hasOwnProperty("edgeComplement")&&(!levels||levels[edgeInfo[edge1].edgeComplement]>edge2level)&&edgeInfo[edge1].down_x>=edgeInfo[edge2].left_x&&edgeInfo[edge1].down_x<=edgeInfo[edge2].right_x&&(extraIntersections-=.4),extraIntersections};var relEdgeLevels=new VerticalPosIntOptimizer(pairScoreFunc,initLevels,initLevels).computeVerticalPositions(5,500);for(i=numLevels=0;i<edgeInfo.length;i++)verticalLevels.outEdgeVerticalLevel[edgeInfo[i].v][edgeInfo[i].u].verticalLevel=relEdgeLevels[i],relEdgeLevels[i]>numLevels&&(numLevels=relEdgeLevels[i]);for(i=0;i<edgeInfo.length;i++){var level=relEdgeLevels[i];if(1<level){var lowerLevel=!0;for(e=0;e<edgeInfo[i].over.length;e++){var w=edgeInfo[i].over[e];if(!this.GG.isRelationship(w)){lowerLevel=!1;break}var parents=this.GG.getParents(w);if(verticalLevels.outEdgeVerticalLevel[parents[0]][w].verticalLevel<=level||verticalLevels.outEdgeVerticalLevel[parents[1]][w].verticalLevel<=level){lowerLevel=!1;break}}lowerLevel&&(verticalLevels.outEdgeVerticalLevel[edgeInfo[i].v][edgeInfo[i].u].verticalLevel=1)}}}verticalLevels.rankVerticalLevels[r-1]+=Math.max(0,numLevels-2)}return verticalLevels},_findLeftAndRightPartners:function(v,useOrdering){for(var ordering=useOrdering?useOrdering.vOrder:this.order.vOrder,rank=this.ranks[v],orderV=ordering[v],outEdges=this.GG.getOutEdges(v),leftEdges=[],rightEdges=[],j=0;j<outEdges.length;j++){var rel=outEdges[j];this.ranks[rel]==rank&&(ordering[rel]<orderV?leftEdges.push(rel):rightEdges.push(rel))}var byDistToV=function(a,b){return Math.abs(ordering[a]-orderV)-Math.abs(ordering[b]-orderV)};return leftEdges.sort(byDistToV),rightEdges.sort(byDistToV),{leftPartners:leftEdges,rightPartners:rightEdges}},findBestTwinInsertPosition:function(v,insertedTwinRelationships,useOrdering){var allTwins=this.GG.getAllTwinsOf(v),rank=this.ranks[v],rankOrder=useOrdering?useOrdering.order[rank]:this.order.order[rank],vOrder=useOrdering?useOrdering.vOrder:this.order.vOrder;allTwins.sort(function(a,b){return vOrder[a]-vOrder[b]});for(var numEdgesAcross=[],i=0;i<=allTwins.length;i++)numEdgesAcross[i]=0;var leftMostTwinOrder=vOrder[allTwins[0]];for(i=0;i<insertedTwinRelationships.length;i++){var rel=insertedTwinRelationships[i];if(vOrder[rel]<leftMostTwinOrder)for(var j=1;j<=allTwins.length;j++)numEdgesAcross[j]+=j;else for(j=0;j<allTwins.length;j++)numEdgesAcross[j]+=allTwins.length-j}for(i=0;i<allTwins.length;i++){var partnerInfo=this._findLeftAndRightPartners(allTwins[i],useOrdering),numLeftOf=partnerInfo.leftPartners.length,numRightOf=partnerInfo.rightPartners.length;for(j=0;j<=i;j++)numEdgesAcross[j]+=numLeftOf;for(j=i+1;j<=allTwins.length;j++)numEdgesAcross[j]+=numRightOf}var orderOfLeftMostTwin=vOrder[allTwins[0]],order=orderOfLeftMostTwin+Helpers.indexOfLastMinElementInArray(numEdgesAcross);for(i=orderOfLeftMostTwin+1;i<order;i++){var nodeID=rankOrder[i];this.GG.isRelationship(nodeID)&&order++}return order},computeRankY:function(oldRanks,oldRankY){for(var rankY=[0,0],r=2;r<=this.maxRank;r++){var yDistance=this.isChildhubRank(r)?this._computePersonRankHeight(r-1):this.yDistanceChildhubToNode;rankY[r]=rankY[r-1]+yDistance+this.yExtraPerHorizontalLine*(Math.max(this.vertLevel.rankVerticalLevels[r-1],1)-1)}if(oldRanks&&oldRankY){var oldRank=oldRanks[0],newRank=this.ranks[0],oldY=oldRankY[oldRank],shiftAmount=rankY[newRank]-oldY;for(r=0;r<=this.maxRank;r++)rankY[r]-=shiftAmount}return rankY},isChildhubRank:function(r){for(var i=0;i<this.order.order[r].length;i++){if(this.GG.isPerson(this.order.order[r][i])||this.GG.isRelationship(this.order.order[r][i]))return!1;if(this.GG.isChildhub(this.order.order[r][i]))return!0}return!0},_computePersonRankHeight:function(r){for(var height=this.yDistanceNodeToChildhub,maxNumLinesInComments=0,i=0;i<this.order.order[r].length;i++)if(this.GG.isPerson(this.order.order[r][i])){var person=this.order.order[r][i],numLabelLines=0,personProperties=this.GG.properties[person];if(personProperties.hasOwnProperty("comments"))numLabelLines+=(personProperties.comments.replace(/^\s+|\s+$/g,"").match(/\n/g)||[]).length+1;var dob=personProperties.hasOwnProperty("dob")?new PedigreeDate(personProperties.dob):null,dod=personProperties.hasOwnProperty("dod")?new PedigreeDate(personProperties.dod):null;if(null!==dob&&dob.isComplete()&&numLabelLines++,null!==dod&&dod.isComplete()&&numLabelLines++,null!==dob&&dob.isComplete()&&null!==dod&&dod.isComplete()){var age=AgeCalc.getAge(dob,dod);(age.length<2||age.indexOf(" y")<0)&&numLabelLines--}if((personProperties.hasOwnProperty("lName")||personProperties.hasOwnProperty("fName"))&&numLabelLines++,personProperties.hasOwnProperty("externalID")&&numLabelLines++,editor&&editor.getPreferencesManager().getConfigurationOption("displayCancerLabels")&&personProperties.hasOwnProperty("cancers"))for(var cancer in personProperties.cancers)personProperties.cancers.hasOwnProperty(cancer)&&personProperties.cancers[cancer].hasOwnProperty("Affected")&&personProperties.cancers[cancer].affected&&numLabelLines++;maxNumLinesInComments<numLabelLines&&(maxNumLinesInComments=numLabelLines)}return 4<maxNumLinesInComments&&(height+=(maxNumLinesInComments-4)*this.yCommentLineHeight),height},computeNodeY:function(rank,level){return this.rankY[rank]+(level-1)*this.yExtraPerHorizontalLine},computeRelLineY:function(rank,attachLevel,verticalLevel){var attachY=this.rankY[rank]-attachLevel*this.yAttachPortHeight,relLineY=this.rankY[rank];return{attachY:attachY,relLineY:relLineY-=1==verticalLevel?attachLevel*this.yAttachPortHeight:2==verticalLevel?1.25*this.yExtraPerHorizontalLine:verticalLevel*this.yExtraPerHorizontalLine}},displayGraph:function(xcoord,message){if(TIME_DRAWING_DEBUG=0,DISPLAY_POSITIONING_DEBUG){var debugTimer=new Helpers.Timer,renderPackage={convertedG:this.GG,ranks:this.ranks,ordering:this.order,positions:xcoord,consangr:this.consangr};debug_display_processed_graph(renderPackage,"output",!0,message),TIME_DRAWING_DEBUG=debugTimer.report()}},position:function(){var longEdges=this.find_long_edges(),xcoord=new XCoord(null,this);this.try_shift_right(xcoord,!0,!1),this.try_shift_right(xcoord,!1,!0),xcoord.normalize(),Helpers.printObject(xcoord.xcoord);for(var xbest=xcoord.copy(),bestScore=this.xcoord_score(xbest),i=0;i<=this.maxXcoordIterations;i++){this.try_shift_right(xcoord,!0,!0),this.try_straighten_long_edges(longEdges,xcoord),xcoord.normalize();var score=this.xcoord_score(xcoord);if(!score.isBettertThan(bestScore))break;xbest=xcoord.copy(),bestScore=score}return Helpers.printObject(xbest.xcoord),xbest.xcoord},xcoord_score:function(xcoord,considerOnlyRank,considerEdgesFromAbove,considerEdgesToBelow,fromOrderOnRank){var score=new XCoordScore(this.GG.getMaxRealVertexId()),rankFrom=1,rankTo=this.maxRank;void 0!==considerOnlyRank&&(0==(rankFrom=(rankTo=considerOnlyRank)-1)&&(rankFrom=1),considerEdgesFromAbove||(rankFrom=considerOnlyRank));for(var r=rankFrom;r<=rankTo;r++){var len=this.order.order[r].length,fromOrder=0;void 0!==considerOnlyRank&&r==considerOnlyRank&&(fromOrder=fromOrderOnRank);for(var i=fromOrder;i<len;++i)for(var v=this.order.order[r][i],outEdges=this.GG.getOutEdges(v),lenO=outEdges.length,j=0;j<lenO;++j){var u=outEdges[j];if(void 0!==considerOnlyRank){if(!considerEdgesToBelow&&this.ranks[u]!=considerOnlyRank)continue;if(this.ranks[u]==considerOnlyRank&&this.order.vOrder[u]<fromOrderOnRank)continue}var coeff=this.edge_importance_to_straighten(v,u),w=this.xCoordEdgeWeightValue?this.GG.weights[v][u]:1,dist=Math.abs(xcoord.xcoord[v]-xcoord.xcoord[u]),thisScore=coeff*w*dist;score.add(thisScore),score.addEdge(v,u,dist)}}return score},edge_importance_to_straighten:function(fromV,toV){return this.GG.isRelationship(toV)?1:!this.GG.isVirtual(fromV)&&this.GG.isVirtual(toV)?1.5:this.GG.isRelationship(fromV)?8:this.GG.isVirtual(fromV)?this.GG.isVirtual(toV)?16:4:2},try_shift_right:function(xcoord,scoreQualityOfNodesBelow,scoreQualityOfNodesAbove){for(var rr=0;rr<=this.maxRank;rr++){var r;if(0!=(r=scoreQualityOfNodesAbove?rr:this.maxRank-rr))for(var considerEdgesToBelow=(scoreQualityOfNodesBelow||1==r)&&r!=this.maxRank,considerEdgesFromAbove=(scoreQualityOfNodesAbove||r==this.maxRank)&&1!=r,i=this.order.order[r].length-1;0<=i;i--){var v=this.order.order[r][i],median=this.compute_median(v,xcoord,considerEdgesFromAbove,considerEdgesToBelow);median!=median&&(median=xcoord.xcoord[v]);var maxShift=median-xcoord.xcoord[v],noDisturbMax=xcoord.getRightMostNoDisturbPosition(v),maxSafeShift=noDisturbMax<median?noDisturbMax-xcoord.xcoord[v]:maxShift;if(!(maxShift<=0)){var bestShift=0,bestScore=this.xcoord_score(xcoord,r,considerEdgesFromAbove,considerEdgesToBelow,i),shiftAmount=maxShift;do{var newScore;if(shiftAmount<=maxSafeShift)xcoord.xcoord[v]+=shiftAmount,newScore=this.xcoord_score(xcoord,r,considerEdgesFromAbove,considerEdgesToBelow,i),xcoord.xcoord[v]-=shiftAmount;else{var newCoord=xcoord.copy();newCoord.shiftRightAndShiftOtherIfNecessary(v,shiftAmount),newScore=this.xcoord_score(newCoord,r,considerEdgesFromAbove,considerEdgesToBelow,i)}newScore.isBettertThan(bestScore)&&(bestShift=shiftAmount,bestScore=newScore),shiftAmount-=1}while(shiftAmount>=Math.max(0,maxSafeShift));0<bestShift&&xcoord.shiftRightAndShiftOtherIfNecessary(v,bestShift)}}}},compute_median:function(v,xcoord,considerAbove,considerBelow){var positionsAbove=[],positionsBelow=[],allEdgesWithWeights=this.GG.getAllEdgesWithWeights(v);for(var u in allEdgesWithWeights)if(allEdgesWithWeights.hasOwnProperty(u)){if(u==v)continue;for(var weight=allEdgesWithWeights[u].weight,score=(allEdgesWithWeights[u].out?this.edge_importance_to_straighten(v,u):this.edge_importance_to_straighten(u,v))*(this.xCoordEdgeWeightValue?weight:1),i=0;i<score;i++)this.ranks[u]<=this.ranks[v]&&positionsAbove.push(xcoord.xcoord[u]),this.ranks[u]>=this.ranks[v]&&positionsBelow.push(xcoord.xcoord[u])}var middle,numericSortFunc=function(a,b){return a-b},median=void 0,medianAbove=void 0,medianBelow=void 0;(considerAbove||this.GG.isVirtual(v))&&0<positionsAbove.length&&(positionsAbove.sort(numericSortFunc),(middle=Math.ceil(positionsAbove.length/2))>=positionsAbove.length&&(middle=positionsAbove.length-1),medianAbove=positionsAbove.length%2==0?Math.floor((positionsAbove[middle]+positionsAbove[middle-1])/2):positionsAbove[middle]);(considerBelow||this.GG.isVirtual(v))&&0<positionsBelow.length&&(positionsBelow.sort(numericSortFunc),(middle=Math.ceil(positionsBelow.length/2))>=positionsBelow.length&&(middle=positionsBelow.length-1),medianBelow=positionsBelow.length%2==0?Math.floor((positionsBelow[middle]+positionsBelow[middle-1])/2):positionsBelow[middle]);return median=void 0!==medianAbove&&void 0!==medianBelow?Math.max(medianAbove,medianBelow):void 0!==medianAbove?medianAbove:medianBelow,Math.ceil(median)},try_straighten_long_edges:function(longEdges,xcoord){for(var improved=!1,e=0;e<longEdges.length;++e){for(var chain=longEdges[e],currentCenter=xcoord.xcoord[chain[0]],corridorLeft=xcoord.getLeftMostNoDisturbPosition(chain[0]),corridorRight=xcoord.getRightMostNoDisturbPosition(chain[0]),i=1;i<chain.length;++i){var nextV=chain[i];if((nextCenter=xcoord.xcoord[nextV])!=currentCenter){if(!(corridorLeft<=nextCenter&&nextCenter<=corridorRight))break;for(var j=0;j<i;++j)xcoord.xcoord[chain[j]]=nextCenter;improved=!0,currentCenter=nextCenter}if(corridorLeft=Math.max(corridorLeft,xcoord.getLeftMostNoDisturbPosition(nextV)),(corridorRight=Math.min(corridorRight,xcoord.getRightMostNoDisturbPosition(nextV)))<corridorLeft)break}var lastNode=chain.length-1;for(currentCenter=xcoord.xcoord[chain[lastNode]],corridorLeft=xcoord.getLeftMostNoDisturbPosition(chain[lastNode]),corridorRight=xcoord.getRightMostNoDisturbPosition(chain[lastNode]),i=lastNode-1;0<=i;--i){var nextCenter;nextV=chain[i];if((nextCenter=xcoord.xcoord[nextV])!=currentCenter){if(!(corridorLeft<=nextCenter&&nextCenter<=corridorRight))break;for(j=lastNode;i<j;j--)xcoord.xcoord[chain[j]]=nextCenter;improved=!0,currentCenter=nextCenter}if(corridorLeft=Math.max(corridorLeft,xcoord.getLeftMostNoDisturbPosition(nextV)),(corridorRight=Math.min(corridorRight,xcoord.getRightMostNoDisturbPosition(nextV)))<corridorLeft)break}}return improved},find_long_edges:function(){for(var longEdges=[],maxRealId=this.GG.getMaxRealVertexId(),numVert=this.GG.getNumVertices(),checked=[],v=maxRealId+1;v<numVert;v++)checked[v]=!1;for(v=maxRealId+1;v<numVert;v++)if(!checked[v]&&0!=this.ranks[v]){for(var head=v;this.GG.isVirtual(this.GG.getInEdges(head)[0]);)head=this.GG.getInEdges(head)[0];for(var chain=[],next=head;checked[next]=!0,chain.push(next),next=this.GG.getOutEdges(next)[0],this.GG.isVirtual(next););console.log("Found long edge "+Helpers.stringifyObject(chain)),longEdges.push(chain)}return longEdges}};var DISPLAY_POSITIONING_DEBUG=!1,TIME_DRAWING_DEBUG=0;function make_dynamic_positioned_graph(inputG,debugOutput){var timer=new Helpers.Timer;DISPLAY_POSITIONING_DEBUG=!!debugOutput;var drawGraph=new PositionedGraph(inputG,10,6,5,24,4);return console.log("=== Running time: "+timer.report()+"ms =========="),new DynamicPositionedGraph(drawGraph)}DynamicPositionedGraph=function(drawGraph){this.DG=drawGraph,this._heuristics=new Heuristics(drawGraph),this._heuristics.improvePositioning(),this._onlyProbandGraph=[{name:"proband"}]},DynamicPositionedGraph.makeEmpty=function(layoutRelativePersonWidth,layoutRelativeOtherWidth){var baseG=new BaseGraph(layoutRelativePersonWidth,layoutRelativeOtherWidth),positionedG=new PositionedGraph(baseG);return new DynamicPositionedGraph(positionedG)},DynamicPositionedGraph.prototype={isValidID:function(id){return!(id<0||id>this.DG.GG.getMaxRealVertexId())&&!(!this.DG.GG.isPerson(id)&&!this.DG.GG.isRelationship(id))},getMaxNodeId:function(){return this.DG.GG.getMaxRealVertexId()},isPersonGroup:function(id){return this.getProperties(id).hasOwnProperty("numPersons")},isPerson:function(id){return this.DG.GG.isPerson(id)},isRelationship:function(id){return this.DG.GG.isRelationship(id)},isPlaceholder:function(id){return this.DG.GG.isPlaceholder(id)},isAdoptedIn:function(id){if(!this.isPerson(id))throw"Assertion failed: isAdopted() is applied to a non-person";return this.DG.GG.isAdoptedIn(id)},isAdoptedOut:function(id){if(!this.isPerson(id))throw"Assertion failed: isAdopted() is applied to a non-person";return this.DG.GG.isAdoptedOut(id)},getGeneration:function(id){var minRank=Math.min.apply(null,this.DG.ranks);return(this.DG.ranks[id]-minRank)/2+1},getOrderWithinGeneration:function(id){if(!this.isPerson(id))throw"Assertion failed: getOrderWithinGeneration() is applied to a non-person";for(var order=0,rank=this.DG.ranks[id],i=0;i<this.DG.order.order[rank].length;i++){var next=this.DG.order.order[rank][i];if(this.DG.GG.isPerson(next)&&!this.DG.GG.isPlaceholder(next)&&order++,next==id)break}return order},getTwinGroupId:function(id){return this.DG.GG.getTwinGroupId(id)},getAllTwinsSortedByOrder:function(id){var twins=this.DG.GG.getAllTwinsOf(id),vOrder=this.DG.order.vOrder;return twins.sort(function(a,b){return vOrder[a]-vOrder[b]}),twins},isChildless:function(id){return!!this.getProperties(id).hasOwnProperty("childlessStatus")&&null!==this.getProperties(id).childlessStatus},isChildlessByChoice:function(id){return!!this.getProperties(id).hasOwnProperty("childlessStatus")&&"Childless"==this.getProperties(id).childlessStatus},isInfertile:function(id){return!!this.getProperties(id).hasOwnProperty("childlessStatus")&&"Infertile"==this.getProperties(id).childlessStatus},isConsangrRelationship:function(id){if(!this.isRelationship(id))throw"Assertion failed: isConsangrRelationship() is applied to a non-relationship";return this.DG.consangr.hasOwnProperty(id)},getProperties:function(id){return this.DG.GG.properties[id]},setProperties:function(id,newSetOfProperties){this.DG.GG.properties[id]=newSetOfProperties},setProbandData:function(patientObject){patientObject.hasOwnProperty("patient_name")&&(patientObject.patient_name.hasOwnProperty("first_name")?this.DG.GG.properties[0].fName=patientObject.patient_name.first_name:this.DG.GG.properties[0].fName="",patientObject.patient_name.hasOwnProperty("last_name")?this.DG.GG.properties[0].lName=patientObject.patient_name.last_name:this.DG.GG.properties[0].lName="");if(patientObject.hasOwnProperty("sex")){var probandSex=patientObject.sex,genderString=probandSex.toLowerCase();"female"==genderString||"f"==genderString||"2"==genderString?probandSex="F":"male"==genderString||"m"==genderString||"1"==genderString?probandSex="M":"other"!=genderString&&"o"!=genderString&&"9"!=genderString||(probandSex="O");var possibleGenders=this.getPossibleGenders(0);possibleGenders.hasOwnProperty(probandSex)&&possibleGenders[probandSex]||!(probandSex="U"),this.DG.GG.properties[0].gender=probandSex}if(patientObject.hasOwnProperty("life_status")){var lifeStatus=patientObject.life_status;"Deceased"!=lifeStatus&&"Alive"!=lifeStatus||(this.DG.GG.properties[0].lifeStatus=lifeStatus)}else delete this.DG.GG.properties[0].lifeStatus;if(patientObject.hasOwnProperty("ethnicity")){var ethnicities=[];patientObject.ethnicity.hasOwnProperty("maternal_ethnicity")&&(ethnicities=patientObject.ethnicity.maternal_ethnicity.slice(0)),patientObject.ethnicity.hasOwnProperty("paternal_ethnicity")&&(ethnicities=ethnicities.concat(patientObject.ethnicity.paternal_ethnicity.slice(0))),0<ethnicities.length&&(this.DG.GG.properties[0].ethnicities=Helpers.filterUnique(ethnicities))}patientObject.hasOwnProperty("external_id")?this.DG.GG.properties[0].externalID=patientObject.external_id:delete this.DG.GG.properties[0].externalID;var genes=[];if(patientObject.hasOwnProperty("genes"))for(var i=0;i<patientObject.genes.length;i++)genes.push(patientObject.genes[i].gene);return 0<genes.length?this.DG.GG.properties[0].candidateGenes=genes:delete this.DG.GG.properties[0].candidateGenes,!0},getPosition:function(v){var x=this.DG.positions[v],rank=this.DG.ranks[v],vertLevel=this.DG.GG.isChildhub(v)?this.DG.vertLevel.childEdgeLevel[v]:1,y=this.DG.computeNodeY(rank,vertLevel);if(this.DG.GG.isVirtual(v)){var relId=this.DG.GG.downTheChainUntilNonVirtual(v),personId=this.DG.GG.upTheChainUntilNonVirtual(v);if(rank==this.DG.ranks[personId]){var level=this.DG.vertLevel.outEdgeVerticalLevel[personId][relId].verticalLevel;y=this.DG.computeRelLineY(rank,0,level).relLineY}rank==this.DG.ranks[relId]&&(y=this.getPosition(relId).y)}else if(this.isRelationship(v)){var partners=this.DG.GG.getParents(v),level1=this.DG.vertLevel.outEdgeVerticalLevel[partners[0]].hasOwnProperty(v)?this.DG.vertLevel.outEdgeVerticalLevel[partners[0]][v].verticalLevel:0,level2=this.DG.vertLevel.outEdgeVerticalLevel[partners[1]].hasOwnProperty(v)?this.DG.vertLevel.outEdgeVerticalLevel[partners[1]][v].verticalLevel:0,attach1=(level=Math.min(level1,level2),this.DG.vertLevel.outEdgeVerticalLevel[partners[0]].hasOwnProperty(v)?this.DG.vertLevel.outEdgeVerticalLevel[partners[0]][v].attachlevel:0),attach2=this.DG.vertLevel.outEdgeVerticalLevel[partners[1]].hasOwnProperty(v)?this.DG.vertLevel.outEdgeVerticalLevel[partners[1]][v].attachlevel:0,attach=Math.min(attach1,attach2);y=this.DG.computeRelLineY(rank,attach,level).relLineY}return{x:x,y:y}},getRelationshipChildLastName:function(v){if(!this.isRelationship(v))throw"Assertion failed: getRelationshipChildLastName() is applied to a non-relationship";var fatherLastName=null,parents=this.DG.GG.getParents(v);if("M"==this.getGender(parents[0]))fatherLastName=this.DG.GG.getLastName(parents[0]);else{if("M"!=this.getGender(parents[1]))return null;fatherLastName=this.DG.GG.getLastName(parents[1])}if(""==fatherLastName)return null;for(var childhubId=this.DG.GG.getRelationshipChildhub(v),children=this.DG.GG.getOutEdges(childhubId),i=0;i<children.length;i++){var childLastName=this.DG.GG.getLastNameAtBirth(children[i]);if(""!=childLastName&&childLastName!=fatherLastName)return null}return fatherLastName},getRelationshipChildhubPosition:function(v){if(!this.isRelationship(v))throw"Assertion failed: getRelationshipChildhubPosition() is applied to a non-relationship";var childhubId=this.DG.GG.getRelationshipChildhub(v);return this.getPosition(childhubId)},getRelationshipLineInfo:function(relationship,person){if(!this.isRelationship(relationship))throw"Assertion failed: getRelationshipToPersonLinePosition() is applied to a non-relationship";if(!this.isPerson(person))throw"Assertion failed: getRelationshipToPersonLinePosition() is applied to a non-person";var info=this.DG.vertLevel.outEdgeVerticalLevel[person].hasOwnProperty(relationship)?this.DG.vertLevel.outEdgeVerticalLevel[person][relationship]:{attachlevel:0,verticalLevel:0,numAttachLevels:1},verticalRelInfo=this.DG.computeRelLineY(this.DG.ranks[person],info.attachlevel,info.verticalLevel);return{attachmentPort:info.attachlevel,attachY:verticalRelInfo.attachY,verticalLevel:info.verticalLevel,verticalY:verticalRelInfo.relLineY,numAttachPorts:info.numAttachLevels}},getRelationshipChildrenSortedByOrder:function(v){if(!this.isRelationship(v))throw"Assertion failed: getRelationshipChildren() is applied to a non-relationship";var childhubId=this.DG.GG.getRelationshipChildhub(v),children=this.DG.GG.getOutEdges(childhubId),vOrder=this.DG.order.vOrder;return children.sort(function(a,b){return vOrder[a]-vOrder[b]}),children},getAllChildren:function(v){if(!this.isPerson(v)&&!this.isRelationship(v))throw"Assertion failed: getAllChildren() is applied to a non-person non-relationship node";for(var rels=this.isRelationship(v)?[v]:this.DG.GG.getAllRelationships(v),allChildren=[],i=0;i<rels.length;i++){var chhub=this.DG.GG.getOutEdges(rels[i])[0],children=this.DG.GG.getOutEdges(chhub);allChildren=allChildren.concat(children)}return allChildren},isChildOfProband:function(v){var parents=this.DG.GG.getParents(v);return!!Helpers.arrayContains(parents,0)},isSiblingOfProband:function(v){var siblings=this.DG.GG.getAllSiblingsOf(v);return!!Helpers.arrayContains(siblings,0)},isPartnershipRelatedToProband:function(v){var parents=this.DG.GG.getParents(v);return!!Helpers.arrayContains(parents,0)||v==this.DG.GG.getProducingRelationship(0)},isRelatedToProband:function(v){for(var probandRelatedRels=this.getAllRelatedRelationships(0),i=0;i<probandRelatedRels.length;i++){var rel=probandRelatedRels[i],parents=this.DG.GG.getParents(rel);if(Helpers.arrayContains(parents,v))return!0;var children=this.getAllChildren(rel);if(Helpers.arrayContains(children,v))return!0}return!1},getAllRelatedRelationships:function(v){var allRels=this.DG.GG.getAllRelationships(v),parentRel=this.DG.GG.getProducingRelationship(v);return null!=parentRel&&allRels.push(parentRel),allRels},getAllSiblings:function(v){if(!this.isPerson(v))throw"Assertion failed: getAllSiblings() is applied to a non-person";if(0==this.DG.GG.getInEdges(v).length)return[];var chhub=this.DG.GG.getInEdges(v)[0],siblings=this.DG.GG.getOutEdges(chhub).slice(0);return Helpers.removeFirstOccurrenceByValue(siblings,v),siblings},isOnlyChild:function(v){if(!this.isPerson(v))throw"Assertion failed: isOnlyPartnerlessChild() is applied to a non-person";return 0!=this.DG.GG.getInEdges(v).length&&0==this.getAllSiblings(v).length},hasNonPlaceholderNonAdoptedChildren:function(v){var children=[];this.isRelationship(v)?children=this.getRelationshipChildrenSortedByOrder(v):this.isPerson(v)&&(children=this.getAllChildren(v));for(var i=0;i<children.length;i++){var child=children[i];if(!this.isPlaceholder(child)&&!this.isAdoptedIn(child))return!0}return!1},hasNoNonPlaceholderChildren:function(v){var children=[];this.isRelationship(v)?children=this.getRelationshipChildrenSortedByOrder(v):this.isPerson(v)&&(children=this.getAllChildren(v));for(var i=0;i<children.length;i++){var child=children[i];if(!this.isPlaceholder(child))return!1}return!0},getParentRelationship:function(v){if(!this.isPerson(v))throw"Assertion failed: getParentRelationship() is applied to a non-person";return this.DG.GG.getProducingRelationship(v)},hasToBeAdopted:function(v){if(!this.isPerson(v))throw"Assertion failed: hasToBeAdopted() is applied to a non-person";var parentRel=this.getParentRelationship(v);return!(null===parentRel||!this.isChildless(parentRel))},hasRelationships:function(v){if(!this.isPerson(v))throw"Assertion failed: hasRelationships() is applied to a non-person";return 0<this.DG.GG.v[v].length},getPossibleGenders:function(v){for(var possible={M:!0,F:!0,O:!0,U:!0},partners=this.DG.GG.getAllPartners(v),i=0;i<partners.length;i++){var partnerGender=this.getGender(partners[i]);"U"!=partnerGender&&"O"!=partnerGender&&(possible[partnerGender]=!1)}return possible},getPossibleChildrenOf:function(v){for(var result=[],i=0;i<=this.DG.GG.getMaxRealVertexId();i++)this.isPerson(i)&&0==this.DG.GG.inedges[i].length&&(this.DG.ancestors[v].hasOwnProperty(i)||result.push(i));return result},getPossibleSiblingsOf:function(v){for(var hasParents=null!==this.getParentRelationship(v),result=[],i=0;i<=this.DG.GG.getMaxRealVertexId();i++)this.isPerson(i)&&(this.DG.ancestors[v].hasOwnProperty(i)||this.DG.ancestors[i].hasOwnProperty(v)||hasParents&&0!=this.DG.GG.inedges[i].length||result.push(i));return result},getPossibleParentsOf:function(v){for(var result=[],i=0;i<=this.DG.GG.getMaxRealVertexId();i++)(this.isRelationship(i)||this.isPerson(i))&&(this.isPersonGroup(i)||this.isPlaceholder(i)||this.DG.ancestors[i].hasOwnProperty(v)||this.isPerson(i)&&this.isAdoptedOut(i)||result.push(i));return result},getPossiblePartnersOf:function(v){var oppositeGender=this.DG.GG.getOppositeGender(v),validGendersSet="U"==oppositeGender?["M","F","U","O"]:[oppositeGender,"U","O"],result=this._getAllPersonsOfGenders(validGendersSet,!0),partners=this.DG.GG.getAllPartners(v);partners.push(v);for(var i=0;i<partners.length;i++)Helpers.removeFirstOccurrenceByValue(result,partners[i]);return result},getOppositeGender:function(v){if(!this.isPerson(v))throw"Assertion failed: getOppositeGender() is applied to a non-person";return this.DG.GG.getOppositeGender(v)},getGender:function(v){if(!this.isPerson(v))throw"Assertion failed: getGender() is applied to a non-person";return this.DG.GG.getGender(v)},getLastName:function(v){if(!this.isPerson(v))throw"Assertion failed: getLastName() is applied to a non-person";return this.DG.GG.getLastName(v)},getDisconnectedSetIfNodeRemoved:function(v){var removedList={};if(removedList[v]=!0,this.isPerson(v))for(var allRels=this.DG.GG.getAllRelationships(v),i=0;i<allRels.length;i++)removedList[allRels[i]]=!0;for(var node in removedList){if(removedList.hasOwnProperty(node)&&this.isRelationship(node))removedList[this.DG.GG.getOutEdges(node)[0]]=!0}var connected={},queue=new Queue;for(queue.push(0);0<queue.size();){var next=parseInt(queue.pop());if(!connected.hasOwnProperty(next)){connected[next]=!0;var outEdges=this.DG.GG.getOutEdges(next);for(i=0;i<outEdges.length;i++)removedList.hasOwnProperty(outEdges[i])||queue.push(outEdges[i]);var inEdges=this.DG.GG.getInEdges(next);for(i=0;i<inEdges.length;i++)removedList.hasOwnProperty(inEdges[i])||queue.push(inEdges[i])}}console.log("Connected nodes: "+Helpers.stringifyObject(connected));var affected=[];for(i=0;i<this.DG.GG.getNumVertices();i++)(this.isPerson(i)||this.isRelationship(i))&&(connected.hasOwnProperty(i)||affected.push(i));return console.log("Affected nodes: "+Helpers.stringifyObject(affected)),affected},_debugPrintAll:function(headerMessage){console.log("========== "+headerMessage+" ==========")},updateAncestors:function(){var ancestors=this.DG.findAllAncestors();this.DG.ancestors=ancestors.ancestors,this.DG.consangr=ancestors.consangr;for(var movedNodes=[],i=0;i<=this.DG.GG.getMaxRealVertexId();i++)this.isRelationship(i)&&movedNodes.push(i);return{moved:movedNodes}},addNewChild:function(childhubId,properties,numTwins){this._debugPrintAll("before");var timer=new Helpers.Timer;if(!this.DG.GG.isChildhub(childhubId)){if(!this.DG.GG.isRelationship(childhubId))throw"Assertion failed: adding children to a non-childhub node";childhubId=this.DG.GG.getRelationshipChildhub(childhubId)}var positionsBefore=this.DG.positions.slice(0),ranksBefore=this.DG.ranks.slice(0),vertLevelsBefore=this.DG.vertLevel.copy(),rankYBefore=this.DG.rankY.slice(0),numNodesBefore=this.DG.GG.getMaxRealVertexId();properties||(properties={}),numTwins||(numTwins=1);for(var insertRank=this.DG.ranks[childhubId]+1,insertOrder=this._findBestInsertPosition(insertRank,childhubId),newNodeId=this._insertVertex(BaseGraph.TYPE.PERSON,properties,1,childhubId,null,insertRank,insertOrder),newNodes=[newNodeId],i=0;i<numTwins-1;i++){var changeSet=this.addTwin(newNodeId,properties);newNodes.push(changeSet.new[0])}this.DG.GG.validate(),this._heuristics.improvePositioning(ranksBefore,rankYBefore),this.updateAncestors(),timer.printSinceLast("=== AddChild runtime: "),this._debugPrintAll("after");var movedNodes=this._findMovedNodes(numNodesBefore,positionsBefore,ranksBefore,vertLevelsBefore,rankYBefore),relationshipId=this.DG.GG.getInEdges(childhubId)[0];return Helpers.arrayContains(movedNodes,relationshipId)||movedNodes.push(relationshipId),{new:newNodes,moved:movedNodes,animate:this.DG.GG.getInEdges(relationshipId)}},addNewParents:function(personId){this._debugPrintAll("before");var timer=new Helpers.Timer;if(!this.DG.GG.isPerson(personId))throw"Assertion failed: adding parents to a non-person node";if(0<this.DG.GG.getInEdges(personId).length)throw"Assertion failed: adding parents to a person with parents";var positionsBefore=this.DG.positions.slice(0),ranksBefore=this.DG.ranks.slice(0),vertLevelsBefore=this.DG.vertLevel.copy(),rankYBefore=this.DG.rankY.slice(0),numNodesBefore=this.DG.GG.getMaxRealVertexId();this._heuristics.swapBeforeParentsToBringToSideIfPossible(personId);var insertChildhubRank=this.DG.ranks[personId]-1,insertChildhubOrder=this._findBestInsertPosition(insertChildhubRank,personId),newChildhubId=this._insertVertex(BaseGraph.TYPE.CHILDHUB,{},1,null,personId,insertChildhubRank,insertChildhubOrder),insertParentsRank=this.DG.ranks[newChildhubId]-1,insertParentOrder=this._findBestInsertPosition(insertParentsRank,newChildhubId),newRelationshipId=this._insertVertex(BaseGraph.TYPE.RELATIONSHIP,{},1,null,newChildhubId,insertParentsRank,insertParentOrder);insertParentsRank=this.DG.ranks[newRelationshipId];var newParent1Id=this._insertVertex(BaseGraph.TYPE.PERSON,{gender:"F"},1,null,newRelationshipId,insertParentsRank,insertParentOrder+1),newParent2Id=this._insertVertex(BaseGraph.TYPE.PERSON,{gender:"M"},1,null,newRelationshipId,insertParentsRank,insertParentOrder);this.DG.GG.validate(),this._heuristics.improvePositioning(ranksBefore,rankYBefore),this.updateAncestors(),timer.printSinceLast("=== NewParents runtime: "),this._debugPrintAll("after");var animateNodes=this.DG.GG.getAllPartners(personId);return 1==animateNodes.length?animateNodes.push(personId):animateNodes=[personId],{new:[newRelationshipId,newParent1Id,newParent2Id],moved:this._findMovedNodes(numNodesBefore,positionsBefore,ranksBefore,vertLevelsBefore,rankYBefore),highlight:[personId],animate:animateNodes}},addNewRelationship:function(personId,childProperties,preferLeft,numTwins){this._debugPrintAll("before");var timer=new Helpers.Timer;if(!this.DG.GG.isPerson(personId))throw"Assertion failed: adding relationship to a non-person node";var positionsBefore=this.DG.positions.slice(0),ranksBefore=this.DG.ranks.slice(0),vertLevelsBefore=this.DG.vertLevel.copy(),rankYBefore=this.DG.rankY.slice(0),consangrBefore=this.DG.consangr,numNodesBefore=this.DG.GG.getMaxRealVertexId();childProperties||(childProperties={}),numTwins||(numTwins=1);var partnerProperties={gender:this.DG.GG.getOppositeGender(personId)},insertRank=this.DG.ranks[personId],personOrder=this.DG.order.vOrder[personId],relProperties={};if(childProperties.hasOwnProperty("placeholder")&&childProperties.placeholder)relProperties.childlessStatus="Childless";this._heuristics.swapPartnerToBringToSideIfPossible(personId),this._heuristics.swapTwinsToBringToSideIfPossible(personId);var insertOrder=this._findBestInsertPosition(insertRank,personId,preferLeft);console.log("vOrder: "+personOrder+", inserting @ "+insertOrder),console.log("Orders before: "+Helpers.stringifyObject(this.DG.order.order[this.DG.ranks[personId]]));var newRelationshipId=this._insertVertex(BaseGraph.TYPE.RELATIONSHIP,relProperties,1,personId,null,insertRank,insertOrder);console.log("Orders after: "+Helpers.stringifyObject(this.DG.order.order[this.DG.ranks[personId]]));for(var insertPersonOrder=personOrder<insertOrder?insertOrder+1:insertOrder,newPersonId=this._insertVertex(BaseGraph.TYPE.PERSON,partnerProperties,1,null,newRelationshipId,insertRank,insertPersonOrder),insertChildhubRank=insertRank+1,insertChildhubOrder=this._findBestInsertPosition(insertChildhubRank,newRelationshipId),newChildhubId=this._insertVertex(BaseGraph.TYPE.CHILDHUB,{},1,newRelationshipId,null,insertChildhubRank,insertChildhubOrder),insertChildRank=insertChildhubRank+1,insertChildOrder=this._findBestInsertPosition(insertChildRank,newChildhubId),newChildId=this._insertVertex(BaseGraph.TYPE.PERSON,childProperties,1,newChildhubId,null,insertChildRank,insertChildOrder),newNodes=[newRelationshipId,newPersonId,newChildId],i=0;i<numTwins-1;i++){var changeSet=this.addTwin(newChildId,childProperties);newNodes.push(changeSet.new[0])}return console.log("Orders after all: "+Helpers.stringifyObject(this.DG.order.order[this.DG.ranks[personId]])),this.DG.GG.validate(),this._heuristics.improvePositioning(ranksBefore,rankYBefore),this.updateAncestors(),timer.printSinceLast("=== NewRelationship runtime: "),this._debugPrintAll("after"),{new:newNodes,moved:this._findMovedNodes(numNodesBefore,positionsBefore,ranksBefore,vertLevelsBefore,rankYBefore,consangrBefore),highlight:[personId]}},assignParent:function(parentId,childId){if(this.isRelationship(parentId)){var childHubId=this.DG.GG.getRelationshipChildhub(parentId),rankChildHub=this.DG.ranks[childHubId],rankChild=this.DG.ranks[childId],otherChildren=this.getAllChildren(parentId);if(this.DG.GG.addEdge(childHubId,childId,1),1==otherChildren.length&&this.isPlaceholder(otherChildren[0]))var removeChangeSet=this.removeNodes([otherChildren[0]]);var animateList=[childId];if(rankChildHub!=rankChild-1){var removedList=removeChangeSet?removeChangeSet.removed:[];return this.redrawAll(removedList,animateList)}var positionsBefore=this.DG.positions.slice(0),ranksBefore=this.DG.ranks.slice(0),vertLevelsBefore=this.DG.vertLevel.copy(),rankYBefore=this.DG.rankY.slice(0),consangrBefore=this.DG.consangr,numNodesBefore=this.DG.GG.getMaxRealVertexId();this.DG.GG.validate(),this._updateauxiliaryStructures(ranksBefore,rankYBefore),positionsBefore[parentId]=1/0;var movedNodes=this._findMovedNodes(numNodesBefore,positionsBefore,ranksBefore,vertLevelsBefore,rankYBefore,consangrBefore);return removeChangeSet?(removeChangeSet.moved=removeChangeSet.moved.concat(movedNodes),removeChangeSet.moved=Helpers.filterUnique(removeChangeSet.moved),removeChangeSet.animate=[childId],removeChangeSet):{moved:movedNodes,animate:[childId]}}var rankParent=this.DG.ranks[parentId],partnerProperties=(rankChild=this.DG.ranks[childId],{gender:this.DG.GG.getOppositeGender(parentId)});if(rankChild<=rankParent){ranksBefore=this.DG.ranks.slice(0);var insertChildhubRank=rankChild-1,newChildhubId=this._insertVertex(BaseGraph.TYPE.CHILDHUB,{},1,null,childId,insertChildhubRank,0),insertParentsRank=this.DG.ranks[newChildhubId]-1,newRelationshipId=this._insertVertex(BaseGraph.TYPE.RELATIONSHIP,{},1,null,newChildhubId,insertParentsRank,0),newParentId=this._insertVertex(BaseGraph.TYPE.PERSON,partnerProperties,1,null,newRelationshipId,insertParentsRank,0);this.DG.GG.addEdge(parentId,newRelationshipId,1);animateList=[childId,parentId];var newList=[newRelationshipId,newParentId];return this.redrawAll(null,animateList,newList,ranksBefore)}this._debugPrintAll("before");var timer=new Helpers.Timer,x_parent=(positionsBefore=this.DG.positions.slice(0),ranksBefore=this.DG.ranks.slice(0),vertLevelsBefore=this.DG.vertLevel.copy(),rankYBefore=this.DG.rankY.slice(0),consangrBefore=this.DG.consangr,numNodesBefore=this.DG.GG.getMaxRealVertexId(),this.DG.positions[parentId]),x_child=this.DG.positions[childId];if(rankParent==rankChild-2){var preferLeft=x_child<x_parent,insertRelatOrder=this._findBestInsertPosition(rankParent,parentId,preferLeft),newParentOrder=(newRelationshipId=this._insertVertex(BaseGraph.TYPE.RELATIONSHIP,{},1,parentId,null,rankParent,insertRelatOrder),this.DG.order.vOrder[parentId]>this.DG.order.vOrder[newRelationshipId]?insertRelatOrder:insertRelatOrder+1),insertChildhubOrder=(newParentId=this._insertVertex(BaseGraph.TYPE.PERSON,partnerProperties,1,null,newRelationshipId,rankParent,newParentOrder),insertChildhubRank=rankChild-1,this._findBestInsertPosition(insertChildhubRank,newRelationshipId));newChildhubId=this._insertVertex(BaseGraph.TYPE.CHILDHUB,{},1,newRelationshipId,null,insertChildhubRank,insertChildhubOrder);this.DG.GG.addEdge(newChildhubId,childId,1)}else{insertChildhubRank=rankChild-1,insertChildhubOrder=this._findBestInsertPosition(insertChildhubRank,childId),newChildhubId=this._insertVertex(BaseGraph.TYPE.CHILDHUB,{},1,null,childId,insertChildhubRank,insertChildhubOrder),insertParentsRank=rankChild-2,insertRelatOrder=this._findBestInsertPosition(insertParentsRank,newChildhubId),newRelationshipId=this._insertVertex(BaseGraph.TYPE.RELATIONSHIP,{},1,null,newChildhubId,insertParentsRank,insertRelatOrder),newParentOrder=this.DG.positions[parentId]>this.DG.positions[newRelationshipId]?insertRelatOrder:insertRelatOrder+1,newParentId=this._insertVertex(BaseGraph.TYPE.PERSON,partnerProperties,1,null,newRelationshipId,insertParentsRank,newParentOrder);this._addMultiRankEdge(parentId,newRelationshipId)}return this.DG.GG.validate(),this._heuristics.improvePositioning(ranksBefore,rankYBefore),this.updateAncestors(),timer.printSinceLast("=== DragToParentOrChild runtime: "),this._debugPrintAll("after"),31<=this.DG.positions.length&&console.log("position of node 32: "+this.DG.positions[32]+", was: "+positionsBefore[32]),{new:[newRelationshipId,newParentId],moved:movedNodes=this._findMovedNodes(numNodesBefore,positionsBefore,ranksBefore,vertLevelsBefore,rankYBefore,consangrBefore),highlight:[parentId,newParentId,childId]}},assignPartner:function(person1,person2,childProperties){var positionsBefore=this.DG.positions.slice(0),ranksBefore=this.DG.ranks.slice(0),vertLevelsBefore=this.DG.vertLevel.copy(),rankYBefore=this.DG.rankY.slice(0),consangrBefore=this.DG.consangr,numNodesBefore=this.DG.GG.getMaxRealVertexId(),rankP1=this.DG.ranks[person1],rankP2=this.DG.ranks[person2];if(rankP1<rankP2||rankP1==rankP2&&this.DG.order.vOrder[person2]<this.DG.order.vOrder[person1]){var tmpPerson=person2;person2=person1,person1=tmpPerson,rankP1=rankP2,rankP2=this.DG.ranks[person2]}var x_person1=this.DG.positions[person1],preferLeft=this.DG.positions[person2]<x_person1,insertRelatOrder=rankP1==rankP2?this._findBestRelationshipPosition(person1,!1,person2):this._findBestRelationshipPosition(person1,preferLeft),relProperties={};childProperties.hasOwnProperty("placeholder")&&childProperties.placeholder&&(relProperties.childlessStatus="Childless");var newRelationshipId=this._insertVertex(BaseGraph.TYPE.RELATIONSHIP,relProperties,1,person1,null,rankP1,insertRelatOrder),insertChildhubRank=this.DG.ranks[newRelationshipId]+1,insertChildhubOrder=this._findBestInsertPosition(insertChildhubRank,newRelationshipId),newChildhubId=this._insertVertex(BaseGraph.TYPE.CHILDHUB,{},1,newRelationshipId,null,insertChildhubRank,insertChildhubOrder),insertChildRank=insertChildhubRank+1,insertChildOrder=this._findBestInsertPosition(insertChildRank,newChildhubId),newChildId=this._insertVertex(BaseGraph.TYPE.PERSON,childProperties,1,newChildhubId,null,insertChildRank,insertChildOrder);return rankP1==rankP2?this.DG.GG.addEdge(person2,newRelationshipId,1):this._addMultiRankEdge(person2,newRelationshipId),this.DG.GG.validate(),this._heuristics.improvePositioning(ranksBefore,rankYBefore),this.updateAncestors(),this._debugPrintAll("after"),{new:[newRelationshipId,newChildId],moved:this._findMovedNodes(numNodesBefore,positionsBefore,ranksBefore,vertLevelsBefore,rankYBefore,consangrBefore),highlight:[person1,person2,newChildId]}},addTwin:function(personId,properties){var positionsBefore=this.DG.positions.slice(0),ranksBefore=this.DG.ranks.slice(0),vertLevelsBefore=this.DG.vertLevel.copy(),rankYBefore=this.DG.rankY.slice(0),numNodesBefore=this.DG.GG.getMaxRealVertexId(),parentRel=this.DG.GG.getProducingRelationship(personId),twinGroupId=this.DG.GG.getTwinGroupId(personId);null===twinGroupId&&(twinGroupId=this.DG.GG.getUnusedTwinGroupId(parentRel),console.log("new twin id: "+twinGroupId),this.DG.GG.properties[personId].twinGroup=twinGroupId),properties.twinGroup=twinGroupId;var insertRank=this.DG.ranks[personId],insertOrder=this.DG.findBestTwinInsertPosition(personId,[]),childhubId=this.DG.GG.getInEdges(personId)[0],newNodeId=this._insertVertex(BaseGraph.TYPE.PERSON,properties,1,childhubId,null,insertRank,insertOrder);this.DG.GG.validate(),this._heuristics.improvePositioning(ranksBefore,rankYBefore);var movedNodes=this._findMovedNodes(numNodesBefore,positionsBefore,ranksBefore,vertLevelsBefore,rankYBefore);Helpers.arrayContains(movedNodes,parentRel)||movedNodes.push(parentRel);var animateNodes=this.DG.GG.getInEdges(parentRel).slice(0);return animateNodes.push(personId),{new:[newNodeId],moved:movedNodes,animate:animateNodes}},convertPlaceholderTo:function(placeholderId,childParams){var positionsBefore=this.DG.positions.slice(0),ranksBefore=this.DG.ranks.slice(0),vertLevelsBefore=this.DG.vertLevel.copy(),rankYBefore=this.DG.rankY.slice(0),numNodesBefore=this.DG.GG.getMaxRealVertexId();if(!this.isPlaceholder(placeholderId))throw"Attemp to access a non-paceholder node as a placeholder";childParams.hasOwnProperty("gender")||(childParams.gender="U"),this.setProperties(placeholderId,childParams),this._heuristics.improvePositioning(ranksBefore,rankYBefore);for(var moved=[this.getParentRelationship(placeholderId)],rank=this.DG.ranks[placeholderId],order=0;order<this.DG.order.order[rank].length-1;order++){var v=this.DG.order.order[rank][order];this.DG.GG.isRelationship(v)&&!Helpers.arrayContains(moved,v)&&moved.push(v)}var movedNodes=this._findMovedNodes(numNodesBefore,positionsBefore,ranksBefore,vertLevelsBefore,rankYBefore);return moved=moved.concat(movedNodes),moved=Helpers.filterUnique(moved),Helpers.removeFirstOccurrenceByValue(moved,placeholderId),{removed:[placeholderId],new:[placeholderId],moved:moved}},removeNodes:function(nodeList){this._debugPrintAll("before");var oldMaxID=this.getMaxNodeId(),removed=nodeList.slice(0);removed.sort();for(var moved=[],i=0;i<nodeList.length;i++)if(this.isRelationship(nodeList[i])){var chHub=this.DG.GG.getOutEdges(nodeList[i])[0];nodeList.push(chHub);for(var pathToParents=this.getPathToParents(nodeList[i]),p=0;p<pathToParents.length;p++)for(var j=0;j<pathToParents[p].length;j++)this.DG.GG.isVirtual(pathToParents[p][j])&&nodeList.push(pathToParents[p][j])}nodeList.sort(function(a,b){return a-b});var changedIDSet={};for(i=nodeList.length-1;0<=i;i--){var v=nodeList[i];this.DG.GG.remove(v),this.DG.order.remove(v,this.DG.ranks[v]),this.DG.ranks.splice(v,1),this.DG.positions.splice(v,1);for(var u=v+1;u<=oldMaxID;u++)changedIDSet.hasOwnProperty(u)?changedIDSet[u]--:changedIDSet[u]=u-1}this.DG.maxRank=Math.max.apply(null,this.DG.ranks),this.DG.GG.validate(),this.DG.vertLevel=this.DG.positionVertically(),this.updateAncestors();for(i=0;i<=this.getMaxNodeId();i++)this.isRelationship(i)&&moved.push(i);return{removed:removed,changedIDSet:changedIDSet,moved:moved}},improvePosition:function(){var positionsBefore=this.DG.positions.slice(0),ranksBefore=this.DG.ranks.slice(0),vertLevelsBefore=this.DG.vertLevel.copy(),rankYBefore=this.DG.rankY.slice(0),numNodesBefore=this.DG.GG.getMaxRealVertexId();return this._heuristics.improvePositioning(ranksBefore,rankYBefore),{moved:this._findMovedNodes(numNodesBefore,positionsBefore,ranksBefore,vertLevelsBefore,rankYBefore)}},updateYPositioning:function(){var positionsBefore=this.DG.positions,ranksBefore=this.DG.ranks,vertLevelsBefore=this.DG.vertLevel,rankYBefore=this.DG.rankY.slice(0),numNodesBefore=this.DG.GG.getMaxRealVertexId();this.DG.rankY=this.DG.computeRankY(ranksBefore,rankYBefore);var movedNodes=this._findMovedNodes(numNodesBefore,positionsBefore,ranksBefore,vertLevelsBefore,rankYBefore,null,!0);return 0==movedNodes.length?{}:{moved:movedNodes}},clearAll:function(){var removedNodes=this._getAllNodes(1),emptyGraph=0==this.DG.GG.getNumVertices(),node0properties=emptyGraph?{}:this.getProperties(0),baseGraph=PedigreeImport.initFromPhenotipsInternal(this._onlyProbandGraph);return this._recreateUsingBaseGraph(baseGraph),this.setProperties(0,node0properties),emptyGraph?{new:[0],makevisible:[0]}:{removed:removedNodes,moved:[0],makevisible:[0]}},redrawAll:function(removedBeforeRedrawList,animateList,newList,ranksBefore){ranksBefore=ranksBefore||this.DG.ranks.slice(0);this._debugPrintAll("before");for(var baseGraph=this.DG.GG.makeGWithCollapsedMultiRankEdges(),oldRanks=Helpers.clone2DArray(this.DG.order.order),i=oldRanks.length-1;0<=i;i--)oldRanks[i]=oldRanks[i].filter(this.DG.GG.isPerson.bind(this.DG.GG)),0==oldRanks[i].length&&oldRanks.splice(i,1);if(!this._recreateUsingBaseGraph(baseGraph,oldRanks))return{};var movedNodes=this._getAllNodes(),probandReRankSize=ranksBefore[0]-this.DG.ranks[0],reRankedDiffFrom0=[],reRanked=[];for(i=0;i<=this.DG.GG.getMaxRealVertexId();i++)this.DG.GG.isPerson(i)&&(this.DG.ranks[i]!=ranksBefore[i]&&reRanked.push(i),ranksBefore[i]-this.DG.ranks[i]!=probandReRankSize&&reRankedDiffFrom0.push(i));if(reRankedDiffFrom0.length<reRanked.length&&(reRanked=reRankedDiffFrom0),animateList||(animateList=[]),removedBeforeRedrawList||(removedBeforeRedrawList=[]),newList)for(i=0;i<newList.length;i++)Helpers.removeFirstOccurrenceByValue(movedNodes,newList[i]);else newList=[];return this._debugPrintAll("after"),{new:newList,moved:movedNodes,highlight:reRanked,animate:animateList,removed:removedBeforeRedrawList}},stripUnusedProperties:function(){for(var i=0;i<=this.DG.GG.getMaxRealVertexId();i++)this.isPerson(i)&&(this.deleteEmptyProperty(i,"fName"),this.deleteEmptyProperty(i,"lName"),this.deleteEmptyProperty(i,"gestationAgeDays"),this.deleteEmptyProperty(i,"gestationAgeWeeks"),this.deleteEmptyProperty(i,"carrierStatus"),this.deleteEmptyProperty(i,"comments"),this.deleteEmptyProperty(i,"disorders"))},deleteEmptyProperty:function(nodeID,propName){this.DG.GG.properties[nodeID].hasOwnProperty(propName)&&("[object Array]"===Object.prototype.toString.call(this.DG.GG.properties[nodeID][propName])&&0==this.DG.GG.properties[nodeID][propName].length?delete this.DG.GG.properties[nodeID][propName]:""==this.DG.GG.properties[nodeID][propName]&&delete this.DG.GG.properties[nodeID][propName])},toJSONObject:function(){this.stripUnusedProperties();var output={};return output.GG=this.DG.GG.serialize(),output.ranks=this.DG.ranks,output.order=this.DG.order.serialize(),output.positions=this.DG.positions,output},fromJSONObject:function(jsonData){var removedNodes=this._getAllNodes();return this.DG.GG=PedigreeImport.initFromPhenotipsInternal(jsonData.GG),this.DG.ranks=jsonData.ranks,this.DG.maxRank=Math.max.apply(null,this.DG.ranks),this.DG.order.deserialize(jsonData.order),this.DG.positions=jsonData.positions,this._updateauxiliaryStructures(),this.screenRankShift=0,{new:this._getAllNodes(),removed:removedNodes}},fromImport:function(importString,importType,importOptions){var removedNodes=this._getAllNodes();if("ped"==importType){var baseGraph=PedigreeImport.initFromPED(importString,importOptions.acceptUnknownPhenotypes,importOptions.markEvaluated,importOptions.externalIdMark);if(!this._recreateUsingBaseGraph(baseGraph))return null}else if("BOADICEA"==importType){baseGraph=PedigreeImport.initFromBOADICEA(importString,importOptions.externalIdMark);if(!this._recreateUsingBaseGraph(baseGraph))return null}else if("gedcom"==importType){baseGraph=PedigreeImport.initFromGEDCOM(importString,importOptions.markEvaluated,importOptions.externalIdMark);if(!this._recreateUsingBaseGraph(baseGraph))return null}else if("simpleJSON"==importType){baseGraph=PedigreeImport.initFromSimpleJSON(importString);if(!this._recreateUsingBaseGraph(baseGraph))return null}return{new:this._getAllNodes(),removed:removedNodes,unRendered:baseGraph.unRenderedNodes}},getPathToParents:function(v){return this.DG.GG.getPathToParents(v)},_recreateUsingBaseGraph:function(baseGraph,suggestedRanks){try{var newDG=new PositionedGraph(baseGraph,this.DG.horizontalPersonSeparationDist,this.DG.horizontalRelSeparationDist,this.DG.maxInitOrderingBuckets,this.DG.maxOrderingIterations,this.DG.maxXcoordIterations,!1,suggestedRanks)}catch(e){return!1}return this.DG=newDG,this._heuristics=new Heuristics(this.DG),this._heuristics.improvePositioning(),!0},_insertVertex:function(type,properties,edgeWeights,inedge,outedge,insertRank,insertOrder){if(null===inedge&&null===outedge)throw"Assertion failed: each node should be connected to at least one other node";if(null!==inedge&&null!==outedge)throw"Assertion failed: not clear which edge crossing to optimize, can only insert one edge";var inedges=null!==inedge?[inedge]:[],outedges=null!==outedge?[outedge]:[],newNodeId=this.DG.GG.insertVertex(type,properties,edgeWeights,inedges,outedges);if(0==insertRank){for(var i=0;i<this.DG.ranks.length;i++)this.DG.ranks[i]++;this.DG.maxRank++,this.DG.order.insertRank(1),insertRank=1}else insertRank>this.DG.maxRank&&(this.DG.maxRank=insertRank,this.DG.order.insertRank(insertRank));this.DG.ranks.splice(newNodeId,0,insertRank),this.DG.order.insertAndShiftAllIdsAboveVByOne(newNodeId,insertRank,insertOrder),this.DG.positions.splice(newNodeId,0,-1/0);var nodeToKeepEdgeStraightTo=null!=inedge?inedge:outedge;return this._heuristics.moveToCorrectPositionAndMoveOtherNodesAsNecessary(newNodeId,nodeToKeepEdgeStraightTo),newNodeId},_updateauxiliaryStructures:function(ranksBefore,rankYBefore){var timer=new Helpers.Timer;this.DG.vertLevel=this.DG.positionVertically(),this.DG.rankY=this.DG.computeRankY(ranksBefore,rankYBefore),this.updateAncestors(),timer.printSinceLast("=== Vertical spacing + ancestors runtime: ")},_getAllNodes:function(minID,maxID){for(var nodes=[],i=(minID=minID||0,maxID=maxID?Math.min(maxID,this.DG.GG.getMaxRealVertexId()):this.DG.GG.getMaxRealVertexId(),minID);i<=maxID;i++)this.DG.GG.type[i]!=BaseGraph.TYPE.PERSON&&this.DG.GG.type[i]!=BaseGraph.TYPE.RELATIONSHIP||nodes.push(i);return nodes},_findMovedNodes:function(maxOldID,positionsBefore,ranksBefore,vertLevelsBefore,rankYBefore,consangrBefore,fastCheck){var oldMin=Math.min.apply(Math,positionsBefore);if(oldMin<Math.min.apply(Math,this.DG.positions)){var oldMinNodeID=Helpers.arrayIndexOf(positionsBefore,oldMin);maxOldID<oldMinNodeID&&(oldMinNodeID+=this.DG.GG.getMaxRealVertexId()-maxOldID);for(var shiftAmount=this.DG.positions[oldMinNodeID]-oldMin,i=0;i<this.DG.positions.length;i++)this.DG.positions[i]-=shiftAmount}var result={};for(i=0;i<=maxOldID;i++)if(this.DG.GG.type[i]==BaseGraph.TYPE.RELATIONSHIP||this.DG.GG.type[i]==BaseGraph.TYPE.PERSON){var rank=this.DG.ranks[i];if(rankYBefore&&this.DG.rankY[rank]!=rankYBefore[ranksBefore[i]]){this._addNodeAndAssociatedRelationships(i,result,maxOldID);continue}if(this.DG.positions[i]!=positionsBefore[i]){this._addNodeAndAssociatedRelationships(i,result,maxOldID);continue}if(this.DG.GG.type[i]==BaseGraph.TYPE.RELATIONSHIP){if(consangrBefore&&!consangrBefore.hasOwnProperty(i)&&this.DG.consangr.hasOwnProperty(i)){result[i]=!0;continue}if(!fastCheck){var inEdges=this.DG.GG.getInEdges(i);if(inEdges[0]>this.DG.GG.maxRealVertexId||inEdges[1]>this.DG.GG.maxRealVertexId){result[i]=!0;continue}}var parents=this.DG.GG.getParents(i);if(void 0!==vertLevelsBefore.outEdgeVerticalLevel[parents[0]]&&void 0!==vertLevelsBefore.outEdgeVerticalLevel[parents[1]]&&(vertLevelsBefore.outEdgeVerticalLevel[parents[0]][i].verticalLevel!=this.DG.vertLevel.outEdgeVerticalLevel[parents[0]][i].verticalLevel||vertLevelsBefore.outEdgeVerticalLevel[parents[1]][i].verticalLevel!=this.DG.vertLevel.outEdgeVerticalLevel[parents[1]][i].verticalLevel)){result[i]=!0;continue}var childHub=this.DG.GG.getRelationshipChildhub(i);if(void 0!==vertLevelsBefore.childEdgeLevel[childHub]&&vertLevelsBefore.childEdgeLevel[childHub]!=this.DG.vertLevel.childEdgeLevel[childHub]){result[i]=!0;continue}}}for(i=this.DG.GG.getMaxRealVertexId()+1;i<=this.DG.GG.getNumVertices();i++){rank=this.DG.ranks[i];if(rankYBefore&&rankYBefore.length>=rank&&this.DG.rankY[rank]!=rankYBefore[rank]){var relationship=this.DG.GG.downTheChainUntilNonVirtual(i);relationship<=maxOldID&&(result[relationship]=!0)}}var resultArray=[];for(var node in result)result.hasOwnProperty(node)&&resultArray.push(parseInt(node));return resultArray},_addNodeAndAssociatedRelationships:function(node,addToSet,maxOldID){if(addToSet[node]=!0,this.DG.GG.type[node]==BaseGraph.TYPE.PERSON){var inEdges=this.DG.GG.getInEdges(node);if(0<inEdges.length){var parentChildhub=inEdges[0],parentRelationship=this.DG.GG.getInEdges(parentChildhub)[0];parentRelationship<=maxOldID&&(addToSet[parentRelationship]=!0)}for(var outEdges=this.DG.GG.getOutEdges(node),i=0;i<outEdges.length;i++)outEdges[i]<=maxOldID&&(addToSet[outEdges[i]]=!0)}},_addMultiRankEdge:function(personId,relationshipId,_weight){var weight=_weight||1,rankPerson=this.DG.ranks[personId],rankRelationship=this.DG.ranks[relationshipId];if(rankRelationship-2<rankPerson)throw"Assertion failed: attempt to make a multi-rank edge between non-multirank ranks";for(var otherpartner=this.DG.GG.getInEdges(relationshipId)[0],order_rel=(this.DG.order.vOrder[personId],this.DG.order.vOrder[relationshipId]),prevPieceOrder=this.DG.positions[otherpartner]<this.DG.positions[relationshipId]?order_rel+1:order_rel,prevPieceId=this._insertVertex(BaseGraph.TYPE.VIRTUALEDGE,{},weight,null,relationshipId,rankRelationship,prevPieceOrder),rankNext=rankRelationship;--rankNext>rankPerson;){for(var prevNodeX=this.DG.positions[prevPieceId],orderToMakeEdgeStraight=this.DG.order.order[rankNext].length,o=0;o<this.DG.order.order[rankNext].length;o++)if(this.DG.positions[this.DG.order.order[rankNext][o]]>=prevNodeX){orderToMakeEdgeStraight=o;break}console.log("adding piece @ rank: "+rankNext+" @ order "+orderToMakeEdgeStraight),prevPieceId=this._insertVertex(BaseGraph.TYPE.VIRTUALEDGE,{},weight,null,prevPieceId,rankNext,orderToMakeEdgeStraight)}this.DG.GG.addEdge(personId,prevPieceId,weight)},_findBestInsertPosition:function(rank,edgeToV,preferLeft,_fromOrder,_toOrder){if(0==rank||rank>this.DG.maxRank)return 0;var edgeToRank=this.DG.ranks[edgeToV],edgeToOrder=this.DG.order.vOrder[edgeToV];if(edgeToRank==rank&&this.isPerson(edgeToV))return this._findBestRelationshipPosition(edgeToV,preferLeft);var bestInsertOrder=0,bestCrossings=1/0,bestDistance=1/0,crossingChildhubEdgesPenalty=!1;this.DG.GG.type[edgeToV]==BaseGraph.TYPE.CHILDHUB&&(crossingChildhubEdgesPenalty=!0);for(var desiredOrder=0,edgeToX=this.DG.positions[edgeToV],o=0;o<this.DG.order.order[rank].length;o++){var uAtPos=this.DG.order.order[rank][o];if(!(this.DG.positions[uAtPos]<edgeToX))break;desiredOrder=o+1}this.DG.GG.type[edgeToV]==BaseGraph.TYPE.CHILDHUB&&edgeToRank<rank&&0<this.DG.GG.getOutEdges(edgeToV).length&&(desiredOrder=this._findRightmostChildPosition(edgeToV)+1);var fromOrder=_fromOrder?Math.max(_fromOrder,0):0,toOrder=_toOrder?Math.min(_toOrder,this.DG.order.order[rank].length):this.DG.order.order[rank].length;for(o=fromOrder;o<=toOrder;o++){if(0<o&&o<this.DG.order.order[rank].length){for(var leftNodePos=o-1;0<leftNodePos&&this.DG.GG.isVirtual(this.DG.order.order[rank][leftNodePos]);)leftNodePos--;for(rightNodePos=o;rightNodePos<this.DG.order.order[rank].length-1&&this.DG.GG.isVirtual(this.DG.order.order[rank][rightNodePos]);)rightNodePos--;var nodeToTheLeft=this.DG.order.order[rank][leftNodePos],nodeToTheRight=this.DG.order.order[rank][rightNodePos];if(this.isPerson(nodeToTheLeft)&&this.isPerson(nodeToTheRight))if(this.DG.GG.getProducingRelationship(nodeToTheLeft)==this.DG.GG.getProducingRelationship(nodeToTheRight)){var twinGroupId1=this.DG.GG.getTwinGroupId(nodeToTheLeft),twinGroupId2=this.DG.GG.getTwinGroupId(nodeToTheRight);if(null!==twinGroupId1&&twinGroupId1==twinGroupId2)continue}}var numCrossings=this._edgeCrossingsByFutureEdge(rank,o-.5,edgeToRank,edgeToOrder,crossingChildhubEdgesPenalty,edgeToV);(numCrossings<bestCrossings||numCrossings==bestCrossings&&Math.abs(o-desiredOrder)<=bestDistance)&&(bestInsertOrder=o,bestCrossings=numCrossings,bestDistance=Math.abs(o-desiredOrder))}return bestInsertOrder},_findRightmostChildPosition:function(vertex){return this._heuristics.analizeChildren(vertex).rightMostChildOrder},_edgeCrossingsByFutureEdge:function(newVRank,newVOrder,existingURank,existingUOrder,crossingChildhubEdgesPenalty,existingU){var rankFrom=Math.min(newVRank,existingURank),rankTo=Math.max(newVRank,existingURank),orderFrom=newVRank<existingURank?newVOrder:existingUOrder,orderTo=newVRank<existingURank?existingUOrder:newVOrder,vSibglingInfo=void 0;if(this.DG.GG.isChildhub(existingU)&&existingURank<newVRank&&0<this.DG.GG.getOutEdges(existingU).length&&(vSibglingInfo=this._heuristics.analizeChildren(existingU)).numWithTwoPartners<vSibglingInfo.orderedChildren.length){var okPosition=!1;if(0<newVOrder){var leftNeighbour=this.DG.order.order[newVRank][Math.floor(newVOrder)];1==(neighbourInEdges=this.DG.GG.getInEdges(leftNeighbour)).length&&neighbourInEdges[0]==existingU&&(okPosition=!0)}if(newVOrder<this.DG.order.order[newVRank].length-1){var neighbourInEdges,rightNeighbour=this.DG.order.order[newVRank][Math.ceil(newVOrder)];1==(neighbourInEdges=this.DG.GG.getInEdges(rightNeighbour)).length&&neighbourInEdges[0]==existingU&&(okPosition=!0)}if(!okPosition)return 1/0}var crossings=0;if(rankFrom==rankTo)throw"TODO: probably not needed";for(var verticesAtRankTo=this.DG.order.order[rankTo],ord=0;ord<verticesAtRankTo.length;ord++)if(ord!=orderTo)for(var vertex=verticesAtRankTo[ord],inEdges=this.DG.GG.getInEdges(vertex),len=inEdges.length,j=0;j<len;j++){var target=inEdges[j],penalty=1;if(crossingChildhubEdgesPenalty&&this.DG.GG.isChildhub(target)&&(penalty=1e5,vSibglingInfo)){var targetChildren=this._heuristics.analizeChildren(target);targetChildren.leftMostChildOrder<vSibglingInfo.rightMostChildOrder&&targetChildren.rightMostChildOrder>vSibglingInfo.leftMostChildOrder&&(penalty=1)}var orderTarget=this.DG.order.vOrder[target];this.DG.ranks[target]==rankTo?(ord<orderTo&&orderTo<orderTarget||orderTo<ord&&orderTarget<orderTo)&&(crossings+=2):(ord<orderTo&&orderFrom<orderTarget||orderTo<ord&&orderTarget<orderFrom)&&(crossings+=penalty)}var verticesAtNewRank=this.DG.order.order[newVRank];for(ord=0;ord<verticesAtNewRank.length;ord++)if(ord!=newVOrder){vertex=verticesAtNewRank[ord];var outEdges=this.DG.GG.getOutEdges(vertex);for(len=outEdges.length,j=0;j<len;j++){target=outEdges[j],orderTarget=this.DG.order.vOrder[target];this.DG.ranks[target]==newVRank&&(newVOrder<ord&&orderTarget<newVOrder||ord<newVOrder&&newVOrder<orderTarget)&&(crossings+=.1)}}return crossings},_findBestRelationshipPosition:function(v,preferLeft,u){for(var rank=this.DG.ranks[v],orderR=this.DG.order.order[rank],isTwin=null!=this.DG.GG.getTwinGroupId(v),vOrder=this.DG.order.vOrder[v],penaltyBelow=[],penaltySameRank=[],o=0;o<=orderR.length;o++)penaltyBelow[o]=0,penaltySameRank[o]=0;for(o=0;o<orderR.length;o++){var node=orderR[o];if(this.isRelationship(node)){var childrenInfo=this._heuristics.analizeChildren(node);childrenInfo.leftMostHasLParner&&(penaltyBelow[o]+=1,penaltyBelow[o-1]+=.25),childrenInfo.rightMostHasRParner&&(penaltyBelow[o+1]+=1,penaltyBelow[o+2]+=.25)}}for(o=0;o<orderR.length;o++){node=orderR[o];if(this.isRelationship(node))for(var relOrder=this.DG.order.vOrder[node],parents=this.DG.GG.getInEdges(node),p=0;p<parents.length;p++){var parent=parents[p];if(parent!=v&&this.DG.ranks[parent]==rank&&parent!=u)for(var parentOrder=this.DG.order.vOrder[parent],to=relOrder<parentOrder?parentOrder:relOrder,j=relOrder<parentOrder?relOrder+1:parentOrder+1;j<=to;j++)penaltySameRank[j]=1/0}}for(o=0;o<orderR.length;o++)if(o!=vOrder){node=orderR[o];if(this.isPerson(node)){var allTwins=this.getAllTwinsSortedByOrder(node);if(1<allTwins.length){var leftMostTwinOrder=this.DG.order.vOrder[allTwins[0]],rightMostTwinOrder=this.DG.order.vOrder[allTwins[allTwins.length-1]];for(j=leftMostTwinOrder+1;j<=rightMostTwinOrder;j++)penaltySameRank[j]=1/0;o=rightMostTwinOrder}if(null!=this.DG.GG.getProducingRelationship(node))if(o<vOrder)for(j=0;j<=o;j++)penaltySameRank[j]++;else for(j=o+1;j<=orderR.length;j++)penaltySameRank[j]++}}if(console.log("Insertion same rank penalties: "+Helpers.stringifyObject(penaltySameRank)),console.log("Insertion below penalties:     "+Helpers.stringifyObject(penaltyBelow)),void 0===u){if(preferLeft&&0==vOrder)return 0;var partnerInfo=this.DG._findLeftAndRightPartners(v),numLeftOf=partnerInfo.leftPartners.length,numRightOf=partnerInfo.rightPartners.length;if(console.log("v: "+v+", vOrder: "+vOrder+", numL: "+numLeftOf+", numR: "+numRightOf),!isTwin&&0==numLeftOf&&(preferLeft||0<numRightOf))return vOrder;if(!isTwin&&0==numRightOf)return vOrder+1;var bestPosition=vOrder+1,bestPenalty=1/0;for(o=0;o<=orderR.length;o++){var penalty=penaltyBelow[o]+penaltySameRank[o];o<=vOrder?(penalty+=numLeftOf+(vOrder-o),preferLeft?penalty-=.5:penalty+=.5):penalty+=numRightOf+(o-vOrder-1),penalty<bestPenalty&&(bestPenalty=penalty,bestPosition=o)}return bestPosition}if(this.DG.order.vOrder[v]>this.DG.order.vOrder[u]){var tmp=u;u=v,v=tmp}var orderV=this.DG.order.vOrder[v],orderU=this.DG.order.vOrder[u],partnerInfoV=this.DG._findLeftAndRightPartners(v),partnerInfoU=(numRightOf=partnerInfoV.rightPartners.length,this.DG._findLeftAndRightPartners(u));numLeftOf=partnerInfoU.leftPartners.length;if(0==numRightOf&&0<numLeftOf)return orderV+1;if(0<numRightOf&&0==numLeftOf)return orderU;for(bestPosition=orderV+1,bestPenalty=1/0,o=orderV+1;o<=orderU;o++){for(penalty=penaltyBelow[o]+penaltySameRank[o],p=0;p<partnerInfoV.rightPartners.length;p++){var partner=partnerInfoV.rightPartners[p];o<=this.DG.order.vOrder[partner]&&penalty++}for(p=0;p<partnerInfoU.leftPartners.length;p++){partner=partnerInfoU.leftPartners[p];o>this.DG.order.vOrder[partner]&&penalty++}penalty<=bestPenalty&&(bestPenalty=penalty,bestPosition=o)}return bestPosition},_getAllPersonsOfGenders:function(validGendersSet,excludeAdoptedOut){for(var i=0;i<validGendersSet.length;i++)if(validGendersSet[i]=validGendersSet[i].toLowerCase(),"u"!=validGendersSet[i]&&"m"!=validGendersSet[i]&&"f"!=validGendersSet[i]&&"o"!=validGendersSet[i])return console.log("ERROR: Invalid gender: "+validGendersSet[i]),[];var result=[];for(i=0;i<=this.DG.GG.getMaxRealVertexId();i++)if(this.isPerson(i)&&!this.isPersonGroup(i)&&!(this.isPlaceholder(i)||excludeAdoptedOut&&this.isAdoptedOut(i))){var gender=this.getProperties(i).gender.toLowerCase();Helpers.arrayContains(validGendersSet,gender)&&result.push(i)}return result}},Heuristics=function(drawGraph){this.DG=drawGraph},Heuristics.prototype={swapPartnerToBringToSideIfPossible:function(personId){if(null===this.DG.GG.getTwinGroupId(personId)){var rank=this.DG.ranks[personId],order=this.DG.order.vOrder[personId];if(0!=order&&order!=this.DG.order.order[rank].length-1){var parnetships=this.DG.GG.getAllRelationships(personId);if(1==parnetships.length){var relationship=parnetships[0],partners=(this.DG.order.vOrder[relationship],this.DG.GG.getParents(relationship)),partnerId=partners[0]==personId?partners[1]:partners[0];if(1==this.DG.GG.getOutEdges(partnerId).length&&this.DG.ranks[personId]==this.DG.ranks[partnerId]){var partnerOrder=this.DG.order.vOrder[partnerId];if(!(partnerOrder!=order-2&&partnerOrder!=order+2||0!=this.DG.GG.getInEdges(personId).length&&0!=this.DG.GG.getInEdges(partnerId).length)){var childhubId=this.DG.GG.getOutEdges(relationship)[0];if(0!=this.DG.GG.getOutEdges(childhubId).length){var toTheLeft=order<partnerOrder,childrenPartners=this.analizeChildren(childhubId);(toTheLeft&&childrenPartners.leftMostHasLParner&&!childrenPartners.rightMostHasRParner||!toTheLeft&&childrenPartners.rightMostHasRParner&&!childrenPartners.leftMostHasLParner||2==order&&childrenPartners.rightMostHasRParner||order==this.DG.order.order[rank].length-3&&childrenPartners.leftMostHasLParner)&&this.swapPartners(personId,partnerId,relationship)}}}}}}},swapTwinsToBringToSideIfPossible:function(personId){this.DG.GG.getTwinGroupId(personId)},analizeChildren:function(childhubId){if(this.DG.GG.isRelationship(childhubId)&&(childhubId=this.DG.GG.getOutEdges(childhubId)[0]),!this.DG.GG.isChildhub(childhubId))throw"Assertion failed: applying analizeChildren() not to a childhub";var children=this.DG.GG.getOutEdges(childhubId);if(0!=children.length){var havePartners={},numWithPartners=0,numWithTwoPartners=0,leftMostChildId=void 0,leftMostChildOrder=1/0,leftMostHasLParner=!1,rightMostChildId=void 0,rightMostChildOrder=-1/0,rightMostHasRParner=!1,onlyPlaceholder=!1;1==children.length&&this.DG.GG.isPlaceholder(children[0])&&(onlyPlaceholder=!0);for(var i=0;i<children.length;i++){var childId=children[i],order=this.DG.order.vOrder[childId];order<leftMostChildOrder&&(leftMostChildId=childId,leftMostChildOrder=order,leftMostHasLParner=this.hasParnerBetweenOrders(childId,0,order-1)),rightMostChildOrder<order&&(rightMostChildId=childId,rightMostChildOrder=order,rightMostHasRParner=this.hasParnerBetweenOrders(childId,order+1,1/0)),0<this.DG.GG.getOutEdges(childId).length&&(havePartners[childId]=!0,numWithPartners++,1<this.DG.GG.getOutEdges(childId).length&&numWithTwoPartners++)}return{leftMostHasLParner:leftMostHasLParner,leftMostChildId:leftMostChildId,leftMostChildOrder:leftMostChildOrder,rightMostHasRParner:rightMostHasRParner,rightMostChildId:rightMostChildId,rightMostChildOrder:rightMostChildOrder,withPartnerSet:havePartners,numWithPartners:numWithPartners,numWithTwoPartners:numWithTwoPartners,orderedChildren:this.DG.order.sortByOrder(children),onlyPlaceholder:onlyPlaceholder}}},hasParnerBetweenOrders:function(personId,minOrder,maxOrder){for(var rank=this.DG.ranks[personId],outEdges=(this.DG.order.vOrder[personId],this.DG.GG.getOutEdges(personId)),i=0;i<outEdges.length;i++){var relationship=outEdges[i];if(this.DG.ranks[relationship]==rank){var relOrder=this.DG.order.vOrder[relationship];if(minOrder<=relOrder&&relOrder<=maxOrder)return!0}}return!1},swapPartners:function(partner1,partner2,relationshipId){var rank=this.DG.ranks[partner1];if(this.DG.ranks[partner2]!=rank||this.DG.ranks[relationshipId]!=rank)throw"Assertion failed: swapping nodes of different ranks";var order1=this.DG.order.vOrder[partner1],order2=this.DG.order.vOrder[partner2],orderRel=this.DG.order.vOrder[relationshipId];if(order2<order1){var tmpOrder=order1,tmpId=partner1;order1=order2,partner1=partner2,order2=tmpOrder,partner2=tmpId}if(order1+1==orderRel&&orderRel+1==order2){this.DG.order.exchange(rank,order1,order2);var widthDecrease=this.DG.GG.getVertexWidth(partner1)-this.DG.GG.getVertexWidth(partner2),pos2=this.DG.positions[partner2];this.DG.positions[partner2]=this.DG.positions[partner1],this.DG.positions[partner1]=pos2-widthDecrease,this.DG.positions[relationshipId]-=widthDecrease}},moveSiblingPlusPartnerToOrder:function(personId,partnerId,partnershipId,newOrder){var rank=this.DG.ranks[partnerId],partnerOrder=this.DG.order.vOrder[partnerId],personOrder=this.DG.order.vOrder[personId],relOrder=this.DG.order.vOrder[partnershipId],moveOrders=newOrder-personOrder,moveDistance=this.DG.positions[this.DG.order.order[rank][newOrder]]-this.DG.positions[personId],moveRight=personOrder<newOrder,firstSibling=moveRight?this.DG.order.order[rank][personOrder+1]:this.DG.order.order[rank][personOrder-1],moveOtherDist=this.DG.positions[firstSibling]-this.DG.positions[partnerId];this.DG.order.move(rank,personOrder,moveOrders),this.DG.order.move(rank,relOrder,moveOrders),this.DG.order.move(rank,partnerOrder,moveOrders),this.DG.positions[personId]+=moveDistance,this.DG.positions[partnerId]+=moveDistance,this.DG.positions[partnershipId]+=moveDistance;for(var maxMovedOrder=moveRight?newOrder-3:partnerOrder,o=moveRight?partnerOrder:newOrder+3;o<=maxMovedOrder;o++){var node=this.DG.order.order[rank][o];console.log("moving: "+node),this.DG.positions[node]-=moveOtherDist}},swapBeforeParentsToBringToSideIfPossible:function(personId){var parnetships=this.DG.GG.getAllRelationships(personId);if(1==parnetships.length){var relationshipId=parnetships[0],partners=this.DG.GG.getParents(relationshipId),partnerId=partners[0]==personId?partners[1]:partners[0];if(0!=this.DG.GG.getInEdges(partnerId).length&&this.DG.ranks[personId]==this.DG.ranks[partnerId]&&!(1<this.DG.GG.getOutEdges(partnerId).length)){var order=this.DG.order.vOrder[personId],partnerOrder=this.DG.order.vOrder[partnerId];if(partnerOrder==order-2||partnerOrder==order+2){var toTheLeft=order<partnerOrder,partnerChildhubId=this.DG.GG.getInEdges(partnerId)[0],partnerSibglingInfo=this.analizeChildren(partnerChildhubId);if(1<partnerSibglingInfo.orderedChildren.length){if(partnerSibglingInfo.leftMostChildId==partnerId)return void(toTheLeft||this.swapPartners(personId,partnerId,relationshipId));if(partnerSibglingInfo.rightMostChildId==partnerId)return void(toTheLeft&&this.swapPartners(personId,partnerId,relationshipId))}var partnerParents=this.DG.GG.getInEdges(this.DG.GG.getInEdges(partnerChildhubId)[0]),order0=this.DG.order.vOrder[partnerParents[0]],order1=this.DG.order.vOrder[partnerParents[1]],leftParent=order1<order0?partnerParents[1]:partnerParents[0],rightParent=order1<order0?partnerParents[0]:partnerParents[1];console.log("parents: "+Helpers.stringifyObject(partnerParents));var numLeftPartners=this.DG.GG.getOutEdges(leftParent).length,numRightPartners=this.DG.GG.getOutEdges(rightParent).length;if(console.log("num left: "+numLeftPartners+", numRight: "+numRightPartners),!(1<numLeftPartners&&1<numRightPartners)){if(1==partnerSibglingInfo.orderedChildren.length){if(1==numLeftPartners&&1==numRightPartners)return;return 1!=numLeftPartners||toTheLeft||this.swapPartners(personId,partnerId,relationshipId),void(1==numRightPartners&&toTheLeft&&this.swapPartners(personId,partnerId,relationshipId))}var childHubBelow=this.DG.GG.getRelationshipChildhub(relationshipId);if(!(0<this.analizeChildren(childHubBelow).numWithPartners)){if(1==numRightPartners&&!partnerSibglingInfo.rightMostHasRParner)for(var c=partnerSibglingInfo.orderedChildren.length-1;0<=c;c--){if((sibling=partnerSibglingInfo.orderedChildren[c])==partnerId)return toTheLeft&&this.swapPartners(personId,partnerId,relationshipId),void this.moveSiblingPlusPartnerToOrder(personId,partnerId,relationshipId,partnerSibglingInfo.rightMostChildOrder);if(partnerSibglingInfo.withPartnerSet.hasOwnProperty(sibling))break}if(1==numLeftPartners&&!partnerSibglingInfo.leftMostHasLParner)for(c=0;c<partnerSibglingInfo.orderedChildren.length;c++){var sibling;if((sibling=partnerSibglingInfo.orderedChildren[c])==partnerId)return toTheLeft||this.swapPartners(personId,partnerId,relationshipId),void this.moveSiblingPlusPartnerToOrder(personId,partnerId,relationshipId,partnerSibglingInfo.leftMostChildOrder);if(partnerSibglingInfo.withPartnerSet.hasOwnProperty(sibling))break}}}}}}},improvePositioning:function(ranksBefore,rankYBefore){for(var timer=new Helpers.Timer,parent=0;parent<=this.DG.GG.getMaxRealVertexId();parent++)if(this.DG.GG.isPerson(parent)){for(var rank=this.DG.ranks[parent],order=this.DG.order.vOrder[parent],outEdges=this.DG.GG.getOutEdges(parent),sameRankToTheLeft=0,sameRankToTheRight=0,multiRankEdges=[],i=0;i<outEdges.length;i++){var node=outEdges[i];this.DG.ranks[node]!=rank?multiRankEdges.push(node):this.DG.order.vOrder[node]<order?sameRankToTheLeft++:sameRankToTheRight++}if(0!=multiRankEdges.length){var _this=this;byXcoord=function(v1,v2){var rel1=_this.DG.GG.downTheChainUntilNonVirtual(v1),rel2=_this.DG.GG.downTheChainUntilNonVirtual(v2),position1=_this.DG.positions[rel1],position2=_this.DG.positions[rel2],parentPos=_this.DG.positions[parent];return parentPos<=position1&&parentPos<=position2?position2-position1:position1-position2},multiRankEdges.sort(byXcoord),console.log("multi-rank edges: "+Helpers.stringifyObject(multiRankEdges));for(var p=0;p<multiRankEdges.length;p++){var firstOnPath=multiRankEdges[p],relNode=this.DG.GG.downTheChainUntilNonVirtual(firstOnPath),weight=this.DG.GG.removeEdge(parent,firstOnPath),newNodeId=this.DG.GG.insertVertex(BaseGraph.TYPE.VIRTUALEDGE,{},weight,[parent],[firstOnPath]);this.DG.ranks.splice(newNodeId,0,rank);var insertToTheRight=!(this.DG.positions[relNode]<this.DG.positions[parent]);this.DG.positions[relNode]==this.DG.positions[parent]&&0<sameRankToTheRight&&0==sameRankToTheLeft&&1==multiRankEdges.length&&(insertToTheRight=!1);var parentOrder=this.DG.order.vOrder[parent],newOrder=insertToTheRight?parentOrder+1:parentOrder;if(insertToTheRight){for(;newOrder<this.DG.order.order[rank].length&&this.DG.positions[firstOnPath]>this.DG.positions[this.DG.order.order[rank][newOrder]];)newOrder++;var toTheLeft=this.DG.order.order[rank][newOrder-1],toTheRight=this.DG.order.order[rank][newOrder];this.DG.GG.isRelationship(toTheLeft)&&this.DG.GG.isPerson(toTheRight)&&this.DG.GG.hasEdge(toTheRight,toTheLeft)&&1==this.DG.GG.getOutEdges(toTheRight).length&&newOrder++,this.DG.GG.isRelationship(toTheRight)&&this.DG.GG.isPerson(toTheLeft)&&this.DG.GG.hasEdge(toTheLeft,toTheRight)&&1==this.DG.GG.getOutEdges(toTheLeft).length&&newOrder--}else{for(;0<newOrder&&this.DG.positions[firstOnPath]<this.DG.positions[this.DG.order.order[rank][newOrder-1]];)newOrder--;toTheLeft=this.DG.order.order[rank][newOrder-1],toTheRight=this.DG.order.order[rank][newOrder];this.DG.GG.isRelationship(toTheRight)&&this.DG.GG.isPerson(toTheLeft)&&this.DG.GG.hasEdge(toTheLeft,toTheRight)&&1==this.DG.GG.getOutEdges(toTheLeft).length&&newOrder--,this.DG.GG.isRelationship(toTheLeft)&&this.DG.GG.isPerson(toTheRight)&&this.DG.GG.hasEdge(toTheRight,toTheLeft)&&1==this.DG.GG.getOutEdges(toTheRight).length&&newOrder++}this.DG.order.insertAndShiftAllIdsAboveVByOne(newNodeId,rank,newOrder),this.DG.positions.splice(newNodeId,0,-1/0);var nodeToKeepEdgeStraightTo=firstOnPath;this.moveToCorrectPositionAndMoveOtherNodesAsNecessary(newNodeId,nodeToKeepEdgeStraightTo),!0}}}this.optimizeLongEdgePlacement(),timer.printSinceLast("=== Long edge handling runtime: ");for(var xcoord=new XCoord(this.DG.positions,this.DG),v=0;v<=this.DG.GG.getMaxRealVertexId();v++)if(this.DG.GG.isRelationship(v)){var childhub=this.DG.GG.getRelationshipChildhub(v),relX=xcoord.xcoord[v];(childhubX=xcoord.xcoord[childhub])!=relX&&(improved=xcoord.moveNodeAsCloseToXAsPossible(childhub,relX))}for(v=0;v<=this.DG.GG.getMaxRealVertexId();v++)if(this.DG.GG.isChildhub(v)){var children=this.DG.GG.getOutEdges(v);if(!(children.length<2)){var orderedChildren=this.DG.order.sortByOrder(children);for(i=orderedChildren.length-1;0<=i;i--)if(0==i||0<this.DG.GG.getOutEdges(orderedChildren[i]).length){for(var j=i+1;j<orderedChildren.length;j++)xcoord.shiftLeftOneVertex(orderedChildren[j],1/0);break}for(i=0;i<orderedChildren.length;i++)if(i==orderedChildren.length-1||0<this.DG.GG.getOutEdges(orderedChildren[i]).length){for(j=i-1;0<=j;j--)xcoord.shiftRightOneVertex(orderedChildren[j],1/0);break}}}this._compactGraph(xcoord,5);for(var orderedRelationships=this.DG.order.getLeftToRightTopToBottomOrdering(BaseGraph.TYPE.RELATIONSHIP,this.DG.GG),iter=0,improved=!0;improved&&iter<20;){improved=!1,iter++;for(var k=0;k<orderedRelationships.length;k++){v=orderedRelationships[k];var parents=this.DG.GG.getInEdges(v),childhubX=(childhub=this.DG.GG.getRelationshipChildhub(v),relX=xcoord.xcoord[v],xcoord.xcoord[childhub]),childInfo=this.analizeChildren(childhub),misalignment=0;if(1==childInfo.orderedChildren.length){var childId=childInfo.orderedChildren[0];if(xcoord.xcoord[childId]==childhubX)continue;if(improved=xcoord.moveNodeAsCloseToXAsPossible(childId,childhubX),xcoord.xcoord[childId]==childhubX)continue;misalignment=xcoord.xcoord[childId]-childhubX}else{var positionInfo=this._computeDesiredChildhubLocation(childInfo,xcoord);if(positionInfo.minPreferred<=childhubX&&childhubX<=positionInfo.maxPreferred)continue;var needToShift=childhubX-(childhubX>positionInfo.maxPreferred?positionInfo.maxPreferred:positionInfo.minPreferred);if(0==childInfo.numWithPartners)if(needToShift<0){var leftMost=childInfo.leftMostChildId,leftSlack=xcoord.getSlackOnTheLeft(leftMost);if(0<(haveSlack=Math.min(Math.abs(needToShift),leftSlack))){for(i=0;i<childInfo.orderedChildren.length;i++)xcoord.xcoord[childInfo.orderedChildren[i]]-=haveSlack;improved=!0,needToShift+=haveSlack}}else{var haveSlack,rightMost=childInfo.rightMostChildId,rightSlack=xcoord.getSlackOnTheRight(rightMost);if(0<(haveSlack=Math.min(needToShift,rightSlack))){for(i=0;i<childInfo.orderedChildren.length;i++)xcoord.xcoord[childInfo.orderedChildren[i]]+=haveSlack;improved=!0,needToShift-=haveSlack}}misalignment=-needToShift}if(0!=misalignment){var leftParent=xcoord.xcoord[parents[0]]<xcoord.xcoord[parents[1]]?parents[0]:parents[1],rightParent=xcoord.xcoord[parents[0]]<xcoord.xcoord[parents[1]]?parents[1]:parents[0],shiftList=[v,childhub];this.DG.order.vOrder[leftParent]!=this.DG.order.vOrder[v]-1||this.DG.GG.isVirtual(leftParent)||(0<misalignment||xcoord.getSlackOnTheLeft(v)<-misalignment)&&shiftList.unshift(leftParent),this.DG.order.vOrder[rightParent]!=this.DG.order.vOrder[v]+1||this.DG.GG.isVirtual(rightParent)||(misalignment<0||xcoord.getSlackOnTheRight(v)<misalignment)&&shiftList.push(rightParent),(noUpSet={})[v]=!0;var affectedInfoParentShift=this._findAffectedSet(shiftList,{},noUpSet,Helpers.toObjectWithTrue(shiftList),Helpers.toObjectWithTrue(childInfo.orderedChildren),misalignment,xcoord,!0,!1,7,3),forbiddenList=(shiftList=childInfo.orderedChildren,[v,childhub]),affectedInfoChildShift=this._findAffectedSet(shiftList,{},Helpers.toObjectWithTrue(childInfo.orderedChildren),{},Helpers.toObjectWithTrue(forbiddenList),-misalignment,xcoord,!0,!1,7,3),parentShiftAcceptable=this._isShiftSizeAcceptable(affectedInfoParentShift,!1,7,3),childShiftAcceptable=this._isShiftSizeAcceptable(affectedInfoChildShift,!1,7,3);if(parentShiftAcceptable||childShiftAcceptable)if(improved=!0,!parentShiftAcceptable||childShiftAcceptable&&!this._isShiftBetter(affectedInfoParentShift,affectedInfoChildShift))for(nodes=affectedInfoChildShift.nodes,i=0;i<nodes.length;i++)xcoord.xcoord[nodes[i]]-=misalignment;else for(var nodes=affectedInfoParentShift.nodes,i=0;i<nodes.length;i++)xcoord.xcoord[nodes[i]]+=misalignment;else{if(misalignment<0){var leftShiftingNode=this.DG.order.vOrder[leftParent]==this.DG.order.vOrder[v]-1?leftParent:v;if(0==(smallShift=Math.max(-xcoord.getSlackOnTheLeft(leftShiftingNode),misalignment))||smallShift==misalignment)continue}else{var smallShift,rightShiftingNode=this.DG.order.vOrder[rightParent]==this.DG.order.vOrder[v]+1?rightParent:v;if(0==(smallShift=Math.min(xcoord.getSlackOnTheLeft(rightShiftingNode),misalignment))||smallShift==misalignment)continue}shiftList=[v,childhub];this.DG.order.vOrder[leftParent]!=this.DG.order.vOrder[v]-1||this.DG.GG.isVirtual(leftParent)||shiftList.unshift(leftParent),this.DG.order.vOrder[rightParent]!=this.DG.order.vOrder[v]+1||this.DG.GG.isVirtual(rightParent)||shiftList.push(rightParent),(noUpSet={})[v]=!0;affectedInfoParentShift=this._findAffectedSet(shiftList,{},noUpSet,Helpers.toObjectWithTrue(shiftList),Helpers.toObjectWithTrue(childInfo.orderedChildren),smallShift,xcoord,!0,!1,3,2);if(this._isShiftSizeAcceptable(affectedInfoParentShift,!1,3,2))for(nodes=affectedInfoParentShift.nodes,i=0;i<nodes.length;i++)xcoord.xcoord[nodes[i]]+=smallShift;else;}}}}this._compactGraph(xcoord);for(iter=0,improved=!0;improved&&iter<20;){improved=!1,iter++;for(k=0;k<orderedRelationships.length;k++){v=orderedRelationships[k],parents=this.DG.GG.getInEdges(v);var orderedParents=this.DG.order.sortByOrder(parents);if(2==Math.abs(this.DG.order.vOrder[parents[0]]-this.DG.order.vOrder[parents[1]])){var leftParentRightSide=xcoord.getRightEdge(orderedParents[0]),rightParentLeftSide=xcoord.getLeftEdge(orderedParents[1]),midX=(relX=xcoord.xcoord[v],Math.floor((leftParentRightSide+rightParentLeftSide)/2));if(relX!=midX){var noUpSet,shiftSize=midX-relX;shiftList=[v,childhub=this.DG.GG.getRelationshipChildhub(v)];(noUpSet={})[v]=!0;var affectedInfo=this._findAffectedSet(shiftList,{},noUpSet,{},{},shiftSize,xcoord,!0,!1,5,3,this.DG.ranks[v]);if(this._isShiftSizeAcceptable(affectedInfo,!1,5,3)&&affectedInfo.minAffectedRank>this.DG.ranks[v]){for(nodes=affectedInfo.nodes,i=0;i<nodes.length;i++)xcoord.xcoord[nodes[i]]+=shiftSize;improved=!0}}}}}this.DG.positions=xcoord.xcoord,timer.printSinceLast("=== Improvement runtime: "),this.DG.vertLevel=this.DG.positionVertically(),this.DG.rankY=this.DG.computeRankY(ranksBefore,rankYBefore),timer.printSinceLast("=== Vertical spacing runtime: ")},_compactGraph:function(xcoord,maxComponentSize){maxComponentSize||(maxComponentSize=1/0);for(var iter=0,improved=!0;improved&&iter<20;){improved=!1,iter++;for(var rank=1;rank<this.DG.order.order.length;rank++)for(var order=0;order<this.DG.order.order[rank].length-1;order++){var v=this.DG.order.order[rank][order];if(this.DG.GG.isChildhub(v))break;if(0!=(slack=xcoord.getSlackOnTheRight(v))){var DG=this.DG,excludeEdgesSpanningOrder=function(from,to){if(DG.ranks[from]==rank&&DG.ranks[to]==rank){var orderFrom=DG.order.vOrder[from],orderTo=DG.order.vOrder[to];if(orderFrom<=order&&order<orderTo||orderTo<=order&&order<orderFrom)return!1}return!0},rightNeighbour=this.DG.order.order[rank][order+1],leftSide=(stopSet={})[rightNeighbour]=!0;if(!(component=this.DG.findConnectedComponent(v,excludeEdgesSpanningOrder,stopSet,maxComponentSize)).stopSetReached){if(component.size>maxComponentSize){if((component=this.DG.findConnectedComponent(rightNeighbour,excludeEdgesSpanningOrder,{},maxComponentSize)).size>maxComponentSize)continue;leftSide=!1}if(0!=(slack=leftSide?xcoord.findVertexSetSlacks(component.component).rightSlack:-xcoord.findVertexSetSlacks(component.component).leftSlack))for(var node in console.log("Moving: "+Helpers.stringifyObject(component.component)+" by "+slack),improved=!0,component.component)component.component.hasOwnProperty(node)&&(xcoord.xcoord[node]+=slack)}}}if(!isFinite(maxComponentSize))for(rank=1;rank<this.DG.order.order.length;rank++)for(order=0;order<this.DG.order.order[rank].length;order++){v=this.DG.order.order[rank][order];if(this.DG.GG.isPerson(v))break;if(this.DG.GG.isRelationship(v))break;if(this.DG.GG.isChildhub(v)){var childhubX=xcoord.xcoord[v],childInfo=this.analizeChildren(v),childPositionInfo=this._computeDesiredChildhubLocation(childInfo,xcoord);if(!(childhubX>=childPositionInfo.leftX&&childhubX<=childPositionInfo.rightX)){var component,slack,shiftChhub=childhubX>childPositionInfo.maxPreferred?childPositionInfo.maxPreferred-childhubX:childPositionInfo.minPreferred-childhubX,stopSet=Helpers.toObjectWithTrue(this.DG.GG.getOutEdges(v));if(!(component=this.DG.findConnectedComponent(v,function(from,to){return from!=v},stopSet,1/0)).stopSetReached)if(0!=(slack=0<shiftChhub?Math.min(shiftChhub,xcoord.findVertexSetSlacks(component.component).rightSlack):Math.max(shiftChhub,-xcoord.findVertexSetSlacks(component.component).leftSlack)))for(var node in console.log("Moving chhub: "+Helpers.stringifyObject(component.component)+" by "+slack),improved=!0,component.component)component.component.hasOwnProperty(node)&&(xcoord.xcoord[node]+=slack)}}}}},_findAffectedSet:function(v_list,dontmove_set,noUp_set,noDown_set,forbidden_set,shiftSize,xcoord,stopAtVirtual,minimizeMovement,stopAtPersons,stopAtRels,stopAtRank){var nodes=Helpers.toObjectWithTrue(v_list),initialNodes=Helpers.toObjectWithTrue(v_list);if(minimizeMovement){for(var i=0;i<v_list.length;i++)noUp_set[v_list[i]]=!0,noDown_set[v_list[i]]=!0;for(var node in dontmove_set)if(dontmove_set.hasOwnProperty(node)){var rank=this.DG.ranks[node],order=this.DG.order.vOrder[node],from=0<shiftSize?0:order+1,to=0<shiftSize?order:this.DG.order.order[rank].length;for(i=from;i<to;i++){var u=this.DG.order.order[rank][i];dontmove_set[u]=!0,noUp_set[u]=!0,noDown_set[u]=!0}}}var numPersons=0,numRels=0,numVirtual=0,minRank=1/0,forbiddenMoved=!1,toMove=new Queue;for(toMove.setTo(v_list);0<toMove.size()&&!(stopAtPersons&&stopAtPersons<numPersons)&&!(stopAtRels&&stopAtRels<numRels);){var nextV=toMove.pop();if(forbidden_set&&forbidden_set.hasOwnProperty(nextV)){forbiddenMoved=!0;break}if(0<shiftSize){if(xcoord.getSlackOnTheRight(nextV)<shiftSize){var rightNeighbour=this.DG.order.getRightNeighbour(nextV,this.DG.ranks[nextV]);nodes.hasOwnProperty(rightNeighbour)||(nodes[rightNeighbour]=!0,toMove.push(rightNeighbour))}}else if(xcoord.getSlackOnTheLeft(nextV)<-shiftSize){var leftNeighbour=this.DG.order.getLeftNeighbour(nextV,this.DG.ranks[nextV]);nodes.hasOwnProperty(leftNeighbour)||(nodes[leftNeighbour]=!0,toMove.push(leftNeighbour))}if(!noUp_set.hasOwnProperty(nextV)||!noDown_set.hasOwnProperty(nextV)){if(this.DG.ranks[nextV]<minRank&&!initialNodes.hasOwnProperty(nextV)&&(minRank=this.DG.ranks[nextV],stopAtRank&&minRank<stopAtRank))break;if(this.DG.GG.isRelationship(nextV)){initialNodes.hasOwnProperty(nextV)||numRels++;var chhub=this.DG.GG.getOutEdges(nextV)[0];if(nodes.hasOwnProperty(chhub)||(nodes[chhub]=!0,toMove.push(chhub)),minimizeMovement||noUp_set.hasOwnProperty(nextV))continue;var parents=this.DG.GG.getInEdges(nextV);for(i=0;i<parents.length;i++)dontmove_set.hasOwnProperty(parents[i])||nodes.hasOwnProperty(parents[i])||(this.DG.order.vOrder[parents[i]]==this.DG.order.vOrder[nextV]+1&&shiftSize<0||this.DG.order.vOrder[parents[i]]==this.DG.order.vOrder[nextV]-1&&0<shiftSize)&&(nodes[parents[i]]=!0,toMove.push(parents[i]))}else if(this.DG.GG.isChildhub(nextV)){var rel=this.DG.GG.getInEdges(nextV)[0];if(nodes.hasOwnProperty(rel)||(nodes[rel]=!0,toMove.push(rel)),minimizeMovement||noDown_set.hasOwnProperty(nextV))continue;var childInfo=this.analizeChildren(nextV),positionInfo=this._computeDesiredChildhubLocation(childInfo,xcoord,nodes,shiftSize),shiftedChildhubX=(childhubX=xcoord.xcoord[nextV])+shiftSize;if(shiftedChildhubX==positionInfo.minPreferredWithShift||shiftedChildhubX==positionInfo.maxPreferredWithShift)continue;if(childhubX<positionInfo.minPreferredWithShift&&0<shiftSize&&shiftedChildhubX<positionInfo.minPreferredWithShift)continue;if(childhubX>positionInfo.maxPreferredWithShift&&shiftSize<0&&shiftedChildhubX>positionInfo.maxPreferredWithShift)continue;for(var children=this.DG.GG.getOutEdges(nextV),j=0;j<children.length;j++)dontmove_set.hasOwnProperty(children[j])||nodes.hasOwnProperty(children[j])||(nodes[children[j]]=!0,toMove.push(children[j]))}else if(this.DG.GG.isPerson(nextV)){if(initialNodes.hasOwnProperty(nextV)||this.DG.GG.isPlaceholder(nextV)||numPersons++,!noDown_set.hasOwnProperty(nextV)){var rels=this.DG.GG.getOutEdges(nextV);for(j=0;j<rels.length;j++)dontmove_set.hasOwnProperty(rels[j])||nodes.hasOwnProperty(rels[j])||(this.DG.order.vOrder[rels[j]]==this.DG.order.vOrder[nextV]+1&&shiftSize<0||this.DG.order.vOrder[rels[j]]==this.DG.order.vOrder[nextV]-1&&0<shiftSize)&&(0<shiftSize&&0==xcoord.getSlackOnTheLeft(nextV)||shiftSize<0&&0==xcoord.getSlackOnTheRight(nextV))&&(nodes[rels[j]]=!0,toMove.push(rels[j]))}var twins=this.DG.GG.getAllTwinsOf(nextV);if(1<twins.length)for(var t=0;t<twins.length;t++){var twin=twins[t];dontmove_set.hasOwnProperty(twin)||nodes.hasOwnProperty(twin)||toMove.push(twin)}if(noUp_set.hasOwnProperty(nextV))continue;var inEdges=this.DG.GG.getInEdges(nextV);if(0<inEdges.length){chhub=inEdges[0];if(dontmove_set.hasOwnProperty(chhub)||nodes.hasOwnProperty(chhub))continue;var childhubX;childInfo=this.analizeChildren(chhub),positionInfo=this._computeDesiredChildhubLocation(childInfo,xcoord,nodes,shiftSize);if((childhubX=xcoord.xcoord[chhub])==positionInfo.minPreferredWithShift||childhubX==positionInfo.maxPreferredWithShift)continue;if(childhubX<positionInfo.minPreferred&&shiftSize<0&&childhubX<positionInfo.minPreferredWithShift)continue;if(childhubX>positionInfo.maxPreferred&&0<shiftSize&&childhubX>positionInfo.maxPreferredWithShift)continue;nodes[chhub]=!0,toMove.push(chhub)}}else if(this.DG.GG.isVirtual(nextV)){if(initialNodes.hasOwnProperty(nextV)||numVirtual++,stopAtVirtual&&0<numVirtual)break;if(!noUp_set.hasOwnProperty(nextV)){var v1=this.DG.GG.getInEdges(nextV)[0];this.DG.GG.isPerson(v1)||nodes.hasOwnProperty(v1)||dontmove_set.hasOwnProperty(v1)||(nodes[v1]=!0,toMove.push(v1))}if(!noDown_set.hasOwnProperty(nextV)){var v2=this.DG.GG.getOutEdges(nextV)[0];this.DG.GG.isRelationship(v2)||nodes.hasOwnProperty(v2)||dontmove_set.hasOwnProperty(v2)||(nodes[v2]=!0,toMove.push(v2))}}}}var affectedNodes=[];for(var node in nodes)nodes.hasOwnProperty(node)&&affectedNodes.push(node);return{nodes:affectedNodes,numPersons:numPersons,numRelationships:numRels,numVirtual:numVirtual,minAffectedRank:minRank,forbiddenMoved:forbiddenMoved}},_computeDesiredChildhubLocation:function(childInfo,xcoord,nodesThatShift,shiftSize){var leftMost=childInfo.leftMostChildId,rightMost=childInfo.rightMostChildId,leftX=xcoord.xcoord[leftMost],rightX=xcoord.xcoord[rightMost],middle=(leftX+rightX)/2,median=3==childInfo.orderedChildren.length?xcoord.xcoord[childInfo.orderedChildren[1]]:middle,result={leftX:leftX,rightX:rightX,middle:middle,median:median,minPreferred:Math.min(middle,median),maxPreferred:Math.max(middle,median)};if(nodesThatShift){var middleShifted=(leftX+(nodesThatShift.hasOwnProperty(leftMost)?shiftSize:0)+(rightX+(nodesThatShift.hasOwnProperty(rightMost)?shiftSize:0)))/2,medianShifted=3==childInfo.orderedChildren.length?xcoord.xcoord[childInfo.orderedChildren[1]]+(nodesThatShift.hasOwnProperty(childInfo.orderedChildren[1])?shiftSize:0):middleShifted,minIntervalXShifted=Math.min(middleShifted,medianShifted),maxIntervalXShifted=Math.max(middleShifted,medianShifted);result.minPreferredWithShift=minIntervalXShifted,result.maxPreferredWithShift=maxIntervalXShifted}return result},optimizeLongEdgePlacement:function(){var xcoord=new XCoord(this.DG.positions,this.DG),longEdges=this.DG.find_long_edges();this.DG.try_straighten_long_edges(longEdges,xcoord);var stillNotStraight=this.straighten_long_edges(longEdges,xcoord);this.DG.try_straighten_long_edges(stillNotStraight,xcoord),this.DG.positions=xcoord.xcoord},straighten_long_edges:function(longEdges,xcoord){for(var stillNotStraight=[],e=0;e<longEdges.length;e++){var chain=longEdges[e];do{for(var improved=!1,headCenter=xcoord.xcoord[chain[0]],i=1;i<chain.length;i++){var nextV=chain[i],nextCenter=xcoord.xcoord[nextV];if(nextCenter!=headCenter){var head=chain.slice(0,i),tail=chain.slice(i),shiftHeadSize=nextCenter-headCenter,dontmove=Helpers.toObjectWithTrue(tail),affectedInfoHeadShift=this._findAffectedSet(head,dontmove,{},{},{},shiftHeadSize,xcoord,!0,!0,5,3),shiftTailSize=headCenter-nextCenter,affectedInfoTailShift=(dontmove=Helpers.toObjectWithTrue(head),this._findAffectedSet(tail,dontmove,{},{},{},shiftTailSize,xcoord,!0,!0,5,3));if(!this._isShiftSizeAcceptable(affectedInfoHeadShift,!1,5,3)&&!this._isShiftSizeAcceptable(affectedInfoTailShift,!1,5,3)){stillNotStraight.push(chain);break}if(improved=!0,this._isShiftBetter(affectedInfoTailShift,affectedInfoHeadShift)){var nodes=affectedInfoTailShift.nodes;for(i=0;i<nodes.length;i++)xcoord.xcoord[nodes[i]]+=shiftTailSize}else for(nodes=affectedInfoHeadShift.nodes,i=0;i<nodes.length;i++)xcoord.xcoord[nodes[i]]+=shiftHeadSize;break}}}while(improved)}return stillNotStraight},_isShiftSizeAcceptable:function(shiftInfo,allowShiftVirtual,maxPersonNodes,maxRelNodes){return!shiftInfo.forbiddenMoved&&(!(!allowShiftVirtual&&0<shiftInfo.numVirtual)&&(!(shiftInfo.numPersons>maxPersonNodes)&&!(shiftInfo.numRelationships>maxRelNodes)))},_isShiftBetter:function(shiftInfo1,shiftInfo2){return shiftInfo2.numVirtual>shiftInfo1.numVirtual||!(shiftInfo2.numVirtual<shiftInfo1.numVirtual)&&(shiftInfo2.numPersons>shiftInfo1.numPersons||!(shiftInfo2.numPersons<shiftInfo1.numPersons)&&shiftInfo2.numRelationships>shiftInfo1.numRelationships)},moveToCorrectPositionAndMoveOtherNodesAsNecessary:function(newNodeId,nodeToKeepEdgeStraightTo){console.log("========== PLACING "+newNodeId);var originalDisturbRank=this.DG.ranks[newNodeId],xcoord=new XCoord(this.DG.positions,this.DG),leftBoundary=xcoord.getLeftMostNoDisturbPosition(newNodeId),rightBoundary=xcoord.getRightMostNoDisturbPosition(newNodeId),desiredPosition=this.DG.positions[nodeToKeepEdgeStraightTo];nodeToKeepEdgeStraightTo!=newNodeId&&(this.DG.ranks[nodeToKeepEdgeStraightTo]==originalDisturbRank?this.DG.order.vOrder[newNodeId]>this.DG.order.vOrder[nodeToKeepEdgeStraightTo]?desiredPosition=xcoord.getRightEdge(nodeToKeepEdgeStraightTo)+xcoord.getSeparation(newNodeId,nodeToKeepEdgeStraightTo)+xcoord.halfWidth[newNodeId]:rightBoundary<(desiredPosition=xcoord.getLeftEdge(nodeToKeepEdgeStraightTo)-xcoord.getSeparation(newNodeId,nodeToKeepEdgeStraightTo)-xcoord.halfWidth[newNodeId])&&(desiredPosition=rightBoundary):this.DG.GG.isPerson(newNodeId)&&rightBoundary<desiredPosition&&(desiredPosition=rightBoundary));var insertPosition=desiredPosition<leftBoundary?leftBoundary:desiredPosition,shiftAmount=0;desiredPosition<(xcoord.xcoord[newNodeId]=insertPosition)&&(shiftAmount=insertPosition-desiredPosition);var disturbedNodes=new Queue;disturbedNodes.push([newNodeId,shiftAmount]);var iterOuter=0,iter=0,doNotTouch={},ancestors=this.DG.GG.getAllAncestors(newNodeId);for(var node in ancestors){doNotTouch[node]=!0;for(var rank=this.DG.ranks[node],order=this.DG.order.vOrder[node],i=0;i<order;i++){doNotTouch[u=this.DG.order.order[rank][i]]=!0}}for(var totalMove={};0<disturbedNodes.size()&&iterOuter<5;){iterOuter++;for(var childrenMoved={},maxExpectedMovements=5*this.DG.ranks.length;0<disturbedNodes.size()&&iter<maxExpectedMovements;){iter++;var next=disturbedNodes.pop(),v=next[0];shiftAmount=next[1];var type=this.DG.GG.type[v],vrank=this.DG.ranks[v],vorder=this.DG.order.vOrder[v],position=xcoord.xcoord[v],rightMostOK=xcoord.getRightMostNoDisturbPosition(v);if(rightMostOK<position){var rightDisturbed=this.DG.order.order[vrank][vorder+1],toMove=position-rightMostOK;xcoord.xcoord[rightDisturbed]+=toMove,totalMove[rightDisturbed]=totalMove.hasOwnProperty(rightDisturbed)?totalMove[rightDisturbed]+toMove:toMove,disturbedNodes.push([rightDisturbed,toMove])}if(v!=newNodeId||type==BaseGraph.TYPE.VIRTUALEDGE){var inEdges=this.DG.GG.getInEdges(v),outEdges=this.DG.GG.getOutEdges(v),skipInEdges=!1;if(type!=BaseGraph.TYPE.PERSON&&type!=BaseGraph.TYPE.VIRTUALEDGE||v!=newNodeId||(skipInEdges=!0),type==BaseGraph.TYPE.VIRTUALEDGE){var inEdgeV=inEdges[0];this.DG.ranks[inEdgeV]==vrank&&(skipInEdges=!0)}if(type==BaseGraph.TYPE.RELATIONSHIP&&(skipInEdges=!0,2==inEdges.length)){var parent0=inEdges[0],parent1=inEdges[1],order0=this.DG.order.vOrder[parent0],order1=this.DG.order.vOrder[parent1];order0!=vorder-1||1!=this.DG.GG.getOutEdges(parent0).length||0!=this.DG.GG.getInEdges(parent0).length||doNotTouch.hasOwnProperty(parent0)?order1!=vorder-1||1!=this.DG.GG.getOutEdges(parent1).length||0!=this.DG.GG.getInEdges(parent1).length||doNotTouch.hasOwnProperty(parent1)||(!totalMove.hasOwnProperty(parent1)||totalMove[parent1]<totalMove[v])&&(xcoord.xcoord[parent1]+=shiftAmount,totalMove[parent1]=totalMove.hasOwnProperty(parent1)?totalMove[parent1]+shiftAmount:shiftAmount):(!totalMove.hasOwnProperty(parent0)||totalMove[parent0]<totalMove[v])&&(xcoord.xcoord[parent0]+=shiftAmount,totalMove[parent0]=totalMove.hasOwnProperty(parent0)?totalMove[parent0]+shiftAmount:shiftAmount)}if(!skipInEdges)for(i=0;i<inEdges.length;i++){var u=inEdges[i],typeU=this.DG.GG.type[u];if(!doNotTouch.hasOwnProperty(u)&&!(totalMove.hasOwnProperty(u)&&totalMove[u]>=totalMove[v]))if(type!=BaseGraph.TYPE.PERSON||typeU!=BaseGraph.TYPE.CHILDHUB){if(typeU!=BaseGraph.TYPE.VIRTUALEDGE||xcoord.xcoord[u]!=xcoord.xcoord[v]){var shiftU=totalMove.hasOwnProperty(u)?Math.min(shiftAmount,Math.max(totalMove[v]-totalMove[u],0)):shiftAmount;xcoord.xcoord[u]+=shiftU,totalMove[u]=totalMove.hasOwnProperty(u)?totalMove[u]+shiftU:shiftU,disturbedNodes.push([u,shiftU])}}else childrenMoved.hasOwnProperty(u)?childrenMoved[u]++:childrenMoved[u]=1}if(type==BaseGraph.TYPE.CHILDHUB){var rightMostChildPos=0;for(i=0;i<outEdges.length;i++){u=outEdges[i];var pos=xcoord.xcoord[u];rightMostChildPos<pos&&(rightMostChildPos=pos)}if(rightMostChildPos>=xcoord.xcoord[v])continue}for(i=0;i<outEdges.length;i++){u=outEdges[i],shiftU=totalMove.hasOwnProperty(u)?Math.min(shiftAmount,Math.max(totalMove[v]-totalMove[u],0)):shiftAmount;if(!doNotTouch.hasOwnProperty(u)&&(!(totalMove.hasOwnProperty(u)&&totalMove[u]>=totalMove[v])&&this.DG.ranks[u]!=vrank)){if(type==BaseGraph.TYPE.RELATIONSHIP||type==BaseGraph.TYPE.VIRTUALEDGE){var diff=xcoord.xcoord[v]-xcoord.xcoord[u];if(diff<=0)continue;diff<shiftU&&(shiftU=diff)}xcoord.xcoord[u]+=shiftU,totalMove[u]=totalMove.hasOwnProperty(u)?totalMove[u]+shiftU:shiftU,disturbedNodes.push([u,shiftU])}}}}for(var chhub in childrenMoved)if(childrenMoved.hasOwnProperty(chhub)){if(chhub=parseInt(chhub),doNotTouch.hasOwnProperty(chhub))continue;var children=this.DG.GG.getOutEdges(chhub);if(0<children.length&&children.length==childrenMoved[chhub]){for(var minShift=1/0,j=0;j<children.length;j++)totalMove[children[j]]<minShift&&(minShift=totalMove[children[j]]);if(totalMove.hasOwnProperty(chhub)){if(totalMove[chhub]>minShift)continue;minShift-=totalMove[chhub]}xcoord.xcoord[chhub]+=minShift,totalMove[chhub]=totalMove.hasOwnProperty(chhub)?totalMove[chhub]+minShift:minShift,disturbedNodes.push([chhub,minShift])}}}this.DG.positions=xcoord.xcoord,console.log("PLACED/MOVED: "+newNodeId+" @ position "+this.DG.positions[newNodeId])}},function(view){"use strict";if(view.URL=view.URL||view.webkitURL,view.Blob&&view.URL)try{return new Blob}catch(e){}var BlobBuilder=view.BlobBuilder||view.WebKitBlobBuilder||view.MozBlobBuilder||function(view){var get_class=function(object){return Object.prototype.toString.call(object).match(/^\[object\s(.*)\]$/)[1]},FakeBlobBuilder=function(){this.data=[]},FakeBlob=function(data,type,encoding){this.data=data,this.size=data.length,this.type=type,this.encoding=encoding},FBB_proto=FakeBlobBuilder.prototype,FB_proto=FakeBlob.prototype,FileReaderSync=view.FileReaderSync,FileException=function(type){this.code=this[this.name=type]},file_ex_codes="NOT_FOUND_ERR SECURITY_ERR ABORT_ERR NOT_READABLE_ERR ENCODING_ERR NO_MODIFICATION_ALLOWED_ERR INVALID_STATE_ERR SYNTAX_ERR".split(" "),file_ex_code=file_ex_codes.length,real_URL=view.URL||view.webkitURL||view,real_create_object_URL=real_URL.createObjectURL,real_revoke_object_URL=real_URL.revokeObjectURL,URL=real_URL,btoa=view.btoa,atob=view.atob,ArrayBuffer=view.ArrayBuffer,Uint8Array=view.Uint8Array,origin=/^[\w-]+:\/*\[?[\w\.:-]+\]?(?::[0-9]+)?/;for(FakeBlob.fake=FB_proto.fake=!0;file_ex_code--;)FileException.prototype[file_ex_codes[file_ex_code]]=file_ex_code+1;return real_URL.createObjectURL||(URL=view.URL=function(uri){var uri_origin,uri_info=document.createElementNS("http://www.w3.org/1999/xhtml","a");return uri_info.href=uri,"origin"in uri_info||("data:"===uri_info.protocol.toLowerCase()?uri_info.origin=null:(uri_origin=uri.match(origin),uri_info.origin=uri_origin&&uri_origin[1])),uri_info}),URL.createObjectURL=function(blob){var data_URI_header,type=blob.type;return null===type&&(type="application/octet-stream"),blob instanceof FakeBlob?(data_URI_header="data:"+type,"base64"===blob.encoding?data_URI_header+";base64,"+blob.data:"URI"===blob.encoding?data_URI_header+","+decodeURIComponent(blob.data):btoa?data_URI_header+";base64,"+btoa(blob.data):data_URI_header+","+encodeURIComponent(blob.data)):real_create_object_URL?real_create_object_URL.call(real_URL,blob):void 0},URL.revokeObjectURL=function(object_URL){"data:"!==object_URL.substring(0,5)&&real_revoke_object_URL&&real_revoke_object_URL.call(real_URL,object_URL)},FBB_proto.append=function(data){var bb=this.data;if(Uint8Array&&(data instanceof ArrayBuffer||data instanceof Uint8Array)){for(var str="",buf=new Uint8Array(data),i=0,buf_len=buf.length;i<buf_len;i++)str+=String.fromCharCode(buf[i]);bb.push(str)}else if("Blob"===get_class(data)||"File"===get_class(data)){if(!FileReaderSync)throw new FileException("NOT_READABLE_ERR");var fr=new FileReaderSync;bb.push(fr.readAsBinaryString(data))}else data instanceof FakeBlob?"base64"===data.encoding&&atob?bb.push(atob(data.data)):"URI"===data.encoding?bb.push(decodeURIComponent(data.data)):"raw"===data.encoding&&bb.push(data.data):("string"!=typeof data&&(data+=""),bb.push(unescape(encodeURIComponent(data))))},FBB_proto.getBlob=function(type){return arguments.length||(type=null),new FakeBlob(this.data.join(""),type,"raw")},FBB_proto.toString=function(){return"[object BlobBuilder]"},FB_proto.slice=function(start,end,type){var args=arguments.length;return args<3&&(type=null),new FakeBlob(this.data.slice(start,1<args?end:this.data.length),type,this.encoding)},FB_proto.toString=function(){return"[object Blob]"},FB_proto.close=function(){this.size=0,delete this.data},FakeBlobBuilder}(view);view.Blob=function(blobParts,options){var type=options&&options.type||"",builder=new BlobBuilder;if(blobParts)for(var i=0,len=blobParts.length;i<len;i++)builder.append(blobParts[i]);return builder.getBlob(type)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content||this);var saveAs=saveAs||"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(view){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var doc=view.document,get_URL=function(){return view.URL||view.webkitURL||view},save_link=doc.createElementNS("http://www.w3.org/1999/xhtml","a"),can_use_save_link=!view.externalHost&&"download"in save_link,webkit_req_fs=view.webkitRequestFileSystem,req_fs=view.requestFileSystem||webkit_req_fs||view.mozRequestFileSystem,throw_outside=function(ex){(view.setImmediate||view.setTimeout)(function(){throw ex},0)},fs_min_size=0,deletion_queue=[],process_deletion_queue=function(){for(var i=deletion_queue.length;i--;){var file=deletion_queue[i];"string"==typeof file?get_URL().revokeObjectURL(file):file.remove()}deletion_queue.length=0},dispatch=function(filesaver,event_types,event){for(var i=(event_types=[].concat(event_types)).length;i--;){var listener=filesaver["on"+event_types[i]];if("function"==typeof listener)try{listener.call(filesaver,event||filesaver)}catch(ex){throw_outside(ex)}}},FileSaver=function(blob,name){var object_url,target_view,slice,node,event,filesaver=this,type=blob.type,blob_changed=!1,get_object_url=function(){var object_url=get_URL().createObjectURL(blob);return deletion_queue.push(object_url),object_url},dispatch_all=function(){dispatch(filesaver,"writestart progress write writeend".split(" "))},fs_error=function(){!blob_changed&&object_url||(object_url=get_object_url()),target_view?target_view.location.href=object_url:window.open(object_url,"_blank"),filesaver.readyState=filesaver.DONE,dispatch_all()},abortable=function(func){return function(){if(filesaver.readyState!==filesaver.DONE)return func.apply(this,arguments)}},create_if_not_found={create:!0,exclusive:!1};if(filesaver.readyState=filesaver.INIT,name||(name="download"),can_use_save_link)return object_url=get_object_url(),save_link.href=object_url,save_link.download=name,node=save_link,(event=doc.createEvent("MouseEvents")).initMouseEvent("click",!0,!1,view,0,0,0,0,0,!1,!1,!1,!1,0,null),node.dispatchEvent(event),filesaver.readyState=filesaver.DONE,void dispatch_all();view.chrome&&type&&"application/octet-stream"!==type&&(slice=blob.slice||blob.webkitSlice,blob=slice.call(blob,0,blob.size,"application/octet-stream"),blob_changed=!0),webkit_req_fs&&"download"!==name&&(name+=".download"),("application/octet-stream"===type||webkit_req_fs)&&(target_view=view),req_fs?(fs_min_size+=blob.size,req_fs(view.TEMPORARY,fs_min_size,abortable(function(fs){fs.root.getDirectory("saved",create_if_not_found,abortable(function(dir){var save=function(){dir.getFile(name,create_if_not_found,abortable(function(file){file.createWriter(abortable(function(writer){writer.onwriteend=function(event){target_view.location.href=file.toURL(),deletion_queue.push(file),filesaver.readyState=filesaver.DONE,dispatch(filesaver,"writeend",event)},writer.onerror=function(){var error=writer.error;error.code!==error.ABORT_ERR&&fs_error()},"writestart progress write abort".split(" ").forEach(function(event){writer["on"+event]=filesaver["on"+event]}),writer.write(blob),filesaver.abort=function(){writer.abort(),filesaver.readyState=filesaver.DONE},filesaver.readyState=filesaver.WRITING}),fs_error)}),fs_error)};dir.getFile(name,{create:!1},abortable(function(file){file.remove(),save()}),abortable(function(ex){ex.code===ex.NOT_FOUND_ERR?save():fs_error()}))}),fs_error)}),fs_error)):fs_error()},FS_proto=FileSaver.prototype,saveAs=function(blob,name){return new FileSaver(blob,name)};return FS_proto.abort=function(){this.readyState=this.DONE,dispatch(this,"abort")},FS_proto.readyState=FS_proto.INIT=0,FS_proto.WRITING=1,FS_proto.DONE=2,FS_proto.error=FS_proto.onwritestart=FS_proto.onprogress=FS_proto.onwrite=FS_proto.onabort=FS_proto.onerror=FS_proto.onwriteend=null,view.addEventListener("unload",process_deletion_queue,!1),saveAs.unload=function(){process_deletion_queue(),view.removeEventListener("unload",process_deletion_queue,!1)},saveAs}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content),saveTextAs=saveTextAs||function(textContent,fileName,charset){if(fileName=fileName||"pedigree.txt",charset=charset||"utf-8",textContent=(textContent||"").replace(/\r?\n/g,"\r\n"),saveAs&&Blob){var blob=new Blob([textContent],{type:"text/plain;charset="+charset});return saveAs(blob,fileName),!0}var saveTxtWindow=window.frames.saveTxtWindow;if(!saveTxtWindow&&((saveTxtWindow=document.createElement("iframe")).id="saveTxtWindow",saveTxtWindow.style.display="none",document.body.insertBefore(saveTxtWindow,null),!(saveTxtWindow=window.frames.saveTxtWindow)&&!(saveTxtWindow=window.open("","_temp","width=100,height=100"))))return window.alert("Sorry, download file could not be created."),!1;var doc=saveTxtWindow.document;doc.charset=charset,browser.versionMajor<=8?doc.open("text/plain","replace"):doc.open(),doc.write(textContent),doc.close(),fileName+=".txt";var retValue=doc.execCommand("SaveAs",null,fileName);return saveTxtWindow.close(),retValue},FileSaver={};FileSaver.saveAs=saveAs,FileSaver.saveTextAs=saveTextAs,NodeMenu=Class.create({initialize:function(data,tabs,otherCSSClass){this._justOpened=!1,this.canvas=editor.getWorkspace().canvas||$("body");var cssClass="menu-box";if(otherCSSClass&&(cssClass+=" "+otherCSSClass),this.menuBox=new Element("div",{class:cssClass}),this.closeButton=new Element("span",{class:"close-button"}).update(" "),this.menuBox.insert({top:this.closeButton}),this.closeButton.observe("click",this.hide.bindAsEventListener(this)),this.form=new Element("form",{method:"get",action:"",class:"tabs-content"}),this.tabs={},this.tabHeaders={},tabs&&0<tabs.length){this.tabTop=new Element("dl",{class:"tabs"});for(var i=0;i<tabs.length;i++){var tabName=tabs[i],activeClass=0==i?"active":"";this.tabs[tabName]=new Element("div",{id:"tab_"+tabName,class:"content "+activeClass}),this.form.insert(this.tabs[tabName]),this.tabHeaders[tabName]=new Element("dd",{class:activeClass}).insert("<a>"+tabName+"</a>");var _this=this;this.tabHeaders[tabName].observe("click",function(tabName){return function(){for(var tab in _this.tabs)_this.tabs.hasOwnProperty(tab)&&(tab!=tabName?(_this.tabs[tab].className="content",_this.tabHeaders[tab].className=""):(_this.tabs[tab].className="content active",_this.tabHeaders[tab].className="active"));_this.reposition()}}(tabName)),this.tabTop.insert(this.tabHeaders[tabName])}var div=new Element("div",{class:"tabholder"}).insert(this.tabTop).insert(this.form);this.menuBox.insert({bottom:div})}else this.singleTab=new Element("div",{class:"tabholder"}).insert(this.form),this.menuBox.insert({bottom:this.singleTab}),this.closeButton.addClassName("close-button-old"),this.form.addClassName("content");this.fieldMap={};_this=this;data.each(function(d){if("function"==typeof _this._generateField[d.type]){var insertLocation=_this.form;d.tab&&_this.tabs.hasOwnProperty(d.tab)&&(insertLocation=_this.tabs[d.tab]),insertLocation.insert(_this._generateField[d.type].call(_this,d))}}),this.hide(),editor.getWorkspace().getWorkArea().insert(this.menuBox),this._onClickOutside=this._onClickOutside.bindAsEventListener(this),this._generatePickersAndSuggests(),this._updateDisorderColor=function(id,color){this.menuBox.select('.field-disorders li input[value="'+id+'"]').each(function(item){var colorBubble=item.up("li").down(".abnormality-color");colorBubble||(colorBubble=new Element("span",{class:"abnormality-color"}),item.up("li").insert({top:colorBubble})),colorBubble.setStyle({background:color})})}.bind(this),document.observe("disorder:color",function(event){event.memo&&event.memo.id&&event.memo.color&&_this._updateDisorderColor(event.memo.id,event.memo.color)}),this._updateGeneColor=function(id,color){this.menuBox.select('.field-candidate_genes li input[value="'+id+'"]').each(function(item){var colorBubble=item.up("li").down(".abnormality-color");colorBubble||(colorBubble=new Element("span",{class:"abnormality-color"}),item.up("li").insert({top:colorBubble})),colorBubble.setStyle({background:color})})}.bind(this),document.observe("gene:color",function(event){event.memo&&event.memo.id&&event.memo.color&&_this._updateGeneColor(event.memo.id,event.memo.color)})},_generatePickersAndSuggests:function(){this.form.select(".fuzzy-date").each(function(item){if(!item.__datePicker){var inputMode=editor.getPreferencesManager().getConfigurationOption("dateEditFormat");item.__datePicker=new PedigreeFuzzyDatePicker(item,inputMode)}});var FORM=this.form;this.form.select("input.suggest-omim").each(function(item){item.hasClassName("initialized")||(item._suggest=new PhenoTips.widgets.Suggest(item,{scriptFunction:function(){if(0<FORM.select("select[name='disorderType']").length){var select=FORM.select("select[name='disorderType']")[0],disorderType=select.options[select.selectedIndex].value;return Disorder.getServiceURL(disorderType)+"&"}return Disorder.getServiceURL("OMIM")+"&"},resultUsePagination:function(){var select=FORM.select("select[name='disorderType']")[0];return"SnomedCT"==select.options[select.selectedIndex].value},script:Disorder.getServiceURL("OMIM")+"&",varname:"query",minchars:3,noresults:"No matching terms",json:!0,resultsParameter:function(){console.log("results param");var select=FORM.select("select[name='disorderType']")[0];return"GEL"==select.options[select.selectedIndex].value?"resultFlat":"hits"},resultId:function(){var select=FORM.select("select[name='disorderType']")[0];return"GEL"==select.options[select.selectedIndex].value?"disorderIdWithTag":"code"},resultValue:function(){var select=FORM.select("select[name='disorderType']")[0];return"GEL"==select.options[select.selectedIndex].value?"disorderName":"display"},resultInfo:{},displaySuggestItemFunction:function(searchTerm,data,pedigreeWidget){if(!data.valueAll)return null;var select=FORM.select("select[name='disorderType']")[0];select.options[select.selectedIndex].value;return null},canSelectInputTerm:function(){return!1},enableHierarchy:!1,fadeOnClear:!1,timeout:3e4,parentContainer:$("body")}),item.hasClassName("multi")&&void 0!==PhenoTips.widgets.SuggestPicker&&(item._suggestPicker=new PhenoTips.widgets.SuggestPicker(item,item._suggest,{showKey:!1,showTooltip:!1,showDeleteTool:!0,enableSort:!1,showClearTool:!0,inputType:"hidden",listInsertionElt:"input",listInsertionPosition:"after",acceptFreeText:!0,name:"disorder",showDisorderType:!0,customizeItemDisplay:function(key,value,valueAll,displayedValue,options){if(console.log("testaaa",key,value,valueAll,displayedValue),options.showDisorderType){var select=FORM.select("select[name='disorderType']")[0],disorderType=select.options[select.selectedIndex].value;if(console.log("DDD",disorderType,valueAll.disorderType,null!=valueAll.disorderType),null!=valueAll&&null!=valueAll.disorderType&&(console.log("enter"),disorderType=valueAll.disorderType),valueAll.disorderType=disorderType,"Affected"!=value){var disorderTypeContainer=new Element("span",{class:"disorder-disorder-type"}).insert("(").insert(disorderType).insert(")");if(displayedValue.insert("").insert(disorderTypeContainer),null!=valueAll&&null!=valueAll.diagnosisCertainty&&0<valueAll.diagnosisCertainty.length){var diagnosisCertainty=valueAll.diagnosisCertainty,diagnosisCertaintyContainer=new Element("span","").insert(", ").insert(new Element("span",{class:"disorder-age-of-onset"}).insert(diagnosisCertainty).insert(""));displayedValue.insert("").insert(diagnosisCertaintyContainer)}}}},acceptsDuplicate:function(){var select=FORM.select("select[name='disorderType']")[0],disorderType=select.options[select.selectedIndex].value;return"ICD10"==disorderType||"SnomedCT"==disorderType}})),item.addClassName("initialized"),document.observe("ms:suggest:containerCreated",function(event){event.memo&&event.memo.suggest===item._suggest&&item._suggest.container.setStyle({overflow:"auto",maxHeight:document.viewport.getHeight()-item._suggest.container.cumulativeOffset().top+"px"})}))});var webService=new WebService;this.form.select("input.suggest-ethnicity").each(function(item){item.hasClassName("initialized")||(item._suggest=new PhenoTips.widgets.Suggest(item,{script:webService.getEthnicityLookupPath()+"&",varname:"q",noresults:"No matching terms",json:!0,resultsParameter:function(){return"hits"},resultId:function(){return"code"},resultValue:function(){return"display"},resultInfo:{},resultParent:"is_a",resultAltName:"synonym",resultCategory:"term_category",enableHierarchy:!1,fadeOnClear:!1,minchars:3,timeout:3e4,parentContainer:$("body"),displaySuggestItemFunction:function(searchTerm,data,pedigreeWidget){if(!data.valueAll)return null;var select=FORM.select("select[name='disorderType']")[0];select.options[select.selectedIndex].value;return null},canSelectInputTerm:function(){return!1}}),item.hasClassName("multi")&&void 0!==PhenoTips.widgets.SuggestPicker&&(item._suggestPicker=new PhenoTips.widgets.SuggestPicker(item,item._suggest,{showKey:!1,showTooltip:!1,showDeleteTool:!0,enableSort:!1,showClearTool:!0,inputType:"hidden",listInsertionElt:"input",listInsertionPosition:"after",acceptFreeText:!0,name:"ethnicity",customizeItemDisplay:function(key,value,valueAll,displayedValue,options){console.log("item display",valueAll,value);var hpoPresent="";hpoPresent=null!=valueAll&&valueAll.hpoPresent?valueAll.hpoPresent:"unknown";var hpoPresentContainer=new Element("span",{class:"hpo-present"}).insert("(").insert(hpoPresent).insert(")");displayedValue.insert("").insert(hpoPresentContainer)},acceptsDuplicate:function(){return!1}})),item.addClassName("initialized"),document.observe("ms:suggest:containerCreated",function(event){event.memo&&event.memo.suggest===item._suggest&&item._suggest.container.setStyle({overflow:"auto",maxHeight:document.viewport.getHeight()-item._suggest.container.cumulativeOffset().top+"px"})}))}),this.form.select("input.suggest-genes").each(function(item){if(!item.hasClassName("initialized")){var geneServiceURL=new XWiki.Document("GeneNameService","PhenoTips").getURL("get","outputSyntax=plain");item._suggest=new PhenoTips.widgets.Suggest(item,{script:geneServiceURL+"&json=true&",varname:"query",noresults:"No matching terms",resultsParameter:"docs",json:!0,resultId:"symbol",resultValue:"symbol",resultInfo:{},enableHierarchy:!1,tooltip:"gene-info",fadeOnClear:!1,timeout:3e4,parentContainer:$("body")}),item.hasClassName("multi")&&void 0!==PhenoTips.widgets.SuggestPicker&&(item._suggestPicker=new PhenoTips.widgets.SuggestPicker(item,item._suggest,{showKey:!1,showTooltip:!1,showDeleteTool:!0,enableSort:!1,showClearTool:!0,inputType:"hidden",listInsertionElt:"input",listInsertionPosition:"after",acceptFreeText:!0})),item.addClassName("initialized"),document.observe("ms:suggest:containerCreated",function(event){event.memo&&event.memo.suggest===item._suggest&&item._suggest.container.setStyle({overflow:"auto",maxHeight:document.viewport.getHeight()-item._suggest.container.cumulativeOffset().top+"px"})})}}),this.form.select("input.suggest-hpo").each(function(item){if(!item.hasClassName("initialized")){item._suggest=new PhenoTips.widgets.Suggest(item,{script:webService.getHPOLookupPath()+"&",varname:"query",noresults:"No matching terms",json:!0,resultsParameter:function(){return"hits"},resultId:function(){return"code"},resultValue:function(){return"display"},resultAltName:"synonym",resultCategory:"term_category",resultInfo:{},enableHierarchy:!1,resultParent:"is_a",fadeOnClear:!1,timeout:3e4,minchars:3,parentContainer:$("body"),canSelectInputTerm:function(){return!1},displaySuggestItemFunction:function(searchTerm,data,pedigreeWidget){if(!data.valueAll)return null;var select=FORM.select("select[name='disorderType']")[0];if("GEL"!=select.options[select.selectedIndex].value)return null;var newDataValue=pedigreeWidget.highLightSearchResult(data.value.escapeHTML(),searchTerm),suggestedValue=new Element("span",{class:"suggestValue"}).update(newDataValue),diseaseGroup=new Element("span").update("<br><br> Group: <span style='font-size: 11px'>"+pedigreeWidget.highLightSearchResult(data.valueAll.groupName,searchTerm)+"</span>"),diseaseSubGroup=new Element("span").update("<br> SubGroup: <span style='font-size: 11px'>"+pedigreeWidget.highLightSearchResult(data.valueAll.subGroupName,searchTerm)+"</span>");return suggestedValue.insert(diseaseGroup),suggestedValue.insert(diseaseSubGroup),suggestedValue}});item.hasClassName("multi")&&!item.hasClassName("initialized")&&void 0!==PhenoTips.widgets.SuggestPicker&&(item._suggestPicker=new PhenoTips.widgets.SuggestPicker(item,item._suggest,{showKey:!1,showTooltip:!1,showDeleteTool:!0,enableSort:!1,showClearTool:!0,inputType:"hidden",listInsertionElt:"input",listInsertionPosition:"after",acceptFreeText:!0,name:"hpo",showHPOPresentStatus:!0,customizeItemDisplay:function(key,value,valueAll,displayedValue,options){if(console.log("valueALLL",valueAll),valueAll,options.showHPOPresentStatus){var hpoPresent="";hpoPresent=null!=valueAll&&valueAll.hpoPresent?valueAll.hpoPresent:"unknown";var hpoPresentContainer=new Element("span",{class:"hpo-present"}).insert(hpoPresent);if(displayedValue.insert("").insert(hpoPresentContainer),null!=valueAll.hpoModifiers&&0<valueAll.hpoModifiers.length){var hpoModifier=new Element("span").update('<br>HPO Modifiers: <span style=\'font-size: 11px\'><input type="text" style="display:block !important;visibility:visible;"  class="suggest multi suggest-hpo-modifier accept-value" name="hpo_modifier" value=""/></span>');displayedValue.insert(hpoModifier)}else{hpoModifier=new Element("span").update('<br> Modifiers: <span style=\'font-size: 11px\'><input type="text" class="suggest multi suggest-hpo-modifier accept-value" name="hpo_modifier" value=""/></span>');displayedValue.insert(hpoModifier),item.addClassName("initialized")}setTimeout(function(){item.parentElement.select("input.suggest-hpo-modifier").each(function(hpoModifierItem){if(!hpoModifierItem.hasClassName("initialized")){hpoModifierItem._suggest=new PhenoTips.widgets.Suggest(hpoModifierItem,{script:webService.getHPOModifierLookupPath()+"&",varname:"query",noresults:"No matching terms",json:!0,resultsParameter:function(){return"hits"},resultId:function(){return"code"},resultValue:function(){return"display"},resultAltName:"synonym",resultCategory:"term_category",resultInfo:{},enableHierarchy:!1,resultParent:"is_a",fadeOnClear:!1,timeout:3e4,minchars:3,parentContainer:$("body"),canSelectInputTerm:function(){return!1},displaySuggestItemFunction:function(searchTerm,data,pedigreeWidget){return data.valueAll,null}}),hpoModifierItem.hasClassName("multi")&&hpoModifierItem.hasClassName("suggest-hpo-modifier")&&!hpoModifierItem.hasClassName("initialized")&&void 0!==PhenoTips.widgets.SuggestPicker&&(console.log("TZZZZ",hpoModifierItem._suggest,hpoModifierItem._suggest.fld.disabled),hpoModifierItem._suggestPicker=new PhenoTips.widgets.SuggestPicker(hpoModifierItem,hpoModifierItem._suggest,{showKey:!1,showTooltip:!1,showDeleteTool:!1,enableSort:!1,showClearTool:!0,inputType:"hidden",listInsertionElt:"input",listInsertionPosition:"after",acceptFreeText:!0,name:"hpo-modifier",customizeItemDisplay:function(key,value,valueAll,displayedValue,options){},acceptsDuplicate:function(){return!1}}));var target=hpoModifierItem;if(target)hpoModifierItem.parentNode.parentNode.parentNode.select("input[type=hidden][name=hpo_positive]").each(function(item){var valueAll,li=item.up("li");if(null!=li){valueAll=li.retrieve("valueAll");document.getElementsByName("hpoPresent")[0].value;valueAll&&valueAll.hpoModifiers&&0<valueAll.hpoModifiers.length&&valueAll.hpoModifiers.forEach(function(v){target._suggestPicker.addItem(v.code,v.display,"",null,v.valueAll)})}});hpoModifierItem.addClassName("initialized")}})},0)}},acceptsDuplicate:function(){return!1}})),item.addClassName("initialized"),document.observe("ms:suggest:containerCreated",function(event){event.memo&&event.memo.suggest===item._suggest&&item._suggest.container.setStyle({overflow:"auto",maxHeight:document.viewport.getHeight()-item._suggest.container.cumulativeOffset().top+"px"})})}}),this.form.select("input.suggest-hpo").each(function(item){item.hasClassName("initialized")||(item._suggest=new PhenoTips.widgets.Suggest(item,{script:webService.getHPOLookupPath()+"&",varname:"query",noresults:"No matching terms",json:!0,resultsParameter:function(){return"hits"},resultId:function(){return"code"},resultValue:function(){return"display"},resultAltName:"synonym",resultCategory:"term_category",resultInfo:{},enableHierarchy:!1,resultParent:"is_a",fadeOnClear:!1,timeout:3e4,minchars:3,parentContainer:$("body"),canSelectInputTerm:function(){return!1},displaySuggestItemFunction:function(searchTerm,data,pedigreeWidget){return data.valueAll,null}}),item.hasClassName("multi")&&item.hasClassName("suggest-hpo")&&void 0!==PhenoTips.widgets.SuggestPicker&&(item._suggestPicker=new PhenoTips.widgets.SuggestPicker(item,item._suggest,{showKey:!1,showTooltip:!1,showDeleteTool:!0,enableSort:!1,showClearTool:!0,inputType:"hidden",listInsertionElt:"input",listInsertionPosition:"after",acceptFreeText:!0,name:"hpo",showHPOPresentStatus:!0,customizeItemDisplay:function(key,value,valueAll,displayedValue,options){if(options.showHPOPresentStatus){var hpoPresent="";hpoPresent=null!=valueAll&&valueAll.hpoPresent?valueAll.hpoPresent:"unknown";var hpoPresentContainer=new Element("span",{class:"hpo-present"}).insert("(").insert(hpoPresent).insert(")");displayedValue.insert("").insert(hpoPresentContainer)}},acceptsDuplicate:function(){return!1}})),item.addClassName("initialized"),document.observe("ms:suggest:containerCreated",function(event){event.memo&&event.memo.suggest===item._suggest&&item._suggest.container.setStyle({overflow:"auto",maxHeight:document.viewport.getHeight()-item._suggest.container.cumulativeOffset().top+"px"})}))}),this.form.select("input.suggest-hpo-modifier").each(function(item){item.hasClassName("initialized")||(item._suggest=new PhenoTips.widgets.Suggest(item,{script:webService.getHPOModifierLookupPath()+"&",varname:"query",noresults:"No matching terms",json:!0,resultsParameter:function(){return"hits"},resultId:function(){return"code"},resultValue:function(){return"display"},resultAltName:"synonym",resultCategory:"term_category",resultInfo:{},enableHierarchy:!1,resultParent:"is_a",fadeOnClear:!1,timeout:3e4,minchars:3,parentContainer:$("body"),canSelectInputTerm:function(){return!1},displaySuggestItemFunction:function(searchTerm,data,pedigreeWidget){return data.valueAll,null}}),item.hasClassName("multi")&&item.hasClassName("suggest-hpo")&&void 0!==PhenoTips.widgets.SuggestPicker&&(item._suggestPicker=new PhenoTips.widgets.SuggestPicker(item,item._suggest,{showKey:!1,showTooltip:!1,showDeleteTool:!1,enableSort:!1,showClearTool:!0,inputType:"hidden",listInsertionElt:"input",listInsertionPosition:"after",acceptFreeText:!0,name:"hpo",showHPOPresentStatus:!0,customizeItemDisplay:function(key,value,valueAll,displayedValue,options){if(options.showHPOPresentStatus){var hpoPresent="";hpoPresent=null!=valueAll&&valueAll.hpoPresent?valueAll.hpoPresent:"unknown";var hpoPresentContainer=new Element("span",{class:"hpo-present"}).insert("(").insert(hpoPresent).insert(")");displayedValue.insert("").insert(hpoPresentContainer)}},acceptsDuplicate:function(){return!1}})),item.addClassName("initialized"),document.observe("ms:suggest:containerCreated",function(event){event.memo&&event.memo.suggest===item._suggest&&item._suggest.container.setStyle({overflow:"auto",maxHeight:document.viewport.getHeight()-item._suggest.container.cumulativeOffset().top+"px"})}))}),this.form.select("input.suggest-patients").each(function(item){if(!item.hasClassName("initialized")){var patientSuggestURL=new XWiki.Document("SuggestPatientsService","PhenoTips").getURL("get","outputSyntax=plain")+"&permission=edit&";item._suggest=new PhenoTips.widgets.Suggest(item,{script:patientSuggestURL,varname:"input",noresults:"No matching patients",json:!1,resultsParameter:"rs",resultId:"id",resultValue:"name",resultInfo:"info",enableHierarchy:!1,fadeOnClear:!1,timeout:3e4,parentContainer:$("body")}),item.addClassName("initialized"),document.observe("ms:suggest:containerCreated",function(event){event.memo&&event.memo.suggest===item._suggest&&item._suggest.container.setStyle({overflow:"auto",maxHeight:document.viewport.getHeight()-item._suggest.container.cumulativeOffset().top+"px"})})}})},_generateEmptyField:function(data){var cssClass="field-box field-"+data.name;data.class&&(cssClass="field-box field-"+data.name+" "+data.class);var result=new Element("div",{class:cssClass}),fieldNameClass="field-name";if("label"==data.type&&(fieldNameClass="field-label"),"radio"==data.type&&(fieldNameClass+=" field-no-user-select"),data.addCSS&&"object"==typeof data.addCSS)for(var styleName in data.addCSS)result.style[styleName]=data.addCSS[styleName];var label=new Element("label",{class:fieldNameClass}).update(data.label);return result.inputsContainer=new Element("div",{class:"field-inputs"}),"label"!=data.type?result.insert(label).insert(result.inputsContainer):result.insert(label),this.fieldMap[data.name]={type:data.type,element:result,default:data.default||"",crtValue:data.default||"",function:data.function,disabled:data.disabled||!1,isMultipleSelect:data.isMultipleSelect||!1,inactive:!1},result},_attachFieldEventListeners:function(field,eventNames,values){var _this=this;eventNames.each(function(eventName){field.observe(eventName,function(event){if(_this._saveCursorPositionIfNecessary(field),!_this._updating){var target=_this.targetNode;if(target){null==_this.fieldMap[field.name].isMultipleSelect||0==_this.fieldMap[field.name].isMultipleSelect?_this.fieldMap[field.name].crtValue=field._getValue&&field._getValue()[0]:_this.fieldMap[field.name].crtValue=field._getValue&&field._getValue();var method=_this.fieldMap[field.name].function;if(target.getSummary()[field.name].value!=_this.fieldMap[field.name].crtValue){if(0==method.indexOf("set")&&"function"==typeof target[method]){(properties={})[method]=_this.fieldMap[field.name].crtValue;event={nodeID:target.getID(),properties:properties};document.fire("pedigree:node:setproperty",event)}else{var properties;(properties={})[method]=_this.fieldMap[field.name].crtValue;event={nodeID:target.getID(),modifications:properties};document.fire("pedigree:node:modify",event)}field.fire("pedigree:change")}}}})})},_saveCursorPositionIfNecessary:function(field){this.__lastSelectedField=field.name,this.__lastNodeID=this.targetNode,("text"==field.type||document.selection&&"textarea"==field.type)&&(this.__lastCursorPosition=GraphicHelpers.getCaretPosition(field))},_restoreCursorPositionIfNecessary:function(field){this.targetNode==this.__lastNodeID&&null!=field&&field.name==this.__lastSelectedField&&("text"==field.type||document.selection&&"textarea"==field.type)&&GraphicHelpers.setCaretPosition(field,this.__lastCursorPosition)},update:function(newTarget){newTarget&&(this.targetNode=newTarget),this.targetNode&&(this._updating=!0,this._setCrtData(this.targetNode.getSummary()),delete this._updating)},_attachDependencyBehavior:function(field,data){if(data.dependency){var dependency=data.dependency.split(" ",3),element=this.fieldMap[dependency[0]].element;dependency[0]=this.form[dependency[0]],null!=data.dependencyShowInline&&1==data.dependencyShowInline&&element.inputsContainer.insert(field.up()),this.fieldMap[field.name].element=element,this._updatedDependency(field,dependency),dependency[0].observe("pedigree:change",function(){this._updatedDependency(field,dependency),field.value=""}.bindAsEventListener(this))}},_updatedDependency:function(field,dependency){switch(dependency[1]){case"!=":field.disabled=dependency[0].value==dependency[2];break;default:field.disabled=dependency[0].value!=dependency[2]}},_generateField:{radio:function(data){var result=this._generateEmptyField(data),columnClass=data.columns?"field-values-"+data.columns+"-columns":"field-values",values=new Element("div",{class:columnClass+=" field-no-user-select"});result.inputsContainer.insert(values);var _this=this,_generateRadioButton=function(v){var radioLabel=new Element("label",{class:data.name+"_"+v.actual}).update(v.displayed);v.hasOwnProperty("columnshiftPX")&&radioLabel.setStyle({marginLeft:v.columnshiftPX+"px"});var radioButton=new Element("input",{type:"radio",name:data.name,value:v.actual});radioLabel.insert({top:radioButton}),radioButton._getValue=function(){return[this.value]}.bind(radioButton),values.insert(radioLabel),_this._attachFieldEventListeners(radioButton,["click"]),_this._attachDependencyBehavior(radioButton,data)};return data.hasOwnProperty("valuesIE9")&&navigator&&-1!=navigator.appVersion.indexOf("MSIE 9")?data.valuesIE9.each(_generateRadioButton):data.values.each(_generateRadioButton),result},checkbox:function(data){var result=this._generateEmptyField(data),checkbox=new Element("input",{type:"checkbox",name:data.name,value:"1"});return result.down("label").insert({top:checkbox}),checkbox._getValue=function(){return[this.checked]}.bind(checkbox),this._attachFieldEventListeners(checkbox,["click"]),result},label:function(data){var result=this._generateEmptyField(data);return result.addClassName("field-label"),result},text:function(data){var result=this._generateEmptyField(data),text=new Element("input",{type:"text",name:data.name});return data.tip&&(text.placeholder=data.tip),result.inputsContainer.insert(text),text.wrap("span"),text._getValue=function(){return[this.value]}.bind(text),this._attachFieldEventListeners(text,["keyup"],[!0]),this._attachDependencyBehavior(text,data),result},textarea:function(data){var result=this._generateEmptyField(data),properties={name:data.name};properties.class="textarea-"+data.rows+"-rows";var text=new Element("textarea",properties);return result.inputsContainer.insert(text),text._getValue=function(){return[this.value]}.bind(text),this._attachFieldEventListeners(text,["keyup"],[!0]),this._attachDependencyBehavior(text,data),result},"date-picker":function(data){var result=this._generateEmptyField(data),datePicker=new Element("input",{type:"text",class:"fuzzy-date",name:data.name,title:data.format||"",alt:""});return result.inputsContainer.insert(datePicker),datePicker._getValue=function(){return[new PedigreeDate(JSON.parse(this.value))]}.bind(datePicker),this._attachFieldEventListeners(datePicker,["xwiki:date:changed"]),result},"disease-picker":function(data){var result=this._generateEmptyField(data),style=data.style?data.style:"",diseasePicker=new Element("input",{type:"text",class:"suggest multi suggest-omim",name:data.name,style:style});result.insert(diseasePicker),diseasePicker._getValue=function(){var results=[],container=this.up(".field-box");return container&&container.select("input[type=hidden][name="+data.name+"]").each(function(item){var valueAll,li=item.up("li");null!=li&&(valueAll=li.retrieve("valueAll")),results.push(new Disorder(item.value,item.next(".value")&&item.next(".value").firstChild.nodeValue||item.value,valueAll.ageOfOnset,valueAll.diagnosisCertainty,valueAll.codeSystemUri,valueAll.versionNumber,valueAll.disorderType,valueAll))}),[results]}.bind(diseasePicker);var _this=this;return document.observe("custom:selection:changed",function(event){if(event.memo&&event.memo.fieldName==data.name&&event.memo.trigger&&event.findElement()!=event.memo.trigger&&!event.memo.trigger._silent){if(0<_this.form.select("select[name='diagnosisCertainty']").length){var diagnosisCertainty=_this.form.select("select[name='diagnosisCertainty']")[0].getValue(),valueAll=event.memo.customElement.retrieve("valueAll");null!=valueAll&&(valueAll.diagnosisCertainty=diagnosisCertainty)}Event.fire(event.memo.trigger,"custom:selection:changed"),_this.reposition()}}),this._attachFieldEventListeners(diseasePicker,["custom:selection:changed"]),result},"ethnicity-picker":function(data){var result=this._generateEmptyField(data),ethnicityPicker=new Element("input",{type:"text",class:"suggest multi suggest-ethnicity",name:data.name});result.insert(ethnicityPicker),ethnicityPicker._getValue=function(){var results=[],container=this.up(".field-box");return container&&container.select("input[type=hidden][name="+data.name+"]").each(function(item){var valueAll,li=item.up("li");null!=li&&(valueAll=li.retrieve("valueAll"));item.next(".value")&&item.next(".value").firstChild.nodeValue||item.value,item.value,valueAll.uid;results.push(new Ethnicity(item.value,item.next(".value")&&item.next(".value").firstChild.nodeValue||item.value,valueAll.uid,valueAll))}),[results]}.bind(ethnicityPicker);var _this=this;return document.observe("custom:selection:changed",function(event){event.memo&&event.memo.fieldName==data.name&&event.memo.trigger&&event.findElement()!=event.memo.trigger&&!event.memo.trigger._silent&&(Event.fire(event.memo.trigger,"custom:selection:changed"),_this.reposition())}),this._attachFieldEventListeners(ethnicityPicker,["custom:selection:changed"]),result},"hpo-picker":function(data){var result=this._generateEmptyField(data),hpoPicker=new Element("input",{type:"text",class:"suggest multi suggest-hpo",name:data.name});result.insert(hpoPicker),hpoPicker._getValue=function(){var results=[],container=this.up(".field-box");return container&&container.select("input[type=hidden][name="+data.name+"]").each(function(item){var valueAll,li=item.up("li");null!=li&&(valueAll=li.retrieve("valueAll")),results.push(new HPOTerm(item.value,item.next(".value")&&item.next(".value").firstChild.nodeValue||item.value,valueAll.hpoPresent,valueAll.hpoModifiers,valueAll))}),[results]}.bind(hpoPicker);var _this=this;return document.observe("custom:selection:changed",function(event){if(event.memo&&event.memo.fieldName==data.name&&event.memo.trigger&&event.findElement()!=event.memo.trigger&&!event.memo.trigger._silent){if(0<_this.form.select("select[name='hpoPresent']").length){var hpoPresent=_this.form.select("select[name='hpoPresent']")[0].getValue(),valueAll=event.memo.customElement.retrieve("valueAll");null==valueAll||valueAll.hpoPresent||(valueAll.hpoPresent=hpoPresent)}Event.fire(event.memo.trigger,"custom:selection:changed"),_this.reposition()}}),this._attachFieldEventListeners(hpoPicker,["custom:selection:changed"]),result},"hpo-modifier-picker":function(data){var result=this._generateEmptyField(data),hpoModifierPicker=new Element("input",{type:"text",class:"suggest multi suggest-hpo-modifier",name:data.name});result.insert(hpoModifierPicker),hpoModifierPicker._getValue=function(){return[[]]}.bind(hpoModifierPicker);var _this=this;return document.observe("custom:selection:changed",function(event){if(event.memo&&event.memo.fieldName==data.name&&event.memo.trigger&&event.findElement()!=event.memo.trigger&&!event.memo.trigger._silent){if(0<_this.form.select("select[name='hpoPresent']").length){var hpoPresent=_this.form.select("select[name='hpoPresent']")[0].getValue(),valueAll=event.memo.customElement.retrieve("valueAll");null==valueAll||valueAll.hpoPresent||(valueAll.hpoPresent=hpoPresent)}Event.fire(event.memo.trigger,"custom:selection:changed"),_this.reposition()}}),this._attachFieldEventListeners(hpoModifierPicker,["custom:selection:changed"]),result},"phenotipsid-picker":function(data){var result=this._generateEmptyField(data),patientPicker=new Element("input",{type:"text",class:"suggest multi suggest-patients",name:data.name});result.insert(patientPicker),patientPicker._getValue=function(){var results=[],container=this.up(".field-box");return container&&container.select("input[type=hidden][name="+data.name+"]").each(function(item){results.push(item.next(".value")&&item.next(".value").firstChild.nodeValue||item.value)}),[results]}.bind(patientPicker);var _this=this;return document.observe("custom:selection:changed",function(event){event.memo&&event.memo.fieldName==data.name&&event.memo.trigger&&event.findElement()!=event.memo.trigger&&!event.memo.trigger._silent&&(Event.fire(event.memo.trigger,"custom:selection:changed"),_this.reposition())}),this._attachFieldEventListeners(patientPicker,["custom:selection:changed"]),result},"gene-picker":function(data){var result=this._generateEmptyField(data),genePicker=new Element("input",{type:"text",class:"suggest multi suggest-genes",name:data.name});result.insert(genePicker),genePicker._getValue=function(){var results=[],container=this.up(".field-box");return container&&container.select("input[type=hidden][name="+data.name+"]").each(function(item){results.push(item.next(".value")&&item.next(".value").firstChild.nodeValue||item.value)}),[results]}.bind(genePicker);var _this=this;return document.observe("custom:selection:changed",function(event){event.memo&&event.memo.fieldName==data.name&&event.memo.trigger&&event.findElement()!=event.memo.trigger&&!event.memo.trigger._silent&&(Event.fire(event.memo.trigger,"custom:selection:changed"),_this.reposition())}),this._attachFieldEventListeners(genePicker,["custom:selection:changed"]),result},select:function(data){var result=this._generateEmptyField(data),span=new Element("span"),style=data.style?data.style:"",isMultipleSelect=data.isMultipleSelect?data.isMultipleSelect:"",multiple="";null!=isMultipleSelect&&1==isMultipleSelect&&(multiple="multiple");var optionHTML='<select name="'+data.name+'" style="'+style+'" '+multiple+">",_generateSelectOption=function(v){optionHTML+='<option value="'+v.actual+'">'+v.displayed+"</option>"};return data.nullValue&&_generateSelectOption({actual:"",displayed:"-"}),"ethnicity"==data.name?PedigreeEditorTool.ethnicityList&&PedigreeEditorTool.ethnicityList.hits.forEach(function(hit){var code,display;code=hit.code,display=hit.display,optionHTML+='<option value="'+code+'">'+display+"</option>"}):data.values?data.values.each(_generateSelectOption):data.range&&$A($R(data.range.start,data.range.end)).each(function(i){_generateSelectOption({actual:i,displayed:i+" "+data.range.item[+(1!=i)]})}),optionHTML+="</select>",span.innerHTML=optionHTML,select=span.firstChild,result.inputsContainer.insert(span),select._getValue=function(){if(null==isMultipleSelect||0==isMultipleSelect)return[0<=this.selectedIndex&&this.options[this.selectedIndex].value||""];if(this.selectedOptions){for(var selected=[],i=0;i<this.selectedOptions.length;i++)selected.push(this.selectedOptions[i].value);return selected}return[0<=this.selectedIndex&&this.options[this.selectedIndex].value||""]}.bind(select),this._attachFieldEventListeners(select,["change"]),result},cancerlist:function(data){var result=this._generateEmptyField(data),cancerList=editor.getCancerLegend()._getAllSupportedCancers(),tableHeaderRow=new Element("tr",{class:"cancer_field cancer-header field-no-user-select"}),label1=new Element("td").insert(new Element("label",{class:"cancer_label_field"}).update("Name")),label2=new Element("td").insert(new Element("label",{class:"cancer_status_select"}).update("Status")),label3=new Element("td").insert(new Element("label",{class:"cancer_age_select"}).update("As of"));tableHeaderRow.insert(label1).insert(label2).insert(label3);var table=new Element("table");table.insert(tableHeaderRow);var spanAgeProto=new Element("span"),optionsHTML='<select name="'+data.name+'" class="cancer_age_select field-no-user-select"><option value=""></option>';optionsHTML+='<option value="before_1">before 1</option>';for(var age=1;age<=100;age++)age%10==0&&(optionsHTML+='<option value="before_'+age+'">'+(age-10+1)+"-"+age+"</option>"),optionsHTML+='<option value="'+age+'">'+age+"</option>";optionsHTML+='<option value="after_100">after 100</option></select>',spanAgeProto.innerHTML=optionsHTML;var spanSelectProto=new Element("span");spanSelectProto.innerHTML="<select name='"+data.name+"' class='cancer_status_select field-no-user-select'><option value=''></option><option value='Affected'>Affected</option><option value='Unaffected'>Unaffected</option></select>";for(var cancersUIElements=[],i=0;i<cancerList.length;i++){var cancerName=cancerList[i],tableRow=new Element("tr",{class:"cancer_field"}),label=new Element("td").insert(new Element("label",{class:"cancer_label_field"}).update(cancerName)),spanAge=spanAgeProto.cloneNode(!0),selectAge=spanAge.firstChild;selectAge.disable(),selectAge.id="cancer_age_"+cancerName;var spanSelect=spanSelectProto.cloneNode(!0),select=spanSelect.firstChild;select.id="cancer_status_"+cancerName;var textInput=new Element("textArea",{type:"text",name:data.name}).hide();textInput.disabled=!0,textInput.id="cancer_notes_"+cancerName;var expandNotes=new Element("label",{class:"clickable cancer-notes",for:textInput.id}).update("<span class='fa fa-file-text-o'></span>"),toggleNotes=function(textInput,expandNotes){return function(){1==textInput.disabled?(textInput.disabled=!1,textInput.show(),expandNotes.hide()):""==textInput.value&&(textInput.hide(),textInput.disabled=!0,expandNotes.show())}}(textInput,expandNotes),enableNotes=function(expandNotes,textInput,toggleNotes){return function(){expandNotes.observe("click",toggleNotes),textInput.observe("blur",toggleNotes),expandNotes.removeClassName("disabled")}}(expandNotes,textInput,toggleNotes),disableNotes=function(expandNotes,textInput,toggleNotes){return function(){expandNotes.stopObserving("click",toggleNotes),textInput.stopObserving("blur",toggleNotes),textInput.value="",textInput.hide(),textInput.disabled=!0,expandNotes.show(),expandNotes.addClassName("disabled")}}(expandNotes,textInput,toggleNotes);expandNotes.enableNotes=enableNotes,expandNotes.disableNotes=disableNotes,cancersUIElements.push({name:cancerName,status:select,age:selectAge,notes:textInput,enableNotes:enableNotes}),select._getValue=function(){for(var data={},i=0;i<cancersUIElements.length;i++){var nextCancer=cancersUIElements[i],statusTxt=0<=nextCancer.status.selectedIndex?nextCancer.status.options[nextCancer.status.selectedIndex].value:"",ageTxt=0<=nextCancer.age.selectedIndex?nextCancer.age.options[nextCancer.age.selectedIndex].value:"",notesTxt=nextCancer.notes.value;if(statusTxt&&""!=statusTxt){var status="affected"==statusTxt,ageNumeric=0;if(Helpers.isInt(ageTxt))ageNumeric=parseInt(ageTxt);else{var before=ageTxt.match(/before_(\d+)/);before&&(ageNumeric=before[1]-5)<0&&(ageNumeric=0);var after=ageTxt.match(/after_(\d+)/);after&&(ageNumeric=after[1])}data[nextCancer.name]={Affected:status,ageAtDiagnosis:ageTxt,numericAgeAtDiagnosis:ageNumeric,notes:notesTxt}}}return[data]},selectAge._getValue=textInput._getValue=select._getValue,this._attachFieldEventListeners(select,["change"]),this._attachFieldEventListeners(selectAge,["change"]),this._attachFieldEventListeners(textInput,["change","keyup"]);var events=["change"];browser.isGecko&&events.push("keyup"),events.each(function(eventName){var selFunc=function(select,selectAge,enableNotes,disableNotes){return function(){0<select.selectedIndex?(selectAge.enable(),enableNotes()):(selectAge.selectedIndex=0,selectAge.disable(),disableNotes())}}(select,selectAge,enableNotes,disableNotes);select.observe(eventName,function(){selFunc()})}),tableRow.insert(label).insert(new Element("td").insert(spanSelect)).insert(new Element("td").insert(spanAge)).insert(new Element("td").insert(expandNotes)),table.insert(tableRow).insert(new Element("tr",{class:"cancer_textarea"}).insert(new Element("td",{colspan:3}).insert(textInput))),result.inputsContainer.insert(table)}var buttonContainer=new Element("div",{class:"button-container"}),noneButton=new Element("span",{class:"patient-menu-button patient-no-cancers-button"}).update("None of the above as of today"),nameHolder=new Element("input",{type:"hidden",name:data.name}),_this=this;return noneButton.observe("click",function(event){for(var i=0;i<cancersUIElements.length;i++){"unaffected"!=cancersUIElements[i].status.value&&(cancersUIElements[i].age.value=""),cancersUIElements[i].status.value="unaffected",cancersUIElements[i].enableNotes(),cancersUIElements[i].age.enable();var birthDate=_this.targetNode.getBirthDate();if(birthDate){var age=getAge(birthDate,_this.targetNode.getDeathDate(),!0);cancersUIElements[i].age.value=age}}Event.fire(nameHolder,"custom:selection:changed"),_this.reposition()}),nameHolder._getValue=cancersUIElements[0].status._getValue,this._attachFieldEventListeners(nameHolder,["custom:selection:changed"]),buttonContainer.update(noneButton).insert(nameHolder),result.inputsContainer.insert(buttonContainer),result},hidden:function(data){var result=this._generateEmptyField(data);result.addClassName("hidden");var input=new Element("input",{type:"hidden",name:data.name,value:""});return result.update(input),result}},show:function(node,x,y){var me=this;this._justOpened=!0,setTimeout(function(){me._justOpened=!1},150),this._onscreen=!0,this.targetNode=node,this._setCrtData(node.getSummary()),this.menuBox.show(),this.reposition(x,y);var clinicalIndicationNames=document.getElementsByName("clinicalIndicationName"),clinicalIndicationValue=document.getElementById("clinical-indication-name").innerHTML.split("<span")[0];clinicalIndicationNames&&!clinicalIndicationNames.forEach&&(clinicalIndicationNames=[].slice.call(clinicalIndicationNames)),clinicalIndicationNames.forEach(function(clinicalIndicationName){clinicalIndicationName.value=clinicalIndicationValue}),document.observe("mousedown",this._onClickOutside)},hide:function(){this._justOpened||(this.hideSuggestPicker(),this._onscreen=!1,document.stopObserving("mousedown",this._onClickOutside),this.targetNode&&(this.targetNode.onWidgetHide(),delete this.targetNode),this.menuBox.hide(),this._clearCrtData())},hideSuggestPicker:function(){this.form.select("input.suggest").each(function(item){item._suggest&&item._suggest.clearSuggestions()})},isVisible:function(){return this._onscreen},_onClickOutside:function(event){event.findElement(".suggestItems")||this.hideSuggestPicker(),event.findElement(".menu-box")||event.findElement(".suggestItems")||this.hide()},reposition:function(x,y){if(void 0!==(x=Math.floor(x))&&isFinite(x)){if(this.canvas&&x+this.menuBox.getWidth()>this.canvas.getWidth()+10){var delta=x+this.menuBox.getWidth()-this.canvas.getWidth();editor.getWorkspace().panByX(delta,!0),x-=delta}this.menuBox.style.left=x+"px"}var height=this.menuBox.style.height="",top="";if(void 0!==y&&isFinite(y))y=Math.floor(y);else if(0<this.menuBox.style.top.length)try{y=parseInt(this.menuBox.style.top.match(/^(\d+)/g)[0])}catch(err){}if((void 0===y||!isFinite(y)||y<0)&&(y=0),this.canvas&&this.menuBox.getHeight()>=this.canvas.getHeight()-1)top=0,height=this.canvas.getHeight()-1+"px";else if(this.canvas.getHeight()<y+this.menuBox.getHeight()+1){var position=y-(y+this.menuBox.getHeight()-this.canvas.getHeight()+1);height=position<0?(top=0,this.canvas.getHeight()-1+"px"):(top=position+"px","")}else top=y+"px",height="";this.menuBox.style.top=top,this.menuBox.style.height=height,this.menuBox.style.overflow="auto"},_clearCrtData:function(){var _this=this;Object.keys(this.fieldMap).each(function(name){_this.fieldMap[name].crtValue=_this.fieldMap[name].default,_this._setFieldValue[_this.fieldMap[name].type].call(_this,_this.fieldMap[name].element,_this.fieldMap[name].crtValue),_this.fieldMap[name].inactive=!1})},_setCrtData:function(data){var _this=this;Object.keys(this.fieldMap).each(function(name){"label"!=_this.fieldMap[name].type?(_this.fieldMap[name].crtValue=data&&data[name]&&void 0!==data[name].value?data[name].value:_this.fieldMap[name].crtValue||_this.fieldMap[name].default,_this.fieldMap[name].inactive=data&&data[name]&&("boolean"==typeof data[name].inactive||"object"==typeof data[name].inactive)?data[name].inactive:_this.fieldMap[name].inactive,_this.fieldMap[name].disabled=data&&data[name]&&("boolean"==typeof data[name].disabled||"object"==typeof data[name].disabled)?data[name].disabled:_this.fieldMap[name].disabled,_this._setFieldValue[_this.fieldMap[name].type].call(_this,_this.fieldMap[name].element,_this.fieldMap[name].crtValue),_this._setFieldInactive[_this.fieldMap[name].type].call(_this,_this.fieldMap[name].element,_this.fieldMap[name].inactive),_this._setFieldDisabled[_this.fieldMap[name].type].call(_this,_this.fieldMap[name].element,_this.fieldMap[name].disabled)):data[name]&&(_this.fieldMap[name].inactive=data&&data[name]&&("boolean"==typeof data[name].inactive||"object"==typeof data[name].inactive)?data[name].inactive:_this.fieldMap[name].inactive,_this._setFieldInactive[_this.fieldMap[name].type].call(_this,_this.fieldMap[name].element,_this.fieldMap[name].inactive))})},_setFieldValue:{radio:function(container,value){var target=container.down("input[type=radio][value="+value+"]");target&&(target.checked=!0)},checkbox:function(container,value){var checkbox=container.down("input[type=checkbox]");checkbox&&(checkbox.checked=value)},text:function(container,value){var target=container.down("input[type=text]");target&&(target.value=value),this._restoreCursorPositionIfNecessary(target)},label:function(container,value){},textarea:function(container,value){var target=container.down("textarea");target&&(target.value=value),this._restoreCursorPositionIfNecessary(target)},"date-picker":function(container,value){value||(value={decade:"",year:"",month:"",day:""});var year="",month="",day="";value.decade&&!value.year?year=value.decade:value.year&&(year=value.year.toString());var dateEditFormat=editor.getPreferencesManager().getConfigurationOption("dateEditFormat"),dmyInputMode="DMY"==dateEditFormat||"MY"==dateEditFormat;(dmyInputMode||value.year)&&value.month&&(month=value.month.toString()),(dmyInputMode||value.year&&value.month)&&value.day&&(day=value.day.toString());var updated=!1,yearSelect=container.down("select.year");yearSelect&&((option=yearSelect.down("option[value="+year+"]"))||(option=new Element("option",{value:year}).update(year.toString()),yearSelect.insert(option)),option&&!option.selected&&(updated=option.selected=!0));var monthSelect=container.down("select.month");monthSelect&&((option=monthSelect.down("option[value="+month+"]"))&&!option.selected&&(updated=option.selected=!0));var option,daySelect=container.down("select.day");daySelect&&((option=daySelect.down("option[value="+day+"]"))&&!option.selected&&(updated=option.selected=!0));if(updated){var updateElement=container.down(".fuzzy-date-picker");updateElement&&Event.fire(updateElement,"datepicker:date:changed")}},"disease-picker":function(container,values){var _this=this,target=container.down("input[type=text].suggest-omim");target&&target._suggestPicker&&(target._silent=!0,target._suggestPicker.clearAcceptedList(),values&&values.each(function(v){target._suggestPicker.addItem(v.id,v.value,"",null,v.valueAll),_this._updateDisorderColor(v.id,editor.getDisorderLegend().getObjectColor(v.id))}),target._silent=!1)},"ethnicity-picker":function(container,values){var target=container.down("input[type=text].suggest-ethnicity");target&&target._suggestPicker&&(target._silent=!0,target._suggestPicker.clearAcceptedList(),values&&values.each(function(v){target._suggestPicker.addItem(v,v,"")}),target._silent=!1)},"hpo-picker":function(container,values){var target=container.down("input[type=text].suggest-hpo");if(target&&target._suggestPicker){target._silent=!0,target._suggestPicker.clearAcceptedList();container.down("input[type=text].suggest-hpo-modifier");values&&values.each(function(v){target._suggestPicker.addItem(v.id,v.value,"",null,v.valueAll)}),target._silent=!1}},"hpo-modifier-picker":function(container,values){var target=container.down("input[type=text].suggest-hpo-modifier");target&&target._suggestPicker&&(target._silent=!0,target._suggestPicker.clearAcceptedList(),values&&values.each(function(v){target._suggestPicker.addItem(v.id,v.value,"",null,v.valueAll)}),target._silent=!1)},"gene-picker":function(container,values){var _this=this,target=container.down("input[type=text].suggest-genes");target&&target._suggestPicker&&(target._silent=!0,target._suggestPicker.clearAcceptedList(),values&&values.each(function(v){target._suggestPicker.addItem(v,v,""),_this._updateGeneColor(v,editor.getGeneLegend().getObjectColor(v))}),target._silent=!1)},"phenotipsid-picker":function(container,values){var target=container.down("input[type=text].suggest-genes");target&&target._suggestPicker&&(target._silent=!0,target._suggestPicker.clearAcceptedList(),values&&values.each(function(v){target._suggestPicker.addItem(v,v,"")}),target._silent=!1)},select:function(container,value){if(null==container.down("select").multiple||0==container.down("select").multiple){(target=container.down("select option[value="+value+"]"))&&(target.selected="selected")}else{if(!value||!value.length)return;for(var i=0;i<value.length;i++){var target;(target=container.down("select option[value="+value[i]+"]"))&&(target.selected="selected")}}},cancerlist:function(container,value){for(var cancerList=editor.getCancerLegend()._getAllSupportedCancers(),i=0;i<cancerList.length;i++){var cancerName=cancerList[i],statusSelect=container.down('select[id="cancer_status_'+cancerName+'"]'),ageSelect=container.down('select[id="cancer_age_'+cancerName+'"]'),notesInput=container.down('"#cancer_notes_'+cancerName+'"'),enableNotesIcon=container.down("label[for="+notesInput.id+"]");if(statusSelect){if(value.hasOwnProperty(cancerName)){if(value[cancerName].hasOwnProperty("Affected")&&value[cancerName].affected)var optionStatus=statusSelect.down('option[value="Affected"]');else optionStatus=statusSelect.down('option[value="Unaffected"]');if(value[cancerName].hasOwnProperty("ageAtDiagnosis"))var ageOption=ageSelect.down('option[value="'+value[cancerName].ageAtDiagnosis+'"]');else ageOption=ageSelect.down('option[value=""]');value[cancerName].hasOwnProperty("notes")&&""!=value[cancerName].notes?(notesInput.value=value[cancerName].notes,notesInput.show(),notesInput.disabled=!1,enableNotesIcon.hide()):value[cancerName].hasOwnProperty("notes")&&""==value[cancerName].notes?enableNotesIcon.enableNotes():(notesInput.hide(),notesInput.disabled=!0,enableNotesIcon.show(),enableNotesIcon.removeClassName("disabled")),ageSelect.enable()}else{optionStatus=statusSelect.down('option[value=""]'),ageOption=ageSelect.down('option[value=""]');ageSelect.disable(),notesInput.value="",notesInput.hide(),notesInput.disabled=!0,enableNotesIcon&&enableNotesIcon.disableNotes()}optionStatus&&(optionStatus.selected="selected"),ageOption&&(ageOption.selected="selected")}else alert("This patient is reported to have an unsupported cancer '"+cancerName+"'")}},hidden:function(container,value){var target=container.down("input[type=hidden]");target&&(target.value=value)}},_toggleFieldVisibility:function(container,doHide){doHide?container.addClassName("hidden"):container.removeClassName("hidden")},_setFieldInactive:{label:function(container,inactive){this._toggleFieldVisibility(container,inactive)},radio:function(container,inactive){!0===inactive?container.addClassName("hidden"):(container.removeClassName("hidden"),container.select("input[type=radio]").each(function(item){if(inactive&&"[object Array]"===Object.prototype.toString.call(inactive)){var disableViaOpacity=0<=inactive.indexOf("disableViaOpacity");0<=inactive.indexOf(item.value)?(item.disable(),disableViaOpacity?Element.setOpacity(item.up(),0):item.up().addClassName("hidden")):(item.enable(),disableViaOpacity?Element.setOpacity(item.up(),1):item.up().removeClassName("hidden"))}else inactive||(item.enable(),Element.setOpacity(item.up(),1),item.up().removeClassName("hidden"))}))},checkbox:function(container,inactive){this._toggleFieldVisibility(container,inactive)},text:function(container,inactive){this._toggleFieldVisibility(container,inactive)},textarea:function(container,inactive){this._toggleFieldVisibility(container,inactive)},"date-picker":function(container,inactive){this._toggleFieldVisibility(container,inactive)},"disease-picker":function(container,inactive){this._toggleFieldVisibility(container,inactive)},"ethnicity-picker":function(container,inactive){this._toggleFieldVisibility(container,inactive)},"hpo-picker":function(container,inactive){this._toggleFieldVisibility(container,inactive)},"hpo-modifier-picker":function(container,inactive){this._toggleFieldVisibility(container,inactive)},"gene-picker":function(container,inactive){this._toggleFieldVisibility(container,inactive)},"phenotipsid-picker":function(container,inactive){this._toggleFieldVisibility(container,inactive)},select:function(container,inactive){!0===inactive?container.addClassName("hidden"):(container.removeClassName("hidden"),container.select("option").each(function(item){inactive&&"[object Array]"===Object.prototype.toString.call(inactive)?0<=inactive.indexOf(item.value)?item.addClassName("hidden"):item.removeClassName("hidden"):inactive||item.removeClassName("hidden")}))},cancerlist:function(container,inactive){this._toggleFieldVisibility(container,inactive)},hidden:function(container,inactive){this._toggleFieldVisibility(container,inactive)}},_setFieldDisabled:{radio:function(container,disabled){disabled&&("[object Array]"===Object.prototype.toString.call(disabled)?container.select("input[type=radio]").each(function(item){item.disabled=0<=disabled.indexOf(item.value)}):!0!==disabled&&!1!==disabled||container.select("input[type=radio]").each(function(item){item.disabled=disabled}))},checkbox:function(container,disabled){var target=container.down("input[type=checkbox]");target&&(target.disabled=disabled)},text:function(container,disabled){var target=container.down("input[type=text]");target&&(target.disabled=disabled)},label:function(container,disabled){},textarea:function(container,inactive){var target=container.down("textarea");target&&(target.disabled=inactive)},"date-picker":function(container,disabled){Element.select(container,"select").forEach(function(element){disabled?(Helpers.disableMouseclicks(element),element.addClassName("disabled-select"),element.addClassName("no-mouse-interaction")):(Helpers.enableMouseclicks(element),element.removeClassName("disabled-select"),element.removeClassName("no-mouse-interaction"))})},"disease-picker":function(container,disabled){this.__disableEnableSuggestModification(container,disabled)},"ethnicity-picker":function(container,disabled){this.__disableEnableSuggestModification(container,disabled)},"hpo-picker":function(container,disabled){this.__disableEnableSuggestModification(container,disabled)},"hpo-modifier-picker":function(container,disabled){this.__disableEnableSuggestModification(container,disabled)},"gene-picker":function(container,disabled){this.__disableEnableSuggestModification(container,disabled)},"phenotipsid-picker":function(container,inactive){},select:function(container,inactive){Element.select(container,"select").forEach(function(element){inactive?(Helpers.disableMouseclicks(element),element.addClassName("disabled-select"),element.addClassName("no-mouse-interaction")):(Helpers.enableMouseclicks(element),element.removeClassName("disabled-select"),element.removeClassName("no-mouse-interaction"))})},cancerlist:function(container,inactive){},hidden:function(container,inactive){}},__disableEnableSuggestModification:function(container,disabled){var numElements=0;Element.select(container,".delete-tool").forEach(function(element){numElements++,disabled?element.addClassName("hidden"):element.removeClassName("hidden")}),Element.select(container,"input").forEach(function(element){(element.disabled=disabled)?1<numElements?element.addClassName("hidden"):element.placeholder="none":(element.removeClassName("hidden"),element.placeholder="")})}});var NodetypeSelectionBubble=Class.create({buttonsDefs:[{key:"M",type:"person",label:"Male",tip:"Create a person of male gender",symbol:"<span></span>",cssclass:"square",callback:"CreateChild",params:{parameters:{gender:"M"}},inSiblingMode:!0},{key:"F",type:"person",label:"Female",tip:"Create a person of female gender",symbol:"<span></span>",cssclass:"circle",callback:"CreateChild",params:{parameters:{gender:"F"}},inSiblingMode:!0},{key:"O",type:"person",label:"Other",tip:"Create a person of indeterminate gender",symbol:"<span></span>",cssclass:"diamond",callback:"CreateChild",params:{parameters:{gender:"O"}},inSiblingMode:!0},{key:"U",type:"person",label:"Unknown",tip:"Create a person of unknown gender",symbol:"<span></span>",cssclass:"diamond",callback:"CreateChild",params:{parameters:{gender:"U"}},inSiblingMode:!0},{key:"P",type:"person",label:"Pregnancy",tip:"Create a pregnancy",symbol:"<span></span><strong>P</strong>",cssclass:"diamond text-in-middle",callback:"CreateChild",params:{parameters:{lifeStatus:"Unborn"}},inSiblingMode:!0},{key:"T",type:"person",label:"Twins",tip:"Create twins (expandable to triplets or more)",symbol:"&#8896;",cssclass:"",callback:"CreateChild",params:{twins:!0,parameters:{gender:"U"}},expandsTo:"expandTwins",inSiblingMode:!0},{key:"m",type:"person",label:"Multiple",tip:"Create a node representing multiple siblings",symbol:"<span></span><strong>n</strong>",cssclass:"diamond text-in-middle",callback:"CreateChild",params:{group:!0},expandsTo:"expandPersonGroup",inSiblingMode:!0},{type:"separator"},{key:"n",type:"marker",label:"No children",tip:"Mark as Childless by choice",symbol:"&#9524;",cssclass:"",callback:"setProperty",params:{setChildlessStatus:"Childless"},inSiblingMode:!1},{key:"i",type:"marker",label:"Infertile",tip:"Mark as Infertile",symbol:"&#9575;",cssclass:"",callback:"setProperty",params:{setChildlessStatus:"Infertile"},inSiblingMode:!1}],initialize:function(siblingMode){this._siblingMode=siblingMode,this.element=new Element("div",{class:"callout"}),this.element.insert(new Element("span",{class:"callout-handle"}));var container=new Element("div",{class:"node-type-options field-no-user-select"});this.expandedOptionsContainer=new Element("div",{class:"node-type-options-extended field-no-user-select"}),this.element.insert(container),this.element.insert(this.expandedOptionsContainer);var _this=this;this.buttonsDefs.each(function(def){(!siblingMode||def.hasOwnProperty("inSiblingMode")&&def.inSiblingMode)&&container.insert("separator"==def.type?_this._generateSeparator():_this._createOption(def))}),this.element.hide(),editor.getWorkspace().getWorkArea().insert(this.element),this._onClickOutside=this._onClickOutside.bindAsEventListener(this),this.resetParameters()},resetParameters:function(){this.numPersonsInGroup=1,this.numTwinNodes=2},_createOption:function(data){if(!data)return null;var expandablePrefix="function"==typeof this[data.expandsTo]?"expandable-":"",o=new Element("a",{class:data.cssclass+" "+expandablePrefix+"node-type-option "+(data.type||"")+"-type-option node-type-"+data.key,title:data.tip,href:"#"}).update(data.symbol),_this=this;o.observe("click",function(event){if(event.stop(),_this._node){if(console.log("observe nodetype click: "+data.callback),"setProperty"==data.callback){event={nodeID:_this._node.getID(),properties:data.params};document.fire("pedigree:node:setproperty",event)}else"CreateChild"==data.callback&&_this.handleCreateAction(data);_this.hide()}});var container=new Element("span");return container.insert(o),expandablePrefix&&container.insert(this.generateExpandArrow(data)),container},handleCreateAction:function(data){var id=this._node.getID(),nodeType=this._node.getType();if("Person"==nodeType){var event={personID:id,childParams:data.params.parameters,preferLeft:!1};data.params.twins&&(event.twins=this.numTwinNodes),data.params.group&&(event.groupSize=this.numPersonsInGroup),this._siblingMode?document.fire("pedigree:person:newsibling",event):document.fire("pedigree:person:newpartnerandchild",event)}else if("Partnership"==nodeType){event={partnershipID:id,childParams:data.params.parameters};data.params.twins&&(event.twins=this.numTwinNodes),data.params.group&&(event.groupSize=this.numPersonsInGroup),document.fire("pedigree:partnership:newchild",event)}this.hide()},generateExpandArrow:function(data){var expandArrow=new Element("span",{class:"expand-arrow collapsed",title:"show more options",href:"#"}).update("&#9662;");return expandArrow.expand=function(){$$(".expand-arrow").forEach(function(arrow){arrow.collapse()}),this[data.expandsTo](data),expandArrow.update("&#9652;"),Element.removeClassName(expandArrow,"collapsed")}.bind(this),expandArrow.collapse=function(){this.expandedOptionsContainer.update(""),expandArrow.update("&#9662;"),Element.addClassName(expandArrow,"collapsed")}.bind(this),expandArrow.observe("click",function(){console.log("observe2"),expandArrow.hasClassName("collapsed")?expandArrow.expand():expandArrow.collapse()}),expandArrow},_generateSeparator:function(){return new Element("span",{class:"separator"}).update(" | ")},_positionAt:function(x,y){(y=Math.round(y))+this.element.getHeight()>editor.getWorkspace().getWorkArea().getHeight()&&(this.element.addClassName("upside"),y=Math.round(y-this.element.getHeight())),this.element.style.top=y+"px";var dx=Math.round(this.element.getWidth()/2);x-dx+this.element.getWidth()>editor.getWorkspace().getWorkArea().getWidth()?dx=Math.round(this.element.getWidth()-(editor.getWorkspace().getWorkArea().getWidth()-x)):x<dx&&(dx=Math.round(x)),this.element.down(".callout-handle").style.left=dx+"px",this.element.style.left=Math.round(x-dx)+"px"},show:function(node,x,y){this._node=node,this._node&&(this._node.onWidgetShow(),this._node._isProband||this._node._ngisRegisteredPatientUid?(this.element.select(".node-type-n").invoke("hide"),this.element.select(".node-type-i").invoke("hide")):(this.element.select(".node-type-n").invoke("show"),this.element.select(".node-type-i").invoke("show")),"Partnership"==this._node._type&&"Childless"==this._node._childlessStatus?(this.element.select(".node-type-T").invoke("hide"),this.element.select(".node-type-m").invoke("hide"),this.element.select(".node-type-n").invoke("hide"),this.element.select(".node-type-i").invoke("hide")):(this.element.select(".node-type-T").invoke("show"),this.element.select(".node-type-m").invoke("show"),this.element.select(".node-type-n").invoke("show"),this.element.select(".node-type-i").invoke("show")),this.element.show(),this.expandedOptionsContainer.update(""),this._positionAt(x,y),document.observe("mousedown",this._onClickOutside))},hide:function(){document.stopObserving("mousedown",this._onClickOutside),$$(".expand-arrow").forEach(function(arrow){arrow.collapse()}),this._node&&(this._node.onWidgetHide(),delete this._node,this.element.select(".node-type-option").invoke("show"),this.element.removeClassName("upside")),this.element.hide(),this.resetParameters()},_onClickOutside:function(event){event.findElement(".callout")||this.hide()},_decrementNumNodes:function(){return 1<this.numPersonsInGroup?--this.numPersonsInGroup:this.numPersonsInGroup},_incrementNumNodes:function(){return this.numPersonsInGroup<9?++this.numPersonsInGroup:this.numPersonsInGroup},_decrementNumTwins:function(){return 2<this.numTwinNodes?--this.numTwinNodes:this.numTwinNodes},_incrementNumTwins:function(){return this.numTwinNodes<9?++this.numTwinNodes:this.numTwinNodes},expandPersonGroup:function(personGroupMenuInfo){var me=this,generateIcon=function(){return'<svg version="1.1" viewBox="0.0 0.0 100.0 100.0" width=50 height=50 fill="none" stroke="none" stroke-linecap="square" stroke-miterlimit="10" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><clipPath id="p.0"><path d="m0 0l960.0 0l0 720.0l-960.0 0l0 -720.0z" clip-rule="nonzero"></path></clipPath><g clip-path="url(#p.0)"><path fill="#000000" fill-opacity="0.0" d="m0 0l960.0 0l0 720.0l-960.0 0z" fill-rule="nonzero"></path><path fill="#cfe2f3" d="m1.2283465 49.97113l48.53543 -48.535435l48.53543 48.535435l-48.53543 48.53543z" fill-rule="nonzero"></path><path stroke="#000000" stroke-width="2.0" stroke-linejoin="round" stroke-linecap="butt" d="m1.2283465 49.97113l48.53543 -48.535435l48.53543 48.535435l-48.53543 48.53543z" fill-rule="nonzero"></path><path fill="#000000" fill-opacity="0.0" d="m20.661417 22.068241l58.204727 0l0 48.000004l-58.204727 0z" fill-rule="nonzero"></path></g><desc>Number of children</desc><text x="35" y="60" font-family="Verdana" font-size="40" fill="black">'+(1<me.numPersonsInGroup?String(me.numPersonsInGroup):"n")+"</text></svg>"},createBtn=new Element("input",{type:"button",value:"create",class:"button"}),svgContainer=new Element("span").update(generateIcon()),minusBtn=new Element("span",{class:"minus-button value-control-button"}).update("-"),plusBtn=new Element("span",{class:"plus-button value-control-button"}).update("+");minusBtn.observe("click",function(){me._decrementNumNodes(),svgContainer.update(generateIcon())}),plusBtn.observe("click",function(){me._incrementNumNodes(),svgContainer.update(generateIcon())}),createBtn.observe("click",function(){me.handleCreateAction(personGroupMenuInfo)}),this.expandedOptionsContainer.insert(minusBtn),this.expandedOptionsContainer.insert(svgContainer),this.expandedOptionsContainer.insert(plusBtn),this.expandedOptionsContainer.insert(createBtn)},expandTwins:function(twinMenuInfo){var me=this,generateIcon=function(){return'<svg version="1.1" viewBox="0.0 0.0 100.0 100.0" width=50 height=50 fill="none" stroke="none" stroke-linecap="square" stroke-miterlimit="10" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><clipPath id="p.0"><path d="m0 0l960.0 0l0 720.0l-960.0 0l0 -720.0z" clip-rule="nonzero"></path></clipPath><g clip-path="url(#p.0)"><path fill="#000000" fill-opacity="0.0" d="m0 0l960.0 0l0 720.0l-960.0 0z" fill-rule="nonzero"></path><path fill="#cfe2f3" d="m1.2283465 49.97113l48.53543 -48.535435l48.53543 48.535435l-48.53543 48.53543z" fill-rule="nonzero"></path><path stroke="#000000" stroke-width="2.0" stroke-linejoin="round" stroke-linecap="butt" d="m1.2283465 49.97113l48.53543 -48.535435l48.53543 48.535435l-48.53543 48.53543z" fill-rule="nonzero"></path><path fill="#000000" fill-opacity="0.0" d="m20.661417 22.068241l58.204727 0l0 48.000004l-58.204727 0z" fill-rule="nonzero"></path></g><desc>Number of children</desc><text x="35" y="60" font-family="Verdana" font-size="40" fill="black">'+(me._siblingMode&&"Partnership"!=me._node.getType()?me.numTwinNodes-1:me.numTwinNodes)+"</text></svg>"};if(this._siblingMode)var createBtn=new Element("input",{type:"button",value:"add twins",class:"button"});else createBtn=new Element("input",{type:"button",value:"create twins",class:"button"});var svgContainer=new Element("span").update(generateIcon()),minusBtn=new Element("span",{class:"minus-button value-control-button"}).update("-"),plusBtn=new Element("span",{class:"plus-button value-control-button"}).update("+");minusBtn.observe("click",function(){me._decrementNumTwins(),svgContainer.update(generateIcon())}),plusBtn.observe("click",function(){me._incrementNumTwins(),svgContainer.update(generateIcon())}),createBtn.observe("click",function(){me.handleCreateAction(twinMenuInfo)}),this.expandedOptionsContainer.insert(minusBtn),this.expandedOptionsContainer.insert(svgContainer),this.expandedOptionsContainer.insert(plusBtn),this.expandedOptionsContainer.insert(createBtn)}}),GraphicHelpers={};GraphicHelpers.sector=function(canvas,xPosition,yPosition,radius,gender,startAngle,endAngle,color){var gen=gender,cx=xPosition,cy=yPosition,r=radius,paper=canvas,rad=Math.PI/180,shapeAttributes={fill:color,"stroke-width":0},circleCoordinate=function(alpha){return[cx+r*Math.cos(-alpha*rad),cy+r*Math.sin(-alpha*rad)]};if("F"===gen){if(endAngle-startAngle==360)return paper.circle(cx,cy,r).attr(shapeAttributes);var x1=circleCoordinate(startAngle)[0],x2=circleCoordinate(endAngle)[0],y1=circleCoordinate(startAngle)[1],y2=circleCoordinate(endAngle)[1];return paper.path(["M",cx,cy,"L",x1,y1,"A",r,r,0,+(180<endAngle-startAngle),0,x2,y2,"z"]).attr(shapeAttributes)}if("M"===gen){function sideAtAngle(angle){return((angle+45)/90).floor()%4}function getCoord(alpha){var side=sideAtAngle(alpha),result={},xFactor=side%2,yFactor=1-side%2,sideFactor=side%3?-1:1;result.angle=(alpha-90*side-(0==side&&45<alpha?360:0))*(side<2?-1:1);var degrees,radians,d=r*(degrees=result.angle,radians=degrees*Math.PI/180,Math.tan(radians));return result.x=cx+xFactor*d+yFactor*sideFactor*r,result.y=cy+yFactor*d+xFactor*sideFactor*r,result}function getNextCorner(side){var factorA=side%3?-1:1,factorB=side<2?-1:1,result={};return result.x=cx+factorA*r,result.y=cy+factorB*r,result}var startSide=sideAtAngle(startAngle),endSide=sideAtAngle(endAngle);0==endSide&&startAngle<endAngle&&(endSide=315<=startAngle?0:4);for(var numSides=endSide-startSide,startCoord=getCoord(startAngle),endCoord=getCoord(endAngle),sectorPathData=["M",endCoord.x,endCoord.y,"L",cx,cy,"L",startCoord.x,startCoord.y],currentSide=startSide;0<numSides;)sectorPathData.push("L",getNextCorner(currentSide).x+" "+getNextCorner(currentSide).y),currentSide=++currentSide%4,numSides--;return sectorPathData.push("L",endCoord.x,endCoord.y,"z"),paper.path(sectorPathData).attr(shapeAttributes)}var shape=GraphicHelpers.sector(paper,cx,cy,r*(Math.sqrt(3)/2),"M",startAngle,endAngle,color);return shape.transform(["...r-45,",cx,cy]).attr(shapeAttributes),shape},GraphicHelpers.generateOrb=function(canvas,x,y,r,gender){if(!gender||"F"==gender)return canvas.set(canvas.ellipse(x,y,r,r),canvas.ellipse(x,y,r-r/5,r-r/20).attr({stroke:"none",fill:"r(.5,.1)#ccc-#ccc",opacity:0}));if("M"==gender){var rr=r-1;return canvas.set(canvas.rect(x-rr,y-rr,2*rr,2*rr,0),canvas.rect(x-rr,y-rr,2*rr,2*rr,1).attr({stroke:"none",fill:"330-#ccc-#ccc",opacity:0}))}if("U"==gender){rr=.9*(r-1);return canvas.set(canvas.rect(x-rr,y-rr,2*rr,2*rr,0).attr({transform:"r45"}),canvas.rect(x-rr,y-rr,2*rr,2*rr,1).attr({stroke:"none",fill:"330-#ccc-#ccc",opacity:0}).attr({transform:"r45"}))}},GraphicHelpers.drawCornerCurve=function(xFrom,yFrom,xTo,yTo,bendDown,attr,doubleCurve,shiftx1,shifty1,shiftx2,shifty2){var curve,xDistance=xTo-xFrom,yDistance=yFrom-yTo,dist1x=xDistance/2,dist2x=xDistance/10,dist1y=yDistance/2,dist2y=yDistance/10;if(bendDown){var raphaelPath="M "+xFrom+" "+yFrom+" C "+(xFrom+dist1x)+" "+(yFrom+dist2y)+" "+(xTo+dist2x)+" "+(yTo+dist1y)+" "+xTo+" "+yTo;curve=editor.getPaper().path(raphaelPath).attr(attr).toBack()}else{raphaelPath="M "+xFrom+" "+yFrom+" C "+(xFrom-dist2x)+" "+(yFrom-dist1y)+" "+(xTo-dist1x)+" "+(yTo-dist2y)+" "+xTo+" "+yTo;curve=editor.getPaper().path(raphaelPath).attr(attr).toBack()}if(doubleCurve){var curve2=curve.clone().toBack();curve.transform("t "+shiftx1+","+shifty1+"..."),curve2.transform("t "+shiftx2+","+shifty2+"...")}},GraphicHelpers.drawLevelChangeCurve=function(xFrom,yFrom,xTo,yTo,attr,doubleCurve,shiftx1,shifty1,shiftx2,shifty2){var dist1x=(xTo-xFrom)/2,raphaelPath=" M "+xFrom+" "+yFrom;if(raphaelPath+=" C "+(xFrom+dist1x)+" "+yFrom+" "+(xTo-dist1x)+" "+yTo+" "+xTo+" "+yTo,curve=editor.getPaper().path(raphaelPath).attr(attr).toBack(),doubleCurve){var curve2=curve.clone().toBack();curve.transform("t "+shiftx1+","+shifty1+"..."),curve2.transform("t "+shiftx2+","+shifty2+"...")}},GraphicHelpers.findXInterceptGivenLineAndY=function(crossY,x1,y1,x2,y2){if(x1==x2)return x1;var a=(y1-y2)/(x1-x2);return(crossY-(y1-a*x1))/a},GraphicHelpers.getElementHalfHeight=function(t){return Math.floor(t.getBBox().height/2)},GraphicHelpers.getCaretPosition=function(elem){if(void 0!==elem.selectionEnd)return elem.selectionEnd;if(elem.createTextRange&&document.selection){var r=document.selection.createRange();return r.moveStart("character",-elem.value.length),r.text.length}return null},GraphicHelpers.setCaretPosition=function(ctrl,pos){if(!(null==pos||pos<=0))if(ctrl.setSelectionRange)ctrl.focus(),ctrl.setSelectionRange(pos,pos);else if(ctrl.createTextRange){var range=ctrl.createTextRange();range.collapse(!0),range.moveEnd("character",pos),range.moveStart("character",pos),range.select()}},Raphael.st.flatten=function(){var flattenedSet=new Raphael.st.constructor;return this.forEach(function(element){flattenedSet=flattenedSet.concat(element.flatten())}),flattenedSet},Raphael.el.flatten=function(){return this.paper.set(this)},Raphael.st.concat=function(set){var newSet=this.copy();return"function"==typeof set.forEach?set.forEach(function(element){newSet.push(element)}):newSet.push(set),newSet},Raphael.st.contains=function(target){var found=!1;return this.forEach(function(element){element==target&&(found=!0)}),found},Raphael.st.copy=function(){var newSet=new Raphael.st.constructor;return this.forEach(function(element){newSet.push(element)}),newSet},window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)};var Legend=Class.create({initialize:function(title,allowDrop,initiallyHide){if(this._initiallyHide=initiallyHide,this._affectedNodes={},this._objectColors={},this._preferredColors={},(this._previousHighightedNode=null)==(legendContainer=$("legend-container"))){editor.isReadOnlyMode()||(this._legendInfo=new Element("div",{class:"legend-box legend-info",id:"legend-info"}).insert(new Element("div",{class:"infomessage"}).insert("You can drag and drop all items from the list(s) below onto individuals in the pedigree to mark them as affected.")),this.closeButton=new Element("span",{class:"close-button"}).update(" "),this.closeButton.observe("click",this.hideDragHint.bindAsEventListener(this)),this._legendInfo.insert({top:this.closeButton}),this._legendInfo.hide());var legendContainer=new Element("div",{class:"legend-container",id:"legend-container"}).insert(this._legendInfo);editor.getWorkspace().getWorkArea().insert(legendContainer)}else editor.isReadOnlyMode()||(this._legendInfo=legendContainer.down("#legend-info"));this._legendBox=new Element("div",{class:"legend-box",id:this._getPrefix()+"-legend-box"}),this._legendBox.hide(),legendContainer.insert(this._legendBox);var showMoreIcon=new Element("i",{class:"fa  rightIcon"});!0===this._initiallyHide?showMoreIcon.addClassName("fa-angle-double-down"):showMoreIcon.addClassName("fa-angle-double-up");var plusElement=new Element("span",{style:"cursor:pointer;font-size: 90%;"}).insert(title).insert(showMoreIcon),legendTitle=new Element("h2",{class:"legend-title"}).update(plusElement),divTitle=new Element("div",{class:""}).update(legendTitle),self=this;showMoreIcon.on("click",function(event){var nextUL;this.hasClassName("fa-angle-double-down")?(0<(nextUL=$$("ul."+self._getPrefix()+"-list")).length&&nextUL[0].show(),this.removeClassName("fa-angle-double-down"),this.addClassName("fa-angle-double-up")):(0<(nextUL=$$("ul."+self._getPrefix()+"-list")).length&&nextUL[0].hide(),this.addClassName("fa-angle-double-down"),this.removeClassName("fa-angle-double-up"))}),this._legendBox.insert(divTitle),this._list=new Element("ul",{class:this._getPrefix()+"-list abnormality-list"}),this._legendBox.insert(this._list),!0===this._initiallyHide&&this._list.hide(),Element.observe(this._legendBox,"mouseover",function(){$$(".menu-box").invoke("setOpacity",.1)}),Element.observe(this._legendBox,"mouseout",function(){$$(".menu-box").invoke("setOpacity",1)}),allowDrop&&Droppables.add(editor.getWorkspace().canvas,{accept:"drop-"+this._getPrefix(),onDrop:this._onDropWrapper.bind(this),onHover:this._onHoverWrapper.bind(this)})},_getPrefix:function(id){throw"prefix not defined"},hideDragHint:function(){editor.getPreferencesManager().setConfigurationOption("user","hideDraggingHint",!0),this._legendInfo.hide()},getObjectColor:function(id){return this._objectColors.hasOwnProperty(id)?this._objectColors[id]:"#ff0000"},getAllColors:function(){return this._objectColors},setAllPreferredColors:function(allColors){for(id in allColors)allColors.hasOwnProperty(id)&&this.addPreferredColor(id,allColors[id])},addPreferredColor:function(id,color){this._preferredColors[id]=color},getPreferedColor:function(id){return this._preferredColors.hasOwnProperty(id)?this._preferredColors[id]:null},_hasAffectedNodes:function(id){return this._affectedNodes.hasOwnProperty(id)},addCase:function(id,name,valueAll,nodeID){if(0==Object.keys(this._affectedNodes).length&&(this._legendBox.show(),!editor.getPreferencesManager().getConfigurationOption("hideDraggingHint")&&this._legendInfo&&this._legendInfo.show()),this._hasAffectedNodes(id))this._affectedNodes[id].push(nodeID);else{this._affectedNodes[id]=[nodeID];var listElement=this._generateElement(id,name,valueAll);this._list.insert(listElement)}this._updateCaseNumbersForObject(id)},removeCase:function(id,nodeID){this._hasAffectedNodes(id)&&(this._affectedNodes[id]=this._affectedNodes[id].without(nodeID),0==this._affectedNodes[id].length?(delete this._affectedNodes[id],delete this._objectColors[id],this._getListElementForObjectWithID(id).remove(),0==Object.keys(this._affectedNodes).length&&(this._legendBox.hide(),0==this._legendBox.up().select(".abnormality").size()&&this._legendInfo&&this._legendInfo.hide())):this._updateCaseNumbersForObject(id))},replaceIDs:function(changedIdsSet){for(var abnormality in this._affectedNodes)if(this._affectedNodes.hasOwnProperty(abnormality))for(var affectedList=this._affectedNodes[abnormality],i=0;i<affectedList.length;i++){var oldID=affectedList[i],newID=changedIdsSet.hasOwnProperty(oldID)?changedIdsSet[oldID]:oldID;affectedList[i]=newID}},_getListElementForObjectWithID:function(id){var HTMLid=Helpers.isInt(id)?id:this._hashID(id);return $(this._getPrefix()+"-"+HTMLid)},_updateCaseNumbersForObject:function(id){var HTMLid=Helpers.isInt(id)?id:this._hashID(id),label=this._legendBox.down("li#"+this._getPrefix()+"-"+HTMLid+" .abnormality-cases");if(label){var cases=this._affectedNodes.hasOwnProperty(id)?this._affectedNodes[id].length:0;label.update(cases+"&nbsp;case"+(cases-1?"s":""))}},_generateElement:function(id,name,valueAll){var color=this.getObjectColor(id),HTMLid=Helpers.isInt(id)?id:this._hashID(id),item=new Element("li",{class:"abnormality drop-"+this._getPrefix(),id:this._getPrefix()+"-"+HTMLid}).update(new Element("span",{class:"disorder-name"}).update(name.escapeHTML()));item.store("valueAll",valueAll),item.insert(new Element("input",{type:"hidden",value:id}));var bubble=new Element("span",{class:"abnormality-color"});bubble.style.backgroundColor=color,item.insert({top:bubble});var countLabel=new Element("span",{class:"abnormality-cases"}),countLabelContainer=new Element("span",{class:"abnormality-cases-container"}).insert("(").insert(countLabel).insert(")");item.insert(" ").insert(countLabelContainer);var me=this;return Element.observe(item,"mouseover",function(){item.down(".disorder-name").setStyle({background:color,cursor:"default"}),me._highlightAllByItemID(id,!0)}),Element.observe(item,"mouseout",function(){item.down(".disorder-name").setStyle({background:"",cursor:"default"}),me._highlightAllByItemID(id,!1)}),new Draggable(item,{revert:!0,reverteffect:function(segment){segment.setStyle({height:"",left:"",position:"",top:"",zIndex:"",width:""})},ghosting:!0}),item},_highlightAllByItemID:function(id,highlight){null==editor.getView().getCurrentDraggable()&&this._affectedNodes[id]&&this._affectedNodes[id].forEach(function(nodeID){var node=editor.getNode(nodeID);node&&(highlight?node.getGraphics().highlight():node.getGraphics().unHighlight())})},_onDropWrapper:function(label,target,event){if(!editor.isReadOnlyMode()){editor.getView().setCurrentDraggable(null);var valueAll=label.retrieve("valueAll"),id=label.select("input")[0].value;this._highlightAllByItemID(id,!1),this._unhighlightAfterDrag();var divPos=editor.getWorkspace().viewportToDiv(event.pointerX(),event.pointerY()),pos=editor.getWorkspace().divToCanvas(divPos.x,divPos.y),node=editor.getView().getPersonNodeNear(pos.x,pos.y);if(node){if(node.isProband()||node.isRegistered())return;this._onDropObject(node,id,valueAll)}}},_onFailedDrag:function(node,message,title){editor.getOkCancelDialogue().showCustomized(message,title,"OK",function(){node.getGraphics().getHoverBox().animateHideHoverZone()})},_onHoverWrapper:function(label,target,overlap,event){if(!editor.isReadOnlyMode()){editor.getView().setCurrentDraggable(-1);var divPos=editor.getWorkspace().viewportToDiv(event.pointerX(),event.pointerY()),pos=editor.getWorkspace().divToCanvas(divPos.x,divPos.y),node=editor.getView().getPersonNodeNear(pos.x,pos.y);if(node){if(node.isProband()||node.isRegistered())return;node.getGraphics().getHoverBox().animateHideHoverZone(),node.getGraphics().getHoverBox().setHighlighted(!0),this._previousHighightedNode=node}else this._unhighlightAfterDrag()}},_unhighlightAfterDrag:function(){this._previousHighightedNode&&(this._previousHighightedNode.getGraphics().getHoverBox().setHighlighted(!1),this._previousHighightedNode=null)},_onDropObject:function(node,objectID){throw"drop functionality is not defined"},_hashID:function(s){if(s.toLowerCase(),Array.prototype.reduce)return"c"+s.split("").reduce(function(a,b){return(a=(a<<5)-a+b.charCodeAt(0))&a},0);for(var n=0,i=0;i<s.length;i++)n+=s.charCodeAt(i);return"c"+n}}),Disorder=Class.create({initialize:function(disorderId,name,ageOfOnset,diagnosisCertainty,codeSystemUri,versionNumber,disorderType,valueAll,callWhenReady){null!=name||Helpers.isInt(disorderId)||(name=disorderId),null!=valueAll&&null!=valueAll||(valueAll={}),this.valueAll=valueAll,this.codeSystemUri=codeSystemUri,this.versionNumber=versionNumber,this.disorderId=disorderId,this.ageOfOnset=ageOfOnset,this.name=name||"loading...",this.valueAll&&null==this.valueAll.ageOfOnset&&(this.valueAll.ageOfOnset=ageOfOnset),this.valueAll&&null==this.valueAll.diagnosisCertainty&&(this.valueAll.diagnosisCertainty=diagnosisCertainty),this.diagnosisCertainty=diagnosisCertainty,this.valueAll&&null==this.valueAll.codeSystemUri&&(this.valueAll.codeSystemUri=codeSystemUri),this.valueAll&&null==this.valueAll.versionNumber&&(this.valueAll.versionNumber=versionNumber),this.valueAll&&null==this.valueAll.disorderType&&(this.valueAll.disorderType=disorderType),this.disorderType=disorderType,!name&&callWhenReady&&this.load(callWhenReady)},getDisorderId:function(){return this.disorderId},getName:function(){return this.name},getValueAll:function(){return this.valueAll},load:function(callWhenReady){var queryURL=Disorder.getServiceURL("OMIM")+"&id="+this.disorderId;console.log("loading...."),new Ajax.Request(queryURL,{method:"GET",onSuccess:this.onDataReady.bind(this),onComplete:callWhenReady||{}})},onDataReady:function(response){console.log("33",response);try{var parsed=JSON.parse(response.responseText);this.convertToDisorderFormat(parsed),console.log("LOADED DISORDER: disorder id = "+this.disorderId+", name = "+parsed.rows[0].name),this.name=parsed.rows[0].name,this.valueAll=parsed.rows[0]}catch(err){console.log("[LOAD DISORDER] Error: "+err)}},convertToDisorderFormat:function(response){console.log("ondr:",response)}});Disorder.getServiceURL=function(disorderType){var webservice=new WebService;return webservice.getOmimLookupPath()};var DisorderLegend=Class.create(Legend,{initialize:function($super){$super("Disorders",!0),this._disorderCache={}},_getPrefix:function(id){return"disorder"},getDisorder:function(disorderID){if(!this._disorderCache.hasOwnProperty(disorderID)){this._disorderCache[disorderID]=new Disorder(disorderID,null,null,null,null,null,null,function(){this._updateDisorderName(disorderID)}.bind(this))}return this._disorderCache[disorderID]},getAllNames:function(){var result={};for(var disorderID in this._affectedNodes)this._affectedNodes.hasOwnProperty(disorderID)&&(result[disorderID]=this.getDisorder(disorderID).getName());return result},addCase:function($super,disorderID,disorderName,valueAll,nodeID){var valueAll_WithoutAgeOfOnset=Object.clone(valueAll);valueAll_WithoutAgeOfOnset.ageOfOnset="",this._disorderCache.hasOwnProperty(disorderID)||(this._disorderCache[disorderID]=new Disorder(disorderID,disorderName,"","","","",valueAll_WithoutAgeOfOnset.disorderType,valueAll_WithoutAgeOfOnset)),$super(disorderID,disorderName,valueAll_WithoutAgeOfOnset,nodeID)},_updateDisorderName:function(disorderID){this._legendBox.down("li#"+this._getPrefix()+"-"+disorderID+" .disorder-name").update(this.getDisorder(disorderID).getName())},_generateElement:function($super,disorderID,name,valueAll){if(!this._objectColors.hasOwnProperty(disorderID)){var color=this._generateColor(disorderID,valueAll);this._objectColors[disorderID]=color,document.fire("disorder:color",{id:disorderID,color:color})}var item=$super(disorderID,name,valueAll),disorderType="";if(disorderType=null!=valueAll?valueAll.disorderType:"OMIM","affected"!=name){var disorderTypeContainer=new Element("span",{class:"disorder-disorder-type"}).insert("(").insert(disorderType).insert(")");item.down(".disorder-name").insert(" ").insert(disorderTypeContainer)}return item},_onDropObject:function(node,disorderID){var currentDisorders=node.getDisorders().slice(0);if(-1==currentDisorders.indexOf(disorderID)){currentDisorders.push(disorderID),editor.getView().unmarkAll();var properties={setDisorders:currentDisorders},event={nodeID:node.getID(),properties:properties};document.fire("pedigree:node:setproperty",event)}else this._onFailedDrag(node,"This person already has the selected disorder","Can't drag this disorder to this person")},_generateColor:function(disorderID){if(this._objectColors.hasOwnProperty(disorderID))return this._objectColors[disorderID];var usedColors=Object.values(this._objectColors),prefColors=["#D1E9E9","#92c0db","#4575B4","#949ab8","#FEE090","#bf6632","#fca860","#9a4500","#d12943","#00a2bf"];if("affected"==disorderID&&(prefColors=["#FEE090","#dbad71"]),null!==this.getPreferedColor(disorderID)&&prefColors.unshift(this.getPreferedColor(disorderID)),usedColors.each(function(color){prefColors=prefColors.without(color)}),0<prefColors.length)return prefColors[0];for(var randomColor=Raphael.getColor();"#ffffff"==randomColor||-1!=usedColors.indexOf(randomColor);)randomColor="#"+((1<<24)*Math.random()|0).toString(16);return randomColor}}),HPOTerm=Class.create({initialize:function(hpoId,name,hpoPresent,hpoModifiers,valueAll,callWhenReady){null!=name||HPOTerm.isValidID(hpoId)||(name=hpoId),null!=valueAll&&null!=valueAll||(valueAll={}),this.valueAll=valueAll,this.hpoId=hpoId,this.name=name||"loading...",this.hpoModifiers=hpoModifiers,this.valueAll.hpoModifiers=hpoModifiers,this.valueAll&&null==this.valueAll.hpoPresent&&(this.valueAll.hpoPresent=hpoPresent),this.hpoPresent=hpoPresent,!name&&callWhenReady&&this.load(callWhenReady)},getID:function(){return this.hpoId},getValueAll:function(){return this.valueAll},getName:function(){return this.name},load:function(callWhenReady){var queryURL=(new WebService).getHPOLookupPath()+"id="+this.hpoId;new Ajax.Request(queryURL,{method:"GET",onSuccess:this.onDataReady.bind(this),onComplete:callWhenReady||{}})},onDataReady:function(response){try{var parsed=JSON.parse(response.responseText);console.log("LOADED HPO TERM: id = "+this.hpoId+", name = "+parsed.rows[0].name),this.name=parsed.rows[0].name,this.valueAll=parsed.rows[0]}catch(err){console.log("[LOAD HPO TERM] Error: "+err)}}});HPOTerm.isValidID=function(id){return/^HP\:(\d)+$/i.test(id)};var HPOLegend=Class.create(Legend,{initialize:function($super){$super("Phenotypes",!0),this._termCache={}},_getPrefix:function(id){return"phenotype"},getTerm:function(hpoID){if(!this._termCache.hasOwnProperty(hpoID)){this._termCache[hpoID]=new HPOTerm(hpoID,null,null,null,null,function(){this._updateTermName(hpoID)}.bind(this))}return this._termCache[hpoID]},getObjectColor:function(id){return"#CCCCCC"},addCase:function($super,id,name,valueAll,nodeID){this._termCache[id]=new HPOTerm(id,name,valueAll.hpoPresent,valueAll.hpoModifiers,valueAll),$super(id,name,valueAll,nodeID)},_updateTermName:function(id){this._legendBox.down("li#"+this._getPrefix()+"-"+this._hashID(id)+" .disorder-name").update(this.getTerm(id).getName())},_onDropObject:function(node,hpoID){if(!node.isPersonGroup()){var currentHPO=node.getHPO().slice(0);if(-1==currentHPO.indexOf(hpoID)){currentHPO.push(hpoID),editor.getView().unmarkAll();var properties={setHPO:currentHPO},event={nodeID:node.getID(),properties:properties};document.fire("pedigree:node:setproperty",event)}else this._onFailedDrag(node,"This person already has the selected phenotype","Can't drag this phenotype to this person")}},_generateElement:function($super,disorderID,name,valueAll){return $super(disorderID,name,valueAll)}}),GeneLegend=Class.create(Legend,{initialize:function($super){$super("Candidate Genes",!0)},_getPrefix:function(id){return"gene"},_generateElement:function($super,geneID,name){if(!this._objectColors.hasOwnProperty(geneID)){var color=this._generateColor(geneID);this._objectColors[geneID]=color,document.fire("gene:color",{id:geneID,color:color})}return $super(geneID,name)},_onDropObject:function(node,geneID){if(!node.isPersonGroup()){var currentGenes=node.getGenes().slice(0);if(-1==currentGenes.indexOf(geneID)){currentGenes.push(geneID),editor.getView().unmarkAll();var properties={setGenes:currentGenes},event={nodeID:node.getID(),properties:properties};document.fire("pedigree:node:setproperty",event)}else this._onFailedDrag(node,"This person already has the selected candidate gene","Can't drag this gene to this person")}},_generateColor:function(geneID){if(this._objectColors.hasOwnProperty(geneID))return this._objectColors[geneID];var usedColors=Object.values(this._objectColors),prefColors=["#81a270","#c4e8c4","#56a270","#b3b16f","#4a775a","#65caa3"];if(null!==this.getPreferedColor(geneID)&&prefColors.unshift(this.getPreferedColor(geneID)),usedColors.each(function(color){prefColors=prefColors.without(color)}),0<prefColors.length)return prefColors[0];for(var randomColor=Raphael.getColor();"#ffffff"==randomColor||-1!=usedColors.indexOf(randomColor);)randomColor="#"+((1<<24)*Math.random()|0).toString(16);return randomColor}}),unRenderedLegendSuper=Class.create(Legend,{addNode:function(node){var id=Object.keys(this._affectedNodes).length;if(0==Object.keys(this._affectedNodes).length&&(this._legendBox.show(),!editor.getPreferencesManager().getConfigurationOption("hideDraggingHint")&&this._legendInfo&&this._legendInfo.show()),!this._hasAffectedNodes(id)){this._affectedNodes[id]=[id];var listElement=this._generateNode(id,node);this._list.insert(listElement)}this._updateCaseNumbersForObject(id)},addAllNodes:function(nodes){for(var i=0;nodes&&i<nodes.length;i++)this.addNode(nodes[i])},removeAllNodes:function(){for(var currentNodesLength=Object.keys(this._affectedNodes).length,i=0;i<currentNodesLength;i++){$(this._getPrefix()+i).remove()}this._legendBox.hide(),0==this._legendBox.up().select(".abnormality").size()&&this._legendInfo&&this._legendInfo.hide(),this._affectedNodes={},this._objectColors={}},_generateNode:function(id,node){var color=this.getObjectColor(id),HTMLContent=(""!=node.ngisRegisteredPatientUid?"NGIS ID: "+node.ngisRegisteredPatientUid:"NON NGIS ID: "+node.nonNgisPatientStableUid)+"<br>",item=new Element("li",{class:"UnRendered-legend-box-item abnormality drop-"+this._getPrefix(),id:this._getPrefix()+id}).update(HTMLContent);node.unRenderedIndex=id,item.store("valueAll",node),item.insert(new Element("span",{class:"unRenderedItemName"}).update("NHS#: ")),item.insert(new Element("span",{class:"unRenderedItemValue"}).update(node.NHSNumber)),item.insert(new Element("span",{}).update("<br>")),node.chiNumber&&0<node.chiNumber.length&&(item.insert(new Element("span",{class:"unRenderedItemName"}).update("CHI#: ")),item.insert(new Element("span",{class:"unRenderedItemValue"}).update(node.chiNumber)),item.insert(new Element("span",{}).update("<br>"))),item.insert(new Element("span",{class:"unRenderedItemName"}).update("Forenames: ")),item.insert(new Element("span",{class:"unRenderedItemValue"}).update(node.firstName)),item.insert(new Element("span",{}).update("<br>")),item.insert(new Element("span",{class:"unRenderedItemName"}).update("Surname: ")),item.insert(new Element("span",{class:"unRenderedItemValue"}).update(node.lastName)),item.insert(new Element("span",{}).update("<br>")),item.insert(new Element("span",{class:"unRenderedItemName"}).update("Gender: "));var genderDisplayText=Helpers.getGenderDisplayText(node.sex);item.insert(new Element("span",{class:"unRenderedItemValue"}).update(genderDisplayText)),item.insert(new Element("span",{}).update("<br>")),item.insert(new Element("span",{class:"unRenderedItemName"}).update("BirthDate: "));var dob="";if(node.birthDate)dob=node.birthDate.day+"/"+node.birthDate.month+"/"+node.birthDate.year;if(item.insert(new Element("span",{class:"unRenderedItemValue"}).update(dob)),item.insert(new Element("span",{}).update("<br>")),item.insert(new Element("span",{class:"unRenderedItemName"}).update("Relation: ")),item.insert(new Element("span",{class:"unRenderedItemValue"}).update(node.relationshipToProband)),item.insert(new Element("span",{}).update("<br>")),item.insert(new Element("span",{class:"unRenderedItemName"}).update("NGISPatientID: ")),item.insert(new Element("span",{class:"unRenderedItemValue"}).update(node.ngisRegisteredPatientUid)),item.insert(new Element("span",{}).update("<br>")),item.insert(new Element("span",{class:"unRenderedItemName unRenderedHidden"}).update("KaryotypicSex: ")),item.insert(new Element("span",{class:"unRenderedItemValue unRenderedHidden"}).update(node.karyotypicSex)),item.insert(new Element("span",{class:"unRenderedHidden"}).update("<br>")),node.disordersFullDetails){item.insert(new Element("span",{class:"unRenderedItemName unRenderedHidden"}).update("Disorders:")),item.insert(new Element("span",{class:"unRenderedHidden"}).update("<br>"));for(var i=0;i<node.disordersFullDetails.length;i++)item.insert(new Element("span",{class:"unRenderedHidden unRendered-disorder-item"}).update("&bull;&nbsp;"+node.disordersFullDetails[i].name)),item.insert(new Element("span",{class:"unRenderedHidden"}).update("<br>"))}if(node.hpoTermsFullDetails){item.insert(new Element("span",{class:"unRenderedItemName unRenderedHidden"}).update("HPO:")),item.insert(new Element("span",{class:"unRenderedHidden"}).update("<br>"));for(i=0;i<node.hpoTermsFullDetails.length;i++)item.insert(new Element("span",{class:"unRenderedHidden unRendered-disorder-item"}).update("&bull;&nbsp;"+node.hpoTermsFullDetails[i].hpoID+"&nbsp;"+node.hpoTermsFullDetails[i].name)),item.insert(new Element("span",{class:"unRenderedHidden"}).update("<br>"))}var moreValuesDots=new Element("span",{class:"moreValueDots"}).update("...&nbsp;"),plusElement=new Element("span",{style:"cursor:pointer;font-size: 90%;"}).insert(moreValuesDots).insert('<i class="fa fa-plus-square-o" aria-hidden="true"></i>');item.insert(plusElement),item.select("span.unRenderedHidden").each(Element.hide),plusElement.observe("click",function(event){var plusIcon=this.select("i")[0];plusIcon.hasClassName("fa-plus-square-o")?(plusIcon.removeClassName("fa-plus-square-o"),plusIcon.addClassName("fa-minus-square-o"),item.select("span.unRenderedHidden").each(Element.show),moreValuesDots.hide()):(plusIcon.addClassName("fa-plus-square-o"),plusIcon.removeClassName("fa-minus-square-o"),item.select("span.unRenderedHidden").each(Element.hide),moreValuesDots.show())}),item.insert(new Element("input",{type:"hidden",value:id}));var bubble=new Element("span",{class:"UnRendered-abnormality-color"});bubble.style.backgroundColor=color,item.insert({top:bubble});var countLabelContainer=new Element("span",{class:"abnormality-cases-container"});return item.insert(" ").insert(countLabelContainer),new Draggable(item,{revert:!0,reverteffect:function(segment){segment.setStyle({height:"",left:"",position:"",top:"",zIndex:"",width:""})},ghosting:!0}),item}}),unRenderedLegend=Class.create(unRenderedLegendSuper,{initialize:function($super){$super("Unassigned participants",!0,!0),this._unrenderedLegendInfo=new Element("div",{class:"legend-box legend-info",id:"extra-legend-info"}).insert(new Element("div",{class:"infomessage"}).insert("Please drag & drop all 'unassigned' participants from the list below into the correct position in the pedigree.")),this.unrenderedCloseButton=new Element("span",{class:"close-button"}).update("x"),this.unrenderedCloseButton.observe("click",this.hideUnRenderedHint.bindAsEventListener(this)),this._unrenderedLegendInfo.insert({top:this.unrenderedCloseButton}),this._list.insert(this._unrenderedLegendInfo),this._termCache={}},hideUnRenderedHint:function(){editor.getPreferencesManager().setConfigurationOption("user","hideDraggingHint",!0),this._unrenderedLegendInfo.hide()},_getPrefix:function(id){return"UnRendered"},getObjectColor:function(id){return"#CCCCCC"},addCase:function($super,id,name,nodeID){this._termCache.hasOwnProperty(id)||(this._termCache[id]=new HPOTerm(id,name)),$super(id,name,nodeID)},addNode:function($super,id,name,nodeID,node){this._termCache.hasOwnProperty(id)||(this._termCache[id]={id:id,name:name}),$super(id,name,nodeID,node)},_updateTermName:function(id){this._legendBox.down("li#"+this._getPrefix()+"-"+this._hashID(id)+" .disorder-name").update(this.getTerm(id).getName())},_onDropObject:function(node,hpoID,valueAll){var self=this;if(!node.isPersonGroup()){var participantId=node.getParticipantId();if(participantId&&0<participantId.trim().length){var closeFunction=function(){this.dialog.show()};editor.getOkCancelDialogue().showCustomized("You can not assign to a node that has Participant Id.","Genomics England","Close",closeFunction,null,null,null,null,!0)}else{var nodeArray=editor.getGraph()._getAllNodes(),alreadyInGraph=!1;for(i=0;i<nodeArray.length;i++){var nodeValue=nodeArray[i],currentNode=editor.getNode(nodeValue);if(currentNode._ngisRegisteredPatientUid&&valueAll.ngisRegisteredPatientUid&&currentNode._ngisRegisteredPatientUid==valueAll.ngisRegisteredPatientUid){alreadyInGraph=!0;break}}if(alreadyInGraph){closeFunction=function(){this.dialog.show()};editor.getOkCancelDialogue().showCustomized("This node has been already assigned to another node","Genomics England","Close",closeFunction,null,null,null,null,!0)}else{editor.getOkCancelDialogue().showCustomized("Are you sure you want to assign the values to this node?","Genomics England","Yes",function(){Person.copyUnassignedNode(node,valueAll);var HTMLId=self._getPrefix()+valueAll.unRenderedIndex,unRenderedNode=editor._unRenderedLegend._legendBox.select("#"+HTMLId);0<unRenderedNode.length&&(unRenderedNode=unRenderedNode[0]),unRenderedNode&&(unRenderedNode.removeClassName("UnRendered-legend-box-item"),unRenderedNode.addClassName("UnRendered-legend-box-item-selected"))},"No",closeFunction,null,!0)}}}}}),SaveLoadIndicator=Class.create({initialize:function(){var me=this,mainDiv=new Element("div",{class:"load-status-container"});this._isHidden=!0,this.dialog=new PhenoTips.widgets.ModalPopup(mainDiv,!1,{extraClassName:"loading-indicator",displayCloseButton:!1}),document.observe("pedigree:load:start",function(event){me._isHidden&&me.show()}),document.observe("pedigree:load:finish",function(event){me._isHidden||me.hide()})},show:function(){this.dialog.show(),this._isHidden=!1},hide:function(){this.dialog.close(),this._isHidden=!0}}),TemplateSelector=Class.create({initialize:function(isStartupTemplateSelector){this._isStartupTemplateSelector=isStartupTemplateSelector,this.mainDiv=new Element("div",{class:"template-picture-container"}),this.mainDiv.update("Loading list of templates...");var closeShortcut=isStartupTemplateSelector?[]:["Esc"];this.dialog=new PhenoTips.widgets.ModalPopup(this.mainDiv,{close:{method:this.hide.bind(this),keys:closeShortcut}},{extraClassName:"pedigree-template-chooser",title:"Please select a pedigree template",displayCloseButton:!isStartupTemplateSelector,verticalPosition:"top"}),isStartupTemplateSelector&&this.show();var newURL=(new WebService).getPathToEditorFiles()+new XWiki.Document("WebHome").getRestURL("objects/PhenoTips.PedigreeClass/index.xml").substring(1);new Ajax.Request(newURL,{method:"GET",onSuccess:this._onTemplateListAvailable.bind(this)})},isStartupTemplateSelector:function(){return this._isStartupTemplateSelector},_onTemplateListAvailable:function(response){this.mainDiv.update();for(var objects=response.responseXML.documentElement.getElementsByTagName("objectSummary"),i=0;i<objects.length;++i){var pictureBox=new Element("div",{class:"picture-box"});pictureBox.update("Loading..."),this.mainDiv.insert(pictureBox);var href=getSelectorFromXML(objects[i],"link","rel","http://www.xwiki.org/rel/properties").getAttribute("href"),newURL="rest"+href.substring(href.indexOf("/",href.indexOf("//")+2)),templatePath=(new WebService).getPathToEditorFiles()+newURL;new Ajax.Request(templatePath,{method:"GET",onSuccess:this._onTemplateAvailable.bind(this,pictureBox)})}},_onTemplateAvailable:function(pictureBox,response){pictureBox.innerHTML=getSubSelectorTextFromXML(response.responseXML,"property","name","image","value").replace(/&amp;/,"&"),pictureBox.pedigreeData=getSubSelectorTextFromXML(response.responseXML,"property","name","data","value"),pictureBox.type="internal",pictureBox.description=getSubSelectorTextFromXML(response.responseXML,"property","name","description","value"),pictureBox.title=pictureBox.description,window.SVGSVGElement&&document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#Image","1.1")?pictureBox.update(getSubSelectorTextFromXML(response.responseXML,"property","name","image","value")):pictureBox.innerHTML="<table bgcolor='#FFFAFA'><tr><td><br>&nbsp;"+pictureBox.description+"&nbsp;<br><br></td></tr></table>",pictureBox.observe("click",this._onTemplateSelected.bindAsEventListener(this,pictureBox))},_onTemplateSelected:function(event,pictureBox){this.dialog.close(),"internal"==pictureBox.type?editor.getSaveLoadEngine().createGraphFromSerializedData(pictureBox.pedigreeData,!1,!0):"simpleJSON"==pictureBox.type&&editor.getSaveLoadEngine().createGraphFromImportData(pictureBox.pedigreeData,"simpleJSON",{},!1,!0)},show:function(){var availableHeight=document.viewport.getHeight()-80;this.mainDiv.setStyle({"max-height":availableHeight+"px","overflow-y":"auto"}),this.dialog.show()},hide:function(){this.dialog.closeDialog()}});function unescapeRestData(data){var tempNode=document.createElement("div");return tempNode.innerHTML=data.replace(/&amp;/,"&"),tempNode.innerText||tempNode.text||tempNode.textContent}function getSelectorFromXML(responseXML,selectorName,attributeName,attributeValue){if(responseXML.querySelector)return responseXML.querySelector(selectorName+"["+attributeName+"='"+attributeValue+"']");var query=".//"+selectorName+"[@"+attributeName+"='"+attributeValue+"']";try{return responseXML.selectSingleNode(query)}catch(e){throw alert("your browser is unsupported"),window.stop&&window.stop(),"Unsupported browser"}}function getSubSelectorTextFromXML(responseXML,selectorName,attributeName,attributeValue,subselectorName){var selector=getSelectorFromXML(responseXML,selectorName,attributeName,attributeValue),value=selector.innerText||selector.text||selector.textContent;return value||(value=""),value}var OkCancelDialogue=Class.create({initialize:function(){var _this=this;this._onButtonActions=[void 0,void 0,void 0],this._buttons=[void 0,void 0,void 0];var mainDiv=new Element("div",{class:"ok-cancel-dialogue"});this._promptBody=new Element("div",{class:"ok-cancel-body"}),mainDiv.insert(this._promptBody),this._buttons[0]=new Element("input",{type:"button",name:"ok",value:"OK",class:"button min-width80px",id:"OK_button"}),this._buttons[1]=new Element("input",{type:"button",name:"cancel",value:"Cancel",class:"button secondary min-width80px"}),this._buttons[2]=new Element("input",{type:"button",name:"other",value:"Other",class:"button secondary min-width80px"});for(var buttons=new Element("div",{class:"buttons import-block-bottom"}),i=0;i<this._buttons.length;i++)buttons.insert(this._buttons[i].wrap("span",{class:"buttonwrapper"})),this._buttons[i].index=i,this._buttons[i].observe("click",function(event){_this.hide(),_this._onButtonActions[this.index]&&_this._onButtonActions[this.index]()});mainDiv.insert(buttons);this.dialog=new PhenoTips.widgets.ModalPopup(mainDiv,{close:{method:this.hide.bind(this),keys:["Esc"]}},{extraClassName:"pedigree-okcancel",title:"?",displayCloseButton:!1})},show:function(message,title,onOKFunction,onCancelFunction){this.showCustomized(message,title,"OK",onOKFunction,"Cancel",onCancelFunction)},showCustomized:function(message,title,button1title,on1Function,button2title,on2Function,button3title,on3Function,bottomRight){this._configButton(0,button1title,on1Function),this._configButton(1,button2title,on2Function),this._configButton(2,button3title,on3Function,bottomRight),this._promptBody.update(message),this.dialog.show(),this.dialog.dialogBox.down("div.msdialog-title").update(title)},hide:function(){this.dialog.closeDialog()},_configButton:function(buttonID,buttonTitle,actionFunction,bottomRightButton){buttonTitle&&""!=buttonTitle?(this._buttons[buttonID].show(),this._buttons[buttonID].writeAttribute("value",buttonTitle),this._onButtonActions[buttonID]=actionFunction):this._buttons[buttonID].hide(),bottomRightButton?this._buttons[buttonID].setStyle({marginLeft:"-200px",marginRight:"10px",float:"right"}):this._buttons[buttonID].setStyle({marginLeft:"0px",marginRight:"0px",float:"none"})}}),ImportSelector=Class.create({initialize:function(){if(!editor.isReadOnlyMode()){var _this=this,mainDiv=new Element("div",{class:"import-selector"}),promptImport=new Element("div",{class:"import-section"}).update("Import data:");if(this.importValue=new Element("textarea",{id:"import",value:"",class:"import-textarea"}),mainDiv.insert(promptImport).insert(this.importValue),window.FileReader&&window.FileList){var uploadFileSelector=new Element("input",{type:"file",id:"pedigreeInputFile",style:"display:none"});uploadFileSelector.observe("change",function(event){_this.handleFileUpload(this.files);try{this.value=""}catch(err){}});var uploadButton=new Element("input",{type:"button",value:"Select a local file to be imported",class:"button"}).wrap("span",{class:"buttonwrapper"});uploadButton.observe("click",function(event){document.getElementById("pedigreeInputFile").click()}),mainDiv.insert(uploadFileSelector).insert(uploadButton)}var typeListElement=new Element("table");typeListElement.insert(function(checked,labelText,value){var optionWrapper=new Element("tr"),input=new Element("input",{type:"radio",value:value,name:"select-type"});input.observe("click",_this.disableEnableOptions),checked&&(input.checked=!0);var label=new Element("label",{class:"import-type-label"}).insert(input).insert(labelText);return optionWrapper.insert(label.wrap("td")),optionWrapper}(!0,"Simple JSON","simpleJSON"));var promptType=new Element("div",{class:"import-section"}).update("Data format:"),dataSection2=new Element("div",{class:"import-block"});dataSection2.insert(promptType).insert(typeListElement),mainDiv.insert(dataSection2);var _addConfigOption=function(checked,labelText,value){var optionWrapper=new Element("tr"),input=new Element("input",{type:"radio",value:value,name:"select-options"});checked&&(input.checked=!0);var label=new Element("label",{class:"import-config-label"}).insert(input).insert(labelText);return optionWrapper.insert(label.wrap("td")),optionWrapper},configListElement=new Element("table",{id:"import-type"});configListElement.insert(_addConfigOption(!0,"Treat non-standard phenotype values as new disorders","accept")),configListElement.insert(_addConfigOption(!1,'Treat non-standard phenotype values as "no information"',"dontaccept"));var markEvaluated=new Element("input",{type:"checkbox",value:"1",name:"mark-evaluated"}),markLabel1=new Element("label",{class:"import-mark-label1"}).insert(markEvaluated).insert("Mark all patients with known disorder status with 'documented evaluation' mark").wrap("td").wrap("tr");configListElement.insert(markLabel1);var markExternal=new Element("input",{type:"checkbox",value:"1",name:"mark-external"});markExternal.checked=!0;var markLabel2=new Element("label",{class:"import-mark-label2"}).insert(markExternal).insert("Save individual IDs as given in the input data as 'external ID'").wrap("td").wrap("tr");configListElement.insert(markLabel2);var dataSection3=new Element("div",{class:"import-block"});mainDiv.insert(dataSection3);var buttons=new Element("div",{class:"buttons import-block-bottom"});buttons.insert(new Element("input",{type:"button",name:"import",value:"Import",class:"button",id:"import_button"}).wrap("span",{class:"buttonwrapper"})),buttons.insert(new Element("input",{type:"button",name:"cancel",value:"Cancel",class:"button secondary"}).wrap("span",{class:"buttonwrapper"})),mainDiv.insert(buttons),buttons.down('input[name="cancel"]').observe("click",function(event){_this.hide()}),buttons.down('input[name="import"]').observe("click",function(event){_this._onImportStarted()});this.dialog=new PhenoTips.widgets.ModalPopup(mainDiv,{close:{method:this.hide.bind(this),keys:["Esc"]}},{extraClassName:"pedigree-import-chooser",title:"Pedigree import",displayCloseButton:!0})}},handleFileUpload:function(files){for(var i=0,numFiles=files.length;i<numFiles;i++){var nextFile=files[i];console.log("loading file: "+nextFile.name+", size: "+nextFile.size);var _this=this,fr=new FileReader;fr.onload=function(e){_this.importValue.value=e.target.result},fr.readAsText(nextFile)}},disableEnableOptions:function(){for(var importType=$$('input:checked[type=radio][name="select-type"]')[0].value,pedOnlyOptions=$$('input[type=radio][name="select-options"]'),i=0;i<pedOnlyOptions.length;i++)pedOnlyOptions[i].disabled="ped"!=importType;var pedAndGedcomOption=$$('input[type=checkbox][name="mark-evaluated"]')[0];pedAndGedcomOption.disabled="ped"!=importType&&"gedcom"!=importType;var saveExternalID=$$('input[type=checkbox][name="mark-external"]')[0];saveExternalID.disabled="simpleJSON"==importType},_onImportStarted:function(){var importValue=this.importValue.value;if(console.log("Importing:\n"+importValue),this.hide(),importValue&&""!=importValue){var importType=$$('input:checked[type=radio][name="select-type"]')[0].value;console.log("Import type: "+importType);var importOptions={markEvaluated:[],externalIdMark:[],acceptUnknownPhenotypes:[]};editor.getSaveLoadEngine().createGraphFromImportData(importValue,importType,importOptions,!1,!0)}else alert("Nothing to import!")},show:function(){this.dialog.show()},hide:function(){this.importValue.value="",this.dialog.closeDialog()}}),ExportSelector=Class.create({initialize:function(){var _this=this,mainDiv=new Element("div",{class:"import-selector"}),typeListElement=new Element("table");typeListElement.insert(function(checked,labelText,value){var optionWrapper=new Element("tr"),input=new Element("input",{type:"radio",value:value,name:"export-type"});input.observe("click",_this.disableEnableOptions),checked&&(input.checked=!0);var label=new Element("label",{class:"import-type-label"}).insert(input).insert(labelText);return optionWrapper.insert(label.wrap("td")),optionWrapper}(!0,"Simple JSON","simpleJSON"));var fileDownload=new Element("a",{id:"downloadLink",style:"display:none"});mainDiv.insert(fileDownload);var promptType=new Element("div",{class:"import-section"}).update("Data format:"),dataSection2=new Element("div",{class:"import-block"});dataSection2.insert(promptType).insert(typeListElement),mainDiv.insert(dataSection2);var _addConfigOption=function(checked,name,cssClass,labelText,value){var optionWrapper=new Element("tr"),input=new Element("input",{type:"radio",value:value,name:name});checked&&(input.checked=!0);var label=new Element("label",{class:cssClass}).insert(input).insert(labelText);return optionWrapper.insert(label.wrap("td")),optionWrapper},configListElementJSON=new Element("table",{id:"jsonOptions",style:"display:none"});configListElementJSON.insert(_addConfigOption(!0,"export-options","import-config-label","All data","all")),configListElementJSON.insert(_addConfigOption(!1,"export-options","import-config-label","Remove personal information (name and age)","nopersonal")),configListElementJSON.insert(_addConfigOption(!1,"export-options","import-config-label","Remove personal information and free-form comments","minimal"));var configListElementPED=new Element("table",{id:"pedOptions"}),label=new Element("label",{class:"export-config-header"}).insert("How should person IDs be assigned in the generated file?");configListElementPED.insert(label.wrap("td").wrap("tr")),configListElementPED.insert(_addConfigOption(!0,"ped-options","export-subconfig-label","Using External IDs (when available)","external")),configListElementPED.insert(_addConfigOption(!1,"ped-options","export-subconfig-label","Generate new numeric IDs","newid")),configListElementPED.insert(_addConfigOption(!1,"ped-options","export-subconfig-label","Using Names (when available)","name"));var promptConfig=new Element("div",{class:"import-section"}).update("Options:"),dataSection3=new Element("div",{class:"import-block"});dataSection3.insert(promptConfig).insert(configListElementJSON).insert(configListElementPED),mainDiv.insert(dataSection3);var buttons=new Element("div",{class:"buttons import-block-bottom"});buttons.insert(new Element("input",{type:"button",name:"export",value:"Export",class:"button",id:"export_button"}).wrap("span",{class:"buttonwrapper"})),buttons.insert(new Element("input",{type:"button",name:"cancel",value:"Cancel",class:"button secondary"}).wrap("span",{class:"buttonwrapper"})),mainDiv.insert(buttons),buttons.down('input[name="cancel"]').observe("click",function(event){_this.hide()}),buttons.down('input[name="export"]').observe("click",function(event){_this._onExportStarted()});this.dialog=new PhenoTips.widgets.ModalPopup(mainDiv,{close:{method:this.hide.bind(this),keys:["Esc"]}},{extraClassName:"pedigree-import-chooser",title:"Pedigree export",displayCloseButton:!0})},disableEnableOptions:function(){var exportType=$$('input:checked[type=radio][name="export-type"]')[0].value,pedOptionsTable=$("pedOptions"),jsonOptionsTable=$("jsonOptions");if("ped"==exportType||"BOADICEA"==exportType){pedOptionsTable.show();var idgenerator=$$('input[type=radio][name="ped-options"]')[2];"BOADICEA"==exportType?(idgenerator.checked&&($$('input[type=radio][name="ped-options"]')[0].checked=!0),idgenerator.up().hide()):idgenerator.up().show(),jsonOptionsTable.hide()}else pedOptionsTable.hide(),jsonOptionsTable.show()},_onExportStarted:function(){this.hide();var patientDocument=(new WebService).getParticipantId();null!=patientDocument&&null!=patientDocument||(patientDocument="participant");var exportType=$$('input:checked[type=radio][name="export-type"]')[0].value;if("simpleJSON"==exportType)var privacySetting=$$('input:checked[type=radio][name="export-options"]')[0].value,exportString=PedigreeExport.exportAsSimpleJSON(editor.getGraph().DG,privacySetting),fileName=patientDocument+"_pedigree.json";else{var idGenerationSetting=$$('input:checked[type=radio][name="ped-options"]')[0].value;if("ped"==exportType)exportString=PedigreeExport.exportAsPED(editor.getGraph().DG,idGenerationSetting),fileName=patientDocument+".ped";else if("BOADICEA"==exportType)exportString=PedigreeExport.exportAsBOADICEA(editor.getGraph(),idGenerationSetting),fileName=patientDocument+".txt"}console.log("Export data: >>"+exportString+"<<"),""!=exportString&&FileSaver.saveTextAs(exportString,fileName)},show:function(){this.dialog.show()},hide:function(){this.dialog.closeDialog()}}),AbstractHoverbox=Class.create({initialize:function(node,shiftX,shiftY,width,height,nodeX,nodeY,nodeShapes){this._node=node,this._relativeX=shiftX,this._relativeY=shiftY,this._nodeX=nodeX,this._nodeY=nodeY,this._hidden=!0,this._enabled=!1,this._width=width,this._height=height,this._isHovered=!1,this._currentHandles=null,this._currentOrbs=null,this._currentButtons=null,this._handlesZoomSz=null,this._boxOnHover=editor.getPaper().rect(this.getX(),this.getY(),this._width,this._height,5).attr(PedigreeEditorParameters.attributes.boxOnHover),this._boxOnHover.node.setAttribute("class","pedigree-hoverbox"),this._backElements=editor.getPaper().set(this._boxOnHover),this._mask=this._boxOnHover.clone().attr({fill:"green",opacity:0}),this._frontElements=editor.getPaper().set().push(this._mask);var nodeShapeSet=nodeShapes.flatten();this._backElements.insertBefore(nodeShapeSet),this._frontElements.insertAfter(nodeShapeSet),this.animateDrawHoverZone=this.animateDrawHoverZone.bind(this),this.animateHideHoverZone=this.animateHideHoverZone.bind(this),this.getBoxOnHover().attr({opacity:0}),this.enable(),this._isMenuToggled=!1,this._justClosedMenu=!1},getX:function(){return this.getNodeX()+this._relativeX},getY:function(){return this.getNodeY()+this._relativeY},getNodeX:function(){var nodeGraphics=this.getNode().getGraphics();return nodeGraphics&&(this._nodeX=nodeGraphics.getX()),this._nodeX},getNodeY:function(){var nodeGraphics=this.getNode().getGraphics();return nodeGraphics&&(this._nodeY=nodeGraphics.getY()),this._nodeY},getWidth:function(){return this._width},getHeight:function(){return this._height},getNode:function(){return this._node},generateButtons:function(){null===this._currentButtons&&(this._currentButtons=[])},regenerateButtons:function(){this.removeButtons(),this.generateButtons()},removeButtons:function(){if(this._currentButtons){var enableState=this._enabled;enableState&&this.disable();for(var i=0;i<this._currentButtons.length;i++)this.getFrontElements().exclude(this._currentButtons[i]),this._currentButtons[i].remove();this._currentButtons=null,enableState&&this.enable()}},hideButtons:function(){if(this._currentButtons)for(var i=0;i<this._currentButtons.length;i++)this._currentButtons[i].hasOwnProperty("mask")&&this._currentButtons[i].mask.attr(PedigreeEditorParameters.attributes.btnMaskHoverOff),this._currentButtons[i].hide()},showButtons:function(){if(this._currentButtons)for(var i=0;i<this._currentButtons.length;i++)this._currentButtons[i].show()},getCurrentButtons:function(){return this._currentButtons},removeHandles:function(){if(this._currentHandles){var enableState=this._enabled;enableState&&this.disable();for(var i=0;i<this._currentOrbs.length;i++)this.getFrontElements().exclude(this._currentOrbs[i]);this._currentOrbs=null,enableState&&this.enable();for(i=0;i<this._currentHandles.length;i++)this._currentHandles[i].remove();this._currentHandles=null}},hideHandles:function(){if(this._currentHandles)for(var i=0;i<this._currentHandles.length;i++)this._currentHandles[i].hide()},showHandles:function(){if(this._currentHandles)for(var i=0;i<this._currentHandles.length;i++)this._currentHandles[i].show()},generateHandles:function(){null===this._currentHandles&&(this._currentHandles=[],this._currentOrbs=[],this._handlesZoomSz=editor.getWorkspace().getCurrentZoomLevel())},regenerateHandles:function(){this._currentHandles&&this.removeHandles(),this._hidden&&!this.isMenuToggled()||this.generateHandles()},createButton:function(x,y,svgPath,svgPathBBox,attributes,onClick,className,title){var icon=editor.getPaper().path(svgPath).attr(attributes);icon.transform(["t",x,y]);var xShift=svgPathBBox.width/4,yShift=svgPathBBox.height/4,newWidth=1.5*svgPathBBox.width,newHeight=1.5*svgPathBBox.height,mask=editor.getPaper().rect(x+svgPathBBox.x-xShift,y+svgPathBBox.y-yShift,newWidth,newHeight,1);mask.attr({fill:"gray",opacity:0,"stroke-width":0});var button=editor.getPaper().set(mask,icon).toFront(),me=this;button.click(function(){me._hidden?button.isClicked=!1:(button.isClicked=!button.isClicked,button.isClicked?mask.attr(PedigreeEditorParameters.attributes.btnMaskClick):mask.attr(PedigreeEditorParameters.attributes.btnMaskHoverOn),onClick&&onClick())}),button.mousedown(function(){mask.attr(PedigreeEditorParameters.attributes.btnMaskClick)}),button.hover(function(){mask.attr(PedigreeEditorParameters.attributes.btnMaskHoverOn),title&&mask.attr({title:title})},function(){mask.attr(PedigreeEditorParameters.attributes.btnMaskHoverOff)}),className&&button.forEach(function(element){element.node.setAttribute("class",className)}),button.icon=icon,button.mask=mask,this._hidden&&!this.isMenuToggled()&&button.hide(),this._currentButtons.push(button),this.disable(),this.getFrontElements().push(button),this.enable()},generateMenuBtn:function(){var me=this,attributes=PedigreeEditorParameters.attributes.menuBtnIcon,x=this.getX()+this.getWidth()-20-this.getWidth()/40,y=this.getY()+this.getHeight()/40;this.createButton(x,y,editor.getView().__menuButton_svgPath,editor.getView().__menuButton_BBox,attributes,function(){me.toggleMenu(!me.isMenuToggled())},"menu-trigger","node properties")},generateDeleteBtn:function(){var me=this,attributes=PedigreeEditorParameters.attributes.deleteBtnIcon,x=this.getX()+this.getWidth()-20-this.getWidth()/40,y=this.getY()+this.getHeight()/40;this.createButton(x,y,editor.getView().__deleteButton_svgPath,editor.getView().__deleteButton_BBox,attributes,function(){me.animateHideHoverZone();var event={nodeID:me.getNode().getID()};document.fire("pedigree:node:remove",event)},"delete","remove node")},getBoxOnHover:function(){return this._boxOnHover},isHovered:function(){return this._isHovered},setHovered:function(isHovered){this._isHovered=isHovered},setHighlighted:function(isHighlighted){isHighlighted?(this.getBoxOnHover().attr(PedigreeEditorParameters.attributes.boxOnHover),this.getBoxOnHover().attr("fill","green")):this.getBoxOnHover().attr(PedigreeEditorParameters.attributes.boxOnHover).attr("opacity",0)},getHoverZoneMask:function(){return this._mask},getFrontElements:function(){return this._frontElements},getBackElements:function(){return this._backElements},generateHandle:function(type,startX,startY,orbX,orbY,title,orbShapeGender,toHide){orbShapeGender||(orbShapeGender="F");var strokeWidth=editor.getWorkspace().getSizeNormalizedToDefaultZoom(PedigreeEditorParameters.attributes.handleStrokeWidth),path=[["M",startX,startY],["L",orbX,orbY]],connection=editor.getPaper().path(path).attr({"stroke-width":strokeWidth,stroke:"gray"}).toBack();connection.oPath=path;var orbRadius="createTouch"in document?PedigreeEditorParameters.attributes.touchOrbRadius:PedigreeEditorParameters.attributes.orbRadius,orbHue=PedigreeEditorParameters.attributes.orbHue,normalOrbAttr="F"!=orbShapeGender?{fill:"0-hsb("+orbHue+", 1, .75)-hsb("+orbHue+", .5, .25)",stroke:"#555","stroke-width":"0.75"}:{fill:"r(.5,.9)hsb("+orbHue+", 1, .75)-hsb("+orbHue+", .5, .25)",stroke:"none"},selectedOrbAttr="F"!=orbShapeGender?{fill:"0-hsb("+(orbHue+.36)+", 1, .75)-hsb("+(orbHue+.36)+", .5, .25)"}:{fill:"r(.5,.9)hsb("+(orbHue+.36)+", 1, .75)-hsb("+(orbHue+.36)+", .5, .25)"},orbAttrX="F"!=orbShapeGender?"x":"cx",orbAttrY="F"!=orbShapeGender?"y":"cy",orb=GraphicHelpers.generateOrb(editor.getPaper(),orbX,orbY,1.1*orbRadius,orbShapeGender).attr("cursor","pointer");orb[0].attr(normalOrbAttr);var handle=editor.getPaper().set().push(connection,orb);handle.type=type,connection.insertBefore(this.getHoverZoneMask()),orb.toFront();var me=this,inHoverMode=!1,interactionStarted=!1,onDragHandle=function(){inHoverMode||(inHoverMode=!0,null!==editor.getView().getCurrentDraggable()&&editor.getView().enterHoverMode(me.getNode(),type),toHide&&toHide.hide())},wrongClick=!1;return orb.drag(function(dx,dy){wrongClick||interactionStarted&&(onDragHandle(),dx/=editor.getWorkspace().zoomCoefficient,dy/=editor.getWorkspace().zoomCoefficient,0<orb.ot.length&&orb.transform(""),orb.attr(orbAttrX,orb.ox+dx),orb.attr(orbAttrY,orb.oy+dy),0<orb.ot.length&&orb.transform(orb.ot),connection.oPath[1][1]=connection.ox+dx,connection.oPath[1][2]=connection.oy+dy,connection.attr("path",connection.oPath),(1<dx||dx<-1||1<dy||dy<-1)&&(handle.isDragged=!0))},function(x,y,e){interactionStarted||(wrongClick=!(interactionStarted=!0),0==e.button?(connection.toFront(),orb.stop(),orb.toFront(),inHoverMode=!1,me.disable(),me.getFrontElements().toFront(),orb.ot?(orb.transform(""),orb.attr(orbAttrX,orb.ox),orb.attr(orbAttrY,orb.oy),orb.transform(orb.ot)):(orb.ot=orb[0].transform(),orb.ox=orb[0].attr(orbAttrX),orb.oy=orb[0].attr(orbAttrY)),connection.ox=connection.oPath[1][1],connection.oy=connection.oPath[1][2],handle.isDragged=!1,editor.getView().setCurrentDraggable(me.getNode().getID()),setTimeout(onDragHandle,100)):wrongClick=!(interactionStarted=!1))},function(){if(interactionStarted=inHoverMode=!1,!wrongClick){var curHoveredId=editor.getView().getCurrentHoveredNode();if(editor.getView().setCurrentDraggable(null),editor.getView().exitHoverMode(),handle.isDragged)if(0==orb.ot.length){var finalPosition={};finalPosition[orbAttrX]=orb.ox,finalPosition[orbAttrY]=orb.oy,orb.animate(finalPosition,1e3,"elastic",function(){})}else{var dx=orb.ox-orb[0].attr(orbAttrX),dy=orb.oy-orb[0].attr(orbAttrY);orb.animate({transform:"T"+dx+","+dy+"R45"},1e3,"elastic",function(){orb.transform(""),orb.attr(orbAttrX,orb.ox),orb.attr(orbAttrY,orb.oy),orb.transform(orb.ot)})}console.log("handle.isDragged: "+handle.isDragged+", currentHover: "+curHoveredId),connection.oPath[1][1]=connection.ox,connection.oPath[1][2]=connection.oy,connection.animate({path:connection.oPath},1e3,"elastic"),orb[0].attr(normalOrbAttr),connection.insertBefore(me.getHoverZoneMask()),me.enable(),handle.isDragged&&null==curHoveredId||me.handleAction(handle.type,handle.isDragged,curHoveredId)}}),orb.hover(function(){orb[0].attr(selectedOrbAttr),title&&(orb[0].attr({title:title}),orb[1].attr({title:title}))},function(){orb[0].attr(normalOrbAttr)}),this._currentOrbs.push(orb[0]),this._currentOrbs.push(orb[1]),this.disable(),this.getFrontElements().push(orb[0]),this.getFrontElements().push(orb[1]),this.enable(),handle},isMenuToggled:function(){return!1},animateDrawHoverZone:function(){null===editor.getView().getCurrentDraggable()&&(this._hidden=!1,this.getNode().getGraphics().setSelected(!0),this.getBoxOnHover().stop().animate({opacity:.7},200),this.generateButtons(),this.showButtons(),this.getCurrentButtons().forEach(function(button){button.hasOwnProperty("icon")&&button.icon.stop().animate({opacity:1},200)}),this._handlesZoomSz!=editor.getWorkspace().getCurrentZoomLevel()&&this.removeHandles(),this.generateHandles(),this.showHandles())},animateHideHoverZone:function(){null===editor.getView().getCurrentDraggable()&&(this._hidden=!0,this.getNode().getGraphics().setSelected(!1),this.getBoxOnHover().stop().animate({opacity:0},200),this.hideButtons(),this.hideHandles())},disable:function(){this._enabled=!1,this.getFrontElements().unhover(this.animateDrawHoverZone,this.animateHideHoverZone)},enable:function(){this._enabled=!0,this.getFrontElements().hover(this.animateDrawHoverZone,this.animateHideHoverZone)},remove:function(){this.disable(),this.removeButtons(),this.removeHandles(),this.getBackElements().remove(),this.getFrontElements().remove()},onWidgetHide:function(){this._isMenuToggled=!1,this._justClosedMenu=!0;var me=this;setTimeout(function(){me._justClosedMenu=!1},100),this._hidden?this.animateHideHoverZone():this.animateDrawHoverZone()},onWidgetShow:function(){this._isMenuToggled=!0}}),ReadOnlyHoverbox=Class.create(AbstractHoverbox,{initialize:function($super,node,x,y,shapes){this._node=node,this._nodeX=x,this._nodeY=y,this._shapes=editor.getPaper().set()},getWidth:function(){return 0},getHeight:function(){return 0},getNode:function(){return this._node},generateButtons:function(){},removeButtons:function(){},hideButtons:function(){},showButtons:function(){},getCurrentButtons:function(){return this._currentButtons},removeHandles:function(){},hideHandles:function(){},showHandles:function(){},generateHandles:function(){},regenerateHandles:function(){},getBoxOnHover:function(){return null},isHovered:function(){return!1},setHovered:function(isHovered){},setHighlighted:function(isHighlighted){},getHoverZoneMask:function(){return null},getFrontElements:function(){return this._shapes},getBackElements:function(){return this._shapes},isMenuToggled:function(){return!1},animateDrawHoverZone:function(){},animateHideHoverZone:function(){},disable:function(){},enable:function(){},remove:function(){},onWidgetHide:function(){},onWidgetShow:function(){}}),PartnershipHoverbox=Class.create(AbstractHoverbox,{initialize:function($super,partnership,junctionX,junctionY,nodeShapes){var radius=PedigreeEditorParameters.attributes.radius;$super(partnership,.65*-radius,.8*-radius,1.3*radius,2.3*radius,junctionX,junctionY,nodeShapes),this._isMenuToggled=!1},generateHandles:function($super){if(null===this._currentHandles&&($super(),"Infertile"!=this.getNode().getChildlessStatus())){var x=this.getNodeX(),y=this.getNodeY(),strokeWidth=editor.getWorkspace().getSizeNormalizedToDefaultZoom(PedigreeEditorParameters.attributes.handleStrokeWidth);editor.getPaper().setStart();var path=[["M",x,y],["L",x,y+PedigreeEditorParameters.attributes.partnershipHandleBreakY]];editor.getPaper().path(path).attr({"stroke-width":strokeWidth,stroke:"gray"}).insertBefore(this.getNode().getGraphics().getJunctionShape()),this.generateHandle("child",x,y+PedigreeEditorParameters.attributes.partnershipHandleBreakY,x,y+PedigreeEditorParameters.attributes.partnershipHandleLength),this._currentHandles.push(editor.getPaper().setFinish())}},generateButtons:function($super){null===this._currentButtons&&($super(),this.generateDeleteBtn(),this.generateMenuBtn())},generateMenuBtn:function(){var me=this,junctionShapedButton=this.getNode().getGraphics().getJunctionShape().clone();junctionShapedButton.attr(PedigreeEditorParameters.attributes.nodeShapeMenuOffPartner),junctionShapedButton.click(function(){me.toggleMenu(!me.isMenuToggled())}),junctionShapedButton.hover(function(){junctionShapedButton.attr(PedigreeEditorParameters.attributes.nodeShapeMenuOnPartner)},function(){junctionShapedButton.attr(PedigreeEditorParameters.attributes.nodeShapeMenuOffPartner)}),junctionShapedButton.attr("cursor","pointer"),this._currentButtons.push(junctionShapedButton),this.disable(),this.getFrontElements().push(junctionShapedButton),this.enable()},isMenuToggled:function(){return this._isMenuToggled},toggleMenu:function(isMenuToggled){if(!this._justClosedMenu&&(this._isMenuToggled=isMenuToggled)){var optBBox=this.getBoxOnHover().getBBox(),x=optBBox.x2,y=optBBox.y,position=editor.getWorkspace().canvasToDiv(x+5,y);editor.getPartnershipMenu().show(this.getNode(),position.x,position.y)}},animateHideHoverZone:function($super){this._hidden=!0,this.isMenuToggled()||$super()},animateDrawHoverZone:function($super){this._hidden=!1,this.isMenuToggled()||$super()},handleAction:function(handleType,isDrag,curHoveredId){if(isDrag&&null!=curHoveredId){if("child"==handleType){var event={personID:curHoveredId,parentID:this.getNode().getID()};document.fire("pedigree:person:drag:newparent",event)}}else if(!isDrag&&"child"==handleType){var position=editor.getWorkspace().canvasToDiv(this.getNodeX(),this.getNodeY()+PedigreeEditorParameters.attributes.partnershipHandleLength+15);!editor.getGraph().hasNonPlaceholderNonAdoptedChildren(this.getNode().getID())?editor.getNodetypeSelectionBubble().show(this.getNode(),position.x,position.y):editor.getSiblingSelectionBubble().show(this.getNode(),position.x,position.y)}this.animateHideHoverZone()}}),PersonHoverbox=Class.create(AbstractHoverbox,{initialize:function($super,personNode,centerX,centerY,nodeShapes){var radius=PedigreeEditorParameters.attributes.personHoverBoxRadius;$super(personNode,-radius,-radius,2*radius,2*radius,centerX,centerY,nodeShapes)},generateHandles:function($super){if(null===this._currentHandles){$super();var x=this.getNodeX(),y=this.getNodeY(),node=this.getNode(),nodeShapes=node.getGraphics().getGenderGraphics().flatten();if(editor.getPaper().setStart(),PedigreeEditorParameters.attributes.newHandles){var strokeWidth=editor.getWorkspace().getSizeNormalizedToDefaultZoom(PedigreeEditorParameters.attributes.handleStrokeWidth),partnerGender="U";"F"==node.getGender()&&(partnerGender="M"),"M"==node.getGender()&&(partnerGender="F");var splitLocationY=y-PedigreeEditorParameters.attributes.personHandleBreakY-4,path=[["M",x,y],["L",x,splitLocationY],["L",x+PedigreeEditorParameters.attributes.personSiblingHandleLengthX,splitLocationY]];if(editor.getPaper().path(path).attr({"stroke-width":strokeWidth,stroke:"gray"}).insertBefore(nodeShapes),this.generateHandle("sibling",x+PedigreeEditorParameters.attributes.personSiblingHandleLengthX-strokeWidth/3,splitLocationY,x+PedigreeEditorParameters.attributes.personSiblingHandleLengthX-strokeWidth/2,splitLocationY+PedigreeEditorParameters.attributes.personSiblingHandleLengthY,"Click to create a sibling or drag to an existing parentless person (valid choices will be highlighted in green)","U"),null===editor.getGraph().getParentRelationship(node.getID())){var topHandleHint=void 0;if(PedigreeEditorParameters.attributes.enableHandleHintImages){var hintSize=PedigreeEditorParameters.attributes.radius/2,line1=(path=[["M",x-hintSize,y-PedigreeEditorParameters.attributes.personHandleLength],["L",x+hintSize,y-PedigreeEditorParameters.attributes.personHandleLength]],editor.getPaper().path(path).attr({"stroke-width":strokeWidth/3,stroke:"#555555"}).toBack()),father=editor.getPaper().rect(x-hintSize-11,y-PedigreeEditorParameters.attributes.personHandleLength-5.5,11,11).attr({fill:"#CCCCCC"}).toBack(),mother=editor.getPaper().circle(x+hintSize+6,y-PedigreeEditorParameters.attributes.personHandleLength,6).attr({fill:"#CCCCCC"}).toBack();topHandleHint=editor.getPaper().set().push(line1,father,mother)}this.generateHandle("parent",x,splitLocationY,x,y-PedigreeEditorParameters.attributes.personHandleLength,"Click to create new nodes for the parents or drag to an existing person or partnership (valid choices will be highlighted in green). Dragging to a person will create a new relationship.","F",topHandleHint)}if(!node.isFetus()&&"adoptedOut"!=node.getAdopted()){if(null===node.getChildlessStatus()){path=[["M",x,y],["L",x,y+PedigreeEditorParameters.attributes.personHandleBreakX]];editor.getPaper().path(path).attr({"stroke-width":strokeWidth,stroke:"gray"}).insertBefore(nodeShapes),this.generateHandle("child",x,y+PedigreeEditorParameters.attributes.personHandleBreakX-2,x,y+PedigreeEditorParameters.attributes.personHandleLength,"Click to create a new child node or drag to an existing parentless person (valid choices will be highlighted in green)","U")}var vertPosForPartnerHandles=y;path=[["M",x,vertPosForPartnerHandles],["L",x-PedigreeEditorParameters.attributes.personHandleBreakX,vertPosForPartnerHandles]];editor.getPaper().path(path).attr({"stroke-width":strokeWidth,stroke:"gray"}).insertBefore(nodeShapes),this.generateHandle("partnerR",x-PedigreeEditorParameters.attributes.personHandleBreakX+2,vertPosForPartnerHandles,x-PedigreeEditorParameters.attributes.personHandleLength,vertPosForPartnerHandles,"Click to create a new partner node or drag to an existing node (valid choices will be highlighted in green)",partnerGender)}}else null===editor.getGraph().getParentRelationship(node.getID())&&this.generateHandle("parent",x,y,x,y-PedigreeEditorParameters.attributes.personHandleLength,"Click to create new nodes for the parents or drag to an existing person or partnership (valid choices will be highlighted in green)"),node.isFetus()||"adoptedOut"==node.getAdopted()||(null===node.getChildlessStatus()&&this.generateHandle("child",x,y,x,y+PedigreeEditorParameters.attributes.personHandleLength,"Click to create a new child node or drag to an existing parentless node (valid choices will be highlighted in green)"),this.generateHandle("partnerR",x,y,x+PedigreeEditorParameters.attributes.personHandleLength,y,"Click to create a new partner node or drag to an existing node (valid choices will be highlighted in green)"),this.generateHandle("partnerL",x,y,x-PedigreeEditorParameters.attributes.personHandleLength,y,"Click to create a new partner node or drag to an existing node (valid choices will be highlighted in green)"));this._currentHandles.push(editor.getPaper().setFinish())}},generateButtons:function($super){null===this._currentButtons&&($super(),this.generateMenuBtn(),this.getNode().isProband()||this.generateDeleteBtn())},generateMenuBtn:function(){var me=this,genderShapedButton=this.getNode().getGraphics().getGenderShape().clone();genderShapedButton.attr(PedigreeEditorParameters.attributes.nodeShapeMenuOff),genderShapedButton.click(function(){me.toggleMenu(!me.isMenuToggled())}),genderShapedButton.hover(function(){genderShapedButton.attr(PedigreeEditorParameters.attributes.nodeShapeMenuOn)},function(){genderShapedButton.attr(PedigreeEditorParameters.attributes.nodeShapeMenuOff)}),genderShapedButton.attr("cursor","pointer"),this._currentButtons.push(genderShapedButton),this.disable(),this.getFrontElements().push(genderShapedButton),this.enable()},isMenuToggled:function(){return this._isMenuToggled},toggleMenu:function(isMenuToggled){if(!this._justClosedMenu&&(this._isMenuToggled=isMenuToggled)){this.getNode().getGraphics().unmark();var optBBox=this.getBoxOnHover().getBBox(),x=optBBox.x2,y=optBBox.y,position=editor.getWorkspace().canvasToDiv(x+5,y);editor.getNodeMenu().show(this.getNode(),position.x,position.y)}},animateHideHoverZone:function($super){if(this._hidden=!0,!this.isMenuToggled()){var parentPartnershipNode=editor.getGraph().getParentRelationship(this.getNode().getID());parentPartnershipNode&&editor.getNode(parentPartnershipNode)&&editor.getNode(parentPartnershipNode).getGraphics().unmarkPregnancy(),$super()}},animateDrawHoverZone:function($super){if(this._hidden=!1,!this.isMenuToggled()){var parentPartnershipNode=editor.getGraph().getParentRelationship(this.getNode().getID());parentPartnershipNode&&editor.getNode(parentPartnershipNode)&&editor.getNode(parentPartnershipNode).getGraphics().markPregnancy(),$super()}},handleAction:function(handleType,isDrag,curHoveredId){if(console.log("handleType: "+handleType+", isDrag: "+isDrag+", curHovered: "+curHoveredId),isDrag&&null!==curHoveredId){if("parent"==handleType){this.removeHandles(),this.removeButtons();var event={personID:this.getNode().getID(),parentID:curHoveredId};document.fire("pedigree:person:drag:newparent",event)}else if("partnerR"==handleType||"partnerL"==handleType){this.removeHandles();event={personID:this.getNode().getID(),partnerID:curHoveredId};document.fire("pedigree:person:drag:newpartner",event)}else if("child"==handleType){event={personID:curHoveredId,parentID:this.getNode().getID()};document.fire("pedigree:person:drag:newparent",event)}else if("sibling"==handleType){event={sibling2ID:curHoveredId,sibling1ID:this.getNode().getID()};document.fire("pedigree:person:drag:newsibling",event)}}else if(!isDrag)if("partnerR"==handleType||"partnerL"==handleType){this.removeHandles();var preferLeft="F"==this.getNode().getGender()||"partnerL"==handleType;event={personID:this.getNode().getID(),preferLeft:preferLeft};document.fire("pedigree:person:newpartnerandchild",event)}else if("child"==handleType){var position=editor.getWorkspace().canvasToDiv(this.getNodeX(),this.getNodeY()+PedigreeEditorParameters.attributes.personHandleLength+15);editor.getNodetypeSelectionBubble().show(this.getNode(),position.x,position.y)}else if("sibling"==handleType){position=editor.getWorkspace().canvasToDiv(this.getNodeX()+PedigreeEditorParameters.attributes.personSiblingHandleLengthX-4,this.getNodeY()-PedigreeEditorParameters.attributes.personHandleBreakY+PedigreeEditorParameters.attributes.personSiblingHandleLengthY+15);editor.getSiblingSelectionBubble().show(this.getNode(),position.x,position.y)}else if("parent"==handleType){this.removeHandles(),this.removeButtons();event={personID:this.getNode().getID()};document.fire("pedigree:person:newparent",event)}this.animateHideHoverZone()}}),AbstractNode=Class.create({initialize:function(x,y,id){this._id=id,this._comments="",!this._type&&(this._type="AbstractNode"),this._graphics=this._generateGraphics(x,y)},getID:function(){return this._id},setID:function(id){id!=this._id&&(this._id=id,this._graphics.onSetID(id))},_generateGraphics:function(x,y){return new AbstractNodeVisuals(this,x,y)},getGraphics:function(){return this._graphics},getX:function(){return this.getGraphics().getX()},getY:function(){return this.getGraphics().getY()},setPos:function(x,y,animate,callback){this.getGraphics().setPos(x,y,animate,callback)},getType:function(){return this._type},remove:function(){this.getGraphics().remove()},getComments:function(){return this._comments},setComments:function(comment){this._comments=comment},getProperties:function(){var info={};return""!=this.getComments()&&(info.comments=this.getComments()),info},assignProperties:function(properties){return properties.hasOwnProperty("comments")&&this.getComments()!=properties.comments&&this.setComments(properties.comments),!0},onWidgetHide:function(){this.getGraphics().getHoverBox()&&this.getGraphics().getHoverBox().onWidgetHide()},onWidgetShow:function(){this.getGraphics().getHoverBox()&&this.getGraphics().getHoverBox().onWidgetShow()}}),AbstractNodeVisuals=Class.create({initialize:function(node,x,y){this._node=node,this._absoluteX=x,this._absoluteY=y,this._hoverBox=null,this._isGrown=!1,this._anonimized=!1},getNode:function(){return this._node},getX:function(){return this._absoluteX},onSetID:function(id){},setAnonimizedStatus:function(status){this._anonimized=status},getY:function(){return this._absoluteY},getBottomY:function(){return this._absoluteY},setPos:function(x,y,animate,callback){this._absoluteX=x,this._absoluteY=y,callback&&callback()},grow:function(){this._isGrown=!0},shrink:function(){this._isGrown=!1},isGrown:function(){return this._isGrown},containsXY:function(x,y){return!1},isSelected:function(){return this._isSelected},setSelected:function(isSelected){this._isSelected=isSelected},getAllGraphics:function(){return editor.getPaper().set(this.getShapes())},getShapes:function(){return editor.getPaper().set()},remove:function(){this.getHoverBox()&&this.getHoverBox().remove(),this.getAllGraphics().remove()},getHoverBox:function(){return this._hoverBox}}),AbstractPerson=Class.create(AbstractNode,{initialize:function($super,x,y,gender,id){this._gender=this.parseGender(gender),this._adoptedStatus="",!this._type&&(this._type="AbstractPerson"),$super(x,y,id)},_generateGraphics:function(x,y){return new AbstractPersonVisuals(this,x,y)},parseGender:function(gender){var genderUpperCase=gender.toUpperCase();return"M"==genderUpperCase||"F"==genderUpperCase||"O"==genderUpperCase?genderUpperCase:"U"},getGender:function(){return this._gender},isPersonGroup:function(){return"PersonGroup"==this._type},setGender:function(gender){gender=this.parseGender(gender);this._gender!=gender&&(this._gender=gender,this.getGraphics().setGenderGraphics(),this.getGraphics().getHoverBox().regenerateHandles(),this.getGraphics().getHoverBox().regenerateButtons())},setSex:function(sex){this.setGender(sex)},setAdopted:function(adoptedStatus){""!=adoptedStatus&&"adoptedIn"!=adoptedStatus&&"adoptedOut"!=adoptedStatus&&(adoptedStatus=""),this._adoptedStatus=adoptedStatus,this.getGraphics().drawAdoptedShape(),this.getGraphics().getHoverBox().regenerateHandles()},getAdopted:function(){return this._adoptedStatus},getProperties:function($super){var info=$super();return info.gender=this.getGender(),info},assignProperties:function($super,properties){return!!$super(properties)&&(!!properties.gender&&(this.getGender()!=this.parseGender(properties.gender)&&this.setGender(properties.gender),!0))}});Settings=Class.create({initialize:function(baseURL){this._settings=config,this._settings.version=version},getSetting:function(key){return null==this._settings&&alert("Settings are not loaded yet"),this._settings[key]}});var UndoRedoManager=Class.create({initialize:function(){this._currentState=0,this._stack=[],this._MAXUNDOSIZE=100,this._savedState=""},hasUnsavedChanges:function(){var state=this._getCurrentState();return null==state||this._savedState!=state.serializedState},hasRedo:function(){return!!this._getNextState()},hasUndo:function(){return!!this._getPreviousState()},addSaveEvent:function(){var state=this._getCurrentState();null!=state&&(this._savedState=state.serializedState)},redo:function(){var nextState=this._getNextState();if(nextState){if(this._currentState++,nextState.eventToGetToThisState){var memo=nextState.eventToGetToThisState.memo;memo.noUndoRedo=!0,document.fire(nextState.eventToGetToThisState.eventName,memo)}else editor.getSaveLoadEngine().createGraphFromSerializedData(nextState.serializedState,!0);document.fire("pedigree:historychange",null)}},undo:function(){var prevState=this._getPreviousState();if(prevState){var currentState=this._getCurrentState();if(this._currentState--,currentState.eventToUndo){var memo=currentState.eventToUndo.memo;memo.noUndoRedo=!0,document.fire(currentState.eventToUndo.eventName,memo)}else editor.getSaveLoadEngine().createGraphFromSerializedData(prevState.serializedState,!0);document.fire("pedigree:historychange",null)}},addState:function(eventToGetToThisState,eventToUndo,serializedState){this._currentState<this._size()&&this._stack.splice(this._currentState,this._stack.length-this._currentState),serializedState||(serializedState=editor.getSaveLoadEngine().serialize());var state=new State(serializedState,eventToGetToThisState,eventToUndo),currentState=this._getCurrentState();if(eventToGetToThisState&&currentState&&currentState.eventToGetToThisState&&"pedigree:node:setproperty"==currentState.eventToGetToThisState.eventName&&this._combinableEvents(currentState.eventToGetToThisState,eventToGetToThisState))return currentState.eventToGetToThisState=eventToGetToThisState,void(currentState.serializedState=serializedState);this._addNewest(state),this._size()>this._MAXUNDOSIZE&&this._removeOldest(),document.fire("pedigree:historychange",null)},_combinableEvents:function(event1,event2){return!(!event1.memo.hasOwnProperty("nodeID")||!event2.memo.hasOwnProperty("nodeID")||event1.memo.nodeID!=event2.memo.nodeID)&&(!(!event1.memo.properties.hasOwnProperty("setFirstName")||!event2.memo.properties.hasOwnProperty("setFirstName"))||(!(!event1.memo.properties.hasOwnProperty("setLastName")||!event2.memo.properties.hasOwnProperty("setLastName"))||(!(!event1.memo.properties.hasOwnProperty("setLastNameAtBirth")||!event2.memo.properties.hasOwnProperty("setLastNameAtBirth"))||(!(!event1.memo.properties.hasOwnProperty("setComments")||!event2.memo.properties.hasOwnProperty("setComments"))||!(!event1.memo.properties.hasOwnProperty("setChildlessReason")||!event2.memo.properties.hasOwnProperty("setChildlessReason"))))))},_size:function(){return this._stack.length},_addNewest:function(state){this._stack.push(state),this._currentState++},_removeOldest:function(){this._stack.splice(0,1),this._currentState--},_getCurrentState:function(){return 0==this._size()||0==this._currentState?null:this._stack[this._currentState-1]},_getNextState:function(){return this._size()<=1||this._currentState>=this._size()?null:this._stack[this._currentState]},_getPreviousState:function(){return 1==this._size()||this._currentState<=1?null:this._stack[this._currentState-2]},_debug_print_states:function(){console.log("------------");for(var i=0;i<this._stack.length;i++)console.log("["+i+"] EventToState: "+Helpers.stringifyObject(this._stack[i].eventToGetToThisState)+"\n    EventUndo: "+Helpers.stringifyObject(this._stack[i].eventToUndo)+"\n    EventSerial: "+Helpers.stringifyObject(this._stack[i].serializedState));console.log("------------")}}),State=Class.create({initialize:function(serializedState,eventToGetToThisState,eventToUndo){this.serializedState=serializedState,this.eventToGetToThisState=eventToGetToThisState,this.eventToUndo=eventToUndo}}),Controller=Class.create({initialize:function(){document.observe("pedigree:update:topMenu",this.handleTopMenuUpdate),document.observe("pedigree:update:clinicalIndicationName",this.handleClinicalIndicationNameUpdate),document.observe("pedigree:autolayout",this.handleAutoLayout),document.observe("pedigree:graph:clear",this.handleClearGraph),document.observe("pedigree:undo",this.handleUndo),document.observe("pedigree:redo",this.handleRedo),document.observe("pedigree:renumber",this.handleRenumber),document.observe("pedigree:historychange",this.handleUndoHistoryChange),document.observe("pedigree:node:remove",this.handleRemove),document.observe("pedigree:node:setproperty",this.handleSetProperty),document.observe("pedigree:node:modify",this.handleModification),document.observe("pedigree:person:drag:newparent",this.handlePersonDragToNewParent),document.observe("pedigree:person:drag:newpartner",this.handlePersonDragToNewPartner),document.observe("pedigree:person:drag:newsibling",this.handlePersonDragToNewSibling),document.observe("pedigree:person:newparent",this.handlePersonNewParents),document.observe("pedigree:person:newsibling",this.handlePersonNewSibling),document.observe("pedigree:person:newpartnerandchild",this.handlePersonNewPartnerAndChild),document.observe("pedigree:partnership:newchild",this.handleRelationshipNewChild)},handleUndo:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo)),editor.getUndoRedoManager().undo()},handleRedo:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo)),editor.getUndoRedoManager().redo()},handleRenumber:function(event){var check=event.memo.hasOwnProperty("check"),clear=!1,needRedraw=!1;do{var secondPass=!1;for(var nodeID in editor.getView().getNodeMap())if(editor.getView().getNodeMap().hasOwnProperty(nodeID)&&editor.getGraph().isPerson(nodeID)&&!editor.getGraph().isPlaceholder(nodeID)){var node=editor.getView().getNode(nodeID),currentPedNumber=node.getPedNumber();if(clear)var pedNumber="";else{var generation=editor.getGraph().getGeneration(nodeID),order=editor.getGraph().getOrderWithinGeneration(nodeID);pedNumber=Helpers.romanize(generation)+"-"+order;if(check&&pedNumber!=currentPedNumber){secondPass=clear=!0;break}}if(currentPedNumber!=pedNumber){needRedraw=!0,node.setPedNumber(pedNumber);var allProperties=node.getProperties();editor.getGraph().setProperties(nodeID,allProperties)}}}while(secondPass);var renumberButton=$("action-number");try{clear?(renumberButton.removeClassName("disabled-menu-item"),renumberButton.addClassName("menu-item")):(renumberButton.removeClassName("menu-item"),renumberButton.addClassName("disabled-menu-item"))}catch(err){console.log(err)}!event.memo.noUndoRedo&&needRedraw&&(editor.getView().unmarkAll(),editor.getUndoRedoManager().addState(event))},handleUndoHistoryChange:function(){var redoButton=$("action-redo");editor.getUndoRedoManager().hasRedo()?(redoButton.removeClassName("disabled-menu-item"),redoButton.addClassName("menu-item")):(redoButton.removeClassName("menu-item"),redoButton.addClassName("disabled-menu-item"));var undoButton=$("action-undo");editor.getUndoRedoManager().hasUndo()?(undoButton.removeClassName("disabled-menu-item"),undoButton.addClassName("menu-item")):(undoButton.removeClassName("menu-item"),undoButton.addClassName("disabled-menu-item"))},handleAutoLayout:function(event){try{console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var changeSet=editor.getGraph().redrawAll();editor.getView().applyChanges(changeSet,!0),event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)}catch(err){console.log("Autolayout error: "+err)}},handleClearGraph:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var changeSet=editor.getGraph().clearAll();editor.getView().applyChanges(changeSet,!0),editor.getWorkspace().centerAroundNode(0,!1),event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)},handleTopMenuUpdate:function(event){var testRequestId=event.memo.testRequestId;editor.getWorkspace().setMenuText(testRequestId,"")},handleClinicalIndicationNameUpdate:function(event){var clinicalIndicationName=event.memo.clinicalIndicationName;editor.getWorkspace().setClinicalIndicationNameText(clinicalIndicationName)},handleRemove:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var nodeID=event.memo.nodeID,disconnectedList=editor.getGraph().getDisconnectedSetIfNodeRemoved(nodeID),onlyChild=!1;if(editor.getGraph().isPerson(nodeID)&&editor.getGraph().isOnlyChild(nodeID)){var producingRelationship=editor.getGraph().getParentRelationship(nodeID);Helpers.arrayContains(disconnectedList,producingRelationship)||(onlyChild=!0)}if(onlyChild){var closeFunction=function(){this.dialog&&this.dialog.show()};editor.getOkCancelDialogue().showCustomized("You cannot remove an only child (still attached to a parent).<br> Please remove one of the parents to trigger the removal of the only child.","Genomics England","Close",closeFunction,null,null,null,null,!0)}else{for(var i=0;i<disconnectedList.length;i++){var nodeIndex=disconnectedList[i],node=null;try{node=editor.getView().getNode(nodeIndex)}catch(exp){console.log(exp)}if(node&&(node.isRegistered&&node.isRegistered())){closeFunction=function(){this.dialog&&this.dialog.show()};return void editor.getOkCancelDialogue().showCustomized("You can not delete registered participants or any hierarchy that contains a registered participant(s) .","Genomics England","Close",closeFunction,null,null,null,null,!0)}}var removeSelected=function(){try{if(onlyChild&&(Helpers.removeFirstOccurrenceByValue(disconnectedList,nodeID),editor.getGraph().setProperties(nodeID,{gender:"U",placeholder:!0}),!editor.getGraph().isChildless(producingRelationship))){var partnership=editor.getView().getNode(producingRelationship);partnership.setChildlessStatus("Childless");var newProperties=partnership.getProperties();editor.getGraph().setProperties(producingRelationship,newProperties)}var changeSet=editor.getGraph().removeNodes(disconnectedList);if(onlyChild){changeSet.removed.push(nodeID);var newNodeID=changeSet.changedIDSet.hasOwnProperty(nodeID)?changeSet.changedIDSet[nodeID]:nodeID;changeSet.new=[newNodeID]}editor.getView().applyChanges(changeSet,!0);changeSet=editor.getGraph().improvePosition();editor.getView().applyChanges(changeSet,!0),event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)}catch(err){console.log("[DEBUG] Remove error: "+err)}};if(disconnectedList.length<=1||event.memo.hasOwnProperty("noUndoRedo"))removeSelected();else{editor.getView().unmarkAll();for(i=0;i<disconnectedList.length;i++){var nextHighlight=disconnectedList[i];editor.getView().checkNodeExists(nextHighlight)&&editor.getView().getNode(nextHighlight).getGraphics().markPermanently()}editor.getOkCancelDialogue().show("All highlighted nodes will be removed. Do you want to proceed?","Delete nodes?",removeSelected,function(){for(var i=0;i<disconnectedList.length;i++){var nextHighlight=disconnectedList[i];editor.getView().checkNodeExists(nextHighlight)&&editor.getView().getNode(nextHighlight).getGraphics().unmark()}})}}},handleSetProperty:function(event){var nodeID=event.memo.nodeID,properties=event.memo.properties,undoEvent={eventName:event.eventName,memo:{nodeID:nodeID,properties:Helpers.cloneObject(event.memo.properties)}},node=editor.getView().getNode(nodeID),twinUpdate=void 0,needUpdateAncestors=!1,needUpdateRelationship=!1,needUpdateAllRelationships=!1,needUpdateYPositions=!1,changedValue=!1;for(var propertySetFunction in properties)if(properties.hasOwnProperty(propertySetFunction)){var propValue=properties[propertySetFunction];if(!Controller._validatePropertyValue(nodeID,propertySetFunction,propValue))continue;var propertyGetFunction=propertySetFunction.replace("set","get"),oldValue=null;if(node[propertyGetFunction]&&"function"==typeof node[propertyGetFunction]&&(oldValue=node[propertyGetFunction]()),oldValue==propValue)continue;if(oldValue&&"object"==typeof oldValue&&"object"==typeof propValue&&("setDeathDate"==propertySetFunction||"setBirthDate"==propertySetFunction))try{if(oldValue.decade==propValue.decade&&oldValue.year==propValue.year&&oldValue.month==propValue.month&&oldValue.day==propValue.day)continue}catch(err){}if("[object Array]"===Object.prototype.toString.call(oldValue)?oldValue=oldValue.slice(0):"object"==typeof oldValue&&(oldValue=Helpers.cloneObject(oldValue)),undoEvent.memo.properties[propertySetFunction]=oldValue,"setLifeStatus"==propertySetFunction&&(undoEvent.memo.properties.setDeathDate=node.getDeathDate(),undoEvent.memo.properties.setGestationAgeWeeks=node.getGestationAgeWeeks(),undoEvent.memo.properties.setGestationAgeDays=node.getGestationAgeDays(),undoEvent.memo.properties.setBirthDate=node.getBirthDate(),undoEvent.memo.properties.setAdopted=node.getAdopted()),"setDeathDate"==propertySetFunction&&(undoEvent.memo.properties.setLifeStatus=node.getLifeStatus()),"setChildlessStatus"==propertySetFunction&&(undoEvent.memo.properties.setChildlessReason=node.getChildlessReason()),"setDisorders"==propertySetFunction&&(undoEvent.memo.properties.setCarrierStatus=node.getCarrierStatus()),"setCarrierStatus"==propertySetFunction&&(undoEvent.memo.properties.setDisorders=node.getDisorders().slice(0)),node[propertySetFunction]&&"function"==typeof node[propertySetFunction]&&node[propertySetFunction](propValue),"setDisorders"==propertySetFunction){var newDisorders=node[propertyGetFunction]();if(JSON.stringify(oldValue)==JSON.stringify(newDisorders))continue}changedValue=!0,"setLastName"==propertySetFunction&&editor.getPreferencesManager().getConfigurationOption("propagateFatherLastName")&&"M"==node.getGender(nodeID)&&(Controller._propagateLastNameAtBirth(nodeID,propValue,oldValue),undoEvent=null),"setGender"==propertySetFunction&&(node.getMonozygotic()&&(twinUpdate||(twinUpdate={}),twinUpdate[propertySetFunction]=propValue),"U"==oldValue&&"M"==propValue&&""==node.getLastName()&&""!=node.getLastNameAtBirth()&&0==editor.getGraph().getAllChildren(nodeID).length&&(node.setLastName(node.getLastNameAtBirth()),node.setLastNameAtBirth(""),undoEvent=null)),"setBirthDate"==propertySetFunction&&(twinUpdate||(twinUpdate={}),twinUpdate[propertySetFunction]=propValue),"setAdopted"==propertySetFunction&&(needUpdateAncestors=!0,"adoptedIn"==propValue&&(twinUpdate||(twinUpdate={}),twinUpdate[propertySetFunction]=propValue),"adoptedIn"==oldValue&&(twinUpdate||(twinUpdate={}),twinUpdate[propertySetFunction]="")),"setComments"!=propertySetFunction&&"setExternalID"!=propertySetFunction&&"setFirstName"!=propertySetFunction&&"setLastName"!=propertySetFunction||Helpers.numTextLines(oldValue)!=Helpers.numTextLines(propValue)&&(needUpdateYPositions=!0),"setBirthDate"!=propertySetFunction&&"setDeathDate"!=propertySetFunction||(needUpdateYPositions=!0),"setCancers"==propertySetFunction&&(needUpdateYPositions=!0),"setMonozygotic"==propertySetFunction&&(needUpdateRelationship=!0,twinUpdate||(twinUpdate={}),twinUpdate[propertySetFunction]=propValue),"setConsanguinity"!=propertySetFunction&&"setBrokenStatus"!=propertySetFunction||(needUpdateRelationship=!0),"setLostContact"==propertySetFunction&&(needUpdateAllRelationships=!0)}if(twinUpdate){var allTwins=editor.getGraph().getAllTwinsSortedByOrder(nodeID);for(var propertySetFunction in twinUpdate)if(twinUpdate.hasOwnProperty(propertySetFunction)){propValue=twinUpdate[propertySetFunction];for(var i=0;i<allTwins.length;i++){var twin=allTwins[i];if(twin!=nodeID){var twinNode=editor.getView().getNode(twin);twinNode[propertySetFunction](propValue);var twinProperties=twinNode.getProperties();console.log("Setting twin properties: "+Helpers.stringifyObject(twinProperties)),editor.getGraph().setProperties(twin,twinProperties)}}}}var allProperties=node.getProperties();if(editor.getGraph().setProperties(nodeID,allProperties),needUpdateAncestors){var changeSet=editor.getGraph().updateAncestors();editor.getView().applyChanges(changeSet,!0)}if(needUpdateAllRelationships){changeSet={moved:editor.getGraph().getAllRelatedRelationships(nodeID)};editor.getView().applyChanges(changeSet,!0)}if(needUpdateRelationship){changeSet={moved:[editor.getGraph().isRelationship(nodeID)?nodeID:editor.getGraph().getParentRelationship(nodeID)]};editor.getView().applyChanges(changeSet,!0)}if(needUpdateYPositions){changeSet=editor.getGraph().updateYPositioning();editor.getView().applyChanges(changeSet,!0)}editor.getNodeMenu().update(),!event.memo.noUndoRedo&&changedValue&&editor.getUndoRedoManager().addState(event,undoEvent)},handleModification:function(event){try{console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var nodeID=event.memo.nodeID,modifications=event.memo.modifications,node=editor.getView().getNode(nodeID);for(modificationType in modifications)if(modifications.hasOwnProperty(modificationType)){var modValue=modifications[modificationType];if("addTwin"==modificationType){for(var numNewTwins=modValue-1,i=0;i<numNewTwins;i++){var twinProperty={gender:node.getGender()};"adoptedIn"==node.getAdopted()&&(twinProperty.adoptedStatus=node.getAdopted());var changeSet=editor.getGraph().addTwin(nodeID,twinProperty);editor.getView().applyChanges(changeSet,!0)}node.assignProperties(editor.getGraph().getProperties(nodeID))}modificationType}event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)}catch(err){console.log("err: "+err)}},handlePersonDragToNewParent:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var personID=event.memo.personID,parentID=event.memo.parentID;if(editor.getGraph().isPerson(personID)&&editor.getGraph().isValidID(parentID)){if(editor.getGraph().isRelationship(parentID)&&editor.getGraph().isChildlessByChoice(parentID)){var partnership=editor.getView().getNode(parentID);partnership.setChildlessStatus(null);var newProperties=partnership.getProperties();editor.getGraph().setProperties(parentID,newProperties)}editor.getGraph().isChildless(parentID)&&editor.getController().handleSetProperty({memo:{nodeID:personID,properties:{setAdopted:"adoptedIn"},noUndoRedo:!0}});try{var changeSet=editor.getGraph().assignParent(parentID,personID);editor.getView().applyChanges(changeSet,!0),-1!=changeSet.moved.indexOf(personID)&&editor.getWorkspace().centerAroundNode(personID,!0),event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)}catch(err){console.log("err: "+err)}}},handlePersonNewParents:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var personID=event.memo.personID;if(editor.getGraph().isPerson(personID)){var changeSet=editor.getGraph().addNewParents(personID);return editor.getView().applyChanges(changeSet,!0),event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event),changeSet.new[0]}},handlePersonNewSibling:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var personID=event.memo.personID,childParams=event.memo.childParams?Helpers.cloneObject(event.memo.childParams):{},parentRelationship=(event.memo.twins&&event.memo.twins,event.memo.groupSize&&event.memo.groupSize,editor.getGraph().getParentRelationship(personID));if(null===parentRelationship&&(parentRelationship=editor.getController().handlePersonNewParents({memo:{personID:personID,noUndoRedo:!0}})),event.memo.twins){var nextEvent={nodeID:personID,modifications:{addTwin:event.memo.twins},noUndoRedo:!0};editor.getController().handleModification({memo:nextEvent})}else{nextEvent={partnershipID:parentRelationship,childParams:childParams,noUndoRedo:!0};event.memo.groupSize&&(nextEvent.groupSize=event.memo.groupSize),editor.getController().handleRelationshipNewChild({memo:nextEvent})}event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)},handlePersonDragToNewSibling:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var sibling1=event.memo.sibling1ID,sibling2=event.memo.sibling2ID,parentRelationship=editor.getGraph().getParentRelationship(sibling1);null==parentRelationship&&(parentRelationship=editor.getGraph().getParentRelationship(sibling2)),null===parentRelationship&&(parentRelationship=editor.getController().handlePersonNewParents({memo:{personID:sibling1,noUndoRedo:!0}})),editor.getGraph().getParentRelationship(sibling2)!=parentRelationship?editor.getController().handlePersonDragToNewParent({memo:{personID:sibling2,parentID:parentRelationship,noUndoRedo:!0}}):editor.getController().handlePersonDragToNewParent({memo:{personID:sibling1,parentID:parentRelationship,noUndoRedo:!0}}),event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)},handlePersonNewPartnerAndChild:function(event){var timer=new Helpers.Timer;try{console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var personID=event.memo.personID;if(!editor.getGraph().isPerson(personID))return;var preferLeft=event.memo.preferLeft,childParams=event.memo.childParams?Helpers.cloneObject(event.memo.childParams):{},numTwins=event.memo.twins?event.memo.twins:1,numPersons=event.memo.groupSize?event.memo.groupSize:0;if(editor.getGraph().isChildless(personID)&&(childParams.adoptedStatus="adoptedIn"),0<numPersons&&(childParams.numPersons=numPersons),editor.getPreferencesManager().getConfigurationOption("propagateFatherLastName")){var lastName=null;"M"==editor.getGraph().getGender(personID)&&(lastName=editor.getGraph().getLastName(personID)),lastName&&""!=lastName&&(childParams.hasOwnProperty("gender")&&"M"==childParams.gender?childParams.lName=lastName:childParams.lNameAtB=lastName)}var changeSet=editor.getGraph().addNewRelationship(personID,childParams,preferLeft,numTwins);editor.getView().applyChanges(changeSet,!0),event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)}catch(err){console.log("err: "+err)}timer.printSinceLast("=== Total new partner+child runtime: ")},handlePersonDragToNewPartner:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var personID=event.memo.personID,partnerID=event.memo.partnerID;if(editor.getGraph().isPerson(personID)&&editor.getGraph().isPerson(partnerID)){var childProperties={};(editor.getGraph().isChildless(personID)||editor.getGraph().isChildless(partnerID))&&(childProperties.adoptedStatus="adoptedIn");var node1=editor.getView().getNode(personID),node2=editor.getView().getNode(partnerID);if("U"==node1.getGender()&&"U"!=node2.getGender()){var gender1=editor.getGraph().getOppositeGender(partnerID);node1.setGender(gender1),editor.getGraph().setProperties(personID,node1.getProperties())}else if("U"!=node1.getGender()&&"U"==node2.getGender()){var gender2=editor.getGraph().getOppositeGender(personID);node2.setGender(gender2),editor.getGraph().setProperties(partnerID,node2.getProperties())}if(editor.getPreferencesManager().getConfigurationOption("propagateFatherLastName")){var lastName=null;"M"==node1.getGender()?lastName=editor.getGraph().getLastName(personID):"M"==node2.getGender()&&(lastName=editor.getGraph().getLastName(partnerID)),lastName&&""!=lastName&&(childProperties.lNameAtB=lastName)}var changeSet=editor.getGraph().assignPartner(personID,partnerID,childProperties);editor.getView().applyChanges(changeSet,!0),event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)}},handleRelationshipNewChild:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var partnershipID=event.memo.partnershipID;if(editor.getGraph().isRelationship(partnershipID)){var numTwins=event.memo.twins?event.memo.twins:1,childParams=Helpers.cloneObject(event.memo.childParams);editor.getGraph().isInfertile(partnershipID)&&(childParams.adoptedStatus="adoptedIn");var numPersons=event.memo.groupSize?event.memo.groupSize:0;if(0<numPersons&&(childParams.numPersons=numPersons),editor.getPreferencesManager().getConfigurationOption("propagateFatherLastName")){var lastName=editor.getGraph().getRelationshipChildLastName(partnershipID);lastName&&("M"==childParams.gender?childParams.lName=lastName:childParams.lNameAtB=lastName)}var children=editor.getGraph().getRelationshipChildrenSortedByOrder(partnershipID);if(1==children.length&&editor.getGraph().isPlaceholder(children[0])){var changeSet=editor.getGraph().convertPlaceholderTo(children[0],childParams);if(editor.getGraph().isChildlessByChoice(partnershipID)){var partnership=editor.getView().getNode(partnershipID);partnership.setChildlessStatus(null);var newProperties=partnership.getProperties();editor.getGraph().setProperties(partnershipID,newProperties)}}else changeSet=editor.getGraph().addNewChild(partnershipID,childParams,numTwins);editor.getView().applyChanges(changeSet,!0),event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)}}});Controller._validatePropertyValue=function(nodeID,propertySetFunction,propValue){return"setGender"!=propertySetFunction||editor.getGraph().getPossibleGenders(nodeID)[propValue]},Controller._propagateLastNameAtBirth=function(parentID,parentLastName,changeIfEqualTo){for(var children=editor.getGraph().getAllChildren(parentID),i=0;i<children.length;i++){var childID=children[i],childNode=editor.getView().getNode(childID);if(childNode.getLastNameAtBirth()==changeIfEqualTo||""==childNode.getLastNameAtBirth()&&(""==childNode.getLastName()||"M"==childNode.getGender()&&childNode.getLastName()==changeIfEqualTo)){"M"==childNode.getGender()&&childNode.getLastNameAtBirth()!=changeIfEqualTo?childNode.setLastName(parentLastName):childNode.setLastNameAtBirth(parentLastName);var allProperties=childNode.getProperties();editor.getGraph().setProperties(childID,allProperties),"M"==childNode.getGender()&&Controller._propagateLastNameAtBirth(childID,parentLastName,changeIfEqualTo)}}};var PreferencesManager=Class.create({initialize:function(templatePreferences){this.preferences=templatePreferences},load:function(callWhenReady){new XWiki.Document("PedigreeInterface","PhenoTips").getURL("get","action=getPreferences");Math.random();var defaultResponse={responseJSON:{user:{firstName:"",lastName:"",hideDraggingHint:!1},global:{disabledFields:[],dateDisplayFormat:"MDY",dateEditFormat:"YMD",nonStandardAdoptedOutGraphic:!1,propagateFatherLastName:!1,lineStyle:"regular"}}};this.onPreferencesAvailable(defaultResponse),callWhenReady()},onPreferencesAvailable:function(response){response.responseJSON?(Helpers.setByTemplate(this.preferences,response.responseJSON),console.log("Loaded preferences: "+stringifyObject(response.responseJSON))):console.log("Failed to loaded properties, no JSON")},getConfigurationOption:function(optionName){return this.preferences.pedigree.hasOwnProperty(optionName)?this.preferences.pedigree[optionName]:this.preferences.user.hasOwnProperty(optionName)?this.preferences.user[optionName]:this.preferences.global.hasOwnProperty(optionName)?this.preferences.global[optionName]:null},setConfigurationOption:function(domain,optionName,value){if("user"==domain)this.preferences.user[optionName]=value;else{if("pedigree"!=domain)throw"Unsupported options domain: "+domain;this.preferences.pedigree[optionName]=value}}}),ProbandDataLoader=Class.create({initialize:function(){this.probandData={}},load:function(callWhenReady){var probandID=XWiki.currentDocument.page,patientJsonURL=new XWiki.Document("ExportPatient","PhenoTips").getURL("get","id="+probandID);patientJsonURL+="&rand="+Math.random(),new Ajax.Request(patientJsonURL,{method:"GET",onSuccess:this.onProbandDataReady.bind(this),onComplete:callWhenReady||{}})},onProbandDataReady:function(response){response.responseJSON?this.probandData=response.responseJSON:console.log("[!] Error parsing patient JSON"),console.log("Proband data: "+Helpers.stringifyObject(this.probandData))}}),SaveLoadEngine=Class.create({initialize:function(){this._saveInProgress=!1},serialize:function(){var jsonObject=editor.getGraph().toJSONObject();return jsonObject.settings=editor.getView().getSettings(),JSON.stringify(jsonObject)},createGraphFromSerializedData:function(JSONString,noUndo,centerAround0){console.log("---- load: parsing data ----"),document.fire("pedigree:load:start");try{var jsonObject=JSON.parse(JSONString),changeSet=editor.getGraph().fromJSONObject(jsonObject);editor._unRenderedLegend.removeAllNodes();var unRenderedNodes=changeSet.unRendered;editor._unRenderedLegend.addAllNodes(unRenderedNodes),editor.getWorkspace().clearMenuText(),jsonObject.hasOwnProperty("settings")&&editor.getView().loadSettings(jsonObject.settings)}catch(err){return console.log("ERROR loading the graph: "+err),alert("Error loading the graph"),document.fire("pedigree:graph:clear"),void document.fire("pedigree:load:finish")}if(!noUndo){var probandJSONObject=editor.getProbandDataFromPhenotips();editor.getGraph().setProbandData(probandJSONObject)||alert("Proband gender defined in Phenotips is incompatible with this pedigree. Setting proband gender to 'Unknown'"),JSONString=this.serialize()}editor.getView().applyChanges(changeSet,!1)&&editor.getWorkspace().adjustSizeToScreen(),centerAround0&&editor.getWorkspace().centerAroundNode(0),noUndo||editor.isReadOnlyMode()||editor.getUndoRedoManager().addState(null,null,JSONString),document.fire("pedigree:load:finish")},createGraphFromImportData:function(importString,importType,importOptions,noUndo,centerAround0){console.log("---- import: parsing data ----"),document.fire("pedigree:load:start");try{var changeSet=editor.getGraph().fromImport(importString,importType,importOptions);editor._unRenderedLegend.removeAllNodes();var unRenderedNodes=changeSet.unRendered;if(this.swapNgisPatientIdPropertyforUnrenderedNodes(unRenderedNodes),editor._unRenderedLegend.addAllNodes(unRenderedNodes),editor.getWorkspace().clearMenuText(),null==changeSet)throw"Unable to create a pedigree from imported data"}catch(err){return console.error(err),alert("Error importing pedigree: "+err),void document.fire("pedigree:load:finish")}if(!noUndo){var probandJSONObject=editor.getProbandDataFromPhenotips();editor.getGraph().setProbandData(probandJSONObject)||alert("Proband gender defined in Phenotips is incompatible with the imported pedigree. Setting proband gender to 'Unknown'"),JSONString=this.serialize()}editor.getView().applyChanges(changeSet,!1)&&editor.getWorkspace().adjustSizeToScreen(),centerAround0&&editor.getWorkspace().centerAroundNode(0),noUndo||editor.isReadOnlyMode()||editor.getUndoRedoManager().addState(null,null,JSONString),setTimeout(function(){editor.getWorkspace().centerAroundNode(0)},1e3),document.fire("pedigree:load:finish")},reset:function(callback){},save:function(callback,callback2){if(!this._saveInProgress){editor.getView().unmarkAll();var exportString=PedigreeExport.exportAsSimpleJSON(editor.getGraph().DG,"all"),_this=this,jsonData=this.serialize();console.log("[SAVE] data: "+Helpers.stringifyObject(jsonData));var svgText=editor.getWorkspace().getSVGCopy(!1).getSVGText(),savingNotification=new XWiki.widgets.Notification("Saving","inprogress"),urlParams=(new WebService,new URLSearchParams(window.location.search));$ESAPI.encoder().encodeForHTML(urlParams.get("testRequestId")),urlParams.get("userToken");var postBodyObject={};postBodyObject.pedigree=JSON.parse(exportString),postBodyObject.pedigree.forEach(function(elem){null!=elem.hpoTermsFullDetails&&elem.hpoTermsFullDetails.forEach(function(hpoFullDetail){null!=hpoFullDetail.valueAll&&null!=hpoFullDetail.valueAll.hpoModifiers&&0<hpoFullDetail.valueAll.hpoModifiers.size()&&(hpoFullDetail.hpoModifiers=hpoFullDetail.valueAll.hpoModifiers)})}),postBodyObject.svgDiagram=svgText,postBodyObject.testRequestId=$ESAPI.encoder().encodeForHTML(PedigreeEditorTool.testRequestId),postBodyObject.clinicalIndicationName=document.getElementById("canvas-clinical-indication-name").innerHTML.split("Clinical Indication Name: ")[1],new Ajax.Request(CONSTANTS.PEDIGREE_SERVICE_URL+"/api/v1.0/pedigree-tool",{method:"POST",headers:{Authorization:PedigreeEditorTool.accessToken},requestHeaders:{Accept:"*",Authorization:PedigreeEditorTool.accessToken},contentType:"application/json",postBody:JSON.stringify(postBodyObject),onCreate:function(){_this._saveInProgress=!0;var closeButton=$("action-close"),saveButton=$("action-save"),saveAndExitButton=$("action-saveAndExit");Element.addClassName(saveButton,"disabled-menu-item"),Element.removeClassName(saveButton,"menu-item"),Element.addClassName(saveButton,"no-mouse-interaction"),Element.addClassName(closeButton,"disabled-menu-item"),Element.removeClassName(closeButton,"menu-item"),Element.addClassName(closeButton,"no-mouse-interaction"),Element.addClassName(saveAndExitButton,"disabled-menu-item"),Element.removeClassName(saveAndExitButton,"menu-item"),Element.addClassName(saveAndExitButton,"no-mouse-interaction"),null!=closeButton&&null!=closeButton&&Helpers.disableMouseclicks(closeButton),null!=saveButton&&null!=saveButton&&Helpers.disableMouseclicks(saveButton),null!=saveAndExitButton&&null!=saveAndExitButton&&Helpers.disableMouseclicks(saveAndExitButton)},onComplete:function(response){_this._saveInProgress=!1;var actionAfterSave=editor.getAfterSaveAction();actionAfterSave&&actionAfterSave();var closeButton=$("action-close"),saveButton=$("action-save"),saveAndExitButton=$("action-saveAndExit");Element.addClassName(saveButton,"menu-item"),Element.removeClassName(saveButton,"disabled-menu-item"),Element.removeClassName(saveButton,"no-mouse-interaction"),Element.addClassName(closeButton,"menu-item"),Element.removeClassName(closeButton,"disabled-menu-item"),Element.removeClassName(closeButton,"no-mouse-interaction"),Element.addClassName(saveAndExitButton,"menu-item"),Element.removeClassName(saveAndExitButton,"disabled-menu-item"),Element.removeClassName(saveAndExitButton,"no-mouse-interaction"),null!=closeButton&&null!=closeButton&&Helpers.enableMouseclicks(closeButton),null!=saveButton&&null!=saveButton&&Helpers.enableMouseclicks(saveButton),null!=saveAndExitButton&&null!=saveAndExitButton&&Helpers.enableMouseclicks(saveAndExitButton)},on401:function(response){PedigreeEditorTool.accessRefreshFunction()},on0:function(response){_this.handleSaveFail(_this,savingNotification);var message="-- Connection Error --";message+="<br><br><pre>"+response.request.url.replace(/\?.+/,""),message+="</pre><br>Please report this to the ",message+=_this.constructHelpdeskDetails()+"<br>--------<br>",_this.showSaveError(message),callback2&&callback2(!1)},onFailure:function(response){_this.handleSaveFail(_this,savingNotification);var message=_this.constructErrorMessage(response.responseJSON,response.statusText);_this.showSaveError(message),callback2&&callback2(!1)},onSuccess:function(response){if(_this._saveInProgress=!1,editor.getUndoRedoManager().addSaveEvent(),savingNotification.replace(new XWiki.widgets.Notification("Successfully saved")),window.pedigreeStatus.reset(),"openclinica"===(new Settings).getSetting("diagramEndpoint").service){var isAdminEdit=(new WebService).getUrlParameter("adminEdit",!0);if(isAdminEdit&&null!=isAdminEdit&&"true"==isAdminEdit){editor.getOkCancelDialogue().showCustomized("Your data will be saved for later but not resubmitted to Genomics England. <br>When you are ready, please resubmit the Pedigree CRF.","Genomics England","Close",function(){this.dialog.show(),callback&&callback()},null,null,null,null,!0)}else callback&&callback()}else callback&&callback();callback2&&callback2(!0)}})}},load:function(probandDataObj){console.log("initiating load process");new WebService;var testRequestId,accessToken,state,userToken="",_this=this,urlParams=new URLSearchParams(window.location.search),redirectParams=new URLSearchParams(window.location.hash);if(userToken=urlParams.get("userToken"),accessToken=redirectParams.get("#id_token"),state=redirectParams.get("state"),testRequestId=null!==urlParams.get("testRequestId")?$ESAPI.encoder().encodeForHTML(urlParams.get("testRequestId")):"NoTestRequestId"!==state?state:null,null===userToken&&null!==accessToken&&(userToken=accessToken),null===userToken&&"true"===CONSTANTS.AUTH_ENABLED){var existingTestRequestId=null!==testRequestId?$ESAPI.encoder().encodeForHTML(testRequestId):"NoTestRequestId",authPath=CONSTANTS.AUTHORIZE_URL+"client_id="+encodeURI(CONSTANTS.CLIENT_ID)+"&redirect_uri="+encodeURI(CONSTANTS.REDIRECT_URL)+"&scope=openid&response_type=id_token&response_mode=fragment&nonce=424242&state="+existingTestRequestId;console.log("GET AUTHORIZE Endpoint: "+authPath),null===state?window.location=authPath:console.log("ERROR - No token received from authentication server.")}else if(null===PedigreeEditorTool.testRequestId){_this.showLoadError("No Test Request ID specified")}else{console.log("we back");var ieCachBuster=(new Date).getTime().toString(),path=CONSTANTS.PEDIGREE_SERVICE_URL+"/api/v1.0/pedigree-tool/"+PedigreeEditorTool.testRequestId+"?cb="+ieCachBuster;window.CONSTANTS.pedigreeLoading=!0,new Ajax.Request(path,{method:"GET",headers:{Authorization:PedigreeEditorTool.accessToken},requestHeaders:{Accept:"*",Authorization:PedigreeEditorTool.accessToken},contentType:"application/x-www-form-urlencoded",onCreate:function(response){document.fire("pedigree:load:start"),window.CONSTANTS.pedigreeLoading=!0},on401:function(response){window.CONSTANTS.pedigreeLoading=!1;_this.showLoadError("Invalid User Token"),PedigreeEditorTool.accessRefreshFunction()},on0:function(response){window.CONSTANTS.pedigreeLoading=!1;var message="-- Connection Error --";message+="<br><br><pre>"+response.request.url.replace(/\?.+/,""),message+="</pre><br>Please report this to the ",message+=_this.constructHelpdeskDetails()+"<br>--------<br>",_this.showLoadError(message)},onFailure:function(response){window.CONSTANTS.pedigreeLoading=!1;_this.constructErrorMessage(response.responseJSON,response.statusText);_this.showLoadError("No information for Test Request ID: "+PedigreeEditorTool.testRequestId)},onSuccess:function(response){if(window.CONSTANTS.pedigreeLoading){window.CONSTANTS.pedigreeLoading=!1;probandDataObj.probandData={};var pedigreeJSON=response.responseJSON.pedigree;for(i=0;i<pedigreeJSON.length;i++)null==pedigreeJSON[i].comments&&(pedigreeJSON[i].comments=" ");var jsonContentString=JSON.stringify(pedigreeJSON),event={clinicalIndicationName:response.responseJSON.clinicalIndicationName,clinicalIndicationCode:response.responseJSON.clinicalIndicationCode};document.fire("pedigree:update:clinicalIndicationName",event);var testRequestId=response.responseJSON.testRequestId,clinicalIndicationName=response.responseJSON.clinicalIndicationName;document.getElementById("canvas-test-request-simple-id").innerHTML="Test Request ID: "+$ESAPI.encoder().encodeForHTML(testRequestId),document.getElementById("canvas-clinical-indication-name").innerHTML="Clinical Indication Name: "+$ESAPI.encoder().encodeForHTML(clinicalIndicationName),this.createGraphFromImportData(jsonContentString,"simpleJSON",{acceptUnknownPhenotypes:!0,externalIdMark:!0,markEvaluated:!1},!1,!0),window.pedigreeStatus.reset(),setTimeout(function(){response.responseJSON.testRequestSimpleId?document.fire("pedigree:update:topMenu",{testRequestId:response.responseJSON.testRequestSimpleId}):document.fire("pedigree:update:topMenu",{testRequestId:testRequestId})},200)}}.bind(this)})}},handleSaveFail:function(_this,savingNotification){_this._saveInProgress=!1,editor.getUndoRedoManager().addSaveEvent(),savingNotification.replace(new XWiki.widgets.Notification("Save unsuccessful"))},showLoadError:function(reason){this.showLoadErrorWithReason("",reason)},showUnauthorisedLoadError:function(reason){this.showLoadErrorWithReason("!! User is not allowed to load pedigree model !!",reason)},showLoadErrorWithReason:function(message,reason){var fullMessage=message+"<br><br>"+reason;editor.getOkCancelDialogue().showCustomized(fullMessage,"Pedigree Editor",null,null,null,null,null,null,!0)},showSaveError:function(reason){this.showSaveErrorWithReason("!! Failed to save pedigree model !!",reason)},showUnauthorisedSaveError:function(reason){this.showSaveErrorWithReason("!! User is not allowed to save pedigree model !!",reason)},showSaveErrorWithReason:function(message,reason){var fullMessage=message+"<br><br>"+reason;editor.getOkCancelDialogue().showCustomized(fullMessage,"Error","Close",function(){},null,null,null,null,!0)},constructErrorMessage:function(json,status){var message="-- "+status;return json?json.errorCode||json.type?message=this.constructMercuryErrorMessage(json,message):json.message&&(message+=" :: "+json.message+" --"):message+=" :: Unknown cause --",message+"<br>--------<br>"},constructMercuryErrorMessage:function(json,message){return json.message?(message+=" --<br><br>:: ",json.errorCode&&!json.message.startsWith(json.errorCode)&&(message+=json.errorCode+" - "),message+=json.message+" ::<br>",json.exception?message+=this.constructExceptionSection(json.exception):json.type&&(message+=this.constructExceptionSection(json)),json.validationErrors&&(message+=this.constructJsonRenderSection(json.validationErrors,"Please find the validation errors below"))):json.type?(message+=" :: "+json.type,message+=this.constructExceptionSection(json)):message+=" :: Unknown Reason --",message},constructExceptionSection:function(exception){return renderJson={exception:{type:exception.type,message:exception.message}},exception.stacktrace&&(renderJson.exception.stacktrace=exception.stacktrace),this.constructJsonRenderSection(renderJson,"Please copy the below and provide to the "+this.constructHelpdeskDetails())},constructJsonRenderSection:function(renderJson,title){var message="<br>--------<br>"+title+"<br><br>";return message+='<pre style="text-align: left;">',message+=JSON.stringify(renderJson,null,2),message+="</pre>"},constructHelpdeskDetails:function(){var contact="Help Desk",config=(new Settings).getSetting("helpdesk");return config&&(contact=config.name,contact+="<br>",contact+=config.contact.phone+" :: "+config.contact.email),contact},swapNgisPatientIdPropertyforUnrenderedNodes:function(nodes){if(null!=nodes&&null!=nodes)for(var i=0;i<nodes.length;i++){var currentNode=nodes[i],currentNgisRegisteredPatientUid=currentNode.ngisRegisteredPatientUid,currentNgisRegisteredPatientSimpleId=currentNode.ngisRegisteredPatientSimpleId;currentNode.ngisRegisteredPatientUid=currentNgisRegisteredPatientSimpleId,currentNode.ngisRegisteredPatientSimpleId=currentNgisRegisteredPatientUid}}});VersionUpdater=Class.create({initialize:function(){this.availableUpdates=[{comment:"group node comment representation",introduced:"May2014",func:"updateGroupNodeComments"},{comment:"adopted status",introduced:"Nov2014",func:"updateAdoptedStatus"},{comment:"id desanitation",introduced:"Mar2015",func:"updateId"}]},updateToCurrentVersion:function(pedigreeJSON){for(var i=0;i<this.availableUpdates.length;i++){var update=this.availableUpdates[i],updateResult=this[update.func](pedigreeJSON);null!==updateResult&&(console.log("[update #"+i+"] [updating to "+update.introduced+" version] - performing "+update.comment+" update"),pedigreeJSON=updateResult)}return pedigreeJSON},updateGroupNodeComments:function(pedigreeJSON){for(var change=!1,data=JSON.parse(pedigreeJSON),i=0;i<data.GG.length;i++){var node=data.GG[i];node.hasOwnProperty("prop")&&node.prop.hasOwnProperty("numPersons")&&!node.prop.hasOwnProperty("comments")&&node.prop.hasOwnProperty("fName")&&""!=node.prop.hasOwnProperty("fName")&&(node.prop.comments=node.prop.fName,delete node.prop.fName,change=!0)}return change?JSON.stringify(data):null},updateAdoptedStatus:function(pedigreeJSON){for(var change=!1,data=JSON.parse(pedigreeJSON),i=0;i<data.GG.length;i++){var node=data.GG[i];node.hasOwnProperty("prop")&&node.prop.hasOwnProperty("isAdopted")&&(node.prop.isAdopted&&(node.prop.adoptedStatus="adoptedIn"),delete node.prop.isAdopted,change=!0)}return change?JSON.stringify(data):null},updateId:function(pedigreeJSON){for(var change=!1,data=JSON.parse(pedigreeJSON),i=0;i<data.GG.length;i++){var node=data.GG[i];if(node.hasOwnProperty("prop")){if(node.prop.hasOwnProperty("disorders"))for(var j=0;j<node.prop.disorders.length;j++)node.prop.disorders[j]=desanitizeId(node.prop.disorders[j]),change=!0;if(node.prop.hasOwnProperty("hpoTerms"))for(j=0;j<node.prop.hpoTerms.length;j++)node.prop.hpoTerms[j]=desanitizeId(node.prop.hpoTerms[j]),change=!0;if(node.prop.hasOwnProperty("candidateGenes"))for(j=0;j<node.prop.candidateGenes.length;j++)node.prop.candidateGenes[j]=desanitizeId(node.prop.candidateGenes[j]),change=!0}}return change?JSON.stringify(data):null;function desanitizeId(id){var temp=id.replace(/__/g," ");return(temp=(temp=temp.replace(/_C_/g,":")).replace(/_L_/g,"(")).replace(/_J_/g,")")}}});var LineSet=Class.create({initialize:function(){this._lineCrossings={},this._lines=[]},replaceIDs:function(changedIdsSet){var newLineCrossings={};for(var oldOwnerID in this._lineCrossings)if(this._lineCrossings.hasOwnProperty(oldOwnerID)){var crosses=this._lineCrossings[oldOwnerID],newCrosses={};for(var oldID in crosses)if(crosses.hasOwnProperty(oldID)){newCrosses[newID=changedIdsSet.hasOwnProperty(oldID)?changedIdsSet[oldID]:oldID]=!0}newLineCrossings[changedIdsSet.hasOwnProperty(oldOwnerID)?changedIdsSet[oldOwnerID]:oldOwnerID]=newCrosses}this._lineCrossings=newLineCrossings;for(var i=0;i<this._lines.length;i++){oldID=this._lines[i].owner;var newID=changedIdsSet.hasOwnProperty(oldID)?changedIdsSet[oldID]:oldID;this._lines[i].owner=newID}},addLine:function(owner,x1,y1,x2,y2){this._lineCrossings.hasOwnProperty(owner)||(this._lineCrossings[owner]={});for(var bendPoints=[],thisLine={owner:owner,x1:x1,y1:y1,x2:x2,y2:y2},i=0;i<this._lines.length;i++){var line=this._lines[i];if(line.owner!=owner){var crossingPoint=this._getLineCrossing(thisLine,line);crossingPoint&&(this._lineCrossings[line.owner][owner]=!0,bendPoints.push(crossingPoint))}}return this._lines.push(thisLine),bendPoints},removeAllLinesByOwner:function(owner){if(!this._lineCrossings.hasOwnProperty(owner))return{};for(var i=this._lines.length-1;0<=i;i--){this._lines[i].owner==owner&&this._lines.splice(i,1)}var affectedOwners=this._lineCrossings[owner];for(var ownerID in delete this._lineCrossings[owner],this._lineCrossings)if(this._lineCrossings.hasOwnProperty(ownerID)){var crosses=this._lineCrossings[ownerID];crosses.hasOwnProperty(owner)&&delete crosses[owner]}return affectedOwners},removeAllLinesAffectedByOwnerMovement:function(owner){var returnNewAffected=[],processed={};processed[owner]=!0;for(var affected=[owner];0<affected.length;){var next=affected.pop(),newAffected=this.removeAllLinesByOwner(next);for(var o in newAffected)newAffected.hasOwnProperty(o)&&(processed.hasOwnProperty(o)||(affected.push(parseInt(o)),returnNewAffected.push(parseInt(o)),processed[o]=!0))}return returnNewAffected},_getLineCrossing:function(line1,line2){var a=line1.x2-line1.x1,b=line2.x1-line2.x2,c=line1.y2-line1.y1,d=line2.y1-line2.y2,e=line2.x1-line1.x1,f=line2.y1-line1.y1,denom=a*d-b*c;if(Math.abs(denom)<=.001)return null;var t=(e*d-b*f)/denom,s=(a*f-e*c)/denom;return t<=0||1<=t||s<=0||1<=s?0:{x:line1.x1+t*(line1.x2-line1.x1),y:line1.y1+t*(line1.y2-line1.y1)}}}),ChildlessBehavior={getChildlessStatus:function(){return this._childlessStatus},isValidChildlessStatus:function(status){return"Infertile"==status||"Childless"==status},getChildlessReason:function(){return this._childlessReason},setChildlessReason:function(reason){null==this.getChildlessStatus()&&(reson=""),this._childlessReason=reason,this.getGraphics().updateChildlessStatusLabel()}},ChildlessBehaviorVisuals={getChildlessShape:function(){return this._childlessShape},getChildlessStatusLabel:function(){return this._childlessStatusLabel},updateChildlessShapes:function(){var status=this.getNode().getChildlessStatus();if(this._childlessShape&&this._childlessShape.remove(),status){var x=this.getX(),y=this.getY(),r=PedigreeEditorParameters.attributes.infertileMarkerWidth,lowY=this.getBottomY()+PedigreeEditorParameters.attributes.infertileMarkerHeight,childlessPath=[["M",x,y],["L",x,lowY],["M",x-r,lowY],["l",2*r,0]];"Infertile"==status&&childlessPath.push(["M",x-r,lowY+5],["l",2*r,0]),this._childlessShape=editor.getPaper().path(childlessPath),"Childless"==status&&this.getChildlessShapeAttr?this._childlessShape.attr(this.getChildlessShapeAttr()):this._childlessShape.attr(PedigreeEditorParameters.attributes.childlessShapeAttr),this._childlessShape.toBack()}},updateChildlessStatusLabel:function(){this._childlessStatusLabel&&this._childlessStatusLabel.remove(),this._childlessStatusLabel=null;var text="";this.getNode().getChildlessReason()&&(text+=this.getNode().getChildlessReason()),""!=text.strip()&&(this._childlessStatusLabel=editor.getPaper().text(this.getX(),this.getBottomY()+18,"("+text.slice(0,15)+")"),this._childlessStatusLabel.attr({"font-size":18,"font-family":"Cambria"}),this._childlessStatusLabel.toBack()),this.drawLabels()}},PartnershipVisuals=Class.create(AbstractNodeVisuals,{initialize:function($super,partnership,x,y){$super(partnership,x,y),this._childlessShape=null,this._childlessStatusLabel=null,this._junctionShape=editor.getPaper().circle(x,y,PedigreeEditorParameters.attributes.partnershipRadius).attr(PedigreeEditorParameters.attributes.partnershipNode),this._junctionShape.node.setAttribute("class","pedigree-partnership-circle"),editor.isReadOnlyMode()?this._hoverBox=new ReadOnlyHoverbox(partnership,x,y,this.getShapes()):this._hoverBox=new PartnershipHoverbox(partnership,x,y,this.getShapes()),this.updateIDLabel(),this._childhubConnection=null,this._partnerConnections=null,this.updatePartnerConnections(),this.updateChildhubConnection()},updateIDLabel:function(){if(editor.DEBUG_MODE){var x=this.getX(),y=this.getY();this._idLabel&&this._idLabel.remove(),this._idLabel=editor.getPaper().text(x,y-20,this.getNode().getID()).attr(PedigreeEditorParameters.attributes.dragMeLabel).insertAfter(this._junctionShape.flatten())}},onSetID:function($super,id){$super(id),this.updateIDLabel()},grow:function(){this.area||(this.area=this.getJunctionShape().clone().flatten().insertBefore(this.getJunctionShape().flatten()),this.area.attr({fill:"green",stroke:"none"}),this.area.ot=this.area.transform(),this.area.attr({transform:"...S2"}))},shrink:function(){this.area&&this.area.remove(),delete this.area},markPregnancy:function(){this.mark||(this.mark=this.getJunctionShape().glow({width:10,fill:!0,opacity:.3,color:"blue"}).insertBefore(this.getJunctionShape().flatten()))},unmarkPregnancy:function(){this.mark&&this.mark.remove(),delete this.mark},markPermanently:function(){this.mark2||(this.mark2=this.getJunctionShape().glow({width:18,fill:!0,opacity:.4,color:"#ee8d00"}).insertBefore(this.getJunctionShape().flatten()))},unmark:function(){this.mark2&&this.mark2.remove(),delete this.mark2},getJunctionShape:function(){return this._junctionShape},getBottomY:function(){return this._absoluteY+PedigreeEditorParameters.attributes.partnershipRadius+PedigreeEditorParameters.attributes.parnershipChildlessLength},_isDisplayedAsConsanguinous:function(){var consangr=editor.getGraph().isConsangrRelationship(this.getNode().getID()),nodeConsangrPreference=this.getNode().getConsanguinity();return"N"==nodeConsangrPreference&&(consangr=!1),"Y"==nodeConsangrPreference&&(consangr=!0),consangr},updatePartnerConnections:function(){this._partnerConnections&&this._partnerConnections.remove(),editor.getPaper().setStart();for(var id=this.getNode().getID(),consangr=this._isDisplayedAsConsanguinous(),lineAttr=consangr?PedigreeEditorParameters.attributes.consangrPartnershipLines:PedigreeEditorParameters.attributes.partnershipLines,lineAttrNoContact=consangr?PedigreeEditorParameters.attributes.noContactLinesConsangr:PedigreeEditorParameters.attributes.noContactLines,partnerPaths=editor.getGraph().getPathToParents(id),cornerRadius=PedigreeEditorParameters.attributes.curvedLinesCornerRadius,p=0;p<partnerPaths.length;p++){for(var path=partnerPaths[p],person=path[path.length-1],finalSegmentInfo=editor.getGraph().getRelationshipLineInfo(id,person),nodePos=editor.getGraph().getPosition(person),finalPosition=editor.convertGraphCoordToCanvasCoord(nodePos.x,nodePos.y),finalYTo=editor.convertGraphCoordToCanvasCoord(0,finalSegmentInfo.attachY).y,yTop=editor.convertGraphCoordToCanvasCoord(0,finalSegmentInfo.verticalY).y,lastBend=finalYTo==yTop&&yTop<this.getY()&&1==finalSegmentInfo.attachmentPort?1/0:1<finalSegmentInfo.numAttachPorts?PedigreeEditorParameters.attributes.radius*(1.8+.1*finalSegmentInfo.numAttachPorts-.35*finalSegmentInfo.attachmentPort):1.6*PedigreeEditorParameters.attributes.radius,goesLeft=!1,xFrom=this.getX(),yFrom=this.getY(),xTo=xFrom,yTo=yFrom,prevY=yFrom,prevX=xFrom,vertical=!1,wasAngle=!1,firstDraw=!0,i=0;i<path.length;i++){var nextNodeOnPath=path[i],position=(nodePos=editor.getGraph().getPosition(nextNodeOnPath),editor.convertGraphCoordToCanvasCoord(nodePos.x,nodePos.y));if(editor.DEBUG_MODE)editor.getPaper().text(position.x,position.y,nextNodeOnPath).attr(PedigreeEditorParameters.attributes.dragMeLabel).toFront().node.setAttribute("class","no-mouse-interaction");position.x<xFrom?goesLeft=!0:position.x>xFrom&&(goesLeft=!1);var newVertical=prevY!=position.y,angled=prevX!=position.x&&prevY!=position.y,changesDirection=vertical&&!newVertical||!vertical&&newVertical||angled;i==path.length-1&&prevY==yTop&&(changesDirection=xFrom!=xTo||yFrom!=yTo,newVertical=angled=!1),0==i&&goesLeft&&this.getNode().getBrokenStatus()&&(editor.getView().drawLineWithCrossings(id,xFrom,yFrom,xFrom-16,yFrom,lineAttr,consangr,goesLeft,!1,firstDraw),editor.getPaper().path("M "+(xFrom-29)+" "+(yFrom+9)+" L "+(xFrom-15)+" "+(yFrom-9)).attr(lineAttr).toBack(),editor.getPaper().path("M "+(xFrom-24)+" "+(yFrom+9)+" L "+(xFrom-10)+" "+(yFrom-9)).attr(lineAttr).toBack(),xFrom-=23,firstDraw=!1),changesDirection&&(editor.getView().drawLineWithCrossings(id,xFrom,yFrom,xTo,yTo,lineAttr,consangr,goesLeft,!1,firstDraw),xFrom=xTo,yFrom=yTo,firstDraw=!1),xTo=position.x,yTo=i>=path.length-2?yTop:position.y,prevY=position.y,prevX=position.x,(!wasAngle&&!angled||i>=path.length-2&&1<path.length)&&(newVertical&&!vertical?(xTo<xFrom?(GraphicHelpers.drawCornerCurve(xFrom,yFrom,xFrom-cornerRadius,yFrom-cornerRadius,!0,lineAttr,consangr,2.5,-2.5,-2.5,2.5),xFrom-=cornerRadius):(GraphicHelpers.drawCornerCurve(xFrom,yFrom,xFrom+cornerRadius,yFrom-cornerRadius,!0,lineAttr,consangr,2.5,2.5,-2.5,-2.5),xFrom+=cornerRadius),yFrom-=cornerRadius):!newVertical&&vertical?(xTo<xFrom?(GraphicHelpers.drawCornerCurve(xFrom,yFrom,xFrom-cornerRadius,yFrom-cornerRadius,!1,lineAttr,consangr,-2.5,2.5,2.5,-2.5),xFrom-=cornerRadius):(GraphicHelpers.drawCornerCurve(xFrom,yFrom,xFrom+cornerRadius,yFrom-cornerRadius,!1,lineAttr,consangr,2.5,2.5,-2.5,-2.5),xFrom+=cornerRadius),yFrom-=cornerRadius):newVertical?yTo+=cornerRadius:i!=path.length-1&&(position.x>xFrom?xTo-=cornerRadius:xTo+=cornerRadius)),vertical=newVertical,wasAngle=angled}var thisLineAttr=!editor.getView().getNode(person).isProband()&&editor.getView().getNode(person).getLostContact()&&editor.getGraph().isPartnershipRelatedToProband(id)?lineAttrNoContact:lineAttr;yFrom>=finalPosition.y+2*cornerRadius?editor.getView().drawLineWithCrossings(id,xFrom,yFrom,xTo,finalYTo,thisLineAttr,consangr,!1,firstDraw):editor.getView().drawCurvedLineWithCrossings(id,xFrom,yFrom,yTop,xTo,finalYTo,lastBend,thisLineAttr,consangr,goesLeft,firstDraw)}this._partnerConnections=editor.getPaper().setFinish().toBack(),this.getNode().getGraphics()&&(this.getHoverBox().regenerateHandles(),this.getHoverBox().regenerateButtons())},updateChildhubConnection:function(){this._childhubConnection&&this._childhubConnection.remove();var twinCommonVerticalPieceLength=PedigreeEditorParameters.attributes.twinCommonVerticalLength,positionedGraph=editor.getGraph(),id=this.getNode().getID(),childlinePos=positionedGraph.getRelationshipChildhubPosition(id),childlineY=editor.convertGraphCoordToCanvasCoord(childlinePos.x,childlinePos.y).y,children=positionedGraph.getRelationshipChildrenSortedByOrder(id);if(1==children.length&&editor.getGraph().isPlaceholder(children[0]))return editor.getPaper().setStart(),void(this._childhubConnection=editor.getPaper().setFinish());editor.getPaper().setStart();for(var leftmostX=this.getX(),rightmostX=this.getX(),currentTwinGroup=null,currentTwinGroupCenterX=null,currentIsMonozygothic=!1,numPregnancies=0,allChildrenLostContact=!0,j=0;j<children.length;j++){var child=children[j];if(editor.getView().checkNodeExists(child)){var twinGroupId=positionedGraph.getTwinGroupId(child);if(twinGroupId!=currentTwinGroup){numPregnancies++,currentTwinGroup=twinGroupId;var allTwins=positionedGraph.getAllTwinsSortedByOrder(child),positionL=editor.getView().getNode(allTwins[0]).getX(),positionR=editor.getView().getNode(allTwins[allTwins.length-1]).getX(),positionY=editor.getView().getNode(allTwins[0]).getY();if(currentTwinGroupCenterX=(positionL+positionR)/2,3==allTwins.length&&(currentTwinGroupCenterX=editor.getView().getNode(allTwins[1]).getX()),editor.getView().drawLineWithCrossings(id,currentTwinGroupCenterX,childlineY,currentTwinGroupCenterX,childlineY+twinCommonVerticalPieceLength,PedigreeEditorParameters.attributes.partnershipLines),currentIsMonozygothic=editor.getView().getNode(allTwins[0]).getMonozygotic()){var twinlineY=childlineY+PedigreeEditorParameters.attributes.twinMonozygothicLineShiftY,xIntercept1=GraphicHelpers.findXInterceptGivenLineAndY(twinlineY,currentTwinGroupCenterX,childlineY+twinCommonVerticalPieceLength,positionL,positionY),xIntercept2=GraphicHelpers.findXInterceptGivenLineAndY(twinlineY,currentTwinGroupCenterX,childlineY+twinCommonVerticalPieceLength,positionR,positionY);editor.getView().drawLineWithCrossings(id,xIntercept1,twinlineY,xIntercept2,twinlineY,PedigreeEditorParameters.attributes.partnershipLines)}}else null==twinGroupId&&(numPregnancies++,currentIsMonozygothic=!1);var childX=editor.getView().getNode(child).getX(),childY=editor.getView().getNode(child).getY(),topLineX=null===currentTwinGroup?childX:currentTwinGroupCenterX,topLineY=null===currentTwinGroup?childlineY:childlineY+twinCommonVerticalPieceLength;rightmostX<topLineX&&(rightmostX=topLineX),topLineX<leftmostX&&(leftmostX=topLineX);var lostContact=(editor.getGraph().isChildOfProband(child)||editor.getGraph().isSiblingOfProband(child))&&editor.getView().getNode(child).getLostContact();lostContact||(allChildrenLostContact=!1);var lineAttr=lostContact?PedigreeEditorParameters.attributes.noContactLines:PedigreeEditorParameters.attributes.partnershipLines;if(editor.getGraph().isAdoptedIn(child)&&(lineAttr=lostContact?PedigreeEditorParameters.attributes.noContactAdoptedIn:PedigreeEditorParameters.attributes.partnershipLinesAdoptedIn),currentIsMonozygothic&&childX!=positionL&&childX!=positionR){var xIntercept=GraphicHelpers.findXInterceptGivenLineAndY(twinlineY,currentTwinGroupCenterX,childlineY+twinCommonVerticalPieceLength,childX,childY);editor.getView().drawLineWithCrossings(id,xIntercept,twinlineY,childX,childY,lineAttr)}else editor.getView().drawLineWithCrossings(id,topLineX,topLineY,childX,childY,lineAttr)}}lineAttr=allChildrenLostContact?PedigreeEditorParameters.attributes.noContactLines:PedigreeEditorParameters.attributes.partnershipLines;editor.getView().drawLineWithCrossings(id,leftmostX,childlineY,rightmostX,childlineY,lineAttr);var fromY=this._isDisplayedAsConsanguinous()?this.getY()+2:this.getY();if(editor.getView().drawLineWithCrossings(id,this.getX(),fromY,this.getX(),childlineY,lineAttr),editor.DEBUG_MODE){var childhubID=positionedGraph.DG.GG.getOutEdges(id)[0];editor.getPaper().text(this.getX(),childlineY,childhubID).attr(PedigreeEditorParameters.attributes.dragMeLabel).toFront().node.setAttribute("class","no-mouse-interaction")}1<numPregnancies&&editor.getPaper().circle(this.getX(),childlineY,PedigreeEditorParameters.attributes.partnershipRadius/2).attr({fill:"#666666",stroke:"#888888","stroke-width":1,opacity:1}),this._childhubConnection=editor.getPaper().setFinish()},setPos:function($super,x,y,animate,callback){if(this.getHoverBox().removeHandles(),this.getHoverBox().removeButtons(),animate)throw"Can't animate a partnership node";this.mark&&this.mark.remove(),this.mark2&&this.mark2.remove(),this.getAllGraphics().transform("t "+(x-this.getX())+","+(y-this.getY())+"..."),$super(x,y,animate,callback),this.updatePartnerConnections(),this.updateChildhubConnection(),this.updateChildlessStatusLabel()},remove:function(){this.getJunctionShape().remove(),this.getHoverBox().remove(),this._idLabel&&this._idLabel.remove(),this.getChildlessShape()&&this.getChildlessShape().remove(),this.getChildlessStatusLabel()&&this.getChildlessStatusLabel().remove(),this._childhubConnection&&this._childhubConnection.remove(),this._partnerConnections&&this._partnerConnections.remove(),this.area&&this.area.remove(),this.mark&&this.mark.remove(),this.mark2&&this.mark2.remove()},getShapes:function($super){return $super().push(this.getJunctionShape())},getAllGraphics:function($super){return editor.getPaper().set(this.getHoverBox().getBackElements(),this._idLabel,this._childlessShape).concat($super()).push(this.getHoverBox().getFrontElements())},drawLabels:function(){},getChildlessShapeAttr:function(){return PedigreeEditorParameters.attributes.partnershipChildlessShapeAttr}});PartnershipVisuals.addMethods(ChildlessBehaviorVisuals);var Partnership=Class.create(AbstractNode,{initialize:function($super,x,y,id,properties){this._childlessStatus=null,this._childlessReason="",this._type="Partnership",this._broken=!1,this._consangrMode="N",this.setBrokenStatus(properties.broken),this.setConsanguinity(properties.consangr),$super(x,y,id),this.assignProperties(properties)},_generateGraphics:function(x,y){return new PartnershipVisuals(this,x,y)},setChildlessStatus:function(status){return this.isValidChildlessStatus(status)||(status=null),status!=this.getChildlessStatus()&&(this._childlessStatus=status,this.setChildlessReason(null),this.getGraphics().updateChildlessShapes(),this.getGraphics().updateChildhubConnection(),this.getGraphics().getHoverBox().regenerateHandles()),this.getChildlessStatus()},setConsanguinity:function(value){"A"!=value&&"N"!=value&&"Y"!=value&&"P"!=value&&"U"!=value&&(value="A"),this._consangrMode!=value&&(this._consangrMode=value),this.getGraphics()&&this.getGraphics().getHoverBox().regenerateButtons()},getConsanguinity:function(){return this._consangrMode},setBrokenStatus:function(value){void 0===value&&(value=!1),this._broken!=value&&(this._broken=value)},getBrokenStatus:function(){return this._broken},getSummary:function(){var childlessTextInactive=!1,childlessInactive=[];return editor.getGraph().hasNonPlaceholderNonAdoptedChildren(this.getID())?childlessTextInactive=childlessInactive=!0:editor.getGraph().hasNoNonPlaceholderChildren(this.getID())&&(childlessInactive=["none"]),{identifier:{value:this.getID()},childlessSelect:{value:this.getChildlessStatus()?this.getChildlessStatus():"None",inactive:childlessInactive},childlessText:{value:this.getChildlessReason()?this.getChildlessReason():"None",inactive:childlessTextInactive},consangr:{value:this._consangrMode,inactive:!1},broken:{value:this.getBrokenStatus(),inactive:!1}}},getProperties:function($super){var info=$super();return null!=this.getChildlessStatus()&&(info.childlessStatus=this.getChildlessStatus(),info.childlessReason=this.getChildlessReason()),"A"!=this.getConsanguinity()&&(info.consangr=this.getConsanguinity()),this.getBrokenStatus()&&(info.broken=this.getBrokenStatus()),info},assignProperties:function($super,info){return!!$super(info)&&(info.childlessStatus&&info.childlessStatus!=this.getChildlessStatus()&&this.setChildlessStatus(info.childlessStatus),info.childlessReason&&info.childlessReason!=this.getChildlessReason()&&this.setChildlessReason(info.childlessReason),info.consangr&&info.consangr!=this.getConsanguinity()&&this.setConsanguinity(info.consangr),info.broken&&info.broken!=this.getBrokenStatus()&&this.setBrokenStatus(info.broken),!0)}});Partnership.addMethods(ChildlessBehavior);var AbstractPersonVisuals=Class.create(AbstractNodeVisuals,{initialize:function($super,node,x,y){$super(node,x,y),this._radius=PedigreeEditorParameters.attributes.radius,this._width=4*PedigreeEditorParameters.attributes.radius,this._highlightBox=null,this._adoptedShape=null,this._genderShape=null,this._genderGraphics=null,this._numberLabel=null,this.setGenderGraphics(),this.setHighlightBox(),this.updateIDLabel(),this._hoverBox=this.generateHoverbox(x,y)},updateIDLabel:function(){if(editor.DEBUG_MODE){var x=this.getX(),y=this.getY();this._idLabel&&this._idLabel.remove(),this._idLabel=editor.getPaper().text(x,y,this.getNode().getID()).attr(PedigreeEditorParameters.attributes.dragMeLabel).toFront(),this._idLabel.node.setAttribute("class","no-mouse-interaction")}},updateNumberLabel:function(){if(this._numberLabel&&this._numberLabel.remove(),""!=this.getNode().getPedNumber()){var x=this.getX(),y=this.getY();this._numberLabel=editor.getPaper().text(x,y,this.getNode().getPedNumber()).attr(PedigreeEditorParameters.attributes.pedNumberLabel).toFront(),this._numberLabel.node.setAttribute("class","no-mouse-interaction")}},generateHoverbox:function(x,y){return null},onSetID:function($super,id){$super(id),this.updateIDLabel()},setPos:function($super,x,y,animate,callback){this.getHoverBox().removeHandles(),this.getHoverBox().removeButtons();var moveX=x-this.getX(),moveY=y-this.getY();if(0!=moveX||0!=moveY)if($super(x,y,animate),animate){var me=this;this._callback=function(){me._toMark&&(me.markPermanently(),delete me._toMark),delete me._callback,callback&&callback()},this.getAllGraphics().animate({transform:"t "+moveX+","+moveY+"..."},900,"linear",me._callback)}else this.getAllGraphics().transform("t "+moveX+","+moveY+"..."),callback&&callback()},grow:function($super){if($super(),this._callback)throw"Assertion failed: grow() during animation";this.glow||(this.glow=this._genderShape.glow({width:11,fill:!0,opacity:.4,color:"green"}),this.marked&&this.marked.hide())},shrink:function($super){this.glow&&this.glow.remove(),delete this.glow,this.marked&&this.marked.show(),$super()},markPermanently:function(){!this._callback||this._toMark?this.marked||(this.marked=this._genderShape.glow({width:11,fill:!0,opacity:.6,color:"#ee8d00"})):this._toMark=!0},unmark:function(){this.marked&&this.marked.remove(),delete this.marked},containsXY:function(x,y){return Math.abs(x-this.getX())<=PedigreeEditorParameters.attributes.personHoverBoxRadius&&Math.abs(y-this.getY())<=PedigreeEditorParameters.attributes.personHoverBoxRadius},getBottomY:function(){return this._absoluteY+this._radius+PedigreeEditorParameters.attributes.childlessLength},drawAdoptedShape:function(){if(this._adoptedShape&&this._adoptedShape.remove(),""!=this.getNode().getAdopted()){var r=PedigreeEditorParameters.attributes.radius,y=this.getY()-1.3*r+2;if("adoptedOut"==this.getNode().getAdopted()&&editor.getPreferencesManager().getConfigurationOption("nonStandardAdoptedOutGraphic"))var x1=this.getX()-1.7*r,x2=this.getX()+1.7*r,coeff=2.5;else x1=this.getX()-.9*r,x2=this.getX()+.9*r,coeff=-2.5;brackets="M"+x1+" "+y+"l"+r/coeff+" 0l0 "+(2.6*r-4)+"l"+r/-coeff+" 0M"+x2+" "+y+"l"+r/-coeff+" 0l0 "+(2.6*r-4)+"l"+r/coeff+" 0",this._adoptedShape=editor.getPaper().path(brackets).attr("stroke-width",2.5),this._adoptedShape.toBack()}},getAdoptedShape:function(){return this._adoptedShape},getShapes:function($super){var shapes=$super().push(this.getGenderGraphics());return this.getAdoptedShape()&&shapes.push(this.getAdoptedShape()),shapes},getAllGraphics:function($super){return editor.getPaper().set(this.getHighlightBox(),this._idLabel,this._numberLabel).concat($super())},getGenderGraphics:function(){return this._genderGraphics},getGenderShape:function(){return this._genderShape},setGenderGraphics:function(){this.unmark(),this._genderGraphics&&this._genderGraphics.remove();var shape,gender=this.getNode().getGender();this._shapeRadius="U"==gender||"O"==gender?1.1*PedigreeEditorParameters.attributes.radius/Math.sqrt(2):PedigreeEditorParameters.attributes.radius,this.getNode().isPersonGroup()&&(this._shapeRadius*=PedigreeEditorParameters.attributes.groupNodesScale);var x=this.getX(),y=this.getY(),radius=this._shapeRadius;if(shape="F"==gender?editor.getPaper().circle(x,y,radius):editor.getPaper().rect(x-radius,y-radius,2*radius,2*radius),"U"==gender?(shape.attr(PedigreeEditorParameters.attributes.nodeShapeDiag),shape.attr({transform:"...R45"})):"O"==gender?(shape.attr(PedigreeEditorParameters.attributes.nodeShapeOther),shape.attr({transform:"...R45"})):"M"==gender?shape.attr(PedigreeEditorParameters.attributes.nodeShapeMale):"F"==gender&&shape.attr(PedigreeEditorParameters.attributes.nodeShapeFemale),this._genderShape=shape,!editor.isUnsupportedBrowser()&&editor.getPreferencesManager().getConfigurationOption("drawNodeShadows")){var shadow=this.makeNodeShadow(shape);this._genderGraphics=editor.getPaper().set(shadow,shape)}else this._genderGraphics=editor.getPaper().set(shape)},makeNodeShadow:function(shape){var shadow=shape.clone().attr({stroke:"none",fill:"gray",opacity:.3});return shadow.translate(3,3),shadow.insertBefore(shape),shadow.node.setAttribute("class","pedigree-node-shadow"),shadow},setHighlightBox:function(){this._highlightBox&&this._highlightBox.remove();var radius=PedigreeEditorParameters.attributes.personHoverBoxRadius;this._highlightBox=editor.getPaper().rect(this.getX()-radius,this.getY()-radius,2*radius,2*radius,5).attr(PedigreeEditorParameters.attributes.boxOnHover),this._highlightBox.attr({fill:"black",opacity:0,"fill-opacity":0}),this._highlightBox.insertBefore(this.getGenderGraphics().flatten())},getHighlightBox:function(){return this._highlightBox},highlight:function(){this.getHighlightBox()&&this.getHighlightBox().attr({opacity:.5,"fill-opacity":.5})},unHighlight:function(){this.getHighlightBox().attr({opacity:0,"fill-opacity":0})},remove:function($super){this.marked&&this.marked.remove(),$super()}}),PersonVisuals=Class.create(AbstractPersonVisuals,{initialize:function($super,node,x,y){$super(node,x,y),this._nameLabel=null,this._stillBirthLabel=null,this._ageLabel=null,this._externalIDLabel=null,this._participatingInTestLabel=null,this._commentsLabel=null,this._cancerAgeOfOnsetLabels={},this._childlessStatusLabel=null,this._disorderShapes=null,this._deadShape=null,this._unbornShape=null,this._childlessShape=null,this._isSelected=!1,this._carrierGraphic=null,this._evalLabel=null},generateHoverbox:function(x,y){return editor.isReadOnlyMode()?new ReadOnlyHoverbox(this.getNode(),x,y,this.getGenderGraphics()):new PersonHoverbox(this.getNode(),x,y,this.getGenderGraphics())},updateAgeLabelForGELDirectly:function(text){this.getAgeLabel()&&this.getAgeLabel().remove(),this._ageLabel=text?editor.getPaper().text(this.getX(),this.getY(),text).attr(PedigreeEditorParameters.attributes.label):null,this._ageLabel&&(this._ageLabel.node.setAttribute("class","field-no-user-select"),text&&0<text.indexOf("\n")&&(this._ageLabel.alignTop=!0)),this.drawLabels()},setGenderGraphics:function($super){if("Aborted"==this.getNode().getLifeStatus()||"Miscarriage"==this.getNode().getLifeStatus()){this._genderGraphics&&this._genderGraphics.remove();var radius=PedigreeEditorParameters.attributes.radius;this.getNode().isPersonGroup()&&(radius*=PedigreeEditorParameters.attributes.groupNodesScale);var height=(this._shapeRadius=radius)*Math.sqrt(3.5)/Math.sqrt(2),x=this.getX()-height,y=this.getY(),shape=editor.getPaper().path(["M",x,y,"l",height,-height,"l",height,height,"z"]);if(shape.attr(PedigreeEditorParameters.attributes.nodeShapeAborted),this._genderShape=shape,editor.getPreferencesManager().getConfigurationOption("drawNodeShadows")){var shadow=this.makeNodeShadow(shape);shape=editor.getPaper().set(shadow,shape)}else shape=editor.getPaper().set(shape);this.getNode().isProband()&&(shape.transform(["...s",1.07]),shape.attr("stroke-width",5));var gender=this.getNode().getGender();if("U"==gender||"O"==gender)this._genderGraphics=shape;else{x=this.getX(),y=this.getY()+radius/1.4;var text="M"==gender?"Male":"Female",genderLabel=editor.getPaper().text(x,y,text).attr(PedigreeEditorParameters.attributes.label);this._genderGraphics=editor.getPaper().set(shape,genderLabel)}}else $super();this.getNode().isProband()&&(this._genderGraphics.push(this.generateProbandArrow()),this.getGenderShape().transform(["...s",1.08]),this.getGenderShape().attr("stroke-width",5.5)),!editor.isUnsupportedBrowser()&&this.getHoverBox()&&this._genderGraphics.flatten().insertBefore(this.getFrontElements().flatten()),this.updateDisorderShapes(),this.updateCarrierGraphic(),this.updateEvaluationLabel(),this.updateParticipatingInTestLabel(),"Unborn"==this.getNode().getLifeStatus()&&this.updateLifeStatusShapes("Unborn")},generateProbandArrow:function(){var icon=editor.getPaper().path(editor.getView().__probandArrowPath).attr({fill:"#595959",stroke:"none",opacity:1}),x=this.getX()-this._shapeRadius-26,y=this.getY()+this._shapeRadius-12;return"F"==this.getNode().getGender()&&(x+=5,y-=5),icon.transform(["t",x,y]),icon},generateIsParticipatingInTestArrow:function(){var icon=editor.getPaper().path(editor.getView().__participatingInTest).attr({fill:"#595959",stroke:"none",opacity:1}),x=this.getX()-this._shapeRadius-20,y=this.getY()+this._shapeRadius-12;return"F"==this.getNode().getGender()&&(x+=12,y-=12),icon.transform(["t",x,y]),icon},getBackElements:function(){return this.getHoverBox().getBackElements().concat(editor.getPaper().set(this.getChildlessStatusLabel(),this.getChildlessShape()))},getFrontElements:function(){return this.getHoverBox().getFrontElements()},updateParticipatingInTestLabel:function(){if(this._participatingInTestLabel&&this._participatingInTestLabel.remove(),this.getNode().getParticipatingInTest()){this._participatingInTestLabel=editor.getPaper().text(this.getX()-PedigreeEditorParameters.attributes.radius-13,this.getY(),"T").attr(PedigreeEditorParameters.attributes.participatingInTestAttr)}else this._participatingInTestLabel=null;this.drawLabels()},getParticipatingInTestLabel:function(){return this._participatingInTestLabel},updateExternalIDLabel:function(){this._externalIDLabel&&this._externalIDLabel.remove();var number=this.getNode().getNHSNumber(),text="\r\n ";number&&(text+="[nhs:"+number+"] \r\n"),this.getNode().getNgisRegisteredPatientUid()?text+="NGIS Patient ID : "+this.getNode().getNgisRegisteredPatientUid()+"\r\n":this.getNode().getNonNgisPatientStableUid()&&(text+="Non NGIS Patient ID : "+this.getNode().getNonNgisPatientStableUid()+"\r\n"),this._externalIDLabel=editor.getPaper().text(this.getX(),this.getY()+PedigreeEditorParameters.attributes.radius,text).attr(PedigreeEditorParameters.attributes.externalIDLabels),this.drawLabels()},getExternalIDLabel:function(){return this._externalIDLabel},updateNameLabel:function(){this._nameLabel&&this._nameLabel.remove();var disabledFields=editor.getPreferencesManager().getConfigurationOption("disabledFields"),text="";this.getNode().getFirstName()&&!Helpers.arrayContains(disabledFields,"first_name")&&(text=this.getNode().getFirstName());var lastNameAtBirth=this.getNode().getLastNameAtBirth()&&!Helpers.arrayContains(disabledFields,"last_name_birth")?this.getNode().getLastNameAtBirth():"";this.getNode().getLastName()&&!Helpers.arrayContains(disabledFields,"last_name")&&(text+=" "+this.getNode().getLastName(),lastNameAtBirth=lastNameAtBirth==this.getNode().getLastName()||""===lastNameAtBirth?"":"("+lastNameAtBirth+")"),text+=" "+lastNameAtBirth,text=Helpers.toTitleCase(text);text=Helpers.wrapString(text,20),text=Helpers.wrapStringNonBreak(text,20),this._nameLabel&&this._nameLabel.remove(),""!=text.strip()?(this._nameLabel=editor.getPaper().text(this.getX(),this.getY()+PedigreeEditorParameters.attributes.radius,text).attr(PedigreeEditorParameters.attributes.nameLabels),this._nameLabel.node.setAttribute("class","field-no-user-select")):this._nameLabel=null,this.drawLabels()},getNameLabel:function(){return this._nameLabel},getDisorderShapes:function(){return this._disorderShapes},updateDisorderShapes:function(){this._disorderShapes&&this._disorderShapes.remove();var colors=this.getNode().getAllNodeColors();this.getNode().getCarrierStatus();if(0!=colors.length){var delta,color,disorderShapes=editor.getPaper().set();if("Aborted"==this.getNode().getLifeStatus()||"Miscarriage"==this.getNode().getLifeStatus()){var radius=PedigreeEditorParameters.attributes.radius;this.getNode().isPersonGroup()&&(radius*=PedigreeEditorParameters.attributes.groupNodesScale);var height=radius*Math.sqrt(3.5)/Math.sqrt(2),x1=this.getX()-height,y1=this.getY();delta=2*height/colors.length;for(var k=0;k<colors.length;k++){var corner=[],x2=x1+delta,y2=this.getY()-(height-Math.abs(x2-this.getX()));x1<this.getX()&&x2>=this.getX()&&(corner=["L",this.getX(),this.getY()-height]);var slice=editor.getPaper().path(["M",x1,y1,corner,"L",x2,y2,"L",this.getX(),this.getY(),"z"]);color=colors[k],disorderShapes.push(slice.attr({fill:color,"stroke-width":.5,stroke:"none"})),x1=x2,y1=y2}this.getNode().isProband()&&disorderShapes.transform(["...s",1.04,1.04,this.getX(),this.getY()-this._shapeRadius])}else{var disorderAngle=360/colors.length;delta=360/colors.length/2,1!=colors.length||"U"!=this.getNode().getGender()&&"O"!=this.getNode().getGender()||(delta-=45);radius=this._shapeRadius-.6;"U"!=this.getNode().getGender()&&"O"!=this.getNode().getGender()||(radius*=1.155);for(var i=0;i<colors.length;i++)color=colors[i],disorderShapes.push(GraphicHelpers.sector(editor.getPaper(),this.getX(),this.getY(),radius,this.getNode().getGender(),i*disorderAngle,(i+1)*disorderAngle,color));disorderShapes.length<2?disorderShapes.attr("stroke","none"):disorderShapes.attr({stroke:"#595959","stroke-width":.03}),this.getNode().isProband()&&disorderShapes.transform(["...s",1.04,1.04,this.getX(),this.getY()])}this._disorderShapes=disorderShapes,this._disorderShapes.flatten().insertAfter(this.getGenderGraphics().flatten())}},drawDeadShape:function(){var strokeWidth=editor.getWorkspace().getSizeNormalizedToDefaultZoom(2.5);if("Aborted"==this.getNode().getLifeStatus()){var height=PedigreeEditorParameters.attributes.radius*Math.sqrt(3.5)/Math.sqrt(2);this.getNode().isPersonGroup()&&(height*=PedigreeEditorParameters.attributes.groupNodesScale);var x=this.getX()-height/1.5;this.getNode().isPersonGroup()&&(x-=PedigreeEditorParameters.attributes.radius/4);var y=this.getY()+height/3;this._deadShape=editor.getPaper().path(["M",x,y,"l",height+height/3,-(height+height/3),"z"]),this._deadShape.attr("stroke-width",strokeWidth)}else{x=this.getX(),y=this.getY();var coeff=1.25*(this.getNode().isPersonGroup()?PedigreeEditorParameters.attributes.groupNodesScale:1),x1=x-coeff*PedigreeEditorParameters.attributes.radius,y1=y+coeff*PedigreeEditorParameters.attributes.radius,x2=x+coeff*PedigreeEditorParameters.attributes.radius,y2=y-coeff*PedigreeEditorParameters.attributes.radius;this._deadShape=editor.getPaper().path(["M",x1,y1,"L",x2,y2]).attr("stroke-width",strokeWidth)}editor.isUnsupportedBrowser()||(this._deadShape.toFront(),this._deadShape.node.setAttribute("class","no-mouse-interaction"))},getDeadShape:function(){return this._deadShape},getAgeLabel:function(){return this._ageLabel},updateAgeLabel:function(){var text,person=this.getNode();if(person.isFetus())person.getGestationAgeDays(),person.getGestationAgeWeeks();else{var birthDate=person.getBirthDate(),deathDate=person.getDeathDate(),dateFormat=editor.getPreferencesManager().getConfigurationOption("dateDisplayFormat");if("DMY"==dateFormat||"MY"==dateFormat)if("Alive"==person.getLifeStatus()){if(birthDate&&birthDate.isComplete()&&(text="b. "+person.getBirthDate().getBestPrecisionStringDDMMYYY(dateFormat),null!==person.getBirthDate().getYear()))var age=AgeCalc.getAge(person.getBirthDate())}else if(deathDate&&birthDate&&deathDate.isComplete()&&birthDate.isComplete()){if(text=person.getBirthDate().getBestPrecisionStringDDMMYYY(dateFormat)+" - "+person.getDeathDate().getBestPrecisionStringDDMMYYY(dateFormat),null!==person.getBirthDate().getYear()&&null!==person.getDeathDate().getYear())age=AgeCalc.getAge(person.getBirthDate(),person.getDeathDate())}else deathDate&&deathDate.isComplete()||birthDate&&birthDate.isComplete();else if("Alive"==person.getLifeStatus()){if(birthDate)if(birthDate.onlyDecadeAvailable());else{age=AgeCalc.getAge(birthDate,null);null==birthDate.getMonth()||(null==birthDate.getDay()||"MMY"==dateFormat?birthDate.getYear():-1!=age.indexOf("day")||age.indexOf("wk"))}}else if(deathDate&&birthDate){age=AgeCalc.getAge(birthDate,deathDate);(null==deathDate.getYear()||null==deathDate.getMonth()||-1==age.indexOf("day")&&-1==age.indexOf("wk")&&-1==age.indexOf("mo"))&&(text=birthDate.getBestPrecisionStringYear()+" - "+deathDate.getBestPrecisionStringYear())}}this.getAgeLabel()&&this.getAgeLabel().remove(),this._ageLabel=text?editor.getPaper().text(this.getX(),this.getY(),text).attr(PedigreeEditorParameters.attributes.label):null,this._ageLabel&&(this._ageLabel.node.setAttribute("class","field-no-user-select"),text&&0<text.indexOf("\n")&&(this._ageLabel.alignTop=!0)),this.drawLabels()},getUnbornShape:function(){return this._unbornShape},drawUnbornShape:function(){this._unbornShape&&this._unbornShape.remove(),"Unborn"==this.getNode().getLifeStatus()?(this._unbornShape=editor.getPaper().text(this.getX(),this.getY(),"P").attr(PedigreeEditorParameters.attributes.unbornShape),editor.isUnsupportedBrowser()||this._unbornShape.insertBefore(this.getHoverBox().getFrontElements())):this._unbornShape=null},updateEvaluationLabel:function(){if(this._evalLabel&&this._evalLabel.remove(),this.getNode().getEvaluated()){if("Aborted"==this.getNode().getLifeStatus()||"Miscarriage"==this.getNode().getLifeStatus())var x=this.getX()+1.6*this._shapeRadius,y=this.getY()+.6*this._shapeRadius;else{var mult=1.1;"U"==this.getNode().getGender()?mult=1.3:"M"==this.getNode().getGender()&&(mult=1.4),this.getNode().isProband&&(mult*=1.1);x=this.getX()+this._shapeRadius*mult-5,y=this.getY()+this._shapeRadius*mult}this._evalLabel=editor.getPaper().text(x,y,"*").attr(PedigreeEditorParameters.attributes.evaluationShape).toBack()}else this._evalLabel=null},getEvaluationGraphics:function(){return this._evalLabel},updateCarrierGraphic:function(){this._carrierGraphic&&this._carrierGraphic.remove();var status=this.getNode().getCarrierStatus();if(""!=status&&"Unaffected"!=status&&"Affected"!=status){if("Carrier"==status){if("Aborted"==this.getNode().getLifeStatus()||"Miscarriage"==this.getNode().getLifeStatus())var x=this.getX(),y=this.getY()-this._radius/2;else x=this.getX(),y=this.getY();this._carrierGraphic=editor.getPaper().circle(x,y,PedigreeEditorParameters.attributes.carrierDotRadius).attr(PedigreeEditorParameters.attributes.carrierShape)}else if("Uncertain"==status||"Unknown"==status){if("Aborted"==this.getNode().getLifeStatus()||"Miscarriage"==this.getNode().getLifeStatus()){x=this.getX(),y=this.getY()-this._radius/2;var fontAttr=PedigreeEditorParameters.attributes.uncertainSmallShape}else x=this.getX(),y=this.getY(),fontAttr=PedigreeEditorParameters.attributes.uncertainShape;this._carrierGraphic=editor.getPaper().text(x,y,"?").attr(fontAttr)}else if("Presymptomatic"==status){if("Aborted"==this.getNode().getLifeStatus()||"Miscarriage"==this.getNode().getLifeStatus())return void(this._carrierGraphic=null);editor.getPaper().setStart();var startX=this.getX()-PedigreeEditorParameters.attributes.presymptomaticShapeWidth/2,startY=this.getY()-this._radius;if(editor.getPaper().rect(startX,startY,PedigreeEditorParameters.attributes.presymptomaticShapeWidth,2*this._radius).attr(PedigreeEditorParameters.attributes.presymptomaticShape),"U"==this.getNode().getGender()){editor.getPaper().path("M "+startX+" "+startY+"L "+this.getX()+" "+(this.getY()-1.1*this._radius)+"L "+(startX+PedigreeEditorParameters.attributes.presymptomaticShapeWidth)+" "+startY+"Z").attr(PedigreeEditorParameters.attributes.presymptomaticShape);var endY=this.getY()+this._radius;editor.getPaper().path("M "+startX+" "+endY+"L "+this.getX()+" "+(this.getY()+1.1*this._radius)+"L "+(startX+PedigreeEditorParameters.attributes.presymptomaticShapeWidth)+" "+endY+"Z").attr(PedigreeEditorParameters.attributes.presymptomaticShape)}this._carrierGraphic=editor.getPaper().setFinish()}editor.isReadOnlyMode()?this._carrierGraphic.toFront():this._carrierGraphic.insertBefore(this.getHoverBox().getFrontElements())}else this._carrierGraphic=null;this.updateDisorderShapes()},getCarrierGraphics:function(){return this._carrierGraphic},getSBLabel:function(){return this._stillBirthLabel},updateSBLabel:function(){this.getSBLabel()&&this.getSBLabel().remove(),"Stillborn"==this.getNode().getLifeStatus()?this._stillBirthLabel=editor.getPaper().text(this.getX(),this.getY(),"SB").attr(PedigreeEditorParameters.attributes.label):this._stillBirthLabel=null,this.drawLabels()},getCommentsLabel:function(){return this._commentsLabel},updateCommentsLabel:function(){if(this.getCommentsLabel()&&this.getCommentsLabel().remove(),""!=this.getNode().getComments()){var text=this.getNode().getComments().replace(/^\s+|\s+$/g,"").replace(/\n\n/gi,"\n \n");this._commentsLabel=editor.getPaper().text(this.getX(),this.getY(),text).attr(PedigreeEditorParameters.attributes.commentLabel),this._commentsLabel.node.setAttribute("class","field-no-user-select"),this._commentsLabel.alignTop=!0,this._commentsLabel.addGap=!0}else this._commentsLabel=null;this.drawLabels()},getCancerAgeOfOnsetLabels:function(){return this._cancerAgeOfOnsetLabels},updateCancerAgeOfOnsetLabels:function(){var cancerLabels=this.getCancerAgeOfOnsetLabels();if(!Helpers.isObjectEmpty(cancerLabels))for(var cancerName in cancerLabels)cancerLabels[cancerName].remove();var cancerData=this.getNode().getCancers();if(!Helpers.isObjectEmpty(cancerData)&&editor.getPreferencesManager().getConfigurationOption("displayCancerLabels")){for(var cancerName in cancerData)if(cancerData.hasOwnProperty(cancerName)&&cancerData[cancerName].affected){var text=cancerName.toString()+" ca.";if(cancerData[cancerName].hasOwnProperty("ageAtDiagnosis")&&0<cancerData[cancerName].ageAtDiagnosis.length){var age=cancerData[cancerName].ageAtDiagnosis;isNaN(parseInt(age))?text+="before_1"==age?" dx <1":"before_10"==age?" dx <10":-1<age.indexOf("before_")?" dx "+(parseInt(age.substring(7))-10)+"'s":" dx >100":text+=" dx "+cancerData[cancerName].ageAtDiagnosis}else text+=" dx ?";this.getCancerAgeOfOnsetLabels()[cancerName]&&this.getCancerAgeOfOnsetLabels()[cancerName].remove(),this._cancerAgeOfOnsetLabels[cancerName]=editor.getPaper().text(this.getX(),this.getY(),text).attr(PedigreeEditorParameters.attributes.cancerAgeOfOnsetLabels),this._cancerAgeOfOnsetLabels[cancerName].node.setAttribute("class","field-no-user-select"),this._cancerAgeOfOnsetLabels[cancerName].alignTop=!0,this._cancerAgeOfOnsetLabels[cancerName].addGap=!0}}else this._cancerAgeOfOnsetLabels={};this.drawLabels()},updateLifeStatusShapes:function(oldStatus){var status=this.getNode().getLifeStatus();this.getDeadShape()&&this.getDeadShape().remove(),this.getUnbornShape()&&this.getUnbornShape().remove(),this.getSBLabel()&&this.getSBLabel().remove(),("Aborted"==oldStatus||"Miscarriage"==oldStatus)!=("Aborted"==status||"Miscarriage"==status)&&this.setGenderGraphics(),"Deceased"==status||"Aborted"==status?this.drawDeadShape():"Stillborn"==status?(this.drawDeadShape(),this.updateSBLabel()):"Unborn"==status&&this.drawUnbornShape(),this.updateAgeLabel()},setSelected:function($super,isSelected){$super(isSelected),isSelected?this.shiftLabels():this.unshiftLabels()},shiftLabels:function(){for(var shift=this._labelSelectionOffset(),labels=this.getLabels(),i=0;i<labels.length;i++)labels[i].stop().animate({y:labels[i].oy+shift},200,">")},unshiftLabels:function(){for(var labels=this.getLabels(),i=(this._childlessStatusLabel,0);i<labels.length;i++)labels[i].stop().animate({y:labels[i].oy},200,">")},getLabels:function(){var labels=editor.getPaper().set();this.getSBLabel()&&labels.push(this.getSBLabel()),this._anonimized?(this.getNameLabel()&&this.getNameLabel().hide(),this.getAgeLabel()&&this.getAgeLabel().hide()):(this.getNameLabel()&&(this.getNameLabel().show(),labels.push(this.getNameLabel())),this.getAgeLabel()&&(this.getAgeLabel().show(),labels.push(this.getAgeLabel()))),this.getExternalIDLabel()&&labels.push(this.getExternalIDLabel()),this.getCommentsLabel()&&labels.push(this.getCommentsLabel());var cancerLabels=this.getCancerAgeOfOnsetLabels();if(!Helpers.isObjectEmpty(cancerLabels))for(var cancerName in cancerLabels)labels.push(cancerLabels[cancerName]);return labels},setAnonimizedStatus:function($super,status){$super(status),this.drawLabels()},drawLabels:function(){var labels=this.getLabels(),selectionOffset=this._labelSelectionOffset(),childlessOffset=this.getChildlessStatusLabel()?PedigreeEditorParameters.attributes.label["font-size"]:0;childlessOffset+=null!==this.getNode().getChildlessStatus()?PedigreeEditorParameters.attributes.infertileMarkerHeight+2:0;for(var lowerBound=PedigreeEditorParameters.attributes.radius*(this.getNode().isPersonGroup()?PedigreeEditorParameters.attributes.groupNodesScale:1),startY=this.getY()+1.8*lowerBound+selectionOffset+childlessOffset,i=0;i<labels.length;i++){var shift=labels[i].addGap&&0!=i?4:8,offset=labels[i].alignTop?GraphicHelpers.getElementHalfHeight(labels[i])-shift:0;labels[i].transform(""),labels[i].attr("x",this.getX()),labels[i].attr("y",startY+offset),labels[i].oy=labels[i].attr("y")-selectionOffset,labels[i].toBack(),i!=labels.length-1&&(startY=labels[i].getBBox().y2+11)}},_labelSelectionOffset:function(){var selectionOffset=this.isSelected()?PedigreeEditorParameters.attributes.radius/1.4:0;return this.isSelected()&&this.getNode().isPersonGroup()&&(selectionOffset+=PedigreeEditorParameters.attributes.radius*(1-PedigreeEditorParameters.attributes.groupNodesScale)+5),this.getChildlessStatusLabel()&&(selectionOffset/=2),selectionOffset},getShapes:function($super){var lifeStatusShapes=editor.getPaper().set();return this.getUnbornShape()&&lifeStatusShapes.push(this.getUnbornShape()),this.getChildlessShape()&&lifeStatusShapes.push(this.getChildlessShape()),this.getChildlessStatusLabel()&&lifeStatusShapes.push(this.getChildlessStatusLabel()),this.getDeadShape()&&lifeStatusShapes.push(this.getDeadShape()),$super().concat(editor.getPaper().set(this.getDisorderShapes(),lifeStatusShapes))},getAllGraphics:function($super){return $super().push(this.getHoverBox().getBackElements(),this.getLabels(),this.getCarrierGraphics(),this.getEvaluationGraphics(),this.getParticipatingInTestLabel(),this.getHoverBox().getFrontElements())},setPos:function($super,x,y,animate,callback){var funct=callback;if(animate){var me=this;this.getHoverBox().disable(),funct=function(){me.getHoverBox().enable(),callback&&callback()}}$super(x,y,animate,funct)}});PersonVisuals.addMethods(ChildlessBehaviorVisuals);var Person=Class.create(AbstractPerson,{initialize:function($super,x,y,id,properties){this._isProband=0==id,!this._type&&(this._type="Person"),this._setDefault(),$super(x,y,properties.hasOwnProperty("gender")?properties.gender:"U",id),properties.carrierStatus||(properties.carrierStatus="Unknown"),this.assignProperties(properties)},_setDefault:function(){this._phenotipsId="",Person.setMethods.sex="setGender",Person.setMethods.gender="setGender",this._firstName="",Person.setMethods.firstName="setFirstName",this._lastName="",Person.setMethods.lastName="setLastName",this._NHSNumber="",Person.setMethods.NHSNumber="setNHSNumber",this._gelSuperFamilyId="",Person.setMethods.gelSuperFamilyId="setGelSuperFamilyId",this._familyId="",Person.setMethods.familyId="setFamilyId",this._nonNgisPatientStableUid="",Person.setMethods.nonNgisPatientStableUid="setNonNgisPatientStableUid",this._ngisRegisteredPatientUid="",Person.setMethods.ngisRegisteredPatientUid="setNgisRegisteredPatientUid",this._consanguineousPopulation="",Person.setMethods.consanguineousPopulation="setConsanguineousPopulation",this._karyotypicSex="Unknown",Person.setMethods.karyotypicSex="setKaryotypicSex",this._ancestries="",Person.setMethods.ancestries="setAncestries",this._participantId="",Person.setMethods.participantId="setParticipantId",this._registered="",Person.setMethods.registered="setRegistered",this._lastNameAtBirth="",Person.setMethods.lastNameAtBirth="setLastNameAtBirth",this._birthDate=null,Person.setMethods.birthDate="setBirthDate",this._deathDate=null,Person.setMethods.deathDate="setDeathDate",this._ageOfDeath="",Person.setMethods.ageOfDeath="setAgeOfDeath",this._ageOfDeathFormat="y",Person.setMethods.ageOfDeathFormat="setAgeOfDeathFormat",this._conceptionDate="",this._adoptedStatus="",Person.setMethods.adoptedStatus="setAdoptedStatus",this._externalID="",Person.setMethods.externalID="setExternalID",this._lifeStatus="Alive",Person.setMethods.lifeStatus="setLifeStatus",this._childlessStatus=null,Person.setMethods.childlessStatus="setChildlessStatus",this._childlessReason="",Person.setMethods.childlessReason="setChildlessReason",this._carrierStatus="",Person.setMethods.carrierStatus="setCarrierStatus",this._disorders=[],Person.setMethods.disorders="setDisorders",this._disordersFullDetails=[],Person.setMethods.disordersFullDetails="setDisordersFullDetails",this._disorderType="",this._ageOfOnset="",this._hpoPresent="",this._familyId="",this._cancers=[],Person.setMethods.cancers="setCancers",this._hpo=[],Person.setMethods.hpoTerms="setHPO",this._hpoFullDetails=[],Person.setMethods.hpoTermsFullDetails="setHPOFullDetails",this._ethnicities=[],Person.setMethods.ethnicities="setEthnicities",this._candidateGenes=[],Person.setMethods.candidateGenes="setGenes",this._twinGroup=null,Person.setMethods.twinGroup="setTwinGroup",this._monozygotic=!1,Person.setMethods.monozygotic="setMonozygotic",this._evaluated=!1,Person.setMethods.evaluated="setEvaluated",this._pedNumber="",Person.setMethods.nodeNumber="setPedNumber",this._lostContact=!1,Person.setMethods.lostContact="setLostContact",this._ngisRegisteredPatientId=!1,Person.setMethods.ngisRegisteredPatientId="setNgisRegisteredPatientId",this._nonNgisStableId=!1,Person.setMethods.nonNgisStableId="setNonNgisStableId",this._otherIdentifier="",Person.setMethods.otherIdentifier="setOtherIdentifier",this._chiNumber="",Person.setMethods.chiNumber="setChiNumber",this._localIdentifier="",Person.setMethods.localIdentifier="setLocalIdentifier",this._organDonorId="",Person.setMethods.organDonorId="setOrganDonorId",this._otherIdentifierType="CHINumber",Person.setMethods.otherIdentifierType="setOtherIdentifierType",this._participatingInTest=!1,Person.setMethods.participatingInTest="setParticipatingInTest",this._gestationAgeDays="",Person.setMethods.gestationAgeDays="setGestationAgeDays",this._gestationAgeWeeks="",Person.setMethods.gestationAgeWeeks="setGestationAgeWeeks",this._estimatedDateOfDelivery=!1,Person.setMethods.estimatedDateOfDelivery="setEstimatedDateOfDelivery",this._comments="",Person.setMethods.comments="setComments",this._clinicalIndicationName="",Person.setMethods.clinicalIndicationName="setClinicalIndicationName",this._clinicalIndicationCode="",Person.setMethods.clinicalIndicationCode="setClinicalIndicationCode",this._clinicalIndicationAgeOfOnsetYears=0,Person.setMethods.clinicalIndicationAgeOfOnsetYears="setClinicalIndicationAgeOfOnsetYears",this._clinicalIndicationAgeOfOnsetMonths=0,Person.setMethods.clinicalIndicationAgeOfOnsetMonths="setClinicalIndicationAgeOfOnsetMonths",this._numberOfColorectalPolypsTotal="",Person.setMethods.numberOfColorectalPolypsTotal="setNumberOfColorectalPolypsTotal",this._numberOfColorectalPolypsAdenomas="",Person.setMethods.numberOfColorectalPolypsAdenomas="setNumberOfColorectalPolypsAdenomas",this._diagnosisCertainty="Suspected",Person.setMethods.diagnosisCertainty="setDiagnosisCertainty",this._lastMenstralPeriod="",Person.setMethods.lastMenstralPeriod="setLastMenstralPeriod"},_generateGraphics:function(x,y){return new PersonVisuals(this,x,y)},isProband:function(){return this._isProband},getPhenotipsPatientId:function(){return this._phenotipsId},setPhenotipsPatientId:function(phenotipsId){this._phenotipsId=phenotipsId},setNgisRegisteredPatientId:function(ngisRegisteredPatientId){this._ngisRegisteredPatientId=ngisRegisteredPatientId},getNgisRegisteredPatientId:function(){return this._ngisRegisteredPatientId},setNonNgisStableId:function(nonNgisStableId){this._nonNgisStableId=nonNgisStableId},getNonNgisStableId:function(){return this._nonNgisStableId},setOtherIdentifier:function(otherIdentifier){this._otherIdentifier=otherIdentifier},getOtherIdentifier:function(){return this._otherIdentifier},setOtherIdentifierType:function(otherIdentifierType){this._otherIdentifierType=otherIdentifierType},getOtherIdentifierType:function(){return this._otherIdentifierType},setParticipatingInTest:function(participatingInTest){this._participatingInTest=participatingInTest,this.getGraphics().updateParticipatingInTestLabel()},getParticipatingInTest:function(){return this._participatingInTest},setGestationAgeWeeks:function(gestationAgeWeeks){this._gestationAgeWeeks=gestationAgeWeeks},getGestationAgeWeeks:function(){return this._gestationAgeWeeks},setGestationAgeDays:function(gestationAgeDays){this._gestationAgeDays=gestationAgeDays},getGestationAgeDays:function(){return this._gestationAgeDays},setEstimatedDateOfDelivery:function(estimatedDateOfDelivery){this._estimatedDateOfDelivery=estimatedDateOfDelivery},getEstimatedDateOfDelivery:function(){return this._estimatedDateOfDelivery},setComments:function(comments){this._comments=comments},getComments:function(){return this._comments},setClinicalIndicationName:function(clinicalIndicationName){this._clinicalIndicationName=clinicalIndicationName},getClinicalIndicationName:function(){return this._clinicalIndicationName},setClinicalIndicationAgeOfOnsetYears:function(clinicalIndicationAgeOfOnsetYears){this._clinicalIndicationAgeOfOnsetMonths<0&&0<clinicalIndicationAgeOfOnsetYears&&(this._clinicalIndicationAgeOfOnsetMonths=0),this._clinicalIndicationAgeOfOnsetYears=clinicalIndicationAgeOfOnsetYears},getClinicalIndicationAgeOfOnsetYears:function(){return this._clinicalIndicationAgeOfOnsetYears},setClinicalIndicationAgeOfOnsetMonths:function(clinicalIndicationAgeOfOnsetMonths){clinicalIndicationAgeOfOnsetMonths<0&&0<this._clinicalIndicationAgeOfOnsetYears&&(this._clinicalIndicationAgeOfOnsetYears=0),this._clinicalIndicationAgeOfOnsetMonths=clinicalIndicationAgeOfOnsetMonths},getClinicalIndicationAgeOfOnsetMonths:function(){return this._clinicalIndicationAgeOfOnsetMonths},setClinicalIndicationCode:function(clinicalIndicaitonCode){if(this.isProband()){var event={clinicalIndicationCode:this._clinicalIndicationCode};document.fire("pedigree:update:clinicalIndicationName",event)}this._clinicalIndicationName=clinicalIndicaitonCode},getClinicalIndicationCode:function(){return this._clinicalIndicationCode},getFirstName:function(){return this._firstName},getNHSNumber:function(){return this._NHSNumber},getNgisRegisteredPatientUid:function(){return this._ngisRegisteredPatientUid},setNgisRegisteredPatientUid:function(ngisRegisteredPatientUid){this._ngisRegisteredPatientUid=ngisRegisteredPatientUid,this.getGraphics().updateExternalIDLabel()},getNonNgisPatientStableUid:function(){return this._nonNgisPatientStableUid},setNonNgisPatientStableUid:function(nonNgisPatientStableUid){this._nonNgisPatientStableUid=nonNgisPatientStableUid,this.getGraphics().updateExternalIDLabel()},getRegistered:function(){return this._registered},isRegistered:function(){return!(!this._registered||1!=this._registered)},getGelSuperFamilyId:function(){return this._gelSuperFamilyId},getFamilyId:function(){return this._familyId},getConsanguineousPopulation:function(){return this._consanguineousPopulation},getKaryotypicSex:function(){return this._karyotypicSex},getAncestries:function(){return this._ancestries},getChiNumber:function(){return this._chiNumber},getLocalIdentifier:function(){return this._localIdentifier},getOrganDonorId:function(){return this._organDonorId},getParticipantId:function(){return this._participantId},setFirstName:function(firstName){firstName&&(firstName=firstName.charAt(0).toUpperCase()+firstName.slice(1)),this._firstName=firstName,this.getGraphics().updateNameLabel()},setNHSNumber:function(NHSNumber){this._NHSNumber=NHSNumber,this.getGraphics().updateExternalIDLabel()},setRegistered:function(registered){this._registered=registered},setGelSuperFamilyId:function(gelSuperFamilyId){this._gelSuperFamilyId=gelSuperFamilyId},setFamilyId:function(familyId){this._familyId=familyId,this.isProband()},setConsanguineousPopulation:function(consanguineousPopulation){this._consanguineousPopulation=consanguineousPopulation},setKaryotypicSex:function(karyotypicSex){this._karyotypicSex=karyotypicSex},setAncestries:function(ancestries){this._ancestries=ancestries},setChiNumber:function(CHINumber){this._chiNumber=CHINumber},setLocalIdentifier:function(localIdentifier){this._localIdentifier=localIdentifier},setOrganDonorId:function(id){this._organDonorId=id},setParticipantId:function(participantId){this._participantId="",this.isProband(),this.getGraphics().updateExternalIDLabel()},getLastName:function(){return this._lastName},setLastName:function(lastName){return lastName&&(lastName=lastName.charAt(0).toUpperCase()+lastName.slice(1)),this._lastName=lastName,this.getGraphics().updateNameLabel(),lastName},getExternalID:function(){return this._externalID},setPedNumber:function(pedNumberString){this._pedNumber=pedNumberString,this.getGraphics().updateNumberLabel()},getPedNumber:function(){return this._pedNumber},setExternalID:function(externalID){this._externalID=externalID},getLastNameAtBirth:function(){return this._lastNameAtBirth},setLastNameAtBirth:function(lastNameAtBirth){return lastNameAtBirth&&(lastNameAtBirth=lastNameAtBirth.charAt(0).toUpperCase()+lastNameAtBirth.slice(1)),this._lastNameAtBirth=lastNameAtBirth,this.getGraphics().updateNameLabel(),lastNameAtBirth},setMonozygotic:function(monozygotic){monozygotic!=this._monozygotic&&(this._monozygotic=monozygotic)},getEvaluated:function(){return this._evaluated},setEvaluated:function(evaluationStatus){evaluationStatus!=this._evaluated&&(this._evaluated=evaluationStatus,this.getGraphics().updateEvaluationLabel())},getNumberOfColorectalPolypsTotal:function(){return this._numberOfColorectalPolypsTotal},setNumberOfColorectalPolypsTotal:function(numberOfColorectalPolypsTotal){this._numberOfColorectalPolypsTotal=numberOfColorectalPolypsTotal},getNumberOfColorectalPolypsAdenomas:function(){return this._numberOfColorectalPolypsAdenomas},setNumberOfColorectalPolypsAdenomas:function(numberOfColorectalPolypsAdenomas){this._numberOfColorectalPolypsAdenomas=numberOfColorectalPolypsAdenomas},getDiagnosisCertainty:function(){return this._diagnosisCertainty},setDiagnosisCertainty:function(diagnosisCertainty){this._diagnosisCertainty=diagnosisCertainty},getLostContact:function(){return this._lostContact},setAgeOfOnset:function(ageOfOnset){this._ageOfOnset=ageOfOnset},getAgeOfOnset:function(ageOfOnset){return this._ageOfOnset},setLostContact:function(lostContact){lostContact!=this._lostContact&&(this._lostContact=lostContact)},getMonozygotic:function(){return this._monozygotic},setTwinGroup:function(groupId){this._twinGroup=groupId},getLifeStatus:function(){return this._lifeStatus},isFetus:function(){return"Alive"!=this.getLifeStatus()&&"Deceased"!=this.getLifeStatus()},_isValidLifeStatus:function(status){return"Unborn"==status||"Stillborn"==status||"Aborted"==status||"Miscarriage"==status||"Alive"==status||"Deceased"==status},setLifeStatus:function(newStatus){if(this._isValidLifeStatus(newStatus)){var oldStatus=this._lifeStatus;"Deceased"!=(this._lifeStatus=newStatus)&&this.setDeathDate(""),"Alive"==newStatus&&this.setGestationAgeDays()&&this.setGestationAgeWeeks(),this.getGraphics().updateSBLabel(),this.isFetus()&&(this.setBirthDate(""),this.setAdopted(""),this.setChildlessStatus(null)),"Alive"==newStatus&&(this.setAgeOfDeath(""),this.setAgeOfDeathFormat("y")),this.getGraphics().updateLifeStatusShapes(oldStatus),this.getGraphics().getHoverBox().regenerateHandles(),this.getGraphics().getHoverBox().regenerateButtons()}},getConceptionDate:function(){return this._conceptionDate},setConceptionDate:function(newDate){this._conceptionDate=newDate?new Date(newDate):"",this.getGraphics().updateAgeLabel()},getBirthDate:function(){return this._birthDate},setBirthDate:function(newDate){(newDate=new PedigreeDate(newDate)).isSet()||(newDate=null),null!=newDate&&(this.setAgeOfDeath(""),this.setAgeOfDeathFormat("y")),newDate&&this.getDeathDate()&&!this.getDeathDate().canBeAfterDate(newDate)||(this._birthDate=newDate,this.getGraphics().updateAgeLabel())},getDeathDate:function(){return this._deathDate},getAgeOfDeath:function(){return this._ageOfDeath},getAgeOfDeathFormat:function(){return this._ageOfDeathFormat},setDeathDate:function(deathDate){return(deathDate=new PedigreeDate(deathDate)).isSet()||(deathDate=null),null!=deathDate&&(this.setAgeOfDeath(""),this.setAgeOfDeathFormat("y")),deathDate&&this.getBirthDate()&&!deathDate.canBeAfterDate(this.getBirthDate())||(this._deathDate=deathDate,this._deathDate&&"Alive"==this.getLifeStatus()&&this.setLifeStatus("Deceased")),this.getGraphics().updateAgeLabel(),this.getDeathDate()},setAgeOfDeath:function(ageOfDeath){var wasSet=this._ageOfDeath||this._ageOfDeath.length;if(this._ageOfDeath=ageOfDeath+"",this._ageOfDeath&&this._ageOfDeath.length){this.setLifeStatus("Deceased"),this.setDeathDate(null),this.setBirthDate(null);var text=ageOfDeath+" "+this._ageOfDeathFormat;this.getGraphics().updateAgeLabelForGELDirectly(text)}else wasSet&&this.getGraphics().updateAgeLabelForGELDirectly("")},setAgeOfDeathFormat:function(ageOfDeathFormat){if(this._ageOfDeathFormat=ageOfDeathFormat,this._ageOfDeathFormat&&0<this._ageOfDeathFormat.length&&this._ageOfDeath&&0<this._ageOfDeath.length){var text=this._ageOfDeath+" "+this._ageOfDeathFormat;this.getGraphics().updateAgeLabelForGELDirectly(text)}},_isValidCarrierStatus:function(status){return"Unaffected"==status||"Carrier"==status||"Uncertain"==status||"Unknown"==status||"Affected"==status||"Presymptomatic"==status},setCarrierStatus:function(status){for(var numDisorders=0,i=0;i<this._disordersFullDetails.length;i++)numDisorders+=1;if(null==status&&0<numDisorders)return status="Affected",this.getGraphics().updateDisorderShapes(),this._carrierStatus=status,void this.getGraphics().updateCarrierGraphic();this._isValidCarrierStatus(status)&&status!=this._carrierStatus&&(this._carrierStatus=status,this.getGraphics().updateCarrierGraphic())},getCarrierStatus:function(){return this._carrierStatus},getAllNodeColors:function(){for(var result=[],i=0;i<this.getDisorders().length;i++)null!=this._disordersFullDetails&&null!=this._disordersFullDetails[i].valueAll&&result.push(editor.getDisorderLegend().getObjectColor(this.getDisorders()[i]));for(i=0;i<this.getGenes().length;i++)result.push(editor.getGeneLegend().getObjectColor(this.getGenes()[i]));for(i=0;i<this.getCancers().length;i++)this.getCancers()[i].affected=!0,this.getCancers()[i].hasOwnProperty("Affected")&&this.getCancers()[i].affected&&result.push(editor.getCancerLegend().getObjectColor(this.getCancers()[i]));return"Affected"==this.getCarrierStatus()&&result.push("#81a270"),result},getDisorders:function(){return this._disorders},getDisorderType:function(){return this._disorderType},getDisordersForExport:function(){return this._disorders.slice(0)},addDisorder:function(disorder){"object"!=typeof disorder&&(disorder=editor.getDisorderLegend().getDisorder(disorder)),editor.getDisorderLegend().addCase(disorder.getDisorderId(),disorder.getName(),disorder.getValueAll(),this.getID()),this.getDisorders().push(disorder.getDisorderId()),this._disordersFullDetails.push(disorder),1<this.getDisorders().length&&this.removeDisorder("Affected")},removeDisorder:function(disorderId){this.hasDisorder(disorderId)&&(editor.getDisorderLegend().removeCase(disorderId,this.getID()),this._disorders=this.getDisorders().without(disorderId));for(var i=this._disordersFullDetails.length-1;0<=i;i--)this._disordersFullDetails[i].disorderId==disorderId&&this._disordersFullDetails.splice(i,1)},setDisorders:function(disorders){for(var i=this.getDisorders().length-1;0<=i;i--)this.removeDisorder(this.getDisorders()[i]);for(i=0;i<disorders.length;i++)this.addDisorder(disorders[i]);this.getGraphics().updateDisorderShapes(),"Affected"==this.getCarrierStatus()&&this.setCarrierStatus()},setDisorderType:function(disorderType){this._disorderType=disorderType},setDisordersFullDetails:function(disordersFullDetails){this._disordersFullDetails=disordersFullDetails},getHPO:function(){return this._hpo},getHPOForExport:function(){return this._hpo.slice(0)},addHPO:function(hpo){if("object"!=typeof hpo&&(hpo=editor.getHPOLegend().getTerm(hpo)),this.hasHPO(hpo.getID()))alert("This person already has the specified phenotype");else{editor.getHPOLegend().addCase(hpo.getID(),hpo.getName(),hpo.getValueAll(),this.getID()),this.getHPO().push(hpo.getID());for(var alreadyExists=!1,i=0;i<this._hpoFullDetails.length;i++)this._hpoFullDetails[i].hpoId==hpo&&(alreadyExists=!0);alreadyExists||this._hpoFullDetails.push(hpo)}},removeHPO:function(hpoId){if(this.hasHPO(hpoId)){editor.getHPOLegend().removeCase(hpoId,this.getID()),this._hpo=this.getHPO().without(hpoId);for(var i=0;i<this._hpoFullDetails.length;i++)if(this._hpoFullDetails[i].hpoId==hpoId){this._hpoFullDetails.splice(i,1);break}}else alert("This person doesn't have the specified HPO term")},setHPO:function(hpos){for(var i=this.getHPO().length-1;0<=i;i--)this.removeHPO(this.getHPO()[i]);hpos=this.sortHPOs(hpos);for(i=0;i<hpos.length;i++)this.addHPO(hpos[i])},sortHPOs:function(hpos){var resultHPOs=[];return hpos.forEach(function(hpo){hpo.hpoPresent&&"Present"==hpo.hpoPresent&&resultHPOs.push(hpo)}),hpos.forEach(function(hpo){hpo.hpoPresent&&"Unknown"!=hpo.hpoPresent||resultHPOs.push(hpo)}),hpos.forEach(function(hpo){"Absent"==hpo.hpoPresent&&resultHPOs.push(hpo)}),resultHPOs},setHPOFullDetails:function(hpoFullDetails){this._hpoFullDetails=hpoFullDetails},hasHPO:function(id){return-1!=this.getHPO().indexOf(id)},setEthnicities:function(ethnicities){this._ethnicities=ethnicities},getEthnicities:function(){var elements=document.getElementsByName("ethnicity")[0].options;if(document.getElementsByName("ethnicity")&&document.getElementsByName("ethnicity")[0])for(var i=0;i<elements.length;i++)elements[i].selected=!1;return this._ethnicities},addGene:function(gene){-1==this.getGenes().indexOf(gene)&&(editor.getGeneLegend().addCase(gene,gene,this.getID()),this.getGenes().push(gene))},removeGene:function(gene){-1!==this.getGenes().indexOf(gene)&&(editor.getGeneLegend().removeCase(gene,this.getID()),this._candidateGenes=this.getGenes().without(gene))},setGenes:function(genes){for(var i=this.getGenes().length-1;0<=i;i--)this.removeGene(this.getGenes()[i]);for(i=0;i<genes.length;i++)this.addGene(genes[i]);this.getGraphics().updateDisorderShapes()},getGenes:function(){return this._candidateGenes},addCancer:function(cancer){console.log("CCCancer",cancer),editor.getCancerLegend().addCase(cancer.tumourUid,cancer.tumourCodeMorphText,cancer,this.getID()),this.getCancers().push(cancer.tumourUid)},removeCancer:function(cancerName){this.getCancers().hasOwnProperty(cancerName)&&(editor.getCancerLegend().removeCase(cancerName,this.getID()),delete this._cancers[cancerName])},addUnmappedPerson:function(cancerName,cancerDetails){console.log("addunmappedperson"),console.log("cancerName",cancerName,"details",cancerDetails),this.getCancers().hasOwnProperty(cancerName)||(editor.getUnmappedPersonLegend().addCase(cancerDetails.tumourUid,cancerDetails.tumourCodeMorphText,this.getID()),this.getCancers()[cancerName]=cancerDetails)},removeUnmappedPerson:function(cancerName){this.getCancers().hasOwnProperty(cancerName)&&(editor.getCancerLegend().removeCase(cancerName,this.getID()),delete this._cancers[cancerName])},setCancers:function(cancers){console.log("TTT"),console.log(this.getCancers()),console.log(cancers);for(var i=0;i<cancers.length;i++)this.addCancer(cancers[i]);this.getGraphics().updateDisorderShapes(),this.getGraphics().updateCancerAgeOfOnsetLabels()},getLastMenstralPeriod:function(){return this._lastMenstralPeriod},setLastMenstralPeriod:function(lastMenstralPeriod){this._lastMenstralPeriod=lastMenstralPeriod},getCancers:function(){return this._cancers},remove:function($super){this.setDisorders([]),this.setHPO([]),this.setGenes([]),this.setCancers([]),$super()},hasDisorder:function(id){return-1!=this.getDisorders().indexOf(id)},setChildlessStatus:function(status){return this.isValidChildlessStatus(status)||(status=null),status!=this.getChildlessStatus()&&(this._childlessStatus=status,this.setChildlessReason(null),this.getGraphics().updateChildlessShapes(),this.getGraphics().getHoverBox().regenerateHandles()),this.getChildlessStatus()},getSummary:function(){var onceAlive=editor.getGraph().hasRelationships(this.getID()),inactiveStates=!!onceAlive&&["Unborn","Aborted","Miscarriage","Stillborn"],disabledStates=!1;(this.isProband()||this.isRegistered())&&(disabledStates=["Alive","Deceased","Unborn","Aborted","Miscarriage","Stillborn"],Helpers.removeFirstOccurrenceByValue(disabledStates,this.getLifeStatus()));var disabledGenders=!(!this.isProband()&&!this.isRegistered())&&[],inactiveGenders=!1,genderSet=editor.getGraph().getPossibleGenders(this.getID());for(gender in genderSet)genderSet.hasOwnProperty(gender)&&(genderSet[gender]||(inactiveGenders||(inactiveGenders=[]),inactiveGenders.push(gender))),this.isProband()&&gender!=this.getGender()&&disabledGenders.push(gender);var childlessInactive=this.isFetus(),disorders=[];this._disordersFullDetails.forEach(function(disorder){disorders.push({id:disorder.disorderId,value:disorder.name,valueAll:disorder.valueAll})});var hpoTerms=[];this.getHPO().forEach(function(hpo){var termName=editor.getHPOLegend().getTerm(hpo).getName(),hpoObj=editor.getHPOLegend().getTerm(hpo);hpoTerms.push({id:hpo,value:termName,valueAll:hpoObj.valueAll})});var cantChangeAdopted=this.isFetus()||editor.getGraph().hasToBeAdopted(this.getID());!cantChangeAdopted&&onceAlive&&(cantChangeAdopted=["adoptedOut","disableViaOpacity"]);var inactiveMonozygothic=!0,disableMonozygothic=!0;if(null!==this._twinGroup){var twins=editor.getGraph().getAllTwinsSortedByOrder(this.getID());if(1<twins.length){disableMonozygothic=inactiveMonozygothic=!1;for(var i=0;i<twins.length;i++)if(editor.getGraph().getGender(twins[i])!=this.getGender()){disableMonozygothic=!0;break}}}var inactiveCarriers=[];"Aborted"!=this.getLifeStatus()&&"Miscarriage"!=this.getLifeStatus()||inactiveCarriers.push("presymptomatic"),this.isRegistered()&&(inactiveCarriers=["","Carrier","Uncertain","Affected","Unknown","Unaffected","Presymptomatic"]);var inactiveLostContact=this.isProband()||!editor.getGraph().isRelatedToProband(this.getID())||this.isRegistered();return{identifier:{value:this.getID()},nhs_number:{value:this.getNHSNumber(),disabled:!0},chiNumber:{value:this.getChiNumber(),disabled:!0},organDonorId:{value:this.getOrganDonorId(),disabled:!0},localIdentifier:{value:this.getLocalIdentifier(),disabled:!0},gel_super_family_id:{value:this.getGelSuperFamilyId()},family_id:{value:this.getFamilyId()},consanguineous_population:{value:this.getConsanguineousPopulation()},karyotypic_sex:{value:this.getKaryotypicSex(),disabled:this.isRegistered()},ancestries:{value:this.getAncestries()},participant_id:{value:this.getParticipantId(),disabled:!0},registered:{value:this.getRegistered()},first_name:{value:this.getFirstName(),disabled:!0},last_name:{value:this.getLastName(),disabled:!0},last_name_birth:{value:this.getLastNameAtBirth(),disabled:this.isRegistered()},external_id:{value:this.getExternalID(),disabled:this.isRegistered()},chiNumber:{value:this.getChiNumber(),disabled:!0},organDonorId:{value:this.getOrganDonorId(),disabled:!0},localIdentifier:{value:this.getLocalIdentifier(),disabled:!0},participatingInTest:{value:this.getParticipatingInTest(),disabled:!0},gestationAgeWeeks:{value:this.getGestationAgeWeeks(),disabled:this.isRegistered()},gestationAgeDays:{value:this.getGestationAgeDays(),disabled:this.isRegistered()},estimatedDateOfDelivery:{value:this.getEstimatedDateOfDelivery(),disabled:this.isRegistered()},comments:{value:this.getComments(),disabled:this.isRegistered()},gender:{value:this.getGender(),inactive:inactiveGenders,disabled:this.isRegistered()},date_of_birth:{value:this.getBirthDate(),inactive:this.isFetus(),disabled:this.isRegistered()},carrierStatus:{value:this.getCarrierStatus(),disabled:this.isRegistered()},disorders:{value:disorders,disabled:this.isRegistered()},disordersFullDetails:{value:this._disordersFullDetails,disabled:this.isRegistered()},disorderType:{value:this.getDisorderType(),disabled:this.isRegistered()},ethnicity:{value:this.getEthnicities(),disabled:this.isRegistered()},candidate_genes:{value:this.getGenes(),disabled:this.isRegistered()},adopted:{value:this.getAdopted(),inactive:cantChangeAdopted,disabled:this.isRegistered()},state:{value:this.getLifeStatus(),inactive:inactiveStates,disabled:disabledStates},date_of_death:{value:this.getDeathDate(),inactive:this.isFetus(),disabled:this.isRegistered()},age_of_death:{value:this.getAgeOfDeath(),inactive:this.isFetus(),disabled:this.isRegistered()||null!=this.getBirthDate()&&null!=this.getDeathDate()},age_of_death_format:{value:this.getAgeOfDeathFormat(),inactive:this.isFetus(),disabled:this.isRegistered()||null!=this.getBirthDate()&&null!=this.getDeathDate()},commentsClinical:{value:this.getComments(),inactive:!1,disabled:this.isRegistered()},commentsPersonal:{value:this.getComments(),inactive:!1,disabled:this.isRegistered()},commentsCancers:{value:this.getComments(),inactive:!1,disabled:this.isRegistered()},gestation_age_weeks:{value:this.getGestationAgeWeeks(),inactive:!this.isFetus(),disabled:this.isRegistered()},gestation_age_days:{value:this.getGestationAgeDays(),inactive:!this.isFetus(),disabled:this.isRegistered()},childlessSelect:{value:this.getChildlessStatus()?this.getChildlessStatus():"None",inactive:childlessInactive,disabled:this.isRegistered()},childlessText:{value:this.getChildlessReason()?this.getChildlessReason():void 0,inactive:childlessInactive,disabled:!this.getChildlessStatus()||this.isRegistered()},placeholder:{value:!1,inactive:!0},monozygotic:{value:this.getMonozygotic(),inactive:inactiveMonozygothic,disabled:disableMonozygothic||this.isRegistered()},evaluated:{value:this.getEvaluated(),disabled:!1},hpo_positive:{value:hpoTerms,disabled:this.isRegistered()},hpo_positiveFullDetails:{value:this._hpoFullDetails},nocontact:{value:this.getLostContact(),inactive:inactiveLostContact},cancers:{value:this.getCancers(),disabled:this.isRegistered()},phenotipsid:{value:this.getPhenotipsPatientId(),disabled:this.isRegistered()},ageOfOnset:{value:this.getAgeOfOnset(),disabled:this.isRegistered()},hpoPresent:{value:"",disabled:this.isRegistered()},age_of_death_guide:{value:"",inactive:this.isFetus()},numberOfColorectalPolypsAdenomas:{value:this.getNumberOfColorectalPolypsAdenomas(),disabled:this.isRegistered()},numberOfColorectalPolypsTotal:{value:this.getNumberOfColorectalPolypsTotal(),disabled:this.isRegistered()},clinicalIndicationName:{value:this.getClinicalIndicationName(),disabled:!0},clinicalIndicationAgeOfOnsetYears:{value:this.getClinicalIndicationAgeOfOnsetYears(),disabled:this.isRegistered()},clinicalIndicationAgeOfOnsetMonths:{value:this.getClinicalIndicationAgeOfOnsetMonths(),disabled:this.isRegistered()},diagnosisCertainty:{value:this.getDiagnosisCertainty(),disabled:this.isRegistered()},lastMenstralPeriod:{value:this.getLastMenstralPeriod(),disabled:this.isRegistered()},nonNgisPatientStableUid:{value:this.getNonNgisPatientStableUid(),disabled:!0},ngisRegisteredPatientUid:{value:this.getNgisRegisteredPatientUid(),disabled:!0}}},getProperties:function($super){var info=$super();return""!=this.getPhenotipsPatientId()&&(info.phenotipsId=this.getPhenotipsPatientId()),""!=this.getFirstName()&&(info.fName=this.getFirstName()),""!=this.getLastName()&&(info.lName=this.getLastName()),""!=this.getNHSNumber()&&(info.NHSNumber=this.getNHSNumber()),""!=this.getGelSuperFamilyId()&&(info.gelSuperFamilyId=this.getGelSuperFamilyId()),""!=this.getFamilyId()&&(info.familyId=this.getFamilyId()),""!=this.getKaryotypicSex()&&(info.karyotypicSex=this.getKaryotypicSex()),""!=this.getConsanguineousPopulation()&&(info.consanguineousPopulation=this.getConsanguineousPopulation()),""!=this.getAncestries()&&(info.ancestries=this.getAncestries()),""!=this.getChiNumber()&&(info.chiNumber=this.getChiNumber()),""!=this.getOrganDonorId()&&(info.organDonorId=this.getOrganDonorId()),""!=this.getLocalIdentifier()&&(info.localIdentifier=this.getLocalIdentifier()),""!=this.getParticipantId()&&(info.participantId=this.getParticipantId()),""!=this.getRegistered()&&(info.registered=this.getRegistered()),""!=this.getLastNameAtBirth()&&(info.lNameAtB=this.getLastNameAtBirth()),""!=this.getExternalID()&&(info.externalID=this.getExternalID()),null!=this.getBirthDate()&&(info.dob=this.getBirthDate().getSimpleObject()),""!=this.getAdopted()&&(info.adoptedStatus=this.getAdopted()),"Alive"!=this.getLifeStatus()&&(info.lifeStatus=this.getLifeStatus()),null!=this.getDeathDate()&&(info.dod=this.getDeathDate().getSimpleObject()),""!=this.getAgeOfDeath()&&(info.ageOfDeath=this.getAgeOfDeath()),""!=this.getAgeOfDeathFormat()&&(info.ageOfDeathFormat=this.getAgeOfDeathFormat()),null!=this.getGestationAgeWeeks()&&(info.gestationAgeWeeks=this.getGestationAgeWeeks()),null!=this.getGestationAgeDays()&&(info.gestationAgeDays=this.getGestationAgeDays()),null!=this.getChildlessStatus()&&(info.childlessStatus=this.getChildlessStatus(),info.childlessReason=this.getChildlessReason()),0<this.getDisorders().length&&(info.disorders=this.getDisordersForExport()),0<this._disordersFullDetails.length&&(info.disordersFullDetails=this._disordersFullDetails),Helpers.isObjectEmpty(this.getCancers())||(info.cancers=this.getCancers()),0<this.getHPO().length&&(info.hpoTerms=this.getHPOForExport()),0<this._hpoFullDetails.length&&(info.hpoTermsFullDetails=this._hpoFullDetails),this.getEthnicities()&&0<this.getEthnicities().length&&(info.ethnicities=this.getEthnicities()),this.getGenes()&&0<this.getGenes().length&&(info.candidateGenes=this.getGenes()),null!==this._twinGroup&&(info.twinGroup=this._twinGroup),this._monozygotic&&(info.monozygotic=this._monozygotic),this._evaluated&&(info.evaluated=this._evaluated),this._carrierStatus&&(info.carrierStatus=this._carrierStatus),this.getLostContact()&&(info.lostContact=this.getLostContact()),""!=this.getPedNumber()&&(info.nodeNumber=this.getPedNumber()),this._participatingInTest&&(info.participatingInTest=this._participatingInTest),""!=this.getNonNgisPatientStableUid()&&(info.nonNgisPatientStableUid=this.getNonNgisPatientStableUid()),""!=this.getNgisRegisteredPatientUid()&&(info.ngisRegisteredPatientUid=this.getNgisRegisteredPatientUid()),""!=this.getOtherIdentifier()&&(info.otherIdentifier=this.getOtherIdentifier()),""!=this.getOtherIdentifierType()&&(info.otherIdentifierType=this.getOtherIdentifierType()),""!=this.getGestationAgeWeeks()&&(info.gestationAgeWeeks=this.getGestationAgeWeeks()),""!=this.getGestationAgeDays()&&(info.gestationAgeDays=this.getGestationAgeDays()),""!=this.getEstimatedDateOfDelivery()&&(info.estimatedDateOfDelivery=this.getEstimatedDateOfDelivery()),""!=this.getComments()&&(info.comments=this.getComments()),""!=this.getLastMenstralPeriod()&&(info.lastMenstralPeriod=this.getLastMenstralPeriod()),""!=this.getNumberOfColorectalPolypsTotal()&&(info.numberOfColorectalPolypsTotal=this.getNumberOfColorectalPolypsTotal()),""!=this.getNumberOfColorectalPolypsAdenomas()&&(info.numberOfColorectalPolypsAdenomas=this.getNumberOfColorectalPolypsAdenomas()),""!=this.getClinicalIndicationAgeOfOnsetMonths()&&(info.clinicalIndicationAgeOfOnsetMonths=this.getClinicalIndicationAgeOfOnsetMonths()),""!=this.getClinicalIndicationAgeOfOnsetYears()&&(info.clinicalIndicationAgeOfOnsetYears=this.getClinicalIndicationAgeOfOnsetYears()),info},assignProperties:function($super,info){if(this._setDefault(),$super(info)){if(info.phenotipsId&&this.getPhenotipsPatientId()!=info.phenotipsId&&this.setPhenotipsPatientId(info.phenotipsId),info.fName&&this.getFirstName()!=info.fName&&this.setFirstName(info.fName),info.lName&&this.getLastName()!=info.lName&&this.setLastName(info.lName),info.participantId&&this.getParticipantId()!=info.participantId&&this.setParticipantId(info.participantId),info.registered&&this.getRegistered()!=info.registered&&this.setRegistered(info.registered),info.NHSNumber&&this.getNHSNumber()!=info.NHSNumber&&this.setNHSNumber(info.NHSNumber),info.gelSuperFamilyId&&this.getGelSuperFamilyId()!=info.gelSuperFamilyId&&this.setGelSuperFamilyId(info.gelSuperFamilyId),info.familyId&&this.getFamilyId()!=info.familyId&&this.setFamilyId(info.familyId),info.karyotypicSex&&this.getKaryotypicSex()!=info.karyotypicSex&&this.setKaryotypicSex(info.karyotypicSex),info.consanguineousPopulation&&this.getConsanguineousPopulation()!=info.consanguineousPopulation&&this.setConsanguineousPopulation(info.consanguineousPopulation),info.ancestries&&this.getAncestries()!=info.ancestries&&this.setAncestries(info.ancestries),info.chiNumber&&this.getChiNumber()!=info.chiNumber&&this.setChiNumber(info.chiNumber),info.organDonorId&&this.getOrganDonorId()!=info.organDonorId&&this.setOrganDonorId(info.organDonorId),info.localIdentifier&&this.getLocalIdentifier()!=info.localIdentifier&&this.setLocalIdentifier(info.localIdentifier),info.lNameAtB&&this.getLastNameAtBirth()!=info.lNameAtB&&this.setLastNameAtBirth(info.lNameAtB),info.externalID&&this.getExternalID()!=info.externalID&&this.setExternalID(info.externalID),info.dob&&this.getBirthDate()!=info.dob&&this.setBirthDate(info.dob),info.ngisRegisteredPatientUid&&this.getNgisRegisteredPatientUid()!=info.ngisRegisteredPatientUid&&this.setNgisRegisteredPatientUid(info.ngisRegisteredPatientUid),info.nonNgisPatientStableUid&&this.getNonNgisPatientStableUid()!=info.nonNgisPatientStableUid&&this.setNonNgisPatientStableUid(info.nonNgisPatientStableUid),!this.getNonNgisPatientStableUid()&&!this.getNgisRegisteredPatientId()&&!this.getNHSNumber()){var nonNgisId=Math.random().toString(36).substr(2,5);this.setNonNgisPatientStableUid(nonNgisId),info.nonNgisPatientStableUid=nonNgisId}info.otherIdentifier&&this.getOtherIdentifier()!=info.otherIdentifier&&this.setOtherIdentifier(info.otherIdentifier),info.otherIdentifierType&&this.getOtherIdentifierType()!=info.otherIdentifierType&&this.setOtherIdentifierType(info.otherIdentifierType),info.hasOwnProperty("participatingInTest")&&this._participatingInTest!=info.participatingInTest&&this.setParticipatingInTest(info.participatingInTest),info.participatingInTest&&this.getParticipatingInTest()!=info.participatingInTest&&this.setParticipatingInTest(info.participatingInTest),info.gestationAgeWeeks&&this.getGestationAgeWeeks()!=info.gestationAgeWeeks&&this.setGestationAgeWeeks(info.gestationAgeWeeks),info.gestationAgeDays&&this.getGestationAgeDays()!=info.gestationAgeDays&&this.setGestationAgeDays(info.gestationAgeDays),info.estimatedDateOfDelivery&&this.getEstimatedDateOfDelivery()!=info.estimatedDateOfDelivery&&this.setEstimatedDateOfDelivery(info.estimatedDateOfDelivery),info.comments&&this.getComments()!=info.comments&&this.setComments(info.comments);var clinicalIndicationName=document.getElementById("clinical-indication-name").innerHTML.split("<span")[0];if(clinicalIndicationName&&this.getClinicalIndicationName()!=clinicalIndicationName&&this.setClinicalIndicationName(clinicalIndicationName),info.clinicalIndicationCode&&this.getClinicalIndicationCode()!=info.clinicalIndicationCode&&this.setClinicalIndicationCode(info.clinicalIndicationCode),info.numberOfColorectalPolypsAdenomas&&this.getNumberOfColorectalPolypsAdenomas()!=info.numberOfColorectalPolypsAdenomas&&this.setNumberOfColorectalPolypsAdenomas(info.numberOfColorectalPolypsAdenomas),info.numberOfColorectalPolypsTotal&&this.getNumberOfColorectalPolypsTotal()!=info.numberOfColorectalPolypsTotal&&this.setNumberOfColorectalPolypsTotal(info.numberOfColorectalPolypsTotal),info.diagnosisCertainty&&this.getDiagnosisCertainty()!=info.diagnosisCertainty&&this.setDiagnosisCertainty(info.diagnosisCertainty),info.lastMenstralPeriod&&this.getLastMenstralPeriod()!=info.lastMenstralPeriod&&this.setLastMenstralPeriod(info.lastMenstralPeriod),info.carrierStatus&&this.getCarrierStatus()!=info.carrierStatus&&this.setCarrierStatus(info.carrierStatus),info.clinicalIndicationAgeOfOnsetYears&&this.getClinicalIndicationAgeOfOnsetYears()!=info.clinicalIndicationAgeOfOnsetYears&&this.setClinicalIndicationAgeOfOnsetYears(info.clinicalIndicationAgeOfOnsetYears),info.clinicalIndicationAgeOfOnsetMonths&&this.getClinicalIndicationAgeOfOnsetMonths()!=info.clinicalIndicationAgeOfOnsetMonths&&this.setClinicalIndicationAgeOfOnsetMonths(info.clinicalIndicationAgeOfOnsetMonths),info.disorders){var disorders=[];if(null!=info.disordersFullDetails&&0<info.disordersFullDetails.length){for(var i=0;i<info.disordersFullDetails.length;i++){var disorder=new Disorder(info.disordersFullDetails[i].disorderId,info.disordersFullDetails[i].name,info.disordersFullDetails[i].ageOfOnset,info.disordersFullDetails[i].diagnosisCertainty,info.disordersFullDetails[i].codeSystemUri,info.disordersFullDetails[i].versionNumber,info.disordersFullDetails[i].disorderType,info.disordersFullDetails[i].valueAll);disorders.push(disorder)}this.setDisorders(disorders)}else this.setDisorders(info.disorders)}if(info.cancers&&(console.log("cancers"),this.setCancers(info.cancers)),info.hpoTermsFullDetails){this._hpoTermsFullDetails=info.hpoTermsFullDetails.slice();for(i=0;i<this._hpoTermsFullDetails.length;i++)this._hpoTermsFullDetails[i].valueAll||(this._hpoTermsFullDetails[i].valueAll={});var terms=[];if(null!=this._hpoTermsFullDetails&&0<this._hpoTermsFullDetails.length){for(i=0;i<this._hpoTermsFullDetails.length;i++){var term=new HPOTerm(this._hpoTermsFullDetails[i].hpoId,this._hpoTermsFullDetails[i].name,this._hpoTermsFullDetails[i].hpoPresent,this._hpoTermsFullDetails[i].hpoModifiers,this._hpoTermsFullDetails[i].valueAll);terms.push(term)}this.setHPO(terms)}else this.setHPO(info.hpoTerms)}return info.ethnicities&&this.setEthnicities(info.ethnicities),info.candidateGenes&&this.setGenes(info.candidateGenes),info.hasOwnProperty("adoptedStatus")&&this.getAdopted()!=info.adoptedStatus&&this.setAdopted(info.adoptedStatus),info.hasOwnProperty("lifeStatus")&&this.getLifeStatus()!=info.lifeStatus&&this.setLifeStatus(info.lifeStatus),info.dod&&this.getDeathDate()!=info.dod&&this.setDeathDate(info.dod),info.ageOfDeath&&this.getAgeOfDeath()!=info.ageOfDeath&&this.setAgeOfDeath(info.ageOfDeath),info.ageOfDeathFormat&&this.getAgeOfDeathFormat()!=info.ageOfDeathFormat&&this.setAgeOfDeathFormat(info.ageOfDeathFormat),info.gestationAgeWeeks&&this.getGestationAgeWeeks()!=info.gestationAgeWeeks&&this.setGestationAgeWeeks(info.gestationAgeWeeks),info.gestationAgeDays&&this.getGestationAgeDays()!=info.gestationAgeDays&&this.setGestationAgeDays(info.gestationAgeDays),info.childlessStatus&&this.getChildlessStatus()!=info.childlessStatus&&this.setChildlessStatus(info.childlessStatus),info.childlessReason&&this.getChildlessReason()!=info.childlessReason&&this.setChildlessReason(info.childlessReason),info.hasOwnProperty("twinGroup")&&this._twinGroup!=info.twinGroup&&this.setTwinGroup(info.twinGroup),info.hasOwnProperty("monozygotic")&&this._monozygotic!=info.monozygotic&&this.setMonozygotic(info.monozygotic),info.hasOwnProperty("evaluated")&&this._evaluated!=info.evaluated&&this.setEvaluated(info.evaluated),info.hasOwnProperty("carrierStatus")&&this._carrierStatus!=info.carrierStatus&&this.setCarrierStatus(info.carrierStatus),info.hasOwnProperty("nodeNumber")&&this.getPedNumber()!=info.nodeNumber&&this.setPedNumber(info.nodeNumber),info.hasOwnProperty("lostContact")&&this.getLostContact()!=info.lostContact&&this.setLostContact(info.lostContact),info.hasOwnProperty("ngisRegisteredPatientUid")&&this.getNgisRegisteredPatientUid()!=info.ngisRegisteredPatientUid&&this.setNgisRegisteredPatientUid(info.ngisRegisteredPatientUid),info.hasOwnProperty("lostContact")&&this.getLostContact()!=info.lostContact&&this.setLostContact(info.lostContact),!0}return!1}});Person.addMethods(ChildlessBehavior),Person.setMethods={},Person.copyUnassignedNode=function(person,unRenderedValueAll){var yesFunction=function(){var disorderLoaded=!1,hpoLoaded=!1;for(var property in unRenderedValueAll.registered=!0,unRenderedValueAll)if(Object.prototype.hasOwnProperty.call(unRenderedValueAll,property)){var value=unRenderedValueAll[property],setMethod=Person.setMethods[property];if(!setMethod){console.log("Set method '"+setMethod+"' for property '"+property+"' not specified in 'Person.setMethods'");continue}"sex"!=property&&"gender"!=property||(value=Person.FormatGender(value));if(-1<["gelsuperfamilyid","ancestries","consanguineouspopulation","comments","childlessstatus","childlessreason","karyotypicsex"].indexOf(property.toLocaleLowerCase().trim()))continue;if("disordersFullDetails"==property||"disorders"==property){if(disorderLoaded)continue;if(!unRenderedValueAll.disordersFullDetails){console.log("disordersFullDetails must have been included, otherwise we can not load Nodes");continue}if(console.log("unrenderedva",unRenderedValueAll),console.log("dfd",unRenderedValueAll.disordersFullDetails),unRenderedValueAll.disordersFullDetails){for(var disorders=unRenderedValueAll.disordersFullDetails,newDisorderArray=[],i=0;i<disorders.length;i++){var disorder=new Disorder(disorders[i].disorderId,disorders[i].name,disorders[i].ageOfOnset,disorders[i].diagnosisCertainty,disorders[i].codeSystemUri,disorders[i].versionNumber,disorders[i].disorderType,disorders[i].valueAll);newDisorderArray.push(disorder)}(properties={}).setDisorders=newDisorderArray;var event={nodeID:person.getID(),properties:properties};document.fire("pedigree:node:setproperty",event)}disorderLoaded=!0;continue}if("hpoTerms"==property||"hpoTermsFullDetails"==property){if(hpoLoaded)continue;if(!unRenderedValueAll.hpoTermsFullDetails){console.log("hpoTermsFullDetails must have been included, otherwise we can not load HPOs from 'hpoTerms' in unRendered Nodes");continue}if(unRenderedValueAll.hpoTermsFullDetails){var properties,HPOs=unRenderedValueAll.hpoTermsFullDetails;console.log("hpos",HPOs);var newHPOArray=[];for(i=0;i<HPOs.length;i++){var HPO=new HPOTerm(HPOs[i].hpoId,HPOs[i].name,HPOs[i].hpoPresent,HPOs[i].hpoModifiers,HPOs[i].valueAll);newHPOArray.push(HPO)}(properties={}).setHPO=newHPOArray;event={nodeID:person.getID(),properties:properties};document.fire("pedigree:node:setproperty",event)}hpoLoaded=!0;continue}(properties={})[setMethod]=value;event={nodeID:person.getID(),properties:properties};document.fire("pedigree:node:setproperty",event)}},targetNodeGender=Person.FormatGender(person.getGender()),sourceNodeGender=Person.FormatGender(unRenderedValueAll.sex),genderMessage=void 0;"M"!==targetNodeGender||"F"!==sourceNodeGender&&"O"!==sourceNodeGender&&"unknown"!==sourceNodeGender?"F"!==targetNodeGender||"M"!==sourceNodeGender&&"O"!==sourceNodeGender&&"unknown"!==sourceNodeGender?"O"!==targetNodeGender||"M"!==sourceNodeGender&&"F"!==sourceNodeGender&&"unknown"!==sourceNodeGender||(genderMessage="Gender in target node is 'Other' but in unassigned node it is '"+Person.getGenderString(sourceNodeGender)+"',<br> Are you sure you want to assign the values to this node?"):genderMessage="Gender in target node is 'Female' but in unassigned node it is '"+Person.getGenderString(sourceNodeGender)+"',<br> Are you sure you want to assign the values to this node?":genderMessage="Gender in target node is 'Male' but in unassigned node it is '"+Person.getGenderString(sourceNodeGender)+"',<br> Are you sure you want to assign the values to this node?",genderMessage?editor.getOkCancelDialogue().showCustomized(genderMessage,"Genomics England","Yes",yesFunction,"No",function(){this.dialog.show()},null,!0):yesFunction()},Person.FormatGender=function(genderString){return null==genderString||null==genderString?"unknown":"female"==(genderString=genderString.toLowerCase())||"f"==genderString||"2"==genderString?"F":"other"==genderString||"o"==genderString||"9"==genderString?"O":"male"==genderString||"m"==genderString||"1"==genderString?"M":"unknown"},Person.getGenderString=function(genderString){return null==genderString||null==genderString?"unknown":"female"==(genderString=genderString.toLowerCase())||"f"==genderString||"2"==genderString?"Female":"other"==genderString||"o"==genderString||"9"==genderString?"Other":"male"==genderString||"m"==genderString||"1"==genderString?"Male":"Unknown"};var PersonGroupHoverbox=Class.create(PersonHoverbox,{initialize:function($super,personNode,centerX,centerY,nodeShapes){PedigreeEditorParameters.attributes.radius;$super(personNode,centerX,centerY,nodeShapes)},generateHandles:function($super){null===this._currentHandles&&PedigreeEditorParameters.attributes.newHandles},generateButtons:function($super){null===this._currentButtons&&(this._currentButtons=[],this.generateMenuBtn(),this.generateDeleteBtn())},isMenuToggled:function(){return this._isMenuToggled},toggleMenu:function(isMenuToggled){if(!this._justClosedMenu&&(this._isMenuToggled=isMenuToggled)){this.getNode().getGraphics().unmark();var optBBox=this.getBoxOnHover().getBBox(),x=optBBox.x2,y=optBBox.y,position=editor.getWorkspace().canvasToDiv(x+5,y);editor.getNodeGroupMenu().show(this.getNode(),position.x,position.y)}}}),PersonGroupVisuals=Class.create(PersonVisuals,{initialize:function($super,node,x,y){$super(node,x,y),this.setNumPersons(node.getNumPersons())},generateHoverbox:function(x,y){return editor.isReadOnlyMode()?new ReadOnlyHoverbox(this.getNode(),x,y,this.getGenderGraphics()):new PersonGroupHoverbox(this.getNode(),x,y,this.getGenderGraphics())},getAllGraphics:function($super){return $super().push(this._label)},setNumPersons:function(numPersons){this._label&&this._label.remove();var text=numPersons&&1<numPersons?String(numPersons):"n",y="Aborted"==this.getNode().getLifeStatus()||"Miscarriage"==this.getNode().getLifeStatus()?this.getY()-12:this.getY(),x="Aborted"==this.getNode().getLifeStatus()?this.getX()+8:this.getX();this._label=editor.getPaper().text(x,y,text).attr(PedigreeEditorParameters.attributes.descendantGroupLabel),this._label.node.setAttribute("class","no-mouse-interaction")}}),PersonGroup=Class.create(Person,{initialize:function($super,x,y,id,properties){this._numPersons=1,this._comment="",this._type="PersonGroup",$super(x,y,id,properties)},_generateGraphics:function(x,y){return new PersonGroupVisuals(this,x,y)},isProband:function(){return!1},setNumPersons:function(numPersons){this._numPersons=numPersons,this.getGraphics().setNumPersons(numPersons)},getNumPersons:function(){return this._numPersons},setLifeStatus:function($super,newStatus){$super(newStatus),this.getGraphics().setNumPersons(this._numPersons)},getProperties:function($super){var info=$super();return info.numPersons=this.getNumPersons(),info},assignProperties:function($super,info){return!(!$super(info)||!info.numPersons)&&(this.getNumPersons()!=info.numPersons&&this.setNumPersons(info.numPersons),!0)},getSummary:function(){var disorders=[];this.getDisorders().forEach(function(disorder){var disorderName=editor.getDisorderLegend().getDisorder(disorder).getName();disorders.push({id:disorder,value:disorderName})});var cantChangeAdopted=this.isFetus()||editor.getGraph().hasToBeAdopted(this.getID());return{identifier:{value:this.getID()},comment:{value:this.getFirstName()},gender:{value:this.getGender()},external_ids:{value:this.getExternalID()},disorders:{value:disorders},disordersFullDetails:{value:this._disordersFullDetails},disorderType:{value:this.getDisorderType()},ethnicity:{value:this.getEthnicities()},adopted:{value:this.getAdopted(),inactive:cantChangeAdopted},comments:{value:this.getComments(),inactive:!1},state:{value:this.getLifeStatus()},numInGroup:{value:this.getNumPersons()},evaluatedGrp:{value:this.getEvaluated()}}}}),PersonPlaceholderVisuals=Class.create(PersonVisuals,{initialize:function($super,node,x,y){$super(node,x,y)},generateHoverbox:function(x,y){return new ReadOnlyHoverbox(this.getNode(),x,y,this.getGenderGraphics())},markPermanently:function(){},grow:function(){},setGenderGraphics:function(){this._genderGraphics&&this._genderGraphics.remove();var x=this.getX(),y=this.getY(),shape=editor.getPaper().rect(x-10,y-10,20,20).hide();this._genderShape=shape,this._genderGraphics=editor.getPaper().set(shape)},drawLabels:function(){for(var labels=this.getLabels(),i=0;i<labels.length;i++)labels[i].hide()}}),PersonPlaceholder=Class.create(Person,{initialize:function($super,x,y,id,properties){this._comment="",this._type="PersonPlaceholder",$super(x,y,id,{gender:"U"})},_generateGraphics:function(x,y){return new PersonPlaceholderVisuals(this,x,y)},isProband:function(){return!1},getProperties:function($super){var info={};return""!=this.getComments()&&(info.comments=this.getComments()),info.placeholder=!0,info},assignProperties:function($super,info){return $super(info)},getSummary:function(){return{type:{value:"placeholder"}}}}),View=Class.create({initialize:function(){console.log("--- view init ---"),this.preGenerateGraphics(),this._nodeMap={},this.hoverModeZones=editor.getPaper().set(),this._currentMarkedNew=[],this._currentGrownNodes=[],this._currentHoveredNode=null,this._currentDraggable=null,this._lineSet=new LineSet},getSettings:function(){return{colors:{disorders:editor.getDisorderLegend().getAllColors(),genes:editor.getGeneLegend().getAllColors(),cancers:editor.getCancerLegend().getAllColors()},names:{disorders:editor.getDisorderLegend().getAllNames()}}},loadSettings:function(settingsObject){settingsObject.hasOwnProperty("colors")&&(settingsObject.colors.hasOwnProperty("disorders")&&editor.getDisorderLegend().setAllPreferredColors(settingsObject.colors.disorders),settingsObject.colors.hasOwnProperty("genes")&&editor.getGeneLegend().setAllPreferredColors(settingsObject.colors.genes))},preGenerateGraphics:function(){this.__menuButton_svgPath="M1.213,5.849C1.213,5.849,1.213,5.849,1.213,5.849C1.213,5.849,1.213,5.848,1.213,5.848C1.213,5.848,1.213,5.849,1.213,5.849C1.213,5.849,1.213,5.849,1.213,5.849M1.213,5.848C1.213,5.848,4.676,9.3114,4.676,9.3114C4.676,9.3114,1.2126,12.774,1.2126,12.774C1.2126,12.774,2.486,14.048,2.486,14.048C2.486,14.048,7.222,9.311,7.222,9.311C7.222,9.311,2.486,4.574,2.486,4.574C2.486,4.574,1.213,5.848,1.213,5.8476C1.2131999999999998,5.8476,1.2131999999999998,5.8476,1.2131999999999998,5.8476M7.348799999999999,13.9614C7.348799999999999,13.9614,16.0002,13.9614,16.0002,13.9614C16.0002,13.9614,16.0002,12.161999999999999,16.0002,12.161999999999999C16.0002,12.161999999999999,7.348799999999999,12.161999999999999,7.348799999999999,12.161999999999999C7.348799999999999,12.161999999999999,7.348799999999999,13.9614,7.348799999999999,13.9614C7.348799999999999,13.9614,7.348799999999999,13.9614,7.348799999999999,13.9614M9.949799999999998,10.2114C9.949799999999998,10.2114,16.0002,10.2114,16.0002,10.2114C16.0002,10.2114,16.0002,8.411999999999999,16.0002,8.411999999999999C16.0002,8.411999999999999,9.949799999999998,8.411999999999999,9.949799999999998,8.411999999999999C9.949799999999998,8.411999999999999,9.949799999999998,10.2114,9.949799999999998,10.2114C9.949799999999998,10.2114,9.949799999999998,10.2114,9.949799999999998,10.2114M7.348799999999999,4.6613999999999995C7.348799999999999,4.6613999999999995,7.348799999999999,6.462,7.348799999999999,6.462C7.348799999999999,6.462,16.0002,6.462,16.0002,6.462C16.0002,6.462,16.0002,4.661,16.0,4.6614C16.0,4.6614,7.349,4.6614,7.349,4.6614C7.349,4.6614,7.349,4.6614,7.349,4.6614",this.__menuButton_BBox=Raphael.pathBBox(this.__menuButton_svgPath),this.__deleteButton_svgPath="M14.867,12.851C14.867,12.851,11.566,9.55,11.566,9.55C11.566,9.55,14.866,6.249,14.866,6.249C14.866,6.249,13.169,4.551,13.169,4.551C13.169,4.551,9.868,7.852,9.868,7.852C9.868,7.852,6.567,4.551,6.567,4.551C6.567,4.551,4.87,6.249,4.87,6.249C4.87,6.249,8.171,9.55,8.171,9.55C8.171,9.55,4.87,12.851,4.870,12.851C4.870,12.851,6.568,14.549,6.568,14.549C6.568,14.549,9.868,11.248,9.868,11.248C9.868,11.248,13.169,14.549,13.169,14.549C13.169,14.549,14.867,12.851,14.867,12.851",this.__deleteButton_BBox=Raphael.pathBBox(this.__deleteButton_svgPath),this.__arrow_svgPath="M8.348,23.029C8.348,23.029,0.791,30.584,0.791,30.584C0.791,30.584,3.515,33.308,3.515,33.308C3.515,33.308,11.07,25.752,11.0704,25.752C11.07,25.752,13.114,27.795,13.114,27.795C13.114,27.795,15.598,18.524,15.598,18.524C15.598,18.524,6.327,21.008,6.327,21.008C6.327,21.008,8.348,23.029,8.348,23.0285C8.348,23.029,8.348,23.029,8.348,23.029",this.__probandArrowPath=Raphael.transformPath(this.__arrow_svgPath,["s",1.1,1.1,0,0])},getNodeMap:function(){return this._nodeMap},getNode:function(nodeId){if(!this._nodeMap.hasOwnProperty(nodeId))throw console.log("ERROR: requesting non-existent node "+nodeId),"ERROR";return this._nodeMap[nodeId]},checkNodeExists:function(nodeId){return this._nodeMap.hasOwnProperty(nodeId)},getPersonNodeNear:function(x,y){for(var nodeID in this._nodeMap)if(this._nodeMap.hasOwnProperty(nodeID)){var node=this.getNode(nodeID);if(("Person"==node.getType()||"PersonGroup"==node.getType())&&node.getGraphics().containsXY(x,y))return node}return null},setAnonimizeStatus:function(status){for(var nodeID in this._nodeMap){if(this._nodeMap.hasOwnProperty(nodeID))this.getNode(nodeID).getGraphics().setAnonimizedStatus(status)}},getCurrentHoveredNode:function(){return this._currentHoveredNode},getCurrentDraggable:function(){return this._currentDraggable},setCurrentDraggable:function(draggable){this._currentDraggable=draggable},removeFromNodeMap:function(nodeID){delete this.getNodeMap()[nodeID]},drawCurvedLineWithCrossings:function(id,xFrom,yFrom,yTop,xTo,yTo,lastBend,attr,twoLines,secondLineBelow,startSameX){if(yFrom==yTop&&yFrom==yTo)return this.drawLineWithCrossings(id,xFrom,yFrom,xTo,yTo,attr,twoLines,secondLineBelow,!1,startSameX);var cornerRadius=.8*PedigreeEditorParameters.attributes.curvedLinesCornerRadius,goesRight=xTo<xFrom;if(isFinite(lastBend))var xFinalBend=goesRight?xTo+lastBend:xTo-lastBend,xFinalBendVert=goesRight?xTo+lastBend+cornerRadius:xTo-lastBend-cornerRadius,xBeforeFinalBend=goesRight?xTo+lastBend+2*cornerRadius:xTo-lastBend-2*cornerRadius;else xBeforeFinalBend=xTo;var xFromAndBit=goesRight?xFrom-cornerRadius/2:xFrom+cornerRadius/2,xFromAfterCorner=goesRight?xFromAndBit-cornerRadius:xFromAndBit+cornerRadius,xFromAfter2Corners=goesRight?xFromAndBit-2*cornerRadius:xFromAndBit+2*cornerRadius;yFrom<=yTop?this.drawLineWithCrossings(id,xFrom,yFrom,xBeforeFinalBend,yFrom,attr,twoLines,!goesRight,!0,startSameX):(this.drawLineWithCrossings(id,xFrom,yFrom,xFromAndBit,yFrom,attr,twoLines,!goesRight,!0,startSameX),Math.abs(yFrom-yTop)>=2*cornerRadius?(goesRight?GraphicHelpers.drawCornerCurve(xFromAndBit,yFrom,xFromAfterCorner,yFrom-cornerRadius,!0,attr,twoLines,-2.5,2.5,2.5,-2.5):GraphicHelpers.drawCornerCurve(xFromAndBit,yFrom,xFromAfterCorner,yFrom-cornerRadius,!0,attr,twoLines,2.5,2.5,-2.5,-2.5),this.drawLineWithCrossings(id,xFromAfterCorner,yFrom-cornerRadius,xFromAfterCorner,yTop+cornerRadius,attr,twoLines,goesRight),goesRight?GraphicHelpers.drawCornerCurve(xFromAfterCorner,yTop+cornerRadius,xFromAfter2Corners,yTop,!1,attr,twoLines,-2.5,2.5,2.5,-2.5):GraphicHelpers.drawCornerCurve(xFromAfterCorner,yTop+cornerRadius,xFromAfter2Corners,yTop,!1,attr,twoLines,2.5,2.5,-2.5,-2.5)):goesRight?GraphicHelpers.drawLevelChangeCurve(xFromAndBit,yFrom,xFromAfter2Corners,yTop,attr,twoLines,-2.5,2.5,2.5,-2.5):GraphicHelpers.drawLevelChangeCurve(xFromAndBit,yFrom,xFromAfter2Corners,yTop,attr,twoLines,2.5,2.5,-2.5,-2.5),this.drawLineWithCrossings(id,xFromAfter2Corners,yTop,xBeforeFinalBend,yTop,attr,twoLines,!goesRight,!0)),xBeforeFinalBend!=xTo&&(Math.abs(yTo-yTop)>=2*cornerRadius?(goesRight?GraphicHelpers.drawCornerCurve(xBeforeFinalBend,yTop,xFinalBendVert,yTop+cornerRadius,!0,attr,twoLines,2.5,2.5,-2.5,-2.5):GraphicHelpers.drawCornerCurve(xBeforeFinalBend,yTop,xFinalBendVert,yTop+cornerRadius,!0,attr,twoLines,2.5,-2.5,-2.5,2.5),this.drawLineWithCrossings(id,xFinalBendVert,yTop+cornerRadius,xFinalBendVert,yTo-cornerRadius,attr,twoLines,!goesRight),goesRight?GraphicHelpers.drawCornerCurve(xFinalBendVert,yTo-cornerRadius,xFinalBend,yTo,!1,attr,twoLines,2.5,2.5,-2.5,-2.5):GraphicHelpers.drawCornerCurve(xFinalBendVert,yTo-cornerRadius,xFinalBend,yTo,!1,attr,twoLines,2.5,-2.5,-2.5,2.5)):goesRight?GraphicHelpers.drawLevelChangeCurve(xBeforeFinalBend,yTop,xFinalBend,yTo,attr,twoLines,2.5,2.5,-2.5,-2.5):GraphicHelpers.drawLevelChangeCurve(xBeforeFinalBend,yTop,xFinalBend,yTo,attr,twoLines,2.5,-2.5,-2.5,2.5),this.drawLineWithCrossings(id,xFinalBend,yTo,xTo,yTo,attr,twoLines,!goesRight))},drawLineWithCrossings:function(owner,x1,y1,x2,y2,attr,twoLines,secondLineBelow,bothEndsGoDown,sameXStart){if(x2<x1||x1==x2&&y2<y1){var tx=x1,ty=y1;x1=x2,y1=y2,x2=tx,y2=ty}var isHorizontal=y1==y2,isVertical=x1==x2,intersections=this._lineSet.addLine(owner,x1,y1,x2,y2);intersections.sort(function(p1,p2){return(x1-p1.x)*(x1-p1.x)+(y1-p1.y)*(y1-p1.y)-((x1-p2.x)*(x1-p2.x)+(y1-p2.y)*(y1-p2.y))});for(var lineNum=0;lineNum<(twoLines?2:1);lineNum++){twoLines&&(bothEndsGoDown?(x1-=sameXStart&&secondLineBelow?0:2.5,x2+=sameXStart&&!secondLineBelow?0:2.5):(x1+=sameXStart&&!secondLineBelow?0:7.5*lineNum-2.5,x2+=sameXStart&&secondLineBelow?0:7.5*lineNum-2.5),secondLineBelow?(y1+=2.5-7.5*lineNum,y2+=2.5-7.5*lineNum):(y1+=7.5*lineNum-2.5,y2+=7.5*lineNum-2.5));for(var raphaelPath="M "+x1+" "+y1,i=0;i<intersections.length;i++){var intersectPoint=intersections[i],distance=function(p1,p2){return(p1.x-p2.x)*(p1.x-p2.x)+(p1.y-p2.y)*(p1.y-p2.y)},noCrossSymbolProximity=isHorizontal?400:81;distance(intersectPoint,{x:x1,y:y1})<noCrossSymbolProximity||(distance(intersectPoint,{x:x2,y:y2})<noCrossSymbolProximity||(isHorizontal?(twoLines&&(intersectPoint.y+=secondLineBelow?2.5-7.5*lineNum:7.5*lineNum-2.5),raphaelPath+=" L "+(intersectPoint.x-10)+" "+intersectPoint.y,raphaelPath+=" C "+(intersectPoint.x-7)+" "+(intersectPoint.y+1)+" "+(intersectPoint.x-7)+" "+(intersectPoint.y-7)+" "+intersectPoint.x+" "+(intersectPoint.y-7),raphaelPath+=" C "+(intersectPoint.x+7)+" "+(intersectPoint.y-7)+" "+(intersectPoint.x+7)+" "+(intersectPoint.y+1)+" "+(intersectPoint.x+10)+" "+intersectPoint.y):isVertical&&(twoLines&&(intersectPoint.x+=7.5*lineNum-2.5),raphaelPath+=" L "+intersectPoint.x+" "+(intersectPoint.y-10),raphaelPath+=" C "+(intersectPoint.x-1)+" "+(intersectPoint.y-7)+" "+(intersectPoint.x+7)+" "+(intersectPoint.y-7)+" "+(intersectPoint.x+7)+" "+intersectPoint.y,raphaelPath+=" C "+(intersectPoint.x+7)+" "+(intersectPoint.y+7)+" "+(intersectPoint.x-1)+" "+(intersectPoint.y+7)+" "+intersectPoint.x+" "+(intersectPoint.y+10))))}raphaelPath+=" L "+x2+" "+y2,editor.getPaper().path(raphaelPath).attr(attr).toBack()}},addNode:function(id){var node,positionedGraph=editor.getGraph();if(!positionedGraph.isValidID(id))throw"addNode(): Invalid id";var properties=positionedGraph.getProperties(id),graphPos=positionedGraph.getPosition(id),position=editor.convertGraphCoordToCanvasCoord(graphPos.x,graphPos.y);if(positionedGraph.isRelationship(id))node=new Partnership(position.x,position.y,id,properties);else if(positionedGraph.isPlaceholder(id))node=new PersonPlaceholder(position.x,position.y,id,properties);else if(positionedGraph.isPersonGroup(id))node=new PersonGroup(position.x,position.y,id,properties);else{if(!positionedGraph.isPerson(id))throw"addNode(): unsupported node type";node=new Person(position.x,position.y,id,properties)}return this.getNodeMap()[id]=node},moveNode:function(id,animate){var graphPos=editor.getGraph().getPosition(id),position=editor.convertGraphCoordToCanvasCoord(graphPos.x,graphPos.y);this.checkNodeExists(id)&&this.getNode(id).setPos(position.x,position.y,animate)},changeNodeIds:function(changedIdsSet){var newNodeMap={};for(oldID in this._nodeMap){var node=this.getNode(oldID),newID=changedIdsSet.hasOwnProperty(oldID)?changedIdsSet[oldID]:oldID;node.setID(newID),newNodeMap[newID]=node}this._nodeMap=newNodeMap,this._lineSet.replaceIDs(changedIdsSet),editor.getCancerLegend().replaceIDs(changedIdsSet),editor.getGeneLegend().replaceIDs(changedIdsSet),editor.getHPOLegend().replaceIDs(changedIdsSet),editor.getDisorderLegend().replaceIDs(changedIdsSet)},enterHoverMode:function(sourceNode,hoverType){var me=this;this.getValidDragTargets(sourceNode.getID(),hoverType).each(function(nodeID){me._currentGrownNodes.push(nodeID);var node=me.getNode(nodeID);node.getGraphics().grow();var hoverModeZone=node.getGraphics().getHoverBox().getHoverZoneMask().clone().toFront();hoverModeZone.hover(function(){me._currentHoveredNode=nodeID,node.getGraphics().getHoverBox().setHighlighted(!0)},function(){me._currentHoveredNode=null,node.getGraphics().getHoverBox().setHighlighted(!1)}),me.hoverModeZones.push(hoverModeZone)})},exitHoverMode:function(){this._currentHoveredNode=null,this.hoverModeZones.remove();var me=this;this._currentGrownNodes.each(function(nodeID){var node=me.getNode(nodeID);node.getGraphics().shrink(),node.getGraphics().getHoverBox().setHighlighted(!1)}),this._currentGrownNodes=[]},unmarkAll:function(){for(var i=0;i<this._currentMarkedNew.length;i++){this.getNode(this._currentMarkedNew[i]).getGraphics().unmark()}this._currentMarkedNew=[]},getValidDragTargets:function(sourceNodeID,hoverType){var result=[];switch(hoverType){case"sibling":result=editor.getGraph().getPossibleSiblingsOf(sourceNodeID);break;case"child":result=editor.getGraph().getPossibleChildrenOf(sourceNodeID);break;case"parent":result=editor.getGraph().getPossibleParentsOf(sourceNodeID);break;case"partnerR":case"partnerL":result=editor.getGraph().getPossiblePartnersOf(sourceNodeID);break;case"PlaceHolder":throw"TODO";default:throw"Incorrect hoverType"}return result},applyChanges:function(changeSet,markNew){if(!Helpers.isObjectEmpty(changeSet)){var timer=new Helpers.Timer,timer2=new Helpers.Timer;if(this.unmarkAll(),changeSet.hasOwnProperty("moved")||(changeSet.moved=[]),changeSet.hasOwnProperty("removed")||(changeSet.removed=[]),changeSet.hasOwnProperty("changedIDSet")||(changeSet.changedIDSet={}),changeSet.hasOwnProperty("new")||(changeSet.new=[]),changeSet.hasOwnProperty("removed")){for(var affectedByLineRemoval={},i=0;i<changeSet.removed.length;i++){var nextRemoved=changeSet.removed[i];this.getNodeMap()[nextRemoved].remove(),this.removeFromNodeMap(nextRemoved);for(var affected=this._lineSet.removeAllLinesAffectedByOwnerMovement(nextRemoved),j=0;j<affected.length;j++)Helpers.arrayContains(changeSet.removed,affected[j])||(affectedByLineRemoval[affected[j]]=!0)}for(var node in this.changeNodeIds(changeSet.changedIDSet),affectedByLineRemoval)if(affectedByLineRemoval.hasOwnProperty(node)){var newID=changedIDs.hasOwnProperty(node)?changedIDs[node]:node;Helpers.arrayContains(changeSet.moved,newID)||changeSet.moved.push(newID)}}timer.printSinceLast("=== Removal runtime: ");var movedPersons=[],movedRelationships=[],newPersons=[],newRelationships=[],animate={};if(changeSet.hasOwnProperty("moved")){for(i=0;i<changeSet.moved.length;i++){var nextMoved=changeSet.moved[i];if(editor.getGraph().isRelationship(nextMoved))for(affected=this._lineSet.removeAllLinesAffectedByOwnerMovement(nextMoved),j=0;j<affected.length;j++){node=affected[j];Helpers.arrayContains(changeSet.moved,node)||changeSet.moved.push(node)}}for(i=0;i<changeSet.moved.length;i++){nextMoved=changeSet.moved[i];editor.getGraph().isRelationship(nextMoved)?movedRelationships.push(nextMoved):movedPersons.push(nextMoved)}}if(console.log("moved: "+Helpers.stringifyObject(changeSet.moved)),changeSet.hasOwnProperty("new"))for(i=0;i<changeSet.new.length;i++){var nextNew=changeSet.new[i];editor.getGraph().isRelationship(nextNew)?newRelationships.push(nextNew):newPersons.push(nextNew)}timer.printSinceLast("=== Bookkeeping/sorting runtime: ");for(i=0;i<movedPersons.length;i++)this.moveNode(movedPersons[i],animate.hasOwnProperty(movedPersons[i]));timer.printSinceLast("=== Move persons runtime: ");for(i=0;i<newPersons.length;i++){var newPerson=this.addNode(newPersons[i]);markNew&&(newPerson.getGraphics().markPermanently(),this._currentMarkedNew.push(newPersons[i]))}timer.printSinceLast("=== New persons runtime: ");for(i=0;i<movedRelationships.length;i++)this.moveNode(movedRelationships[i]);timer.printSinceLast("=== Move rels runtime: ");for(i=0;i<newRelationships.length;i++)this.addNode(newRelationships[i]);if(timer.printSinceLast("=== New rels runtime: "),changeSet.hasOwnProperty("highlight"))for(i=0;i<changeSet.highlight.length;i++){var nextHighlight=changeSet.highlight[i];this.getNode(nextHighlight).getGraphics().markPermanently(),this._currentMarkedNew.push(nextHighlight)}if(!editor.isReadOnlyMode()){for(var nodeID in this._nodeMap)this._nodeMap.hasOwnProperty(nodeID)&&editor.getGraph().isPerson(nodeID)&&!this.getNode(nodeID).getGraphics().getHoverBox().isMenuToggled()&&(this.getNode(nodeID).getGraphics().getHoverBox().removeButtons(),this.getNode(nodeID).getGraphics().getHoverBox().removeHandles());editor.getController().handleRenumber({memo:{check:!0,noUndoRedo:!0}}),timer.printSinceLast("=== highlight & update handles runtime: ")}timer2.printSinceLast("=== Total apply changes runtime: ")}}}),SVGWrapper=Class.create({initialize:function(svgText,boundingBox,scale){this._svgText=svgText,this._bbox={x:boundingBox.x,y:boundingBox.y,height:boundingBox.height,width:boundingBox.width},this._scale=scale||1},getSVGText:function(){return this._svgText},getBBox:function(){return Helpers.cloneObject(this._bbox)},getCopy:function(){return new SVGWrapper(this._svgText,this._bbox,this._scale)},setNoAspectRatioPreservation:function(){return this._svgText=this._svgText.replace(/preserveAspectRatio="xMinYMin"/,'preserveAspectRatio="none"'),this},move:function(xShift,yShift){this._bbox.x+=xShift,this._bbox.y+=yShift},scale:function(scaleFactor){return this._scale=scaleFactor,this._bbox.width=Math.ceil(this._bbox.width*scaleFactor),this._bbox.height=Math.ceil(this._bbox.height*scaleFactor),this._svgText=this._svgText.replace(/(<svg [^<>]+) width=["-]?\d+"? height=["-]?\d+"?/g,'$1 width="'+this._bbox.width+'" height="'+this._bbox.height+'"'),this},setViewBox:function(xOffset,yOffset,xWidth,yWidth){return xWidth=Math.ceil(xWidth),yWidth=Math.ceil(yWidth),this._svgText=this._svgText.replace(/(<svg[^<>]+) viewBox="[^<>"]*"/g,'$1 viewBox="'+Math.floor(this._bbox.x+xOffset/this._scale)+" "+Math.floor(this._bbox.y+yOffset/this._scale)+" "+xWidth/this._scale+" "+yWidth/this._scale+'"'),this._svgText=this._svgText.replace(/(<svg [^<>]+) width=["-]?\d+"? height=["-]?\d+"?/g,'$1 width="'+xWidth+'" height="'+yWidth+'"'),this},addCenteringCSS:function(){return this._svgText=this._svgText.replace(/(<svg [^<>]+) style="/,'$1 style="display:block; margin: auto; '),this}}),PedigreeEditorTool=window.PedigreeEditorTool;function initializeEthnicitiesAndCreateEditor(){var webservice=new WebService;return new Ajax.Request(webservice.getEthnicityLookupPath(),{method:"GET",headers:{Authorization:PedigreeEditorTool.accessToken},requestHeaders:{Accept:"application/json","Access-Control-Allow-Origin":"*",Authorization:PedigreeEditorTool.accessToken},contentType:"application/x-www-form-urlencoded",onSuccess:function(response){console.log(response),PedigreeEditorTool.ethnicityList=response.responseJSON,editor=new PedigreeEditor;var legendContainer=document.getElementById("legend-container"),canvasContainer=document.getElementById("work-area"),clinicalIndicationDiv=new Element("div",{class:"clinical-indication-name",id:"clinical-indication-name"});clinicalIndicationDiv.innerHTML="Clinical Indication Name",legendContainer.insertBefore(clinicalIndicationDiv,legendContainer.firstElementChild);var clinicalIndicationNames=document.getElementsByName("clinicalIndicationName"),clinicalIndicationValue=document.getElementById("clinical-indication-name").innerHTML;clinicalIndicationNames&&!clinicalIndicationNames.forEach&&(clinicalIndicationNames=[].slice.call(clinicalIndicationNames)),clinicalIndicationNames.forEach(function(clinicalIndicationName){clinicalIndicationName.value=clinicalIndicationValue});var canvasSideBar=new Element("div",{class:"canvas-sidebar-container",id:"canvas-sidebar-container"});canvasSideBar.innerHTML='<div id="canvas-clinical-indication-name" class="sidebar-item">Clinical Indication Name</div><div id="canvas-test-request-simple-id" class="sidebar-item"> Test Request Simple Id</div>',canvasContainer.insertBefore(canvasSideBar,canvasContainer.firstElementChild),document.getElementById(PedigreeEditorTool.divId).className="pedigree-tool skin-colibri wiki-xwiki space-data viewbody hidelefthideright panel-left-width-Medium panel-right-width-Medium";var parentNode=document.getElementById(PedigreeEditorTool.divId).parentNode;parentNode&&(parentNode.style.maxWidth="970px");console.log("CONSTANTS:",CONSTANTS),"object"==typeof CONSTANTS&&""!=CONSTANTS.PEDIGREE_TOOL_URL&&void 0!==CONSTANTS.PEDIGREE_TOOL_URL&&["/pedigree-ui/resources/font-awesome/css/font-awesome.min.css","/pedigree-ui/css/style.min.css","/pedigree-ui/css/colibri-ie-all.min.css"].forEach(function(src){if(src=CONSTANTS.PEDIGREE_TOOL_URL+src,!Utils.checkIfCssExist(src))if(console.log("adding stylesheet:"+src),document.createStyleSheet)document.createStyleSheet(src);else{var stylesheet=document.createElement("link");stylesheet.href=src,stylesheet.rel="stylesheet",stylesheet.type="text/css",document.getElementsByTagName("head")[0].appendChild(stylesheet)}})},onFailure:function(response){console.error("FAILURE",response)}})}function initializeEditor(accessToken,id,divId,referralId,currentPatientId,accessRefreshFunction,standalone,hostSaveFunc){var urlParams=new URLSearchParams(window.location.search);PedigreeEditorTool={accessToken:accessToken,id:id,divId:divId,testRequestId:referralId||$ESAPI.encoder().encodeForHTML(urlParams.get("testRequestId")),currentPatientId:currentPatientId,accessRefreshFunction:accessRefreshFunction,standalone:standalone,save:hostSaveFunc,isDirty:window.pedigreeStatus.isDirty},initializeEthnicitiesAndCreateEditor()}window.PedigreeEmbeddedWidth=800;var Workspace=Class.create({initialize:function(){var me=this;this._settings=new Settings,this.canvas=new Element("div",{id:"canvas"}),this.workArea=new Element("div",{id:"work-area"}).update(this.canvas),document.getElementById(PedigreeEditorTool.divId).update(this.workArea);var screenDimensions=document.viewport.getDimensions();this.topMenu=this.generateTopMenu();Utils.getOffsetFromHost();this.width=PedigreeEditorTool.standalone?screenDimensions.width:PedigreeEmbeddedWidth,this.height=screenDimensions.height-this.canvas.cumulativeOffset().top-4,this._paper=Raphael("canvas",this.width,this.height),this.viewBoxX=0,this.viewBoxY=0,this.zoomCoefficient=1,this.disablePan=!1,this.background=this.getPaper().rect(0,0,this.width,this.height).attr({fill:"blue",stroke:"none",opacity:0}).toBack(),this.background.node.setAttribute("class","panning-background"),this.adjustSizeToScreen=this.adjustSizeToScreen.bind(this),Event.observe(window,"resize",me.adjustSizeToScreen),this.generateViewControls();me.background.drag(function(dx,dy){if(editor.isAnyMenuVisible()||me.disablePan)me.disablePan=!0;else{var deltax=me.viewBoxX-dx/me.zoomCoefficient,deltay=me.viewBoxY-dy/me.zoomCoefficient;me.getPaper().setViewBox(deltax,deltay,me.width/me.zoomCoefficient,me.height/me.zoomCoefficient),me.background.ox=deltax,me.background.oy=deltay,me.background.attr({x:deltax,y:deltay})}},function(){me.background.ox=me.background.attr("x"),me.background.oy=me.background.attr("y"),editor.isAnyMenuVisible()?me.disablePan=!0:me.background.attr({cursor:"move"})},function(){me.viewBoxX=me.background.ox,me.viewBoxY=me.background.oy,me.background.attr({cursor:"default"}),me.disablePan=!1}),document.addEventListener&&(me.handleMouseWheel=function(evt){if(evt.preventDefault?evt.preventDefault():evt.returnValue=!1,!editor.isAnyMenuVisible())if(0<(evt.wheelDelta?-evt.wheelDelta:evt.detail)){$$(".zoom-out")[0];$$(".zoom-out")[0].click()}else $$(".zoom-in")[0].click()},0<=navigator.userAgent.toLowerCase().indexOf("webkit")?this.canvas.addEventListener("mousewheel",me.handleMouseWheel,!1):this.canvas.addEventListener("DOMMouseScroll",me.handleMouseWheel,!1))},getSVGCopy:function(anonimize){editor.getView().unmarkAll();var image=$("canvas"),background=image.getElementsByClassName("panning-background")[0];background.style.display="none",anonimize&&editor.getView().setAnonimizeStatus(!0);var _bbox=image.down().getBBox(),bbox={};bbox.x=Math.floor(_bbox.x)-2,bbox.y=Math.floor(_bbox.y)-2,bbox.width=Math.ceil(_bbox.width)+4,bbox.height=Math.ceil(_bbox.height)+4;var svgText=image.innerHTML.replace(/xmlns(:xlink)?=".*?"/g,"").replace(/width=".*?"/,"").replace(/height=".*?"/,"").replace(/viewBox=".*?"/,'viewBox="'+bbox.x+" "+bbox.y+" "+bbox.width+" "+bbox.height+'" width="'+bbox.width+'" height="'+bbox.height+'" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg"');return anonimize&&editor.getView().setAnonimizeStatus(!1),svgText=(svgText=(svgText=(svgText=(svgText=(svgText=(svgText=(svgText=(svgText=(svgText=svgText.replace(/(<svg[^<>]+style=")/g,"$1display:block; ")).replace(/<[^<>]+display: ?none;[^<>]+([^/]><\/\w+|\/)>/g,"")).replace(/<[^<>]+[" ]opacity: ?0;[^<>]+([^/]><\/\w+|\/)>/g,"")).replace(/<circle [^<>]+pedigree-partnership-circle[^<>]+([^/]><\/\w+|\/)>/g,"")).replace(/<a [^<>]*xlink:title=[^<>]+([^/]><\/\w+|\/)>/g,"")).replace(/<[^<>]+pedigree-hoverbox[^<>]+([^/]><\/\w+|\/)>/g,"")).replace(/<[^<>]+pedigree-node-shadow[^<>]+([^/]><\/\w+|\/)>/g,"")).replace(/<linearGradient.*<\/linearGradient>/g,"")).replace(/<radialGradient.*?<\/radialGradient>/g,"")).replace(/<desc>[^<>]+<\/desc>/g,""),background.style.display="",new SVGWrapper(svgText,bbox,1)},getPaper:function(){return this._paper},getWorkArea:function(){return this.workArea},getWidth:function(){return this.width},getHeight:function(){return this.height},generateTopMenu:function(){var menu=new Element("div",{class:"editor-menu"});this.getWorkArea().insert({before:menu});var secondaryMenu=new Element("div",{class:"editor-menu editor-menu-secondary"});this.getWorkArea().insert({before:secondaryMenu}),secondaryMenu.hide();var menuItems=[];menuItems=editor.isUnsupportedBrowser()?[{name:"input",items:[{key:"readonlymessage",label:"Unsuported browser mode",icon:"exclamation-triangle"}]},{name:"output",items:[{key:"export",label:"Export",icon:"download"},{key:"close",label:"Close",icon:"sign-out"}]}]:[{name:"edit",items:[{key:"undo",label:"Undo",icon:"undo"},{key:"redo",label:"Redo",icon:"repeat"},{key:"reset",label:"Reset",icon:"unlock"}]},{name:"print",items:[{key:"print",label:"Print",icon:"print"}]},{name:"output",items:[{key:"saveAndExit",label:"Save",icon:"check"},{key:"export",label:"Export",icon:"download"},{key:"close",label:"Close",icon:"sign-out"}]},{name:"details",items:[{key:"familyId",label:"",isTextOnly:!0}]},{name:"version",items:[{key:"version",label:"NGIS Editor Based on Version: "+this._settings.getSetting("version"),isTextOnly:!0}]}];var secondaryMenuItems=[];editor.isUnsupportedBrowser()||(secondaryMenuItems=[]);var _createSubmenu=function(data){var submenu=new Element("div",{class:data.name+"-actions action-group"});this.insert(submenu),data.items.each(function(item){submenu.insert(_createMenuItem(item))})},_createMenuItem=function(data){var settings=new Settings;if(data.isTextOnly)return mi=new Element("span",{id:"text-"+data.key,class:"menu-item-text-only"}).insert(data.label);if(!0===settings.getSetting("saveAndExit")){if("save"==data.key||"close"==data.key)return}else if("saveAndExit"==data.key)return;var buttonIcon=new Element("span",{class:"fa fa-"+data.icon}),mi=new Element("span",{id:"action-"+data.key,class:"field-no-user-select menu-item "+data.key}).insert(buttonIcon).insert(" ").insert(data.label);return data.callback&&"function"==typeof data.callback&&mi.observe("click",function(){data.callback(mi,buttonIcon)}),mi};return menuItems.each(_createSubmenu.bind(menu)),secondaryMenuItems.each(_createSubmenu.bind(secondaryMenu)),menu},setMenuText:function(testRequestId,familyId){if(this.topMenu){var span=this.topMenu.select("span#text-familyId");if(span&&0<span.length){var label="";0<testRequestId.length&&(label="Test Request ID: "+testRequestId),span[0].update(label)}}},setClinicalIndicationNameText:function(clinicalIndicationName){if(console.log($(".clinicalIndicationName")),document.getElementsByClassName("clinical-indication-name")[0]){document.getElementsByClassName("clinical-indication-name")[0].innerHTML=$ESAPI.encoder().encodeForHTML(clinicalIndicationName);var clinicalIndiciationColor=new Element("span",{class:"abnormality-color clinical-indication-color"});document.getElementsByClassName("clinical-indication-name")[0].appendChild(clinicalIndiciationColor)}},clearMenuText:function(){if(this.topMenu){var span=this.topMenu.select("span#text-familyId");span&&0<span.length&&span[0].update("")}},zoom:function(zoomCoefficient){zoomCoefficient<.15&&(zoomCoefficient=.15),.15<zoomCoefficient&&zoomCoefficient<.25&&(zoomCoefficient=.25),zoomCoefficient=Math.round(zoomCoefficient/.05)/20;var newWidth=this.width/zoomCoefficient,newHeight=this.height/zoomCoefficient,offsets=Utils.getOffsetFromHost();0==this.viewBoxX&&(this.viewBoxX=-offsets.x),0==this.viewBoxY&&(this.viewBoxY=-offsets.y),this.viewBoxX=this.viewBoxX+(this.width/this.zoomCoefficient-newWidth)/2,this.viewBoxY=this.viewBoxY+(this.height/this.zoomCoefficient-newHeight)/2,this.getPaper().setViewBox(this.viewBoxX,this.viewBoxY,newWidth,newHeight),this.zoomCoefficient=zoomCoefficient,this.background.attr({x:this.viewBoxX,y:this.viewBoxY,width:newWidth,height:newHeight})},enableReset:function(enabled){var span=document.getElementById("action-reset");console.log("spacn="+span),span&&(span.style.display=enabled?"":"none")},generateViewControls:function(){var _this=this;this.__controls=new Element("div",{class:"view-controls"}),this.__pan=new Element("div",{class:"view-controls-pan",title:"Pan"}),this.__controls.insert(this.__pan),["up","right","down","left","home"].each(function(direction){var faIconClass="home"==direction?"fa-user":"fa-arrow-"+direction;_this.__pan[direction]=new Element("span",{class:"view-control-pan pan-"+direction+" fa fa-fw "+faIconClass,title:"Pan "+direction}),_this.__pan.insert(_this.__pan[direction]),_this.__pan[direction].observe("click",function(event){"home"==direction?_this.centerAroundNode(0):"up"==direction?_this.panTo(_this.viewBoxX,_this.viewBoxY-150):"down"==direction?_this.panTo(_this.viewBoxX,_this.viewBoxY+150):"left"==direction?_this.panTo(_this.viewBoxX-150,_this.viewBoxY):_this.panTo(_this.viewBoxX+150,_this.viewBoxY)})});this.__zoom=new Element("div",{class:"view-controls-zoom",title:"Zoom"}),this.__controls.insert(this.__zoom),this.__zoom.track=new Element("div",{class:"zoom-track"}),this.__zoom.handle=new Element("div",{class:"zoom-handle",title:"Drag to zoom"}),this.__zoom.in=new Element("div",{class:"zoom-button zoom-in fa fa-fw fa-search-plus",title:"Zoom in"}),this.__zoom.out=new Element("div",{class:"zoom-button zoom-out fa fa-fw fa-search-minus",title:"Zoom out"}),this.__zoom.label=new Element("div",{class:"zoom-crt-value"}),this.__zoom.insert(this.__zoom.in),this.__zoom.insert(this.__zoom.track),this.__zoom.track.insert(this.__zoom.handle),this.__zoom.track.style.height="200px",this.__zoom.insert(this.__zoom.out),this.__zoom.insert(this.__zoom.label),this.zoomSlider=new Control.Slider(this.__zoom.handle,this.__zoom.track,{axis:"vertical",minimum:0,maximum:200,increment:1,alignY:6,onSlide:function(value){value<=.9?_this.zoom(-value/.9+1.25):_this.zoom(.15)},onChange:function(value){value<=.9?_this.zoom(-value/.9+1.25):_this.zoom(.15)}}),editor.isUnsupportedBrowser()?this.zoomSlider.setValue(.225):this.zoomSlider.setValue(.45),this.__zoom.in.observe("click",function(event){_this.zoomCoefficient<.25?_this.zoomSlider.setValue(.9):_this.zoomSlider.setValue(.9*-(_this.zoomCoefficient-1))}),this.__zoom.out.observe("click",function(event){_this.zoomCoefficient<=.25?_this.zoomSlider.setValue(1):_this.zoomSlider.setValue(.9*-(_this.zoomCoefficient-1.5))}),this.getWorkArea().insert(this.__controls)},getSizeNormalizedToDefaultZoom:function(pixelSizeAtDefaultZoom){return pixelSizeAtDefaultZoom},getCurrentZoomLevel:function(pixelSizeAtDefaultZoom){return this.zoomCoefficient},canvasToDiv:function(canvasX,canvasY){return{x:this.zoomCoefficient*(canvasX-this.viewBoxX),y:this.zoomCoefficient*(canvasY-this.viewBoxY)}},divToCanvas:function(divX,divY){return{x:divX/this.zoomCoefficient+this.viewBoxX,y:divY/this.zoomCoefficient+this.viewBoxY}},viewportToDiv:function(absX,absY){return{x:+absX-this.canvas.cumulativeOffset().left,y:absY-this.canvas.cumulativeOffset().top}},panTo:function(x,y,instant){var me=this,xDisplacement=x-this.viewBoxX,yDisplacement=y-this.viewBoxY;editor.isUnsupportedBrowser()&&(instant=!0);var numSeconds=instant?0:.4,frames=instant?1:11,xStep=xDisplacement/frames,yStep=yDisplacement/frames;if(0!=xStep||0!=yStep){var progress=0;!function draw(){setTimeout(function(){progress++<frames&&(me.viewBoxX+=xStep,me.viewBoxY+=yStep,me.getPaper().setViewBox(me.viewBoxX,me.viewBoxY,me.width/me.zoomCoefficient,me.height/me.zoomCoefficient),me.background.attr({x:me.viewBoxX,y:me.viewBoxY}),draw())},1e3*numSeconds/frames)}()}},panByX:function(deltaX,instant){this.panTo(this.viewBoxX+Math.floor(deltaX/this.zoomCoefficient),this.viewBoxY,instant)},adjustSizeToScreen:function(){var screenDimensions=document.viewport.getDimensions();Utils.getOffsetFromHost();this.width=PedigreeEditorTool.standalone?screenDimensions.width:PedigreeEmbeddedWidth,this.height=screenDimensions.height-this.canvas.cumulativeOffset().top-4,this.getPaper().setSize(this.width,this.height),this.getPaper().setViewBox(this.viewBoxX,this.viewBoxY,this.width/this.zoomCoefficient,this.height/this.zoomCoefficient),this.background&&this.background.attr({width:this.width,height:this.height}),editor.getNodeMenu()&&editor.getNodeMenu().reposition()},centerAroundNode:function(nodeID,instant,xCenterShift,yCenterShift){var node=editor.getNode(nodeID);if(node){var x=node.getX(),y=node.getY();xCenterShift||(xCenterShift=0),yCenterShift||(yCenterShift=0);var xOffset=this.getWidth()/this.zoomCoefficient,yOffset=this.getHeight()/this.zoomCoefficient;this.panTo(x-xOffset/2-xCenterShift,y-yOffset/2-yCenterShift,instant)}}}),CancerLegend=Class.create(Legend,{initialize:function($super){this._cancerColors={Breast:"#e267a3",Ovarian:"#9370DB",Colon:"#945d34",Uterus:"#c93320",Prostate:"#ecb739",Pancreatic:"#4657dc",Melanoma:"#444444",Kidney:"#197419",Gastric:"#9aac8c",Lung:"#008080",Brain:"#F5DEB3",Oesophagus:"#BC8F8F",Thyroid:"#FFFF00"},this._cancerLabels={Breast:"Breast cancer",Ovarian:"Ovarian cancer",Colon:"Colon cancer",Uterus:"Uterus cancer",Prostate:"Prostate cancer",Pancreatic:"Pancreatic cancer",Melanoma:"Melanoma",Kidney:"Kidney cancer",Gastric:"Gastric cancer",Lung:"Lung cancer",Brain:"Brain cancer",Oesophagus:"Oesophagus cancer",Thyroid:"Thyroid cancer"},$super("Cancers",!0)},_getPrefix:function(id){return"cancers"},_getAllSupportedCancers:function(){var clist=[];for(var cancer in this._cancerColors)this._cancerColors.hasOwnProperty(cancer)&&clist.push(cancer);return clist},addCase:function($super,id,name,valueAll,nodeID){},_generateElement:function($super,cancerID,name){if(!this._objectColors.hasOwnProperty(cancerID)){var color=this._generateColor(cancerID);this._objectColors[cancerID]=color,document.fire("cancer:color",{id:cancerID,color:color})}return $super(cancerID,name)},_onDropObject:function(node,cancerID){if(!node.isPersonGroup()){var currentCancers=Helpers.cloneObject(node.getCancers());if(currentCancers.hasOwnProperty(cancerID)&&currentCancers[cancerID].affected)this._onFailedDrag(node,"This person is already marked as affected by the selected cancer","Can't drag this cancer to this person");else{currentCancers[cancerID]={affected:!0},editor.getView().unmarkAll();var properties={setCancers:currentCancers},event={nodeID:node.getID(),properties:properties};document.fire("pedigree:node:setproperty",event)}}},_generateColor:function(cancerID){if(this._objectColors.hasOwnProperty(cancerID))return this._objectColors[cancerID];if(this._cancerColors.hasOwnProperty(cancerID))return this._cancerColors[cancerID];var usedColors=Object.values(this._objectColors),prefColors=["#f8ebb7","#eac080","#bf6632","#a47841","#c95555","#ae6c57"];if(usedColors.each(function(color){prefColors=prefColors.without(color)}),0<prefColors.length)return prefColors[0];for(var randomColor=Raphael.getColor();"#ffffff"==randomColor||-1!=usedColors.indexOf(randomColor);)randomColor="#"+((1<<24)*Math.random()|0).toString(16);return randomColor}}),PrintEngine=Class.create({initialize:function(){this.printPageWidth=1055,this.printPageHeight=756,this.printPageWidthPortrait=756,this.printPageHeightPortrait=980,this.xOverlap=32,this.yOverlap=32},_generatePages:function(scale,moveHorizontallySize,pageWidth,pageHeight,options,emulateFullPage,scaleComparedToPrint){var totalLegendHeight=0,patientInfoHeight=0,legendHTML="",patientInfoHTML="";if(options.includeLegend){var legendData=editor.getView().getSettings(),generateSection=function(colors,names,sectionName){var count=0,height=30,html="<div class='legend-section'><h3 class='section-title'>"+sectionName+"</h3><ul class='abnormality-list'>";for(var id in colors){if(colors.hasOwnProperty(id))count++,html+="<li class='abnormality'>",html+="<span class='abnormality-color'><svg height='13' width='13' style='display: inline-block;'><rect x='0' y='0' rx='6' ry='6' width='13' height='13' fill='"+colors[id]+"'></rect></svg></span>",html+="<span class='legend-item-name'>"+(names&&names.hasOwnProperty(id)?names[id]:id)+"</span>",height+=20}return html+="</ul></div>",0<count?{html:html,heightInPixels:height}:{html:"",heightInPixels:0}},sections=[];legendData.hasOwnProperty("colors")&&(legendData.colors.hasOwnProperty("disorders")&&sections.push(generateSection(legendData.colors.disorders,legendData.names.disorders,"Disorders")),legendData.colors.hasOwnProperty("genes")&&sections.push(generateSection(legendData.colors.genes,null,"Genes")),legendData.colors.hasOwnProperty("phenotypes")&&sections.push(generateSection(legendData.colors.phenotypes,null,"Phenotypes")),legendData.colors.hasOwnProperty("cancers")&&sections.push(generateSection(legendData.colors.cancers,null,"Cancers")));for(var i=0;i<sections.length;i++)totalLegendHeight+=sections[i].heightInPixels,legendHTML+=sections[i].html}if(options.includePatientInfo){patientInfoHeight=30;var proband=editor.getNode(0);if(options.anonimize||!proband.getFirstName()&&!proband.getLastName()){patientInfoHTML="Participant "+proband.getParticipantId();var familyId=proband.getFamilyId();familyId&&0<familyId.length&&(patientInfoHTML=patientInfoHTML+" (FamilyId: "+familyId+")")}else{var space=proband.getFirstName()&&proband.getLastName()?" ":"";patientInfoHTML=proband.getFirstName()+space+proband.getLastName()+", "+XWiki.currentDocument.page}var userFirstName=editor.getPreferencesManager().getConfigurationOption("firstName"),userLastName=editor.getPreferencesManager().getConfigurationOption("lastName"),date=new PedigreeDate(new Date);patientInfoHTML+=". Printed",(userFirstName||userLastName)&&(patientInfoHTML+=" by "+userFirstName+" "+userLastName);var dateDisplayFormat=editor.getPreferencesManager().getConfigurationOption("dateDisplayFormat");patientInfoHTML+="DMY"==dateDisplayFormat||"MY"==dateDisplayFormat?" on "+date.getBestPrecisionStringDDMMYYY()+".":" on "+date.getMonthName()+" "+date.getDay()+", "+date.getYear()+"."}var svg=editor.getWorkspace().getSVGCopy(options.anonimize);svg.scale(scale),svg.move(moveHorizontallySize,0);svg.getSVGText();var bbox=svg.getBBox(),xOverlap=options.addOverlaps?Math.floor(this.xOverlap*scale):0,yOverlap=options.addOverlaps?Math.floor(this.yOverlap*scale):0,pagesWide=bbox.width<=pageWidth?1:Math.ceil(bbox.width/pageWidth),pagesTall=bbox.height+patientInfoHeight*scaleComparedToPrint<=pageHeight?1:Math.ceil((bbox.height+patientInfoHeight*scaleComparedToPrint)/pageHeight);if(1<pagesWide&&options.addOverlaps){var realWidthWithOverlaps=bbox.width+(pagesWide-1)*xOverlap;pagesWide=Math.ceil(realWidthWithOverlaps/pageWidth)}if(1<pagesTall&&options.addOverlaps){var realHeightWithOverlaps=bbox.height+(pagesTall-1)*yOverlap;pagesTall=Math.ceil(realHeightWithOverlaps/pageHeight)}for(var pages=[],pageStartY=0,legendOnSeparatePage=!1,pageNumY=0;pageNumY<pagesTall;pageNumY++){var rowHeight=Math.min(pageHeight,bbox.height-pageStartY);if(!emulateFullPage&&rowHeight<=2)pagesTall-=1,legendOnSeparatePage=!0;else{if(emulateFullPage)rowHeight=pageHeight;var pagesRow=[],pageStartX=0;0==pageNumY&&options.includePatientInfo&&pageHeight<rowHeight+patientInfoHeight*scaleComparedToPrint&&(rowHeight=pageHeight-patientInfoHeight*scaleComparedToPrint);for(var pageNumX=0;pageNumX<pagesWide;pageNumX++){var columnWidth=pageWidth,startX=pageStartX;1==pagesWide&&(startX=pageStartX-(pageWidth-bbox.width)/2);var page={pageName:"page "+pageNumX+":"+pageNumY,svg:svg.getCopy().setViewBox(startX,pageStartY,columnWidth,rowHeight).getSVGText(),width:columnWidth};pagesRow.push(page),pageStartX+=columnWidth-xOverlap}pages.push(pagesRow),pageNumY==pagesTall-1&&pageHeight<rowHeight+totalLegendHeight&&(legendOnSeparatePage=!0),pageStartY+=rowHeight-yOverlap}}return{pages:pages,pagesWide:pagesWide,pagesTall:pagesTall,needLegendOnSeparatePage:legendOnSeparatePage,legendHTML:legendHTML,legendHeight:totalLegendHeight,patientInfoHTML:patientInfoHTML,patientInfoHeight:patientInfoHeight}},generatePreviewHTML:function(landscape,maxPreviewWidth,maxPreviewHeight,printScale,moveHorizontallySize,options){for(var previewWidth=maxPreviewWidth-30,printedWidth=landscape?this.printPageWidth:this.printPageWidthPortrait,printedHeight=landscape?this.printPageHeight:this.printPageHeightPortrait,pagesReal=this._generatePages(printScale,moveHorizontallySize,printedWidth,printedHeight,options,!1,1),pageNumX=0;pageNumX<pagesReal.pagesWide;pageNumX++)pagesReal.pages[0][pageNumX].width;var scaleComparedToPrint=previewWidth/(pagesReal.pagesWide*printedWidth),useScale=scaleComparedToPrint*printScale,pages=this._generatePages(useScale,moveHorizontallySize,scaleComparedToPrint*printedWidth,scaleComparedToPrint*printedHeight,options,!0,scaleComparedToPrint);pages.pagesTall>pagesReal.pagesTall&&(pages.pagesTall=pagesReal.pagesTall);for(var html="<div class='printPreview' id='printPreview' style='height: "+maxPreviewHeight+"px; width: "+maxPreviewWidth+"px; overflow-y: scroll;'>",pageNumY=0;pageNumY<pages.pagesTall;pageNumY++)for(pageNumX=0;pageNumX<pages.pagesWide;pageNumX++){var page=pages.pages[pageNumY][pageNumX];if(html+="<div class='previewPage' style='border: 1px; border-style: dotted; float: left;' id='pedigree-page-x"+pageNumX+"-y"+pageNumY+"'>",0==pageNumY&&options.includePatientInfo){var content=0==pageNumX?pages.patientInfoHTML:"";html+="<div style='height: "+pages.patientInfoHeight*scaleComparedToPrint+"px; font-size: "+11*scaleComparedToPrint+"pt; text-align: left'>"+content+"</div>"}html+=page.svg,html+="</div>"}return html+="</div>"},print:function(landscape,printScale,moveHorizontallySize,options,printPageSet){var pages=this._generatePages(printScale,moveHorizontallySize,landscape?this.printPageWidth:this.printPageWidthPortrait,landscape?this.printPageHeight:this.printPageHeightPortrait,options,!1,1),w=window.open();w.document.write('<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">'),landscape?w.document.write("<style type='text/css' media='print'>@page { size: landscape; }</style>"):w.document.write("<style type='text/css' media='print'>@page { size: portrait; }</style>"),w.document.write("<style type='text/css'>* {margin: 0;}html, body { height: 100%; }.wrapper { min-height: 100%; height: auto !important; height: 100%; }.break_here { page-break-before:always; }.abnormality-list { list-style-type: none; }.abnormality-color { margin-right: 8px; }.legend-item-name {font-size: 11pt }.patient-info {font-size: 11pt }</style>");for(var pageNumY=0;pageNumY<pages.pagesTall;pageNumY++)for(var pageNumX=0;pageNumX<pages.pagesWide;pageNumX++)if(!printPageSet||printPageSet["x"+pageNumX+"y"+pageNumY]){var patientInfoOnThisPage=0==pageNumY&&options.includePatientInfo;if(patientInfoOnThisPage){var content=0==pageNumX?pages.patientInfoHTML:"";w.document.write("<div id='patientInfo' class='header patient-info' style='height: "+pages.patientInfoHeight+"px;'>"+content+"</div>")}var page=pages.pages[pageNumY][pageNumX],bottomLeftPage=pageNumY==pages.pagesTall-1&&0==pageNumX,spaceForLegend=options.includeLegend&&0<pages.legendHeight&&options.legendAtBottom&&bottomLeftPage&&!pages.needLegendOnSeparatePage;if(spaceForLegend){var skipOnTop=patientInfoOnThisPage?-pages.patientInfoHeight:0;w.document.write("<div class='wrapper' style='margin: "+skipOnTop+"px auto -"+pages.legendHeight+"px;'>"),patientInfoOnThisPage&&w.document.write("<div style='height: "+pages.patientInfoHeight+"px;'></div>")}1==pages.pagesWide&&w.document.write("<center>"),w.document.write("<div id='pedigree-page-x"+pageNumX+"-"+pageNumY+"'>"+page.svg+"</div>"),1==pages.pagesWide&&w.document.write("</center>"),spaceForLegend?(w.document.write("<div style='height: "+pages.legendHeight+"px;'></div></div>"),w.document.write("<div id='legend' class='footer print-legend' style='height: "+pages.legendHeight+"px;'>"+pages.legendHTML+"</div>")):this._isLastPage(pageNumY,pageNumX,pages,printPageSet)||w.document.write("<div class='break_here'></div>")}options.includeLegend&&options.legendAtBottom&&pages.needLegendOnSeparatePage&&(w.document.write("<div class='break_here'></div>"),w.document.write("<div id='legend' class='print-legend'>"+pages.legendHTML+"</div>")),w.document.close(),w.print(),options.closeAfterPrint&&w.close()},_isLastPage:function(pageY,pageX,pages,printPageSet){for(var pageNumY=pageY;pageNumY<pages.pagesTall;pageNumY++)for(var pageNumX=pageNumY==pageY?pageX+1:0;pageNumX<pages.pagesWide;pageNumX++)if(!printPageSet||printPageSet["x"+pageNumX+"y"+pageNumY])return!1;return!0}}),PrintDialog=Class.create({initialize:function(){var _this=this;this._defaultScale=.4,this._landscape=!0,this._zoomLevel=100,this._moveHorizontally=0,this._printPageSet={},this._printEngine=new PrintEngine;var mainDiv=new Element("div",{class:"import-selector field-no-user-select cursor-normal"}),previewHeader=new Element("div",{class:"print-preview-header"}).update("Print preview:<br>(each block indicates a separate printed page; click on a page to exclude/include the page from print job)");this.previewContainer=new Element("div",{id:"preview",class:"preview-container"});var previewFooter=new Element("div",{class:"print-preview-footer fa fa-exclamation-triangle"});previewFooter.update(new Element("span",{class:"print-preview-footer-text"}).update("Note: in some browsers you need to manually select correct orientation (landscape or portrait)")),mainDiv.insert(previewHeader).insert(this.previewContainer).insert(previewFooter);var minusButton=new Element("input",{type:"button",value:"-",class:"print-small-button print-left-margin"}),plusButton=new Element("input",{type:"button",value:"+",class:"print-small-button"});this.zoomValue=new Element("label",{class:"print-zoom-value no-mouse-interaction"}).update("100%");var zoom=new Element("span",{class:"print-zoom-span"});zoom.update("Print scale:").insert(minusButton).insert(this.zoomValue).insert(plusButton);var leftButton=new Element("input",{type:"button",value:"<",class:"print-small-button print-small-left-margin"}),rightButton=new Element("input",{type:"button",value:">",class:"print-small-button print-small-left-margin"});this._centerButton=new Element("input",{type:"button",value:"default",class:"print-long-button print-small-left-margin"});var move=new Element("span",{class:"print-move-span"});move.update("Move on page:").insert(leftButton).insert(this._centerButton).insert(rightButton);var landscape=new Element("input",{type:"button",value:"landscape",class:"print-long-button",id:"landscape-button"}),portrait=new Element("input",{type:"button",value:"portrait",class:"print-long-button print-small-left-margin",id:"portrait-button"}),orientation=new Element("span",{class:"print-orientation-span"});orientation.update(landscape).insert(portrait);var controlsDiv=new Element("div",{class:"pedigree-print-controls-container field-no-user-select"});controlsDiv.update(zoom).insert(move).insert(orientation),minusButton.observe("click",function(event){10<_this._zoomLevel&&(_this._zoomLevel-=10,_this._moveHorizontally=0,_this.zoomValue.update(_this._zoomLevel+"%"),_this._updatePreview())}),plusButton.observe("click",function(event){_this._zoomLevel<250&&(_this._zoomLevel+=10,_this._moveHorizontally=0,_this.zoomValue.update(_this._zoomLevel+"%"),_this._updatePreview())}),leftButton.observe("click",function(event){_this._moveHorizontally+=40,_this._updatePreview()}),rightButton.observe("click",function(event){_this._moveHorizontally-=40,_this._updatePreview()}),this._centerButton.observe("click",function(event){_this._moveHorizontally=0,_this._updatePreview()}),landscape.observe("click",function(event){_this._landscape=!0,_this._moveHorizontally=0,$("landscape-button").disable(),$("portrait-button").enable(),_this._updatePreview()}),portrait.observe("click",function(event){_this._landscape=!1,_this._moveHorizontally=0,$("landscape-button").enable(),$("portrait-button").disable(),_this._updatePreview()}),mainDiv.insert(controlsDiv);var configListElement=new Element("table",{id:"print-settings"}),anonimize=new Element("input",{type:"checkbox",value:"0",name:"anonimize"});anonimize.checked=!1,anonimize.observe("click",function(){_this._updatePreview()}),configListElement.insert(new Element("label",{class:"import-mark-label1"}).insert(anonimize).insert("Remove PII information (anonimize)").wrap("td").wrap("tr"));var addLegend=new Element("input",{type:"checkbox",value:"1",name:"add-legend"});addLegend.checked=!0,configListElement.insert(new Element("label",{class:"import-mark-label2"}).insert(addLegend).insert("Print legend on the bottom left sheet").wrap("td").wrap("tr"));var includeOverlaps=new Element("input",{type:"checkbox",value:"1",name:"add-overlap",id:"add-overlaps-checkbox"});includeOverlaps.checked=!1,includeOverlaps.observe("click",function(){_this._updatePreview()}),configListElement.insert(new Element("label",{class:"import-mark-label2"}).insert(includeOverlaps).insert("Make pages slightly overlapped").wrap("td").wrap("tr"));var info=new Element("input",{type:"checkbox",value:"1",name:"patient-info"});info.checked=!0,info.observe("click",function(){_this._updatePreview()}),configListElement.insert(new Element("label",{class:"import-mark-label2"}).insert(info).insert("Include patient information and print date at the top of the first page").wrap("td").wrap("tr"));var closeAfterPrint=new Element("input",{type:"checkbox",value:"1",name:"close-print"});closeAfterPrint.checked=!0,configListElement.insert(new Element("label",{class:"import-mark-label2"}).insert(closeAfterPrint).insert("Close window with printer-friendly version after printing").wrap("td").wrap("tr"));var dataSection3=new Element("div",{class:"print-settings-block"});dataSection3.insert(configListElement),mainDiv.insert(dataSection3);var buttons=new Element("div",{class:"buttons import-block-bottom"});this._printButton=new Element("input",{type:"button",name:"print",value:"Print",class:"button",id:"print_button"}),buttons.insert(this._printButton.wrap("span",{class:"buttonwrapper"})),buttons.insert(new Element("input",{type:"button",name:"done",value:"Close",class:"button secondary"}).wrap("span",{class:"buttonwrapper"})),mainDiv.insert(buttons),buttons.down('input[name="done"]').observe("click",function(event){_this.hide()}),this._printButton.observe("click",function(event){_this._onPrint()});this.dialog=new PhenoTips.widgets.ModalPopup(mainDiv,{close:{method:this.hide.bind(this),keys:["Esc"]}},{extraClassName:"pedigree-print-dialog",title:"Print pedigree",displayCloseButton:!0,verticalPosition:"top"}),Event.observe(window,"resize",_this._adjustPreviewWindowHeight.bind(_this))},_onPrint:function(){var options=this._generateOptions();this._printEngine.print(this._landscape,this._getSelectedPrintScale(),this._moveHorizontally,options,this._printPageSet)},_generateOptions:function(){var patientInfo=$$('input[type=checkbox][name="patient-info"]')[0].checked,anonimize=$$('input[type=checkbox][name="anonimize"]')[0].checked,closePrintVersion=$$('input[type=checkbox][name="close-print"]')[0].checked;return{includeLegend:$$('input[type=checkbox][name="add-legend"]')[0].checked,legendAtBottom:!0,addOverlaps:$$('input[type=checkbox][name="add-overlap"]')[0].checked,closeAfterPrint:closePrintVersion,anonimize:anonimize,includePatientInfo:patientInfo}},show:function(){this.dialog.show(),this._moveHorizontally=0,this._updatePreview()},_adjustPreviewWindowHeight:function(){var canvas=editor.getWorkspace().canvas||document.getElementById(PedigreeEditorTool.divId),pedigreeDialogue=$$(".pedigree-print-dialog")[0];if(pedigreeDialogue){var freeSpace=canvas.getHeight()-10-pedigreeDialogue.getHeight(),previewPaneHeight=$("printPreview").getHeight();if(freeSpace<0){var newPreviewHeight=Math.max(PedigreeEditorParameters.attributes.minPrintPreviewPaneHeight,previewPaneHeight+freeSpace);$("printPreview").style.height=newPreviewHeight+"px"}if(0<freeSpace&&previewPaneHeight<PedigreeEditorParameters.attributes.maxPrintPreviewPaneHeight){newPreviewHeight=Math.min(PedigreeEditorParameters.attributes.maxPrintPreviewPaneHeight,previewPaneHeight+freeSpace);$("printPreview").style.height=newPreviewHeight+"px"}}},_updatePreview:function(){var options=this._generateOptions(),previewHTML=this._printEngine.generatePreviewHTML(this._landscape,730,PedigreeEditorParameters.attributes.maxPrintPreviewPaneHeight,this._getSelectedPrintScale(),this._moveHorizontally,options);this.previewContainer.update(previewHTML),this._adjustPreviewWindowHeight();var _this=this;this._printPageSet={};var numPrinted=0;$$("div[id^=pedigree-page-]").forEach(function(page){try{var pageIDParts=page.id.match(/pedigree-page-x(\d+)-y(\d+)/),pageX=pageIDParts[1],pageY=pageIDParts[2];_this._printPageSet["x"+pageX+"y"+pageY]=!0,numPrinted++,page.observe("click",function(){_this._printPageSet["x"+pageX+"y"+pageY]?(_this._printPageSet["x"+pageX+"y"+pageY]=!1,page.style.backgroundColor="#111",page.style.opacity=.1):(_this._printPageSet["x"+pageX+"y"+pageY]=!0,page.style.backgroundColor="",page.style.opacity=1),_this._checkPrintbuttonStatus()})}catch(err){console.log("Preview page ID mismatch")}}),this._printButton.enable(),numPrinted<2?$("add-overlaps-checkbox").disable():$("add-overlaps-checkbox").enable(),this._landscape?($("landscape-button").disable(),$("portrait-button").enable()):($("landscape-button").enable(),$("portrait-button").disable()),0==_this._moveHorizontally?this._centerButton.disable():this._centerButton.enable()},_checkPrintbuttonStatus:function(){for(var page in this._printPageSet)if(this._printPageSet.hasOwnProperty(page)&&this._printPageSet[page])return void this._printButton.enable();this._printButton.disable()},_getSelectedPrintScale:function(){return this._defaultScale*this._zoomLevel/100},hide:function(){this.dialog.closeDialog()}}),PedigreeEditor=Class.create({initialize:function(){(window.editor=this)._defaultPreferences={global:{nonStandardAdoptedOutGraphic:!1,propagateFatherLastName:!1,dateDisplayFormat:"YMD",dateEditFormat:"YMD",drawNodeShadows:!0,disabledFields:[],displayCancerLabels:!0},user:{hideDraggingHint:!1,firstName:"",lastName:""},pedigree:{}},this._preferencesManager=new PreferencesManager(this._defaultPreferences),this._graphModel=DynamicPositionedGraph.makeEmpty(PedigreeEditorParameters.attributes.layoutRelativePersonWidth,PedigreeEditorParameters.attributes.layoutRelativeOtherWidth),this._workspace=new Workspace,this._unRenderedLegend=new unRenderedLegend,this._disorderLegend=new DisorderLegend,this._geneLegend=new GeneLegend,this._hpoLegend=new HPOLegend,this._cancerLegend=new CancerLegend,this._nodetypeSelectionBubble=new NodetypeSelectionBubble(!1),this._siblingSelectionBubble=new NodetypeSelectionBubble(!0),this._okCancelDialogue=new OkCancelDialogue,this._view=new View,this._actionStack=new UndoRedoManager,this._templateSelector=new TemplateSelector,this._saveLoadIndicator=new SaveLoadIndicator,this._versionUpdater=new VersionUpdater,this._saveLoadEngine=new SaveLoadEngine,this._probandData=new ProbandDataLoader,this._preferencesManager.load(function(){Helpers.copyProperties(PedigreeEditorParameters.styles.blackAndWhite,PedigreeEditorParameters.attributes),this._saveLoadEngine.load(this._probandData),this._nodeMenu=this.generateNodeMenu(),this._nodeGroupMenu=this.generateNodeGroupMenu(),this._partnershipMenu=this.generatePartnershipMenu(),this._importSelector=new ImportSelector,this._exportSelector=new ExportSelector,this._printDialog=new PrintDialog}.bind(this)),this._controller=new Controller;var undoButton=$("action-undo");undoButton&&undoButton.on("click",function(event){document.fire("pedigree:undo")});var redoButton=$("action-redo");redoButton&&redoButton.on("click",function(event){document.fire("pedigree:redo")});var autolayoutButton=$("action-layout");autolayoutButton&&autolayoutButton.on("click",function(event){document.fire("pedigree:autolayout")});var clearButton=$("action-clear");clearButton&&clearButton.on("click",function(event){document.fire("pedigree:graph:clear")});var saveButton=$("action-save");saveButton&&saveButton.on("click",function(event){editor.getSaveLoadEngine().save()});var saveAndExitButton=$("action-saveAndExit");saveAndExitButton&&saveAndExitButton.on("click",function(event){editor.getSaveLoadEngine().save(onCloseButtonClickFunc)});var resetFunction=function(){this._probandData=new ProbandDataLoader,editor.getSaveLoadEngine().load(function(){})},resetButton=$("action-reset");resetButton&&resetButton.on("click",function(event){editor.getOkCancelDialogue().showCustomized("You are about to delete the Pedigrees for this Proband and all user-added information will be lost and will need to be re-input.\n\nDo you want to continue?","Are you sure you want to continue?","Yes",resetFunction,"No",null)});var templatesButton=$("action-templates");templatesButton&&templatesButton.on("click",function(event){editor.getTemplateSelector().show()});var importButton=$("action-import");importButton&&importButton.on("click",function(event){editor.getImportSelector().show()});var exportButton=$("action-export");exportButton&&exportButton.on("click",function(event){editor.getExportSelector().show()});var printButton=$("action-print");printButton&&printButton.on("click",function(event){editor.getPrintDialog().show()});var onLeavePageFunc=function(){if(!editor.isReadOnlyMode()&&editor.getUndoRedoManager().hasUnsavedChanges())return"All changes will be lost when navigating away from this page."};setTimeout(function(){window.addEventListener("beforeonload",onLeavePageFunc)},200);var onCloseButtonClickFunc=function(event){var quitFunc=function(){var config=(new Settings).getSetting("diagramEndpoint");if("openclinica"==config.service||"mercury"==config.service){var webService=new WebService,returnURL=webService.getUrlParameter("returnURL",!0),status=webService.getUrlParameter("status",!0);if("openclinica"==config.service&&"new"==status)return void window.close();returnURL&&(window.location=decodeURIComponent(returnURL))}},saveAndExit=(new Settings).getSetting("saveAndExit");editor.isReadOnlyMode()||!0===saveAndExit?quitFunc():(window.onbeforeunload=void 0,editor.getUndoRedoManager().hasUnsavedChanges()?editor.getOkCancelDialogue().showCustomized("There are unsaved changes, do you want to save the pedigree before closing the pedigree editor?","Save before closing?","Save",function(){editor._afterSaveFunc=quitFunc,editor.getSaveLoadEngine().save()},"Don't save",quitFunc,"Don't close",function(){window.onbeforeunload=onLeavePageFunc},!0):quitFunc())},closeButton=$("action-close");this._afterSaveFunc=null,closeButton&&(closeButton.onclick=onCloseButtonClickFunc);var renumberButton=$("action-number");renumberButton&&renumberButton.on("click",function(event){document.fire("pedigree:renumber")});var unsupportedBrowserButton=$("action-readonlymessage");unsupportedBrowserButton&&unsupportedBrowserButton.on("click",function(event){alert("Your browser does not support all the features required for Pedigree Editor, so pedigree is displayed in read-only mode (and may have quirks).\n\nSupported browsers include Firefox v3.5+, Internet Explorer v9+, Chrome, Safari v4+, Opera v10.5+ and most mobile browsers.")})},getPreferencesManager:function(){return this._preferencesManager},getNode:function(nodeID){return this.getView().getNode(nodeID)},getView:function(){return this._view},getVersionUpdater:function(){return this._versionUpdater},getGraph:function(){return this._graphModel},getController:function(){return this._controller},getUndoRedoManager:function(){return this._actionStack},getAfterSaveAction:function(){return this._afterSaveFunc},getOkCancelDialogue:function(){return this._okCancelDialogue},getNodetypeSelectionBubble:function(){return this._nodetypeSelectionBubble},getSiblingSelectionBubble:function(){return this._siblingSelectionBubble},getWorkspace:function(){return this._workspace},getDisorderLegend:function(){return this._disorderLegend},getHPOLegend:function(){return this._hpoLegend},getGeneLegend:function(){return this._geneLegend},getCancerLegend:function(){return this._cancerLegend},getUnmappedPersonLegend:function(){return this._unmappedPersonLegend},getPaper:function(){return this.getWorkspace().getPaper()},isReadOnlyMode:function(){return!!this.isUnsupportedBrowser()},isUnsupportedBrowser:function(){return!document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")||!window.JSON&&(alert("Your browser is not supported and is unable to load and display any pedigrees.\n\nSuported browsers include Internet Explorer version 9 and higher, Safari version 4 and higher, Firefox version 3.6 and higher, Opera version 10.5 and higher, any version of Chrome and most other modern browsers (including mobile). IE8 is able to display pedigrees in read-only mode."),window.stop&&window.stop(),!0)},getSaveLoadEngine:function(){return this._saveLoadEngine},getProbandDataFromPhenotips:function(){return this._probandData.probandData},getTemplateSelector:function(){return this._templateSelector},getImportSelector:function(){return this._importSelector},getExportSelector:function(){return this._exportSelector},getPrintDialog:function(){return this._printDialog},isAnyMenuVisible:function(){this.getNodeMenu().isVisible()||this.getNodeGroupMenu().isVisible()||this.getPartnershipMenu().isVisible()},generateNodeMenu:function(){if(this.isReadOnlyMode())return null;var disabledFields=this.getPreferencesManager().getConfigurationOption("disabledFields");return new NodeMenu([{name:"identifier",label:"",type:"hidden",tab:"Personal"},{name:"gender",label:"Gender",type:"select",tab:"Personal",values:[{actual:"M",displayed:"Male"},{actual:"F",displayed:"Female"},{actual:"O",displayed:"Indeterminate"},{actual:"U",displayed:"Unknown"}],default:"U",function:"setGender"},{name:"karyotypic_sex",label:"Working Karyotypic Sex",values:[{actual:"Unknown",displayed:"Unknown"},{actual:"XY",displayed:"XY"},{actual:"XX",displayed:"XX"},{actual:"XO",displayed:"XO"},{actual:"XXY",displayed:"XXY"},{actual:"XYY",displayed:"XYY"},{actual:"XXX",displayed:"XXX"},{actual:"XXYY",displayed:"XXYY"},{actual:"XXXY",displayed:"XXXY"},{actual:"XXXX",displayed:"XXXX"},{actual:"Other",displayed:"Other"}],type:"select",tab:"Personal",function:"setKaryotypicSex",isMultipleSelect:!1},{name:"participant_id",label:"&nbsp",type:"text",tab:"Personal",function:"setParticipantId"},{name:"nhs_number",label:"NHS Number",type:"text",tab:"Personal",function:"setNHSNumber"},{name:"ngisRegisteredPatientUid",label:"NGIS Patient ID",type:"text",tab:"Personal",function:"setNgisRegisteredPatientUid"},{name:"ngisRegisteredPatientSimpleId",label:"NGIS Patient ID",type:"hidden",tab:"Personal",function:"setNgisRegisteredPatientUid"},{name:"nonNgisPatientStableUid",label:"Non NGIS Patient ID",type:"text",tab:"Personal",function:"setNonNgisPatientStableUid"},{name:"chiNumber",label:"CHI Number",type:"text",tab:"Personal",function:"setChiNumber"},{name:"organDonorId",label:"Organ Donor ID",type:"text",tab:"Personal",function:"setOrganDonorId"},{name:"localIdentifier",label:"Local Identifier",type:"text",tab:"Personal",function:"setLocalIdentifier"},{name:"last_name",label:"Last name",type:"text",tab:"Personal",function:"setLastName"},{name:"first_name",label:"First name",type:"text",tab:"Personal",function:"setFirstName"},{name:"ethnicity",label:"Ethnicity",values:[{actual:"A",displayed:"British, Mixed British"},{actual:"B",displayed:"Irish"},{actual:"C",displayed:"Any other White background"},{actual:"C2",displayed:"Northern Irish"},{actual:"C3",displayed:"Other white, white unspecified"},{actual:"CA",displayed:"English"},{actual:"CB",displayed:"Scottish"},{actual:"CC",displayed:"Welsh"},{actual:"CD",displayed:"Cornish"},{actual:"CE",displayed:"Cypriot (part not stated)"},{actual:"CF",displayed:"Greek"},{actual:"CG",displayed:"Greek Cypriot"},{actual:"CH",displayed:"Turkish"},{actual:"CJ",displayed:"Turkish Cypriot"},{actual:"CK",displayed:"Italian"},{actual:"CL",displayed:"Irish Traveller"},{actual:"CM",displayed:"Traveller"},{actual:"CN",displayed:"Gypsy/Romany"},{actual:"CP",displayed:"Polish"},{actual:"CQ",displayed:"All republics which made up the former USSR"},{actual:"CR",displayed:"Kosovan"},{actual:"CS",displayed:"Albanian"},{actual:"CT",displayed:"Bosnian"},{actual:"CU",displayed:"Croatian"},{actual:"CV",displayed:"Serbian"},{actual:"CW",displayed:"Other republics which made up the former Yugoslavia"},{actual:"CX",displayed:"Mixed white"},{actual:"CY",displayed:"Other white European, European unspecified, European mixed"},{actual:"D",displayed:"White and Black Caribbean"},{actual:"E",displayed:"White and Black African"},{actual:"F",displayed:"White and Asian"},{actual:"G",displayed:"Any other mixed background"},{actual:"GA",displayed:"Black and Asian"},{actual:"GB",displayed:"Black and Chinese"},{actual:"GC",displayed:"Black and White"},{actual:"GD",displayed:"Chinese and White"},{actual:"GE",displayed:"Asian and Chinese"},{actual:"GF",displayed:"Other Mixed, Mixed Unspecified"},{actual:"H",displayed:"Indian or British Indian"},{actual:"J",displayed:"Pakistani or British Pakistani"},{actual:"K",displayed:"Bangladeshi or British Bangladeshi"},{actual:"L",displayed:"Any other Asian background"},{actual:"LA",displayed:"Mixed Asian"},{actual:"LB",displayed:"Punjabi"},{actual:"LC",displayed:"Kashmiri"},{actual:"LD",displayed:"East African Asian"},{actual:"LE",displayed:"Sri Lanka"},{actual:"LF",displayed:"Tamil"},{actual:"LG",displayed:"Sinhalese"},{actual:"LH",displayed:"British Asian"},{actual:"LJ",displayed:"Caribbean Asian"},{actual:"LK",displayed:"Other Asian, Asian unspecified"},{actual:"M",displayed:"Caribbean"},{actual:"N",displayed:"African"},{actual:"P",displayed:"Any other Black background"},{actual:"PA",displayed:"Somali"},{actual:"PB",displayed:"Mixed Black"},{actual:"PC",displayed:"Nigerian"},{actual:"PD",displayed:"Black British"},{actual:"PE",displayed:"Other Black, Black unspecified"},{actual:"R",displayed:"Chinese"},{actual:"S",displayed:"Any other ethnic group"},{actual:"SA",displayed:"Vietnamese"},{actual:"SB",displayed:"Japanese"},{actual:"SC",displayed:"Filipino"},{actual:"SD",displayed:"Malaysian"},{actual:"SE",displayed:"Any Other Group"},{actual:"Z",displayed:"Not stated"}],type:"select",tab:"Personal",function:"setEthnicities",isMultipleSelect:!0},{name:"clinicalIndicationName",label:"Clinical Indication Name",type:"text",tab:"Clinical",function:"setClinicalIndicationName"},{name:"clinicalIndicationAgeOfOnsetYears",label:"Age at Onset (Y)",type:"select",range:{start:0,end:100,item:["year","years"]},tab:"Clinical",function:"setClinicalIndicationAgeOfOnsetYears"},{name:"clinicalIndicationAgeOfOnsetMonths",label:"Age at Onset (m)",type:"select",range:{start:-9,end:11,default:"0",item:["month","months"]},default:"0",tab:"Clinical",function:"setClinicalIndicationAgeOfOnsetMonths"},{name:"carrierStatus",label:"Disease status",type:"radio",tab:"Clinical",values:[{actual:"Unaffected",displayed:"Unaffected"},{actual:"Affected",displayed:"Affected"},{actual:"Uncertain",displayed:"Uncertain"},{actual:"Unknown",displayed:"Unknown"}],default:"Unknown",function:"setCarrierStatus"},{label:"<i class='fa fa-info-circle' aria-hidden='true'></i> Please select coding system for disorder search:",name:"disorderType",type:"select",tab:"Clinical",values:[{actual:"OMIM",displayed:"OMIM"},{actual:"Orphanet",displayed:"Orphanet"}],function:"setDisorderType"},{label:"Diagnosis Certainty",name:"diagnosisCertainty",type:"select",values:[{actual:"Suspected",displayed:"Suspected"},{actual:"Confirmed",displayed:"Confirmed"}],tab:"Clinical",function:"setDiagnosisCertainty"},{name:"disorders",label:"Disorder",type:"disease-picker",tab:"Clinical",function:"setDisorders"},{name:"hpo_positive",label:"Phenotype",type:"hpo-picker",tab:"Phenotype",function:"setHPO"},{name:"hpoPresent",label:"HPO Present",type:"select",tab:"Phenotype",values:[{actual:"Present",displayed:"Present"},{actual:"Absent",displayed:"Absent"},{actual:"Unknown",displayed:"Unknown"}],function:"setHPOPresent"},{name:"age_of_death_guide",label:"<i class='fa fa-info-circle' aria-hidden='true'></i> Please use either 'Age of death' or 'Date of birth/death'",type:"label",tab:"Personal"},{name:"age_of_death",label:"Age at death",type:"text",tab:"Personal",function:"setAgeOfDeath"},{name:"age_of_death_format",label:"",type:"select",tab:"Personal",function:"setAgeOfDeathFormat",values:[{actual:"y",displayed:"Year"},{actual:"mo",displayed:"Month"},{actual:"wk",displayed:"Week"},{actual:"d",displayed:"Day"}]},{name:"date_of_birth",label:"Date of birth",type:"date-picker",tab:"Personal",function:"setBirthDate"},{name:"date_of_death",label:"Date of death",type:"date-picker",tab:"Personal",function:"setDeathDate"},{name:"gestationAgeWeeks",label:"Gestation age",type:"select",tab:"Personal",range:{start:0,end:50,item:["week","weeks"]},nullValue:!0,function:"setGestationAgeWeeks"},{name:"gestationAgeDays",label:"  ",type:"select",tab:"Personal",range:{start:0,end:6,item:["day","days"]},nullValue:!0,function:"setGestationAgeDays"},{name:"estimatedDateOfDelivery",label:"Estimated Date Of Delivery",type:"date-picker",tab:"Personal",function:"setEstimatedDateOfDelivery"},{name:"state",label:"Individual is",type:"radio",tab:"Personal",columns:3,valuesIE9:[{actual:"Alive",displayed:"Alive"},{actual:"Deceased",displayed:"Deceased"},{actual:"Stillborn",displayed:"Stillborn"},{actual:"Unborn",displayed:"Unborn"},{actual:"Miscarriage",displayed:"Miscarried"},{actual:"Aborted",displayed:"Elective abortion"}],values:[{actual:"Alive",displayed:"Alive"},{actual:"Stillborn",displayed:"Stillborn"},{actual:"Deceased",displayed:"Deceased",columnshiftPX:-2},{actual:"Miscarriage",displayed:"Miscarried",columnshiftPX:-2},{actual:"Unborn",displayed:"Unborn",columnshiftPX:8},{actual:"Aborted",displayed:"Aborted",columnshiftPX:8}],default:"Alive",function:"setLifeStatus"},{label:"Heredity options",name:"childlessSelect",values:[{actual:"None",displayed:"None"},{actual:"Childless",displayed:"Childless"},{actual:"Infertile",displayed:"Infertile"}],type:"select",tab:"Personal",function:"setChildlessStatus"},{name:"childlessText",type:"text",dependency:"childlessSelect != None",dependencyShowInline:!0,tip:"Reason",tab:"Personal",function:"setChildlessReason"},{name:"participatingInTest",label:"Participating In Test",type:"checkbox",tab:"Personal",function:"setParticipatingInTest"},{name:"adopted",label:"Adopted status",type:"radio",tab:"Personal",columns:3,values:[{actual:"",displayed:"Not adopted"},{actual:"adoptedIn",displayed:"Adopted in"},{actual:"adoptedOut",displayed:"Adopted out"}],default:"",function:"setAdopted"},{name:"comments",label:"Comments",type:"textarea",rows:4,tab:"Personal",function:"setComments"},{name:"monozygotic",label:"Monozygotic twin",type:"checkbox",tab:"Personal",function:"setMonozygotic"},{name:"nocontact",label:"Not in contact with proband",type:"checkbox",tab:"Personal",function:"setLostContact"},{name:"placeholder",label:"Placeholder node",type:"checkbox",tab:"Personal",function:"makePlaceholder"},{name:"evaluated",label:"Documented evaluation",type:"checkbox",tab:"Clinical",function:"setEvaluated"},{name:"numberOfColorectalPolypsTotal",label:"Number Of Colorectal Polyps Total",type:"text",tab:"Tumours",function:"setNumberOfColorectalPolypsTotal"},{name:"numberOfColorectalPolypsAdenomas",label:"Number of Colorectal Polyps Adenomas",type:"text",tab:"Tumours",function:"setNumberOfColorectalPolypsAdenomas"},{name:"lastMenstralPeriod",label:"last menstral period",type:"text",tab:"Personal",function:"setLastMenstralPeriod"}].filter(function(field){return!Helpers.arrayContains(disabledFields,field.name)}),["Personal","Clinical","Phenotype","Tumours"])},getNodeMenu:function(){return this._nodeMenu},generateNodeGroupMenu:function(){if(this.isReadOnlyMode())return null;return new NodeMenu([{name:"identifier",label:"",type:"hidden",tab:"Personal"},{name:"gender",label:"Gender",type:"select",columns:3,values:[{actual:"Male",displayed:"Male"},{actual:"Female",displayed:"Female"},{actual:"Indeterminate",displayed:"Indeterminate"},{actual:"Unknown",displayed:"Unknown"}],default:"U",tab:"Personal",function:"setGender"},{name:"karyotypic_sex",label:"Working Karyotypic Sex",values:[{actual:"Unknown",displayed:"Unknown"},{actual:"XY",displayed:"XY"},{actual:"XX",displayed:"XX"},{actual:"XO",displayed:"XO"},{actual:"XXY",displayed:"XXY"},{actual:"XYY",displayed:"XYY"},{actual:"XXX",displayed:"XXX"},{actual:"XXYY",displayed:"XXYY"},{actual:"XXXY",displayed:"XXXY"},{actual:"XXXX",displayed:"XXXX"},{actual:"Other",displayed:"Other"}],type:"select",tab:"Personal",function:"setKaryotypicSex",isMultipleSelect:!1},{name:"numInGroup",label:"Number of persons in this group",type:"select",values:[{actual:1,displayed:"N"},{actual:2,displayed:"2"},{actual:3,displayed:"3"},{actual:4,displayed:"4"},{actual:5,displayed:"5"},{actual:6,displayed:"6"},{actual:7,displayed:"7"},{actual:8,displayed:"8"},{actual:9,displayed:"9"}],tab:"Personal",function:"setNumPersons"},{name:"external_ids",label:"External ID(s)",type:"text",tab:"Personal",function:"setExternalID"},{name:"ethnicity",label:"Ethnicities<br>(common to all individuals in the group)",values:[{actual:"A",displayed:"White: British"},{actual:"B",displayed:"White: Irish"},{actual:"C",displayed:"White: Any other White background"},{actual:"D",displayed:"Mixed: White and Black Caribbean"},{actual:"E",displayed:"Mixed: White and Black African"},{actual:"F",displayed:"Mixed: White and Asian"},{actual:"G",displayed:"Mixed: Any other mixed background"},{actual:"H",displayed:"Asian or Asian British: Indian"},{actual:"J",displayed:"Asian or Asian British: Pakistani"},{actual:"K",displayed:"Asian or Asian British: Bangladeshi"},{actual:"L",displayed:"Asian or Asian British: Any other Asian background"},{actual:"M",displayed:"Black or Black British: Caribbean"},{actual:"N",displayed:"Black or Black British: African"},{actual:"P",displayed:"Black or Black British: Any other Black background"},{actual:"R",displayed:"Other Ethnic Groups: Chinese"},{actual:"S",displayed:"Other Ethnic Groups: Any other ethnic group"},{actual:"Z",displayed:"Not stated"}],type:"select",tab:"Personal",function:"setEthnicities",isMultipleSelect:!0},{label:"<i class='fa fa-info-circle' aria-hidden='true'></i> Please select coding system for disorder search:",name:"disorderType",type:"select",tab:"Clinical",values:[{actual:"OMIM",displayed:"OMIM"},{actual:"Orphanet",displayed:"Orphanet"}],function:"setDisorderType"},{name:"disorders",class:"disordersNodeGroup",label:"Known disorders<br>(common to all individuals in the group)",type:"disease-picker",tab:"Clinical",function:"setDisorders"},{name:"comments",label:"Comments",type:"textarea",rows:4,tab:"Clinical",function:"setComments"},{name:"adopted",label:"Adopted status",type:"radio",tab:"Personal",columns:3,values:[{actual:"",displayed:"Not adopted"},{actual:"adoptedIn",displayed:"Adopted in"},{actual:"adoptedOut",displayed:"Adopted out"}],default:"",tab:"Personal",function:"setAdopted"},{name:"state",class:"stateNodeGroup",label:"All individuals in the group are",type:"radio",values:[{actual:"Alive",displayed:"Alive"},{actual:"Aborted",displayed:"Aborted electively"},{actual:"Deceased",displayed:"Deceased"},{actual:"Miscarriage",displayed:"Miscarried"}],default:"Alive",tab:"Personal",function:"setLifeStatus"},{name:"evaluatedGrp",label:"Documented evaluation",type:"checkbox",tab:"Clinical",function:"setEvaluated"}],["Personal","Clinical"])},getNodeGroupMenu:function(){return this._nodeGroupMenu},generatePartnershipMenu:function(){if(this.isReadOnlyMode())return null;return new NodeMenu([{name:"consangr",label:"Consanguinity of this relationship",type:"radio",values:[{actual:"A",displayed:"Automatic"},{actual:"Y",displayed:"Yes"},{actual:"P",displayed:"Possible"},{actual:"U",displayed:"Unknown"},{actual:"N",displayed:"No"}],default:"A",function:"setConsanguinity"},{name:"broken",label:"Separated",type:"checkbox",function:"setBrokenStatus"}],[],"relationship-menu")},getPartnershipMenu:function(){return this._partnershipMenu},convertGraphCoordToCanvasCoord:function(x,y){var scale=PedigreeEditorParameters.attributes.layoutScale;return{x:x*scale.xscale,y:y*scale.yscale}},startAutoSave:function(intervalInSeconds){setInterval(function(){editor.getSaveLoadEngine().save()},1e3*intervalInSeconds)}}),editor;PedigreeEditor.styles={blackAndWhite:{nodeShapeFemale:{fill:"#ffffff",stroke:"#222222"},nodeShapeMale:{fill:"#ffffff",stroke:"#111111"},nodeShapeOther:{fill:"#ffffff",stroke:"#222222"},nodeShapeDiag:{fill:"#ffffff",stroke:"#222222"},nodeShapeAborted:{fill:"#ffffff",stroke:"#222222"}}},PedigreeEditor.attributes={radius:40,orbRadius:6,touchOrbRadius:8,personHoverBoxRadius:90,newHandles:!0,personHandleLength:75,personHandleBreakX:55,personHandleBreakY:53,personSiblingHandleLengthX:65,personSiblingHandleLengthY:30,enableHandleHintImages:!0,handleStrokeWidth:5,groupNodesScale:.85,infertileMarkerHeight:4,infertileMarkerWidth:14,twinCommonVerticalLength:6,twinMonozygothicLineShiftY:24,curvedLinesCornerRadius:25,unbornShape:{"font-size":50,"font-family":"Cambria"},carrierShape:{fill:"#595959"},carrierDotRadius:8,presymptomaticShape:{fill:"#777777",stroke:"#777777"},presymptomaticShapeWidth:8,uncertainShape:{"font-size":"45px","font-family":"Arial",fill:"#696969","font-weight":"bold"},uncertainSmallShape:{"font-size":"30px","font-family":"Arial",fill:"#696969","font-weight":"bold"},evaluationShape:{"font-size":40,"font-family":"Arial"},nodeShapeFemale:PedigreeEditor.styles.blackAndWhite.nodeShapeFemale,nodeShapeMale:PedigreeEditor.styles.blackAndWhite.nodeShapeMale,nodeShapeOther:PedigreeEditor.styles.blackAndWhite.nodeShapeOther,nodeShapeDiag:PedigreeEditor.styles.blackAndWhite.nodeShapeDiag,nodeShapeAborted:PedigreeEditor.styles.blackAndWhite.nodeShapeAborted,nodeShapeMenuOn:{fill:"#000",stroke:"none","fill-opacity":.1},nodeShapeMenuOff:{fill:"#000",stroke:"none","fill-opacity":0},nodeShapeMenuOnPartner:{fill:"#000",stroke:"none","fill-opacity":.1},nodeShapeMenuOffPartner:{fill:"#000",stroke:"none","fill-opacity":0},boxOnHover:{fill:"gray",stroke:"none",opacity:1,"fill-opacity":.35},menuBtnIcon:{fill:"#1F1F1F",stroke:"none"},deleteBtnIcon:{fill:"#990000",stroke:"none"},btnMaskHoverOn:{opacity:.6,stroke:"none"},btnMaskHoverOff:{opacity:0},btnMaskClick:{opacity:1},orbHue:.53,phShape:{fill:"white","fill-opacity":0,stroke:"black","stroke-dasharray":"- "},dragMeLabel:{"font-size":14,"font-family":"Tahoma"},pedNumberLabel:{"font-size":19,"font-family":"Serif"},descendantGroupLabel:{"font-size":21,"font-family":"Tahoma"},label:{"font-size":20,"font-family":"Arial"},nameLabels:{"font-size":20,"font-family":"Arial"},commentLabel:{"font-size":19,"font-family":"Arial"},cancerAgeOfOnsetLabels:{"font-size":19,"font-family":"Arial"},externalIDLabels:{"font-size":18,"font-family":"Arial"},disorderShapes:{},partnershipNode:{fill:"#d79185",stroke:"black","stroke-width":2},partnershipRadius:7,partnershipHandleBreakY:18,partnershipHandleLength:36,partnershipLines:{"stroke-width":1.25,stroke:"#303058"},partnershipLinesAdoptedIn:{"stroke-width":1.25,stroke:"#303058","stroke-dasharray":"--"},consangrPartnershipLines:{"stroke-width":1.25,stroke:"#402058"},noContactLines:{"stroke-width":1.25,stroke:"#303058","stroke-dasharray":"-.-."},noContactAdoptedIn:{"stroke-width":1.25,stroke:"#303058","stroke-dasharray":"-- ."},noContactLinesConsangr:{"stroke-width":1.25,stroke:"#402058","stroke-dasharray":"-.-."},childlessShapeAttr:{"stroke-width":2.5,stroke:"#3C3C3C"},partnershipChildlessShapeAttr:{"stroke-width":2,stroke:"#3C3C3C"},childlessLength:14,parnershipChildlessLength:27,graphToCanvasScale:12,layoutRelativePersonWidth:10,layoutRelativeOtherWidth:2,layoutScale:{xscale:12,yscale:8},maxPrintPreviewPaneHeight:600,minPrintPreviewPaneHeight:250},document.observe("xwiki:dom:loaded",function(){});var XWiki=function(d){var c=d.actionButtons=d.actionButtons||{};function b(){return new c.EditActions,document.getElementById(PedigreeEditorTool.divId).hasClassName("previewbody")||new c.AjaxSaveAndContinue,!0}function a(){if("undefined"!=typeof Wysiwyg){var h=Wysiwyg.getInstances();for(var f in h){var g=h[f],e=g.getPlainTextArea();e&&!e.disabled?$(f).value=e.value:g.getCommandManager().execute("submit")}}}return c.EditActions=Class.create({initialize:function(){this.addListeners(),this.addShortcuts(),this.addValidators()},addListeners:function(){$$("input[name=action_cancel]").each(function(e){e.observe("click",this.onCancel.bindAsEventListener(this))}.bind(this)),$$("input[name=action_preview]").each(function(e){e.observe("click",this.onPreview.bindAsEventListener(this))}.bind(this)),$$("input[name=action_save]").each(function(e){e.observe("click",this.onSaveAndView.bindAsEventListener(this))}.bind(this)),$$("input[name=action_saveandcontinue]").each(function(e){e.observe("click",this.onSaveAndContinue.bindAsEventListener(this))}.bind(this))},addShortcuts:function(){var e={action_cancel:"$services.localization.render('core.shortcuts.edit.cancel')",action_preview:"$services.localization.render('core.shortcuts.edit.preview')",action_edit:"$services.localization.render('core.shortcuts.edit.backtoedit')",action_inline:"$services.localization.render('core.shortcuts.edit.backtoedit')",action_save:"$services.localization.render('core.shortcuts.edit.saveandview')",action_propupdate:"$services.localization.render('core.shortcuts.edit.saveandview')",action_saveandcontinue:"$services.localization.render('core.shortcuts.edit.saveandcontinue')"};for(var f in e){var g=$$("input[name="+f+"]");0<g.size()&&shortcut.add(e[f],function(){this.click()}.bind(g.first()),{propagate:!1})}},validators:new Array,addValidators:function(){for(var e=document.getElementById(PedigreeEditorTool.divId).select("input.required"),h=0;h<e.length;h++){var f=e[h],g=new LiveValidation(f,{validMessage:""});g.add(Validate.Presence,{failureMessage:"$services.localization.render('core.validation.required.message')"}),g.validate(),this.validators.push(g)}},validateForm:function(g){for(var f=0;f<this.validators.length;f++)if(!this.validators[f].validate())return!1;var h=g.comment;if(h&&($xwiki.isEditCommentSuggested()||$xwiki.isEditCommentMandatory()))for(;""==h.value;){var e=prompt("$services.localization.render('core.comment.prompt')","");if(null===e)return!1;if(h.value=e,!$xwiki.isEditCommentMandatory())break}return!0},onCancel:function(g){g.stop(),this.notify(g,"cancel");var f=g.element().form.action;"string"!=typeof f&&(f=(f=g.element().form.attributes.getNamedItem("action"))?f.nodeValue:window.self.location.href);var i=f.split("#",2),k=2==i.length?i[1]:"";-1==(f=i[0]).indexOf("?")&&(f+="?");var h=g.element().form.elements.xredirect,e=h?"&xredirect="+escape(h.value):"";d.EditLock&&d.EditLock.setLocked(!1),window.location=f+"&action_cancel=true"+e+k},onPreview:function(e){this.validateForm(e.element().form)?this.notify(e,"preview"):e.stop()},onSaveAndView:function(e){this.validateForm(e.element().form)?this.notify(e,"save",{continue:!1}):e.stop()},onSaveAndContinue:function(e){this.validateForm(e.element().form)?this.notify(e,"save",{continue:!0}):e.stop()},notify:function(e,f,g){document.fire("xwiki:actions:"+f,Object.extend({originalEvent:e,form:e.element().form},g||{})),e.stopped&&e.stop()}}),c.AjaxSaveAndContinue=Class.create({initialize:function(){this.createMessages(),this.addListeners()},createMessages:function(){this.savingBox=new d.widgets.Notification("$escapetool.javascript($services.localization.render('core.editors.saveandcontinue.notification.inprogress'))","inprogress",{inactive:!0}),this.savedBox=new d.widgets.Notification("$escapetool.javascript($services.localization.render('core.editors.saveandcontinue.notification.done'))","done",{inactive:!0}),this.failedBox=new d.widgets.Notification('$escapetool.javascript($services.localization.render("core.editors.saveandcontinue.notification.error", ["<span id=""ajaxRequestFailureReason""/>"]))',"error",{inactive:!0})},addListeners:function(){document.observe("xwiki:actions:save",this.onSave.bindAsEventListener(this))},onSave:function(e){if(!e.stopped&&e.memo.continue){void 0!==e.memo.originalEvent&&e.memo.originalEvent.stop(),this.form=$(e.memo.form),this.savedBox.hide(),this.failedBox.hide(),this.savingBox.show();var f=new Hash(this.form.serialize({hash:!0,submit:"action_saveandcontinue"}));f.set("minorEdit","1"),Prototype.Browser.Opera||f.set("ajax","true"),new Ajax.Request(this.form.action,{method:"post",parameters:f.toQueryString(),onSuccess:this.onSuccess.bindAsEventListener(this),on1223:this.on1223.bindAsEventListener(this),on0:this.on0.bindAsEventListener(this),onFailure:this.onFailure.bind(this)})}},on1223:function(e){e.request.options.onSuccess(e)},on0:function(e){e.request.options.onFailure(e)},onSuccess:function(e){this.form&&this.form.template&&(this.form.template.disabled=!0,this.form.template.value=""),this.savingBox.replace(this.savedBox),document.fire("xwiki:document:saved")},onFailure:function(e){this.savingBox.replace(this.failedBox),""==e.statusText||12031==e.status?$("ajaxRequestFailureReason").update("Server not responding"):e.getHeader("Content-Type").match(/^\s*text\/plain/)?$("ajaxRequestFailureReason").update(e.responseText):$("ajaxRequestFailureReason").update(e.statusText),document.fire("xwiki:document:saveFailed",{response:e})}}),d.domIsLoaded&&b()||document.observe("xwiki:dom:loaded",b),document.observe("xwiki:actions:save",a),document.observe("xwiki:actions:preview",a),d}(XWiki||{});document.observe("xwiki:dom:loaded",function(){var c=$("table-of-contents"),a=$("toc-entry");c&&a&&c.down("ul")?((a=a.up("li")).down("ul").replace(c.down("ul")),a.down("ul").select("a").invoke("observe","click",function(g){var d=g.findElement("a"),f=d&&d.getAttribute("href"),h=f&&$(f.substring(1)),e=h&&(h.up(".collapsible-group")||h.up(".chapter"));e&&e.hasClassName("collapsed")&&(e.removeClassName("collapsed"),e.down(".expand-tool")&&e.down(".expand-tool").update(""),e.up(".chapter")&&e.up(".chapter").removeClassName("collapsed"))})):a&&a.up("li").remove()}),document.observe("xwiki:dom:loaded",function(){var a=$("prActionDelete");if(!a)return!1;a.observe("click",function(b){b.stop();var d=b.element();if(d.blur(),!d.disabled){var c=d.readAttribute("href")+"?confirm=1&form_token="+$$("meta[name=form_token]")[0].content+(Prototype.Browser.Opera?"":"&ajax=1");new XWiki.widgets.ConfirmedAjaxRequest(c,{onCreate:function(){d.disabled=!0},onSuccess:function(){window.location=new XWiki.Document("WebHome",XWiki.Document.currentSpace).getURL("view")},onFailure:function(){d.disabled=!1}},{confirmationText:"Are you sure you wish to move this document to the recycle bin?"})}})}),document.observe("xwiki:dom:loaded",function(){if("edit"==XWiki.contextaction){var a=$("edit")||$("inline");if(a){var e=a.form_token&&a.form_token.value,i=(a.serialize(),0<$$("meta[name=version]").length&&$$("meta[name=version]")[0].content),f=function(k){return XWiki.currentDocument.getURL("rollback","rev="+k+"&confirm=1&form_token="+e)},h=XWiki.currentDocument.getURL("delete","confirm=1&form_token="+e);if(i)var b=f(i);var j=XWiki.currentDocument.getRestURL(),d=function(l){var k=l.getElementsByTagName("version");return 0<k.length&&k[0].firstChild.nodeValue};new Ajax.Request(j,{method:"get",onSuccess:function(k){!i&&(i=d(k.responseXML))&&(b=f(i))},onFailure:function(k){404==k.statusCode&&(i="none",b=h)}.bind(this)}),a.select("input[name=action_cancel]").invoke("observe","click",function(k){!a._isVersionVerified&&i&&b&&(Event.stop(k),new Ajax.Request(j,{method:"get",onCreate:function(){a._isVersionVerified=!0},onSuccess:function(m){var l=d(m.responseXML);window.onbeforeunload=function(){},l&&l!=i?window.location=b:k.element().click()}.bind(this),onFailure:function(l){window.onbeforeunload=function(){},k.element().click()}.bind(this),on0:function(l){l.request.options.onFailure(l)}}))})}}}),function(){var a=function(d){var c=$("mainContentArea"),e=$("patient-record-actions");if(c&&e)new StickyBox(e,c,{offsetTop:0})};XWiki.domIsLoaded&&a()||document.observe("xwiki:dom:loaded",a)}(),document.observe("xwiki:dom:loaded",function(){$$(" .export-link").invoke("observe","click",function(b){if(b.stop(),void 0!==b.findElement(".editbody")){var d=window.open("","_blank"),c=function(){d.location=b.findElement().href,document.stopObserving("xwiki:document:saved",c)};document.observe("xwiki:document:saved",c),document.fire("xwiki:actions:save",{continue:!0,form:b.findElement("form")})}else window.open(b.findElement().href,"_blank")})});var PhenoTips=function(b){return(b.widgets=b.widgets||{}).PushPatientWidget=Class.create({initialize:function(){this._consentsModule=null,this._pushManyPatients=!1;var f=$$("div[id^=push-patient]");if(0==f.length){if(0==(f=$$("a[id^=pushall-server]")).length)return;this._pushManyPatients=!0}this._serviceURL=new XWiki.Document("PushPatientService","PhenoTips").getURL("get","outputSyntax=plain"),this._patientId=XWiki.currentDocument.page,this._initUI();var i=this;this._observeSave=function(){i._launchUI()};for(var e=0;e<f.length;e++){var c=f[e],d=this._pushManyPatients?c:c.down("a");if(d){var h=c.readAttribute("name");d.observe("click",function(j){return function(k){k.stop(),k.findElement().blur(),i._selectedServer=j,k.findElement(".editbody")?(document.fire("xwiki:actions:save",{continue:!0,form:k.findElement("form")}),document.observe("xwiki:document:saved",i._observeSave)):i._launchUI()}}(h))}}},_initUI:function(){var f=function(j,i,h){return new Element("div",{id:j,class:"section"}).insert(i&&new Element("h2").update(i)||"").insert(h&&new Element("p",{class:"intro xHint"}).update(h)||"").insert(new Element("div",{class:"section-contents"}))},c=this._pushManyPatients?"Where to send all the patient data to?":"Where to send this patient profile?",d=this._pushManyPatients?"Remote PhenoTips server where all the data will be sent.":"Remote PhenoTips server where this patient's data will be sent.";this._container=new Element("form",{id:"push-patients-ui",class:"xform",method:"post",action:this._serviceURL}),this._container.insert(f("server-selection",c,d)).insert(f("user-selection","Authentication on remote server","Please choose the user name to be used to authenticate on the server and send the data; this user will be marked as the reporter on the remote server.")).insert(f("group-selection","Remote PhenoTips group","The PhenoTips group you would like to share this patient with on the remote server. If a group is selected, the group would be the owner and the given remote user will be a collaborator. If no group is selected, the remote user will be the only owner.")),this._container.insert(f("consents-section","Consents","Remote servers may accept some patient data only if the patient has consented to collection and/or sharing of such data. The set of required consents depends on the server you want to push data to.")),this._retryButtonClass="button secondary push-retry-button",this._checkBoxApprove=new Element("input",{type:"checkbox",id:"approve-checkbox",value:"approve"}),this._approveMessage=new Element("span",{class:"field-no-user-select"});var e=new Element("label",{id:"approve-label"}).update(this._checkBoxApprove).insert(this._approveMessage);this._approveElement=new Element("div",{class:"confirm-push plainmessage"}),this._approveElement.insert(e),this._container.insert(this._approveElement),this._serverManager=this._container.down("#server-selection .section-contents"),this._userManager=this._container.down("#user-selection .section-contents"),this._groupManager=this._container.down("#group-selection .section-contents"),this._consentsSection=this._container.down("#consents-section"),this._consentsManager=this._consentsSection.down(".section-contents"),this._consentsSection.hide(),this._consentsManager.insert('<div class="box warningmessage hidden error">Consents that need to be granted before pushing could not be found. This might prevent you from pushing this patient to a remote server</div>'),this._initServerSelector(),this._initMainFormActions();var g=this._pushManyPatients?"Pushing patient data to a remote PhenoTips instance...":"Pushing __patientID__ to a remote database...".replace("__patientID__",this._patientId);this._dialog=new b.widgets.ModalPopup(this._container,!1,{title:g,verticalPosition:"top",removeOnClose:!1})},_updateConsentHint:function(d){var c=$("consents-section").down(".intro");c&&c.update(d)},_generateServerFirstMessage:function(){return new Element("div",{class:"warningmessage"}).update("Please select server first")},_generateServerAndUserFirstMessage:function(){return new Element("div",{class:"warningmessage"}).update("Please login to the remote server first")},_generateNoServerListMessage:function(){var c=new Element("input",{type:"button",name:"retry",value:"Retry",class:this._retryButtonClass}).wrap("span",{class:"buttonwrapper"}),d=this;return c.observe("click",function(e){d._launchUI()}),new Element("div",{class:"errormessage"}).update("Cannot access the list of remote servers. Please contact your administrator for further details.").insert(c)},_generateCantConnectToServerMessage:function(d,g,e){var c=new Element("input",{type:"button",name:"retry",value:"Retry",class:this._retryButtonClass}).wrap("span",{class:"buttonwrapper"}),f=this;return c.observe("click",function(h){f._loginAndGetConfig(g,e)}),new Element("div",{class:"errormessage"}).update(d+" ").insert(c)},_generateNoPushServerConfiguredMessage:function(){return new Element("div",{class:"errormessage"}).update("Unable to authenticate user: incorrect credentials")},_generateIncorrectCredentialsMessage:function(){return new Element("div",{class:"errormessage"}).update("Unable to authenticate user: incorrect credentials")},_generateFailedToPushPatient:function(e,d,h){var c=new Element("div",{class:"errormessage"}).update(e);if(d){d=new Element("input",{type:"button",name:"retry",value:"Retry",class:this._retryButtonClass}).wrap("span",{class:"buttonwrapper"});var g=this;d.observe("click",function(i){g._pushPatient()}),c.insert(d)}if(h){var f=new Element("input",{type:"button",name:"retry",value:"Push as a new patient",class:this._retryButtonClass}).wrap("span",{class:"buttonwrapper"});g=this;f.observe("click",function(i){g._selectPushNewPatient(),g._pushPatient()}),c.insert(f)}return c},_onUnapprovedUser:function(){this._patientData=void 0,this._groupManager.update(this._generateServerAndUserFirstMessage()),this._consentsSection.hide(),this._pushButton.disable(),this._approveElement.hide(),this._pushResultSection.update(""),this._patientFieldList=void 0,this._userGroupsList=void 0},_onNoServerSelected:function(){this._lastApprovedUser=void 0,this._lastSelectedGroup=void 0,this._userLoginError=void 0,this._serverInfo.hide(),this._userManager.update(this._generateServerFirstMessage()),this._onUnapprovedUser()},_disableControl:function(c){c.disable(),c.__wasDisabledState=!0},_disableInputs:function(e){this._container.addClassName("loading-indicator-large");for(var d=this._container.getElementsByTagName("input"),c=0;c<d.length;c++)d[c].disabled?d[c].__wasDisabledState=!0:d[c].disable();this._serverSelector.down("select").disable(),e||this._cancelButton.enable()},_restoreInputs:function(){this._container.removeClassName("loading-indicator-large");for(var d=this._container.getElementsByTagName("input"),c=0;c<d.length;c++)d[c].__wasDisabledState?delete d[c].__wasDisabledState:d[c].enable();this._serverSelector.down("select").enable()},_launchUI:function(){var c=this;document.stopObserving("xwiki:document:saved",c._observeSave),this.__launchUIAjaxInProgress||(this._consentsModule=b.widgets.ConsentsModule.createNew(),this._remoteServers={},this._numAvailableServers=0,this._onNoServerSelected(),this._serverLoadMessages.update(new Element("div",{class:"infomessage"}).update("Retrieving server list...")),this._serverLoadMessages.show(),this._serverSelector.hide(),this._container.addClassName("loading-indicator-large"),new Ajax.Request(this._serviceURL,{method:c._container.method,parameters:{do:"getremotes",patientId:c._patientId},onCreate:function(){c.__launchUIAjaxInProgress=!0,c._dialog.showDialog(),c._container.up(".msdialog-modal-container").style.zIndex=3001},onSuccess:function(d){console.log("PUSH: Got response for the getremotes request");var e=d.responseJSON;e&&0!=e.length?(c._serverLoadMessages.hide(),c._populateServerList(e)):c._serverLoadMessages.update(c._generateNoPushServerConfiguredMessage())},onFailure:function(d){c._serverLoadMessages.update(c._generateNoServerListMessage())},on0:function(d){d.request.options.onFailure(d)},onComplete:function(){c.__launchUIAjaxInProgress=!1,c._container.removeClassName("loading-indicator-large"),console.log("PUSH: getting remotes - complete")}}))},_queryStoredUserName:function(){var c=this;this._userManager.update(""),new Ajax.Request(this._serviceURL,{method:c._container.method,parameters:{do:"getuser",serverid:this._selectedServer},onCreate:function(){console.log("PUSH: get username - start"),c._disableInputs()},onSuccess:function(d){d.responseJSON.remoteUserName&&(c._lastApprovedUser=d.responseJSON.remoteUserName)},onFailure:function(d){console.log("PUSH: couldn't not get the user last used for this server")},on0:function(d){d.request.options.onFailure(d)},onComplete:function(){c._restoreInputs(),console.log("PUSH: getting username - complete"),c._lastApprovedUser?c._loginAndGetConfig(c._lastApprovedUser,null):c._updateUserList()}})},_loginAndGetConfig:function(f,c){console.log("loginAndGetConfig: probing "+f);var e=this,d={do:"getremoteconfig",serverid:this._selectedServer,savetoken:!0};c&&(d.usr=f,d.pwd=c),new Ajax.Request(this._serviceURL,{method:e._container.method,parameters:d,onCreate:function(){console.log("PUSH: get remote config - start"),e._disableInputs()},onSuccess:function(g){g.hasOwnProperty("responseJSON")&&g.responseJSON?(console.log("PUSH: Got response from server: "+stringifyObject(g.responseJSON)),e._lastLoginResponse=g.responseJSON):(console.log("PUSH: No response from local service"),e._lastLoginResponse={status:"error",nolocalresponse:!0})},onFailure:function(g){console.log("PUSH: unable to get a response from remote server"),e._lastLoginResponse={status:"error",serverconnectproblem:!0}},on0:function(g){g.request.options.onFailure(g)},onComplete:function(){this._restoreInputs(),console.log("PUSH: get remote config - complete"),"success"==this._lastLoginResponse.status?(console.log("--\x3e login successful!"),this._lastApprovedUser=f,this._updateUserList(),this._populateGroupsAndData(this._lastLoginResponse.groups,this._lastLoginResponse.serverfields,this._lastLoginResponse.updatesEnabled),this._populateConsentsList(this._lastLoginResponse.consents)):(console.log("--\x3e login failed!"),this._lastApprovedUser==f&&(this._lastApprovedUser=void 0),this._updateUserList(f,this._lastLoginResponse,f,c))}.bind(this)})},_logoutUser:function(){var d=this,c={do:"removetokens",serverid:this._selectedServer};new Ajax.Request(this._serviceURL,{method:d._container.method,parameters:c,onCreate:function(){console.log("PUSH: logout user");try{d._disableInputs()}catch(f){console.log("ERROR: "+f)}},onSuccess:function(e){d._lastLoginResponse=void 0,d._lastApprovedUser=void 0,d._updateUserList()},onFailure:function(e){alert("Failed to log out")},on0:function(e){e.request.options.onFailure(e)},onComplete:function(){this._restoreInputs(),console.log("PUSH: logout - complete")}.bind(this)})},_updateUserList:function(d,f,c,p){if(f){if(this._lastLoginResponse.nolocalresponse)return void this._userManager.update(this._generateCantConnectToServerMessage("Can't connect to local service. Make sure you are currently logged in.",c,p));if(this._lastLoginResponse.unauthorizedserver)return void this._userManager.update(this._generateCantConnectToServerMessage("This server is not authorized to push patients to the selected server. Please contact your administrator",c,p));if(this._lastLoginResponse.serverconnectproblem)return void this._userManager.update(this._generateCantConnectToServerMessage("Cannot connect to selected PhenoTips server.",c,p));if(this._lastLoginResponse.serverdoesnotsupportclientprotocol)return void this._userManager.update(this._generateCantConnectToServerMessage("Cannot connect to selected PhenoTips server - the server does not support the (old) version of PhenoTips this instance is running.",c,p));if(this._lastLoginResponse.clientdoesnotsupportserverprotocol)return void this._userManager.update(this._generateCantConnectToServerMessage("Cannot connect to selected PhenoTips server - the server is running an outdated unsupported version of PhenoTips software.",c,p))}console.log("updateUserList: "+d+", last approved: "+this._lastApprovedUser);var e=new Element("table",{id:"user-list"}),n=function(v,r,u,q,w){var x=new Element("tr"),s=new Element("input",{type:"radio",value:u,name:"select-user"});v&&(s.checked=!0);var t=new Element("label").insert(s).insert(u);return x.insert(new Element("span",{class:"fa fa-"+r}).wrap("td")).insert(t.wrap("td")),w&&x.insert(w.wrap("td",{class:"controlled-element"})),s.observe("change",function(B){for(var z=B.findElement("input"),y=z.up("table").getElementsByTagName("input"),A=0;A<y.length;A++)"select-user"!=y[A].getAttribute("name")&&y[A].disable();for(y=z.up("tr").getElementsByTagName("input"),A=0;A<y.length;A++)y[A].enable();q()}),x},j=!1;if(this._lastApprovedUser){j=!d||this._lastApprovedUser==d;var m=new Element("input",{type:"button",name:"logout",value:"Log out",class:"button secondary"}).wrap("span",{class:"buttonwrapper"});m.observe("click",function(q){this._onUnapprovedUser(),this._logoutUser()}.bind(this));var k=n(j,"check","Currently authenticated user: __lastApprovedUser__".replace("__lastApprovedUser__","<strong>"+this._lastApprovedUser+"</strong> &nbsp;"),function(){this._userLoginError.hide(),this._onUnapprovedUser(),this._loginAndGetConfig(this._lastApprovedUser)}.bind(this),m);e.insert(k)}var i=new Element("span",{class:"user-password-box"}),g=new Element("input",{type:"text",id:"newusername",value:"",placeholder:"user name",size:12});d&&(g.value=d);var l=new Element("input",{type:"password",id:"password",value:"",placeholder:"password",size:12}),o=new Element("input",{type:"button",id:"authorizenewuser",name:"authorize",value:"Log in",class:"button secondary"});o.observe("click",function(q){""!=l.value?(this._userLoginError.hide(),this._loginAndGetConfig(g.value,l.value)):(this._userLoginError.update("No password provided"),this._userLoginError.show())}.bind(this)),j&&(g.disable(),l.disable(),o.disable()),i.insert(g.wrap("label",{class:"fa fa-user"})).insert(" ").insert(l.wrap("label",{class:"fa fa-key"})).insert(" ").insert(o.wrap("span",{class:"buttonwrapper"})),this._lastApprovedUser?e.insert(n(!j,"user","Another remote user: ",this._onUnapprovedUser.bind(this),i)):e.insert(i.wrap("td",{class:"controlled-element"}).wrap("tr")),this._userLoginError=new Element("div",{class:"errormessage"}),this._userLoginError.hide(),this._userManager.update(e).insert(this._userLoginError),f&&this._lastLoginResponse.loginfailed&&""!=p&&(this._userLoginError.update("Unable to authorize user: incorrect credentials"),this._userLoginError.show())},_populateGroupsAndData:function(d,c,e){e||(this._remoteServers[this._selectedServer].noUpdates=!0),this._displayGroupPicker(d),this._showApproveCheckbox()},_displayGroupPicker:function(c){if(c)this._userGroupsList=c;else if(c=this._userGroupsList,!this._userGroupsList)return;console.log("Groups: "+stringifyObject(c));var d=new Element("table",{id:"user-list"}),e=function(l,h,k,m){var n=new Element("tr"),i=new Element("input",{type:"radio",value:m,name:"select-group"});l&&(i.checked=!0);var j=new Element("label").insert(i).insert(k);return n.insert(new Element("span",{class:"fa fa-"+h}).wrap("td")).insert(j.wrap("td")),n};if(this._updatingExistingPatient()){" <span class ='hint'>(the group can't be changed when updating an existing patient)</span>",d.insert(e(!0,"check","Keep existing group(s) <span class ='hint'>(the group can't be changed when updating an existing patient)</span>","__self"))}else{var f="<span class ='hint'>None</span>";0==c.length&&(f+=" (user __lastApprovedUser__ does not belong to any PhenoTips groups on the selected server)".replace("__lastApprovedUser__",this._lastApprovedUser)),d.insert(e(!0,"user",f,"__self")),c.each(function(h){d.insert(e(!1,"group",h,h))})}this._groupManager.update(d),this._remoteServers[this._selectedServer].noUpdates&&this._disableUpdateOption()},_showApproveCheckbox:function(){this._checkBoxApprove.checked=!1,this._checkBoxApprove.enable(),this._approveElement.show()},_populateConsentsList:function(c){if(null!=c&&0!=c.length){var d=function(f,e){this._pushResultSection.update("")}.bind(this);this._consentsManager.update(""),this._updateConsentHint(this._selectedServer+" is configured with the following set of consents. Not all consents are required, but some data might not be uploaded if corresponding consent has not been granted."),this._consentsModule.init(this._consentsManager,"edit",c,!1,d),this._consentsSection.show()}else this._consentsSection.hide()},_populateServerList:function(j){this._remoteServers={};var n=[];this._numAvailableServers=j.length;for(var h=0;h<j.length;h++){var e=j[h].serverinfo,d=j[h].pushinfo,c=e.serverID;n.push(c),e.serverURL=this._addHTTP(e.serverURL);var f=d?d.lastPushAgeInHours:-1,g=d?d.remotePatientID:"",m=d?d.remotePatientGUID:"",l=d?e.serverURL+d.remotePatientURL:"";this._remoteServers[c]={url:e.serverURL,desc:e.serverDescription,pushAgeHours:f,remoteID:g,remoteGUID:m,remoteURL:l}}n.sort();this._selectServer(this._selectedServer)},_selectServer:function(d,c){this._selectedServer=d;var h=this._remoteServers[d],m=new Element("a",{href:h.url,target:"_blank",class:"remote-server-name"}).update(this._selectedServer);1==this._numAvailableServers&&this._serverInfo.update("There is only one configured remote server: ");var n="";if(void 0!==h.pushAgeHours&&0<=h.pushAgeHours){n=new Element("dd");var o=new Element("p",{id:"server-description"}),l=h.pushAgeHours;o.insert("This patient was uploaded to "+this._selectedServer),l<1?o.insert(" less than an hour ago"):48<=l?o.insert(" "+Math.floor(l/24)+" days ago"):o.insert(" "+l+" hours ago"),o.insert(" and was assigned patient ID ").insert(new Element("a",{href:h.remoteURL,target:"_blank"}).update(h.remoteID)).insert("."),o.insert("<br/>If data in the record has changed, push to __serverID__ again to update the record there.".replace("__serverID__",this._selectedServer)),n.insert(o);var k=this,j=(new Element("p"),new Element("input",{type:"radio",value:"update",id:"choice-update-patient",name:"new-or-update"}));j.checked=!0,j.observe("change",function(){k._displayGroupPicker()});var g=new Element("label",{hidden:!0}).insert(new Element("span",{class:"fa fa-refresh"}).update(" ")).insert(j).insert("Update remote patient"),i=new Element("input",{type:"radio",value:"new",id:"choice-new-patient",name:"new-or-update"});i.observe("change",function(){k._displayGroupPicker()});var f=new Element("label",{hidden:!0}).insert(new Element("span",{class:"fa fa-plus-square"}).update(" ")).insert(i).insert("Create new remote patient");n.insert(g).insert(f)}this._serverInfo.update(new Element("dl").insert(m.clone(!0).wrap("dt")).insert(h.desc&&new Element("dd",{class:"hint"}).update(h.desc)||"").insert(n||"")),this._approveMessage.update("I agree to push selected patient data to "+this._selectedServer),c||(this._serverInfo.show(),this._queryStoredUserName())},_onServerOptionChange:function(){var c=this._serverSelector.down("select"),d=c.options[c.selectedIndex].value;this._onNoServerSelected(),"none"!=d&&this._selectServer(d)},_initServerSelector:function(){this._serverLoadMessages=new Element("div",{id:"server-load-messages"}),this._serverLoadMessages.hide();var c=new Element("select",{id:"server-selector"});c.insert(new Element("option",{value:"none"}).update("Loading server list...")),c.observe("change",this._onServerOptionChange.bind(this)),this._serverSelector=new Element("div",{id:"server-selector-div"}),this._serverSelector.hide(),this._serverSelector.update(c),this._serverInfo=new Element("div",{id:"server-info"}),this._serverManager.update(this._serverLoadMessages).insert(this._serverSelector).insert(this._serverInfo)},_initMainFormActions:function(){var e=this,d=new Element("div",{class:"buttons"});d.insert(new Element("input",{type:"hidden",name:"xaction",value:"push"})),d.insert(new Element("input",{type:"hidden",name:"patient",value:this._patientId}));var c=this._pushManyPatients?"Next: Select patients and data fields to be pushed":"Next: Select data fields to be pushed";d.insert(new Element("input",{type:"submit",name:"submit",value:c,class:"button",id:"push_patient_button"}).wrap("span",{class:"buttonwrapper"})),d.insert(new Element("input",{type:"button",name:"close",value:"Cancel",class:"button secondary"}).wrap("span",{class:"buttonwrapper"})),this._container.insert(d),this._pushResultSection=new Element("div",{class:"section-contents"}),this._container.insert(this._pushResultSection),this._cancelButton=d.down('input[name="close"]'),this._cancelButton.observe("click",function(f){e._dialog.closeDialog()}),this._pushButton=d.down('input[name="submit"]'),this._checkBoxApprove.observe("click",function(f){e._pushResultSection.update(""),e._checkBoxApprove.checked?e._pushButton.enable():e._pushButton.disable()}),this._container.observe("submit",function(f){f.stop(),e._pushSelectFieldsAndPatients()})},_updatingExistingPatient:function(){var d=!1,c=document.getElementById("choice-update-patient");return c&&(d=c.checked),d},_selectPushNewPatient:function(){var c=document.getElementById("choice-update-patient"),d=document.getElementById("choice-new-patient");c&&d&&(c.checked=!1,d.checked=!0)},_disableUpdateOption:function(){var e=document.getElementById("choice-new-patient");e&&(e.checked=!0);var c=document.getElementById("choice-update-patient-label");c&&(document.getElementById("server-description").insert("<p>Selected server does not allow updating existing patients, so can only push again to a new patient record.</p>"),c.hide())},_pushPatient:function(f,d,g){var i=this;if(!i._pushManyPatients||d&&g)if(i._pushManyPatients||i._pushResultSection.update(""),f?i._lastSelectedColumnList=f:f=i._lastSelectedColumnList,f&&0!=f.length){d=d||this._patientId;var h={do:"push",serverid:this._selectedServer,patientid:d};h.fields=f?Object.toJSON(f):Object.toJSON(this._patientFieldList),i._pushManyPatients?h.guid="auto":this._updatingExistingPatient()&&(h.guid=i._remoteServers[i._selectedServer].remoteGUID);var e=$$('input:checked[type=radio][name="select-group"]')[0].value;"__self"!=e&&(h.groupname=e);var c={consents:i._consentsModule.listGrantedConsentIDs()};h.patientState=stringifyObject(c),console.log("PUSH request params: "+stringifyObject(h)),new Ajax.Request(this._serviceURL,{method:i._container.method,parameters:h,onCreate:function(){i._disableInputs(!0)},onSuccess:function(k){try{console.log("Got response: "+stringifyObject(k.responseJSON));var l=k.responseJSON;if(i._pushManyPatients)return void g(l,d);if("success"==l.status){i._checkBoxApprove.checked=!1;var o=i._remoteServers[i._selectedServer].url+l.patienturl;if(i._remoteServers[i._selectedServer].pushAgeHours=0,i._remoteServers[i._selectedServer].remoteID=l.patientid,i._remoteServers[i._selectedServer].remoteGUID=l.patientguid,i._remoteServers[i._selectedServer].remoteURL=o,i._updatingExistingPatient()){var n="(<a href='"+o+"' target='_blank'>click here to open remote patient</a>)";i._pushResultSection.update(new Element("div",{class:"infomessage"}).update("Updated patient successfully. "+n))}else{var j="<a href='"+o+"' target='_blank'>"+l.patientid+"</a>";i._pushResultSection.update(new Element("div",{class:"infomessage"}).update("Pushed patient successfully, ID of the new patient on the remote server is "+j))}i._selectServer(i._selectedServer,!0),i._displayGroupPicker()}else l.updatesdisabled?i._pushResultSection.update(i._generateFailedToPushPatient("Unable to update this patient - updates are disbaled on the remote server")):l.invalidguid?i._pushResultSection.update(i._generateFailedToPushPatient("Unable to update this patient - stored remote GUID is incorrect. Maybe the patient was deleted on the remote server&nbsp;",!1,!0)):l.accessdeniedguid?i._pushResultSection.update(i._generateFailedToPushPatient("Unable to update this patient - access denied. Check if the given remote user has access rights to update the patient")):l.accessdeniedguid?i._pushResultSection.update(i._generateFailedToPushPatient("Unable to update this patient: access denied")):l.cantconnect?i._pushResultSection.update(i._generateFailedToPushPatient("Unable to connect to server",!0)):l.missingconsent?i._pushResultSection.update(i._generateFailedToPushPatient("Unable to update this patient - missing a required consent",!0)):i._pushResultSection.update(i._generateFailedToPushPatient("Unable to update this patient",!0))}catch(m){console.log("EXCEPTION: "+m),i._pushResultSection.update(i._generateFailedToPushPatient("Error updating patient ( __e__ )".replace("__e__",m),!0))}},onFailure:function(k){if(i._pushManyPatients)g({status:"error"},d);else{var j=!1,l=k.statusText;""!=k.statusText&&12031!=k.status||(l="Server not responding",j=!0),i._pushResultSection.update(i._generateFailedToPushPatient(l,j))}},on0:function(j){i._pushManyPatients?g({status:"error"},d):j.request.options.onFailure(j)},onComplete:function(){i._restoreInputs(),i._checkBoxApprove.checked||i._pushButton.disable()}})}else i._pushResultSection.update(new Element("div",{class:"errormessage"}).update("No columns were selected"))},_addHTTP:function(c){return/^(f|ht)tps?:\/\//i.test(c)||(c="http://"+c),c},_pushSelectFieldsAndPatients:function(){var j=this,d=function(k,l){if(0!=k.length){var m="Do you want to push the following __numPatients__ patients to __selectServer__?".replace("__numPatients__",k.length).replace("__selectServer__",j._selectedServer)+"<br/><div class='plainmessage multi-push-patient-list'><ol>";k.each(function(n){m+="<li>"+n+"</li>"}),m+="</ol></div>",new XWiki.widgets.ConfirmationBox({onYes:function(){!function(k,m){j._checkBoxApprove.checked=!1;var o=new Element("div",{class:"multi-push-results infomessage"});j._pushResultSection.update(o);var n=0,l=function(q,r){if(q&&r)if("success"!=q.status){if(o.className="multi-push-results errormessage",q.cantconnect)return void o.insert(" Unable to connect to server");var s="failed.";q.invalidguid?s="Unable to update: stored remote GUID is incorrect":q.accessdeniedguid?s="Unable to update: access denied.":q.missingconsent&&(s="Unable to update this patient - missing a required consent"),o.insert(" "+s+"<br/>")}else{o.innerHTML=o.innerHTML.replace(/Pushing (\w+?)\.\.\.$/,"");var t="<a href='"+(j._remoteServers[j._selectedServer].url+q.patienturl)+"' target='_blank'>"+q.patientid+"</a>";o.insert("<div class='pushed-ok-message'>"+"Pushed __prevPatientID__ successfully, remote patient ID is __linkToRemote__".replace("__prevPatientID__",r).replace("__linkToRemote__",t)+"</div>")}if(n<k.length){var p=k[n++];o.insert("Pushing __nextPatientID__...".replace("__nextPatientID__",p)),j._pushPatient(m,p,l)}};l()}(k,l)}},{confirmationText:m,showCancelButton:!1})}};if(j._pushManyPatients){var i=$("phenotips_export");if(!i)return;(f=new b.widgets.ModalPopup('<img src="resources/icons/xwiki/ajax-loader-large.gif"/>',!1,{title:"Select patients and fields to be pushed",verticalPosition:"top",removeOnClose:!0,extraClassName:"export-dialog"})).showDialog();var e=function(){alert("Failed to get the list of patients to be pushed")};new Ajax.Request(new XWiki.Document("ExportPreferences","PhenoTips").getURL("get","space="+/space=([^&]+)/.exec(i.href)[1]+"&push=true&multipatient=true&remoteserver="+this._selectedServer),{parameters:{enabledFields:this._lastLoginResponse.serverfields},onSuccess:function(l){var k=f.dialogBox._x_contentPlug;k.update(l.responseText),k.__dialog=f,document.fire("xwiki:dom:updated",{elements:[k],pushPreferences:k,pushMulti:!0,callbackOK:d,callbackFail:e})}})}else{var f;(f=new b.widgets.ModalPopup('<img src="resources/icons/xwiki/ajax-loader-large.gif"/>',!1,{title:"Select fields to be pushed",verticalPosition:"top",removeOnClose:!0,extraClassName:"narrow-export-dialog export-dialog"})).showDialog();var c=function(){alert("Failed to get the list of fields to be pushed")},h=function(k){j._pushPatient(k)};new Ajax.Request(new XWiki.Document("ExportPreferences","PhenoTips").getURL("get","push=true&singlepatient=false&remoteserver="+this._selectedServer),{parameters:{enabledFields:this._lastLoginResponse.serverfields},onSuccess:function(l){var k=f.dialogBox._x_contentPlug;k.update(l.responseText),k.__dialog=f,document.fire("xwiki:dom:updated",{elements:[k],pushPreferences:k,pushMulti:!1,callbackOK:h,callbackFail:c})}})}}}),b}(PhenoTips||{});function stringifyObject(a){return _printObjectInternal(a,1)}function _printObjectInternal(d,e){if(10<e)return"...[too deep, possibly a recursive object]...";var b="";if("object"==typeof d)if("[object Array]"===Object.prototype.toString.call(d)){b="[";for(var c=0;c<d.length;c++)0<c&&(b+=", "),b+=_printObjectInternal(d[c],e+1);b+="]"}else{b="{";var a=0;for(property in 0==e&&(b+="\n"),d)d.hasOwnProperty(property)&&(0!=e&&0!=a&&(b+=", "),b+=property+": "+_printObjectInternal(d[property],e+1),0==e&&(b+="\n"),a++);b+="}"}else b="string"==typeof d?"'"+d+"'":""+d;return b}["xwiki:dom:updated"].each(function(a){document.observe(a,function(g){if(g.memo&&g.memo.pushPreferences&&g.memo.callbackOK){var d=g.memo.pushPreferences.__dialog,c=g.memo.callbackOK,f=g.memo.callbackFail,e=g.memo.pushMulti,h=$("export_cancel");h&&h.observe("click",function(i){d.closeDialog()});var b=g.memo.pushMulti?$("push-multiple-patients"):$("push-patient");b&&b.observe("click",function(n){n.stop();var m=b.up("form");if(m){var k=[];if(m.down(".push-fields").select('input[name="columns"]').each(function(q){q.checked&&k.push(q.identify().replace("columns_",""))}),!e)return d.closeDialog(),void c(k);$("filter-match-count");var l="/get/PhenoTips/ExportFilter?list=true&"+m.serialize();new Ajax.Request(l,{method:"get",onSuccess:function(r){var q=[];r.responseJSON.each(function(s){q.push(s.replace("data.",""))}),c(q,k)},onFailure:function(q){f&&f()}})}d.closeDialog()})}})}),document.observe("xwiki:dom:loaded",function(){new PhenoTips.widgets.PushPatientWidget}),function(){function a(b){"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn(b)}"object"==typeof XWiki.widgets&&"function"==typeof XWiki.widgets.FullScreen&&(XWiki.editors=XWiki.editors||{},XWiki.editors.FullScreenEditing=Class.create(XWiki.widgets.FullScreen,{initialize:function($super){a("XWiki.editors.FullScreenEditing is deprecated since XWiki 2.6RC2. Use XWiki.widgets.FullScreen instead."),$super()}})),window.useXWKns?(a("_xwk namespace is deprecated since XWiki 2.6RC1. Use the XWiki namespace instead."),"undefined"==typeof _xwk&&(_xwk=new Object)):_xwk=window,_xwk.ajaxSuggest=Class.create(XWiki.widgets.Suggest,{initialize:function($super){a("ajaxSuggest is deprecated since XWiki 2.6RC1. Use XWiki.widgets.Suggest instead.");var b=$A(arguments);b.shift(),$super.apply(_xwk,b)}}),window.displayDocExtra=XWiki.displayDocExtra.wrap(function(){a("window.displayDocExtra is deprecated since XWiki 1.9M2. Use XWiki.displayDocExtra instead.");var b=$A(arguments);return b.shift().apply(window,b)}),"object"==typeof XWiki.widgets&&"function"==typeof XWiki.widgets.LiveTable&&(window.ASSTable=Class.create(XWiki.widgets.LiveTable,{initialize:function($super,b,f,e,c,g,h,i,d){a("window.ASSTable is deprecated since XWiki 1.9M2. Use XWiki.widgets.LiveTable instead."),$("showLimits")&&($("showLimits").up("tr")&&$("showLimits").up("tr").insert({after:new Element("tr").update(new Element("td").update(new Element("div",{id:e+"-pagination",class:"xwiki-grid-pagination-content"})))}),$("showLimits").id=e+"-limits"),$("scrollbar1")&&$("scrollbar1").up("td")&&($("scrollbar1").up("td").next()&&$("scrollbar1").up("td").next().remove(),$("scrollbar1").up("td").remove()),$("table-filters")&&($("table-filters").id=e+"-filters"),$super(b,e,h,{action:d})}})),window.hideForm=function(b){a("window.hideForm is deprecated since XWiki 2.6RC1. Use a CSS selector + Element#toggleClassName instead."),b.getElementsByTagName("fieldset").item(0).className="collapsed"},window.toggleForm=function(c){a("window.toggleForm is deprecated since XWiki 2.6RC1. Use a CSS selector + Element#toggleClassName instead.");var b=c.getElementsByTagName("fieldset").item(0);"collapsed"==b.className?b.className="expanded":b.className="collapsed"},window.createCookie=XWiki.cookies.create.wrap(function(){a("window.createCookie is deprecated since XWiki 2.6RC1. Use XWiki.cookies.create instead.");var b=$A(arguments);return b.shift().apply(window,b)}),window.readCookie=XWiki.cookies.read.wrap(function(){a("window.readCookie is deprecated since XWiki 2.6RC1. Use XWiki.cookies.read instead.");var b=$A(arguments);return b.shift().apply(window,b)}),window.eraseCookie=XWiki.cookies.erase.wrap(function(){a("window.eraseCookie is deprecated since XWiki 2.6RC1. Use XWiki.cookies.erase instead.");var b=$A(arguments);return b.shift().apply(window,b)}),window.togglePanelVisibility=XWiki.togglePanelVisibility.wrap(function(){a("window.togglePanelVisibility is deprecated since XWiki 2.6RC1. Use XWiki.togglePanelVisibility instead.");var b=$A(arguments);return b.shift().apply(window,b)}),window.cancelEdit=function(){a("window.cancelEdit is deprecated since XWiki 4.1M1. Use XWiki.EditLock.unlock instead."),XWiki.EditLock.unlock()},window.lockEdit=function(){a("window.lockEdit is deprecated since XWiki 4.1M1. Use XWiki.EditLock.lock instead."),XWiki.EditLock.lock()},window.cancelCancelEdit=function(){a("window.cancelCancelEdit is deprecated since XWiki 4.1M1. Use XWiki.EditLock.setLocked(false) instead."),XWiki.EditLock.setLocked(!1)},XWiki.resource=XWiki.resource||{},Object.extend(XWiki.resource,{getWikiFromResourceName:function(b){return b.include(XWiki.constants.wikiSpaceSeparator)?b.substring(0,b.indexOf(XWiki.constants.wikiSpaceSeparator)):null},getSpaceFromResourceName:function(c){var b=c;return c.include(XWiki.constants.wikiSpaceSeparator)&&(c=c.substring(c.indexOf(XWiki.constants.wikiSpaceSeparator)+1,c.length)),c.include(XWiki.constants.spacePageSeparator)?c.include(XWiki.constants.pageAttachmentSeparator)&&c.indexOf(XWiki.constants.spacePageSeparator)>c.indexOf(XWiki.constants.pageAttachmentSeparator)?null:c.substring(0,c.indexOf(XWiki.constants.spacePageSeparator)):!b.include(XWiki.constants.wikiSpaceSeparator)||b.include(XWiki.constants.pageAttachmentSeparator)||b.include(XWiki.constants.anchorSeparator)?null:c},getNameFromResourceName:function(c){var b=c;return c.include(XWiki.constants.wikiSpaceSeparator)&&(c=c.substring(c.indexOf(XWiki.constants.wikiSpaceSeparator)+1,c.length)),c.include(XWiki.constants.pageAttachmentSeparator)&&(c=c.substring(0,c.indexOf(XWiki.constants.pageAttachmentSeparator))),c.include(XWiki.constants.anchorSeparator)&&(c=c.substring(0,c.indexOf(XWiki.constants.anchorSeparator))),c.include(XWiki.constants.spacePageSeparator)?c.substring(c.indexOf(XWiki.constants.spacePageSeparator)+1,c.length):b.include(XWiki.constants.wikiSpaceSeparator)?null:c},getAttachmentFromResourceName:function(b){return b.include(XWiki.constants.pageAttachmentSeparator)?b.substring(b.indexOf(XWiki.constants.pageAttachmentSeparator)+1,b.length):null},getAnchorFromResourceName:function(b){return b.include(XWiki.constants.anchorSeparator)?b.substring(b.indexOf(XWiki.constants.anchorSeparator)+1,b.length):null}}),XWiki.constants=XWiki.constants||{},Object.extend(XWiki.constants,{wikiSpaceSeparator:":",spacePageSeparator:".",pageAttachmentSeparator:"@"}),function(){if(!(0<$$("meta[name='document']").length)){var c=$$("html")[0],b=$$("head")[0],d=function(e,f){b.insert(new Element("meta",{name:e,content:c.readAttribute("data-xwiki-"+f)}))};d("document","document"),d("wiki","wiki"),d("space","space"),d("page","page"),d("version","version"),d("restURL","resturl"),d("form_token","form-token"),b.insert(new Element("meta",{name:"language",content:c.readAttribute("lang")}))}}()}(),XWiki.lastScriptLoaded=!0,XWiki.failedInit&&XWiki.initialize();var PedigreeDate=Class.create({initialize:function(date){if(this.decade=null,this.year=null,this.month=null,(this.day=null)!=date&&date){var jsDate=null;if("string"==typeof date||date instanceof String){if(date.match(/^\d\d\d\ds$/))this.decade=date;else if(!isNaN(Date.parse(date))){if(null!==(parsed=date.match(/\w\w\w (\w\w\w) (\d\d) \d\d:\d\d:\d\d \w\w\w (\d\d\d\d)/))){var timezonelessDate=parsed[1]+" "+parsed[2]+", "+parsed[3];jsDate=new Date(timezonelessDate)}else{var parsed;if(null!==(parsed=date.match(/(\d\d\d\d)-(\d\d)-(\d\d)/))){var month0based=parseInt(parsed[2])-1;timezonelessDate=this._getMonthName("en",month0based)+" "+parsed[3]+", "+parsed[1];jsDate=new Date(timezonelessDate)}else jsDate=new Date(date)}}}else"[object Date]"===Object.prototype.toString.call(date)&&(jsDate=date);null!==jsDate?(this.year=jsDate.getFullYear(),this.month=jsDate.getMonth()+1,this.day=jsDate.getDate()):"object"==typeof date&&(date.hasOwnProperty("decade")&&(this.decade=date.decade),date.hasOwnProperty("year")&&(this.year=this.parseIntOrNull(date.year)),date.hasOwnProperty("month")&&(this.month=this.parseIntOrNull(date.month)),date.hasOwnProperty("day")&&(this.day=this.parseIntOrNull(date.day))),null!==this.year&&null===this.decade&&(this.decade=this.year.toString().slice(0,-1)+"0s")}},parseIntOrNull:function(expectedInteger){var result=parseInt(expectedInteger);return isNaN(result)?null:result},toString:function(){return null===this.year&&null!==this.decade?this.decade:null!==this.year&&null==this.month?this.year.toString():null!==this.year&&null!==this.month&&null===this.day?this.getMonthName()+" "+this.year:null===this.year||null===this.month||null===this.day?"":this.toJSDate().toDateString()},getMonthName:function(locale){return null==this.getMonth()?"":(locale=locale&&locale in localeMonthNames?locale:"en",this._getMonthName(locale,this.getMonth()-1))},_getMonthName:function(locale,month0based){return{en:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]}[locale][month0based]},toGEDCOMString:function(){return null===this.year&&null!==this.decade?"ABT "+this.getYear(!0).toString():this.toString()},isSet:function(){return null!==this.decade||null!==this.year||null!==this.month||null!==this.day},isComplete:function(){return null!==this.decade},onlyDecadeAvailable:function(){return null!==this.decade&&null==this.year},getDecade:function(){return this.decade},getSimpleObject:function(){var date={};return null!==this.decade&&(date.decade=this.decade),null!==this.year&&(date.year=this.year),null!==this.month&&(date.month=this.month),null!==this.day&&(date.day=this.day),date},toJSDate:function(){var year=this.getYear(!0),month=this.getMonth(!0)-1,day=this.getDay(!0);return new Date(year,month,day)},getBestPrecisionStringYear:function(){return this.isComplete()?null==this.year?this.decade:this.year.toString():""},getMostConservativeYearEstimate:function(){return this.isComplete()?this.getYear(!0,!1).toString():""},getAverageYearEstimate:function(){return this.isComplete()?this.getYear(!0,!0).toString():""},getBestPrecisionStringDDMMYYY:function(dateFormat){if(dateFormat||(dateFormat="DMY"),!this.isComplete())return"";if(null==this.year)return this.decade;var dateStr=this.getYear().toString();return null!=this.getMonth()&&(dateStr=("0"+this.getMonth()).slice(-2)+"-"+dateStr,null!=this.getDay()&&"DMY"==dateFormat&&(dateStr=("0"+this.getDay()).slice(-2)+"-"+dateStr)),dateStr},getTime:function(){return this.toJSDate().getTime()},getYear:function(failsafe,average){if(this.isComplete()&&null==this.year&&failsafe){var year=parseInt(this.decade.slice(0,-1));return average&&(year+=5),year}return this.year},getMonth:function(failsafe){return this.isComplete()&&null==this.month&&failsafe?1:this.month},getDay:function(failsafe){return this.isComplete()&&null==this.day&&failsafe?1:this.day},canBeAfterDate:function(otherPedigreeDate){if(!this.isComplete())return!0;if(!otherPedigreeDate.isComplete())return!0;if(this.getTime()>otherPedigreeDate.getTime())return!0;var leastOtherYear=otherPedigreeDate.getYear(!0),leastOtherMonth=otherPedigreeDate.getMonth(!0),leastOtherDay=otherPedigreeDate.getDay(!0),maxThisYear=this.year?this.year:this.getYear(!0)+9,maxThisMonth=this.month?this.month:12,maxThisDay=this.day?this.day:31;return leastOtherYear<maxThisYear||!(maxThisYear<leastOtherYear)&&(leastOtherMonth<maxThisMonth||!(maxThisMonth<leastOtherMonth)&&leastOtherDay<=maxThisDay)}}),PedigreeEditorParameters={styles:{blackAndWhite:{nodeShapeFemale:{fill:"#ffffff",stroke:"#222222"},nodeShapeMale:{fill:"#ffffff",stroke:"#111111"},nodeShapeOther:{fill:"#ffffff",stroke:"#222222"},nodeShapeDiag:{fill:"#ffffff",stroke:"#222222"},nodeShapeAborted:{fill:"#ffffff",stroke:"#222222"}}}};PedigreeEditorParameters.attributes={radius:40,orbRadius:6,touchOrbRadius:8,personHoverBoxRadius:90,newHandles:!0,personHandleLength:75,personHandleBreakX:55,personHandleBreakY:53,personSiblingHandleLengthX:65,personSiblingHandleLengthY:30,enableHandleHintImages:!0,handleStrokeWidth:5,groupNodesScale:.85,infertileMarkerHeight:4,infertileMarkerWidth:14,twinCommonVerticalLength:6,twinMonozygothicLineShiftY:24,curvedLinesCornerRadius:25,unbornShape:{"font-size":50,"font-family":"Cambria"},carrierShape:{fill:"#595959"},carrierDotRadius:8,presymptomaticShape:{fill:"#777777",stroke:"#777777"},presymptomaticShapeWidth:8,uncertainShape:{"font-size":"45px","font-family":"Arial",fill:"#696969","font-weight":"bold"},uncertainSmallShape:{"font-size":"30px","font-family":"Arial",fill:"#696969","font-weight":"bold"},evaluationShape:{"font-size":40,"font-family":"Arial"},nodeShapeFemale:PedigreeEditorParameters.styles.blackAndWhite.nodeShapeFemale,nodeShapeMale:PedigreeEditorParameters.styles.blackAndWhite.nodeShapeMale,nodeShapeOther:PedigreeEditorParameters.styles.blackAndWhite.nodeShapeOther,nodeShapeDiag:PedigreeEditorParameters.styles.blackAndWhite.nodeShapeDiag,nodeShapeAborted:PedigreeEditorParameters.styles.blackAndWhite.nodeShapeAborted,nodeShapeMenuOn:{fill:"#000",stroke:"none","fill-opacity":.1},nodeShapeMenuOff:{fill:"#000",stroke:"none","fill-opacity":0},nodeShapeMenuOnPartner:{fill:"#000",stroke:"none","fill-opacity":.1},nodeShapeMenuOffPartner:{fill:"#000",stroke:"none","fill-opacity":0},boxOnHover:{fill:"gray",stroke:"none",opacity:1,"fill-opacity":.35},menuBtnIcon:{fill:"#1F1F1F",stroke:"none"},deleteBtnIcon:{fill:"#990000",stroke:"none"},btnMaskHoverOn:{opacity:.6,stroke:"none"},btnMaskHoverOff:{opacity:0},btnMaskClick:{opacity:1},orbHue:.53,phShape:{fill:"white","fill-opacity":0,stroke:"black","stroke-dasharray":"- "},dragMeLabel:{"font-size":14,"font-family":"Tahoma"},pedNumberLabel:{"font-size":19,"font-family":"Serif"},descendantGroupLabel:{"font-size":21,"font-family":"Tahoma"},label:{"font-size":20,"font-family":"Arial"},nameLabels:{"font-size":20,"font-family":"Arial"},commentLabel:{"font-size":19,"font-family":"Arial"},cancerAgeOfOnsetLabels:{"font-size":19,"font-family":"Arial"},externalIDLabels:{"font-size":16,"font-family":"Arial"},disorderShapes:{},partnershipNode:{fill:"#d79185",stroke:"black","stroke-width":2},partnershipRadius:7,partnershipHandleBreakY:18,partnershipHandleLength:36,partnershipLines:{"stroke-width":1.25,stroke:"#303058"},partnershipLinesAdoptedIn:{"stroke-width":1.25,stroke:"#303058","stroke-dasharray":"--"},consangrPartnershipLines:{"stroke-width":1.25,stroke:"#402058"},noContactLines:{"stroke-width":1.25,stroke:"#303058","stroke-dasharray":"-.-."},noContactAdoptedIn:{"stroke-width":1.25,stroke:"#303058","stroke-dasharray":"-- ."},noContactLinesConsangr:{"stroke-width":1.25,stroke:"#402058","stroke-dasharray":"-.-."},childlessShapeAttr:{"stroke-width":2.5,stroke:"#3C3C3C"},participatingInTestAttr:{"stroke-width":1.5,"font-size":16,"font-weight":"boold","font-family":"Tahoma"},partnershipChildlessShapeAttr:{"stroke-width":2,stroke:"#3C3C3C"},childlessLength:14,parnershipChildlessLength:27,graphToCanvasScale:12,layoutRelativePersonWidth:10,layoutRelativeOtherWidth:2,layoutScale:{xscale:12,yscale:8},maxPrintPreviewPaneHeight:600,minPrintPreviewPaneHeight:250};var PhenoTips=function(PhenoTips){return(PhenoTips.widgets=PhenoTips.widgets||{}).SolrQueryProcessor=Class.create({initialize:function(queryFields,restriction){this.queryFields=queryFields,this.restriction=restriction},processQuery:function(query){return this.inflateQuery(query)},generateParameters:function(query){var parameters={defType:"edismax","spellcheck.collate":!0,spellcheck:!0,lowercaseOperators:!1};return this.setupMandatoryQuery(query,parameters)||(this.restrictQuery(query,parameters),this.setupQueryFields(query,parameters)),parameters},setupMandatoryQuery:function(query,parameters){var txt=query.strip(),mandatoryQuery="",hasMandatoryFields=!1;for(var field in this.queryFields){var fieldOptions=this.queryFields[field],activationRegex=fieldOptions.activationRegex;fieldOptions.mandatory&&activationRegex&&txt.match(activationRegex)&&(mandatoryQuery+=field+":"+(fieldOptions.transform?fieldOptions.transform(query):query)+" ",hasMandatoryFields=!0)}return mandatoryQuery&&(parameters.fq=mandatoryQuery.strip()),hasMandatoryFields},restrictQuery:function(query,parameters){if(this.restriction){var result="";for(var rField in this.restriction){for(var restrictionString=("-"==rField.substring(0,1)?"-":"+")+"(",i=0;i<this.restriction[rField].length;++i)restrictionString+=rField.replace(/^-/,"")+":"+this.restriction[rField][i].replace(/:/g,"\\:")+" ";result+=restrictionString=restrictionString.strip()+") "}result&&(parameters.fq=result.strip())}},setupQueryFields:function(query,parameters){var txt=query.strip(),wordFields="",phraseFields="",boostQuery="",lastWord=query.replace(/.*\W/g,"");for(var field in this.queryFields){var fieldOptions=this.queryFields[field],activationRegex=fieldOptions.activationRegex;activationRegex&&!txt.match(activationRegex)||(fieldOptions.wordBoost&&(wordFields+=field+"^"+fieldOptions.wordBoost+" "),fieldOptions.phraseBoost&&(phraseFields+=field+"^"+fieldOptions.phraseBoost+(fieldOptions.phraseSlop?"~"+fieldOptions.phraseSlop:"")+" "),lastWord&&fieldOptions.stubBoost&&(boostQuery+=field+":"+lastWord.replace(/:/g,"\\:")+"*^"+fieldOptions.stubBoost+" "))}wordFields&&(parameters.qf=wordFields.strip()),phraseFields&&(parameters.pf=phraseFields.strip()),boostQuery&&(parameters.bq=boostQuery.strip())},inflateQuery:function(query){var lastWord=query.replace(/.*\W/g,"");if(!lastWord)return query;var result=query;for(var field in this.queryFields)this.queryFields[field].stubTrigger&&(result+=" "+field+":"+lastWord.replace(/:/g,"\\:")+"*");return result.strip()}}),PhenoTips}(PhenoTips||{}),PhenoTips=function(PhenoTips){return(PhenoTips.widgets=PhenoTips.widgets||{}).OntologyBrowser=Class.create({options:{script:"${xwiki.getURL('PhenoTips.SolrService', 'get', 'sort=nameSort asc&start=0&rows=10000')}&",varname:"query",method:"post",json:!0,responseFormat:"application/json",resultsParameter:function(){return"rows"},resultId:function(){return"id"},resultValue:function(){return"name"},resultCategory:"term_category",resultParent:{selector:"is_a",processingFunction:function(text){var data={};return data.id=text.replace(/\s+/gm," ").replace(/(HP:[0-9]+)\s*!\s*(.*)/m,"$1"),data.value=text.replace(/\s+/gm," ").replace(/(HP:[0-9]+)\s*!\s*(.*)/m,"$2"),data}},noresults:"No sub-terms",targetQueryProcessor:void 0===PhenoTips.widgets.SolrQueryProcessor?null:new PhenoTips.widgets.SolrQueryProcessor({id:{activationRegex:/^HP:[0-9]+$/i,mandatory:!0,transform:function(query){return query.toUpperCase().replace(/:/g,"\\:")}}}),expandQueryProcessor:void 0===PhenoTips.widgets.SolrQueryProcessor?null:new PhenoTips.widgets.SolrQueryProcessor({is_a:{activationRegex:/^HP:[0-9]+$/i,mandatory:!0,transform:function(query){return query.toUpperCase().replace(/:/g,"\\:")}}}),showParents:!0,showRoot:!0,enableSelection:!0,enableBrowse:!0,isTermSelected:function(id){return!1},unselectTerm:function(id){},defaultEntryAction:"browse"},initialize:function(suggest,container,options){this.options=Object.extend(Object.clone(this.options),options||{}),this.suggest=suggest,this.loadingMessage=new Element("div",{class:"plainmessage loading"}).update("Loading..."),container?this.container=container:(this.container=new PhenoTips.widgets.ModalPopup(this.loadingMessage,{},{idPrefix:"ontology-browser-window-",title:"Related terms",backgroundColor:"#ffffff",verticalPosition:"top",extraDialogClassName:"dialog-ontology-browser",removeOnClose:!0}),this.options.modal=!0),this._obrowserExpandEventHandler=this._obrowserExpandEventHandler.bindAsEventListener(this)},load:function(id){this.setContent(this.loadingMessage);var query=id,parameters={};null!=this.options.targetQueryProcessor&&"function"==typeof this.options.targetQueryProcessor.generateParameters&&(parameters=this.options.targetQueryProcessor.generateParameters(query)),null!=this.options.targetQueryProcessor&&"function"==typeof this.options.targetQueryProcessor.processQuery&&(query=this.options.targetQueryProcessor.processQuery(query));var url=this.options.script+this.options.varname+"="+encodeURIComponent(query),headers={};headers.Accept=this.options.responseFormat;new Ajax.Request(url,{method:this.options.method,parameters:parameters,requestHeaders:headers,onSuccess:function(response){this.setContent(this.buildTree(this._getDataFromResponse(response))),this.__crtRoot=id,this.container.content&&Event.fire(document,"xwiki:dom:updated",{elements:[this.container.contentContainer||this.container.content]})}.bind(this),onFailure:function(response){this.setContent("Failed to retrieve data : "+response.statusText),this.__crtRoot=""}.bind(this)})},expandTo:function(termId,categories){-1!=categories.indexOf(this.__crtRoot)&&this._expandToStep(termId,categories.without(this.__crtRoot,termId))},_expandToStep:function(termId,categories){var _this=this;if(!this.container.contentContainer.down('li.entry input.select-tool[value="'+termId.replace(/"/g,'\\"')+'"]')){var finishedStep=!1;categories.each(function(category){if(!finishedStep){var categoryInput=_this.container.contentContainer.down('li.entry input.select-tool[value="'+category.replace(/"/g,'\\"')+'"]');if(categoryInput){var categoryEntry=categoryInput.up("li");!categoryEntry.hasClassName("collapsed")&&categoryEntry.down(".descendents")||(Event.observe(categoryEntry,"obrowser:expand:finished",function(event){Event.stopObserving(categoryEntry,"obrowser:expand:finished"),_this._expandToStep(termId,categories.without(category))}),_this._toggleExpandState(categoryEntry),finishedStep=!0)}}})}},expand:function(element,doPopulate){var query=element.__termId,parameters={};null!=this.options.expandQueryProcessor&&"function"==typeof this.options.expandQueryProcessor.generateParameters&&(parameters=this.options.expandQueryProcessor.generateParameters(query)),null!=this.options.expandQueryProcessor&&"function"==typeof this.options.expandQueryProcessor.processQuery&&(query=this.options.expandQueryProcessor.processQuery(query));var url=this.options.script+this.options.varname+"="+encodeURIComponent(query),headers={};headers.Accept=this.options.responseFormat;new Ajax.Request(url,{method:this.options.method,requestHeaders:headers,parameters:parameters,onCreate:function(){this._lockExpandTool(element)}.bind(this),onSuccess:function(response){var memo={};if(doPopulate){var newAdditions=this.buildDescendentsList(this._getDataFromResponse(response));element.insert({bottom:newAdditions}),Event.fire(document,"obrowser:content:added",{added:newAdditions,obrowser:this}),Event.fire(element,"obrowser:expand:finished"),Event.fire(this.container.contentContainer||document,"obrowser:expand:finished"),Event.fire(document,"xwiki:dom:updated",{elements:[newAdditions]})}else memo.count=this.countDescendents(this._getDataFromResponse(response));if(0===memo.count||doPopulate&&!element.down(".descendents .entry, .error")){element.addClassName("collapsed");var expandTool=element.down(".expand-tool");expandTool&&(expandTool.update(this._getExpandCollapseSymbol(!0)).addClassName("disabled"),expandTool.stopObserving("click"))}Event.fire(document,"ms:popup:content-updated",{popup:this.container})}.bind(this),onFailure:function(response){Event.fire(element,"obrowser:expand:failed",{data:new Element("div",{class:"error"}).update("Failed to retrieve data : "+response.statusText),count:-1})},onComplete:function(){this._unlockExpandTool(element)}.bind(this)})},_getDataFromResponse:function(response){return this.options.json?response.responseJSON:response.responseXML},_getResultset_json:function(data,fieldName){return data&&data[fieldName]||[]},_getResultFieldValue_json:function(data,fieldName){return data&&data[fieldName]||""},_getResultFieldValueAsArray_json:function(data,fieldName){return new Array(data&&data[fieldName]||"").flatten()},_getResultset_xml:function(data,selector){return data&&data.getElementsByTagName(selector)},_getResultFieldValue_xml:function(data,selector){var element=data&&Element.down(data,selector);return element&&element.firstChild&&element.firstChild.nodeValue||""},_getResultFieldValueAsArray_xml:function(data,selector){var result=new Array;return data&&Element.select(data,selector).each(function(item){var value=item.firstChild&&item.firstChild.nodeValue;value&&result.push(value)}),result},_getResultset:function(data,fieldName){return this.options.json?this._getResultset_json(data,fieldName):this._getResultset_xml(data,fieldName)},_getResultFieldValue:function(data,fieldName){return this.options.json?this._getResultFieldValue_json(data,fieldName):this._getResultFieldValue_xml(data,fieldName)},_getResultFieldValueAsArray:function(data,fieldName){return this.options.json?this._getResultFieldValueAsArray_json(data,fieldName):this._getResultFieldValueAsArray_xml(data,fieldName)},buildTree:function(data){var results=this._getResultset(data,this.options.resultsParameter());if(0==results.length)return new Element("div",{class:"error"}).update(this.options.noresults);var targetResult=results[0],newContent=new Element("div");if(this.options.showParents){var parents=new Element("ul",{class:"parents"});this._getResultFieldValueAsArray(targetResult,this.options.resultParent.selector).each(function(item){var text=item,data={};"function"==typeof this.options.resultParent.processingFunction&&(data=this.options.resultParent.processingFunction(text)),parents.insert({bottom:this._createParentBranch(data)})}.bind(this)),parents.hasChildNodes()&&newContent.insert({top:parents}),Event.fire(document,"obrowser:content:added",{added:parents,obrowser:this})}data={id:this._getResultFieldValue(targetResult,this.options.resultId()),value:this._getResultFieldValue(targetResult,this.options.resultValue()),category:this._generateEntryCategory(targetResult)};var root=this._createRoot(data);return newContent.insert({bottom:root}),Event.fire(document,"obrowser:content:added",{added:root,obrowser:this}),newContent},countDescendents:function(xml){return this._getResultset(xml,this.options.resultsParameter()).length},buildDescendentsList:function(xml){for(var results=this._getResultset(xml,this.options.resultsParameter()),list=new Element("ul",{class:"descendents"}),i=0;i<results.length;i++){var data={id:this._getResultFieldValue(results[i],this.options.resultId()),value:this._getResultFieldValue(results[i],this.options.resultValue()),category:this._generateEntryCategory(results[i])};list.insert({bottom:this._createDescendentBranch(data)})}return list.hasChildNodes()?list:new Element("div",{class:"descendents hint empty"}).update(this.options.noresults)},_createBranch:function(eltName,className,data,expandable){var element=new Element(eltName,{class:"entry "+className});element.__termId=data.id,element.__termCategory=data.category;var wrapper=new Element("div",{class:"entry-data"});wrapper.insert({bottom:this._generateEntryTitle(data.id,data.value)});var entryTools=new Element("span",{class:"entry-tools"});if(entryTools.observe("click",function(event){event.stop()}),wrapper.insert({bottom:entryTools}),element.update(wrapper),this._isRootEntry(element)||"browse"==this.options.defaultEntryAction&&wrapper.down(".info").observe("click",this._browseEntry.bindAsEventListener(this)),entryTools.insert(new Element("span",{class:"fa fa-info-circle phenotype-info xHelpButton",title:data.id})),this.options.enableSelection&&(element.__selectTool=new Element("input",{type:"checkbox",name:"term_selector",value:data.id,class:"select-tool"}),wrapper.insert({top:element.__selectTool}),this.options.isTermSelected(element.__termId)&&(element.addClassName("accepted"),element.__selectTool.checked="checked"),element.__selectTool.observe("click",this._toggleEntrySelection.bindAsEventListener(this)),"select"==this.options.defaultEntryAction&&wrapper.down(".info").observe("click",this._toggleEntrySelection.bindAsEventListener(this))),expandable){var expandTool=new Element("span",{class:"expand-tool"}).update(this._getExpandCollapseSymbol(!element.hasClassName("root")));expandTool.observe("click",function(event){var entry=event.element().up(".entry");this._isExpandToolLocked(entry)||this._toggleExpandState(entry)}.bindAsEventListener(this));var expandOnSelect=function(e){this._isExpandToolLocked(element)||"yes"!=e.memo.selected||this._expandEntry(element)};element.observe("obrowser:entry:selected",expandOnSelect.bindAsEventListener(this)),element.observe("ynpicker:selectionChanged",expandOnSelect.bindAsEventListener(this)),wrapper.insert({top:expandTool}),this.expand(element,element.hasClassName("root"))}return element},_generateEntryTitle:function(id,value){return new Element("span",{class:"info"}).insert({bottom:new Element("span",{class:"key"}).update("["+id+"]")}).insert({bottom:" "}).insert({bottom:new Element("span",{class:"value"}).update(value)})},_generateEntryCategory:function(xmlFragment){var category=new Element("span",{class:"hidden term-category"});return this.options.resultCategory&&this._getResultFieldValueAsArray(xmlFragment,this.options.resultCategory).each(function(c){category.insert(new Element("input",{type:"hidden",value:c}))}),category.hasChildNodes()?category:null},_expandEntry:function(target){target&&(target.down(".descendents")?Event.fire(target,"obrowser:expand:finished"):(target.down(".error")&&target.down(".error").remove(),this.expand(target,!0)),target.removeClassName("collapsed"),target.down(".expand-tool").update(this._getExpandCollapseSymbol(!1)))},_collapseEntry:function(target){target&&(target.addClassName("collapsed"),Event.fire(target,"obrowser:expand:finished"),target.down(".expand-tool").update(this._getExpandCollapseSymbol(!0)))},_toggleExpandState:function(target){target&&(!target.down(".descendents")||target.hasClassName("collapsed")?this._expandEntry(target):this._collapseEntry(target))},_obrowserExpandEventHandler:function(event){var element=event.element();if(event.memo){if(event.memo.data?(element.insert({bottom:event.memo.data}),element.stopObserving("obrowser:expand:done",this._obrowserExpandEventHandler)):void 0!==event.memo.count&&element.stopObserving("obrowser:count:done",this._obrowserExpandEventHandler),element.stopObserving("obrowser:expand:failed",this._obrowserExpandEventHandler),"0"==event.memo.count||!element.hasClassName("root")&&event.memo.data&&!element.down(".descendents .entry, .error")){element.addClassName("collapsed");var expandTool=element.down(".expand-tool");expandTool&&(expandTool.update(this._getExpandCollapseSymbol(!0)).addClassName("disabled"),expandTool.stopObserving("click"))}this._unlockExpandTool(element),Event.fire(document,"ms:popup:content-updated",{popup:this.container}),event.memo.data&&Event.fire(element,"obrowser:expand:finished")}},_lockExpandTool:function(element){var expandTool=element.down(".expand-tool");expandTool&&expandTool.addClassName("locked")},_unlockExpandTool:function(element){var expandTool=element.down(".expand-tool");expandTool&&expandTool.removeClassName("locked")},_isExpandToolLocked:function(element){return!!element.down(".expand-tool.locked")},_getExpandCollapseSymbol:function(isCollapsed){return isCollapsed?"&#x25ba;":"&#x25bc;"},_toggleEntrySelection:function(event){var trigger=event.element();if(trigger.hasClassName("select-tool")){var elt=trigger.up(".entry");trigger.checked?this._selectEntry(elt):this._unselectEntry(elt)}else trigger.up(".entry").down("input").click()},_selectEntry:function(entry){if(this.suggest){if(this.options.modal&&"function"==typeof this.container.getPositionInViewport)var prevPosition=this.container.getPositionInViewport();var value=entry.down(".value").firstChild.nodeValue;this.suggest.acceptEntry({id:entry.__termId,value:value,category:entry.__termCategory,negative:entry.down(".selected.no")},value,"",!0),entry.addClassName("accepted"),prevPosition&&"function"==typeof this.container.positionDialogInViewport&&this.container.positionDialogInViewport(prevPosition.left,prevPosition.top),entry.fire("obrowser:entry:selected",{selected:entry.down(".selected.no")?"no":"yes"})}},_unselectEntry:function(entry){this.options.unselectTerm(entry.__termId),this.options.unselectTerm(entry.__termId,!0),entry.removeClassName("accepted")},_browseEntry:function(event){event.stop();var elt=event.element().up(".entry");this.load(elt.__termId)},_createParentBranch:function(parent){return parent=this._createBranch("li","parent",parent,!1)},_createRoot:function(data){var root=this._createBranch("div","root",data,!0);return this.options.showRoot||(root.addClassName("no-root"),root.down(".entry-data").addClassName("invisible")),root},_createDescendentBranch:function(data){return this._createBranch("li","descendent",data,!0)},_isRootEntry:function(element){return element.hasClassName("entry")&&element.hasClassName("root")},setContent:function(content){this.container.setContent(new Element("div",{class:"ontology-tree"}).update(content))},show:function(id){id&&(this.container.show(),this.__crtRoot!=id?this.load(id):Event.fire(this.container.contentContainer||document,"obrowser:expand:finished"))},hide:function(){this.container.close()}}),PhenoTips}(PhenoTips||{}),PhenoTips=function(PhenoTips){return(PhenoTips.widgets=PhenoTips.widgets||{}).DropDown=Class.create({options:{},initialize:function(element){this.element=element,this.hasForceOpen=!1;var existingDropdown=element.next(".dropdown");existingDropdown?(this.contentContainer=null,this.dropdown=existingDropdown,this.hasForceOpen=!0):(this.dropdown=new Element("div",{class:"dropdown"}),this.contentContainer=new Element("div"),this.dropdown.update(this.contentContainer))},setContent:function(content){null!=this.contentContainer&&this.contentContainer.update(content)},show:function(force){return!(force&&!this.hasForceOpen)&&(this.dropdown.hasClassName("invisible")?this.dropdown.removeClassName("invisible"):this.element.insert({after:this.dropdown}),!0)},close:function(force){return!(force&&!this.hasForceOpen)&&(this.dropdown.addClassName("invisible"),!0)}}),PhenoTips}(PhenoTips||{});StickyBox=Class.create({options:{offsetTop:6,offsetBottom:0,resize:!1,isSticky:function(element){return!0}},initialize:function(stickyElement,stickyAreaElement,options){this.stickyElement=stickyElement,this.stickyAreaElement=stickyAreaElement,this.stickyElement&&this.stickyAreaElement&&(this.options=Object.extend(Object.clone(this.options),options||{}),this.options.shadowSize&&void 0===options.offsetTop&&(this.options.offsetTop=this.options.shadowSize),this.resetPosition=this.resetPosition.bindAsEventListener(this),Event.observe(window,"scroll",this.resetPosition),Event.observe(window,"resize",this.resetPosition),"function"==typeof this.options.makeDefault&&(thid.makeDefault=this.options.makeDefault.bind(this)),this.resetPosition())},resetPosition:function(){if(this.options.isSticky(this.stickyElement)&&!(this.stickyElement.getHeight()>=this.stickyAreaElement.getHeight())){this.stickyElement.style.height="",this.stickyElement.style.overflow="",this.stickyElement.fire("size:changed"),this.boxHeight=this.stickyElement.getHeight();var maxBoxHeight=document.viewport.getHeight()-this.options.offsetTop-this.options.offsetBottom;if(this.options.resize){var memo={diff:maxBoxHeight-this.boxHeight,original:this.boxHeight};this.boxHeight=maxBoxHeight,this.stickyElement.style.height=this.boxHeight+"px",this.stickyElement.style.overflow="auto",this.stickyElement.fire("size:changed",memo)}this.boxWidth=this.stickyElement.getWidth(),this.boxMinTop=this.stickyAreaElement.cumulativeOffset().top+this.options.offsetTop,this.boxMaxTop=this.stickyAreaElement.cumulativeOffset().top+this.stickyAreaElement.getHeight()-this.boxHeight,this.boxLeft=this.stickyElement.cumulativeOffset().left,this.boxRelativeLeft=this.boxLeft-this.stickyElement.getOffsetParent().viewportOffset().left;var relativeContentPosition=this.stickyAreaElement.viewportOffset().top;this.direction=0,this.stickyAreaElement._prevPosition&&(this.stickyAreaElement._prevPosition>relativeContentPosition?this.direction=1:this.stickyAreaElement._prevPosition<relativeContentPosition&&(this.direction=-1)),(this.options.isSticky(this.stickyElement)||1==this.direction)&&document.viewport.getScrollOffsets().top>=this.boxMinTop&&document.viewport.getScrollOffsets().top<this.boxMaxTop?this.makeFixed():(this.options.isSticky(this.stickyElement)||-1==this.direction)&&document.viewport.getScrollOffsets().top>=this.boxMaxTop?this.makeAbsolute():this.makeDefault(),this.stickyAreaElement._prevPosition=relativeContentPosition}},makeFixed:function(){"fixed"!=this.stickyElement.style.position&&(this.stickyElement.addClassName("sticky"),this.stickyElement.style.left=this.boxLeft+"px",this.stickyElement.style.width=this.boxWidth+"px",this.stickyElement.style.top=this.options.offsetTop+"px",this.stickyElement.style.right="",this.stickyElement.style.position="fixed")},makeAbsolute:function(top){if("absolute"!=this.stickyElement.style.position){this.stickyElement.addClassName("sticky"),top=top||this.stickyAreaElement.getHeight()-this.stickyElement.getHeight(),this.stickyElement.style.top=top+"px",this.stickyElement.style.right="";var originalPosition=this.stickyElement.getStyle("position");this.stickyElement.style.position="absolute","fixed"!=originalPosition||Prototype.Browser.WebKit?this.stickyElement.style.left=this.boxRelativeLeft+"px":this.stickyElement.style.left=this.boxRelativeLeft-this.stickyElement.getOffsetParent().viewportOffset().left+2+"px"}},makeDefault:function(){""!=this.stickyElement.style.position&&(this.stickyElement.removeClassName("sticky"),this.stickyElement.style.position="",this.stickyElement.style.top="",this.stickyElement.style.left="",this.stickyElement.style.right="",this.stickyElement.style.width="")},isFixed:function(){return"fixed"==this.stickyElement.style.position},isAbsolute:function(){return"absolute"==this.stickyElement.style.position},isDefault:function(){return""==this.stickyElement.style.position}});var PhenoTips=function(PhenoTips){return(PhenoTips.widgets=PhenoTips.widgets||{}).FreeMultiselect=Class.create({counter:1,options:{returnKeyNavigation:!1},initialize:function(element,options){this.options=Object.extend(Object.clone(this.options),options||{});var _this=this,suggestInfoSource=element.previous('input[name="xwiki-free-multiselect-suggest-script"][type="hidden"]');if(suggestInfoSource&&suggestInfoSource.value&&void 0!==XWiki.widgets.Suggest&&(this.suggestOptions={script:suggestInfoSource.value,shownoresults:!1,varname:"input",timeout:0}),this.enhanceLine=this.enhanceLine.bind(this),element.select("li input.xwiki-free-multiselect-value").each(this.enhanceLine),element.down("input.xwiki-free-multiselect-value")){var addTool=new Element("a",{title:"add",href:"#"+element.id}).update("+...");element.insert(addTool.wrap("li")),addTool.observe("click",function(event){event.stop();var prevLine=addTool.up("li").previous(),template=prevLine&&prevLine.down("input.xwiki-free-multiselect-value");template&&_this.generateInput(template)}.bindAsEventListener(this))}},enhanceLine:function(element){element.id=this.generateId(element),element.up("li").addClassName("xwiki-free-multiselect-line"),this.attachDeleteTool(element),this.suggestOptions&&new XWiki.widgets.Suggest(element,this.suggestOptions),this.enableAddInput(element)},attachDeleteTool:function(element){var wrapper=element.up(".xwiki-free-multiselect-line"),deleteTool=new Element("a",{title:"delete",href:"#"+element.id}).update("");wrapper.insert(" ").insert(deleteTool),deleteTool.observe("click",function(event){event.stop();var wrapper=event.findElement(".xwiki-free-multiselect-line");if(wrapper.previous(".xwiki-free-multiselect-line")||wrapper.next(".xwiki-free-multiselect-line"))wrapper.remove();else{var target=wrapper.down("input");target.value="",target.focus()}})},enableAddInput:function(element){var wrapper=element.up(".xwiki-free-multiselect-line"),_this=this;wrapper&&element.observe("keypress",function(event){if(event.keyCode==Event.KEY_RETURN){event.stop();var next=wrapper.next(".xwiki-free-multiselect-line");_this.options.returnKeyNavigation&&next&&next.down("input")?next.down("input").focus():(element.next().removeClassName("inactive"),_this.generateInput(element))}else if(event.keyCode==Event.KEY_BACKSPACE&&""==element.value){event.stop();var previous=wrapper.previous(".xwiki-free-multiselect-line");previous&&previous.down("input")&&(previous.down("input").focus(),element.up(".xwiki-free-multiselect-line").remove())}})},generateInput:function(template){var newInput=new Element("input",{name:template.name,id:this.generateId(template),type:template.type,size:template.size,class:"xwiki-free-multiselect-value"}),newWrapper=new Element("li");newWrapper.insert(newInput),template.up(".xwiki-free-multiselect-line").insert({after:newWrapper}),this.enhanceLine(newInput),newInput.focus()},generateId:function(element){return element.name+"_"+this.nextIndex()},nextIndex:function(){return++this.counter},lastIndex:function(){return this.counter}}),PhenoTips}(PhenoTips||{});document.observe("xwiki:dom:loaded",function(){$$(".xwiki-free-multiselect").each(function(element){new PhenoTips.widgets.FreeMultiselect(element)})});var XWiki=function(XWiki){(XWiki.widgets=XWiki.widgets||{}).VisibilityController=Class.create({initialize:function(element){this.element=element,this.reverse=this.element.hasClassName("exclude"),this.controller=this.element.select(".controller input[type=checkbox]");var eventName="change";0!=this.controller.length&&(1==this.controller.length?this.controller=this.controller[0]:(this.controller=this.element.down(".controller .yes input[type=checkbox]"),eventName="picker:change"),this.controller&&(this.controlled=this.element.select(".controlled"),this.element.hasClassName("complete-hide")?(this.hiddenStyle={display:"none"},this.visibleStyle={display:""}):(this.hiddenStyle={visibility:"hidden"},this.visibleStyle={visibility:"visible"}),this.controlVisibility(),this.controller.observe(eventName,this.controlVisibility.bindAsEventListener(this))))},controlVisibility:function(){this.controller.checked^this.reverse?(this.controlled.invoke("setStyle",this.hiddenStyle),this.element.select(".controlled input").invoke("disable")):(this.controlled.invoke("setStyle",this.visibleStyle),this.element.select(".controlled input").invoke("enable"))}});var init=function(event){return(event&&event.memo.elements||[document.getElementById(PedigreeEditorTool.divId)]).each(function(element){element.select(".controlled-group").each(function(group){group.__visibilityController||(group.__visibilityController=new XWiki.widgets.VisibilityController(group))})}),!0};return XWiki.domIsLoaded&&init()||document.observe("xwiki:dom:loaded",init),document.observe("xwiki:dom:updated",init),XWiki}(XWiki||{}),PhenoTips=function(PhenoTips){return(PhenoTips.widgets=PhenoTips.widgets||{}).UnitConverter=Class.create({CONVERSION_META:{weight:{imperial_units:["lb","oz"],metric_unit:"kg",inter_unit_scale:16,inter_system_scale:.0283495},length:{imperial_units:["ft","in"],metric_unit:"cm",inter_unit_scale:12,inter_system_scale:2.54}},DEFAULT_UNIT_SYSTEM:"metric",initialize:function(container,selector,triggerInsertionElt,triggerInsertionPosition,system){if(this._selector=selector,this._container=container||document.documentElement,this._selector&&triggerInsertionElt){this.crtUnitSystem=system||this.DEFAULT_UNIT_SYSTEM,this.initializeElements=this.initializeElements.bind(this),this.attachConverter=this.attachConverter.bind(this),this.generateTrigger(triggerInsertionElt,triggerInsertionPosition||"bottom"),this.initializeElements();var _this=this;document.observe("xwiki:dom:updated",function(event){event.memo&&event.memo.elements&&event.memo.elements.each(_this.initializeElements.bind(_this))})}},generateTrigger:function(atElement,position){this._trigger=new Element("select",{class:"unit-system-selector"});var optionMetric=new Element("option",{value:"metric"}).update("Metric units ("+this.CONVERSION_META.weight.metric_unit+", "+this.CONVERSION_META.length.metric_unit+")");"metric"==this.crtUnitSystem&&(optionMetric.selected="selected");var optionImperial=new Element("option",{value:"imperial"}).update("Imperial units ("+this.CONVERSION_META.weight.imperial_units.join(" / ")+", "+this.CONVERSION_META.length.imperial_units.join(" / ")+")");"imperial"==this.crtUnitSystem&&(optionImperial.selected="selected"),this._trigger.insert(optionMetric).insert(optionImperial),insertionInfo={},insertionInfo[position]=this._trigger,atElement.insert(insertionInfo);var _this=this;this._trigger.observe("change",function(event){_this.crtUnitSystem=_this._trigger.options[_this._trigger.selectedIndex].value,_this.switchUnits(_this.crtUnitSystem)})},initializeElements:function(element){container=element||this._container,container.__unitSwitcher||!container.up(".measurements")&&!container.hasClassName("measurements")||(container.__unitSwitcher=this,container.select(this._selector).each(this.attachConverter),this.switchUnits(this.crtUnitSystem,container))},switchUnits:function(type,element){container=element||this._container,container.select(".unit-conversion-values .unit-type").each(function(item){item.hasClassName(type)?item.show():item.hide()})},attachConverter:function(element){if("input"==element.tagName.toLowerCase()&&"text"==element.type){var unitElt=element.next(".unit"),converterElement=new Element("div",{class:"unit-conversion-values"}),type=element.up(".weight")?"weight":"length";converterElement.addClassName(type),converterElement._meta=this.CONVERSION_META[type];var values=this.metricToImperial(converterElement._meta,parseFloat(element.value)||0),metricZone=element.up(".metric");metricZone?(metricZone.addClassName("unit-type"),metricZone.insert({after:converterElement})):((metricZone=new Element("div",{class:"unit-type metric"})).insert(element).insert(unitElt||converterElement._meta.metric_unit),element.insert({after:converterElement}));var imperialZone=new Element("div",{class:"unit-type imperial"});converterElement.insert(metricZone).insert(imperialZone),converterElement._meta.imperial_units.each(function(unit){imperialZone.insert(new Element("label").insert(new Element("input",{style:"width: auto",name:unit,type:"text",size:3,value:values[unit]||""})).insert(unit))}),this.enableSyncValues(converterElement)}},enableSyncValues:function(element){var _this=this;element.select(".imperial input").invoke("observe","change",function(event){_this.syncMetricWithImperial(element)}),element.select(".metric input").invoke("observe","change",function(event){_this.syncImperialWithMetric(element)})},syncMetricWithImperial:function(element){var metricInput=element.down(".metric input");metricInput.value=this.imperialToMetric(element._meta,parseFloat(element.down('.imperial input[name="'+element._meta.imperial_units[0]+'"]').value)||0,parseFloat(element.down('.imperial input[name="'+element._meta.imperial_units[1]+'"]').value)||0)||"",Event.fire(metricInput,"phenotips:measurement-updated")},syncImperialWithMetric:function(element){var imperialValues=this.metricToImperial(element._meta,parseFloat(element.down(".metric input").value)||0);element._meta.imperial_units.each(function(unit){element.down('.imperial input[name="'+unit+'"]').value=imperialValues[unit]||""})},metricToImperial:function(conversionMeta,value){var result={},lowerUnitValue=value/conversionMeta.inter_system_scale,higherUnitValue=Math.floor(lowerUnitValue/conversionMeta.inter_unit_scale);return(lowerUnitValue-=higherUnitValue*conversionMeta.inter_unit_scale)&&(lowerUnitValue=lowerUnitValue.toFixed(2)),result[conversionMeta.imperial_units[0]]=higherUnitValue,result[conversionMeta.imperial_units[1]]=lowerUnitValue,result},imperialToMetric:function(conversionMeta,higherUnitValue,lowerUnitValue){return((conversionMeta.inter_unit_scale*higherUnitValue+lowerUnitValue)*conversionMeta.inter_system_scale).toFixed(2)}}),PhenoTips}(PhenoTips||{});PhenoTips=function(PhenoTips){(PhenoTips.widgets=PhenoTips.widgets||{}).HelpButton=Class.create({infoServices:{xHelpButton:{hint:$services.localization.render("phenotips.widgets.helpButtons.xHelpButton.hint"),callback:function(helpButton){helpButton.helpBox.content.update(helpButton._information||"")}},"phenotype-info":{hint:$services.localization.render("phenotips.widgets.helpButtons.phenotype.hint"),service:"$xwiki.getURL('PhenoTips.PhenotypeInfoService', 'get')",callback:function(helpButton,json){var c=helpButton.helpBox.content,elt=function(type,cssClass,content){return new Element(type,cssClass&&{class:cssClass}||{}).update(content||"")};c.update(elt("span","info").insert(elt("span","key").update(json.id)).insert(" ").insert(elt("span","value").update(json.label))),json.def&&c.insert(elt("p").update(json.def.replace(/\s*\n\s*/," ").replace(/`([^`]+)`\s+\(([A-Z]+:[0-9]+)`?\)/g,'<em title="$2">$1</em>')));var labels={synonym:$services.localization.render("phenotips.widgets.helpButtons.phenotype.synonym"),is_a:$services.localization.render("phenotips.widgets.helpButtons.phenotype.typeOf")},advancedInfo=elt("dl");for(var l in labels)json[l]&&(advancedInfo.insert(elt("dt","",labels[l])),json[l].each(function(item){advancedInfo.insert(elt("dd","",item.label||item))}));if(advancedInfo.firstDescendant()&&c.insert(advancedInfo),PhenoTips.widgets.OntologyBrowser){var browseButton=new Element("a",{class:"button",href:"#"}).update($services.localization.render("phenotips.widgets.helpButtons.phenotype.browseRelated"));browseButton._id=json.id,browseButton.observe("click",function(event){event.stop();var suggest=($("quick-phenotype-search")||$$("input.suggestHpo")[0])._suggest,params={};"undefined"!=typeof isPhenotypeSelected&&(params={isTermSelected:isPhenotypeSelected,unselectTerm:unselectPhenotype}),browseButton._obrowser=new PhenoTips.widgets.OntologyBrowser(suggest,null,params),browseButton._obrowser.show(browseButton._id)}),c.insert(elt("div","term-tools").insert(browseButton.wrap("span",{class:"buttonwrapper"})))}}},"phenotype-qualifier-info":{hint:$services.localization.render("phenotips.widgets.helpButtons.phenotypeQualifier.hint"),service:"$xwiki.getURL('PhenoTips.PhenotypeInfoService', 'get')",callback:function(helpButton,json){var c=helpButton.helpBox.content,elt=function(type,cssClass,content){return new Element(type,cssClass&&{class:cssClass}||{}).update(content||"")};c.update(elt("span","info").insert(elt("span","key").update(json.id)).insert(" ").insert(elt("span","value").update(json.label))),json.def&&c.insert(elt("p").update(json.def.replace(/\s*\n\s*/," ").replace(/`([^`]+)`\s+\(([A-Z]+:[0-9]+)`?\)/g,'<em title="$2">$1</em>')))}},"omim-disease-info":{hint:"About this disease",service:"$xwiki.getURL('PhenoTips.OmimInfoService', 'get')",callback:function(helpButton,json){var c=helpButton.helpBox.content,elt=function(type,cssClass,content){return new Element(type,cssClass&&{class:cssClass}||{}).update(content||"")};c.update(elt("span","info").insert(elt("span","key").update(json.id)).insert(" ").insert(elt("span","value").update(json.label.splice(0,1)[0])));var labels={label:"",symptoms:$services.localization.render("phenotips.widgets.helpButtons.omimDisease.symptoms"),not_symptoms:$services.localization.render("phenotips.widgets.helpButtons.omimDisease.notSymptoms")},advancedInfo=elt("dl");for(var l in labels)json[l]&&0<json[l].length&&(advancedInfo.insert(elt("dt","",labels[l])),json[l].each(function(item){advancedInfo.insert(elt("dd","",item.label||item))}));advancedInfo.firstDescendant()&&c.insert(advancedInfo);var viewButton=new Element("a",{class:"button",href:"http://www.omim.org/entry/"+json.id,target:"_blank"}).update($services.localization.render("phenotips.widgets.helpButtons.omimDisease.linkToOmim"));if(c.insert(elt("div","term-tools").insert(viewButton.wrap("span",{class:"buttonwrapper"}))),viewButton.observe("click",function(event){event.stop(),window.open(viewButton.href)}),json.gene_reviews_link){var geneReviewsButton=new Element("a",{class:"button",href:json.gene_reviews_link,target:"_blank"}).update("Read about it on Gene Reviews...");c.insert(elt("div","term-tools").insert(geneReviewsButton.wrap("span",{class:"buttonwrapper"}))),geneReviewsButton.observe("click",function(event){event.stop(),window.open(geneReviewsButton.href)})}}},"gene-info":{hint:$services.localization.render("phenotips.widgets.helpButtons.gene.hint"),service:"$xwiki.getURL('PhenoTips.GeneInfoService', 'get')",callback:function(helpButton,json){var c=helpButton.helpBox.content,elt=function(type,cssClass,content){return new Element(type,cssClass&&{class:cssClass}||{}).update(content||"")};c.update(elt("span","info").insert(elt("span","key").update(json.symbol)).insert(" ").insert(elt("span","value").update(json.name)));var labels={alias_symbol:$services.localization.render("phenotips.widgets.helpButtons.gene.alias"),prev_symbol:$services.localization.render("phenotips.widgets.helpButtons.gene.previousSymbols"),gene_family:$services.localization.render("phenotips.widgets.helpButtons.gene.family")},advancedInfo=elt("dl");for(var l in labels)json[l]&&0<json[l].length&&(advancedInfo.insert(elt("dt","",labels[l])),"[object Array]"===Object.prototype.toString.call(json[l])?json[l].each(function(item){advancedInfo.insert(elt("dd","",item.label||item))}):advancedInfo.insert(elt("dd","",json[l])));if(advancedInfo.firstDescendant()&&c.insert(advancedInfo),json.external_ids){var tools=elt("div","term-tools");[{name:"GENECARDS",url:"http://www.genecards.org/cgi-bin/carddisp.pl?gene=",field:"genecards_id"},{name:"OMIM",url:"http://www.omim.org/entry/",field:"omim_id"},{name:"Entrez",url:"http://www.ncbi.nlm.nih.gov/gene/?term=",field:"entrez_id"},{name:"RefSeq",url:"http://www.ncbi.nlm.nih.gov/nuccore/",field:"refseq_accession"},{name:"Ensembl",url:"http://useast.ensembl.org/Homo_sapiens/Gene/Compara_Tree?g=",field:"ensembl_gene_id"}].each(function(item){var value=json.external_ids[item.field];value&&(value.each||(value=[value]),value.each(function(id){tools.insert(new Element("a",{href:item.url+id,class:"button"}).update(item.name+": "+id).wrap("span",{class:"buttonwrapper"}))}))}),tools.select("a").each(function(item){item.observe("click",function(event){event.stop(),window.open(item.href)})}),c.insert(tools)}}}},initialize:function(icon){for(var label in this.icon=icon,this._information=this.icon._information||this.icon.title,this.infoServices)this.icon.hasClassName(label)&&(this._builder=this.infoServices[label],this.icon.title=this.infoServices[label].hint||"");this._builder&&(this.icon.observe("click",this.toggleHelp.bindAsEventListener(this)),this.hideAllHelpOnOutsideClick=this.hideAllHelpOnOutsideClick.bindAsEventListener(this))},toggleHelp:function(){!this.helpBox||this.helpBox.hasClassName("hidden")?(this.showHelp(),document.observe("click",this.hideAllHelpOnOutsideClick)):this.hideHelp()},hideAllHelpOnOutsideClick:function(event){event.findElement(".xTooltip")||event.findElement(".xHelpButton")||(this.hideHelp(),document.stopObserving("click",this.hideAllHelpOnOutsideClick))},hideHelp:function(event){event&&event.stop(),this.helpBox&&(this.helpBox.hasClassName("error")?(this.helpBox.remove(),delete this.helpBox):this.helpBox.addClassName("hidden"))},showHelp:function(){this.helpBox||this.createHelpBox(),$$("div.xTooltip:not(.hidden)").invoke("_hideHelp"),this.helpBox.removeClassName("hidden")},createHelpBox:function(){this.helpBox=new Element("div",{class:"hidden xTooltip"}),(this.helpBox._behavior=this).helpBox._hideHelp=function(){this._behavior.hideHelp()}.bind(this.helpBox),this.helpBox.content=new Element("div"),this.helpBox.insert(this.helpBox.content),this._builder.service?this.createHelpContentFromService():this._builder.callback&&this._builder.callback(this);var closeButton=new Element("span",{class:"hide-tool",title:"Hide"});closeButton.update(""),closeButton.observe("click",this.hideHelp.bindAsEventListener(this)),this.helpBox.insert({top:closeButton}),this.icon.insert({after:this.helpBox})},createHelpContentFromService:function(){var _this=this;new Ajax.Request(_this._builder.service,{parameters:{id:_this._information},onCreate:function(){_this.helpBox.content.update(new Element("span",{class:"hint temporary"}).update($services.localization.render("phenotips.widgets.helpButtons.loading")))},onSuccess:function(response){_this._builder.callback(_this,response.responseJSON)},onFailure:function(response){_this.helpBox.addClassName("error"),_this.helpBox.down(".temporary").remove(),_this.helpBox.insert($services.localization.render("phenotips.widgets.helpButtons.failedToLoad").replace("__subject__",_this._information)+" : "+response.statusText)}})}});var init=function(event){return(event&&event.memo.elements||[document.getElementById(PedigreeEditorTool.divId)]).each(function(element){(element.hasClassName("xHelpButton")?[element]:element.select(".xHelpButton")).each(function(icon){icon.__helpController||(icon.__helpController=new PhenoTips.widgets.HelpButton(icon))})}),!0};return XWiki.domIsLoaded&&init()||document.observe("xwiki:dom:loaded",init),document.observe("xwiki:dom:updated",init),PhenoTips}(PhenoTips||{});var PhenoTips=function(PhenoTips){var widgets=PhenoTips.widgets=PhenoTips.widgets||{};widgets.FuzzyDatePickerDropdown=Class.create({initialize:function(options){this.span=new Element("span"),this.options=options,this.callback=null},populate:function(values){var selectedIndex=this.dropdown?this.dropdown.selectedIndex||this._tmpSelectedIndex:0,optionsHTML='<select name="'+this.options.name+'" class="'+(this.options.cssClass||this.options.name||"")+'" placeholder="'+(this.options.hint||this.options.name||"")+'" title="'+(this.options.hint||this.options.name||"")+'">';optionsHTML+='<option value="" class="empty"> </option>',values.each(function(item){optionsHTML+='<option value="'+item.value+'"',item.cssClass&&(optionsHTML+=' class="'+item.cssClass+'"'),item.selected&&(optionsHTML+=' selected="selected"'),optionsHTML+=">"+(item.text||item.value||"")+"</option>"}),optionsHTML+="</select>",this.span.innerHTML=optionsHTML,this.dropdown=this.span.firstChild,this.callback&&this.onSelect(this.callback),this.dropdown.selectedIndex<=0&&0<=selectedIndex&&selectedIndex<this.dropdown.options.length&&(this.dropdown.selectedIndex=selectedIndex)},enable:function(){return this.dropdown.enable(),this.dropdown.selectedIndex<=0&&this._tmpSelectedIndex<this.dropdown.options.length&&(this.dropdown.selectedIndex=this._tmpSelectedIndex,0<this._tmpSelectedIndex)},disable:function(){this.dropdown.disable(),this._tmpSelectedIndex=this.dropdown.selectedIndex,this.dropdown.selectedIndex=0},getElement:function(){return this.span},onSelect:function(callback){var _this=this;this.callback=callback;var events=["change"];browser.isGecko&&events.push("keyup"),events.each(function(eventName){_this.dropdown.observe(eventName,function(){callback(),_this._tmpSelectedIndex=_this.dropdown.selectedIndex})})},onFocus:function(callback){var _this=this;this.dropdown.observe("focus",function(){callback(),-1==_this.dropdown.selectedIndex&&_this._tmpSelectedIndex<_this.dropdown.options.size()&&(_this.dropdown.selectedIndex=_this._tmpSelectedIndex)})},onBlur:function(callback){this.dropdown.observe("blur",callback)},getSelectedValue:function(){return 0<=this.dropdown.selectedIndex?this.dropdown.options[this.dropdown.selectedIndex].value:""},getSelectedOption:function(){return 0<=this.dropdown.selectedIndex?this.dropdown.options[this.dropdown.selectedIndex].innerHTML:""}}),widgets.FuzzyDatePicker=Class.create({initialize:function(input){if(input){if(this.__input=input,this.__input.hide(),this.__fuzzyInput=$(this.__input.name+"_entered"),this.__fuzzyInput&&(this.__recordBoth=!0),this.__fuzzyInput&&this.__fuzzyInput.value)this.__date=JSON.parse(this.__fuzzyInput.value||"{}");else if(this.__input.alt){var parsedDate=new Date(this.__input.alt);this.__date={year:parsedDate.getUTCFullYear(),month:parsedDate.getUTCMonth()+1,day:parsedDate.getUTCDate()}}else this.__date={};this.container=new Element("div",{class:"fuzzy-date-picker"}),this.__input.insert({before:this.container});for(var format=(this.__input.title||"yyyy-MM-dd").split(/\W+/),i=0;i<format.length;++i)switch(format[i][0]){case"y":this.container.insert(this.createYearDropdown());break;case"M":this.container.insert(this.createMonthDropdown());break;case"d":this.container.insert(this.createDayDropdown())}this.container.observe("datepicker:date:changed",this.onProgrammaticUpdate.bind(this)),this.onProgrammaticUpdate()}},onProgrammaticUpdate:function(){this.yearSelected(),this.monthSelected(),this.updateDate()},createYearDropdown:function(){this.yearSelector=new widgets.FuzzyDatePickerDropdown({name:"year"});for(var values=[],y=(new Date).getYear()+1900;1900<=y;--y)values.push({value:y,selected:this.__date.year==y}),y%10==0&&values.push({value:y+"s",cssClass:"decade",text:y+"s",selected:this.__date.decade==y+"s"});return values.push({value:"1800s",cssClass:"decade",selected:"1800s"==this.__date.decade}),values.push({value:"1700s",cssClass:"decade",selected:"1700s"==this.__date.decade}),values.push({value:"1600s",cssClass:"decade",selected:"1600s"==this.__date.decade}),this.yearSelector.populate(values),this.yearSelector.onSelect(this.yearSelected.bind(this)),this.yearSelector.getElement()},yearSelected:function(){this.yearSelector&&(0<this.yearSelector.getSelectedValue()&&this.monthSelector&&this.monthSelected(),this.updateDate())},createMonthDropdown:function(){return this.monthSelector=new widgets.FuzzyDatePickerDropdown({name:"month"}),this.monthSelector.populate(this.getZeroPaddedValueRange(1,12,this.__date.month)),this.monthSelector.onSelect(this.monthSelected.bind(this)),this.monthSelector.getElement()},monthSelected:function(){this.monthSelector&&(0<this.monthSelector.getSelectedValue()&&this.daySelector&&this.daySelector.populate(this.getAvailableDays()),this.updateDate())},createDayDropdown:function(){return this.daySelector=new widgets.FuzzyDatePickerDropdown({name:"day"}),this.daySelector.populate(this.getZeroPaddedValueRange(1,31,this.__date.day)),this.daySelector.onSelect(this.updateDate.bind(this)),this.daySelector.getElement()},getAvailableDays:function(){var year=1*this.yearSelector.getSelectedValue(),month=1*this.monthSelector.getSelectedValue(),lastDayOfMonth=0;return 0<=[1,3,5,7,8,10,12].indexOf(month)?lastDayOfMonth=31:0<=[4,6,9,11].indexOf(month)?lastDayOfMonth=30:2==month&&(lastDayOfMonth=year%4!=0||year%100==0&&year%400!=0?28:29),this.getZeroPaddedValueRange(1,lastDayOfMonth)},getZeroPaddedValue:function(value){return value?("0"+value).slice(-2):"01"},getZeroPaddedValueRange:function(start,end,selected){var values=[];if(start<=end)for(var v=start;v<=end;++v)values.push({value:v,text:("0"+v).slice(-2),selected:selected==v});else for(v=end;v<=start;--v)values.push({value:v,text:("0"+v).slice(-2),selected:selected==v});return values},updateDate:function(){var dateObject={},y=this.yearSelector.getSelectedValue();if(y.match(/\d\d\d\ds$/)?dateObject.decade=y:""!=y&&(dateObject.year=y),0<y){var m=this.monthSelector&&this.monthSelector.getSelectedValue();if(0<m){dateObject.month=this.monthSelector.getSelectedOption();var d=this.daySelector&&this.daySelector.getSelectedValue();0<d&&(dateObject.day=this.daySelector.getSelectedOption())}}var newValue=JSON.stringify(dateObject);this.__recordBoth?newValue!=this.__fuzzyInput.value&&(this.__fuzzyInput.value=JSON.stringify(dateObject),this.__input.value=y&&!y.match(/\d\d\d\ds$/)?y+"-"+this.getZeroPaddedValue(m)+"-"+this.getZeroPaddedValue(d):"",this.__input.alt=y&&!y.match(/\d\d\d\ds$/)?y+"-"+this.getZeroPaddedValue(m)+"-"+this.getZeroPaddedValue(d)+"T00:00:00Z":"",this.__input.fire("xwiki:date:changed")):newValue!=this.__input.value&&(this.__input.value=JSON.stringify(dateObject),this.__input.alt=y&&!y.match(/\d\d\d\ds$/)?y+"-"+this.getZeroPaddedValue(m)+"-"+this.getZeroPaddedValue(d)+"T00:00:00Z":"",this.__input.fire("xwiki:date:changed"))}});var init=function(event){return(event&&event.memo.elements||[document.getElementById(PedigreeEditorTool.divId)]).each(function(element){(element.hasClassName("fuzzy-date")?[element]:element.select(".fuzzy-date")).each(function(dateInput){dateInput.__datePicker||(dateInput.__datePicker=new PhenoTips.widgets.FuzzyDatePicker(dateInput))})}),!0};return XWiki.domIsLoaded&&init()||document.observe("xwiki:dom:loaded",init),document.observe("xwiki:dom:updated",init),PhenoTips}(PhenoTips||{});!function(){var init=function(event){(event&&event.memo.elements||[document.getElementById(PedigreeEditorTool.divId)]).each(function(container){container.select("input.suggestWorkgroups").each(function(input){if(!input.hasClassName("initialized")){var options={script:new XWiki.Document("SuggestWorkgroupsService","PhenoTips").getURL("get","outputSyntax=plain&"),noresults:$services.localization.render("phenotips.widgets.workgroupPicker.noResults")};input.hasClassName("global")&&(options.script=options.script+"wiki=global&"),new XWiki.widgets.UserPicker(input,options),input.addClassName("initialized")}})})};XWiki.domIsLoaded&&init()||document.observe("xwiki:dom:loaded",init),document.observe("xwiki:dom:updated",init)}();var PhenoTips=function(PhenoTips){return(PhenoTips.widgets=PhenoTips.widgets||{}).SegmentedBar=Class.create({options:{segments:5,displayValue:!0},initialize:function(value,options){this.value=value,this.options=Object.extend(Object.clone(this.options),options||{})},generateSegmentedBar:function(){if(!(1<this.value||this.value<0)){for(var bar=new Element("div",{class:"segmented-bar",title:Math.round(100*this.value)+"%"||""}),valueUnit=1/this.options.segments,i=0;i<this.options.segments;++i){var segmentFill=100*Math.min(Math.max((this.value-i*valueUnit)/valueUnit,0),1),segment=new Element("span",{class:"segmented-unit"}),segmentFillElement=new Element("span",{class:"segmented-unit-fill"});segmentFillElement.setStyle({width:segmentFill+"%"}),segment.insert(segmentFillElement),bar.insert(segment)}return this.options.displayValue&&bar.insert(" "+Math.round(100*this.value)+"%"),bar}console.log("Invalid segmented bar value")}}),PhenoTips}(PhenoTips||{}),PhenoTips=function(PhenoTips){var widgets=PhenoTips.widgets=PhenoTips.widgets||{};return void 0===XWiki.widgets.XList?"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn("[Suggest widget] Required class missing: XWiki.widgets.XList"):(widgets.XList=XWiki.widgets.XList,widgets.XListItem=XWiki.widgets.XListItem,widgets.Suggest=Class.create({options:{minchars:1,method:"get",varname:"input",className:"ajaxsuggest",timeout:2500,delay:500,offsety:0,shownoresults:!0,noresults:"No results!",maxheight:250,cache:!1,seps:"",icon:null,resultsParameter:function(){return"results"},resultId:function(){return"id"},resultValue:function(){return"value"},resultInfo:"info",resultCategory:"category",resultAltName:"",resultIcon:"icon",resultHint:"hint",tooltip:!1,highlight:!0,fadeOnClear:!0,enableHideButton:!0,insertBeforeSuggestions:null,displayId:!1,displayValue:!1,displayValueText:"Value :",align:"left",unifiedLoader:!1,loaderNode:null,filterFunc:null},sInput:"",nInputChars:0,aSuggestions:[],iHighlighted:null,isActive:!1,resultTotal:0,resultPage:-1,resultLimit:10,resultHasMore:!1,initialize:function(fld,param){if(!fld)return!1;this.setInputField(fld),this.options=Object.extend(Object.clone(this.options),param||{}),"object"==typeof this.options.sources&&1<this.options.sources.length?this.sources=this.options.sources:this.sources=this.options,this.sources=[this.sources].flatten().compact(),$(this.options.parentContainer)||(this.options.parentContainer=$(document.body)),this.options.seps?this.seps=this.options.seps:this.seps="",this.latestRequest=0},setInputField:function(input){this.fld&&this.fld.stopObserving(),this.fld=$(input),(this.fld._suggestWidget=this).fld.observe("keyup",this.onKeyUp.bindAsEventListener(this)),Prototype.Browser.IE||Prototype.Browser.WebKit?this.fld.observe("keydown",this.onKeyPress.bindAsEventListener(this)):this.fld.observe("keypress",this.onKeyPress.bindAsEventListener(this)),this.fld.observe("paste",this.onPaste.bindAsEventListener(this)),this.fld.setAttribute("autocomplete","off"),this.fld.observe("blur",function(event){this.latestRequest++}.bind(this))},onKeyUp:function(event){switch(event.keyCode){case Event.KEY_RETURN:case Event.KEY_ESC:case Event.KEY_UP:case Event.KEY_DOWN:break;default:if(this.seps){for(var lastIndx=-1,i=0;i<this.seps.length;i++)this.fld.value.lastIndexOf(this.seps.charAt(i))>lastIndx&&(lastIndx=this.fld.value.lastIndexOf(this.seps.charAt(i)));-1==lastIndx?this.getSuggestions(this.fld.value):this.getSuggestions(this.fld.value.substring(lastIndx+1))}else this.getSuggestions(this.fld.value)}},onPaste:function(event){setTimeout(function(){this.onKeyUp({keyCode:null})}.bind(this),0)},onKeyPress:function(event){if($(this.isActive)){var key=event.keyCode;switch(key){case Event.KEY_RETURN:this.setHighlightedValue(),Event.stop(event);break;case Event.KEY_ESC:this.clearSuggestions(),Event.stop(event);break;case Event.KEY_UP:case Event.KEY_DOWN:this.changeHighlight(key),Event.stop(event)}}else event.keyCode==Event.KEY_RETURN&&Event.stop(event)},getSuggestions:function(val){if((val=val.strip().toLowerCase())==this.sInput&&1<val.length)return!1;if(0==val.length)return this.sInput="",this.clearSuggestions(),!1;if(val.length<this.options.minchars)return this.sInput="",!1;if(val.length>this.nInputChars&&this.aSuggestions.length&&this.options.cache){for(var arr=[],i=0;i<this.aSuggestions.length;i++)this.aSuggestions[i].value.substr(0,val.length).toLowerCase()==val&&arr.push(this.aSuggestions[i]);return this.sInput=val,this.nInputChars=val.length,this.aSuggestions=arr,this.createList(this.aSuggestions),!1}this.resultPage=-1,this.sInput=val,this.nInputChars=val.length,this.container=this.prepareContainer(),this.latestRequest++;var pointer=this,requestId=this.latestRequest;return clearTimeout(this.ajID),this.ajID=setTimeout(function(){pointer.doAjaxRequests(requestId)},this.options.delay),!1},doAjaxRequests:function(requestId){if(!(this.fld.value.length<this.options.minchars))for(var i=0;i<this.sources.length;i++){var source=this.sources[i],query=this.fld.value.strip(),parameters={};null!=this.options.queryProcessor&&"function"==typeof this.options.queryProcessor.generateParameters&&(parameters=this.options.queryProcessor.generateParameters(query)),null!=this.options.queryProcessor&&"function"==typeof this.options.queryProcessor.processQuery&&(query=this.options.queryProcessor.processQuery(query));var url="";url=null!=source.scriptFunction&&"function"==typeof source.scriptFunction?source.scriptFunction()+source.varname+"="+encodeURIComponent(query):source.script+source.varname+"="+encodeURIComponent(query);var method=source.method||"get",headers={};source.json?headers.Accept="application/json":headers.Accept="application/xml";var _GELThisAjaxCall=this;_GELThisAjaxCall.options.resultUsePagination&&_GELThisAjaxCall.options.resultUsePagination()&&(this.resultPage=this.resultPage+1,url=url+"&page="+this.resultPage+"&limit="+this.resultLimit);new Ajax.Request(url,{method:method,parameters:parameters,requestHeaders:headers,onCreate:function(){this.fld.addClassName("loading")}.bind(this),onSuccess:function(_GELResult){if(_GELThisAjaxCall.options.resultUsePagination&&_GELThisAjaxCall.options.resultUsePagination()){var result=_GELResult.responseJSON;_GELThisAjaxCall.resultHasMore=result.more,_GELThisAjaxCall.resultTotal=result.total,result.more?_GELThisAjaxCall.updateLoadMore(_GELThisAjaxCall.resultPage,_GELThisAjaxCall.resultLimit,_GELThisAjaxCall.resultTotal):_GELThisAjaxCall.hideLoadMore()}_GELThisAjaxCall.setSuggestions(_GELResult,source,requestId)},onFailure:function(response){alert("Failed to retrieve suggestions : "+response.statusText)},onComplete:function(){requestId<this.latestRequest||this.fld.removeClassName("loading")}.bind(this)})}},setSuggestions:function(req,source,requestId){requestId<this.latestRequest||(this.aSuggestions=this.getSuggestionList(req,source),this.createList(this.aSuggestions,source))},getSuggestionList:function(req,source){var aSuggestions=[];if(source&&source.json){var jsondata=req.responseJSON;if(!jsondata)return!1;var results=jsondata[source.resultsParameter()||this.options.resultsParameter()],_getResultFieldValue=function(data,fieldName){return data&&data[fieldName]||""},_getResultFieldValueAsArray=function(data,fieldName){return new Array(data&&data[fieldName]||"").flatten()}}else{var xmldata=req.responseXML;if(!xmldata)return!1;results=xmldata.getElementsByTagName(source&&source.resultsParameter()||this.options.resultsParameter()),_getResultFieldValue=function(data,selector){var element=data&&Element.down(data,selector);return element&&element.firstChild&&element.firstChild.nodeValue||""},_getResultFieldValueAsArray=function(data,selector){var result=new Array;return data&&Element.select(data,selector).each(function(item){var value=item.firstChild&&item.firstChild.nodeValue;value&&result.push(value)}),result}}for(var _getExpandCollapseTriggerSymbol=function(isCollapsed){return isCollapsed?"&#x25B8;":"&#x25BE;"},i=0;i<results.length;i++){var info=new Element("dl");for(var section in this.options.resultInfo){var sOptions=this.options.resultInfo[section];sectionClass=section.strip().toLowerCase().replace(/[^a-z0-9 ]/gi,"").replace(/\s+/gi,"-");var sectionState="";sOptions.collapsed&&(sectionState="collapsed");var processingFunction=sOptions.processor;if(sOptions.extern){var trigger=new Element("a").update(section);trigger._processingFunction=processingFunction,info.insert({bottom:new Element("dt",{class:sectionState+" "+sectionClass}).insert({bottom:trigger})}),trigger._processingFunction.call(this,trigger)}else{var selector=sOptions.selector;if(selector){var sectionContents=null;_getResultFieldValueAsArray(results[i],selector).each(function(item){var text=item||"";if("function"==typeof processingFunction&&(text=processingFunction(text)),""!=text){if(!sectionContents){var trigger=new Element("a",{class:"expand-tool"}).update(_getExpandCollapseTriggerSymbol(sOptions.collapsed));info.insert({bottom:new Element("dt",{class:sectionState}).insert({top:trigger}).insert({bottom:section})}),sectionContents=new Element("dd",{class:"expandable"}),info.insert({bottom:sectionContents}),trigger.observe("click",function(event){event.stop(),trigger.up().toggleClassName("collapsed"),trigger.update(_getExpandCollapseTriggerSymbol(trigger.up().hasClassName("collapsed")))}.bindAsEventListener(this))}sectionContents.insert({bottom:new Element("div").update(text)})}})}}}if(info.hasChildNodes()||(info=""),this.options.resultCategory){var category=new Element("span",{class:"hidden term-category"});_getResultFieldValueAsArray(results[i],this.options.resultCategory).each(function(c){category.insert(new Element("input",{type:"hidden",value:c}))})}if(this.options.resultCategory&&category.hasChildNodes()||(category=""),this.options.resultAltName)for(var bestNameMatch="",name=_getResultFieldValue(results[i],source.resultValue()||this.options.resultValue()),altNames=_getResultFieldValueAsArray(results[i],source.resultAltName||this.options.resultAltName),nameMatchScore=this.computeSimilarity(name,this.sInput),k=0;k<altNames.length;++k){var altNameMatchScore=this.computeSimilarity(altNames[k],this.sInput);nameMatchScore<altNameMatchScore&&(bestNameMatch=altNames[k],nameMatchScore=altNameMatchScore)}aSuggestions.push({id:_getResultFieldValue(results[i],source.resultId()||this.options.resultId()),value:_getResultFieldValue(results[i],source.resultValue()||this.options.resultValue()),valueAll:results[i],altName:bestNameMatch,info:info,category:category})}return aSuggestions},computeSimilarity:function(str1,str2){var score,maxSoFar=0,a=str1,m=a.length,b=str2,n=b.length,d=new Array;for(i=0;i<n;i++)d[i]=new Array,score=a.charAt(i)==b.charAt(0)?1:-1,0==i?d[0][0]=Math.max(0,-2,score):d[i][0]=Math.max(0,d[i-1][0]-2,score),d[i][0]>maxSoFar&&(maxSoFar=d[i][0]);for(j=0;j<m;j++)score=a.charAt(0)==b.charAt(j)?1:-1,0==j?d[0][0]=Math.max(0,-2,score):d[0][j]=Math.max(0,d[0][j-1]-2,score),d[0][j]>maxSoFar&&(maxSoFar=d[0][j]);for(i=1;i<n;i++)for(j=1;j<m;j++)score=a.charAt(i)==b.charAt(j)?1:-1,d[i][j]=Math.max(0,d[i-1][j]-2,d[i][j-1]-2,d[i-1][j-1]+score),d[i][j]>maxSoFar&&(maxSoFar=d[i][j]);return maxSoFar},prepareContainer:function(){var elName=this.fld.name,containerName=$$("div.tabholder")[0],crtContainer=$(containerName).down(".suggestItems");if(crtContainer&&crtContainer.__targetField!=this.fld&&(crtContainer.__targetField?crtContainer.__targetField._suggest.clearSuggestions():crtContainer.remove(),crtContainer=!1),!crtContainer){var div=new Element("div",{class:"suggestItems "+this.options.className}),pos="body"==$(containerName).tagName.toLowerCase()?this.fld.cumulativeOffset():this.fld.positionedOffset(),containerWidth=this.options.width?this.options.width:this.fld.offsetWidth-2;"left"==this.options.align?div.style.left=pos.left+"px":"center"==this.options.align?div.style.left=pos.left+(this.fld.getWidth()-containerWidth-2)/2+"px":div.style.left=pos.left-containerWidth+this.fld.offsetWidth-2+"px";var offsetTop=document.getElementsByName(elName)[0].offsetTop;div.style.top=offsetTop+this.fld.offsetHeight+"px",div.style.width=containerWidth+"px",div.style.height="100px",div.style.maxHeight="100px";var pointer=this;div.onmouseover=function(){pointer.killTimeout()},div.onmouseout=function(){pointer.resetTimeout()},this.resultContainer=new Element("div",{class:"resultContainer "+elName+"_class"}),div.appendChild(this.resultContainer),$(containerName).insert(div),this.container=div,this.options.insertBeforeSuggestions&&this.resultContainer.insert(this.options.insertBeforeSuggestions),document.fire("ms:suggest:containerCreated",{container:this.container,suggest:this}),div.style.maxHeight="100px"}if(1<this.sources.length)for(var i=0;i<this.sources.length;i++){var source=this.sources[i];if(source.id=i,this.resultContainer.down(".results"+source.id))this.resultContainer.down(".results"+source.id).down("ul")&&this.resultContainer.down(".results"+source.id).down("ul").remove(),this.options.unifiedLoader?((this.options.loaderNode||this.fld).addClassName("loading"),this.resultContainer.down(".results"+source.id).addClassName("hidden loading")):this.resultContainer.down(".results"+source.id).down(".sourceContent").addClassName("loading");else{var sourceContainer=new Element("div",{class:"results results"+source.id}),sourceHeader=new Element("div",{class:"sourceName"});if(this.options.unifiedLoader&&sourceContainer.addClassName("hidden loading"),void 0!==source.icon){var iconImage=new Image;iconImage.onload=function(){this.sourceHeader.setStyle({backgroundImage:"url("+this.iconImage.src+")"}),this.sourceHeader.setStyle({textIndent:this.iconImage.width+6+"px"})}.bind({sourceHeader:sourceHeader,iconImage:iconImage}),iconImage.src=source.icon}sourceHeader.insert(source.name),sourceContainer.insert(sourceHeader);var classes="sourceContent "+(this.options.unifiedLoader?"":"loading");sourceContainer.insert(new Element("div",{class:classes})),void 0!==source.before&&this.resultContainer.insert(source.before),this.resultContainer.insert(sourceContainer),void 0!==source.after&&this.resultContainer.insert(source.after)}}else this.resultContainer.down("ul")&&this.resultContainer.down("ul").remove();this.container.fire("ms:suggest:containerPrepared",{container:this.container,suggest:this});(this.container.__targetField=this.fld,this.options.enableHideButton&&!this.container.down(".hide-button"))&&(!!this.options.resultUsePagination&&this.options.resultUsePagination()&&(hideButton=new Element("span",{class:"hide-button loadMore",style:"float:left;"}).update("Load more"),hideButton.observe("click",this.loadMode.bindAsEventListener(this)),this.container.insert({bottom:new Element("div",{class:"hide-button-wrapper"}).update(hideButton)})));return this.container},getBoundPosition:function(elemName){try{var screenPosition=document.getElementsByName(elemName)[0].getBoundingClientRect();return screenPosition.y?{y:screenPosition.y,x:screenPosition.x}:screenPosition.top?{y:screenPosition.top,x:screenPosition.left}:null}catch(err){console.warn("Could not find element with name "+elemName+". "+err)}return null},hideLoadMore:function(){var container=this.container;container&&0<container.select("span.loadMore").length&&container.select("span.loadMore")[0].hide()},updateLoadMore:function(page,limit,total){var container=this.container,loadMoreSpan=container.select("span.loadMore");container&&0<loadMoreSpan.length&&loadMoreSpan[0].update("("+10*(page+1)+"/"+total+") Load more")},loadMode:function(){var val=this.fld.value;this.sInput=val,this.nInputChars=val.length,this.latestRequest++;var pointer=this,requestId=this.latestRequest;return clearTimeout(this.ajID),this.ajID=setTimeout(function(){pointer.doAjaxRequests(requestId)},this.options.delay),!1},createList:function(arr,source){this.isActive=!0;var pointer=this;if(this.killTimeout(),this.clearHighlight(),1<this.sources.length){var div=this.resultContainer.down(".results"+source.id);(0<arr.length||this.options.shownoresults)&&(div.down(".sourceContent").removeClassName("loading"),this.resultContainer.down(".results"+source.id).removeClassName("hidden loading")),this.options.unifiedLoader&&!this.resultContainer.down("loading")&&(this.options.loaderNode||this.fld).removeClassName("loading")}else div=this.resultContainer;if(0==arr.length&&!this.options.shownoresults)return!1;var list=void 0;if(div.down("ul")){for(var oldUL=div.down("ul"),newUL=this.createListElement(arr,pointer),i=0;i<newUL.select("li").length;i++)oldUL.appendChild(newUL.select("li")[i]);list=oldUL}else list=this.createListElement(arr,pointer),div.appendChild(list);Event.fire(document,"xwiki:dom:updated",{elements:[list]}),this.suggest=div;pointer=this;0<this.options.timeout&&(this.toID=setTimeout(function(){pointer.clearSuggestions()},this.options.timeout)),this.highlightFirst()},createListElement:function(arr,pointer){var list=new PhenoTips.widgets.XList([],{icon:this.options.icon,classes:"suggestList",eventListeners:{click:function(){return pointer.setHighlightedValue(),!1},mouseover:function(){pointer.setHighlight(this.getElement())}}});if(this.fld.hasClassName("accept-value")){var customItemId=this.fld.value.replace(/[^a-z0-9_]+/gi,"_"),customItemCategoryInfo=this.fld.next('input[name="_category"]'),customItemCategories=customItemCategoryInfo&&customItemCategoryInfo.value.split(",")||[],customItemCategoriesElt=new Element("div",{class:"hidden term-category"}),categoryFieldName=this.fld.name+"__"+customItemId+"__category";customItemCategories.each(function(c){c&&customItemCategoriesElt.insert(new Element("input",{type:"hidden",name:categoryFieldName,value:c}))});var pagination=!!this.options.resultUsePagination&&this.options.resultUsePagination(),canSelectInputTerm=!this.options.canSelectInputTerm||this.options.canSelectInputTerm();(!pagination&&canSelectInputTerm||pagination&&0==this.resultPage&&canSelectInputTerm)&&list.addItem(this.generateListItem({id:this.fld.value,value:this.fld.value,category:customItemCategoriesElt,info:new Element("div",{class:"hint"}).update("(your text, not a standard term)")},"custom-value",!0))}for(var i=0,len=arr.length;i<len;i++)this.options.filterFunc&&!this.options.filterFunc(arr[i])||list.addItem(this.generateListItem(arr[i]));return 0==arr.length&&list.addItem(new PhenoTips.widgets.XListItem(this.options.noresults,{classes:"noSuggestion",noHighlight:!0})),list.getElement()},highLightSearchResult:function(text,queryTerm){return text.replace(new RegExp(queryTerm,"ig"),"<strong>$&</strong>")},generateListItem:function(data,cssClass,disableTooltip){var displayNode=new Element("div",{class:"tooltip-"+this.options.tooltip});if(data.icon&&displayNode.insert(new Element("img",{src:data.icon,class:"icon"})),this.options.displayId&&displayNode.insert(new Element("span",{class:"suggestId"}).update(data.id.escapeHTML())),this.options.displaySuggestItemFunction){var displaySuggestItem=this.options.displaySuggestItemFunction(this.sInput,data,this);if(displaySuggestItem)displayNode.insert(displaySuggestItem);else{var newDataValue=this.highLightSearchResult(data.value.escapeHTML(),this.sInput);displayNode.insert(new Element("span",{class:"suggestValue"}).update(newDataValue))}}else{newDataValue=this.highLightSearchResult(data.value.escapeHTML(),this.sInput);displayNode.insert(new Element("span",{class:"suggestValue"}).update(newDataValue))}if(this.options.tooltip&&!disableTooltip){var infoTool=new Element("span",{class:"fa fa-info-circle xHelpButton "+this.options.tooltip,title:data.id});infoTool.observe("click",function(event){event.stop()}),displayNode.insert(" ").insert(infoTool)}var displayInfo=new Element("div",{class:"suggestInfo"}).update(data.info);displayNode.insert(displayInfo),data.altName&&displayInfo.insert({top:new Element("span",{class:"matching-alternative-name"}).update(data.altName.escapeHTML())});var valueNode=new Element("div").insert(new Element("span",{class:"suggestId"}).update(data.id.escapeHTML())).insert(new Element("span",{class:"suggestValue"}).update(data.value.escapeHTML())).insert(new Element("div",{class:"suggestCategory"}).update(data.category));valueNode.store("itemData",data);var item=new PhenoTips.widgets.XListItem(displayNode,{containerClasses:"suggestItem "+(cssClass||""),value:valueNode,noHighlight:!0});return Event.fire(this.fld,"ms:suggest:suggestionCreated",{element:item.getElement(),suggest:this}),item},emphasizeMatches:function(input,value){for(var output=value,fragments=input.split(" ").uniq().compact(),offset=0,matches={},j=0,flen=fragments.length;j<flen;j++)for(var index=output.toLowerCase().indexOf(fragments[j].toLowerCase());0<=index;){var match=output.substring(index,index+fragments[j].length),placeholder="";fragments[j].length.times(function(){placeholder+=" "}),matches[index]=match,index=(output=output.substring(0,index)+placeholder+output.substring(index+fragments[j].length)).toLowerCase().indexOf(fragments[j].toLowerCase())}return Object.keys(matches).sortBy(function(s){return parseInt(s)}).each(function(key){var before=output.substring(0,parseInt(key)+offset),after=output.substring(parseInt(key)+matches[key].length+offset);output=before+"<em>"+matches[key]+"</em>"+after,offset+=9}),output},changeHighlight:function(key){var elem,list=this.resultContainer;if(!list)return!1;if(this.iHighlighted){if(key==Event.KEY_DOWN){if(!(elem=this.iHighlighted.next())&&this.iHighlighted.up("div.results"))for(var source=this.iHighlighted.up("div.results").next();source&&!elem;)elem=source.down("li"),source=source.next();elem||(elem=list.down("li"))}else if(key==Event.KEY_UP){if(!(elem=this.iHighlighted.previous())&&this.iHighlighted.up("div.results"))for(source=this.iHighlighted.up("div.results").previous();source&&!elem;)elem=source.down("li:last-child"),source=source.previous();elem||(elem=list.select("ul")[list.select("ul").length-1].down("li:last-child"))}}else key==Event.KEY_DOWN?elem=list.down("div.results")?list.down("div.results").down("li"):list.down("li"):key==Event.KEY_UP&&0<list.select("li")&&(elem=list.select("li")[list.select("li").length-1]);elem&&this.setHighlight(elem)},setHighlight:function(highlightedItem){this.iHighlighted&&this.clearHighlight(),highlightedItem.addClassName("xhighlight"),this.iHighlighted=highlightedItem,this.killTimeout()},clearHighlight:function(){this.iHighlighted&&(this.iHighlighted.removeClassName("xhighlight"),delete this.iHighlighted)},highlightFirst:function(){if(this.suggest&&this.suggest.down("ul")){var first=this.suggest.down("ul").down("li");first&&this.setHighlight(first)}},hasActiveSelection:function(){return this.iHighlighted},setHighlightedValue:function(){if(this.iHighlighted&&!this.iHighlighted.hasClassName("noSuggestion")){var selection,newFieldValue;if(""==this.sInput&&""==this.fld.value)selection=newFieldValue=this.iHighlighted.down(".suggestValue").innerHTML;else if(this.seps){for(var lastIndx=-1,i=0;i<this.seps.length;i++)this.fld.value.lastIndexOf(this.seps.charAt(i))>lastIndx&&(lastIndx=this.fld.value.lastIndexOf(this.seps.charAt(i)));selection=-1==lastIndx?newFieldValue=this.iHighlighted.down(".suggestValue").innerHTML:(newFieldValue=this.fld.value.substring(0,lastIndx+1)+this.iHighlighted.down(".suggestValue").innerHTML).substring(lastIndx+1)}else selection=newFieldValue=this.iHighlighted.down(".suggestValue").innerHTML;var inputData=this.iHighlighted.down(".value div").retrieve("itemData"),data={suggest:this,id:inputData.id||this.iHighlighted.down(".suggestId").innerHTML,value:inputData.value||this.iHighlighted.down(".suggestValue").innerHTML,valueAll:inputData.valueAll,info:inputData.info||this.iHighlighted.down(".suggestInfo").innerHTML,icon:inputData.icon||(this.iHighlighted.down("img.icon")?this.iHighlighted.down("img.icon").src:""),category:this.iHighlighted.down(".suggestCategory").innerHTML};this.acceptEntry(data,selection,newFieldValue)}},acceptEntry:function(data,selection,newFieldValue,silent){var hpoPresent=document.getElementsByName("hpoPresent")[0].value;data.valueAll.hpoPresent=hpoPresent;var fld=this.fld,container=this.fld.up(".accepted-suggestion");if(container){container.select("input[type=hidden][name=hpo_positive]").each(function(item){var valueAll,li=item.up("li");if(null!=li&&((valueAll=li.retrieve("valueAll")).hpoPresent=hpoPresent),null==valueAll.hpoModifiers&&(valueAll.hpoModifiers=[]),-1!=fld.className.indexOf("suggest-hpo-modifier")){var containsValue=!1;valueAll.hpoModifiers.forEach(function(elem){elem.uid==li.retrieve("valueAll").uid&&(containsValue=!0)}),containsValue||null==li||valueAll.hpoModifiers.push(data.valueAll)}})}var nm="hpo_positive";if(window.editor._nodeMenu.fieldMap[nm].crtValue&&window.editor._nodeMenu.fieldMap[nm].crtValue.forEach(function(elem){data.id==elem.id&&(console.log("id equals id"),elem.valueAll.hpoPresent=data.valueAll.hpoPresent,elem.hpoPresent=data.valueAll.hpoPresent)}),!Event.fire(this.fld,"ms:suggest:selected",data).stopped&&(silent||(this.sInput=selection,this.fld.value=newFieldValue||this.fld.defaultValue||"",this.fld.focus(),this.clearSuggestions()),"function"==typeof this.options.callback&&this.options.callback(data),0<this.fld.id.indexOf("_suggest"))){var hidden_id=this.fld.id.substring(0,this.fld.id.indexOf("_suggest")),hidden_inp=$(hidden_id);hidden_inp&&(hidden_inp.value=info)}},killTimeout:function(){clearTimeout(this.toID)},resetTimeout:function(){clearTimeout(this.toID);var pointer=this;this.toID=setTimeout(function(){pointer.clearSuggestions()},1e6)},clearSuggestions:function(){this.killTimeout(),this.isActive=!1;var ele=$(this.container),pointer=this;if(ele&&ele.parentNode){if(this.options.fadeOnClear)new Effect.Fade(ele,{duration:"0.25",afterFinish:function(){$(pointer.container)&&$(pointer.container).remove()}});else $(this.container).remove();document.fire("ms:suggest:clearSuggestions",{suggest:this})}}})),PhenoTips}(PhenoTips||{}),PhenoTips=function(PhenoTips){var widgets=PhenoTips.widgets=PhenoTips.widgets||{};return widgets.ModalPopup=Class.create({options:{idPrefix:"modal-popup-",title:"",displayCloseButton:!0,screenColor:"",borderColor:"",titleColor:"",backgroundColor:"",screenOpacity:"0.5",verticalPosition:"center",horizontalPosition:"center",resetPositionOnShow:!0,removeOnClose:!1,onClose:Prototype.emptyFunction},initialize:function(content,shortcuts,options){this.shortcuts={show:{method:this.showDialog,keys:[]},close:{method:this.closeDialog,keys:["Esc"]}},this.content=content||"Hello world!",this.shortcuts=Object.extend(Object.clone(this.shortcuts),shortcuts||{}),this.options=Object.extend(Object.clone(this.options),options||{}),this.registerShortcuts("show"),void 0===widgets.ModalPopup.instanceCounter&&(widgets.ModalPopup.instanceCounter=0),this.id=++widgets.ModalPopup.instanceCounter},getBoxId:function(){return this.options.idPrefix+this.id},createDialog:function(event){if(this.dialog=new Element("div",{class:"msdialog-modal-container"}),this.options.extraDialogClassName&&this.dialog.addClassName(this.options.extraDialogClassName),this.screen=new Element("div",{class:"msdialog-screen"}).setStyle({opacity:this.options.screenOpacity,backgroundColor:this.options.screenColor}),this.dialog.update(this.screen),this.dialogBox=new Element("div",{class:"msdialog-box",id:this.getBoxId()}),this.options.extraClassName&&this.dialogBox.addClassName(this.options.extraClassName),this.dialogBox._x_contentPlug=new Element("div",{class:"content"}),this.dialogBox.update(this.dialogBox._x_contentPlug),this.dialogBox._x_contentPlug.update(this.content),this.options.title){var title=new Element("div",{class:"msdialog-title"}).update(this.options.title);title.setStyle({color:this.options.titleColor,backgroundColor:this.options.borderColor}),this.dialogBox.insertBefore(title,this.dialogBox.firstChild)}if(this.options.displayCloseButton){var closeButton=new Element("div",{class:"msdialog-close",title:"Close"}).update("&#215;");closeButton.setStyle({color:this.options.titleColor}),closeButton.observe("click",this.closeDialog.bindAsEventListener(this)),this.dialogBox.insertBefore(closeButton,this.dialogBox.firstChild)}this.dialog.appendChild(this.dialogBox),this.dialogBox.setStyle({textAlign:"left",borderColor:this.options.borderColor,backgroundColor:this.options.backgroundColor}),this.positionDialog(),document.getElementById(PedigreeEditorTool.divId).appendChild(this.dialog),void 0!==Draggable&&new Draggable(this.getBoxId(),{handle:$(this.getBoxId()).down(".msdialog-title"),scroll:window,change:this.updateScreenSize.bind(this)}),this.dialog.hide();var __enableUpdateScreenSize=function(event){this.dialog.visible()&&this.updateScreenSize()}.bindAsEventListener(this);["resize","scroll"].each(function(eventName){Event.observe(window,eventName,__enableUpdateScreenSize)}.bind(this)),Event.observe(document,"ms:popup:content-updated",__enableUpdateScreenSize)},positionDialog:function(){switch(this.options.verticalPosition){case"top":this.dialogBox.setStyle({top:document.viewport.getScrollOffsets().top+6+"px"});break;case"bottom":this.dialogBox.setStyle({bottom:".5em"});break;default:this.dialogBox.setStyle({top:"20%"})}switch(this.dialogBox.setStyle({left:"",right:""}),this.options.horizontalPosition){case"left":this.dialog.setStyle({textAlign:"left"});break;case"right":this.dialog.setStyle({textAlign:"right"});break;default:this.dialog.setStyle({textAlign:"center"}),this.dialogBox.setStyle({margin:"auto"})}},positionDialogInViewport:function(left,top){this.dialogBox.setStyle({left:document.viewport.getScrollOffsets().left+left+"px",top:document.viewport.getScrollOffsets().top+top+"px",margin:"0"})},getPositionInViewport:function(){return this.dialogBox.viewportOffset()},updateScreenSize:function(){var __getNewDimension=function(eltToFit,dimensionAccessFunction,position){var crtDimension=$(document.documentElement)[dimensionAccessFunction](),viewportDimension=document.viewport.getScrollOffsets()[position]+document.viewport[dimensionAccessFunction]();if(eltToFit)eltToFit.cumulativeOffset()[position],eltToFit[dimensionAccessFunction]();var result="";return crtDimension<viewportDimension&&(result=viewportDimension+"px"),result};this.screen.style.width=__getNewDimension(this.dialogBox,"getWidth","left"),this.screen.style.height=__getNewDimension(this.dialogBox,"getHeight","top")},setClass:function(className){this.dialogBox.addClassName("msdialog-box-"+className)},removeClass:function(className){this.dialogBox.removeClassName("msdialog-box-"+className)},setContent:function(content){this.content=content,this.dialogBox._x_contentPlug.update(this.content),this.updateScreenSize()},showDialog:function(event){event&&Event.stop(event),this.active||(this.active=!0,this.dialog||this.createDialog(),this.attachKeyListeners(),this.dialog.show(),this.options.resetPositionOnShow&&this.positionDialog(),this.updateScreenSize())},onScroll:function(event){this.dialog.setStyle({top:document.viewport.getScrollOffsets().top+"px"})},closeDialog:function(event){event&&Event.stop(event),this.options.onClose.call(this),this.dialog.hide(),this.options.removeOnClose&&this.dialog.remove(),this.detachKeyListeners(),this.active=!1},attachKeyListeners:function(){for(var action in this.shortcuts)"show"!=action&&this.registerShortcuts(action)},detachKeyListeners:function(){for(var action in this.shortcuts)"show"!=action&&this.unregisterShortcuts(action)},registerShortcuts:function(action){for(var shortcuts=this.shortcuts[action].keys,method=this.shortcuts[action].method,i=0;i<shortcuts.size();++i)Prototype.Browser.IE||Prototype.Browser.WebKit?shortcut.add(shortcuts[i],method.bindAsEventListener(this,action),{type:"keyup"}):shortcut.add(shortcuts[i],method.bindAsEventListener(this,action),{type:"keypress"})},unregisterShortcuts:function(action){for(var i=0;i<this.shortcuts[action].keys.size();++i)shortcut.remove(this.shortcuts[action].keys[i])},createButton:function(type,text,title,id){var wrapper=new Element("span",{class:"buttonwrapper"}),button=new Element("input",{type:type,class:"button",value:text,title:title,id:id});return wrapper.update(button),wrapper},show:function(event){this.showDialog(event)},close:function(event){this.closeDialog(event)}}),widgets.ModalPopup.active=!1,PhenoTips}(PhenoTips||{}),PhenoTips=function(PhenoTips){return(PhenoTips.widgets=PhenoTips.widgets||{}).SuggestPicker=Class.create({options:{showKey:!0,showTooltip:!1,showDeleteTool:!0,enableSort:!0,showClearTool:!0,inputType:"hidden",listInsertionElt:null,listInsertionPosition:"after",predefinedEntries:null,acceptFreeText:!1},initialize:function(element,suggest,options,serializedDataInput){this.options=Object.extend(Object.clone(this.options),options||{}),this.serializedDataInput=serializedDataInput,this.input=element,this.suggest=suggest,this.inputName=this.input.name,this.options.acceptFreeText?this.input.addClassName("accept-value"):this.input.name=this.input.name+"__suggested",this.suggest.options.callback=this.acceptSuggestion.bind(this);var listInsertionElement,extraClass="";this.options.name&&(extraClass=this.options.name+"_suggestions"),this.list=new Element("ul",{class:"accepted-suggestions gel-accepted-suggestions "+extraClass}),this.options.listInsertionElt&&(listInsertionElement="string"==typeof this.options.listInsertionElt?this.input.up().down(this.options.listInsertionElt):this.options.listInsertionElt),listInsertionElement||(listInsertionElement=this.input);var insertion={};insertion[this.options.listInsertionPosition]=this.list,listInsertionElement.insert(insertion),this.predefinedEntries=this.options.predefinedEntries?$(this.options.predefinedEntries):null,this.options.showClearTool&&("hpo-modifier"!=this.options.name&&(this.clearTool=new Element("span",{class:"clear-tool delete-tool invisible",title:$services.localization.render("phenotips.widgets.multiSuggest.clear.title")}).update("Delete all &#x2716;"),this.clearTool.observe("click",this.clearAcceptedList.bindAsEventListener(this))),this.list.insert({after:this.clearTool})),"function"==typeof this.options.onItemAdded&&(this.onItemAdded=this.options.onItemAdded)},acceptAddItem:function(key,negative){console.log("acceptAddItem",key,negative);var searchFor='input[id="'+this.getInputId(key,negative).replace(/[^a-zA-Z0-9_-]/g,"\\$&")+'"]',input=this.predefinedEntries?this.predefinedEntries.down(searchFor):this.list?this.list.down(searchFor):$(this.getInputId(key,negative));null!=this.options.acceptsDuplicate&&"function"==typeof this.options.acceptsDuplicate&&(this.options.acceptsDuplicate()&&(input=void 0));return!input||(input.checked=!0,Event.fire(input,"suggest:change"),this.synchronizeSelection(input),!1)},ensureVisible:function(element,force){if(!(this.silent||!force&&this.options.silent||element.up(".hidden"))){for(var section=element.up(".collapsed:not(.force-collapse)");section;)section.removeClassName("collapsed"),section.down(".expand-tool")&&section.down(".expand-tool").update(""),section=section.up(".collapsed:not(.force-collapse)");element.viewportOffset().top>this.input.viewportOffset().top?element.viewportOffset().top>document.viewport.getHeight()&&(element.viewportOffset().top-this.input.viewportOffset().top<document.viewport.getHeight()?this.input.scrollTo():element.scrollTo()):element.cumulativeOffset().top<document.viewport.getScrollOffsets().top&&element.scrollTo()}},acceptSuggestion:function(obj){return console.log("objjj",obj),this.input.value=this.input.defaultValue||"",this.acceptAddItem(obj.id||obj.value,obj.negative)&&this.addItem(obj.id||obj.value,obj.value,obj.info,obj.category,obj.valueAll),!1},addItem:function(key,value,info,category,valueAll){if(key){var id=this.getInputId(key);if(null!=this.options.acceptsDuplicate&&"function"==typeof this.options.acceptsDuplicate)this.options.acceptsDuplicate()&&(id=id+"_"+Helpers.createRandomID());var listItem=new Element("li");listItem.store("valueAll",valueAll);var displayedValue=new Element("label",{class:"accepted-suggestion",for:id}),inputOptions={type:this.options.inputType,name:this.inputName,id:id,value:key};if("checkbox"==this.options.inputType&&(inputOptions.checked=!0),displayedValue.insert({bottom:new Element("input",inputOptions)}),this.options.showKey&&(displayedValue.insert({bottom:new Element("span",{class:"key"}).update("["+key.escapeHTML()+"]")}),displayedValue.insert({bottom:new Element("span",{class:"sep"}).update(" ")})),displayedValue.insert({bottom:new Element("span",{class:"value"}).update(value.escapeHTML())}),null!=this.options.customizeItemDisplay&&"function"==typeof this.options.customizeItemDisplay&&this.options.customizeItemDisplay(key,value,valueAll,displayedValue,this.options),listItem.insert(displayedValue),category&&""!=category&&listItem.insert(category),this.options.showDeleteTool){var deleteTool=new Element("span",{class:"delete-tool",title:"Delete this term"}).update("&#x2716;");deleteTool.observe("click",this.removeItem.bindAsEventListener(this)),listItem.appendChild(deleteTool)}this.options.showTooltip&&info&&(listItem.appendChild(new Element("div",{class:"tooltip"}).update(info)),listItem.select(".expand-tool").invoke("observe","click",function(event){event.stop()})),this.list.insert(listItem);var newItem=this.list?this.list.down('input[id="'+id.replace(/[^a-zA-Z0-9_-]/g,"\\$&")+'"]'):$(id);return this.synchronizeSelection(newItem),newItem.observe("change",this.synchronizeSelection.bind(this,newItem)),this.updateListTools(),this.onItemAdded(newItem),newItem}},onItemAdded:function(element){},removeItem:function(event){var item=event.findElement("li");this.synchronizeSelection({value:(item.down("input[type=checkbox]")||item.down("input")).value,checked:!1}),item.remove(),this.notifySelectionChange(item),this.input.value=this.input.defaultValue||"",this.updateListTools()},clearAcceptedList:function(){for(var item=this.list.down("li .delete-tool"),i=0;item&&i<100;)item.click(),item=this.list.down("li .delete-tool"),i++},updateListTools:function(){if(this.clearTool&&(0<this.list.select("li .accepted-suggestion").length?this.clearTool.removeClassName("invisible"):this.clearTool.addClassName("invisible")),this.options.enableSort&&0<this.list.select("li .accepted-suggestion").length&&void 0!==Sortable&&Sortable.create(this.list),this.serializedDataInput){var value="";this.list.select("li .accepted-suggestion input[type=checkbox]").each(function(entry){value+=entry.value+"|"}),this.serializedDataInput.value=value}},getInputId:function(key,negative){return(negative?this.inputName.replace(/(_\d+)_/,"$1_negative_"):this.inputName)+"_"+key},synchronizeSelection:function(input){var element="function"==typeof input.up&&input.up("li");if(element&&this.input.hasClassName("generateYesNo")&&!input.up(".yes-no-picker")){Element.select(element,'input[name="fieldName"][type="hidden"]').each(function(n){var target=n.up("li").down('input[type="checkbox"]'),originalName=target.name;target.id=target.id.replace(target.name,n.value),target.name=n.value,target.up("label").addClassName(n.className),target.up("label").htmlFor=target.id,n.value=originalName,n.up(".term-category")&&n.up(".term-category").insert({before:n})});var positiveName=this.input.name.replace(/__suggested$/,""),negativeName=this.input.name.replace(/(_\d+)_/,"$1_negative_").replace(/__suggested$/,""),value=input.value,text=element.down(".value").firstChild.nodeValue,ynpickerElt=YesNoPicker.generatePickerElement([{type:"na",selected:!isValueSelected(positiveName,value)&&!isValueSelected(negativeName,value)},{type:"yes",name:positiveName,selected:isValueSelected(positiveName,value)},{type:"no",name:negativeName,selected:isValueSelected(negativeName,value)}],value,text,!0,input.next());input.insert({before:ynpickerElt}),input.hide(),input.name="",input.id="",input.value="",enableHighlightChecked(ynpickerElt.down(".yes input")),enableHighlightChecked(ynpickerElt.down(".no input"))}element&&this.notifySelectionChange(element)},notifySelectionChange:function(elt){elt.__categoryArray||(elt.__categoryArray=[],Element.select(elt,".term-category input[type=hidden]").each(function(c){elt.__categoryArray.push(c.value)})),-1!=this.input.className.indexOf("suggest-hpo-modifier")&&""==this.inputName&&(this.inputName="hpo_positive"),Event.fire(document,"custom:selection:changed",{categories:elt.__categoryArray,trigger:this.input,fieldName:this.inputName,customElement:elt})}}),PhenoTips}(PhenoTips||{});!function(){window.pedigreeStatus=window.pedigreeStatus||{};var previousState=[],getCurrentState=function(){var exportString=PedigreeExport.exportAsSimpleJSON(editor.getGraph().DG,"all"),pedigreeData=JSON.parse(exportString);return pedigreeData.forEach(function(elem){null!=elem.hpoTermsFullDetails&&elem.hpoTermsFullDetails.forEach(function(hpoFullDetail){null!=hpoFullDetail.valueAll&&null!=hpoFullDetail.valueAll.hpoModifiers&&0<hpoFullDetail.valueAll.hpoModifiers.size()&&(hpoFullDetail.hpoModifiers=hpoFullDetail.valueAll.hpoModifiers)})}),pedigreeData};window.pedigreeStatus.isDirty=function(){var currentStateJson=getCurrentState();return!(JSON.stringify(currentStateJson)===JSON.stringify(previousState))},window.pedigreeStatus.reset=function(){previousState=getCurrentState()}}(),function(){var config={},embeddedAppConfigFunc=window.embeddedAppConfig;if(!embeddedAppConfigFunc||"function"!=typeof embeddedAppConfigFunc)throw"embeddedAppConfigFunc is not defined. It must be defined at window level for pedigree tool app to work.";config=embeddedAppConfigFunc();var isStandAlone=!1;CONSTANTS.STANDALONE&&(isStandAlone=!0),initializeEditor(config.accessToken,null,config.divId,config.referralId,null,function(){if(!window.refreshAccessToken||"function"!=typeof window.refreshAccessToken)throw"refreshTokenFunction is not defined. It must be defined at window level for pedigree tool app to work.";var newAccessToken=window.refreshAccessToken();window.PedigreeEditorTool.accessToken=newAccessToken},isStandAlone,function(callbackFunc){if(null!==callbackFunc&&!Object.isFunction(callbackFunc))throw"Save callback function is not a function";window.editor.getSaveLoadEngine().save(null,callbackFunc)})}();